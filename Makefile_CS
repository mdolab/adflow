#      ******************************************************************
#      *                                                                *
#      * File:          Makefile                                        *
#      * Author:        Edwin van der Weide, Gaetan Kenway              *
#      * Starting date: 12-10-2002                                      *
#      * Last modified: 11-16-2014                                      *
#      *                                                                *
#      ******************************************************************

# These are the directories that will be automatically complexified.
REAL_SRC    =	src/modules       \
	    	src/ADT           \
		src/bcdata        \
	        src/initFlow      \
	        src/inputParam    \
		src/metis-4.0     \
	        src/output        \
	        src/overset       \
		src/parallelIO    \
	        src/partitioning  \
	        src/preprocessing \
	        src/slidingComm   \
	        src/solver        \
		src/NKsolver      \
	        src/turbulence    \
	        src/utils         \
	        src/wallDistance  \
		src/warping       \
		src/exec          \
		src/adjoint       \
		src/forwardAdjoint\
		src/forwardAdjoint/residualInput\
		src/bendingMomentAnalysis \
	        src/stabilityDerivatives \
		src/adjoint/forcesInput\
		src/adjoint/stabilityInput\

# These are the directories that will actually be compiled:
SUBDIR_SRC    = src_cs/modules       \
		src_cs/ADT           \
		src_cs/solver        \
		src_cs/bcdata        \
	        src_cs/initFlow      \
	        src_cs/metis-4.0     \
	        src_cs/inputParam    \
	        src_cs/output        \
	        src_cs/overset       \
		src_cs/parallelIO    \
	        src_cs/partitioning  \
	        src_cs/preprocessing \
	        src_cs/slidingComm   \
	        src_cs/turbulence    \
		src_cs/NKsolver      \
	        src_cs/utils         \
	        src_cs/wallDistance  \
		src_cs/warping       \
		src_cs/adjoint               \
		src_cs/forwardAdjoint \
		src_cs/forwardAdjoint/residualInput\
		src_cs/bendingMomentAnalysis \
	        src_cs/stabilityDerivatives \
		src_cs/adjoint/forcesInput\
		src_cs/adjoint/stabilityInput\

SUBDIR_EXEC   = src_cs/exec
SUBDIR_PV3    = src_cs/pv3Interface
CONFIG_DEFAULT_DIR = config/defaults
CONFIG_DIR         = config
SUMB_SUBDIRS       = $(SUBDIR_SRC) $(PV3_INT_SRC_DIR)
SUMB_CLEAN_SUBDIRS = $(SUBDIR_SRC)  $(SUBDIR_PV3) $(SUBDIR_EXEC)

default:
# Check if the config.mk file is in the config dir.
	@if [ ! -f "config/config.mk" ]; then \
	echo "Before compiling, copy an existing config file from the "; \
	echo "config/defaults/ directory to the config/ directory and  "; \
	echo "rename to config.mk. For example:"; \
	echo " ";\
	echo "  cp config/defaults/config.LINUX_INTEL_OPENMPI.mk config/config.mk"; \
	echo " ";\
	echo "The modify this config file as required. Typically the CGNS directory "; \
	echo "will have to be modified. With the config file specified, rerun "; \
	echo "'make' and the build will start"; \
	else make -f Makefile_CS sumb;\
	fi;

dirs:	
	mkdir -p bin
	mkdir -p obj_cs
	mkdir -p mod_cs
	@for subdir in $(SUMB_SUBDIRS) ; \
	     do \
	     	 echo "Creating Complex Directory $$subdir"; \
	         (mkdir -p $$subdir) || exit 1;  \
	     done
	mkdir -p src_cs/exec

clean:
	ln -sf SUmb_Common_CS.mk SUmb_Common.mk
	@echo " Making clean ... "
	@for subdir in $(SUMB_SUBDIRS) ; \
	     do \
	     	 echo "Removing Complex Directory $$subdir"; \
	         (rm -fr $$subdir) || exit 1;  \
	     done
	(cd src_cs/exec && make clean)
	(cd src_cs/python/f2py && make clean)
	rm -f *~ config.mk;
	rm -f lib_cs/lib* mod_cs/* obj_cs/*

sumb:
	make -f Makefile_CS dirs
	ln -sf config/config.mk config.mk
	ln -sf SUmb_Common_CS.mk SUmb_Common.mk

	@for subdir in $(REAL_SRC) ; \
		do \
			echo "complexifying $@ in $$subdir"; \
			echo; \
			(cd $$subdir && make complexify) || exit 1; \
		done

	@for subdir in $(SUMB_SUBDIRS) ; \
		do \
			echo "making $@ in $$subdir"; \
			echo; \
			(cd $$subdir && make) || exit 1; \
		done

	(cd lib_cs && make)
	(cd $(SUBDIR_EXEC) && make)
	(cd src/python/f2py && make complexify)
	(cd src_cs/python/f2py && make)	
