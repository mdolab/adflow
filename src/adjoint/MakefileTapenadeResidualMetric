#     ******************************************************************
#     *                                                                *
#     * File:          MakefileResidualMetric                          *
#     * Author:        Andre C. Marta, Sandy Mader                     *
#     * Starting date: 08-02-2006                                      *
#     * Last modified: 05-08-2008                                      *
#     *                                                                *
#     ******************************************************************

#     ******************************************************************
#     *                                                                *
#     * Description: Makefile to build the differentiated routines of  *
#     * the SUmb flow residual with respect to both xAdj and wAdj,     *
#     * including penalty terms, using Tapenade                        *
#     *                                                                *
#     * http://www-sop.inria.fr/tropics/tapenade.html                  *
#     *                                                                *
#     * Upon local installation of Tapenade, typing tapenade -help     *
#     * at the prompt gives the following information:                 *
#     *                                                                *
#     * Tapenade - Version 2.2 (r2308) - Java 1.6.0_06                 *
#     *                                                                *
#     *  Builds a differentiated program.                              *
#     *                                                                *
#     *  Usage: tapenade [options] filenames                           *
#     *                                                                *
#     *   options:                                                     *
#     *                                                                *
#     * -tangent, -d          differentiate in the tangent mode        *
#     * -reverse, -b          differentiate in the reverse mode        *
#     * -multi                turn on "vectorial" differentiation      *
#     *                       (multi-directional)                      *
#     * -directValid, -dV     tangent mode computing validity interval *
#     * -preprocess, -p       turn off differentiation                 *
#     * -head, -root <proc>   set the differentiation root procedure   *
#     * -outvars <vars>       set dependents, i.e. differentiate these *
#     *                       output variables, eg "x y z". Use the "  *
#     *                       delimitor. (default all outputs)         *
#     * -vars <vars>          set independents, i.e. differentiate wrt *
#     *                       these input variables, eg "x y z". Use   *
#     *                       the " delimitor. (default all inputs)    *
#     * -diffvarname <str>    set differentiation suffix for variables *
#     *                       (default d and b)                        *   
#     * -difffuncname <str>   set differentiation suffix for procedures*
#     *                       (default _D and _B)                      *
#     * -inputlanguage <lang> language of  input files                 *
#     *                       (fortran, fortran90, or fortran95)       *
#     * -outputlanguage <lang>language of output files                 *
#     *                       (fortran, fortran90, or fortran95)       *
#     * -output, -o <file>    put all generated procedures into a      *
#     *                       single <file>                            *
#     * -outputdirectory, -O <directory>  put all generated files in   *
#     *                       <directory> (default .) (default one     *
#     *                       separate file per differentiated procedur*
#     * -nolib                erase previous external libraries        *
#     *                       descriptions                             *
#     * -ext <file>           incorporate external library description *
#     *                       <file>                                   *
#     * -noADlib              erase previous external libraries AD     *
#     *                       descriptions                             *
#     * -extAD <file>         incorporate external library AD          *
#     *                       description <file>                       *
#     * -i<n>                 count <n> bytes for an integer (default4)*
#     * -r<n>                 count <n> bytes for a real (default 4)   *
#     * -dr<n>                count <n> bytes for a double real (def 8)*
#     * -nooptim <str>        turn off optimization <str>              *
#     * -traceactivevars <units>  insert debugging calls for the       *
#     *                       tangent mode of <units>                  *
#     * -traceallactivevars   insert debugging calls for all tangent   *
#     *                       diff procedures                          *
#     * -dptest <units>       insert debugging calls for the dot       *
#     *                       product test                             *
#     * -msglevel <n>         set the level of detail of               *
#     *                       differentiation milestones               *
#     * -dump <file>          write a dump <file>                      *
#     * -html                 display results in a web browser         *
#     *                                                                *
#     ******************************************************************

#     ==================================================================

#     ******************************************************************
#     *                                                                *
#     * Set some environment variables that otherwise would have to be *
#     * set at the command prompt with "setenv".                       *
#     *                                                                *
#     ******************************************************************

#JAVA_HOME = /nfs/opal/home/mader/jdk1.5.0_06
#JAVA_HOME = /home/guysmiley/acmarta/software/tapenade/jre1.5.0_07
#JAVA_HOME =/home/mader/UTIAS/SRC/jdk1.6.0_06
#TAPENADE_HOME = /nfs/opal/home/mader/SRC/Tapenade/tapenade2.2
#TAPENADE_HOME = /home/guysmiley/acmarta/software/tapenade/tapenade2.2
#TAPENADE_HOME = /nfs/mica/home/kenway/Downloads/tapenade2.2

#SOLVER_DIRSRC = /nfs/opal/home/mader/SRC/SUmbVertex/SUmbVertex/src
#SOLVER_DIRSRC = /home/guysmiley/acmarta/SVN/SUmbVertex/src
#SOLVER_DIRSRC = /nfs/basalt/home/mdo/mader/svn/SUmbVertex/trunk/src
#SOLVER_DIRSRC = /home/mader/UTIAS/pyMDO/pyHF/SUmbADjoint/trunk/src
#SOLVER_DIRSRC = /nfs/tuff/home/mader/UTIAS/pyMDO/pyHF/SUmbADjoint/trunk/src
#SOLVER_DIRSRC = /nfs/mica/home/kenway/hg/SUmbADjoint/src
SOLVER_DIRSRC = /nfs/mica/home/kenway/hg/SUmb/src
#SOLVER_DIRSRC = /nfs/basalt/home/mdo/mader/svn/pyHF/SUmbADjoint/trunk/src

#     ******************************************************************
#     *                                                                *
#     * Set Tapenade options.                                          *
#     *                                                                *
#     ******************************************************************

TAPENADE_PARSERFILESEPARATOR = "/"

# Dependent output variables (separator: white space, default: all)

TAPENADE_OUTVARS = "dwadj"

# Independent input variables (separator: white space, default: all)

#TAPENADE_VARS = "xadj wadj alphaadj machadj"
TAPENADE_VARS = "xadj wadj alphaadj betaadj machadj machGridAdj rotRateAdj xBlockCornerAdj pointrefadj rotpointadj rotcenteradj"

# Name of the top routine

TAPENADE_HEADROUTINE = "computeRAdjoint"

# Differentiation mode

TAPENADE_MODE = -reverse
#TAPENADE_MODE = -forward

# Output directory

TAPENADE_OUTDIR = $(SOLVER_DIRSRC)/adjoint/residualTapenade

# Integer, double and real precision (bytes)

#TAPENADE_PRECISION = -i4 -dr8 -r4
TAPENADE_PRECISION = -i4 -dr8 -r8

#     ******************************************************************
#     *                                                                *
#     * The subdirectories where the sources are located.              *
#     *                                                                *
#     ******************************************************************

TAPENADE_DIRSRC_RES = $(SOLVER_DIRSRC)/adjoint/residualInput
#TAPENADE_DIRSRC_MET = $(SOLVER_DIRSRC)/adjoint/metricInput
TAPENADE_DIRMOD     = $(SOLVER_DIRSRC)/modules
TAPENADE_DIRUTILS     = $(SOLVER_DIRSRC)/utils

TAPENADE_CLEAN_DIRS = $(TAPENADE_OUTDIR)

#     ******************************************************************
#     *                                                                *
#     * Routines to be differentiated (and dependencies).              *
#     *                                                                *
#     ******************************************************************

TAPENADE_SRC_COMMON = $(TAPENADE_DIRSRC_RES)/residualAdj.f90 \
		      $(TAPENADE_DIRSRC_RES)/computeRAdj.f90 

#TAPENADE_SRC_METRIC = $(TAPENADE_DIRSRC_MET)/computedRAdj.f90 \
#	       $(TAPENADE_DIRSRC_MET)/correctMetricDegenerateFacesAdj.f90 \
#	       $(TAPENADE_DIRSRC_MET)/metricAdj.f90

TAPENADE_SRC_SOLVER = $(TAPENADE_DIRSRC_RES)/applyAllBCAdj.f90 \
	       $(TAPENADE_DIRSRC_RES)/bcFarfieldAdj.f90 \
	       $(TAPENADE_DIRSRC_RES)/bcSymmAdj.f90 \
	       $(TAPENADE_DIRSRC_RES)/checkOverlapAdj.f90\
	       $(TAPENADE_DIRSRC_RES)/checkXOverlapAdj.f90\
	       $(TAPENADE_DIRSRC_RES)/computePressureAdj.f90 \
               $(TAPENADE_DIRSRC_RES)/rotMatrixRigidBodyAdj.f90\
               $(TAPENADE_DIRSRC_RES)/derivativeRigidRotAngleAdj.f90\
               $(TAPENADE_DIRSRC_RES)/derivativeRotMatrixRigidAdj.f90\
	       $(TAPENADE_DIRSRC_RES)/etotArrayAdj.f90 \
	       $(TAPENADE_DIRSRC_RES)/extractBCStatesAdj.f90 \
	       $(TAPENADE_DIRSRC_RES)/extrapolate2ndHaloAdj.f90 \
               $(TAPENADE_DIRSRC_RES)/gridVelocitiesFineLevelAdj.f90 \
	       $(TAPENADE_DIRSRC_RES)/initresAdj.f90 \
	       $(TAPENADE_DIRSRC_RES)/inviscidCentralFluxAdj.f90 \
	       $(TAPENADE_DIRSRC_RES)/inviscidUpwindFluxAdj.f90 \
	       $(TAPENADE_DIRSRC_RES)/inviscidDissFluxScalarAdj.f90 \
	       $(TAPENADE_DIRSRC_RES)/leftRightStateAdj.f90 \
	       $(TAPENADE_DIRSRC_RES)/metricAdj.f90 \
               $(TAPENADE_DIRSRC_RES)/normalVelocitiesAdj.f90 \
	       $(TAPENADE_DIRSRC_RES)/replaceBCStatesAdj.f90\
	       $(TAPENADE_DIRSRC_RES)/riemannFluxAdj.f90\
               $(TAPENADE_DIRSRC_RES)/rigidRotAngleAdj.f90      \
	       $(TAPENADE_DIRSRC_RES)/bcEulerWallAdj.f90 \
	       $(TAPENADE_DIRSRC_RES)/adjustInflowAngleAdj.f90 \
	       $(TAPENADE_DIRSRC_RES)/checkInputParamAdj.f90 \
	       $(TAPENADE_DIRSRC_RES)/referenceStateAdj.f90 \
	       $(TAPENADE_DIRSRC_RES)/setFlowInfinityStateAdj.f90 \
	       $(TAPENADE_DIRSRC_RES)/getDirAngle.f90 \
	       $(TAPENADE_DIRSRC_RES)/getDirVector.f90 \
	       $(TAPENADE_DIRSRC_RES)/computeGammaAdj.f90 \
	       $(TAPENADE_DIRSRC_RES)/timeStepAdj.f90 \
	       $(TAPENADE_DIRSRC_RES)/vectorRotation.f90\
	       $(TAPENADE_DIRSRC_RES)/xhaloAdj.f90\
	       $(TAPENADE_DIRUTILS)/TSalpha.f90\
	       $(TAPENADE_DIRUTILS)/TSBeta.f90\
	       $(TAPENADE_DIRUTILS)/TSMach.f90	



TAPENADE_MOD = $(TAPENADE_DIRSRC_RES)/block.f90 \
	       $(TAPENADE_DIRSRC_RES)/constants.f90 \
	       $(TAPENADE_DIRSRC_RES)/flowVarRefState.f90 \
	       $(TAPENADE_DIRSRC_RES)/precision.f90 \
	       $(TAPENADE_DIRMOD)/inputParam.f90 \
	       $(TAPENADE_DIRMOD)/BCTypes.f90 \
	       $(TAPENADE_DIRMOD)/blockPointers.f90 \
	       $(TAPENADE_DIRMOD)/iteration.f90 \
	       $(TAPENADE_DIRMOD)/monitor.f90 \
	       $(TAPENADE_DIRSRC_RES)/cgnsGrid.f90 \
	       $(TAPENADE_DIRSRC_RES)/communication.f90 \
	       $(TAPENADE_DIRMOD)/section.f90\
	       $(TAPENADE_DIRSRC_RES)/CpCurveFits.f90\
	       $(TAPENADE_DIRSRC_RES)/terminate.f90

#	       $(TAPENADE_DIRSRC_RES)/inputParam.f90 \

#TAPENADE_SRC_ALL = $(TAPENADE_SRC_COMMON) $(TAPENADE_SRC_METRIC) \
#		   $(TAPENADE_SRC_SOLVER) $(TAPENADE_SRC_MAGNETIC) \
#		   $(TAPENADE_MOD)
TAPENADE_SRC_ALL = $(TAPENADE_SRC_COMMON) $(TAPENADE_SRC_SOLVER)\
	  	   $(TAPENADE_MOD)

#     ******************************************************************
#     *                                                                *
#     * General targets.                                               *
#     *                                                                *
#     ******************************************************************

default:
	@echo "TAPENADE - parsing and generating differentiated code"
	$(TAPENADE_HOME)/bin/tapenade -parserfileseparator $(TAPENADE_PARSERFILESEPARATOR) -outvars $(TAPENADE_OUTVARS) -vars $(TAPENADE_VARS) -head $(TAPENADE_HEADROUTINE) $(TAPENADE_MODE) -msglevel 30 -O $(TAPENADE_OUTDIR) $(TAPENADE_PRECISION) $(TAPENADE_SRC_ALL)
	@echo "deleting some unnecessary files..."
	@rm -f $(TAPENADE_OUTDIR)/*__.f90 $(TAPENADE_OUTDIR)/*~

all:	 default

clean:
	@echo " Making clean ... "
	@for subdir in $(TAPENADE_CLEAN_DIRS) ; \
		do \
			echo; \
			echo "making $@ in $$subdir"; \
			echo; \
			(cd $$subdir && rm -f *_b.f90 *_d.f90  *.msg *~) || exit 1; \
		done
