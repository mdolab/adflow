#    -*- makefile -*-
#     ******************************************************************
#     *                                                                *
#     * File:          Makefile_tapenade                               *
#     * Author:        Gaetan Kenway                                   *
#     * Starting date: 08-02-2006                                      *
#     * Last modified: 10-24-2014                                      *
#     *                                                                *
#     * This makefile is used to create automatically differentated    *
#     * residual code that can be used to constuct the aerodynamic     *
#     * jacobian. There are three main commands:                       *
#     *                                                                *
#     * ad_forward: Run in forward mode. Preprocessed output is in     *
#     *             'outputFoward' directory                           *
#     *                                                                *
#     * ad_reverse: Run in reverse mode. Preprocessed output is in the *
#     *             'outputReverse' directory                          *
#     *                                                                *
#     * ad_reverse_fast : Run the state-only reverse mode.             *
#     * Preprocessed output is in the 'outputReverseFast' directory    *
#     *                                                                *
#     ******************************************************************

# Define the required directories
SRC = ..

# Integer, double and real precision (bytes)
TAPENADE_PRECISION = -i4 -dr8 -r8

ALL_RES_FILES =	$(SRC)/adjoint/adjointExtra.F90\
		$(SRC)/modules/surfaceFamilies.F90\
		$(SRC)/modules/monitor.f90\
		$(SRC)/modules/diffSizes.f90\
		$(SRC)/modules/block.F90\
		$(SRC)/modules/inputParam.F90\
		$(SRC)/modules/constants.F90\
		$(SRC)/modules/precision_tapenade.f90\
		$(SRC)/modules/iteration.f90\
		$(SRC)/modules/section.f90\
		$(SRC)/modules/communication.f90\
		$(SRC)/modules/paramTurb.F90\
		$(SRC)/modules/cgnsGrid.f90 \
		$(SRC)/modules/CpCurveFits.f90\
		$(SRC)/modules/blockPointers.F90 \
		$(SRC)/modules/BCPointers.F90 \
		$(SRC)/modules/flowVarRefState.F90 \
		$(SRC)/modules/costFunctions.F90\
		$(SRC)/modules/wallDistanceData.F90\
		$(SRC)/solver/BCRoutines.F90\
		$(SRC)/solver/fluxes.F90\
		$(SRC)/solver/solverUtils.F90\
		$(SRC)/solver/residuals.F90\
		$(SRC)/solver/surfaceIntegrations.F90\
		$(SRC)/solver/ALEUtils.F90\
		$(SRC)/initFlow/initializeFlow.F90\
		$(SRC)/turbulence/turbUtils.F90\
		$(SRC)/turbulence/turbBCRoutines.F90\
		$(SRC)/turbulence/turbMod.F90\
		$(SRC)/turbulence/sa.F90\
		$(SRC)/utils/flowUtils.F90\
		$(SRC)/utils/utils.F90\
		$(SRC)/utils/sorting.F90\
		$(SRC)/wallDistance/wallDistance.F90\

# intermediate preprocessed files.
I_RES_FILES := $(ALL_RES_FILES:%=%.f90)
# ---------------------------------------------------------------------

#     ******************************************************************
#     *                                                                *
#     * General targets.                                               *
#     *                                                                *
#     ******************************************************************

default: ad_forward

ad_forward:
# First delete the holding directory if it exists
	rm -fr temp_forward

# Next create the holidng directory:
	mkdir -p temp_forward

# Run preprocessor on all input files
	make -f Makefile_tapenade preprocess_forward

# The following is the single Tapenade command to run:
	$(TAPENADE_HOME)/bin/tapenade -html \
	-head "adjointExtra%block_res(flowdoms%w flowdoms%x xsurf alpha beta mach \
	machgrid machcoef pointref lengthRef PinfDim TinfDim rhoInfDim ww0 ww1 ww2 ww3 pp0 pp1 pp2 \
	pp3 rlv0 rlv1 rlv2 rlv3 rev0 rev1 rev2 rev3 ssi ssj ssk ss xx) > \
(flowdoms%dw  bcData%Fv bcData%Fp bcData%area flowdoms%w flowdoms%x funcValues) \
adjointExtra%xhalo_block(x)>(x)" \
	-forward $(TAPENADE_PRECISION) \
	-O temp_forward $(I_RES_FILES)

# Run the auto-edit file:
	python autoEdit/autoEditForward.py temp_forward outputForward

# Remove preprocessor files
	make -f Makefile_tapenade cleanpreprocess_res

ad_reverse:
# First delete the holding directory if it exists
	rm -fr temp_reverse

# Next create the holidng directory:
	mkdir -p temp_reverse

# Run preprocessor on all input files
	make -f Makefile_tapenade preprocess_reverse

# The following is the single Tapenade command to run:
	$(TAPENADE_HOME)/bin/tapenade -html \
	-head "adjointExtra%block_res(flowdoms%w flowdoms%x xsurf alpha beta mach \
	machgrid machcoef pointref lengthRef PinfDim TinfDim rhoInfDim ww0 ww1 ww2 ww3 pp0 pp1 pp2 \
	pp3 rlv0 rlv1 rlv2 rlv3 rev0 rev1 rev2 rev3 xx ssi) > \
(flowdoms%dw  bcData%Fp bcData%Fv bcData%area flowdoms%w flowdoms%x funcValues ww0 ww1 ww2 ww3 pp0 pp1 pp2 pp3 rlv0 rlv1 rlv2 rlv3 rev0 rev1 rev2 rev3 xx ssi) \
adjointExtra%xhalo_block(x)>(x)" \
	-adjvarname %d \
	-reverse -msglevel 30 $(TAPENADE_PRECISION) \
	-noisize \
	-O temp_reverse $(I_RES_FILES)

# Run the auto-edit file:
	python autoEdit/autoEditReverse.py temp_reverse outputReverse

# Remove preprocessor files
	make -f Makefile_tapenade cleanpreprocess_res

# Fix the AD bugs
	sed -i 's/do ii1=1,size(viscsubfaced(ii1)%tau, 1)/do ii1=1,size(viscsubfaced)/' outputReverse/surfaceintegrations_b.f90
	sed -i 's/do ii1=1,size(bcdata(ii1)%f, 1)/do ii1=1,size(bcdata)/' outputReverse/adjointextra_b.f90
	sed -i 's/do ii1=size(bcdata(ii1)%f, 1),1,-1/do ii1=size(bcdata),1,-1/' outputReverse/adjointextra_b.f90
	sed -i 's/do ii1=1,size(bcdatad(ii1)%norm, 1)/do ii1=1,size(bcdatad)/' outputReverse/bcroutines_b.f90
	sed -i 's/end subroutine sa_block_b/deallocate(qq)\nend subroutine sa_block_b/' outputReverse/sa_b.f90

ad_reverse_fast:
# First delete the holding directory if it exists
	rm -fr temp_reverse_fast

# Next create the holidng directory:
	mkdir -p temp_reverse_fast

# Run preprocessor on all input files
	make -f Makefile_tapenade preprocess_reverse_fast

# The following is the single Tapenade command to run:
	$(TAPENADE_HOME)/bin/tapenade -html \
	-head "\
	fluxes%inviscidCentralFlux(w, p, dw)>(w, p, dw) \
	fluxes%inviscidDissFluxScalar(p, w, radi, radj, radk, fw)>(fw, w, p) \
	fluxes%inviscidDissFluxMatrix(p, w, fw)>(fw, w, p) \
	solverutils%timeStep_block(w, p, radi, radj, radk)>(p, w, radi, radj, radk) \
	fluxes%viscousFlux(w, aa, rlv, rev, ux, uy, uz, vx, vy, vz, wx, wy, wz, qx, qy, qz, fw)>(fw, w, rlv, rev, aa) \
	flowutils%allNodalGradients(aa, w, ux, uy, uz, vx, vy, vz, wx, wy, wz, qx, qy, qz)>\
	         (aa, w, ux, uy, uz, vx, vy, vz, wx, wy, wz, qx, qy, qz) \
	flowutils%computeSpeedOfSoundSquared(w, p, aa)>(w, p, aa) \
	flowutils%computeLamViscosity(w, p, rlv)>(w, p, rlv) \
	BCRoutines%bcNSWallAdiabatic(ww0, ww1, ww2, pp0, pp1, pp2, rlv1, rlv2, rev0, rev1, rev2)>\
	                            (ww0, ww1, ww2, pp0, pp1, pp2, rlv1, rlv2, rev0, rev1, rev2) \
	BCRoutines%bcNSWallIsothermal(ww1, ww2, pp1, pp2, rlv1, rlv2, rev1, rev2)>\
	                             (ww1, ww2, pp1, pp2, rlv1, rlv2, rev1, rev2) \
	BCRoutines%bcFarField(ww0, ww1, ww2, pp0, pp1, pp2, rlv0, rlv1, rlv2, rev0, rev1, rev2)>\
			     (ww0, ww1, ww2, pp0, pp1, pp2, rlv0, rlv1, rlv2, rev0, rev1, rev2) \
	BCRoutines%bcSymm1stHalo(ww1, ww2, pp1, pp2, rlv1, rlv2, rev1, rev2)>\
			        (ww1, ww2, pp1, pp2, rlv1, rlv2, rev1, rev2) \
	BCRoutines%bcSymm2ndHalo(ww0, ww3, pp0, pp3, rlv0, rlv3, rev0, rev3)>\
			 (ww0, ww3, pp0, pp3, rlv0, rlv3, rev0, rev3) \
	BCRoutines%bcEulerWall(ww1, ww2, pp1, pp2, pp3, rlv1, rlv2, rev1, rev2)>\
			      (ww1, ww2, pp1, pp2, pp3, rlv1, rlv2, rev1, rev2) \
	flowutils%computePressureSimple(w, p)>(w,p) \
	sa%saSource(scratch,w,rlv)>(scratch,w,rlv) \
	sa%saViscous(scratch, w,rlv)>(scratch,w,rlv) \
	sa%saResScale(scratch)>(dw) \
	turbutils%saEddyViscosity(w,rlv)>(w,rlv,rev) \
	turbutils%turbAdvection(w,scratch)>(w,scratch)" \
	-adjvarname %d \
	-adjfuncname %_fast_b \
	-reverse $(TAPENADE_PRECISION) \
	-noisize \
	-O temp_reverse_fast $(I_RES_FILES)

# Run the auto-edit file:
	python autoEdit/autoEditReverseFast.py temp_reverse_fast outputReverseFast

# Remove preprocessor files
	make -f Makefile_tapenade cleanpreprocess_res

preprocess_forward:
	@echo "Preprocessing all input files for forward mode AD..."
	@for file in $(ALL_RES_FILES); do \
		echo Preprocessing $$file; \
		cpp -DUSE_TAPENADE -DTAPENADE_FORWARD -traditional -P  $$file $$file.f90; \
	done

preprocess_reverse:
	@echo "Preprocessing all input files for reverse mode AD..."
	@for file in $(ALL_RES_FILES); do \
		echo Preprocessing $$file; \
		cpp -DUSE_TAPENADE -DTAPENADE_REVERSE -traditional -P $(FF90_ALL_FLAGS) $$file $$file.f90; \
	done

preprocess_reverse_fast:
	@echo "Preprocessing all input files for reverse mode AD..."
	@for file in $(ALL_RES_FILES); do \
		echo Preprocessing $$file; \
		cpp -DUSE_TAPENADE -DTAPENADE_REVERSE  -DTAPENADE_POINTERS -traditional -P $(FF90_ALL_FLAGS) $$file $$file.f90; \
	done

cleanpreprocess_res:
	@echo "Cleaning up residual preprocessed files..."
	@for file in $(ALL_RES_FILES); do \
		rm $$file.f90; \
	done

all:	 default
