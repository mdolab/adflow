   !        Generated by TAPENADE     (INRIA, Tropics team)
   !  Tapenade 3.4 (r3375) - 10 Feb 2010 15:08
   !
   !  Differentiation of extrapolate2ndhalonkpc in forward (tangent) mode:
   !   variations   of useful results: padj0 wadj0
   !   with respect to varying inputs: padj0 padj1 padj2 wadj0 wadj1
   !                wadj2
   !
   !      ******************************************************************
   !      *                                                                *
   !      * File:          extrapolate2ndHaloAdj.f90                       *
   !      * Author:        Edwin van der Weide                             *
   !      *                Seongim Choi                                    *
   !      * Starting date: 03-21-2006                                      *
   !      * Last modified: 03-21-2006                                      *
   !      *                                                                *
   !      ******************************************************************
   !
   SUBROUTINE EXTRAPOLATE2NDHALONKPC_D(nn, icbeg, icend, jcbeg, jcend, &
   &  ioffset, joffset, wadj0, wadj0d, wadj1, wadj1d, wadj2, wadj2d, padj0, &
   &  padj0d, padj1, padj1d, padj2, padj2d)
   USE FLOWVARREFSTATE
   USE CONSTANTS
   USE ITERATION
   IMPLICIT NONE
   !
   !      ******************************************************************
   !      *                                                                *
   !      * extrapolate2ndHaloAdj determines the states of the second      *
   !      * layer halo cells of subface nn of the block to which the       *
   !      * pointers in blockPointers currently point.                     *
   !      *                                                                *
   !      ******************************************************************
   !
   !irhoE
   !gammaInf, kPresent
   !nt1MG, nt2MG
   !
   !      Subroutine arguments.
   !
   INTEGER(kind=inttype), INTENT(IN) :: nn
   INTEGER(kind=inttype), INTENT(IN) :: icbeg, icend, jcbeg, jcend
   INTEGER(kind=inttype), INTENT(IN) :: ioffset, joffset
   REAL(kind=realtype), DIMENSION(-2:2, -2:2, nw) :: wadj0, wadj1
   REAL(kind=realtype), DIMENSION(-2:2, -2:2, nw) :: wadj0d, wadj1d
   REAL(kind=realtype), DIMENSION(-2:2, -2:2, nw) :: wadj2
   REAL(kind=realtype), DIMENSION(-2:2, -2:2, nw) :: wadj2d
   REAL(kind=realtype), DIMENSION(-2:2, -2:2) :: padj0, padj1
   REAL(kind=realtype), DIMENSION(-2:2, -2:2) :: padj0d, padj1d
   REAL(kind=realtype), DIMENSION(-2:2, -2:2) :: padj2
   REAL(kind=realtype), DIMENSION(-2:2, -2:2) :: padj2d
   !
   !      Local parameter.
   !
   REAL(kind=realtype), PARAMETER :: factor=0.5_realType
   !
   !      Local variables.
   !
   INTEGER(kind=inttype) :: i, j, l, ii, jj
   REAL(kind=realtype) :: ovgm1, gm53, factk
   INTRINSIC MAX
   !
   !      ******************************************************************
   !      *                                                                *
   !      * Begin execution                                                *
   !      *                                                                *
   !      ******************************************************************
   !
   ! Easier storage of variables involving gamma.
   ovgm1 = one/(gammainf-one)
   gm53 = gammainf - five*third
   factk = -(ovgm1*gm53)
   ! Loop over the generic subface to set the state in the
   ! halo cells.
   DO j=jcbeg,jcend
   DO i=icbeg,icend
   ii = i - ioffset
   jj = j - joffset
   ! Extrapolate the density, velocities and pressure.
   ! Make sure that a certain threshold is kept for the
   ! density and pressure.
   wadj0d(ii, jj, irho) = two*wadj1d(ii, jj, irho) - wadj2d(ii, jj, &
   &        irho)
   wadj0(ii, jj, irho) = two*wadj1(ii, jj, irho) - wadj2(ii, jj, irho&
   &        )
   IF (factor*wadj1(ii, jj, irho) .LT. wadj0(ii, jj, irho)) THEN
   wadj0(ii, jj, irho) = wadj0(ii, jj, irho)
   ELSE
   wadj0d(ii, jj, irho) = factor*wadj1d(ii, jj, irho)
   wadj0(ii, jj, irho) = factor*wadj1(ii, jj, irho)
   END IF
   wadj0d(ii, jj, ivx) = two*wadj1d(ii, jj, ivx) - wadj2d(ii, jj, ivx&
   &        )
   wadj0(ii, jj, ivx) = two*wadj1(ii, jj, ivx) - wadj2(ii, jj, ivx)
   wadj0d(ii, jj, ivy) = two*wadj1d(ii, jj, ivy) - wadj2d(ii, jj, ivy&
   &        )
   wadj0(ii, jj, ivy) = two*wadj1(ii, jj, ivy) - wadj2(ii, jj, ivy)
   wadj0d(ii, jj, ivz) = two*wadj1d(ii, jj, ivz) - wadj2d(ii, jj, ivz&
   &        )
   wadj0(ii, jj, ivz) = two*wadj1(ii, jj, ivz) - wadj2(ii, jj, ivz)
   padj0d(ii, jj) = two*padj1d(ii, jj) - padj2d(ii, jj)
   padj0(ii, jj) = two*padj1(ii, jj) - padj2(ii, jj)
   IF (factor*padj1(ii, jj) .LT. padj0(ii, jj)) THEN
   padj0(ii, jj) = padj0(ii, jj)
   ELSE
   padj0d(ii, jj) = factor*padj1d(ii, jj)
   padj0(ii, jj) = factor*padj1(ii, jj)
   END IF
   ! Extrapolate the turbulent variables. Use constant
   ! extrapolation.
   DO l=nt1mg,nt2mg
   wadj0d(i, j, l) = wadj1d(i, j, l)
   wadj0(i, j, l) = wadj1(i, j, l)
   END DO
   ! Compute the total energy.
   wadj0d(ii, jj, irhoe) = ovgm1*padj0d(ii, jj) + half*(wadj0d(ii, jj&
   &        , irho)*(wadj0(ii, jj, ivx)**2+wadj0(ii, jj, ivy)**2+wadj0(ii, &
   &        jj, ivz)**2)+wadj0(ii, jj, irho)*(2*wadj0(ii, jj, ivx)*wadj0d(ii&
   &        , jj, ivx)+2*wadj0(ii, jj, ivy)*wadj0d(ii, jj, ivy)+2*wadj0(ii, &
   &        jj, ivz)*wadj0d(ii, jj, ivz)))
   wadj0(ii, jj, irhoe) = ovgm1*padj0(ii, jj) + half*wadj0(ii, jj, &
   &        irho)*(wadj0(ii, jj, ivx)**2+wadj0(ii, jj, ivy)**2+wadj0(ii, jj&
   &        , ivz)**2)
   IF (kpresent) THEN
   wadj0d(ii, jj, irhoe) = wadj0d(ii, jj, irhoe) - factk*(wadj0d(ii&
   &          , jj, irho)*wadj0(ii, jj, itu1)+wadj0(ii, jj, irho)*wadj0d(ii&
   &          , jj, itu1))
   wadj0(ii, jj, irhoe) = wadj0(ii, jj, irhoe) - factk*wadj0(ii, jj&
   &          , irho)*wadj0(ii, jj, itu1)
   END IF
   END DO
   END DO
   END SUBROUTINE EXTRAPOLATE2NDHALONKPC_D
