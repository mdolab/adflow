   !        Generated by TAPENADE     (INRIA, Tropics team)
   !  Tapenade - Version 2.2 (r1239) - Wed 28 Jun 2006 04:59:55 PM CEST
   !  
   !  Differentiation of extractbcstatesnkpc in reverse (adjoint) mode:
   !   gradient, with respect to input variables: padj0 padj1 padj2
   !                padj padj3 wadj wadj0 wadj1 wadj2 wadj3
   !   of linear combination of output variables: padj0 padj1 padj2
   !                padj padj3 wadj wadj0 wadj1 wadj2 wadj3
   !
   !      ******************************************************************
   !      *                                                                *
   !      * File:          extractBCStatesAdj.f90                             *
   !      * Author:        C.A.(Sandy) Mader                               *
   !      * Starting date: 04-16-2008                                      *
   !      * Last modified: 04-16-2008                                      *
   !      *                                                                *
   !      ******************************************************************
   !
   SUBROUTINE EXTRACTBCSTATESNKPC_B(nn, wadj, wadjb, padj, padjb, wadj0, &
   &  wadj0b, wadj1, wadj1b, wadj2, wadj2b, wadj3, wadj3b, padj0, padj0b, &
   &  padj1, padj1b, padj2, padj2b, padj3, padj3b, rlvadj, revadj, rlvadj1&
   &  , rlvadj2, revadj1, revadj2, ioffset, joffset, koffset, icell, jcell&
   &  , kcell, isbeg, jsbeg, ksbeg, isend, jsend, ksend, ibbeg, jbbeg, &
   &  kbbeg, ibend, jbend, kbend, icbeg, jcbeg, icend, jcend, secondhalo, &
   &  nnn, level, sps, sps2)
   USE bctypes
   USE blockpointers, ONLY : ie, ib, je, jb, ke, kb, nbocos, bcfaceid, &
   &  bctype, bcdata
   USE flowvarrefstate
   USE inputtimespectral
   IMPLICIT NONE
   INTEGER(KIND=INTTYPE), INTENT(IN) :: ibbeg
   INTEGER(KIND=INTTYPE), INTENT(IN) :: ibend
   INTEGER(KIND=INTTYPE), INTENT(IN) :: icell
   INTEGER(KIND=INTTYPE) :: icbeg, icend, jcbeg, jcend
   INTEGER(KIND=INTTYPE) :: ioffset, joffset, koffset
   INTEGER(KIND=INTTYPE), INTENT(IN) :: isbeg
   INTEGER(KIND=INTTYPE), INTENT(IN) :: isend
   INTEGER(KIND=INTTYPE), INTENT(IN) :: jbbeg
   INTEGER(KIND=INTTYPE), INTENT(IN) :: jbend
   INTEGER(KIND=INTTYPE), INTENT(IN) :: jcell
   INTEGER(KIND=INTTYPE), INTENT(IN) :: jsbeg
   INTEGER(KIND=INTTYPE), INTENT(IN) :: jsend
   INTEGER(KIND=INTTYPE), INTENT(IN) :: kbbeg
   INTEGER(KIND=INTTYPE), INTENT(IN) :: kbend
   INTEGER(KIND=INTTYPE), INTENT(IN) :: kcell
   INTEGER(KIND=INTTYPE), INTENT(IN) :: ksbeg
   INTEGER(KIND=INTTYPE), INTENT(IN) :: ksend
   INTEGER(KIND=INTTYPE), INTENT(IN) :: level
   INTEGER(KIND=INTTYPE), INTENT(IN) :: nn
   INTEGER(KIND=INTTYPE), INTENT(IN) :: nnn
   REAL(KIND=REALTYPE), DIMENSION(-2:2, -2:2, -2:2, &
   &  ntimeintervalsspectral), INTENT(IN) :: padj
   REAL(KIND=REALTYPE) :: padj0(-2:2, -2:2), padj0b(-2:2, -2:2), padj1(-2&
   &  :2, -2:2), padj1b(-2:2, -2:2)
   REAL(KIND=REALTYPE) :: padj2(-2:2, -2:2), padj2b(-2:2, -2:2), padj3(-2&
   &  :2, -2:2), padj3b(-2:2, -2:2)
   REAL(KIND=REALTYPE) :: padjb(-2:2, -2:2, -2:2, ntimeintervalsspectral)
   REAL(KIND=REALTYPE) :: revadj1(-2:2, -2:2), revadj2(-2:2, -2:2)
   REAL(KIND=REALTYPE) :: revadj(-2:2, -2:2, -2:2), rlvadj(-2:2, -2:2, -2&
   &  :2)
   REAL(KIND=REALTYPE) :: rlvadj1(-2:2, -2:2), rlvadj2(-2:2, -2:2)
   LOGICAL :: secondhalo
   INTEGER(KIND=INTTYPE), INTENT(IN) :: sps
   INTEGER(KIND=INTTYPE), INTENT(IN) :: sps2
   REAL(KIND=REALTYPE), DIMENSION(-2:2, -2:2, -2:2, nw, &
   &  ntimeintervalsspectral), INTENT(IN) :: wadj
   REAL(KIND=REALTYPE) :: wadj0(-2:2, -2:2, nw), wadj0b(-2:2, -2:2, nw), &
   &  wadj1(-2:2, -2:2, nw), wadj1b(-2:2, -2:2, nw)
   REAL(KIND=REALTYPE) :: wadj2(-2:2, -2:2, nw), wadj2b(-2:2, -2:2, nw), &
   &  wadj3(-2:2, -2:2, nw), wadj3b(-2:2, -2:2, nw)
   REAL(KIND=REALTYPE) :: wadjb(-2:2, -2:2, -2:2, nw, &
   &  ntimeintervalsspectral)
   INTEGER :: branch
   LOGICAL :: ioverlap, joverlap, koverlap
   INTEGER(KIND=INTTYPE) :: irbeg, irend, jrbeg, jrend, krbeg, krend
   INTRINSIC MAX, MIN
   IF (isbeg .LT. ibbeg) THEN
   irbeg = ibbeg
   CALL PUSHINTEGER4(1)
   ELSE
   irbeg = isbeg
   CALL PUSHINTEGER4(0)
   END IF
   IF (isend .GT. ibend) THEN
   irend = ibend
   CALL PUSHINTEGER4(1)
   ELSE
   irend = isend
   CALL PUSHINTEGER4(0)
   END IF
   IF (jsbeg .LT. jbbeg) THEN
   jrbeg = jbbeg
   CALL PUSHINTEGER4(1)
   ELSE
   jrbeg = jsbeg
   CALL PUSHINTEGER4(0)
   END IF
   IF (jsend .GT. jbend) THEN
   jrend = jbend
   CALL PUSHINTEGER4(1)
   ELSE
   jrend = jsend
   CALL PUSHINTEGER4(0)
   END IF
   IF (ksbeg .LT. kbbeg) THEN
   krbeg = kbbeg
   CALL PUSHINTEGER4(1)
   ELSE
   krbeg = ksbeg
   CALL PUSHINTEGER4(0)
   END IF
   IF (ksend .GT. kbend) THEN
   krend = kbend
   CALL PUSHINTEGER4(1)
   ELSE
   krend = ksend
   CALL PUSHINTEGER4(0)
   END IF
   ! Set some pointers depending on the situation.
   SELECT CASE  (bcfaceid(nn)) 
   CASE (imin) 
   CALL PUSHBOOLEAN(secondhalo)
   ! Other straightforward stuff.
   secondhalo = .true.
   IF (irbeg .EQ. irend) THEN
   secondhalo = .false.
   CALL PUSHINTEGER4(1)
   ELSE
   CALL PUSHINTEGER4(0)
   END IF
   IF (secondhalo) THEN
   padjb(1, -2:2, -2:2, sps2) = padjb(1, -2:2, -2:2, sps2) + padj3b(-&
   &        2:2, -2:2)
   padj3b(-2:2, -2:2) = 0.0
   padjb(0, -2:2, -2:2, sps2) = padjb(0, -2:2, -2:2, sps2) + padj2b(-&
   &        2:2, -2:2)
   padj2b(-2:2, -2:2) = 0.0
   padjb(-1, -2:2, -2:2, sps2) = padjb(-1, -2:2, -2:2, sps2) + padj1b&
   &        (-2:2, -2:2)
   padj1b(-2:2, -2:2) = 0.0
   padjb(-2, -2:2, -2:2, sps2) = padjb(-2, -2:2, -2:2, sps2) + padj0b&
   &        (-2:2, -2:2)
   padj0b(-2:2, -2:2) = 0.0
   wadjb(1, -2:2, -2:2, 1:nw, sps2) = wadjb(1, -2:2, -2:2, 1:nw, sps2&
   &        ) + wadj3b(-2:2, -2:2, 1:nw)
   wadj3b(-2:2, -2:2, 1:nw) = 0.0
   wadjb(0, -2:2, -2:2, 1:nw, sps2) = wadjb(0, -2:2, -2:2, 1:nw, sps2&
   &        ) + wadj2b(-2:2, -2:2, 1:nw)
   wadj2b(-2:2, -2:2, 1:nw) = 0.0
   wadjb(-1, -2:2, -2:2, 1:nw, sps2) = wadjb(-1, -2:2, -2:2, 1:nw, &
   &        sps2) + wadj1b(-2:2, -2:2, 1:nw)
   wadj1b(-2:2, -2:2, 1:nw) = 0.0
   wadjb(-2, -2:2, -2:2, 1:nw, sps2) = wadjb(-2, -2:2, -2:2, 1:nw, &
   &        sps2) + wadj0b(-2:2, -2:2, 1:nw)
   wadj0b(-2:2, -2:2, 1:nw) = 0.0
   ELSE
   padjb(0, -2:2, -2:2, sps2) = padjb(0, -2:2, -2:2, sps2) + padj3b(-&
   &        2:2, -2:2)
   padj3b(-2:2, -2:2) = 0.0
   padjb(-1, -2:2, -2:2, sps2) = padjb(-1, -2:2, -2:2, sps2) + padj2b&
   &        (-2:2, -2:2)
   padj2b(-2:2, -2:2) = 0.0
   padjb(-2, -2:2, -2:2, sps2) = padjb(-2, -2:2, -2:2, sps2) + padj1b&
   &        (-2:2, -2:2)
   padj1b(-2:2, -2:2) = 0.0
   wadjb(0, -2:2, -2:2, 1:nw, sps2) = wadjb(0, -2:2, -2:2, 1:nw, sps2&
   &        ) + wadj3b(-2:2, -2:2, 1:nw)
   wadj3b(-2:2, -2:2, 1:nw) = 0.0
   wadjb(-1, -2:2, -2:2, 1:nw, sps2) = wadjb(-1, -2:2, -2:2, 1:nw, &
   &        sps2) + wadj2b(-2:2, -2:2, 1:nw)
   wadj2b(-2:2, -2:2, 1:nw) = 0.0
   wadjb(-2, -2:2, -2:2, 1:nw, sps2) = wadjb(-2, -2:2, -2:2, 1:nw, &
   &        sps2) + wadj1b(-2:2, -2:2, 1:nw)
   wadj1b(-2:2, -2:2, 1:nw) = 0.0
   END IF
   CALL POPINTEGER4(branch)
   CALL POPBOOLEAN(secondhalo)
   CASE (imax) 
   CALL PUSHBOOLEAN(secondhalo)
   ! Other straightforward stuff.
   secondhalo = .true.
   IF (irbeg .EQ. irend) THEN
   secondhalo = .false.
   CALL PUSHINTEGER4(1)
   ELSE
   CALL PUSHINTEGER4(0)
   END IF
   IF (secondhalo) THEN
   padjb(-1, -2:2, -2:2, sps2) = padjb(-1, -2:2, -2:2, sps2) + padj3b&
   &        (-2:2, -2:2)
   padj3b(-2:2, -2:2) = 0.0
   padjb(0, -2:2, -2:2, sps2) = padjb(0, -2:2, -2:2, sps2) + padj2b(-&
   &        2:2, -2:2)
   padj2b(-2:2, -2:2) = 0.0
   padjb(1, -2:2, -2:2, sps2) = padjb(1, -2:2, -2:2, sps2) + padj1b(-&
   &        2:2, -2:2)
   padj1b(-2:2, -2:2) = 0.0
   padjb(2, -2:2, -2:2, sps2) = padjb(2, -2:2, -2:2, sps2) + padj0b(-&
   &        2:2, -2:2)
   padj0b(-2:2, -2:2) = 0.0
   wadjb(-1, -2:2, -2:2, 1:nw, sps2) = wadjb(-1, -2:2, -2:2, 1:nw, &
   &        sps2) + wadj3b(-2:2, -2:2, 1:nw)
   wadj3b(-2:2, -2:2, 1:nw) = 0.0
   wadjb(0, -2:2, -2:2, 1:nw, sps2) = wadjb(0, -2:2, -2:2, 1:nw, sps2&
   &        ) + wadj2b(-2:2, -2:2, 1:nw)
   wadj2b(-2:2, -2:2, 1:nw) = 0.0
   wadjb(1, -2:2, -2:2, 1:nw, sps2) = wadjb(1, -2:2, -2:2, 1:nw, sps2&
   &        ) + wadj1b(-2:2, -2:2, 1:nw)
   wadj1b(-2:2, -2:2, 1:nw) = 0.0
   wadjb(2, -2:2, -2:2, 1:nw, sps2) = wadjb(2, -2:2, -2:2, 1:nw, sps2&
   &        ) + wadj0b(-2:2, -2:2, 1:nw)
   wadj0b(-2:2, -2:2, 1:nw) = 0.0
   ELSE
   padjb(0, -2:2, -2:2, sps2) = padjb(0, -2:2, -2:2, sps2) + padj3b(-&
   &        2:2, -2:2)
   padj3b(-2:2, -2:2) = 0.0
   padjb(1, -2:2, -2:2, sps2) = padjb(1, -2:2, -2:2, sps2) + padj2b(-&
   &        2:2, -2:2)
   padj2b(-2:2, -2:2) = 0.0
   padjb(2, -2:2, -2:2, sps2) = padjb(2, -2:2, -2:2, sps2) + padj1b(-&
   &        2:2, -2:2)
   padj1b(-2:2, -2:2) = 0.0
   wadjb(0, -2:2, -2:2, 1:nw, sps2) = wadjb(0, -2:2, -2:2, 1:nw, sps2&
   &        ) + wadj3b(-2:2, -2:2, 1:nw)
   wadj3b(-2:2, -2:2, 1:nw) = 0.0
   wadjb(1, -2:2, -2:2, 1:nw, sps2) = wadjb(1, -2:2, -2:2, 1:nw, sps2&
   &        ) + wadj2b(-2:2, -2:2, 1:nw)
   wadj2b(-2:2, -2:2, 1:nw) = 0.0
   wadjb(2, -2:2, -2:2, 1:nw, sps2) = wadjb(2, -2:2, -2:2, 1:nw, sps2&
   &        ) + wadj1b(-2:2, -2:2, 1:nw)
   wadj1b(-2:2, -2:2, 1:nw) = 0.0
   END IF
   CALL POPINTEGER4(branch)
   CALL POPBOOLEAN(secondhalo)
   CASE (jmin) 
   CALL PUSHBOOLEAN(secondhalo)
   ! Other straightforward stuff.
   secondhalo = .true.
   IF (jrbeg .EQ. jrend) THEN
   secondhalo = .false.
   CALL PUSHINTEGER4(1)
   ELSE
   CALL PUSHINTEGER4(0)
   END IF
   IF (secondhalo) THEN
   padjb(-2:2, 1, -2:2, sps2) = padjb(-2:2, 1, -2:2, sps2) + padj3b(-&
   &        2:2, -2:2)
   padj3b(-2:2, -2:2) = 0.0
   padjb(-2:2, 0, -2:2, sps2) = padjb(-2:2, 0, -2:2, sps2) + padj2b(-&
   &        2:2, -2:2)
   padj2b(-2:2, -2:2) = 0.0
   padjb(-2:2, -1, -2:2, sps2) = padjb(-2:2, -1, -2:2, sps2) + padj1b&
   &        (-2:2, -2:2)
   padj1b(-2:2, -2:2) = 0.0
   padjb(-2:2, -2, -2:2, sps2) = padjb(-2:2, -2, -2:2, sps2) + padj0b&
   &        (-2:2, -2:2)
   padj0b(-2:2, -2:2) = 0.0
   wadjb(-2:2, 1, -2:2, 1:nw, sps2) = wadjb(-2:2, 1, -2:2, 1:nw, sps2&
   &        ) + wadj3b(-2:2, -2:2, 1:nw)
   wadj3b(-2:2, -2:2, 1:nw) = 0.0
   wadjb(-2:2, 0, -2:2, 1:nw, sps2) = wadjb(-2:2, 0, -2:2, 1:nw, sps2&
   &        ) + wadj2b(-2:2, -2:2, 1:nw)
   wadj2b(-2:2, -2:2, 1:nw) = 0.0
   wadjb(-2:2, -1, -2:2, 1:nw, sps2) = wadjb(-2:2, -1, -2:2, 1:nw, &
   &        sps2) + wadj1b(-2:2, -2:2, 1:nw)
   wadj1b(-2:2, -2:2, 1:nw) = 0.0
   wadjb(-2:2, -2, -2:2, 1:nw, sps2) = wadjb(-2:2, -2, -2:2, 1:nw, &
   &        sps2) + wadj0b(-2:2, -2:2, 1:nw)
   wadj0b(-2:2, -2:2, 1:nw) = 0.0
   ELSE
   padjb(-2:2, 0, -2:2, sps2) = padjb(-2:2, 0, -2:2, sps2) + padj3b(-&
   &        2:2, -2:2)
   padj3b(-2:2, -2:2) = 0.0
   padjb(-2:2, -1, -2:2, sps2) = padjb(-2:2, -1, -2:2, sps2) + padj2b&
   &        (-2:2, -2:2)
   padj2b(-2:2, -2:2) = 0.0
   padjb(-2:2, -2, -2:2, sps2) = padjb(-2:2, -2, -2:2, sps2) + padj1b&
   &        (-2:2, -2:2)
   padj1b(-2:2, -2:2) = 0.0
   wadjb(-2:2, 0, -2:2, 1:nw, sps2) = wadjb(-2:2, 0, -2:2, 1:nw, sps2&
   &        ) + wadj3b(-2:2, -2:2, 1:nw)
   wadj3b(-2:2, -2:2, 1:nw) = 0.0
   wadjb(-2:2, -1, -2:2, 1:nw, sps2) = wadjb(-2:2, -1, -2:2, 1:nw, &
   &        sps2) + wadj2b(-2:2, -2:2, 1:nw)
   wadj2b(-2:2, -2:2, 1:nw) = 0.0
   wadjb(-2:2, -2, -2:2, 1:nw, sps2) = wadjb(-2:2, -2, -2:2, 1:nw, &
   &        sps2) + wadj1b(-2:2, -2:2, 1:nw)
   wadj1b(-2:2, -2:2, 1:nw) = 0.0
   END IF
   CALL POPINTEGER4(branch)
   CALL POPBOOLEAN(secondhalo)
   CASE (jmax) 
   CALL PUSHBOOLEAN(secondhalo)
   ! Other straightforward stuff.
   secondhalo = .true.
   IF (jrbeg .EQ. jrend) THEN
   secondhalo = .false.
   CALL PUSHINTEGER4(1)
   ELSE
   CALL PUSHINTEGER4(0)
   END IF
   IF (secondhalo) THEN
   padjb(-2:2, -1, -2:2, sps2) = padjb(-2:2, -1, -2:2, sps2) + padj3b&
   &        (-2:2, -2:2)
   padj3b(-2:2, -2:2) = 0.0
   padjb(-2:2, 0, -2:2, sps2) = padjb(-2:2, 0, -2:2, sps2) + padj2b(-&
   &        2:2, -2:2)
   padj2b(-2:2, -2:2) = 0.0
   padjb(-2:2, 1, -2:2, sps2) = padjb(-2:2, 1, -2:2, sps2) + padj1b(-&
   &        2:2, -2:2)
   padj1b(-2:2, -2:2) = 0.0
   padjb(-2:2, 2, -2:2, sps2) = padjb(-2:2, 2, -2:2, sps2) + padj0b(-&
   &        2:2, -2:2)
   padj0b(-2:2, -2:2) = 0.0
   wadjb(-2:2, -1, -2:2, 1:nw, sps2) = wadjb(-2:2, -1, -2:2, 1:nw, &
   &        sps2) + wadj3b(-2:2, -2:2, 1:nw)
   wadj3b(-2:2, -2:2, 1:nw) = 0.0
   wadjb(-2:2, 0, -2:2, 1:nw, sps2) = wadjb(-2:2, 0, -2:2, 1:nw, sps2&
   &        ) + wadj2b(-2:2, -2:2, 1:nw)
   wadj2b(-2:2, -2:2, 1:nw) = 0.0
   wadjb(-2:2, 1, -2:2, 1:nw, sps2) = wadjb(-2:2, 1, -2:2, 1:nw, sps2&
   &        ) + wadj1b(-2:2, -2:2, 1:nw)
   wadj1b(-2:2, -2:2, 1:nw) = 0.0
   wadjb(-2:2, 2, -2:2, 1:nw, sps2) = wadjb(-2:2, 2, -2:2, 1:nw, sps2&
   &        ) + wadj0b(-2:2, -2:2, 1:nw)
   wadj0b(-2:2, -2:2, 1:nw) = 0.0
   ELSE
   padjb(-2:2, 0, -2:2, sps2) = padjb(-2:2, 0, -2:2, sps2) + padj3b(-&
   &        2:2, -2:2)
   padj3b(-2:2, -2:2) = 0.0
   padjb(-2:2, 1, -2:2, sps2) = padjb(-2:2, 1, -2:2, sps2) + padj2b(-&
   &        2:2, -2:2)
   padj2b(-2:2, -2:2) = 0.0
   padjb(-2:2, 2, -2:2, sps2) = padjb(-2:2, 2, -2:2, sps2) + padj1b(-&
   &        2:2, -2:2)
   padj1b(-2:2, -2:2) = 0.0
   wadjb(-2:2, 0, -2:2, 1:nw, sps2) = wadjb(-2:2, 0, -2:2, 1:nw, sps2&
   &        ) + wadj3b(-2:2, -2:2, 1:nw)
   wadj3b(-2:2, -2:2, 1:nw) = 0.0
   wadjb(-2:2, 1, -2:2, 1:nw, sps2) = wadjb(-2:2, 1, -2:2, 1:nw, sps2&
   &        ) + wadj2b(-2:2, -2:2, 1:nw)
   wadj2b(-2:2, -2:2, 1:nw) = 0.0
   wadjb(-2:2, 2, -2:2, 1:nw, sps2) = wadjb(-2:2, 2, -2:2, 1:nw, sps2&
   &        ) + wadj1b(-2:2, -2:2, 1:nw)
   wadj1b(-2:2, -2:2, 1:nw) = 0.0
   END IF
   CALL POPINTEGER4(branch)
   CALL POPBOOLEAN(secondhalo)
   CASE (kmin) 
   CALL PUSHBOOLEAN(secondhalo)
   ! Other straightforward stuff.
   secondhalo = .true.
   IF (krbeg .EQ. krend) THEN
   secondhalo = .false.
   CALL PUSHINTEGER4(1)
   ELSE
   CALL PUSHINTEGER4(0)
   END IF
   IF (secondhalo) THEN
   padjb(-2:2, -2:2, 1, sps2) = padjb(-2:2, -2:2, 1, sps2) + padj3b(-&
   &        2:2, -2:2)
   padj3b(-2:2, -2:2) = 0.0
   padjb(-2:2, -2:2, 0, sps2) = padjb(-2:2, -2:2, 0, sps2) + padj2b(-&
   &        2:2, -2:2)
   padj2b(-2:2, -2:2) = 0.0
   padjb(-2:2, -2:2, -1, sps2) = padjb(-2:2, -2:2, -1, sps2) + padj1b&
   &        (-2:2, -2:2)
   padj1b(-2:2, -2:2) = 0.0
   padjb(-2:2, -2:2, -2, sps2) = padjb(-2:2, -2:2, -2, sps2) + padj0b&
   &        (-2:2, -2:2)
   padj0b(-2:2, -2:2) = 0.0
   wadjb(-2:2, -2:2, 1, 1:nw, sps2) = wadjb(-2:2, -2:2, 1, 1:nw, sps2&
   &        ) + wadj3b(-2:2, -2:2, 1:nw)
   wadj3b(-2:2, -2:2, 1:nw) = 0.0
   wadjb(-2:2, -2:2, 0, 1:nw, sps2) = wadjb(-2:2, -2:2, 0, 1:nw, sps2&
   &        ) + wadj2b(-2:2, -2:2, 1:nw)
   wadj2b(-2:2, -2:2, 1:nw) = 0.0
   wadjb(-2:2, -2:2, -1, 1:nw, sps2) = wadjb(-2:2, -2:2, -1, 1:nw, &
   &        sps2) + wadj1b(-2:2, -2:2, 1:nw)
   wadj1b(-2:2, -2:2, 1:nw) = 0.0
   wadjb(-2:2, -2:2, -2, 1:nw, sps2) = wadjb(-2:2, -2:2, -2, 1:nw, &
   &        sps2) + wadj0b(-2:2, -2:2, 1:nw)
   wadj0b(-2:2, -2:2, 1:nw) = 0.0
   ELSE
   padjb(-2:2, -2:2, 0, sps2) = padjb(-2:2, -2:2, 0, sps2) + padj3b(-&
   &        2:2, -2:2)
   padj3b(-2:2, -2:2) = 0.0
   padjb(-2:2, -2:2, -1, sps2) = padjb(-2:2, -2:2, -1, sps2) + padj2b&
   &        (-2:2, -2:2)
   padj2b(-2:2, -2:2) = 0.0
   padjb(-2:2, -2:2, -2, sps2) = padjb(-2:2, -2:2, -2, sps2) + padj1b&
   &        (-2:2, -2:2)
   padj1b(-2:2, -2:2) = 0.0
   wadjb(-2:2, -2:2, 0, 1:nw, sps2) = wadjb(-2:2, -2:2, 0, 1:nw, sps2&
   &        ) + wadj3b(-2:2, -2:2, 1:nw)
   wadj3b(-2:2, -2:2, 1:nw) = 0.0
   wadjb(-2:2, -2:2, -1, 1:nw, sps2) = wadjb(-2:2, -2:2, -1, 1:nw, &
   &        sps2) + wadj2b(-2:2, -2:2, 1:nw)
   wadj2b(-2:2, -2:2, 1:nw) = 0.0
   wadjb(-2:2, -2:2, -2, 1:nw, sps2) = wadjb(-2:2, -2:2, -2, 1:nw, &
   &        sps2) + wadj1b(-2:2, -2:2, 1:nw)
   wadj1b(-2:2, -2:2, 1:nw) = 0.0
   END IF
   CALL POPINTEGER4(branch)
   CALL POPBOOLEAN(secondhalo)
   CASE (kmax) 
   CALL PUSHBOOLEAN(secondhalo)
   ! Other straightforward stuff.
   secondhalo = .true.
   IF (krbeg .EQ. krend) THEN
   secondhalo = .false.
   CALL PUSHINTEGER4(1)
   ELSE
   CALL PUSHINTEGER4(0)
   END IF
   IF (secondhalo) THEN
   padjb(-2:2, -2:2, -1, sps2) = padjb(-2:2, -2:2, -1, sps2) + padj3b&
   &        (-2:2, -2:2)
   padj3b(-2:2, -2:2) = 0.0
   padjb(-2:2, -2:2, 0, sps2) = padjb(-2:2, -2:2, 0, sps2) + padj2b(-&
   &        2:2, -2:2)
   padj2b(-2:2, -2:2) = 0.0
   padjb(-2:2, -2:2, 1, sps2) = padjb(-2:2, -2:2, 1, sps2) + padj1b(-&
   &        2:2, -2:2)
   padj1b(-2:2, -2:2) = 0.0
   padjb(-2:2, -2:2, 2, sps2) = padjb(-2:2, -2:2, 2, sps2) + padj0b(-&
   &        2:2, -2:2)
   padj0b(-2:2, -2:2) = 0.0
   wadjb(-2:2, -2:2, -1, 1:nw, sps2) = wadjb(-2:2, -2:2, -1, 1:nw, &
   &        sps2) + wadj3b(-2:2, -2:2, 1:nw)
   wadj3b(-2:2, -2:2, 1:nw) = 0.0
   wadjb(-2:2, -2:2, 0, 1:nw, sps2) = wadjb(-2:2, -2:2, 0, 1:nw, sps2&
   &        ) + wadj2b(-2:2, -2:2, 1:nw)
   wadj2b(-2:2, -2:2, 1:nw) = 0.0
   wadjb(-2:2, -2:2, 1, 1:nw, sps2) = wadjb(-2:2, -2:2, 1, 1:nw, sps2&
   &        ) + wadj1b(-2:2, -2:2, 1:nw)
   wadj1b(-2:2, -2:2, 1:nw) = 0.0
   wadjb(-2:2, -2:2, 2, 1:nw, sps2) = wadjb(-2:2, -2:2, 2, 1:nw, sps2&
   &        ) + wadj0b(-2:2, -2:2, 1:nw)
   wadj0b(-2:2, -2:2, 1:nw) = 0.0
   ELSE
   padjb(-2:2, -2:2, 0, sps2) = padjb(-2:2, -2:2, 0, sps2) + padj3b(-&
   &        2:2, -2:2)
   padj3b(-2:2, -2:2) = 0.0
   padjb(-2:2, -2:2, 1, sps2) = padjb(-2:2, -2:2, 1, sps2) + padj2b(-&
   &        2:2, -2:2)
   padj2b(-2:2, -2:2) = 0.0
   padjb(-2:2, -2:2, 2, sps2) = padjb(-2:2, -2:2, 2, sps2) + padj1b(-&
   &        2:2, -2:2)
   padj1b(-2:2, -2:2) = 0.0
   wadjb(-2:2, -2:2, 0, 1:nw, sps2) = wadjb(-2:2, -2:2, 0, 1:nw, sps2&
   &        ) + wadj3b(-2:2, -2:2, 1:nw)
   wadj3b(-2:2, -2:2, 1:nw) = 0.0
   wadjb(-2:2, -2:2, 1, 1:nw, sps2) = wadjb(-2:2, -2:2, 1, 1:nw, sps2&
   &        ) + wadj2b(-2:2, -2:2, 1:nw)
   wadj2b(-2:2, -2:2, 1:nw) = 0.0
   wadjb(-2:2, -2:2, 2, 1:nw, sps2) = wadjb(-2:2, -2:2, 2, 1:nw, sps2&
   &        ) + wadj1b(-2:2, -2:2, 1:nw)
   wadj1b(-2:2, -2:2, 1:nw) = 0.0
   END IF
   CALL POPINTEGER4(branch)
   CALL POPBOOLEAN(secondhalo)
   END SELECT
   CALL POPINTEGER4(branch)
   CALL POPINTEGER4(branch)
   CALL POPINTEGER4(branch)
   CALL POPINTEGER4(branch)
   CALL POPINTEGER4(branch)
   CALL POPINTEGER4(branch)
   END SUBROUTINE EXTRACTBCSTATESNKPC_B
