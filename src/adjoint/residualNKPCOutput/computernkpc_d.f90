!        Generated by TAPENADE     (INRIA, Tropics team)
!  Tapenade 3.4 (r3375) - 10 Feb 2010 15:08
!
!  Differentiation of computernkpc in forward (tangent) mode:
!   variations   of useful results: dwadj wadj
!   with respect to varying inputs: wadj
!   RW status of diff variables: dwadj:out wadj:in-out
!
!      ******************************************************************
!      *                                                                *
!      * File:          computeRAdj.f90                                 *
!      * Author:        C.A.(Sandy) Mader                               *
!      * Starting date: 02-01-2008                                      *
!      * Last modified: 04-23-2008                                      *
!      *                                                                *
!      ******************************************************************
SUBROUTINE COMPUTERNKPC_D(wadj, wadjd, dwadj, dwadjd, siadj, sjadj, &
     &  skadj, sadj, voladj, sfaceiadj, sfacejadj, sfacekadj, rotrateadj, &
     &  icell, jcell, kcell, nn, level, sps)
  USE FLOWVARREFSTATE
  USE BLOCKPOINTERS
  USE SECTION
  USE INPUTTIMESPECTRAL
  USE INPUTPHYSICS
  IMPLICIT NONE
  ! Passed in Variables
  ! Input Variables --- Note no intent(in) --- this can cause problems
  ! with reverse mode AD
  INTEGER(kind=inttype), INTENT(IN) :: icell, jcell, kcell, nn, level, &
       &  sps
  REAL(kind=realtype), DIMENSION(-2:2, -2:2, -2:2, nw, &
       &  ntimeintervalsspectral) :: wadj
  REAL(kind=realtype), DIMENSION(-2:2, -2:2, -2:2, nw, &
       &  ntimeintervalsspectral) :: wadjd
  REAL(kind=realtype), DIMENSION(-3:2, -3:2, -3:2, 3, &
       &  ntimeintervalsspectral) :: siadj, sjadj, skadj
  REAL(kind=realtype), DIMENSION(-2:2, -2:2, -2:2, 3, &
       &  ntimeintervalsspectral) :: sadj
  REAL(kind=realtype), DIMENSION(ntimeintervalsspectral) :: voladj
  REAL(kind=realtype), DIMENSION(-2:2, -2:2, -2:2, &
       &  ntimeintervalsspectral) :: sfaceiadj, sfacejadj, sfacekadj
  REAL(kind=realtype), DIMENSION(3) :: rotrateadj
  ! Ouptut Variables
  REAL(kind=realtype), DIMENSION(nw, ntimeintervalsspectral) :: dwadj
  REAL(kind=realtype), DIMENSION(nw, ntimeintervalsspectral) :: dwadjd
  !      Set Local Variables
  REAL(kind=realtype), DIMENSION(-2:2, -2:2, -2:2, &
       &  ntimeintervalsspectral) :: padj
  REAL(kind=realtype), DIMENSION(-2:2, -2:2, -2:2, &
       &  ntimeintervalsspectral) :: padjd
  REAL(kind=realtype), DIMENSION(nbocos, -2:2, -2:2, 3, &
       &  ntimeintervalsspectral) :: normadj
  REAL(kind=realtype), DIMENSION(nbocos, -2:2, -2:2, &
       &  ntimeintervalsspectral) :: rfaceadj
  REAL(kind=realtype), DIMENSION(-1:1, -1:1, -1:1, &
       &  ntimeintervalsspectral) :: radiadj, radjadj, radkadj
  REAL(kind=realtype), DIMENSION(-1:1, -1:1, -1:1, &
       &  ntimeintervalsspectral) :: radiadjd, radjadjd, radkadjd
  REAL(kind=realtype), DIMENSION(nsections) :: t
  ! Integer variables
  INTEGER(kind=inttype) :: sps2
  ! Logical 
  LOGICAL :: secondhalo, correctfork
  secondhalo = .true.
  correctfork = .false.
  padjd = 0.0
  radkadjd = 0.0
  radjadjd = 0.0
  radiadjd = 0.0
  DO sps2=1,ntimeintervalsspectral
     CALL COMPUTENORMNKPC(siadj, sjadj, skadj, normadj, icell, jcell, &
          &                      kcell, nn, level, sps, sps2)
     !Compute the Pressure in the stencil based on the current 
     !States
     CALL NORMALVELOCITIESALLLEVELSNKPC(sps, icell, jcell, kcell, &
          &                                    sfaceiadj, sfacejadj, sfacekadj, &
          &                                    siadj, sjadj, skadj, rfaceadj, nn, &
          &                                    level, sps2)
     CALL COMPUTEPRESSURENKPC_D(wadj, wadjd, padj, padjd, nn, level, sps&
          &                         , sps2)
     ! Apply all boundary conditions to stencil.
     ! In case of a full mg mode, and a segegated turbulent solver,
     ! first call the turbulent boundary conditions, such that the
     ! turbulent kinetic energy is properly initialized in the halo's.
     CALL APPLYALLBCNKPC_D(winf, pinfcorr, wadj, wadjd, padj, padjd, sadj&
          &                    , siadj, sjadj, skadj, voladj, normadj, rfaceadj, &
          &                    icell, jcell, kcell, secondhalo, nn, level, sps, &
          &                    sps2)
     CALL TIMESTEPNKPC_D(.true., wadj, wadjd, padj, padjd, siadj, sjadj, &
          &                  skadj, sfaceiadj, sfacejadj, sfacekadj, voladj, &
          &                  radiadj, radiadjd, radjadj, radjadjd, radkadj, &
          &                  radkadjd, icell, jcell, kcell, pinfcorr, rhoinf, nn, &
          &                  level, sps, sps2)
  END DO
  CALL INITRESNKPC_D(1, nwf, wadj, wadjd, voladj, dwadj, dwadjd, nn, &
       &               level, sps)
  CALL RESIDUALNKPC_D(wadj, wadjd, padj, padjd, siadj, sjadj, skadj, &
       &                voladj, normadj, sfaceiadj, sfacejadj, sfacekadj, &
       &                radiadj, radiadjd, radjadj, radjadjd, radkadj, radkadjd&
       &                , dwadj, dwadjd, icell, jcell, kcell, rotrateadj, &
       &                correctfork, nn, level, sps)
  ! Finally scale the residual by the inverse of the volume.
  DO sps2=1,ntimeintervalsspectral
     dwadjd(:, sps2) = dwadjd(:, sps2)/voladj(sps2)
     dwadj(:, sps2) = dwadj(:, sps2)/voladj(sps2)
  END DO
END SUBROUTINE COMPUTERNKPC_D
