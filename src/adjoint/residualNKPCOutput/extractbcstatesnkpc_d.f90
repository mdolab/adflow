   !        Generated by TAPENADE     (INRIA, Tropics team)
   !  Tapenade 3.4 (r3375) - 10 Feb 2010 15:08
   !
   !  Differentiation of extractbcstatesnkpc in forward (tangent) mode:
   !   variations   of useful results: padj0 padj1 padj2 padj3 wadj0
   !                wadj1 wadj2 wadj3
   !   with respect to varying inputs: padj0 padj1 padj2 padj padj3
   !                wadj wadj0 wadj1 wadj2 wadj3
   !
   !      ******************************************************************
   !      *                                                                *
   !      * File:          extractBCStatesAdj.f90                             *
   !      * Author:        C.A.(Sandy) Mader                               *
   !      * Starting date: 04-16-2008                                      *
   !      * Last modified: 04-16-2008                                      *
   !      *                                                                *
   !      ******************************************************************
   !
   SUBROUTINE EXTRACTBCSTATESNKPC_D(nn, wadj, wadjd, padj, padjd, wadj0, &
   &  wadj0d, wadj1, wadj1d, wadj2, wadj2d, wadj3, wadj3d, padj0, padj0d, &
   &  padj1, padj1d, padj2, padj2d, padj3, padj3d, rlvadj, revadj, rlvadj1, &
   &  rlvadj2, revadj1, revadj2, ioffset, joffset, koffset, icell, jcell, &
   &  kcell, isbeg, jsbeg, ksbeg, isend, jsend, ksend, ibbeg, jbbeg, kbbeg, &
   &  ibend, jbend, kbend, icbeg, jcbeg, icend, jcend, secondhalo, nnn, &
   &  level, sps, sps2)
   USE FLOWVARREFSTATE
   USE BLOCKPOINTERS, ONLY : ie, ib, je, jb, ke, kb, nbocos, bcfaceid, &
   &  bctype, bcdata
   USE INPUTTIMESPECTRAL
   USE BCTYPES
   IMPLICIT NONE
   !      ******************************************************************
   !      *                                                                *
   !      * copyBCStatesAdj copies the states needed for the boundary      *
   !      * condition treatment on a general face, such that the boundary  *
   !      * routines are only implemented once instead of 6 times.         *
   !      * This routine takes the place of setBCPointers in the orginal   *
   !      * Code                                                           *
   !      *                                                                *
   !      ******************************************************************
   !
   !nIntervalTimespectral
   !
   !      Subroutine arguments.
   !
   !, offset
   INTEGER(kind=inttype), INTENT(IN) :: nn, nnn, level, sps, sps2
   INTEGER(kind=inttype), INTENT(IN) :: icell, jcell, kcell
   INTEGER(kind=inttype), INTENT(IN) :: isbeg, jsbeg, ksbeg, isend, jsend&
   &  , ksend
   INTEGER(kind=inttype), INTENT(IN) :: ibbeg, jbbeg, kbbeg, ibend, jbend&
   &  , kbend
   INTEGER(kind=inttype) :: icbeg, jcbeg, icend, jcend
   INTEGER(kind=inttype) :: irbeg, jrbeg, krbeg, irend, jrend, krend
   INTEGER(kind=inttype) :: ioffset, joffset, koffset
   REAL(kind=realtype), DIMENSION(-2:2, -2:2, -2:2, nw, &
   &  ntimeintervalsspectral), INTENT(IN) :: wadj
   REAL(kind=realtype), DIMENSION(-2:2, -2:2, -2:2, nw, &
   &  ntimeintervalsspectral), INTENT(IN) :: wadjd
   REAL(kind=realtype), DIMENSION(-2:2, -2:2, -2:2, &
   &  ntimeintervalsspectral), INTENT(IN) :: padj
   REAL(kind=realtype), DIMENSION(-2:2, -2:2, -2:2, &
   &  ntimeintervalsspectral), INTENT(IN) :: padjd
   REAL(kind=realtype), DIMENSION(-2:2, -2:2, nw) :: wadj0, wadj1
   REAL(kind=realtype), DIMENSION(-2:2, -2:2, nw) :: wadj0d, wadj1d
   REAL(kind=realtype), DIMENSION(-2:2, -2:2, nw) :: wadj2, wadj3
   REAL(kind=realtype), DIMENSION(-2:2, -2:2, nw) :: wadj2d, wadj3d
   REAL(kind=realtype), DIMENSION(-2:2, -2:2) :: padj0, padj1
   REAL(kind=realtype), DIMENSION(-2:2, -2:2) :: padj0d, padj1d
   REAL(kind=realtype), DIMENSION(-2:2, -2:2) :: padj2, padj3
   REAL(kind=realtype), DIMENSION(-2:2, -2:2) :: padj2d, padj3d
   REAL(kind=realtype), DIMENSION(-2:2, -2:2, -2:2) :: rlvadj, revadj
   REAL(kind=realtype), DIMENSION(-2:2, -2:2) :: rlvadj1, rlvadj2
   REAL(kind=realtype), DIMENSION(-2:2, -2:2) :: revadj1, revadj2
   LOGICAL :: ioverlap, joverlap, koverlap
   !logical,intent(inout) :: secondHalo
   LOGICAL :: secondhalo
   INTRINSIC MAX
   INTRINSIC MIN
   IF (isbeg .LT. ibbeg) THEN
   irbeg = ibbeg
   ELSE
   irbeg = isbeg
   END IF
   IF (isend .GT. ibend) THEN
   irend = ibend
   ELSE
   irend = isend
   END IF
   IF (jsbeg .LT. jbbeg) THEN
   jrbeg = jbbeg
   ELSE
   jrbeg = jsbeg
   END IF
   IF (jsend .GT. jbend) THEN
   jrend = jbend
   ELSE
   jrend = jsend
   END IF
   IF (ksbeg .LT. kbbeg) THEN
   krbeg = kbbeg
   ELSE
   krbeg = ksbeg
   END IF
   IF (ksend .GT. kbend) THEN
   krend = kbend
   ELSE
   krend = ksend
   END IF
   !          print *,'stencil',kSBeg, kBBeg,krbeg,kSEnd, kBEnd,krend
   ! Determine the offset values to be used in the computation
   ! of the halo cells. Either the cells with index -2 or with
   ! -1 corresponds to the starting cell ID of the subrange
   ! to be considered.
   IF (icell .EQ. ibbeg) THEN
   ioffset = irbeg
   ELSE
   ioffset = irbeg + 1
   END IF
   IF (isbeg .EQ. irbeg) ioffset = ioffset + 1
   IF (jcell .EQ. jbbeg) THEN
   joffset = jrbeg
   ELSE
   joffset = jrbeg + 1
   END IF
   IF (jsbeg .EQ. jrbeg) joffset = joffset + 1
   IF (kcell .EQ. kbbeg) THEN
   koffset = krbeg
   ELSE
   koffset = krbeg + 1
   END IF
   IF (ksbeg .EQ. krbeg) koffset = koffset + 1
   ! Set some pointers depending on the situation.
   SELECT CASE  (bcfaceid(nn)) 
   CASE (imin) 
   IF (jrbeg .LT. jcell - 2) THEN
   icbeg = jcell - 2
   ELSE
   icbeg = jrbeg
   END IF
   IF (jrend .GT. jcell + 2) THEN
   icend = jcell + 2
   ELSE
   icend = jrend
   END IF
   IF (krbeg .LT. kcell - 2) THEN
   jcbeg = kcell - 2
   ELSE
   jcbeg = krbeg
   END IF
   IF (krend .GT. kcell + 2) THEN
   jcend = kcell + 2
   ELSE
   jcend = krend
   END IF
   ! Other straightforward stuff.
   ioffset = joffset
   joffset = koffset
   secondhalo = .true.
   IF (irbeg .EQ. irend) secondhalo = .false.
   IF (secondhalo) THEN
   wadj0d(-2:2, -2:2, 1:nw) = wadjd(-2, -2:2, -2:2, 1:nw, sps2)
   wadj0(-2:2, -2:2, 1:nw) = wadj(-2, -2:2, -2:2, 1:nw, sps2)
   wadj1d(-2:2, -2:2, 1:nw) = wadjd(-1, -2:2, -2:2, 1:nw, sps2)
   wadj1(-2:2, -2:2, 1:nw) = wadj(-1, -2:2, -2:2, 1:nw, sps2)
   wadj2d(-2:2, -2:2, 1:nw) = wadjd(0, -2:2, -2:2, 1:nw, sps2)
   wadj2(-2:2, -2:2, 1:nw) = wadj(0, -2:2, -2:2, 1:nw, sps2)
   wadj3d(-2:2, -2:2, 1:nw) = wadjd(1, -2:2, -2:2, 1:nw, sps2)
   wadj3(-2:2, -2:2, 1:nw) = wadj(1, -2:2, -2:2, 1:nw, sps2)
   padj0d(-2:2, -2:2) = padjd(-2, -2:2, -2:2, sps2)
   padj0(-2:2, -2:2) = padj(-2, -2:2, -2:2, sps2)
   padj1d(-2:2, -2:2) = padjd(-1, -2:2, -2:2, sps2)
   padj1(-2:2, -2:2) = padj(-1, -2:2, -2:2, sps2)
   padj2d(-2:2, -2:2) = padjd(0, -2:2, -2:2, sps2)
   padj2(-2:2, -2:2) = padj(0, -2:2, -2:2, sps2)
   padj3d(-2:2, -2:2) = padjd(1, -2:2, -2:2, sps2)
   padj3(-2:2, -2:2) = padj(1, -2:2, -2:2, sps2)
   IF (viscous) THEN
   rlvadj1(-2:2, -2:2) = rlvadj(-1, -2:2, -2:2)
   rlvadj2(-2:2, -2:2) = rlvadj(0, -2:2, -2:2)
   END IF
   IF (eddymodel) THEN
   revadj1(-2:2, -2:2) = revadj(-1, -2:2, -2:2)
   revadj2(-2:2, -2:2) = revadj(0, -2:2, -2:2)
   END IF
   ELSE
   wadj1d(-2:2, -2:2, 1:nw) = wadjd(-2, -2:2, -2:2, 1:nw, sps2)
   wadj1(-2:2, -2:2, 1:nw) = wadj(-2, -2:2, -2:2, 1:nw, sps2)
   wadj2d(-2:2, -2:2, 1:nw) = wadjd(-1, -2:2, -2:2, 1:nw, sps2)
   wadj2(-2:2, -2:2, 1:nw) = wadj(-1, -2:2, -2:2, 1:nw, sps2)
   wadj3d(-2:2, -2:2, 1:nw) = wadjd(0, -2:2, -2:2, 1:nw, sps2)
   wadj3(-2:2, -2:2, 1:nw) = wadj(0, -2:2, -2:2, 1:nw, sps2)
   padj1d(-2:2, -2:2) = padjd(-2, -2:2, -2:2, sps2)
   padj1(-2:2, -2:2) = padj(-2, -2:2, -2:2, sps2)
   padj2d(-2:2, -2:2) = padjd(-1, -2:2, -2:2, sps2)
   padj2(-2:2, -2:2) = padj(-1, -2:2, -2:2, sps2)
   padj3d(-2:2, -2:2) = padjd(0, -2:2, -2:2, sps2)
   padj3(-2:2, -2:2) = padj(0, -2:2, -2:2, sps2)
   IF (viscous) THEN
   rlvadj1(-2:2, -2:2) = rlvadj(-2, -2:2, -2:2)
   rlvadj2(-2:2, -2:2) = rlvadj(-1, -2:2, -2:2)
   END IF
   IF (eddymodel) THEN
   revadj1(-2:2, -2:2) = revadj(-2, -2:2, -2:2)
   revadj2(-2:2, -2:2) = revadj(-1, -2:2, -2:2)
   END IF
   END IF
   CASE (imax) 
   IF (jrbeg .LT. jcell - 2) THEN
   icbeg = jcell - 2
   ELSE
   icbeg = jrbeg
   END IF
   IF (jrend .GT. jcell + 2) THEN
   icend = jcell + 2
   ELSE
   icend = jrend
   END IF
   IF (krbeg .LT. kcell - 2) THEN
   jcbeg = kcell - 2
   ELSE
   jcbeg = krbeg
   END IF
   IF (krend .GT. kcell + 2) THEN
   jcend = kcell + 2
   ELSE
   jcend = krend
   END IF
   ! Other straightforward stuff.
   ioffset = joffset
   joffset = koffset
   secondhalo = .true.
   IF (irbeg .EQ. irend) secondhalo = .false.
   IF (secondhalo) THEN
   wadj0d(-2:2, -2:2, 1:nw) = wadjd(2, -2:2, -2:2, 1:nw, sps2)
   wadj0(-2:2, -2:2, 1:nw) = wadj(2, -2:2, -2:2, 1:nw, sps2)
   wadj1d(-2:2, -2:2, 1:nw) = wadjd(1, -2:2, -2:2, 1:nw, sps2)
   wadj1(-2:2, -2:2, 1:nw) = wadj(1, -2:2, -2:2, 1:nw, sps2)
   wadj2d(-2:2, -2:2, 1:nw) = wadjd(0, -2:2, -2:2, 1:nw, sps2)
   wadj2(-2:2, -2:2, 1:nw) = wadj(0, -2:2, -2:2, 1:nw, sps2)
   wadj3d(-2:2, -2:2, 1:nw) = wadjd(-1, -2:2, -2:2, 1:nw, sps2)
   wadj3(-2:2, -2:2, 1:nw) = wadj(-1, -2:2, -2:2, 1:nw, sps2)
   padj0d(-2:2, -2:2) = padjd(2, -2:2, -2:2, sps2)
   padj0(-2:2, -2:2) = padj(2, -2:2, -2:2, sps2)
   padj1d(-2:2, -2:2) = padjd(1, -2:2, -2:2, sps2)
   padj1(-2:2, -2:2) = padj(1, -2:2, -2:2, sps2)
   padj2d(-2:2, -2:2) = padjd(0, -2:2, -2:2, sps2)
   padj2(-2:2, -2:2) = padj(0, -2:2, -2:2, sps2)
   padj3d(-2:2, -2:2) = padjd(-1, -2:2, -2:2, sps2)
   padj3(-2:2, -2:2) = padj(-1, -2:2, -2:2, sps2)
   IF (viscous) THEN
   rlvadj1(-2:2, -2:2) = rlvadj(1, -2:2, -2:2)
   rlvadj2(-2:2, -2:2) = rlvadj(0, -2:2, -2:2)
   END IF
   IF (eddymodel) THEN
   revadj1(-2:2, -2:2) = revadj(1, -2:2, -2:2)
   revadj2(-2:2, -2:2) = revadj(0, -2:2, -2:2)
   END IF
   ELSE
   wadj1d(-2:2, -2:2, 1:nw) = wadjd(2, -2:2, -2:2, 1:nw, sps2)
   wadj1(-2:2, -2:2, 1:nw) = wadj(2, -2:2, -2:2, 1:nw, sps2)
   wadj2d(-2:2, -2:2, 1:nw) = wadjd(1, -2:2, -2:2, 1:nw, sps2)
   wadj2(-2:2, -2:2, 1:nw) = wadj(1, -2:2, -2:2, 1:nw, sps2)
   wadj3d(-2:2, -2:2, 1:nw) = wadjd(0, -2:2, -2:2, 1:nw, sps2)
   wadj3(-2:2, -2:2, 1:nw) = wadj(0, -2:2, -2:2, 1:nw, sps2)
   padj1d(-2:2, -2:2) = padjd(2, -2:2, -2:2, sps2)
   padj1(-2:2, -2:2) = padj(2, -2:2, -2:2, sps2)
   padj2d(-2:2, -2:2) = padjd(1, -2:2, -2:2, sps2)
   padj2(-2:2, -2:2) = padj(1, -2:2, -2:2, sps2)
   padj3d(-2:2, -2:2) = padjd(0, -2:2, -2:2, sps2)
   padj3(-2:2, -2:2) = padj(0, -2:2, -2:2, sps2)
   IF (viscous) THEN
   rlvadj1(-2:2, -2:2) = rlvadj(2, -2:2, -2:2)
   rlvadj2(-2:2, -2:2) = rlvadj(1, -2:2, -2:2)
   END IF
   IF (eddymodel) THEN
   revadj1(-2:2, -2:2) = revadj(2, -2:2, -2:2)
   revadj2(-2:2, -2:2) = revadj(1, -2:2, -2:2)
   END IF
   END IF
   CASE (jmin) 
   IF (irbeg .LT. icell - 2) THEN
   icbeg = icell - 2
   ELSE
   icbeg = irbeg
   END IF
   IF (irend .GT. icell + 2) THEN
   icend = icell + 2
   ELSE
   icend = irend
   END IF
   IF (krbeg .LT. kcell - 2) THEN
   jcbeg = kcell - 2
   ELSE
   jcbeg = krbeg
   END IF
   IF (krend .GT. kcell + 2) THEN
   jcend = kcell + 2
   ELSE
   jcend = krend
   END IF
   ! Other straightforward stuff.
   joffset = koffset
   secondhalo = .true.
   IF (jrbeg .EQ. jrend) secondhalo = .false.
   IF (secondhalo) THEN
   wadj0d(-2:2, -2:2, 1:nw) = wadjd(-2:2, -2, -2:2, 1:nw, sps2)
   wadj0(-2:2, -2:2, 1:nw) = wadj(-2:2, -2, -2:2, 1:nw, sps2)
   wadj1d(-2:2, -2:2, 1:nw) = wadjd(-2:2, -1, -2:2, 1:nw, sps2)
   wadj1(-2:2, -2:2, 1:nw) = wadj(-2:2, -1, -2:2, 1:nw, sps2)
   wadj2d(-2:2, -2:2, 1:nw) = wadjd(-2:2, 0, -2:2, 1:nw, sps2)
   wadj2(-2:2, -2:2, 1:nw) = wadj(-2:2, 0, -2:2, 1:nw, sps2)
   wadj3d(-2:2, -2:2, 1:nw) = wadjd(-2:2, 1, -2:2, 1:nw, sps2)
   wadj3(-2:2, -2:2, 1:nw) = wadj(-2:2, 1, -2:2, 1:nw, sps2)
   padj0d(-2:2, -2:2) = padjd(-2:2, -2, -2:2, sps2)
   padj0(-2:2, -2:2) = padj(-2:2, -2, -2:2, sps2)
   padj1d(-2:2, -2:2) = padjd(-2:2, -1, -2:2, sps2)
   padj1(-2:2, -2:2) = padj(-2:2, -1, -2:2, sps2)
   padj2d(-2:2, -2:2) = padjd(-2:2, 0, -2:2, sps2)
   padj2(-2:2, -2:2) = padj(-2:2, 0, -2:2, sps2)
   padj3d(-2:2, -2:2) = padjd(-2:2, 1, -2:2, sps2)
   padj3(-2:2, -2:2) = padj(-2:2, 1, -2:2, sps2)
   IF (viscous) THEN
   rlvadj1(-2:2, -2:2) = rlvadj(-2:2, -1, -2:2)
   rlvadj2(-2:2, -2:2) = rlvadj(-2:2, 0, -2:2)
   END IF
   IF (eddymodel) THEN
   revadj1(-2:2, -2:2) = revadj(-2:2, -1, -2:2)
   revadj2(-2:2, -2:2) = revadj(-2:2, 0, -2:2)
   END IF
   ELSE
   wadj1d(-2:2, -2:2, 1:nw) = wadjd(-2:2, -2, -2:2, 1:nw, sps2)
   wadj1(-2:2, -2:2, 1:nw) = wadj(-2:2, -2, -2:2, 1:nw, sps2)
   wadj2d(-2:2, -2:2, 1:nw) = wadjd(-2:2, -1, -2:2, 1:nw, sps2)
   wadj2(-2:2, -2:2, 1:nw) = wadj(-2:2, -1, -2:2, 1:nw, sps2)
   wadj3d(-2:2, -2:2, 1:nw) = wadjd(-2:2, 0, -2:2, 1:nw, sps2)
   wadj3(-2:2, -2:2, 1:nw) = wadj(-2:2, 0, -2:2, 1:nw, sps2)
   padj1d(-2:2, -2:2) = padjd(-2:2, -2, -2:2, sps2)
   padj1(-2:2, -2:2) = padj(-2:2, -2, -2:2, sps2)
   padj2d(-2:2, -2:2) = padjd(-2:2, -1, -2:2, sps2)
   padj2(-2:2, -2:2) = padj(-2:2, -1, -2:2, sps2)
   padj3d(-2:2, -2:2) = padjd(-2:2, 0, -2:2, sps2)
   padj3(-2:2, -2:2) = padj(-2:2, 0, -2:2, sps2)
   IF (viscous) THEN
   rlvadj1(-2:2, -2:2) = rlvadj(-2:2, -2, -2:2)
   rlvadj2(-2:2, -2:2) = rlvadj(-2:2, -1, -2:2)
   END IF
   IF (eddymodel) THEN
   revadj1(-2:2, -2:2) = revadj(-2:2, -2, -2:2)
   revadj2(-2:2, -2:2) = revadj(-2:2, -1, -2:2)
   END IF
   END IF
   CASE (jmax) 
   IF (irbeg .LT. icell - 2) THEN
   icbeg = icell - 2
   ELSE
   icbeg = irbeg
   END IF
   IF (irend .GT. icell + 2) THEN
   icend = icell + 2
   ELSE
   icend = irend
   END IF
   IF (krbeg .LT. kcell - 2) THEN
   jcbeg = kcell - 2
   ELSE
   jcbeg = krbeg
   END IF
   IF (krend .GT. kcell + 2) THEN
   jcend = kcell + 2
   ELSE
   jcend = krend
   END IF
   ! Other straightforward stuff.
   joffset = koffset
   secondhalo = .true.
   IF (jrbeg .EQ. jrend) secondhalo = .false.
   IF (secondhalo) THEN
   wadj0d(-2:2, -2:2, 1:nw) = wadjd(-2:2, 2, -2:2, 1:nw, sps2)
   wadj0(-2:2, -2:2, 1:nw) = wadj(-2:2, 2, -2:2, 1:nw, sps2)
   wadj1d(-2:2, -2:2, 1:nw) = wadjd(-2:2, 1, -2:2, 1:nw, sps2)
   wadj1(-2:2, -2:2, 1:nw) = wadj(-2:2, 1, -2:2, 1:nw, sps2)
   wadj2d(-2:2, -2:2, 1:nw) = wadjd(-2:2, 0, -2:2, 1:nw, sps2)
   wadj2(-2:2, -2:2, 1:nw) = wadj(-2:2, 0, -2:2, 1:nw, sps2)
   wadj3d(-2:2, -2:2, 1:nw) = wadjd(-2:2, -1, -2:2, 1:nw, sps2)
   wadj3(-2:2, -2:2, 1:nw) = wadj(-2:2, -1, -2:2, 1:nw, sps2)
   padj0d(-2:2, -2:2) = padjd(-2:2, 2, -2:2, sps2)
   padj0(-2:2, -2:2) = padj(-2:2, 2, -2:2, sps2)
   padj1d(-2:2, -2:2) = padjd(-2:2, 1, -2:2, sps2)
   padj1(-2:2, -2:2) = padj(-2:2, 1, -2:2, sps2)
   padj2d(-2:2, -2:2) = padjd(-2:2, 0, -2:2, sps2)
   padj2(-2:2, -2:2) = padj(-2:2, 0, -2:2, sps2)
   padj3d(-2:2, -2:2) = padjd(-2:2, -1, -2:2, sps2)
   padj3(-2:2, -2:2) = padj(-2:2, -1, -2:2, sps2)
   IF (viscous) THEN
   rlvadj1(-2:2, -2:2) = rlvadj(-2:2, 1, -2:2)
   rlvadj2(-2:2, -2:2) = rlvadj(-2:2, 0, -2:2)
   END IF
   IF (eddymodel) THEN
   revadj1(-2:2, -2:2) = revadj(-2:2, 1, -2:2)
   revadj2(-2:2, -2:2) = revadj(-2:2, 0, -2:2)
   END IF
   ELSE
   wadj1d(-2:2, -2:2, 1:nw) = wadjd(-2:2, 2, -2:2, 1:nw, sps2)
   wadj1(-2:2, -2:2, 1:nw) = wadj(-2:2, 2, -2:2, 1:nw, sps2)
   wadj2d(-2:2, -2:2, 1:nw) = wadjd(-2:2, 1, -2:2, 1:nw, sps2)
   wadj2(-2:2, -2:2, 1:nw) = wadj(-2:2, 1, -2:2, 1:nw, sps2)
   wadj3d(-2:2, -2:2, 1:nw) = wadjd(-2:2, 0, -2:2, 1:nw, sps2)
   wadj3(-2:2, -2:2, 1:nw) = wadj(-2:2, 0, -2:2, 1:nw, sps2)
   padj1d(-2:2, -2:2) = padjd(-2:2, 2, -2:2, sps2)
   padj1(-2:2, -2:2) = padj(-2:2, 2, -2:2, sps2)
   padj2d(-2:2, -2:2) = padjd(-2:2, 1, -2:2, sps2)
   padj2(-2:2, -2:2) = padj(-2:2, 1, -2:2, sps2)
   padj3d(-2:2, -2:2) = padjd(-2:2, 0, -2:2, sps2)
   padj3(-2:2, -2:2) = padj(-2:2, 0, -2:2, sps2)
   IF (viscous) THEN
   rlvadj1(-2:2, -2:2) = rlvadj(-2:2, 2, -2:2)
   rlvadj2(-2:2, -2:2) = rlvadj(-2:2, 1, -2:2)
   END IF
   IF (eddymodel) THEN
   revadj1(-2:2, -2:2) = revadj(-2:2, 2, -2:2)
   revadj2(-2:2, -2:2) = revadj(-2:2, 1, -2:2)
   END IF
   END IF
   CASE (kmin) 
   IF (irbeg .LT. icell - 2) THEN
   icbeg = icell - 2
   ELSE
   icbeg = irbeg
   END IF
   IF (irend .GT. icell + 2) THEN
   icend = icell + 2
   ELSE
   icend = irend
   END IF
   IF (jrbeg .LT. jcell - 2) THEN
   jcbeg = jcell - 2
   ELSE
   jcbeg = jrbeg
   END IF
   IF (jrend .GT. jcell + 2) THEN
   jcend = jcell + 2
   ELSE
   jcend = jrend
   END IF
   ! Other straightforward stuff.
   secondhalo = .true.
   IF (krbeg .EQ. krend) secondhalo = .false.
   IF (secondhalo) THEN
   wadj0d(-2:2, -2:2, 1:nw) = wadjd(-2:2, -2:2, -2, 1:nw, sps2)
   wadj0(-2:2, -2:2, 1:nw) = wadj(-2:2, -2:2, -2, 1:nw, sps2)
   wadj1d(-2:2, -2:2, 1:nw) = wadjd(-2:2, -2:2, -1, 1:nw, sps2)
   wadj1(-2:2, -2:2, 1:nw) = wadj(-2:2, -2:2, -1, 1:nw, sps2)
   wadj2d(-2:2, -2:2, 1:nw) = wadjd(-2:2, -2:2, 0, 1:nw, sps2)
   wadj2(-2:2, -2:2, 1:nw) = wadj(-2:2, -2:2, 0, 1:nw, sps2)
   wadj3d(-2:2, -2:2, 1:nw) = wadjd(-2:2, -2:2, 1, 1:nw, sps2)
   wadj3(-2:2, -2:2, 1:nw) = wadj(-2:2, -2:2, 1, 1:nw, sps2)
   padj0d(-2:2, -2:2) = padjd(-2:2, -2:2, -2, sps2)
   padj0(-2:2, -2:2) = padj(-2:2, -2:2, -2, sps2)
   padj1d(-2:2, -2:2) = padjd(-2:2, -2:2, -1, sps2)
   padj1(-2:2, -2:2) = padj(-2:2, -2:2, -1, sps2)
   padj2d(-2:2, -2:2) = padjd(-2:2, -2:2, 0, sps2)
   padj2(-2:2, -2:2) = padj(-2:2, -2:2, 0, sps2)
   padj3d(-2:2, -2:2) = padjd(-2:2, -2:2, 1, sps2)
   padj3(-2:2, -2:2) = padj(-2:2, -2:2, 1, sps2)
   IF (viscous) THEN
   rlvadj1(-2:2, -2:2) = rlvadj(-2:2, -2:2, -1)
   rlvadj2(-2:2, -2:2) = rlvadj(-2:2, -2:2, 0)
   END IF
   IF (eddymodel) THEN
   revadj1(-2:2, -2:2) = revadj(-2:2, -2:2, -1)
   revadj2(-2:2, -2:2) = revadj(-2:2, -2:2, 0)
   END IF
   ELSE
   wadj1d(-2:2, -2:2, 1:nw) = wadjd(-2:2, -2:2, -2, 1:nw, sps2)
   wadj1(-2:2, -2:2, 1:nw) = wadj(-2:2, -2:2, -2, 1:nw, sps2)
   wadj2d(-2:2, -2:2, 1:nw) = wadjd(-2:2, -2:2, -1, 1:nw, sps2)
   wadj2(-2:2, -2:2, 1:nw) = wadj(-2:2, -2:2, -1, 1:nw, sps2)
   wadj3d(-2:2, -2:2, 1:nw) = wadjd(-2:2, -2:2, 0, 1:nw, sps2)
   wadj3(-2:2, -2:2, 1:nw) = wadj(-2:2, -2:2, 0, 1:nw, sps2)
   padj1d(-2:2, -2:2) = padjd(-2:2, -2:2, -2, sps2)
   padj1(-2:2, -2:2) = padj(-2:2, -2:2, -2, sps2)
   padj2d(-2:2, -2:2) = padjd(-2:2, -2:2, -1, sps2)
   padj2(-2:2, -2:2) = padj(-2:2, -2:2, -1, sps2)
   padj3d(-2:2, -2:2) = padjd(-2:2, -2:2, 0, sps2)
   padj3(-2:2, -2:2) = padj(-2:2, -2:2, 0, sps2)
   IF (viscous) THEN
   rlvadj1(-2:2, -2:2) = rlvadj(-2:2, -2:2, -2)
   rlvadj2(-2:2, -2:2) = rlvadj(-2:2, -2:2, -1)
   END IF
   IF (eddymodel) THEN
   revadj1(-2:2, -2:2) = revadj(-2:2, -2:2, -2)
   revadj2(-2:2, -2:2) = revadj(-2:2, -2:2, -1)
   END IF
   END IF
   CASE (kmax) 
   IF (irbeg .LT. icell - 2) THEN
   icbeg = icell - 2
   ELSE
   icbeg = irbeg
   END IF
   IF (irend .GT. icell + 2) THEN
   icend = icell + 2
   ELSE
   icend = irend
   END IF
   IF (jrbeg .LT. jcell - 2) THEN
   jcbeg = jcell - 2
   ELSE
   jcbeg = jrbeg
   END IF
   IF (jrend .GT. jcell + 2) THEN
   jcend = jcell + 2
   ELSE
   jcend = jrend
   END IF
   ! Other straightforward stuff.
   secondhalo = .true.
   IF (krbeg .EQ. krend) secondhalo = .false.
   IF (secondhalo) THEN
   wadj0d(-2:2, -2:2, 1:nw) = wadjd(-2:2, -2:2, 2, 1:nw, sps2)
   wadj0(-2:2, -2:2, 1:nw) = wadj(-2:2, -2:2, 2, 1:nw, sps2)
   wadj1d(-2:2, -2:2, 1:nw) = wadjd(-2:2, -2:2, 1, 1:nw, sps2)
   wadj1(-2:2, -2:2, 1:nw) = wadj(-2:2, -2:2, 1, 1:nw, sps2)
   wadj2d(-2:2, -2:2, 1:nw) = wadjd(-2:2, -2:2, 0, 1:nw, sps2)
   wadj2(-2:2, -2:2, 1:nw) = wadj(-2:2, -2:2, 0, 1:nw, sps2)
   wadj3d(-2:2, -2:2, 1:nw) = wadjd(-2:2, -2:2, -1, 1:nw, sps2)
   wadj3(-2:2, -2:2, 1:nw) = wadj(-2:2, -2:2, -1, 1:nw, sps2)
   padj0d(-2:2, -2:2) = padjd(-2:2, -2:2, 2, sps2)
   padj0(-2:2, -2:2) = padj(-2:2, -2:2, 2, sps2)
   padj1d(-2:2, -2:2) = padjd(-2:2, -2:2, 1, sps2)
   padj1(-2:2, -2:2) = padj(-2:2, -2:2, 1, sps2)
   padj2d(-2:2, -2:2) = padjd(-2:2, -2:2, 0, sps2)
   padj2(-2:2, -2:2) = padj(-2:2, -2:2, 0, sps2)
   padj3d(-2:2, -2:2) = padjd(-2:2, -2:2, -1, sps2)
   padj3(-2:2, -2:2) = padj(-2:2, -2:2, -1, sps2)
   IF (viscous) THEN
   rlvadj1(-2:2, -2:2) = rlvadj(-2:2, -2:2, 1)
   rlvadj2(-2:2, -2:2) = rlvadj(-2:2, -2:2, 0)
   END IF
   IF (eddymodel) THEN
   revadj1(-2:2, -2:2) = revadj(-2:2, -2:2, 1)
   revadj2(-2:2, -2:2) = revadj(-2:2, -2:2, 0)
   END IF
   ELSE
   wadj1d(-2:2, -2:2, 1:nw) = wadjd(-2:2, -2:2, 2, 1:nw, sps2)
   wadj1(-2:2, -2:2, 1:nw) = wadj(-2:2, -2:2, 2, 1:nw, sps2)
   wadj2d(-2:2, -2:2, 1:nw) = wadjd(-2:2, -2:2, 1, 1:nw, sps2)
   wadj2(-2:2, -2:2, 1:nw) = wadj(-2:2, -2:2, 1, 1:nw, sps2)
   wadj3d(-2:2, -2:2, 1:nw) = wadjd(-2:2, -2:2, 0, 1:nw, sps2)
   wadj3(-2:2, -2:2, 1:nw) = wadj(-2:2, -2:2, 0, 1:nw, sps2)
   padj1d(-2:2, -2:2) = padjd(-2:2, -2:2, 2, sps2)
   padj1(-2:2, -2:2) = padj(-2:2, -2:2, 2, sps2)
   padj2d(-2:2, -2:2) = padjd(-2:2, -2:2, 1, sps2)
   padj2(-2:2, -2:2) = padj(-2:2, -2:2, 1, sps2)
   padj3d(-2:2, -2:2) = padjd(-2:2, -2:2, 0, sps2)
   padj3(-2:2, -2:2) = padj(-2:2, -2:2, 0, sps2)
   IF (viscous) THEN
   rlvadj1(-2:2, -2:2) = rlvadj(-2:2, -2:2, 2)
   rlvadj2(-2:2, -2:2) = rlvadj(-2:2, -2:2, 1)
   END IF
   IF (eddymodel) THEN
   revadj1(-2:2, -2:2) = revadj(-2:2, -2:2, 2)
   revadj2(-2:2, -2:2) = revadj(-2:2, -2:2, 1)
   END IF
   END IF
   END SELECT
   END SUBROUTINE EXTRACTBCSTATESNKPC_D
