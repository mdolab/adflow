   !        Generated by TAPENADE     (INRIA, Tropics team)
   !  Tapenade - Version 2.2 (r1239) - Wed 28 Jun 2006 04:59:55 PM CEST
   !  
   !  Differentiation of computernkpc in reverse (adjoint) mode:
   !   gradient, with respect to input variables: dwadj wadj
   !   of linear combination of output variables: dwadj
   !
   !      ******************************************************************
   !      *                                                                *
   !      * File:          computeRAdj.f90                                 *
   !      * Author:        C.A.(Sandy) Mader                               *
   !      * Starting date: 02-01-2008                                      *
   !      * Last modified: 04-23-2008                                      *
   !      *                                                                *
   !      ******************************************************************
   SUBROUTINE COMPUTERNKPC_B(wadj, wadjb, dwadj, dwadjb, siadj, sjadj, &
   &  skadj, sadj, voladj, sfaceiadj, sfacejadj, sfacekadj, rotrateadj, &
   &  icell, jcell, kcell, nn, level, sps)
   USE blockpointers
   USE flowvarrefstate
   USE inputphysics
   USE inputtimespectral
   USE section
   IMPLICIT NONE
   REAL(KIND=REALTYPE) :: dwadj(nw, ntimeintervalsspectral), dwadjb(nw, &
   &  ntimeintervalsspectral)
   INTEGER(KIND=INTTYPE), INTENT(IN) :: icell
   INTEGER(KIND=INTTYPE), INTENT(IN) :: jcell
   INTEGER(KIND=INTTYPE), INTENT(IN) :: kcell
   INTEGER(KIND=INTTYPE), INTENT(IN) :: level
   INTEGER(KIND=INTTYPE), INTENT(IN) :: nn
   REAL(KIND=REALTYPE) :: rotrateadj(3)
   REAL(KIND=REALTYPE) :: sadj(-2:2, -2:2, -2:2, 3, &
   &  ntimeintervalsspectral)
   REAL(KIND=REALTYPE) :: sfaceiadj(-2:2, -2:2, -2:2, &
   &  ntimeintervalsspectral), sfacejadj(-2:2, -2:2, -2:2, &
   &  ntimeintervalsspectral), sfacekadj(-2:2, -2:2, -2:2, &
   &  ntimeintervalsspectral)
   REAL(KIND=REALTYPE) :: siadj(-3:2, -3:2, -3:2, 3, &
   &  ntimeintervalsspectral), sjadj(-3:2, -3:2, -3:2, 3, &
   &  ntimeintervalsspectral), skadj(-3:2, -3:2, -3:2, 3, &
   &  ntimeintervalsspectral)
   INTEGER(KIND=INTTYPE), INTENT(IN) :: sps
   REAL(KIND=REALTYPE) :: voladj(ntimeintervalsspectral)
   REAL(KIND=REALTYPE) :: wadj(-2:2, -2:2, -2:2, nw, &
   &  ntimeintervalsspectral), wadjb(-2:2, -2:2, -2:2, nw, &
   &  ntimeintervalsspectral)
   LOGICAL :: correctfork, secondhalo
   REAL(KIND=REALTYPE) :: normadj(nbocos, -2:2, -2:2, 3, &
   &  ntimeintervalsspectral)
   REAL(KIND=REALTYPE) :: padj(-2:2, -2:2, -2:2, ntimeintervalsspectral)&
   &  , padjb(-2:2, -2:2, -2:2, ntimeintervalsspectral)
   REAL(KIND=REALTYPE) :: radiadj(-1:1, -1:1, -1:1, &
   &  ntimeintervalsspectral), radiadjb(-1:1, -1:1, -1:1, &
   &  ntimeintervalsspectral), radjadj(-1:1, -1:1, -1:1, &
   &  ntimeintervalsspectral), radjadjb(-1:1, -1:1, -1:1, &
   &  ntimeintervalsspectral), radkadj(-1:1, -1:1, -1:1, &
   &  ntimeintervalsspectral), radkadjb(-1:1, -1:1, -1:1, &
   &  ntimeintervalsspectral)
   REAL(KIND=REALTYPE) :: rfaceadj(nbocos, -2:2, -2:2, &
   &  ntimeintervalsspectral)
   INTEGER(KIND=INTTYPE) :: sps2
   REAL(KIND=REALTYPE) :: t(nsections)
   ! Passed in Variables
   ! Input Variables --- Note no intent(in) --- this can cause problems
   ! with reverse mode AD
   ! Ouptut Variables
   !      Set Local Variables
   ! Integer variables
   ! Logical 
   secondhalo = .true.
   DO sps2=1,ntimeintervalsspectral
   CALL PUSHREAL8ARRAY(normadj, nbocos*5**2*3*ntimeintervalsspectral)
   CALL COMPUTENORMNKPC(siadj, sjadj, skadj, normadj, icell, jcell, &
   &                   kcell, nn, level, sps, sps2)
   CALL PUSHREAL8ARRAY(rfaceadj, nbocos*5**2*ntimeintervalsspectral)
   !Compute the Pressure in the stencil based on the current 
   !States
   CALL NORMALVELOCITIESALLLEVELSNKPC(sps, icell, jcell, kcell, &
   &                                 sfaceiadj, sfacejadj, sfacekadj, siadj&
   &                                 , sjadj, skadj, rfaceadj, nn, level, &
   &                                 sps2)
   CALL PUSHREAL8ARRAY(padj, 5**3*ntimeintervalsspectral)
   CALL COMPUTEPRESSURENKPC(wadj, padj, nn, level, sps, sps2)
   CALL PUSHBOOLEAN(secondhalo)
   CALL PUSHREAL8ARRAY(padj, 5**3*ntimeintervalsspectral)
   CALL PUSHREAL8ARRAY(wadj, 5**3*nw*ntimeintervalsspectral)
   ! Apply all boundary conditions to stencil.
   ! In case of a full mg mode, and a segegated turbulent solver,
   ! first call the turbulent boundary conditions, such that the
   ! turbulent kinetic energy is properly initialized in the halo's.
   CALL APPLYALLBCNKPC(winf, pinfcorr, wadj, padj, sadj, siadj, sjadj, &
   &                  skadj, voladj, normadj, rfaceadj, icell, jcell, kcell&
   &                  , secondhalo, nn, level, sps, sps2)
   CALL PUSHREAL8ARRAY(radkadj, 3**3*ntimeintervalsspectral)
   CALL PUSHREAL8ARRAY(radjadj, 3**3*ntimeintervalsspectral)
   CALL PUSHREAL8ARRAY(radiadj, 3**3*ntimeintervalsspectral)
   CALL TIMESTEPNKPC(.true., wadj, padj, siadj, sjadj, skadj, sfaceiadj&
   &                , sfacejadj, sfacekadj, voladj, radiadj, radjadj, &
   &                radkadj, icell, jcell, kcell, pinfcorr, rhoinf, nn, &
   &                level, sps, sps2)
   END DO
   CALL INITRESNKPC(1, nwf, wadj, voladj, dwadj, nn, level, sps)
   CALL PUSHREAL8ARRAY(wadj, 5**3*nw*ntimeintervalsspectral)
   CALL RESIDUALNKPC(wadj, padj, siadj, sjadj, skadj, voladj, normadj, &
   &              sfaceiadj, sfacejadj, sfacekadj, radiadj, radjadj, &
   &              radkadj, dwadj, icell, jcell, kcell, rotrateadj, &
   &              correctfork, nn, level, sps)
   DO sps2=ntimeintervalsspectral,1,-1
   dwadjb(:, sps2) = dwadjb(:, sps2)/voladj(sps2)
   END DO
   CALL POPREAL8ARRAY(wadj, 5**3*nw*ntimeintervalsspectral)
   CALL RESIDUALNKPC_B(wadj, wadjb, padj, padjb, siadj, sjadj, skadj, &
   &                voladj, normadj, sfaceiadj, sfacejadj, sfacekadj, &
   &                radiadj, radiadjb, radjadj, radjadjb, radkadj, radkadjb&
   &                , dwadj, dwadjb, icell, jcell, kcell, rotrateadj, &
   &                correctfork, nn, level, sps)
   CALL INITRESNKPC_B(1, nwf, wadj, wadjb, voladj, dwadj, dwadjb, nn, &
   &               level, sps)
   DO sps2=ntimeintervalsspectral,1,-1
   CALL POPREAL8ARRAY(radiadj, 3**3*ntimeintervalsspectral)
   CALL POPREAL8ARRAY(radjadj, 3**3*ntimeintervalsspectral)
   CALL POPREAL8ARRAY(radkadj, 3**3*ntimeintervalsspectral)
   CALL TIMESTEPNKPC_B(.true., wadj, wadjb, padj, padjb, siadj, sjadj, &
   &                  skadj, sfaceiadj, sfacejadj, sfacekadj, voladj, &
   &                  radiadj, radiadjb, radjadj, radjadjb, radkadj, &
   &                  radkadjb, icell, jcell, kcell, pinfcorr, rhoinf, nn, &
   &                  level, sps, sps2)
   CALL POPREAL8ARRAY(wadj, 5**3*nw*ntimeintervalsspectral)
   CALL POPREAL8ARRAY(padj, 5**3*ntimeintervalsspectral)
   CALL POPBOOLEAN(secondhalo)
   CALL APPLYALLBCNKPC_B(winf, pinfcorr, wadj, wadjb, padj, padjb, sadj&
   &                    , siadj, sjadj, skadj, voladj, normadj, rfaceadj, &
   &                    icell, jcell, kcell, secondhalo, nn, level, sps, &
   &                    sps2)
   CALL POPREAL8ARRAY(padj, 5**3*ntimeintervalsspectral)
   CALL COMPUTEPRESSURENKPC_B(wadj, wadjb, padj, padjb, nn, level, sps&
   &                         , sps2)
   CALL POPREAL8ARRAY(rfaceadj, nbocos*5**2*ntimeintervalsspectral)
   CALL POPREAL8ARRAY(normadj, nbocos*5**2*3*ntimeintervalsspectral)
   END DO
   dwadjb(1:nw, 1:ntimeintervalsspectral) = 0.0
   END SUBROUTINE COMPUTERNKPC_B
