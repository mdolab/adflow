   !        Generated by TAPENADE     (INRIA, Tropics team)
   !  Tapenade - Version 2.2 (r1239) - Wed 28 Jun 2006 04:59:55 PM CEST
   !  
   !  Differentiation of getdirvectorforces in reverse (adjoint) mode:
   !   gradient, with respect to input variables: alpha beta winddirection
   !   of linear combination of output variables: alpha beta winddirection
   !
   !     ******************************************************************
   !     *                                                                *
   !     * File:          getDirVector.f90                                *
   !     * Author:        Andre C. Marta,C.A.(Sandy) Mader                *
   !     * Starting date: 10-25-2005                                      *
   !     * Last modified: 06-14-2008                                      *
   !     *                                                                *
   !     ******************************************************************
   !
   SUBROUTINE GETDIRVECTORFORCES_B(refdirection, alpha, alphab, beta, betab&
   &  , winddirection, winddirectionb, liftindex)
   USE constants
   IMPLICIT NONE
   REAL(KIND=REALTYPE), INTENT(IN) :: alpha
   REAL(KIND=REALTYPE) :: alphab, betab
   REAL(KIND=REALTYPE), INTENT(IN) :: beta
   INTEGER(KIND=INTTYPE), INTENT(IN) :: liftindex
   REAL(KIND=REALTYPE), DIMENSION(3), INTENT(IN) :: refdirection
   REAL(KIND=REALTYPE) :: winddirection(3), winddirectionb(3)
   REAL(KIND=REALTYPE) :: arg1, arg1b
   INTEGER :: branch
   REAL(KIND=REALTYPE) :: refdirectionnorm(3)
   REAL(KIND=REALTYPE) :: rnorm, x1, x1b, xbn, xbnb, xw, xwb, y1, y1b, &
   &  ybn, ybnb, yw, ywb, z1, z1b, zbn, zbnb, zw, zwb
   INTRINSIC SQRT
   EXTERNAL TERMINATE
   !(xb,yb,zb,alpha,beta,xw,yw,zw)
   !
   !     ******************************************************************
   !     *                                                                *
   !     * Convert the angle of attack and side slip angle to wind axes.  *
   !     * The components of the wind direction vector (xw,yw,zw) are     *
   !     * computed given the direction angles in radians and the body    *
   !     * direction by performing two rotations on the original          *
   !     * direction vector:                                              *
   !     *   1) Rotation about the zb or yb-axis: alpha clockwise (CW)    *
   !     *      (xb,yb,zb) -> (x1,y1,z1)                                  *
   !     *                                                                *
   !     *   2) Rotation about the yl or z1-axis: beta counter-clockwise  *
   !     *      (CCW)  (x1,y1,z1) -> (xw,yw,zw)                           *
   !     *                                                                *
   !     *    input arguments:                                            *
   !     *       alpha    = angle of attack in radians                    *
   !     *       beta     = side slip angle in radians                    *
   !     *       refDirection = reference direction vector                *
   !     *    output arguments:                                           *
   !     *       windDirection = unit wind vector in body axes            *
   !     *                                                                *
   !     ******************************************************************
   !
   !
   !     Subroutine arguments.
   !
   !
   !     Local variables.
   !
   !
   !     ******************************************************************
   !     *                                                                *
   !     * Begin execution.                                               *
   !     *                                                                *
   !     ******************************************************************
   !
   ! Normalize the input vector.
   rnorm = SQRT(refdirection(1)**2 + refdirection(2)**2 + refdirection(3)&
   &    **2)
   xbn = refdirection(1)/rnorm
   ybn = refdirection(2)/rnorm
   zbn = refdirection(3)/rnorm
   !!$      ! Compute the wind direction vector.
   !!$
   !!$      ! 1) rotate alpha radians cw about y-axis
   !!$      !    ( <=> rotate y-axis alpha radians ccw)
   !!$
   !!$      call vectorRotation(x1, y1, z1, 2, alpha, xbn, ybn, zbn)
   !!$
   !!$      ! 2) rotate beta radians ccw about z-axis
   !!$      !    ( <=> rotate z-axis -beta radians ccw)
   !!$
   !!$      call vectorRotation(xw, yw, zw, 3, -beta, x1, y1, z1)
   IF (liftindex .EQ. 2) THEN
   ! Compute the wind direction vector.Aerosurf axes different!!
   ! 1) rotate alpha radians cw about z-axis
   !    ( <=> rotate z-axis alpha radians cw)
   arg1 = -alpha
   CALL VECTORROTATIONFORCES(x1, y1, z1, 3, arg1, xbn, ybn, zbn)
   CALL PUSHREAL8(arg1)
   ! 2) rotate beta radians ccw about y-axis
   !    ( <=> rotate z-axis -beta radians ccw)
   arg1 = -beta
   CALL PUSHINTEGER4(0)
   ELSE IF (liftindex .EQ. 3) THEN
   ! Compute the wind direction vector.Aerosurf axes different!!
   ! 1) rotate alpha radians ccw about z-axis
   !    ( <=> rotate z-axis alpha radians ccw)
   CALL VECTORROTATIONFORCES(x1, y1, z1, 2, alpha, xbn, ybn, zbn)
   ! 2) rotate beta radians ccw about z-axis
   !    ( <=> rotate z-axis beta radians ccw)
   CALL PUSHINTEGER4(2)
   ELSE
   CALL PUSHINTEGER4(1)
   END IF
   zwb = winddirectionb(3)
   winddirectionb(3) = 0.0
   ywb = winddirectionb(2)
   winddirectionb(2) = 0.0
   xwb = winddirectionb(1)
   winddirectionb(1) = 0.0
   CALL POPINTEGER4(branch)
   IF (branch .LT. 2) THEN
   IF (branch .LT. 1) THEN
   arg1b = 0.0
   CALL VECTORROTATIONFORCES_B(xw, xwb, yw, ywb, zw, zwb, 2, arg1, &
   &                            arg1b, x1, x1b, y1, y1b, z1, z1b)
   CALL POPREAL8(arg1)
   betab = betab - arg1b
   arg1b = 0.0
   CALL VECTORROTATIONFORCES_B(x1, x1b, y1, y1b, z1, z1b, 3, arg1, &
   &                            arg1b, xbn, xbnb, ybn, ybnb, zbn, zbnb)
   alphab = alphab - arg1b
   END IF
   ELSE
   CALL VECTORROTATIONFORCES_B(xw, xwb, yw, ywb, zw, zwb, 3, beta, &
   &                          betab, x1, x1b, y1, y1b, z1, z1b)
   CALL VECTORROTATIONFORCES_B(x1, x1b, y1, y1b, z1, z1b, 2, alpha, &
   &                          alphab, xbn, xbnb, ybn, ybnb, zbn, zbnb)
   END IF
   END SUBROUTINE GETDIRVECTORFORCES_B
