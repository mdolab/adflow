!        generated by tapenade     (inria, tropics team)
!  tapenade 3.10 (r5363) -  9 sep 2014 09:53
!
!  differentiation of residual_block in reverse (adjoint) mode (with options i4 dr8 r8 noisize):
!   gradient     of useful results: gammainf *rev *p *dw *w *rlv
!                *x *vol *si *sj *sk *(*viscsubface.tau)
!   with respect to varying inputs: gammainf timeref rhoinf tref
!                winf pinfcorr rgas *rev *p *dw *w *rlv *x *vol
!                *si *sj *sk *radi *radj *radk
!   plus diff mem management of: rev:in aa:in wx:in wy:in wz:in
!                p:in dw:in w:in rlv:in x:in qx:in qy:in qz:in
!                ux:in vol:in uy:in uz:in si:in sj:in sk:in vx:in
!                vy:in vz:in fw:in viscsubface:in *viscsubface.tau:in
!                radi:in radj:in radk:in
!
!      ******************************************************************
!      *                                                                *
!      * file:          residual.f90                                    *
!      * author:        edwin van der weide, steve repsher (blanking)   *
!      * starting date: 03-15-2003                                      *
!      * last modified: 10-29-2007                                      *
!      *                                                                *
!      ******************************************************************
!
subroutine residual_block_b()
!
!      ******************************************************************
!      *                                                                *
!      * residual computes the residual of the mean flow equations on   *
!      * the current mg level.                                          *
!      *                                                                *
!      ******************************************************************
!
  use blockpointers
  use cgnsgrid
  use flowvarrefstate
  use inputiteration
  use inputdiscretization
  use inputtimespectral
! added by hdn
  use inputunsteady
  use iteration
  use inputadjoint
  implicit none
!
!      local variables.
!
  integer(kind=inttype) :: discr
  integer(kind=inttype) :: i, j, k, l
! for loops of ale
  integer(kind=inttype) :: iale, jale, kale, lale, male
  real(kind=realtype), parameter :: k1=1.05_realtype
! random given number
  real(kind=realtype), parameter :: k2=0.6_realtype
! mach number preconditioner activation
  real(kind=realtype), parameter :: m0=0.2_realtype
  real(kind=realtype), parameter :: alpha=0_realtype
  real(kind=realtype), parameter :: delta=0_realtype
!real(kind=realtype), parameter :: hinf = 2_realtype ! test phase 
! test phase
  real(kind=realtype), parameter :: cpres=4.18_realtype
  real(kind=realtype), parameter :: temp=297.15_realtype
!
!     local variables
!
  real(kind=realtype) :: k3, h, velxrho, velyrho, velzrho, sos, hinf
  real(kind=realtype) :: k3d, velxrhod, velyrhod, velzrhod, sosd
  real(kind=realtype) :: resm, a11, a12, a13, a14, a15, a21, a22, a23, &
& a24, a25, a31, a32, a33, a34, a35
  real(kind=realtype) :: resmd, a11d, a15d, a21d, a22d, a25d, a31d, a33d&
& , a35d
  real(kind=realtype) :: a41, a42, a43, a44, a45, a51, a52, a53, a54, &
& a55, b11, b12, b13, b14, b15
  real(kind=realtype) :: a41d, a44d, a45d, a51d, a52d, a53d, a54d, a55d&
& , b11d, b12d, b13d, b14d, b15d
  real(kind=realtype) :: b21, b22, b23, b24, b25, b31, b32, b33, b34, &
& b35
  real(kind=realtype) :: b21d, b22d, b23d, b24d, b25d, b31d, b32d, b33d&
& , b34d, b35d
  real(kind=realtype) :: b41, b42, b43, b44, b45, b51, b52, b53, b54, &
& b55
  real(kind=realtype) :: b41d, b42d, b43d, b44d, b45d, b51d, b52d, b53d&
& , b54d, b55d
  real(kind=realtype) :: rhohdash, betamr2
  real(kind=realtype) :: betamr2d
  real(kind=realtype) :: g, q
  real(kind=realtype) :: qd
  real(kind=realtype) :: b1, b2, b3, b4, b5
  real(kind=realtype) :: dwo(nwf)
  real(kind=realtype) :: dwod(nwf)
  logical :: finegrid
  intrinsic abs
  intrinsic sqrt
  intrinsic max
  intrinsic min
  intrinsic real
  integer :: branch
  real(kind=realtype) :: temp3
  real(kind=realtype) :: temp29
  real(kind=realtype) :: tempd14
  real(kind=realtype) :: temp2
  real(kind=realtype) :: temp28
  real(kind=realtype) :: tempd13
  real(kind=realtype) :: temp1
  real(kind=realtype) :: temp27
  real(kind=realtype) :: tempd12
  real(kind=realtype) :: tempd49
  real(kind=realtype) :: temp0
  real(kind=realtype) :: temp26
  real(kind=realtype) :: tempd11
  real(kind=realtype) :: tempd48
  real(kind=realtype) :: temp25
  real(kind=realtype) :: tempd10
  real(kind=realtype) :: tempd47
  real(kind=realtype) :: temp24
  real(kind=realtype) :: tempd46
  real(kind=realtype) :: temp23
  real(kind=realtype) :: tempd45
  real(kind=realtype) :: temp22
  real(kind=realtype) :: tempd44
  real(kind=realtype) :: temp21
  real(kind=realtype) :: tempd43
  real(kind=realtype) :: temp20
  real(kind=realtype) :: tempd42
  real(kind=realtype) :: tempd41
  real(kind=realtype) :: tempd40
  real(kind=realtype) :: x3
  real(kind=realtype) :: x2
  real(kind=realtype) :: x1
  real(kind=realtype) :: temp19
  real(kind=realtype) :: temp18
  real(kind=realtype) :: temp17
  real(kind=realtype) :: tempd39
  real(kind=realtype) :: temp16
  real(kind=realtype) :: tempd38
  real(kind=realtype) :: temp15
  real(kind=realtype) :: tempd37
  real(kind=realtype) :: temp14
  real(kind=realtype) :: tempd36
  real(kind=realtype) :: temp13
  real(kind=realtype) :: tempd35
  real(kind=realtype) :: temp12
  real(kind=realtype) :: tempd34
  real(kind=realtype) :: temp11
  real(kind=realtype) :: tempd33
  real(kind=realtype) :: temp10
  real(kind=realtype) :: tempd32
  real(kind=realtype) :: tempd31
  real(kind=realtype) :: tempd30
  real(kind=realtype) :: tempd9
  real(kind=realtype) :: tempd
  real(kind=realtype) :: tempd8
  real(kind=realtype) :: tempd7
  real(kind=realtype) :: tempd6
  real(kind=realtype) :: tempd5
  real(kind=realtype) :: tempd4
  real(kind=realtype) :: tempd3
  real(kind=realtype) :: tempd2
  real(kind=realtype) :: tempd1
  real(kind=realtype) :: tempd0
  real(kind=realtype) :: x1d
  real(kind=realtype) :: tempd29
  real(kind=realtype) :: tempd28
  real(kind=realtype) :: tempd27
  real(kind=realtype) :: tempd26
  real(kind=realtype) :: tempd25
  real(kind=realtype) :: temp39
  real(kind=realtype) :: tempd24
  real(kind=realtype) :: temp38
  real(kind=realtype) :: tempd23
  real(kind=realtype) :: temp37
  real(kind=realtype) :: tempd22
  real(kind=realtype) :: temp36
  real(kind=realtype) :: tempd21
  real(kind=realtype) :: temp35
  real(kind=realtype) :: tempd20
  real(kind=realtype) :: tempd57
  real(kind=realtype) :: temp34
  real(kind=realtype) :: tempd56
  real(kind=realtype) :: temp33
  real(kind=realtype) :: tempd55
  real(kind=realtype) :: temp32
  real(kind=realtype) :: tempd54
  real(kind=realtype) :: temp31
  real(kind=realtype) :: tempd53
  real(kind=realtype) :: temp30
  real(kind=realtype) :: tempd52
  real(kind=realtype) :: tempd51
  real(kind=realtype) :: tempd50
  real(kind=realtype) :: abs0
  real(kind=realtype) :: max2
  real(kind=realtype) :: max1
  real(kind=realtype) :: temp9
  real(kind=realtype) :: temp8
  real(kind=realtype) :: tempd19
  real(kind=realtype) :: temp7
  real(kind=realtype) :: tempd18
  real(kind=realtype) :: temp6
  real(kind=realtype) :: tempd17
  real(kind=realtype) :: temp5
  real(kind=realtype) :: tempd16
  real(kind=realtype) :: temp4
  real(kind=realtype) :: tempd15
!
!      ******************************************************************
!      *                                                                *
!      * begin execution                                                *
!      *                                                                *
!      ******************************************************************
!
! add the source terms from the level 0 cooling model.
! set the value of rfil, which controls the fraction of the old
! dissipation residual to be used. this is only for the runge-kutta
! schemes; for other smoothers rfil is simply set to 1.0.
! note the index rkstage+1 for cdisrk. the reason is that the
! residual computation is performed before rkstage is incremented.
  if (smoother .eq. rungekutta) then
    rfil = cdisrk(rkstage+1)
  else
    rfil = one
  end if
! initialize the local arrays to monitor the massflows to zero.
! set the value of the discretization, depending on the grid level,
! and the logical finegrid, which indicates whether or not this
! is the finest grid level of the current mg cycle.
  discr = spacediscrcoarse
  if (currentlevel .eq. 1) discr = spacediscr
  finegrid = .false.
  if (currentlevel .eq. groundlevel) finegrid = .true.
! ===========================================================
!
! assuming ale has nothing to do with mg
! the geometric data will be interpolated if in md mode
!
! ===========================================================
! ===========================================================
!
! the fluxes are calculated as usual
!
! ===========================================================
  call pushreal8array(dw, size(dw, 1)*size(dw, 2)*size(dw, 3)*size(dw, 4&
&               ))
  call inviscidcentralflux()
  select case  (discr) 
  case (dissscalar) 
! standard scalar dissipation scheme.
    if (finegrid) then
      if (.not.lumpeddiss) then
        call invisciddissfluxscalar()
        call pushcontrol3b(0)
      else
        call pushreal8array(w, size(w, 1)*size(w, 2)*size(w, 3)*size(w, &
&                     4))
        call invisciddissfluxscalarapprox()
        call pushcontrol3b(1)
      end if
    else
      call pushcontrol3b(2)
    end if
  case (dissmatrix) 
!===========================================================
! matrix dissipation scheme.
    if (finegrid) then
      if (.not.lumpeddiss) then
        call invisciddissfluxmatrix()
        call pushcontrol3b(3)
      else
        call invisciddissfluxmatrixapprox()
        call pushcontrol3b(4)
      end if
    else
      call pushcontrol3b(5)
    end if
  case (disscusp) 
    call pushcontrol3b(6)
  case (upwind) 
!===========================================================
! cusp dissipation scheme.
!===========================================================
! dissipation via an upwind scheme.
    call inviscidupwindflux(finegrid)
    call pushcontrol3b(7)
  case default
    call pushcontrol3b(6)
  end select
!-------------------------------------------------------
! lastly, recover the old s[i,j,k], sface[i,j,k]
! this shall be done before difussive and source terms
! are computed.
!-------------------------------------------------------
  if (viscous) then
    if (rfil .ge. 0.) then
      abs0 = rfil
    else
      abs0 = -rfil
    end if
! only compute viscous fluxes if rfil > 0
    if (abs0 .gt. thresholdreal) then
! not lumpeddiss means it isn't the pc...call the vicousflux
      if (.not.lumpeddiss) then
        call computespeedofsoundsquared()
        call allnodalgradients()
        call viscousflux()
        call pushcontrol3b(0)
      else
! this is a pc calc...only include viscous fluxes if viscpc
! is used
        call computespeedofsoundsquared()
        if (viscpc) then
          call allnodalgradients()
          call viscousflux()
          call pushcontrol3b(1)
        else
          call viscousfluxapprox()
          call pushcontrol3b(2)
        end if
      end if
    else
      call pushcontrol3b(3)
    end if
  else
    call pushcontrol3b(4)
  end if
!===========================================================
! add the dissipative and possibly viscous fluxes to the
! euler fluxes. loop over the owned cells and add fw to dw.
! also multiply by iblank so that no updates occur in holes
  if (lowspeedpreconditioner) then
    do k=2,kl
      do j=2,jl
        do i=2,il
!    compute speed of sound
          call pushreal8(sos)
          sos = sqrt(gamma(i, j, k)*p(i, j, k)/w(i, j, k, irho))
! coompute velocities without rho from state vector
          velxrho = w(i, j, k, ivx)
          velyrho = w(i, j, k, ivy)
          velzrho = w(i, j, k, ivz)
          q = velxrho**2 + velyrho**2 + velzrho**2
          call pushreal8(resm)
          resm = sqrt(q)/sos
!
!    compute k3
          call pushreal8(k3)
          k3 = k1*(1+(1-k1*m0**2)*resm**2/(k1*m0**4))
          if (k3*(velxrho**2+velyrho**2+velzrho**2) .lt. k2*(winf(ivx)**&
&             2+winf(ivy)**2+winf(ivz)**2)) then
            x1 = k2*(winf(ivx)**2+winf(ivy)**2+winf(ivz)**2)
            call pushcontrol1b(0)
          else
            x1 = k3*(velxrho**2+velyrho**2+velzrho**2)
            call pushcontrol1b(1)
          end if
          if (x1 .gt. sos**2) then
            call pushreal8(betamr2)
            betamr2 = sos**2
            call pushcontrol1b(0)
          else
            call pushreal8(betamr2)
            betamr2 = x1
            call pushcontrol1b(1)
          end if
          a11 = betamr2*(1/sos**4)
          a12 = zero
          a13 = zero
          a14 = zero
          a15 = (-betamr2)/sos**4
          a21 = one*velxrho/sos**2
          a22 = one*w(i, j, k, irho)
          a23 = zero
          a24 = zero
          a25 = one*(-velxrho)/sos**2
          a31 = one*velyrho/sos**2
          a32 = zero
          a33 = one*w(i, j, k, irho)
          a34 = zero
          a35 = one*(-velyrho)/sos**2
          a41 = one*velzrho/sos**2
          a42 = zero
          a43 = zero
          a44 = one*w(i, j, k, irho)
          a45 = zero + one*(-velzrho)/sos**2
          a51 = one*(1/(gamma(i, j, k)-1)+resm**2/2)
          a52 = one*w(i, j, k, irho)*velxrho
          a53 = one*w(i, j, k, irho)*velyrho
          a54 = one*w(i, j, k, irho)*velzrho
          a55 = one*((-(resm**2))/2)
          call pushreal8(b11)
          b11 = a11*(gamma(i, j, k)-1)*q/2 + a12*(-velxrho)/w(i, j, k, &
&           irho) + a13*(-velyrho)/w(i, j, k, irho) + a14*(-velzrho)/w(i&
&           , j, k, irho) + a15*((gamma(i, j, k)-1)*q/2-sos**2)
          call pushreal8(b12)
          b12 = a11*(1-gamma(i, j, k))*velxrho + a12*1/w(i, j, k, irho) &
&           + a15*(1-gamma(i, j, k))*velxrho
          call pushreal8(b13)
          b13 = a11*(1-gamma(i, j, k))*velyrho + a13/w(i, j, k, irho) + &
&           a15*(1-gamma(i, j, k))*velyrho
          call pushreal8(b14)
          b14 = a11*(1-gamma(i, j, k))*velzrho + a14/w(i, j, k, irho) + &
&           a15*(1-gamma(i, j, k))*velzrho
          b15 = a11*(gamma(i, j, k)-1) + a15*(gamma(i, j, k)-1)
          call pushreal8(b21)
          b21 = a21*(gamma(i, j, k)-1)*q/2 + a22*(-velxrho)/w(i, j, k, &
&           irho) + a23*(-velyrho)/w(i, j, k, irho) + a24*(-velzrho)/w(i&
&           , j, k, irho) + a25*((gamma(i, j, k)-1)*q/2-sos**2)
          call pushreal8(b22)
          b22 = a21*(1-gamma(i, j, k))*velxrho + a22/w(i, j, k, irho) + &
&           a25*(1-gamma(i, j, k))*velxrho
          call pushreal8(b23)
          b23 = a21*(1-gamma(i, j, k))*velyrho + a23*1/w(i, j, k, irho) &
&           + a25*(1-gamma(i, j, k))*velyrho
          call pushreal8(b24)
          b24 = a21*(1-gamma(i, j, k))*velzrho + a24*1/w(i, j, k, irho) &
&           + a25*(1-gamma(i, j, k))*velzrho
          b25 = a21*(gamma(i, j, k)-1) + a25*(gamma(i, j, k)-1)
          call pushreal8(b31)
          b31 = a31*(gamma(i, j, k)-1)*q/2 + a32*(-velxrho)/w(i, j, k, &
&           irho) + a33*(-velyrho)/w(i, j, k, irho) + a34*(-velzrho)/w(i&
&           , j, k, irho) + a35*((gamma(i, j, k)-1)*q/2-sos**2)
          call pushreal8(b32)
          b32 = a31*(1-gamma(i, j, k))*velxrho + a32/w(i, j, k, irho) + &
&           a35*(1-gamma(i, j, k))*velxrho
          call pushreal8(b33)
          b33 = a31*(1-gamma(i, j, k))*velyrho + a33*1/w(i, j, k, irho) &
&           + a35*(1-gamma(i, j, k))*velyrho
          call pushreal8(b34)
          b34 = a31*(1-gamma(i, j, k))*velzrho + a34*1/w(i, j, k, irho) &
&           + a35*(1-gamma(i, j, k))*velzrho
          b35 = a31*(gamma(i, j, k)-1) + a35*(gamma(i, j, k)-1)
          call pushreal8(b41)
          b41 = a41*(gamma(i, j, k)-1)*q/2 + a42*(-velxrho)/w(i, j, k, &
&           irho) + a43*(-velyrho)/w(i, j, k, irho) + a44*(-velzrho)/w(i&
&           , j, k, irho) + a45*((gamma(i, j, k)-1)*q/2-sos**2)
          call pushreal8(b42)
          b42 = a41*(1-gamma(i, j, k))*velxrho + a42/w(i, j, k, irho) + &
&           a45*(1-gamma(i, j, k))*velxrho
          call pushreal8(b43)
          b43 = a41*(1-gamma(i, j, k))*velyrho + a43*1/w(i, j, k, irho) &
&           + a45*(1-gamma(i, j, k))*velyrho
          call pushreal8(b44)
          b44 = a41*(1-gamma(i, j, k))*velzrho + a44*1/w(i, j, k, irho) &
&           + a45*(1-gamma(i, j, k))*velzrho
          b45 = a41*(gamma(i, j, k)-1) + a45*(gamma(i, j, k)-1)
          call pushreal8(b51)
          b51 = a51*(gamma(i, j, k)-1)*q/2 + a52*(-velxrho)/w(i, j, k, &
&           irho) + a53*(-velyrho)/w(i, j, k, irho) + a54*(-velzrho)/w(i&
&           , j, k, irho) + a55*((gamma(i, j, k)-1)*q/2-sos**2)
          call pushreal8(b52)
          b52 = a51*(1-gamma(i, j, k))*velxrho + a52/w(i, j, k, irho) + &
&           a55*(1-gamma(i, j, k))*velxrho
          call pushreal8(b53)
          b53 = a51*(1-gamma(i, j, k))*velyrho + a53*1/w(i, j, k, irho) &
&           + a55*(1-gamma(i, j, k))*velyrho
          call pushreal8(b54)
          b54 = a51*(1-gamma(i, j, k))*velzrho + a54*1/w(i, j, k, irho) &
&           + a55*(1-gamma(i, j, k))*velzrho
          b55 = a51*(gamma(i, j, k)-1) + a55*(gamma(i, j, k)-1)
! dwo is the orginal redisual
          do l=1,nwf
            x2 = real(iblank(i, j, k), realtype)
            if (x2 .lt. zero) then
              call pushreal8(max1)
              max1 = zero
              call pushcontrol1b(0)
            else
              call pushreal8(max1)
              max1 = x2
              call pushcontrol1b(1)
            end if
            call pushreal8(dwo(l))
            dwo(l) = (dw(i, j, k, l)+fw(i, j, k, l))*max1
          end do
          dw(i, j, k, 1) = b11*dwo(1) + b12*dwo(2) + b13*dwo(3) + b14*&
&           dwo(4) + b15*dwo(5)
          dw(i, j, k, 2) = b21*dwo(1) + b22*dwo(2) + b23*dwo(3) + b24*&
&           dwo(4) + b25*dwo(5)
          dw(i, j, k, 3) = b31*dwo(1) + b32*dwo(2) + b33*dwo(3) + b34*&
&           dwo(4) + b35*dwo(5)
          dw(i, j, k, 4) = b41*dwo(1) + b42*dwo(2) + b43*dwo(3) + b44*&
&           dwo(4) + b45*dwo(5)
          dw(i, j, k, 5) = b51*dwo(1) + b52*dwo(2) + b53*dwo(3) + b54*&
&           dwo(4) + b55*dwo(5)
        end do
      end do
    end do
    winfd = 0.0_8
    fwd = 0.0_8
    dwod = 0.0_8
    do k=kl,2,-1
      do j=jl,2,-1
        do i=il,2,-1
          a51 = one*(1/(gamma(i, j, k)-1)+resm**2/2)
          a55 = one*((-(resm**2))/2)
          b55 = a51*(gamma(i, j, k)-1) + a55*(gamma(i, j, k)-1)
          b51d = dwo(1)*dwd(i, j, k, 5)
          dwod(1) = dwod(1) + b51*dwd(i, j, k, 5)
          b52d = dwo(2)*dwd(i, j, k, 5)
          dwod(2) = dwod(2) + b52*dwd(i, j, k, 5)
          b53d = dwo(3)*dwd(i, j, k, 5)
          dwod(3) = dwod(3) + b53*dwd(i, j, k, 5)
          b54d = dwo(4)*dwd(i, j, k, 5)
          dwod(4) = dwod(4) + b54*dwd(i, j, k, 5)
          b55d = dwo(5)*dwd(i, j, k, 5)
          dwod(5) = dwod(5) + b55*dwd(i, j, k, 5)
          dwd(i, j, k, 5) = 0.0_8
          velzrho = w(i, j, k, ivz)
          a41 = one*velzrho/sos**2
          a45 = zero + one*(-velzrho)/sos**2
          b45 = a41*(gamma(i, j, k)-1) + a45*(gamma(i, j, k)-1)
          b41d = dwo(1)*dwd(i, j, k, 4)
          dwod(1) = dwod(1) + b41*dwd(i, j, k, 4)
          b42d = dwo(2)*dwd(i, j, k, 4)
          dwod(2) = dwod(2) + b42*dwd(i, j, k, 4)
          b43d = dwo(3)*dwd(i, j, k, 4)
          dwod(3) = dwod(3) + b43*dwd(i, j, k, 4)
          b44d = dwo(4)*dwd(i, j, k, 4)
          dwod(4) = dwod(4) + b44*dwd(i, j, k, 4)
          b45d = dwo(5)*dwd(i, j, k, 4)
          dwod(5) = dwod(5) + b45*dwd(i, j, k, 4)
          dwd(i, j, k, 4) = 0.0_8
          velyrho = w(i, j, k, ivy)
          a31 = one*velyrho/sos**2
          a35 = one*(-velyrho)/sos**2
          b35 = a31*(gamma(i, j, k)-1) + a35*(gamma(i, j, k)-1)
          b31d = dwo(1)*dwd(i, j, k, 3)
          dwod(1) = dwod(1) + b31*dwd(i, j, k, 3)
          b32d = dwo(2)*dwd(i, j, k, 3)
          dwod(2) = dwod(2) + b32*dwd(i, j, k, 3)
          b33d = dwo(3)*dwd(i, j, k, 3)
          dwod(3) = dwod(3) + b33*dwd(i, j, k, 3)
          b34d = dwo(4)*dwd(i, j, k, 3)
          dwod(4) = dwod(4) + b34*dwd(i, j, k, 3)
          b35d = dwo(5)*dwd(i, j, k, 3)
          dwod(5) = dwod(5) + b35*dwd(i, j, k, 3)
          dwd(i, j, k, 3) = 0.0_8
          velxrho = w(i, j, k, ivx)
          a21 = one*velxrho/sos**2
          a25 = one*(-velxrho)/sos**2
          b25 = a21*(gamma(i, j, k)-1) + a25*(gamma(i, j, k)-1)
          b21d = dwo(1)*dwd(i, j, k, 2)
          dwod(1) = dwod(1) + b21*dwd(i, j, k, 2)
          b22d = dwo(2)*dwd(i, j, k, 2)
          dwod(2) = dwod(2) + b22*dwd(i, j, k, 2)
          b23d = dwo(3)*dwd(i, j, k, 2)
          dwod(3) = dwod(3) + b23*dwd(i, j, k, 2)
          b24d = dwo(4)*dwd(i, j, k, 2)
          dwod(4) = dwod(4) + b24*dwd(i, j, k, 2)
          b25d = dwo(5)*dwd(i, j, k, 2)
          dwod(5) = dwod(5) + b25*dwd(i, j, k, 2)
          dwd(i, j, k, 2) = 0.0_8
          a11 = betamr2*(1/sos**4)
          a15 = (-betamr2)/sos**4
          b15 = a11*(gamma(i, j, k)-1) + a15*(gamma(i, j, k)-1)
          b11d = dwo(1)*dwd(i, j, k, 1)
          dwod(1) = dwod(1) + b11*dwd(i, j, k, 1)
          b12d = dwo(2)*dwd(i, j, k, 1)
          dwod(2) = dwod(2) + b12*dwd(i, j, k, 1)
          b13d = dwo(3)*dwd(i, j, k, 1)
          dwod(3) = dwod(3) + b13*dwd(i, j, k, 1)
          b14d = dwo(4)*dwd(i, j, k, 1)
          dwod(4) = dwod(4) + b14*dwd(i, j, k, 1)
          b15d = dwo(5)*dwd(i, j, k, 1)
          dwod(5) = dwod(5) + b15*dwd(i, j, k, 1)
          dwd(i, j, k, 1) = 0.0_8
          do l=nwf,1,-1
            call popreal8(dwo(l))
            dwd(i, j, k, l) = dwd(i, j, k, l) + max1*dwod(l)
            fwd(i, j, k, l) = fwd(i, j, k, l) + max1*dwod(l)
            dwod(l) = 0.0_8
            call popcontrol1b(branch)
            if (branch .eq. 0) then
              call popreal8(max1)
            else
              call popreal8(max1)
            end if
          end do
          temp3 = sos**4
          temp4 = sos**4
          temp6 = gamma(i, j, k) - 1
          tempd56 = (gamma(i, j, k)-1)*b11d
          tempd46 = (1-gamma(i, j, k))*b12d
          tempd47 = (1-gamma(i, j, k))*b12d
          tempd31 = (1-gamma(i, j, k))*b13d
          tempd32 = (1-gamma(i, j, k))*b13d
          tempd16 = (1-gamma(i, j, k))*b14d
          tempd17 = (1-gamma(i, j, k))*b14d
          temp13 = gamma(i, j, k) - 1
          tempd55 = (gamma(i, j, k)-1)*b21d
          tempd48 = (1-gamma(i, j, k))*b22d
          tempd49 = (1-gamma(i, j, k))*b22d
          tempd33 = (1-gamma(i, j, k))*b23d
          tempd34 = (1-gamma(i, j, k))*b23d
          tempd18 = (1-gamma(i, j, k))*b24d
          tempd19 = (1-gamma(i, j, k))*b24d
          temp20 = gamma(i, j, k) - 1
          tempd57 = (gamma(i, j, k)-1)*b31d
          tempd50 = (1-gamma(i, j, k))*b32d
          tempd51 = (1-gamma(i, j, k))*b32d
          tempd35 = (1-gamma(i, j, k))*b33d
          tempd36 = (1-gamma(i, j, k))*b33d
          tempd20 = (1-gamma(i, j, k))*b34d
          tempd21 = (1-gamma(i, j, k))*b34d
          temp27 = gamma(i, j, k) - 1
          tempd54 = (gamma(i, j, k)-1)*b41d
          tempd52 = (1-gamma(i, j, k))*b42d
          tempd53 = (1-gamma(i, j, k))*b42d
          tempd37 = (1-gamma(i, j, k))*b43d
          tempd38 = (1-gamma(i, j, k))*b43d
          tempd22 = (1-gamma(i, j, k))*b44d
          tempd23 = (1-gamma(i, j, k))*b44d
          q = velxrho**2 + velyrho**2 + velzrho**2
          tempd4 = (gamma(i, j, k)-1)*b51d
          temp36 = w(i, j, k, irho)
          tempd39 = -(b51d/temp36)
          temp35 = w(i, j, k, irho)
          tempd24 = -(b51d/temp35)
          temp34 = gamma(i, j, k) - 1
          temp33 = w(i, j, k, irho)
          tempd9 = -(b51d/temp33)
          a41d = velzrho*tempd23 + velxrho*tempd53 + q*tempd54/2 + &
&           velyrho*tempd38 + (gamma(i, j, k)-1)*b45d
          a45d = velzrho*tempd22 + velxrho*tempd52 + (temp27*(q/2)-sos**&
&           2)*b41d + velyrho*tempd37 + (gamma(i, j, k)-1)*b45d
          a44 = one*w(i, j, k, irho)
          a43 = zero
          a42 = zero
          temp29 = w(i, j, k, irho)
          tempd40 = -(a42*b41d/temp29)
          temp28 = w(i, j, k, irho)
          tempd25 = -(a43*b41d/temp28)
          temp26 = w(i, j, k, irho)
          tempd10 = -(b41d/temp26)
          a31d = velzrho*tempd21 + velxrho*tempd51 + q*tempd57/2 + &
&           velyrho*tempd36 + (gamma(i, j, k)-1)*b35d
          a35d = velzrho*tempd20 + velxrho*tempd50 + (temp20*(q/2)-sos**&
&           2)*b31d + velyrho*tempd35 + (gamma(i, j, k)-1)*b35d
          a34 = zero
          a33 = one*w(i, j, k, irho)
          a32 = zero
          temp22 = w(i, j, k, irho)
          tempd41 = -(a32*b31d/temp22)
          temp21 = w(i, j, k, irho)
          tempd26 = -(b31d/temp21)
          temp19 = w(i, j, k, irho)
          tempd11 = -(a34*b31d/temp19)
          a21d = velzrho*tempd19 + velxrho*tempd49 + q*tempd55/2 + &
&           velyrho*tempd34 + (gamma(i, j, k)-1)*b25d
          a25d = velzrho*tempd18 + velxrho*tempd48 + (temp13*(q/2)-sos**&
&           2)*b21d + velyrho*tempd33 + (gamma(i, j, k)-1)*b25d
          a24 = zero
          a23 = zero
          a22 = one*w(i, j, k, irho)
          temp15 = w(i, j, k, irho)
          tempd42 = -(b21d/temp15)
          temp14 = w(i, j, k, irho)
          tempd27 = -(a23*b21d/temp14)
          temp12 = w(i, j, k, irho)
          tempd12 = -(a24*b21d/temp12)
          a11d = velzrho*tempd17 + velxrho*tempd47 + q*tempd56/2 + &
&           velyrho*tempd32 + (gamma(i, j, k)-1)*b15d
          a15d = velzrho*tempd16 + velxrho*tempd46 + (temp6*(q/2)-sos**2&
&           )*b11d + velyrho*tempd31 + (gamma(i, j, k)-1)*b15d
          a14 = zero
          a13 = zero
          a12 = zero
          temp8 = w(i, j, k, irho)
          tempd43 = -(a12*b11d/temp8)
          temp7 = w(i, j, k, irho)
          tempd28 = -(a13*b11d/temp7)
          temp5 = w(i, j, k, irho)
          tempd13 = -(a14*b11d/temp5)
          tempd14 = -(one*a45d/sos**2)
          tempd15 = one*a41d/sos**2
          tempd29 = -(one*a35d/sos**2)
          tempd30 = one*a31d/sos**2
          tempd44 = -(one*a25d/sos**2)
          tempd45 = one*a21d/sos**2
          tempd7 = (1-gamma(i, j, k))*b52d
          tempd3 = (1-gamma(i, j, k))*b52d
          tempd8 = (1-gamma(i, j, k))*b53d
          tempd5 = (1-gamma(i, j, k))*b53d
          tempd6 = (1-gamma(i, j, k))*b54d
          tempd2 = (1-gamma(i, j, k))*b54d
          a51d = velzrho*tempd2 + velxrho*tempd3 + q*tempd4/2 + velyrho*&
&           tempd5 + (gamma(i, j, k)-1)*b55d
          a55d = velzrho*tempd6 + velxrho*tempd7 + (temp34*(q/2)-sos**2)&
&           *b51d + velyrho*tempd8 + (gamma(i, j, k)-1)*b55d
          a54 = one*w(i, j, k, irho)*velzrho
          call popreal8(b54)
          temp39 = w(i, j, k, irho)
          a54d = velzrho*tempd9 + b54d/temp39
          velzrhod = a54*tempd9 + a44*tempd10 + tempd11 + tempd12 + &
&           tempd13 + tempd14 + tempd15 + one*w(i, j, k, irho)*a54d + &
&           a15*tempd16 + a11*tempd17 + a25*tempd18 + a21*tempd19 + a35*&
&           tempd20 + a31*tempd21 + a45*tempd22 + a41*tempd23 + a55*&
&           tempd6 + a51*tempd2
          wd(i, j, k, irho) = wd(i, j, k, irho) - a54*b54d/temp39**2
          a53 = one*w(i, j, k, irho)*velyrho
          call popreal8(b53)
          temp38 = w(i, j, k, irho)
          a53d = velyrho*tempd24 + b53d/temp38
          velyrhod = a53*tempd24 + tempd25 + a33*tempd26 + tempd27 + &
&           tempd28 + tempd29 + tempd30 + one*w(i, j, k, irho)*a53d + &
&           a15*tempd31 + a11*tempd32 + a25*tempd33 + a21*tempd34 + a35*&
&           tempd35 + a31*tempd36 + a45*tempd37 + a41*tempd38 + a55*&
&           tempd8 + a51*tempd5
          wd(i, j, k, irho) = wd(i, j, k, irho) - a53*b53d/temp38**2
          a52 = one*w(i, j, k, irho)*velxrho
          call popreal8(b52)
          temp37 = w(i, j, k, irho)
          a52d = velxrho*tempd39 + b52d/temp37
          velxrhod = a52*tempd39 + tempd40 + tempd41 + a22*tempd42 + &
&           tempd43 + tempd44 + tempd45 + one*w(i, j, k, irho)*a52d + &
&           a15*tempd46 + a11*tempd47 + a25*tempd48 + a21*tempd49 + a35*&
&           tempd50 + a31*tempd51 + a45*tempd52 + a41*tempd53 + a55*&
&           tempd7 + a51*tempd3
          wd(i, j, k, irho) = wd(i, j, k, irho) - a52*b52d/temp37**2
          call popreal8(b51)
          qd = a41*tempd54/2 + temp27*a45*b41d/2 + a21*tempd55/2 + &
&           temp13*a25*b21d/2 + temp6*a15*b11d/2 + a11*tempd56/2 + &
&           temp20*a35*b31d/2 + a31*tempd57/2 + temp34*a55*b51d/2 + a51*&
&           tempd4/2
          wd(i, j, k, irho) = wd(i, j, k, irho) - a54*velzrho*tempd9/&
&           temp33 - a53*velyrho*tempd24/temp35 - a52*velxrho*tempd39/&
&           temp36
          sosd = betamr2*4*sos**3*a15d/temp4**2 - a25*2*sos*b21d - &
&           velzrho*2*tempd14/sos - velyrho*2*tempd29/sos - velxrho*2*&
&           tempd44/sos - a45*2*sos*b41d - betamr2*4*sos**3*a11d/temp3**&
&           2 - velxrho*2*tempd45/sos - velyrho*2*tempd30/sos - velzrho*&
&           2*tempd15/sos - a15*2*sos*b11d - a35*2*sos*b31d - a55*2*sos*&
&           b51d
          call popreal8(b44)
          temp32 = w(i, j, k, irho)
          a44d = velzrho*tempd10 + b44d/temp32
          wd(i, j, k, irho) = wd(i, j, k, irho) - a44*b44d/temp32**2
          call popreal8(b43)
          temp31 = w(i, j, k, irho)
          wd(i, j, k, irho) = wd(i, j, k, irho) - a43*b43d/temp31**2
          call popreal8(b42)
          temp30 = w(i, j, k, irho)
          wd(i, j, k, irho) = wd(i, j, k, irho) - a42*b42d/temp30**2
          call popreal8(b41)
          wd(i, j, k, irho) = wd(i, j, k, irho) - a44*velzrho*tempd10/&
&           temp26 - velyrho*tempd25/temp28 - velxrho*tempd40/temp29
          call popreal8(b34)
          temp25 = w(i, j, k, irho)
          wd(i, j, k, irho) = wd(i, j, k, irho) - a34*b34d/temp25**2
          call popreal8(b33)
          temp24 = w(i, j, k, irho)
          a33d = velyrho*tempd26 + b33d/temp24
          wd(i, j, k, irho) = wd(i, j, k, irho) - a33*b33d/temp24**2
          call popreal8(b32)
          temp23 = w(i, j, k, irho)
          wd(i, j, k, irho) = wd(i, j, k, irho) - a32*b32d/temp23**2
          call popreal8(b31)
          wd(i, j, k, irho) = wd(i, j, k, irho) - velzrho*tempd11/temp19&
&           - a33*velyrho*tempd26/temp21 - velxrho*tempd41/temp22
          call popreal8(b24)
          temp18 = w(i, j, k, irho)
          wd(i, j, k, irho) = wd(i, j, k, irho) - a24*b24d/temp18**2
          call popreal8(b23)
          temp17 = w(i, j, k, irho)
          wd(i, j, k, irho) = wd(i, j, k, irho) - a23*b23d/temp17**2
          call popreal8(b22)
          temp16 = w(i, j, k, irho)
          a22d = velxrho*tempd42 + b22d/temp16
          wd(i, j, k, irho) = wd(i, j, k, irho) - a22*b22d/temp16**2
          call popreal8(b21)
          wd(i, j, k, irho) = wd(i, j, k, irho) - velzrho*tempd12/temp12&
&           - velyrho*tempd27/temp14 - a22*velxrho*tempd42/temp15
          call popreal8(b14)
          temp11 = w(i, j, k, irho)
          wd(i, j, k, irho) = wd(i, j, k, irho) - a14*b14d/temp11**2
          call popreal8(b13)
          temp10 = w(i, j, k, irho)
          wd(i, j, k, irho) = wd(i, j, k, irho) - a13*b13d/temp10**2
          call popreal8(b12)
          temp9 = w(i, j, k, irho)
          wd(i, j, k, irho) = wd(i, j, k, irho) - a12*b12d/temp9**2
          call popreal8(b11)
          wd(i, j, k, irho) = wd(i, j, k, irho) - velzrho*tempd13/temp5 &
&           - velyrho*tempd28/temp7 - velxrho*tempd43/temp8
          resmd = one*resm*a51d - one*resm*a55d
          wd(i, j, k, irho) = wd(i, j, k, irho) + one*velzrho*a54d
          wd(i, j, k, irho) = wd(i, j, k, irho) + one*velyrho*a53d
          wd(i, j, k, irho) = wd(i, j, k, irho) + one*velxrho*a52d
          wd(i, j, k, irho) = wd(i, j, k, irho) + one*a44d
          wd(i, j, k, irho) = wd(i, j, k, irho) + one*a33d
          wd(i, j, k, irho) = wd(i, j, k, irho) + one*a22d
          betamr2d = a11d/temp3 - a15d/temp4
          call popcontrol1b(branch)
          if (branch .eq. 0) then
            call popreal8(betamr2)
            sosd = sosd + 2*sos*betamr2d
            x1d = 0.0_8
          else
            call popreal8(betamr2)
            x1d = betamr2d
          end if
          call popcontrol1b(branch)
          if (branch .eq. 0) then
            tempd0 = k2*x1d
            winfd(ivx) = winfd(ivx) + 2*winf(ivx)*tempd0
            winfd(ivy) = winfd(ivy) + 2*winf(ivy)*tempd0
            winfd(ivz) = winfd(ivz) + 2*winf(ivz)*tempd0
            k3d = 0.0_8
          else
            tempd1 = k3*x1d
            k3d = (velxrho**2+velyrho**2+velzrho**2)*x1d
            velxrhod = velxrhod + 2*velxrho*tempd1
            velyrhod = velyrhod + 2*velyrho*tempd1
            velzrhod = velzrhod + 2*velzrho*tempd1
          end if
          call popreal8(k3)
          resmd = resmd + (1-k1*m0**2)*2*resm*k3d/m0**4
          call popreal8(resm)
          temp2 = sqrt(q)
          if (.not.q .eq. 0.0_8) qd = qd + resmd/(sos*2.0*temp2)
          sosd = sosd - temp2*resmd/sos**2
          velxrhod = velxrhod + 2*velxrho*qd
          velyrhod = velyrhod + 2*velyrho*qd
          velzrhod = velzrhod + 2*velzrho*qd
          wd(i, j, k, ivz) = wd(i, j, k, ivz) + velzrhod
          wd(i, j, k, ivy) = wd(i, j, k, ivy) + velyrhod
          wd(i, j, k, ivx) = wd(i, j, k, ivx) + velxrhod
          call popreal8(sos)
          temp1 = w(i, j, k, irho)
          temp0 = p(i, j, k)/temp1
          if (gamma(i, j, k)*temp0 .eq. 0.0_8) then
            tempd = 0.0
          else
            tempd = gamma(i, j, k)*sosd/(2.0*sqrt(gamma(i, j, k)*temp0)*&
&             temp1)
          end if
          pd(i, j, k) = pd(i, j, k) + tempd
          wd(i, j, k, irho) = wd(i, j, k, irho) - temp0*tempd
        end do
      end do
    end do
  else
    do l=1,nwf
      do k=2,kl
        do j=2,jl
          do i=2,il
            x3 = real(iblank(i, j, k), realtype)
            if (x3 .lt. zero) then
              call pushreal8(max2)
              max2 = zero
              call pushcontrol1b(0)
            else
              call pushreal8(max2)
              max2 = x3
              call pushcontrol1b(1)
            end if
          end do
        end do
      end do
    end do
    fwd = 0.0_8
    do l=nwf,1,-1
      do k=kl,2,-1
        do j=jl,2,-1
          do i=il,2,-1
            fwd(i, j, k, l) = fwd(i, j, k, l) + max2*dwd(i, j, k, l)
            dwd(i, j, k, l) = max2*dwd(i, j, k, l)
            call popcontrol1b(branch)
            if (branch .eq. 0) then
              call popreal8(max2)
            else
              call popreal8(max2)
            end if
          end do
        end do
      end do
    end do
    winfd = 0.0_8
  end if
  call popcontrol3b(branch)
  if (branch .lt. 2) then
    if (branch .eq. 0) then
      call viscousflux_b()
      call allnodalgradients_b()
      call computespeedofsoundsquared_b()
      goto 100
    else
      call viscousflux_b()
      call allnodalgradients_b()
    end if
  else if (branch .eq. 2) then
    call viscousfluxapprox_b()
  else
    goto 100
  end if
  call computespeedofsoundsquared_b()
 100 call popcontrol3b(branch)
  if (branch .lt. 4) then
    if (branch .lt. 2) then
      if (branch .eq. 0) then
        call invisciddissfluxscalar_b()
      else
        call popreal8array(w, size(w, 1)*size(w, 2)*size(w, 3)*size(w, 4&
&                    ))
        call invisciddissfluxscalarapprox_b()
      end if
    else if (branch .eq. 2) then
      rhoinfd = 0.0_8
      pinfcorrd = 0.0_8
      radid = 0.0_8
      radjd = 0.0_8
      radkd = 0.0_8
    else
      call invisciddissfluxmatrix_b()
      goto 110
    end if
    trefd = 0.0_8
    rgasd = 0.0_8
    goto 120
  else if (branch .lt. 6) then
    if (branch .eq. 4) then
      call invisciddissfluxmatrixapprox_b()
    else
      pinfcorrd = 0.0_8
    end if
  else
    if (branch .eq. 6) then
      rhoinfd = 0.0_8
      trefd = 0.0_8
      pinfcorrd = 0.0_8
      rgasd = 0.0_8
      radid = 0.0_8
      radjd = 0.0_8
      radkd = 0.0_8
    else
      call inviscidupwindflux_b(finegrid)
      rhoinfd = 0.0_8
      pinfcorrd = 0.0_8
      radid = 0.0_8
      radjd = 0.0_8
      radkd = 0.0_8
    end if
    goto 120
  end if
 110 rhoinfd = 0.0_8
  trefd = 0.0_8
  rgasd = 0.0_8
  radid = 0.0_8
  radjd = 0.0_8
  radkd = 0.0_8
 120 call popreal8array(dw, size(dw, 1)*size(dw, 2)*size(dw, 3)*size(dw&
&                 , 4))
  call inviscidcentralflux_b()
end subroutine residual_block_b
