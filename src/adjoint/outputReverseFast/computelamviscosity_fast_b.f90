!        generated by tapenade     (inria, tropics team)
!  tapenade 3.10 (r5363) -  9 sep 2014 09:53
!
!  differentiation of computelamviscosity in reverse (adjoint) mode (with options i4 dr8 r8 noisize):
!   gradient     of useful results: *p *w *rlv
!   with respect to varying inputs: *p *w *rlv
!   rw status of diff variables: *p:incr *w:incr *rlv:in-out
!   plus diff mem management of: p:in w:in rlv:in
!
!      ******************************************************************
!      *                                                                *
!      * file:          computelamviscosity.f90                         *
!      * author:        edwin van der weide                             *
!      * starting date: 03-10-2003                                      *
!      * last modified: 06-12-2005                                      *
!      *                                                                *
!      ******************************************************************
!
subroutine computelamviscosity_fast_b()
!
!      ******************************************************************
!      *                                                                *
!      * computelamviscosity computes the laminar viscosity ratio in    *
!      * the owned cell centers of the given block. sutherland's law is *
!      * used. it is assumed that the pointes already point to the      *
!      * correct block before entering this subroutine.                 *
!      *                                                                *
!      ******************************************************************
!
  use blockpointers
  use constants
  use flowvarrefstate
  use inputphysics
  use iteration
  use utils_fast_b, only : getcorrectfork
  implicit none
!
!      local parameter.
!
  real(kind=realtype), parameter :: twothird=two*third
!
!      local variables.
!
  integer(kind=inttype) :: i, j, k, ii
  real(kind=realtype) :: musuth, tsuth, ssuth, t, pp
  real(kind=realtype) :: td, ppd
  logical :: correctfork
  intrinsic mod
  real(kind=realtype) :: temp0
  real(kind=realtype) :: tempd
  real(kind=realtype) :: tempd0
  real(kind=realtype) :: temp
!
!      ******************************************************************
!      *                                                                *
!      * begin execution                                                *
!      *                                                                *
!      ******************************************************************
!
! return immediately if no laminar viscosity needs to be computed.
  if (viscous) then
! determine whether or not the pressure must be corrected
! for the presence of the turbulent kinetic energy.
    correctfork = getcorrectfork()
! compute the nondimensional constants in sutherland's law.
    musuth = musuthdim/muref
    tsuth = tsuthdim/tref
    ssuth = ssuthdim/tref
! substract 2/3 rho k, which is a part of the normal turbulent
! stresses, in case the pressure must be corrected.
    if (correctfork) then
      do ii=0,ie*je*ke-1
        i = mod(ii, ie) + 1
        j = mod(ii/ie, je) + 1
        k = ii/(ie*je) + 1
        pp = p(i, j, k) - twothird*w(i, j, k, irho)*w(i, j, k, itu1)
        t = pp/(rgas*w(i, j, k, irho))
        tempd = musuth*(tsuth+ssuth)*rlvd(i, j, k)/(ssuth+t)
        td = (1.5_realtype*(t/tsuth)**0.5/tsuth-(t/tsuth)**1.5_realtype/&
&         (ssuth+t))*tempd
        rlvd(i, j, k) = 0.0_8
        temp = rgas*w(i, j, k, irho)
        ppd = td/temp
        wd(i, j, k, irho) = wd(i, j, k, irho) - pp*rgas*td/temp**2
        pd(i, j, k) = pd(i, j, k) + ppd
        wd(i, j, k, irho) = wd(i, j, k, irho) - twothird*w(i, j, k, itu1&
&         )*ppd
        wd(i, j, k, itu1) = wd(i, j, k, itu1) - twothird*w(i, j, k, irho&
&         )*ppd
      end do
    else
      do ii=0,ie*je*ke-1
        i = mod(ii, ie) + 1
        j = mod(ii/ie, je) + 1
        k = ii/(ie*je) + 1
! compute the nondimensional temperature and the
! nondimensional laminar viscosity.
        t = p(i, j, k)/(rgas*w(i, j, k, irho))
        tempd0 = musuth*(tsuth+ssuth)*rlvd(i, j, k)/(ssuth+t)
        td = (1.5_realtype*(t/tsuth)**0.5/tsuth-(t/tsuth)**1.5_realtype/&
&         (ssuth+t))*tempd0
        rlvd(i, j, k) = 0.0_8
        temp0 = rgas*w(i, j, k, irho)
        pd(i, j, k) = pd(i, j, k) + td/temp0
        wd(i, j, k, irho) = wd(i, j, k, irho) - p(i, j, k)*rgas*td/temp0&
&         **2
      end do
    end if
  end if
end subroutine computelamviscosity_fast_b
