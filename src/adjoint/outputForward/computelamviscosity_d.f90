!        generated by tapenade     (inria, tropics team)
!  tapenade 3.10 (r5363) -  9 sep 2014 09:53
!
!  differentiation of computelamviscosity in forward (tangent) mode (with options i4 dr8 r8):
!   variations   of useful results: *rlv
!   with respect to varying inputs: muref tref rgas *p *w
!   plus diff mem management of: p:in w:in rlv:in
!
!      ******************************************************************
!      *                                                                *
!      * file:          computelamviscosity.f90                         *
!      * author:        edwin van der weide                             *
!      * starting date: 03-10-2003                                      *
!      * last modified: 06-12-2005                                      *
!      *                                                                *
!      ******************************************************************
!
subroutine computelamviscosity_d()
!
!      ******************************************************************
!      *                                                                *
!      * computelamviscosity computes the laminar viscosity ratio in    *
!      * the owned cell centers of the given block. sutherland's law is *
!      * used. it is assumed that the pointes already point to the      *
!      * correct block before entering this subroutine.                 *
!      *                                                                *
!      ******************************************************************
!
  use blockpointers
  use constants
  use flowvarrefstate
  use inputphysics
  use iteration
  use utils_d, only : getcorrectfork
  implicit none
!
!      local parameter.
!
  real(kind=realtype), parameter :: twothird=two*third
!
!      local variables.
!
  integer(kind=inttype) :: i, j, k, ii
  real(kind=realtype) :: musuth, tsuth, ssuth, t, pp
  real(kind=realtype) :: musuthd, tsuthd, ssuthd, td, ppd
  logical :: correctfork
!
!      ******************************************************************
!      *                                                                *
!      * begin execution                                                *
!      *                                                                *
!      ******************************************************************
!
! return immediately if no laminar viscosity needs to be computed.
  if (.not.viscous) then
    rlvd = 0.0_8
    return
  else
! determine whether or not the pressure must be corrected
! for the presence of the turbulent kinetic energy.
    correctfork = getcorrectfork()
! compute the nondimensional constants in sutherland's law.
    musuthd = -(musuthdim*murefd/muref**2)
    musuth = musuthdim/muref
    tsuthd = -(tsuthdim*trefd/tref**2)
    tsuth = tsuthdim/tref
    ssuthd = -(ssuthdim*trefd/tref**2)
    ssuth = ssuthdim/tref
! substract 2/3 rho k, which is a part of the normal turbulent
! stresses, in case the pressure must be corrected.
    if (correctfork) then
      rlvd = 0.0_8
      do k=1,ke
        do j=1,je
          do i=1,ie
            ppd = pd(i, j, k) - twothird*(wd(i, j, k, irho)*w(i, j, k, &
&             itu1)+w(i, j, k, irho)*wd(i, j, k, itu1))
            pp = p(i, j, k) - twothird*w(i, j, k, irho)*w(i, j, k, itu1)
            td = (ppd*rgas*w(i, j, k, irho)-pp*(rgasd*w(i, j, k, irho)+&
&             rgas*wd(i, j, k, irho)))/(rgas*w(i, j, k, irho))**2
            t = pp/(rgas*w(i, j, k, irho))
            rlvd(i, j, k) = (musuthd*(tsuth+ssuth)/(t+ssuth)+musuth*((&
&             tsuthd+ssuthd)*(t+ssuth)-(tsuth+ssuth)*(td+ssuthd))/(t+&
&             ssuth)**2)*(t/tsuth)**1.5_realtype + musuth*(tsuth+ssuth)*&
&             1.5_realtype*(t/tsuth)**0.5*(td*tsuth-t*tsuthd)/((t+ssuth)&
&             *tsuth**2)
            rlv(i, j, k) = musuth*((tsuth+ssuth)/(t+ssuth))*(t/tsuth)**&
&             1.5_realtype
          end do
        end do
      end do
    else
      rlvd = 0.0_8
! loop over the owned cells *and* first level halos of this
! block and compute the laminar viscosity ratio.
      do k=1,ke
        do j=1,je
          do i=1,ie
! compute the nondimensional temperature and the
! nondimensional laminar viscosity.
            td = (pd(i, j, k)*rgas*w(i, j, k, irho)-p(i, j, k)*(rgasd*w(&
&             i, j, k, irho)+rgas*wd(i, j, k, irho)))/(rgas*w(i, j, k, &
&             irho))**2
            t = p(i, j, k)/(rgas*w(i, j, k, irho))
            rlvd(i, j, k) = (musuthd*(tsuth+ssuth)/(t+ssuth)+musuth*((&
&             tsuthd+ssuthd)*(t+ssuth)-(tsuth+ssuth)*(td+ssuthd))/(t+&
&             ssuth)**2)*(t/tsuth)**1.5_realtype + musuth*(tsuth+ssuth)*&
&             1.5_realtype*(t/tsuth)**0.5*(td*tsuth-t*tsuthd)/((t+ssuth)&
&             *tsuth**2)
            rlv(i, j, k) = musuth*((tsuth+ssuth)/(t+ssuth))*(t/tsuth)**&
&             1.5_realtype
          end do
        end do
      end do
    end if
  end if
end subroutine computelamviscosity_d
