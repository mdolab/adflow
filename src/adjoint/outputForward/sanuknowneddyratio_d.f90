!        generated by tapenade     (inria, tropics team)
!  tapenade 3.10 (r5363) -  9 sep 2014 09:53
!
!  differentiation of sanuknowneddyratio in forward (tangent) mode (with options i4 dr8 r8):
!   variations   of useful results: sanuknowneddyratio
!   with respect to varying inputs: nulam
function sanuknowneddyratio_d(eddyratio, nulam, nulamd, &
& sanuknowneddyratio)
!
!       sanuknowneddyratio computes the spalart-allmaras transport     
!       variable nu for the given eddy viscosity ratio.                
!
  use constants
  use paramturb
  implicit none
!
!      function type.
!
  real(kind=realtype) :: sanuknowneddyratio
  real(kind=realtype) :: sanuknowneddyratio_d
!
!      function arguments.
!
  real(kind=realtype), intent(in) :: eddyratio, nulam
  real(kind=realtype), intent(in) :: nulamd
!
!      local variables.
!
  real(kind=realtype) :: cv13, chi, chi2, chi3, chi4, f, df, dchi
  intrinsic abs
  real(kind=realtype) :: abs0
! take care of the exceptional cases.
  if (eddyratio .le. zero) then
    sanuknowneddyratio = zero
    sanuknowneddyratio_d = 0.0_8
    return
  else
! set the value of cv1^3, which is the constant appearing in the
! sa function fv1 to compute the eddy viscosity
    cv13 = rsacv1**3
! determine the value of chi, which is given by the quartic
! polynomial chi^4 - ratio*(chi^3 + cv1^3) = 0.
! first determine the start value, depending on the eddyratio.
    if (eddyratio .lt. 1.e-4_realtype) then
      chi = 0.5_realtype
    else if (eddyratio .lt. 1.0_realtype) then
      chi = 5.0_realtype
    else if (eddyratio .lt. 10.0_realtype) then
      chi = 10.0_realtype
    else
      chi = eddyratio
    end if
! the actual newton algorithm.
    do 
! compute the function value and the derivative.
      chi2 = chi*chi
      chi3 = chi*chi2
      chi4 = chi*chi3
      f = chi4 - eddyratio*(chi3+cv13)
      df = four*chi3 - three*eddyratio*chi2
! compute the negative update and the new value of chi.
      dchi = f/df
      chi = chi - dchi
      if (dchi/chi .ge. 0.) then
        abs0 = dchi/chi
      else
        abs0 = -(dchi/chi)
      end if
! condition to exit the loop.
      if (abs0 .le. thresholdreal) goto 100
    end do
! chi is the ratio of the spalart allmaras transport variable and
! the laminar viscosity. so multiply chi with the laminar viscosity
! to obtain the correct value.
 100 sanuknowneddyratio_d = chi*nulamd
    sanuknowneddyratio = nulam*chi
  end if
end function sanuknowneddyratio_d
