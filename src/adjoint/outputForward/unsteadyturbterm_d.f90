!        generated by tapenade     (inria, tropics team)
!  tapenade 3.10 (r5363) -  9 sep 2014 09:53
!
!  differentiation of unsteadyturbterm in forward (tangent) mode (with options i4 dr8 r8):
!   variations   of useful results: *scratch
!   with respect to varying inputs: timeref *w *scratch
!   plus diff mem management of: dw:in w:in scratch:in
!
!      ******************************************************************
!      *                                                                *
!      * file:          unsteadyturbterm.f90                            *
!      * author:        edwin van der weide                             *
!      * starting date: 02-09-2004                                      *
!      * last modified: 11-27-2007                                      *
!      *                                                                *
!      ******************************************************************
!
subroutine unsteadyturbterm_d(madv, nadv, offset, qq)
!
!      ******************************************************************
!      *                                                                *
!      * unsteadyturbterm discretizes the time derivative of the        *
!      * turbulence transport equations and add it to the residual.     *
!      * as the time derivative is the same for all turbulence models,  *
!      * this generic routine can be used; both the discretization of   *
!      * the time derivative and its contribution to the central        *
!      * jacobian are computed by this routine.                         *
!      *                                                                *
!      * only nadv equations are treated, while the actual system has   *
!      * size madv. the reason is that some equations for some          *
!      * turbulence equations do not have a time derivative, e.g. the   *
!      * f equation in the v2-f model. the argument offset indicates    *
!      * the offset in the w vector where this subsystem starts. as a   *
!      * consequence it is assumed that the indices of the current      *
!      * subsystem are contiguous, e.g. if a 2*2 system is solved the   *
!      * last index in w is offset+1 and offset+2 respectively.         *
!      *                                                                *
!      ******************************************************************
!
  use blockpointers
  use flowvarrefstate
  use inputphysics
  use inputtimespectral
  use inputunsteady
  use iteration
  use section
  use turbmod
  implicit none
!
!      subroutine arguments.
!
  integer(kind=inttype), intent(in) :: madv, nadv, offset
  real(kind=realtype), dimension(2:il, 2:jl, 2:kl, madv, madv), intent(&
& inout) :: qq
!
!      local variables.
!
  integer(kind=inttype) :: i, j, k, ii, jj, nn
  real(kind=realtype) :: oneoverdt, tmp
  real(kind=realtype) :: oneoverdtd, tmpd
!
!      ******************************************************************
!      *                                                                *
!      * begin execution                                                *
!      *                                                                *
!      ******************************************************************
!
! determine the equation mode.
  select case  (equationmode) 
  case (steady) 
! steady computation. no time derivative present.
    return
  case (unsteady) 
!===============================================================
! the time deritvative term depends on the integration
! scheme used.
    select case  (timeintegrationscheme) 
    case (bdf) 
! backward difference formula is used as time
! integration scheme.
! store the inverse of the physical nondimensional
! time step a bit easier.
      oneoverdtd = timerefd/deltat
      oneoverdt = timeref/deltat
! loop over the number of turbulent transport equations.
nadvloopunsteady:do ii=1,nadv
! store the index of the current turbulent variable in jj.
        jj = ii + offset
! loop over the owned cells of this block to compute the
! time derivative.
        do k=2,kl
          do j=2,jl
            do i=2,il
! initialize tmp to the value of the current
! level multiplied by the corresponding coefficient
! in the time integration scheme.
              tmpd = coeftime(0)*wd(i, j, k, jj)
              tmp = coeftime(0)*w(i, j, k, jj)
! loop over the old time levels and add the
! corresponding contribution to tmp.
              do nn=1,noldlevels
                tmp = tmp + coeftime(nn)*wold(nn, i, j, k, jj)
              end do
! update the residual. note that in the turbulent
! routines the residual is defined with an opposite
! sign compared to the residual of the flow equations.
! therefore the time derivative must be substracted
! from dvt.
              scratchd(i, j, k, idvt+ii-1) = scratchd(i, j, k, idvt+ii-1&
&               ) - oneoverdtd*tmp - oneoverdt*tmpd
              scratch(i, j, k, idvt+ii-1) = scratch(i, j, k, idvt+ii-1) &
&               - oneoverdt*tmp
! update the central jacobian.
              qq(i, j, k, ii, ii) = qq(i, j, k, ii, ii) + coeftime(0)*&
&               oneoverdt
            end do
          end do
        end do
      end do nadvloopunsteady
    case (explicitrk) 
!===========================================================
! explicit time integration scheme. the time derivative
! is handled differently.
      return
    case (implicitrk) 
!===========================================================
      call terminate('unsteadyturbterm', &
&                 'implicit rk not implemented yet')
    end select
  case (timespectral) 
!===============================================================
! time spectral method.
! loop over the number of turbulent transport equations.
nadvloopspectral:do ii=1,nadv
! store the index of the current turbulent variable in jj.
      jj = ii + offset
! the time derivative has been computed earlier in
! unsteadyturbspectral and stored in entry jj of scratch.
! substract this value for all owned cells. it must be
! substracted, because in the turbulent routines the
! residual is defined with an opposite sign compared to
! the residual of the flow equations.
! also add a term to the diagonal matrix, which corresponds
! to to the contribution of the highest frequency. this is
! equivalent to an explicit treatment of the time derivative
! and may need to be changed.
      tmp = ntimeintervalsspectral*pi*timeref/sections(sectionid)%&
&       timeperiod
      do k=2,kl
        do j=2,jl
          do i=2,il
            scratch(i, j, k, idvt+ii-1) = scratch(i, j, k, idvt+ii-1) - &
&             dw(i, j, k, jj)
            qq(i, j, k, ii, ii) = qq(i, j, k, ii, ii) + tmp
          end do
        end do
      end do
    end do nadvloopspectral
  end select
end subroutine unsteadyturbterm_d
