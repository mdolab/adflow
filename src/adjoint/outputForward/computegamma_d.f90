!        generated by tapenade     (inria, tropics team)
!  tapenade 3.10 (r5363) -  9 sep 2014 09:53
!
!  differentiation of computegamma in forward (tangent) mode (with options i4 dr8 r8):
!   variations   of useful results: gamma
!   with respect to varying inputs: t
!
!      ******************************************************************
!      *                                                                *
!      * file:          computegamma.f90                                *
!      * author:        edwin van der weide                             *
!      * starting date: 09-16-2003                                      *
!      * last modified: 03-23-2005                                      *
!      *                                                                *
!      ******************************************************************
!
subroutine computegamma_d(t, td, gamma, gammad, mm)
!
!      ******************************************************************
!      *                                                                *
!      * computegamma computes the corresponding values of gamma for    *
!      * the given dimensional temperatures.                            *
!      *                                                                *
!      ******************************************************************
!
  use constants
  use cpcurvefits
  use inputphysics
  implicit none
  integer(kind=inttype), intent(in) :: mm
!
!      subroutine arguments.
!
  real(kind=realtype), dimension(mm), intent(in) :: t
  real(kind=realtype), dimension(mm), intent(in) :: td
  real(kind=realtype), dimension(mm), intent(out) :: gamma
  real(kind=realtype), dimension(mm), intent(out) :: gammad
!
!      local variables.
!
  integer(kind=inttype) :: i, ii, nn, start
  real(kind=realtype) :: cp, t2
  real(kind=realtype) :: cpd, t2d
!
!      ******************************************************************
!      *                                                                *
!      * begin execution                                                *
!      *                                                                *
!      ******************************************************************
!
! determine the cp model used in the computation.
  select case  (cpmodel) 
  case (cpconstant) 
! constant cp and thus constant gamma. set the values.
    do i=1,mm
      gamma(i) = gammaconstant
    end do
    gammad = 0.0_8
  case (cptempcurvefits) 
    gammad = 0.0_8
!        ================================================================
! cp as function of the temperature is given via curve fits.
    do i=1,mm
! determine the case we are having here.
      if (t(i) .le. cptrange(0)) then
! temperature is less than the smallest temperature
! in the curve fits. use cv0 to compute gamma.
        gammad(i) = 0.0_8
        gamma(i) = (cv0+one)/cv0
      else if (t(i) .ge. cptrange(cpnparts)) then
! temperature is larger than the largest temperature
! in the curve fits. use cvn to compute gamma.
        gammad(i) = 0.0_8
        gamma(i) = (cvn+one)/cvn
      else
! temperature is in the curve fit range.
! first find the valid range.
        ii = cpnparts
        start = 1
interval:do 
! next guess for the interval.
          nn = start + ii/2
! determine the situation we are having here.
          if (t(i) .gt. cptrange(nn)) then
! temperature is larger than the upper boundary of
! the current interval. update the lower boundary.
            start = nn + 1
            ii = ii - 1
          else if (t(i) .ge. cptrange(nn-1)) then
            goto 100
          end if
! this is the correct range. exit the do-loop.
! modify ii for the next branch to search.
          ii = ii/2
        end do interval
! nn contains the correct curve fit interval.
! compute the value of cp.
 100    cp = zero
        cpd = 0.0_8
        do ii=1,cptempfit(nn)%nterm
          if (t(i) .gt. 0.0_8 .or. (t(i) .lt. 0.0_8 .and. cptempfit(nn)%&
&             exponents(ii) .eq. int(cptempfit(nn)%exponents(ii)))) then
            t2d = cptempfit(nn)%exponents(ii)*t(i)**(cptempfit(nn)%&
&             exponents(ii)-1)*td(i)
          else if (t(i) .eq. 0.0_8 .and. cptempfit(nn)%exponents(ii) &
&             .eq. 1.0) then
            t2d = td(i)
          else
            t2d = 0.0_8
          end if
          t2 = t(i)**cptempfit(nn)%exponents(ii)
          cpd = cpd + cptempfit(nn)%constants(ii)*t2d
          cp = cp + cptempfit(nn)%constants(ii)*t2
        end do
! compute the corresponding value of gamma.
        gammad(i) = (cpd*(cp-one)-cp*cpd)/(cp-one)**2
        gamma(i) = cp/(cp-one)
      end if
    end do
  case default
    gammad = 0.0_8
  end select
end subroutine computegamma_d
