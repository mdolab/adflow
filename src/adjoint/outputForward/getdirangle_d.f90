!        generated by tapenade     (inria, tropics team)
!  tapenade 3.10 (r5363) -  9 sep 2014 09:53
!
!  differentiation of getdirangle in forward (tangent) mode (with options i4 dr8 r8):
!   variations   of useful results: alpha beta
!   with respect to varying inputs: freestreamaxis
!
!      file:          getdirangle.f90                                 
!      author:        andre c. marta,c.a.(sandy) mader                
!      starting date: 10-25-2005                                      
!      last modified: 06-13-2008                                      
!
subroutine getdirangle_d(freestreamaxis, freestreamaxisd, liftaxis, &
& liftindex, alpha, alphad, beta, betad)
!
!      convert the wind axes to angle of attack and side slip angle.  
!      the direction angles alpha and beta are computed given the     
!      components of the wind direction vector (freestreamaxis), the  
!      lift direction vector (liftaxis) and assuming that the         
!      body direction (xb,yb,zb) is in the default ijk coordinate     
!      system. the rotations are determined by first determining      
!      whether the lift is primarily in the j or k direction and then 
!      determining the angles accordingly.                            
!      direction vector:                                              
!        1) rotation about the zb or yb -axis: alpha clockwise (cw)   
!           (xb,yb,zb) -> (x1,y1,z1)                                  
!        2) rotation about the yl or z1 -axis: beta counter-clockwise 
!           (ccw) (x1,y1,z1) -> (xw,yw,zw)                            
!         input arguments:                                            
!            freestreamaxis = wind vector in body axes                
!            liftaxis       = lift direction vector in body axis      
!         output arguments:                                           
!            alpha    = angle of attack in radians                    
!            beta     = side slip angle in radians                    
!
  use constants
  use utils_d, only : terminate
  implicit none
!
!     subroutine arguments.
!
!      real(kind=realtype), intent(in)  :: xw, yw, zw
  real(kind=realtype), dimension(3), intent(in) :: freestreamaxis
  real(kind=realtype), dimension(3), intent(in) :: freestreamaxisd
  real(kind=realtype), dimension(3), intent(in) :: liftaxis
  real(kind=realtype), intent(out) :: alpha, beta
  real(kind=realtype), intent(out) :: alphad, betad
  integer(kind=inttype), intent(out) :: liftindex
!
!     local variables.
!
  real(kind=realtype) :: rnorm
  real(kind=realtype) :: rnormd
  integer(kind=inttype) :: flowindex, i
  real(kind=realtype), dimension(3) :: freestreamaxisnorm
  real(kind=realtype), dimension(3) :: freestreamaxisnormd
  integer(kind=inttype) :: temp
  intrinsic abs
  intrinsic sqrt
  intrinsic asin
  intrinsic atan2
  real(kind=realtype) :: arg1
  real(kind=realtype) :: arg1d
  real(kind=realtype) :: abs7
  real(kind=realtype) :: abs6
  real(kind=realtype) :: abs5
  real(kind=realtype) :: abs4
  real(kind=realtype) :: abs3
  real(kind=realtype) :: abs2
  real(kind=realtype) :: abs1
  real(kind=realtype) :: abs0
!
!      begin execution.                                               
!
! assume domoniate flow is x
  flowindex = 1
  if (liftaxis(1) .ge. 0.) then
    abs0 = liftaxis(1)
  else
    abs0 = -liftaxis(1)
  end if
  if (liftaxis(2) .ge. 0.) then
    abs2 = liftaxis(2)
  else
    abs2 = -liftaxis(2)
  end if
  if (liftaxis(1) .ge. 0.) then
    abs4 = liftaxis(1)
  else
    abs4 = -liftaxis(1)
  end if
  if (liftaxis(3) .ge. 0.) then
    abs6 = liftaxis(3)
  else
    abs6 = -liftaxis(3)
  end if
! determine the dominant lift direction
  if (abs0 .gt. abs2 .and. abs4 .gt. abs6) then
    temp = 1
  else
    if (liftaxis(2) .ge. 0.) then
      abs1 = liftaxis(2)
    else
      abs1 = -liftaxis(2)
    end if
    if (liftaxis(1) .ge. 0.) then
      abs3 = liftaxis(1)
    else
      abs3 = -liftaxis(1)
    end if
    if (liftaxis(2) .ge. 0.) then
      abs5 = liftaxis(2)
    else
      abs5 = -liftaxis(2)
    end if
    if (liftaxis(3) .ge. 0.) then
      abs7 = liftaxis(3)
    else
      abs7 = -liftaxis(3)
    end if
    if (abs1 .gt. abs3 .and. abs5 .gt. abs7) then
      temp = 2
    else
      temp = 3
    end if
  end if
  liftindex = temp
! normalize the freestreamdirection vector.
  arg1d = 2*freestreamaxis(1)*freestreamaxisd(1) + 2*freestreamaxis(2)*&
&   freestreamaxisd(2) + 2*freestreamaxis(3)*freestreamaxisd(3)
  arg1 = freestreamaxis(1)**2 + freestreamaxis(2)**2 + freestreamaxis(3)&
&   **2
  if (arg1 .eq. 0.0_8) then
    rnormd = 0.0_8
  else
    rnormd = arg1d/(2.0*sqrt(arg1))
  end if
  rnorm = sqrt(arg1)
  freestreamaxisnormd = 0.0_8
  do i=1,3
    freestreamaxisnormd(i) = (freestreamaxisd(i)*rnorm-freestreamaxis(i)&
&     *rnormd)/rnorm**2
    freestreamaxisnorm(i) = freestreamaxis(i)/rnorm
  end do
  if (liftindex .eq. 2) then
! different coordinate system for aerosurf
! wing is in z- direction
! compute angle of attack alpha.
    if (freestreamaxisnorm(2) .eq. 1.0 .or. freestreamaxisnorm(2) .eq. (&
&       -1.0)) then
      alphad = 0.0_8
    else
      alphad = freestreamaxisnormd(2)/sqrt(1.0-freestreamaxisnorm(2)**2)
    end if
    alpha = asin(freestreamaxisnorm(2))
! compute side-slip angle beta.
    betad = -((freestreamaxisnormd(3)*freestreamaxisnorm(1)-&
&     freestreamaxisnormd(1)*freestreamaxisnorm(3))/(freestreamaxisnorm(&
&     3)**2+freestreamaxisnorm(1)**2))
    beta = -atan2(freestreamaxisnorm(3), freestreamaxisnorm(1))
  else if (liftindex .eq. 3) then
! wing is in y- direction
! compute angle of attack alpha.
    if (freestreamaxisnorm(3) .eq. 1.0 .or. freestreamaxisnorm(3) .eq. (&
&       -1.0)) then
      alphad = 0.0_8
    else
      alphad = freestreamaxisnormd(3)/sqrt(1.0-freestreamaxisnorm(3)**2)
    end if
    alpha = asin(freestreamaxisnorm(3))
! compute side-slip angle beta.
    betad = (freestreamaxisnormd(2)*freestreamaxisnorm(1)-&
&     freestreamaxisnormd(1)*freestreamaxisnorm(2))/(freestreamaxisnorm(&
&     2)**2+freestreamaxisnorm(1)**2)
    beta = atan2(freestreamaxisnorm(2), freestreamaxisnorm(1))
  else
    call terminate('getdirangle', 'invalid lift direction')
    alphad = 0.0_8
    betad = 0.0_8
  end if
end subroutine getdirangle_d
