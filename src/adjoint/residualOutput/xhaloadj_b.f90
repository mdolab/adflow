!        Generated by TAPENADE     (INRIA, Tropics team)
!  Tapenade - Version 2.2 (r1239) - Wed 28 Jun 2006 04:59:55 PM CEST
!  
!  Differentiation of xhaloadj in reverse (adjoint) mode:
!   gradient, with respect to input variables: xadj xblockcorneradj
!   of linear combination of output variables: xadj xblockcorneradj
!
!      ******************************************************************
!      *                                                                *
!      * File:          xhaloAdj.f90                                    *
!      * Author:        Edwin van der Weide,C.A.(Sandy) Mader           *
!      * Starting date: 08-13-2009                                      *
!      * Last modified: 08-13-2009                                      *
!      *                                                                *
!      ******************************************************************
!
SUBROUTINE XHALOADJ_B(xadj, xadjb, xblockcorneradj, xblockcorneradjb, &
     &  icell, jcell, kcell, nn, level, sps, sps2)
  USE bctypes
  USE blockpointers
  USE communication
  USE inputtimespectral
  IMPLICIT NONE
  !     enddo domains
  !  enddo spectralLoop
!!$         !print out xAdj
!!$         istart2 = -3
!!$         jstart2 = -3
!!$         kstart2 = -3
!!$         iend2 = 2
!!$         jend2 = 2
!!$         kend2 = 2
!!$         if(icell==2) istart2=-2
!!$         if(jcell==2) jstart2=-2
!!$         if(kcell==2) kstart2=-2
!!$         if(icell==il) iend2=1
!!$         if(jcell==jl) jend2=1
!!$         if(kcell==kl) kend2=1
!!$         do iiii = istart2,iend2
!!$            do jjjj = jstart2,jend2
!!$               do kkkk = kstart2,kend2
!!$                  do n = 1,3
!!$                     i = icell+iiii
!!$                     j = jcell+jjjj
!!$                     k = kcell+kkkk
!!$                     write(unitxAD,10) i,j,k,n,xAdj(iiii,jjjj,kkkk,n)
!!$10                   format(1x,'res',4I8,f20.14)
!!$                  enddo
!!$               enddo
!!$            enddo
!!$         enddo
!!$!
!!$!      ******************************************************************
!!$!      *                                                                *
!!$!      * Exchange the coordinates for the internal halo's.              *
!!$!      *                                                                *
!!$!      ******************************************************************
!!$!
!!$   call exchangeCoor(level)
  INTEGER(KIND=INTTYPE), INTENT(IN) :: icell
  INTEGER(KIND=INTTYPE), INTENT(IN) :: jcell
  INTEGER(KIND=INTTYPE), INTENT(IN) :: kcell
  INTEGER(KIND=INTTYPE), INTENT(IN) :: level
  INTEGER(KIND=INTTYPE), INTENT(IN) :: nn
  INTEGER(KIND=INTTYPE), INTENT(IN) :: sps
  INTEGER(KIND=INTTYPE), INTENT(IN) :: sps2
  REAL(KIND=REALTYPE) :: xadj(-3:2, -3:2, -3:2, 3, &
       &  ntimeintervalsspectral), xadjb(-3:2, -3:2, -3:2, 3, &
       &  ntimeintervalsspectral)
  REAL(KIND=REALTYPE) :: xblockcorneradj(2, 2, 2, 3, &
       &  ntimeintervalsspectral), xblockcorneradjb(2, 2, 2, 3, &
       &  ntimeintervalsspectral)
  INTEGER(KIND=INTTYPE) :: ibeg, iend, iimax, jbeg, jend, jjmax
  INTEGER(KIND=INTTYPE) :: imaxoffset, jmaxoffset, kmaxoffset
  LOGICAL :: imaxinternal, imaxoverlap, imininternal, iminoverlap, &
       &  jmaxinternal, jmaxoverlap, jmininternal, jminoverlap, kmaxinternal, &
       &  kmaxoverlap, kmininternal, kminoverlap
  INTEGER(KIND=INTTYPE) :: istart, jstart
  INTEGER(KIND=INTTYPE) :: i, ii, j, jj, k, mm
  INTEGER(KIND=INTTYPE) :: iminoffset, jminoffset, kminoffset
  INTEGER :: ad_from, ad_from0, ad_to, ad_to0, branch, iend2, iii, iiii&
       &  , istart2, itemp, jend2, jjj, jjjj, jstart2, jtemp, kend2, kkk, kkkk&
       &  , kstart2, n, nnn, nnnn, unitxad=13
  REAL(KIND=REALTYPE) :: dot, dotb, length, lengthb, tempb, tempb0
  REAL(KIND=REALTYPE) :: norm(3), normb(3), v1(3), v1b(3), v2(3), v2b(3)
  REAL(KIND=REALTYPE) :: x0(-3:2, -3:2, 3), x0b(-3:2, -3:2, 3), x1(-3:2&
       &  , -3:2, 3), x1b(-3:2, -3:2, 3), x2(-3:2, -3:2, 3), x2b(-3:2, -3:2, 3)
  REAL(KIND=REALTYPE) :: xfacecorner(2, 2, 3), xfacecornerb(2, 2, 3)
  INTRINSIC MAX, MIN, SQRT
  !
  !      ******************************************************************
  !      *                                                                *
  !      * xhaloAdj determines the coordinates of the nodal halo's.       *
  !      * First it sets all halo coordinates by simple extrapolation,    *
  !      * then the symmetry planes are treated (also the unit normal of  *
  !      * symmetry planes are determined) the internal halo exchange is  *
  !      * ignored. The global indexing in the derivatives takes care of  *
  !      * this.                                                          *
  !      *                                                                *
  !      ******************************************************************
  !
  !nIntervalTimespectral
  !
  !      Subroutine arguments.
  !
  !integer(kind=intType) :: level
  !
  !      Local variables.
  !
  !integer(kind=intType) :: iBeg2, iEnd2, jBeg2, jEnd2
  !real(kind=realType), dimension(:,:,:), pointer :: x0, x1, x2
  !,dimension(nTimeIntervalsSpectral)
  !,iend,jend
  !FILEIO
  !
  !      ******************************************************************
  !      *                                                                *
  !      * Begin execution                                                *
  !      *                                                                *
  !      ******************************************************************
  !
!!$       ! Loop over the number of spectral solutions and the local
!!$       ! number of blocks.
!!$
!!$       spectralLoop: do sps=1,nTimeIntervalsSpectral
!!$         domains: do nn=1,nDom
!!$
!!$           ! Set the pointers to this block.
!!$
!!$           call setPointers(nn, level, sps)
!!$
  !Check to see if current cell contains a halo and if so which one...
  CALL CHECKXOVERLAPADJ(icell, jcell, kcell, iminoffset, imaxoffset, &
       &                  jminoffset, jmaxoffset, kminoffset, kmaxoffset, &
       &                  iminoverlap, jminoverlap, kminoverlap, imaxoverlap, &
       &                  jmaxoverlap, kmaxoverlap)
  !
  !          **************************************************************
  !          *                                                            *
  !          * Because of exchangeCorr at the end of the original xhalo   *
  !          * the internal face halos need to be left alone. Therefore   *
  !          * loop over the Bocos to determine which block faces are     *
  !          * internal.                                                  *
  !          *                                                            *
  !          **************************************************************
  !
  imininternal = .false.
  jmininternal = .false.
  kmininternal = .false.
  imaxinternal = .false.
  jmaxinternal = .false.
  kmaxinternal = .false.
  !print *,'internals',iMinInternal,jMinInternal,kMinInternal,&
  !    iMaxInternal,jMaxInternal,kMaxInternal
  !Bocos
  loopsubface:DO mm=1,nsubface
     ! Check whether a given block face is internal
     ! print *,'bctype',BCType(mm),B2BMatch,mm
     IF (bctype(mm) .EQ. b2bmatch) THEN
        SELECT CASE  (bcfaceid(mm)) 
        CASE (imin) 
           imininternal = .true.
           CALL PUSHINTEGER4(3)
        CASE (imax) 
           imaxinternal = .true.
           CALL PUSHINTEGER4(4)
        CASE (jmin) 
           jmininternal = .true.
           CALL PUSHINTEGER4(5)
        CASE (jmax) 
           jmaxinternal = .true.
           CALL PUSHINTEGER4(6)
        CASE (kmin) 
           kmininternal = .true.
           CALL PUSHINTEGER4(7)
        CASE (kmax) 
           kmaxinternal = .true.
           CALL PUSHINTEGER4(8)
        CASE DEFAULT
           CALL PUSHINTEGER4(2)
        END SELECT
     ELSE
        CALL PUSHINTEGER4(1)
     END IF
  END DO loopsubface
  !print *,'internals after',iMinInternal,jMinInternal,kMinInternal,&
  !     iMaxInternal,jMaxInternal,kMaxInternal
  !
  !          **************************************************************
  !          *                                                            *
  !          * Extrapolation of the coordinates. First extrapolation in   *
  !          * i-direction, without halo's, followed by extrapolation in  *
  !          * j-direction, with i-halo's and finally extrapolation in    *
  !          * k-direction, with both i- and j-halo's. In this way also   *
  !          * the indirect halo's get a value, albeit a bit arbitrary.   *
  !          *                                                            *
  !          **************************************************************
  !
  ! Extrapolation in i-direction.
  IF (iminoverlap) THEN
     IF (.NOT.imininternal) THEN
        IF (iminoffset .GE. -3) THEN
           DO j=-3,2
              DO k=-3,2
                 jjj = jcell + j
                 kkk = kcell + k
                 IF (kkk .GE. 1 .AND. jjj .GE. 1) THEN
                    IF (kkk .LE. kl .AND. jjj .LE. jl) THEN
                       CALL PUSHREAL8(xadj(iminoffset, j, k, 1, sps2))
                       xadj(iminoffset, j, k, 1, sps2) = two*xadj(iminoffset+1&
                            &                  , j, k, 1, sps2) - xadj(iminoffset+2, j, k, 1, sps2)
                       CALL PUSHREAL8(xadj(iminoffset, j, k, 2, sps2))
                       xadj(iminoffset, j, k, 2, sps2) = two*xadj(iminoffset+1&
                            &                  , j, k, 2, sps2) - xadj(iminoffset+2, j, k, 2, sps2)
                       CALL PUSHREAL8(xadj(iminoffset, j, k, 3, sps2))
                       xadj(iminoffset, j, k, 3, sps2) = two*xadj(iminoffset+1&
                            &                  , j, k, 3, sps2) - xadj(iminoffset+2, j, k, 3, sps2)
                       CALL PUSHINTEGER4(3)
                    ELSE
                       CALL PUSHINTEGER4(2)
                    END IF
                 ELSE
                    CALL PUSHINTEGER4(1)
                 END IF
              END DO
           END DO
           CALL PUSHINTEGER4(3)
        ELSE
           CALL PUSHINTEGER4(2)
        END IF
     ELSE
        CALL PUSHINTEGER4(1)
     END IF
  ELSE
     CALL PUSHINTEGER4(0)
  END IF
  IF (imaxoverlap) THEN
     IF (.NOT.imaxinternal) THEN
        IF (imaxoffset .LE. 2) THEN
           DO j=-3,2
              DO k=-3,2
                 jjj = jcell + j
                 kkk = kcell + k
                 IF (kkk .GE. 1 .AND. jjj .GE. 1) THEN
                    IF (kkk .LE. kl .AND. jjj .LE. jl) THEN
                       CALL PUSHREAL8(xadj(imaxoffset, j, k, 1, sps2))
                       xadj(imaxoffset, j, k, 1, sps2) = two*xadj(imaxoffset-1&
                            &                  , j, k, 1, sps2) - xadj(imaxoffset-2, j, k, 1, sps2)
                       CALL PUSHREAL8(xadj(imaxoffset, j, k, 2, sps2))
                       xadj(imaxoffset, j, k, 2, sps2) = two*xadj(imaxoffset-1&
                            &                  , j, k, 2, sps2) - xadj(imaxoffset-2, j, k, 2, sps2)
                       CALL PUSHREAL8(xadj(imaxoffset, j, k, 3, sps2))
                       xadj(imaxoffset, j, k, 3, sps2) = two*xadj(imaxoffset-1&
                            &                  , j, k, 3, sps2) - xadj(imaxoffset-2, j, k, 3, sps2)
                       CALL PUSHINTEGER4(3)
                    ELSE
                       CALL PUSHINTEGER4(2)
                    END IF
                 ELSE
                    CALL PUSHINTEGER4(1)
                 END IF
              END DO
           END DO
           CALL PUSHINTEGER4(3)
        ELSE
           CALL PUSHINTEGER4(2)
        END IF
     ELSE
        CALL PUSHINTEGER4(1)
     END IF
  ELSE
     CALL PUSHINTEGER4(0)
  END IF
!!$!           do k=1,kl
!!$!             do j=1,jl
!!$!               x(0,j,k,1) = two*x(1,j,k,1) - x(2,j,k,1)
!!$!               x(0,j,k,2) = two*x(1,j,k,2) - x(2,j,k,2)
!!$!               x(0,j,k,3) = two*x(1,j,k,3) - x(2,j,k,3)
!!$!
!!$!               x(ie,j,k,1) = two*x(il,j,k,1) - x(nx,j,k,1)
!!$!               x(ie,j,k,2) = two*x(il,j,k,2) - x(nx,j,k,2)
!!$!               x(ie,j,k,3) = two*x(il,j,k,3) - x(nx,j,k,3)
!!$!             enddo
!!$!           enddo
  ! Extrapolation in j-direction.
  IF (jminoverlap) THEN
     IF (.NOT.jmininternal) THEN
        IF (jminoffset .GE. -3) THEN
           DO i=-3,2
              DO k=-3,2
                 iii = icell + i
                 kkk = kcell + k
                 IF (kkk .GE. 1 .AND. iii .GE. 0) THEN
                    IF (kkk .LE. kl .AND. iii .LE. ie) THEN
                       CALL PUSHREAL8(xadj(i, jminoffset, k, 1, sps2))
                       xadj(i, jminoffset, k, 1, sps2) = two*xadj(i, jminoffset&
                            &                  +1, k, 1, sps2) - xadj(i, jminoffset+2, k, 1, sps2)
                       CALL PUSHREAL8(xadj(i, jminoffset, k, 2, sps2))
                       xadj(i, jminoffset, k, 2, sps2) = two*xadj(i, jminoffset&
                            &                  +1, k, 2, sps2) - xadj(i, jminoffset+2, k, 2, sps2)
                       CALL PUSHREAL8(xadj(i, jminoffset, k, 3, sps2))
                       xadj(i, jminoffset, k, 3, sps2) = two*xadj(i, jminoffset&
                            &                  +1, k, 3, sps2) - xadj(i, jminoffset+2, k, 3, sps2)
                       CALL PUSHINTEGER4(3)
                    ELSE
                       CALL PUSHINTEGER4(2)
                    END IF
                 ELSE
                    CALL PUSHINTEGER4(1)
                 END IF
              END DO
           END DO
           CALL PUSHINTEGER4(3)
        ELSE
           CALL PUSHINTEGER4(2)
        END IF
     ELSE
        CALL PUSHINTEGER4(1)
     END IF
  ELSE
     CALL PUSHINTEGER4(0)
  END IF
  IF (jmaxoverlap) THEN
     IF (.NOT.jmaxinternal) THEN
        IF (jmaxoffset .LE. 2) THEN
           DO k=-3,2
              DO i=-3,2
                 iii = icell + i
                 kkk = kcell + k
                 IF (kkk .GE. 1 .AND. iii .GE. 0) THEN
                    IF (kkk .LE. kl .AND. iii .LE. ie) THEN
                       CALL PUSHREAL8(xadj(i, jmaxoffset, k, 1, sps2))
                       xadj(i, jmaxoffset, k, 1, sps2) = two*xadj(i, jmaxoffset&
                            &                  -1, k, 1, sps2) - xadj(i, jmaxoffset-2, k, 1, sps2)
                       CALL PUSHREAL8(xadj(i, jmaxoffset, k, 2, sps2))
                       xadj(i, jmaxoffset, k, 2, sps2) = two*xadj(i, jmaxoffset&
                            &                  -1, k, 2, sps2) - xadj(i, jmaxoffset-2, k, 2, sps2)
                       CALL PUSHREAL8(xadj(i, jmaxoffset, k, 3, sps2))
                       xadj(i, jmaxoffset, k, 3, sps2) = two*xadj(i, jmaxoffset&
                            &                  -1, k, 3, sps2) - xadj(i, jmaxoffset-2, k, 3, sps2)
                       CALL PUSHINTEGER4(3)
                    ELSE
                       CALL PUSHINTEGER4(2)
                    END IF
                 ELSE
                    CALL PUSHINTEGER4(1)
                 END IF
              END DO
           END DO
           CALL PUSHINTEGER4(3)
        ELSE
           CALL PUSHINTEGER4(2)
        END IF
     ELSE
        CALL PUSHINTEGER4(1)
     END IF
  ELSE
     CALL PUSHINTEGER4(0)
  END IF
  !           do k=1,kl
  !             do i=0,ie
  !               x(i,0,k,1) = two*x(i,1,k,1) - x(i,2,k,1)
  !               x(i,0,k,2) = two*x(i,1,k,2) - x(i,2,k,2)
  !               x(i,0,k,3) = two*x(i,1,k,3) - x(i,2,k,3)
  !
  !               x(i,je,k,1) = two*x(i,jl,k,1) - x(i,ny,k,1)
  !               x(i,je,k,2) = two*x(i,jl,k,2) - x(i,ny,k,2)
  !               x(i,je,k,3) = two*x(i,jl,k,3) - x(i,ny,k,3)
  !             enddo
  !           enddo
  ! Extrapolation in k-direction.
  IF (kminoverlap) THEN
     IF (.NOT.kmininternal) THEN
        !print *,'kcellmin',kcell,kminoffset
        IF (kminoffset .GE. -3) THEN
           DO j=-3,2
              DO i=-3,2
                 iii = icell + i
                 jjj = jcell + j
                 IF (jjj .GE. 0 .AND. iii .GE. 0) THEN
                    IF (jjj .LE. je .AND. iii .LE. ie) THEN
                       CALL PUSHREAL8(xadj(i, j, kminoffset, 1, sps2))
                       xadj(i, j, kminoffset, 1, sps2) = two*xadj(i, j, &
                            &                  kminoffset+1, 1, sps2) - xadj(i, j, kminoffset+2, 1, &
                            &                  sps2)
                       CALL PUSHREAL8(xadj(i, j, kminoffset, 2, sps2))
                       xadj(i, j, kminoffset, 2, sps2) = two*xadj(i, j, &
                            &                  kminoffset+1, 2, sps2) - xadj(i, j, kminoffset+2, 2, &
                            &                  sps2)
                       CALL PUSHREAL8(xadj(i, j, kminoffset, 3, sps2))
                       xadj(i, j, kminoffset, 3, sps2) = two*xadj(i, j, &
                            &                  kminoffset+1, 3, sps2) - xadj(i, j, kminoffset+2, 3, &
                            &                  sps2)
                       CALL PUSHINTEGER4(3)
                    ELSE
                       CALL PUSHINTEGER4(2)
                    END IF
                 ELSE
                    CALL PUSHINTEGER4(1)
                 END IF
              END DO
           END DO
           CALL PUSHINTEGER4(3)
        ELSE
           CALL PUSHINTEGER4(2)
        END IF
     ELSE
        CALL PUSHINTEGER4(1)
     END IF
  ELSE
     CALL PUSHINTEGER4(0)
  END IF
  IF (kmaxoverlap) THEN
     IF (.NOT.kmaxinternal) THEN
        !print *,'kcellmax',kcell,kmaxoffset
        IF (kmaxoffset .LE. 2) THEN
           DO j=-3,2
              DO i=-3,2
                 iii = icell + i
                 jjj = jcell + j
                 IF (jjj .GE. 0 .AND. iii .GE. 0) THEN
                    IF (jjj .LE. je .AND. iii .LE. ie) THEN
                       CALL PUSHREAL8(xadj(i, j, kmaxoffset, 1, sps2))
                       xadj(i, j, kmaxoffset, 1, sps2) = two*xadj(i, j, &
                            &                  kmaxoffset-1, 1, sps2) - xadj(i, j, kmaxoffset-2, 1, &
                            &                  sps2)
                       CALL PUSHREAL8(xadj(i, j, kmaxoffset, 2, sps2))
                       xadj(i, j, kmaxoffset, 2, sps2) = two*xadj(i, j, &
                            &                  kmaxoffset-1, 2, sps2) - xadj(i, j, kmaxoffset-2, 2, &
                            &                  sps2)
                       CALL PUSHREAL8(xadj(i, j, kmaxoffset, 3, sps2))
                       xadj(i, j, kmaxoffset, 3, sps2) = two*xadj(i, j, &
                            &                  kmaxoffset-1, 3, sps2) - xadj(i, j, kmaxoffset-2, 3, &
                            &                  sps2)
                       CALL PUSHINTEGER4(3)
                    ELSE
                       CALL PUSHINTEGER4(2)
                    END IF
                 ELSE
                    CALL PUSHINTEGER4(1)
                 END IF
              END DO
           END DO
           CALL PUSHINTEGER4(3)
        ELSE
           CALL PUSHINTEGER4(2)
        END IF
     ELSE
        CALL PUSHINTEGER4(1)
     END IF
  ELSE
     CALL PUSHINTEGER4(0)
  END IF
  !           do j=0,je
  !             do i=0,ie
  !               x(i,j,0,1) = two*x(i,j,1,1) - x(i,j,2,1)
  !               x(i,j,0,2) = two*x(i,j,1,2) - x(i,j,2,2)
  !               x(i,j,0,3) = two*x(i,j,1,3) - x(i,j,2,3)!!
  !
  !               x(i,j,ke,1) = two*x(i,j,kl,1) - x(i,j,nz,1)
  !               x(i,j,ke,2) = two*x(i,j,kl,2) - x(i,j,nz,2)
  !               x(i,j,ke,3) = two*x(i,j,kl,3) - x(i,j,nz,3)
  !             enddo
  !           enddo
  !
  !          **************************************************************
  !          *                                                            *
  !          * Mirror the halo coordinates adjacent to the symmetry       *
  !          * planes                                                     *
  !          *                                                            *
  !          **************************************************************
  !
  ! Loop over boundary subfaces.
  loopbocos:DO mm=1,nbocos
     !write(unitxAD,*)'loopBocos',mm,nbocos
     ! The actual correction of the coordinates only takes
     ! place for symmetry planes.
     IF (bctype(mm) .EQ. symm) THEN
        !write(unitxAD,*)'testSymmetry',bcfaceID(mm)
!!$               ! Set some variables, depending on the block face on
!!$               ! which the subface is located.
!!$
!!$               select case (BCFaceID(mm))
!!$                 case (iMin)
!!$                   iBeg = jnBeg(mm); iEnd = jnEnd(mm); iiMax = jl
!!$                   jBeg = knBeg(mm); jEnd = knEnd(mm); jjMax = kl
!!$                   x0 => x(0,:,:,:); x1 => x(1,:,:,:); x2 => x(2,:,:,:)
!!$
!!$                 case (iMax)
!!$                   iBeg = jnBeg(mm); iEnd = jnEnd(mm); iiMax = jl
!!$                   jBeg = knBeg(mm); jEnd = knEnd(mm); jjMax = kl
!!$                   x0 => x(ie,:,:,:); x1 => x(il,:,:,:); x2 => x(nx,:,:,:)
!!$
!!$                 case (jMin)
!!$                   iBeg = inBeg(mm); iEnd = inEnd(mm); iiMax = il
!!$                   jBeg = knBeg(mm); jEnd = knEnd(mm); jjMax = kl
!!$                   x0 => x(:,0,:,:); x1 => x(:,1,:,:); x2 => x(:,2,:,:)
!!$
!!$                 case (jMax)
!!$                   iBeg = inBeg(mm); iEnd = inEnd(mm); iiMax = il
!!$                   jBeg = knBeg(mm); jEnd = knEnd(mm); jjMax = kl
!!$                   x0 => x(:,je,:,:); x1 => x(:,jl,:,:); x2 => x(:,ny,:,:)
!!$
!!$                 case (kMin)
!!$                   iBeg = inBeg(mm); iEnd = inEnd(mm); iiMax = il
!!$                   jBeg = jnBeg(mm); jEnd = jnEnd(mm); jjMax = jl
!!$                   x0 => x(:,:,0,:); x1 => x(:,:,1,:); x2 => x(:,:,2,:)
!!$
!!$                 case (kMax)
!!$                   iBeg = inBeg(mm); iEnd = inEnd(mm); iiMax = il
!!$                   jBeg = jnBeg(mm); jEnd = jnEnd(mm); jjMax = jl
!!$                   x0 => x(:,:,ke,:); x1 => x(:,:,kl,:); x2 => x(:,:,nz,:)
!!$               end select
        ! Set some variables, depending on the block face on
        ! which the subface is located.
        istart = -3
        iend = 2
        jstart = -3
        jend = 2
        SELECT CASE  (bcfaceid(mm)) 
        CASE (imin) 
           IF (-3 .LT. 2 - jcell - 2) THEN
              istart = 2 - jcell - 2
              CALL PUSHINTEGER4(1)
           ELSE
              istart = -3
              CALL PUSHINTEGER4(0)
           END IF
           IF (-3 .LT. 2 - kcell - 2) THEN
              jstart = 2 - kcell - 2
              CALL PUSHINTEGER4(1)
           ELSE
              jstart = -3
              CALL PUSHINTEGER4(0)
           END IF
           IF (2 .GT. jl - jcell + 1) THEN
              iend = jl - jcell + 1
              CALL PUSHINTEGER4(1)
           ELSE
              iend = 2
              CALL PUSHINTEGER4(0)
           END IF
           IF (2 .GT. kl - kcell + 1) THEN
              jend = kl - kcell + 1
              CALL PUSHINTEGER4(1)
           ELSE
              jend = 2
              CALL PUSHINTEGER4(0)
           END IF
           !print *,'bcfaceID,imin',BCFaceID(mm),imin,iMinOverlap,icell,jcell,kcell
           IF (iminoverlap) THEN
              xfacecorner(:, :, :) = xblockcorneradj(1, :, :, :, sps2)
              IF (icell .EQ. 2) THEN
                 x0(-3:2, -3:2, 1:3) = xadj(-2, -3:2, -3:2, 1:3, sps2)
                 x1(-3:2, -3:2, 1:3) = xadj(-1, -3:2, -3:2, 1:3, sps2)
                 x2(-3:2, -3:2, 1:3) = xadj(0, -3:2, -3:2, 1:3, sps2)
                 CALL PUSHINTEGER4(1)
              ELSE
                 x0(-3:2, -3:2, 1:3) = xadj(-3, -3:2, -3:2, 1:3, sps2)
                 x1(-3:2, -3:2, 1:3) = xadj(-2, -3:2, -3:2, 1:3, sps2)
                 x2(-3:2, -3:2, 1:3) = xadj(-1, -3:2, -3:2, 1:3, sps2)
                 CALL PUSHINTEGER4(2)
              END IF
           ELSE
              CALL PUSHINTEGER4(5)
              GOTO 100
           END IF
        CASE (imax) 
           !skip remainder of loop
           !print *,'cycling imin'
           !write(unitxAD,*)'cycling imin'
           IF (-3 .LT. 2 - jcell - 2) THEN
              istart = 2 - jcell - 2
              CALL PUSHINTEGER4(1)
           ELSE
              istart = -3
              CALL PUSHINTEGER4(0)
           END IF
           IF (-3 .LT. 2 - kcell - 2) THEN
              jstart = 2 - kcell - 2
              CALL PUSHINTEGER4(1)
           ELSE
              jstart = -3
              CALL PUSHINTEGER4(0)
           END IF
           IF (2 .GT. jl - jcell + 1) THEN
              iend = jl - jcell + 1
              CALL PUSHINTEGER4(1)
           ELSE
              iend = 2
              CALL PUSHINTEGER4(0)
           END IF
           IF (2 .GT. kl - kcell + 1) THEN
              jend = kl - kcell + 1
              CALL PUSHINTEGER4(1)
           ELSE
              jend = 2
              CALL PUSHINTEGER4(0)
           END IF
           !print *,'bcfaceID,imax',BCFaceID(mm),imax,iMaxOverlap,icell,jcell,kcell
           IF (imaxoverlap) THEN
              xfacecorner(:, :, :) = xblockcorneradj(2, :, :, :, sps2)
              IF (icell .EQ. il) THEN
                 x0(-3:2, -3:2, 1:3) = xadj(1, -3:2, -3:2, 1:3, sps2)
                 x1(-3:2, -3:2, 1:3) = xadj(0, -3:2, -3:2, 1:3, sps2)
                 x2(-3:2, -3:2, 1:3) = xadj(-1, -3:2, -3:2, 1:3, sps2)
                 CALL PUSHINTEGER4(3)
              ELSE
                 x0(-3:2, -3:2, 1:3) = xadj(2, -3:2, -3:2, 1:3, sps2)
                 x1(-3:2, -3:2, 1:3) = xadj(1, -3:2, -3:2, 1:3, sps2)
                 x2(-3:2, -3:2, 1:3) = xadj(0, -3:2, -3:2, 1:3, sps2)
                 CALL PUSHINTEGER4(4)
              END IF
           ELSE
              CALL PUSHINTEGER4(6)
              GOTO 100
           END IF
        CASE (jmin) 
           !skip remainder of loop
           !print *,'cycling imax'
           !write(unitxAD,*)'cycling imax'
           IF (-3 .LT. 2 - icell - 2) THEN
              istart = 2 - icell - 2
              CALL PUSHINTEGER4(1)
           ELSE
              istart = -3
              CALL PUSHINTEGER4(0)
           END IF
           IF (-3 .LT. 2 - kcell - 2) THEN
              jstart = 2 - kcell - 2
              CALL PUSHINTEGER4(1)
           ELSE
              jstart = -3
              CALL PUSHINTEGER4(0)
           END IF
           IF (2 .GT. il - icell + 1) THEN
              iend = il - icell + 1
              CALL PUSHINTEGER4(1)
           ELSE
              iend = 2
              CALL PUSHINTEGER4(0)
           END IF
           IF (2 .GT. kl - kcell + 1) THEN
              jend = kl - kcell + 1
              CALL PUSHINTEGER4(1)
           ELSE
              jend = 2
              CALL PUSHINTEGER4(0)
           END IF
           !print *,'bcfaceID,jmin',BCFaceID(mm),jmin,jMinOverlap,icell,jcell,kcell 
           IF (jminoverlap) THEN
              xfacecorner(:, :, :) = xblockcorneradj(:, 1, :, :, sps2)
              IF (jcell .EQ. 2) THEN
                 x0(-3:2, -3:2, 1:3) = xadj(-3:2, -2, -3:2, 1:3, sps2)
                 x1(-3:2, -3:2, 1:3) = xadj(-3:2, -1, -3:2, 1:3, sps2)
                 x2(-3:2, -3:2, 1:3) = xadj(-3:2, 0, -3:2, 1:3, sps2)
                 CALL PUSHINTEGER4(5)
              ELSE
                 x0(-3:2, -3:2, 1:3) = xadj(-3:2, -3, -3:2, 1:3, sps2)
                 x1(-3:2, -3:2, 1:3) = xadj(-3:2, -2, -3:2, 1:3, sps2)
                 x2(-3:2, -3:2, 1:3) = xadj(-3:2, -1, -3:2, 1:3, sps2)
                 CALL PUSHINTEGER4(6)
              END IF
           ELSE
              CALL PUSHINTEGER4(7)
              GOTO 100
           END IF
        CASE (jmax) 
           !skip remainder of loop
           !print *,'cycling jmin'
           !write(unitxAD,*)'cycling jmin'
           IF (-3 .LT. 2 - icell - 2) THEN
              istart = 2 - icell - 2
              CALL PUSHINTEGER4(1)
           ELSE
              istart = -3
              CALL PUSHINTEGER4(0)
           END IF
           IF (-3 .LT. 2 - kcell - 2) THEN
              jstart = 2 - kcell - 2
              CALL PUSHINTEGER4(1)
           ELSE
              jstart = -3
              CALL PUSHINTEGER4(0)
           END IF
           IF (2 .GT. il - icell + 1) THEN
              iend = il - icell + 1
              CALL PUSHINTEGER4(1)
           ELSE
              iend = 2
              CALL PUSHINTEGER4(0)
           END IF
           IF (2 .GT. kl - kcell + 1) THEN
              jend = kl - kcell + 1
              CALL PUSHINTEGER4(1)
           ELSE
              jend = 2
              CALL PUSHINTEGER4(0)
           END IF
           !print *,'bcfaceID,jmax',BCFaceID(mm),jmax,jMaxOverlap,icell,jcell,kcell
           IF (jmaxoverlap) THEN
              xfacecorner(:, :, :) = xblockcorneradj(:, 2, :, :, sps2)
              IF (jcell .EQ. jl) THEN
                 x0(-3:2, -3:2, 1:3) = xadj(-3:2, 1, -3:2, 1:3, sps2)
                 x1(-3:2, -3:2, 1:3) = xadj(-3:2, 0, -3:2, 1:3, sps2)
                 x2(-3:2, -3:2, 1:3) = xadj(-3:2, -1, -3:2, 1:3, sps2)
                 CALL PUSHINTEGER4(7)
              ELSE
                 x0(-3:2, -3:2, 1:3) = xadj(-3:2, 2, -3:2, 1:3, sps2)
                 x1(-3:2, -3:2, 1:3) = xadj(-3:2, 1, -3:2, 1:3, sps2)
                 x2(-3:2, -3:2, 1:3) = xadj(-3:2, 0, -3:2, 1:3, sps2)
                 CALL PUSHINTEGER4(8)
              END IF
           ELSE
              CALL PUSHINTEGER4(8)
              GOTO 100
           END IF
        CASE (kmin) 
           !skip remainder of loop
           !print *,'cycling jmax'
           !write(unitxAD,*)'cycling jmax'
           IF (-3 .LT. 2 - icell - 2) THEN
              istart = 2 - icell - 2
              CALL PUSHINTEGER4(1)
           ELSE
              istart = -3
              CALL PUSHINTEGER4(0)
           END IF
           IF (-3 .LT. 2 - jcell - 2) THEN
              jstart = 2 - jcell - 2
              CALL PUSHINTEGER4(1)
           ELSE
              jstart = -3
              CALL PUSHINTEGER4(0)
           END IF
           IF (2 .GT. il - icell + 1) THEN
              iend = il - icell + 1
              CALL PUSHINTEGER4(1)
           ELSE
              iend = 2
              CALL PUSHINTEGER4(0)
           END IF
           IF (2 .GT. jl - jcell + 1) THEN
              jend = jl - jcell + 1
              CALL PUSHINTEGER4(1)
           ELSE
              jend = 2
              CALL PUSHINTEGER4(0)
           END IF
           !print *,'bcfaceID,kmin',BCFaceID(mm),kmin,kMinOverlap,icell,jcell,kcell 
           IF (kminoverlap) THEN
              xfacecorner(:, :, :) = xblockcorneradj(:, :, 1, :, sps2)
              IF (kcell .EQ. 2) THEN
                 x0(-3:2, -3:2, 1:3) = xadj(-3:2, -3:2, -2, 1:3, sps2)
                 x1(-3:2, -3:2, 1:3) = xadj(-3:2, -3:2, -1, 1:3, sps2)
                 x2(-3:2, -3:2, 1:3) = xadj(-3:2, -3:2, 0, 1:3, sps2)
                 CALL PUSHINTEGER4(9)
              ELSE
                 x0(-3:2, -3:2, 1:3) = xadj(-3:2, -3:2, -3, 1:3, sps2)
                 x1(-3:2, -3:2, 1:3) = xadj(-3:2, -3:2, -2, 1:3, sps2)
                 x2(-3:2, -3:2, 1:3) = xadj(-3:2, -3:2, -1, 1:3, sps2)
                 CALL PUSHINTEGER4(10)
              END IF
           ELSE
              CALL PUSHINTEGER4(9)
              GOTO 100
           END IF
        CASE (kmax) 
           !skip remainder of loop
           !print *,'cycling kmin'
           !write(unitxAD,*)'cycling kmin'
           IF (-3 .LT. 2 - icell - 2) THEN
              istart = 2 - icell - 2
              CALL PUSHINTEGER4(1)
           ELSE
              istart = -3
              CALL PUSHINTEGER4(0)
           END IF
           IF (-3 .LT. 2 - jcell - 2) THEN
              jstart = 2 - jcell - 2
              CALL PUSHINTEGER4(1)
           ELSE
              jstart = -3
              CALL PUSHINTEGER4(0)
           END IF
           IF (2 .GT. il - icell + 1) THEN
              iend = il - icell + 1
              CALL PUSHINTEGER4(1)
           ELSE
              iend = 2
              CALL PUSHINTEGER4(0)
           END IF
           IF (2 .GT. jl - jcell + 1) THEN
              jend = jl - jcell + 1
              CALL PUSHINTEGER4(1)
           ELSE
              jend = 2
              CALL PUSHINTEGER4(0)
           END IF
           !print *,'bcfaceID,kmax',BCFaceID(mm),kmax,kMaxOverlap,icell,jcell,kcell 
           IF (kmaxoverlap) THEN
              xfacecorner(:, :, :) = xblockcorneradj(:, :, 2, :, sps2)
              IF (kcell .EQ. kl) THEN
                 x0(-3:2, -3:2, 1:3) = xadj(-3:2, -3:2, 1, 1:3, sps2)
                 x1(-3:2, -3:2, 1:3) = xadj(-3:2, -3:2, 0, 1:3, sps2)
                 x2(-3:2, -3:2, 1:3) = xadj(-3:2, -3:2, -1, 1:3, sps2)
                 CALL PUSHINTEGER4(11)
              ELSE
                 x0(-3:2, -3:2, 1:3) = xadj(-3:2, -3:2, 2, 1:3, sps2)
                 x1(-3:2, -3:2, 1:3) = xadj(-3:2, -3:2, 1, 1:3, sps2)
                 x2(-3:2, -3:2, 1:3) = xadj(-3:2, -3:2, 0, 1:3, sps2)
                 CALL PUSHINTEGER4(12)
              END IF
           ELSE
              CALL PUSHINTEGER4(10)
              GOTO 100
           END IF
        CASE DEFAULT
           CALL PUSHINTEGER4(0)
        END SELECT
        CALL PUSHREAL8(v1(1))
        !skip remainder of loop
        !print *,'cycling kmax'
        !write(unitxAD,*)'cycling kmax'
!!$               write(unitxAD,*) 'kl',kcell,kl,BCFaceID(mm)
!!$               !print out xAdj
!!$               do j=jstart,jend!jBeg,jEnd
!!$                  do i=istart,iend!iBeg,iEnd
!!$                     do n = 1,3
!!$                        ii = itemp+i
!!$                        jj = jtemp+j
!!$                        
        !                           write(unitxAD,10) i,j,k,n,nnn,v1(1),v1(2),v1(3)
        !10                         format(1x,'res',5I8,3f20.14)
!!$                        write(unitxAD,10) ii,jj,n,itemp,jtemp,x0(i,j,n),x1(i,j,n),x2(i,j,n)!,dot*norm(n)
!!$10                      format(1x,'res',5I8,3f20.14)
!!$                     enddo
!!$                  enddo
!!$               enddo
        !CAM commented out on Aug. 11, 2009 by C.A.Mader. Computation modified to fit 
        !CAM into a single residual stencil...
!!$
!!$               ! Determine the sum of all face normals and store this
!!$               ! in norm. The sum of all faces is taken instead of the
!!$               ! cross product of the diagonals, because for some c-type
!!$               ! grids the diagonals of the subface are aligned.
!!$
!!$               norm = zero
!!$
!!$               do j=(jBeg+1),jEnd
!!$                 do i=(iBeg+1),iEnd
!!$
!!$                   ! Determine the vector from the lower left corner to
!!$                   ! the upper right corner. Due to the usage of pointers
!!$                   ! an offset of +1 must be used, because the original
!!$                   ! array x start at 0.
!!$
!!$                   v1(1) = x1(i+1,j+1,1) - x1(i,j,1)
!!$                   v1(2) = x1(i+1,j+1,2) - x1(i,j,2)
!!$                   v1(3) = x1(i+1,j+1,3) - x1(i,j,3)
!!$                   
!!$                   ! And the vector from the upper left corner to the
!!$                   ! lower right corner.
!!$
!!$                   v2(1) = x1(i+1,j,1) - x1(i,j+1,1)
!!$                   v2(2) = x1(i+1,j,2) - x1(i,j+1,2)
!!$                   v2(3) = x1(i+1,j,3) - x1(i,j+1,3)
!!$                   
!!$                   ! Determine the normal of the face by taking the cross
!!$                   ! product of v1 and v2 and add it to norm.
!!$
!!$                   norm(1) = norm(1) + v1(2)*v2(3) - v1(3)*v2(2)
!!$                   norm(2) = norm(2) + v1(3)*v2(1) - v1(1)*v2(3)
!!$                   norm(3) = norm(3) + v1(1)*v2(2) - v1(2)*v2(1)
!!$                   print *,'norm', x1(i+1,j+1,1) ,x1(i,j,1) ,norm(1),norm(2),norm(3),i,j,BCFaceID(mm)
!!$                 enddo
!!$               enddo
!!$
!!$               ! Compute the length of the normal and test if this is
!!$               ! larger than eps. If this is the case this means that
!!$               ! it is a nonsingular subface and the coordinates are
!!$               ! corrected.
!!$
!!$               length = sqrt(norm(1)**2 + norm(2)**2 + norm(3)**2)
!!$
!!$               testSingular: if(length > eps) then
!!$
!!$                 ! Compute the unit normal of the subface.
!!$
!!$                 norm(1) = norm(1)/length
!!$                 norm(2) = norm(2)/length
!!$                 norm(3) = norm(3)/length
!!$
!!$                 ! Add an overlap to the symmetry subface if the
!!$                 ! boundaries coincide with the block boundaries.
!!$                 ! This way the indirect halo's are treated properly.
!!$
!!$                 if(iBeg == 1)     iBeg = 0
!!$                 if(iEnd == iiMax) iEnd = iiMax + 1
!!$
!!$                 if(jBeg == 1)     jBeg = 0
!!$                 if(jEnd == jjMax) jEnd = jjMax + 1
!!$
!!$                 ! Loop over the nodes of the subface and set the
!!$                 ! corresponding halo coordinates.
!!$
!!$                 do j=jBeg,jEnd
!!$                   do i=iBeg,iEnd
!!$
!!$                     ! Determine the vector from the internal node to the
!!$                     ! node on the face. Again an offset of +1 must be
!!$                     ! used, due to the usage of pointers.
!!$
!!$                     v1(1) = x1(i+1,j+1,1) - x2(i+1,j+1,1)
!!$                     v1(2) = x1(i+1,j+1,2) - x2(i+1,j+1,2)
!!$                     v1(3) = x1(i+1,j+1,3) - x2(i+1,j+1,3)
!!$
!!$                     ! Determine two times the normal component of this
!!$                     ! vector; this vector must be added to the
!!$                     ! coordinates of the internal node to obtain the
!!$                     ! halo coordinates. Again the offset of +1.
!!$
!!$                     dot = two*(v1(1)*norm(1) + v1(2)*norm(2) &
!!$                         +      v1(3)*norm(3))
!!$
!!$                     x0(i+1,j+1,1) = x2(i+1,j+1,1) + dot*norm(1)
!!$                     x0(i+1,j+1,2) = x2(i+1,j+1,2) + dot*norm(2)
!!$                     x0(i+1,j+1,3) = x2(i+1,j+1,3) + dot*norm(3)
!!$                     print *,'xhalo', x0(i+1,j+1,1) ,x2(i+1,j+1,1) , dot,norm(1),i,j,BCFaceID(mm)
!!$
!!$                   enddo
!!$                 enddo
!!$
!!$                endif testSingular
        !compute a norm from the 4 corners of the subface. This
        ! will serve to check the subface for singularity and
        !reduce the number of points to be dealt with in the derivatives
        ! Determine the vector from the lower left corner to
        ! the upper right corner. Due to the usage of pointers
        ! an offset of +1 must be used, because the original
        ! array x start at 0.
        v1(1) = xfacecorner(2, 2, 1) - xfacecorner(1, 1, 1)
        CALL PUSHREAL8(v1(2))
        v1(2) = xfacecorner(2, 2, 2) - xfacecorner(1, 1, 2)
        CALL PUSHREAL8(v1(3))
        v1(3) = xfacecorner(2, 2, 3) - xfacecorner(1, 1, 3)
        CALL PUSHREAL8(v2(1))
        !print *,'v1adj',v1,xFaceCorner(2,2,1), xFaceCorner(1,1,1)
        ! And the vector from the upper left corner to the
        ! lower right corner.
        v2(1) = xfacecorner(2, 1, 1) - xfacecorner(1, 2, 1)
        CALL PUSHREAL8(v2(2))
        v2(2) = xfacecorner(2, 1, 2) - xfacecorner(1, 2, 2)
        CALL PUSHREAL8(v2(3))
        v2(3) = xfacecorner(2, 1, 3) - xfacecorner(1, 2, 3)
        CALL PUSHREAL8(norm(1))
        !               print *,'v2adj',v2    
        ! Determine the normal of the face by taking the cross
        ! product of v1 and v2 and add it to norm.
        norm(1) = v1(2)*v2(3) - v1(3)*v2(2)
        CALL PUSHREAL8(norm(2))
        norm(2) = v1(3)*v2(1) - v1(1)*v2(3)
        CALL PUSHREAL8(norm(3))
        norm(3) = v1(1)*v2(2) - v1(2)*v2(1)
        CALL PUSHREAL8(length)
        !print *,'normadj',norm
        ! Compute the length of the normal and test if this is
        ! larger than eps. If this is the case this means that
        ! it is a nonsingular subface and the coordinates are
        ! corrected.
        length = SQRT(norm(1)**2 + norm(2)**2 + norm(3)**2)
        IF (length .GT. eps) THEN
           CALL PUSHREAL8(norm(1))
           ! Compute the unit normal of the subface.
           norm(1) = norm(1)/length
           CALL PUSHREAL8(norm(2))
           norm(2) = norm(2)/length
           CALL PUSHREAL8(norm(3))
           norm(3) = norm(3)/length
           ad_from = jstart
!!$                  ! Add an overlap to the symmetry subface if the
!!$                  ! boundaries coincide with the block boundaries.
!!$                  ! This way the indirect halo's are treated properly.
!!$                  
!!$                  if(iBeg == 1)     iBeg = 0
!!$                  if(iEnd == iiMax) iEnd = iiMax + 1
!!$                  
!!$                  if(jBeg == 1)     jBeg = 0
!!$                  if(jEnd == jjMax) jEnd = jjMax + 1
           ! Loop over the nodes of the subface and set the
           ! corresponding halo coordinates.
           !jBeg,jEnd
           DO j=ad_from,jend
              ad_from0 = istart
              !iBeg,iEnd
              DO i=ad_from0,iend
                 CALL PUSHREAL8(v1(1))
                 ! Determine the vector from the internal node to the
                 ! node on the face. Again an offset of +1 must be
                 ! used, due to the usage of pointers.
!!$                        v1(1) = x1(i+1,j+1,1) - x2(i+1,j+1,1)
!!$                        v1(2) = x1(i+1,j+1,2) - x2(i+1,j+1,2)
!!$                        v1(3) = x1(i+1,j+1,3) - x2(i+1,j+1,3)
                 v1(1) = x1(i, j, 1) - x2(i, j, 1)
                 CALL PUSHREAL8(v1(2))
                 v1(2) = x1(i, j, 2) - x2(i, j, 2)
                 CALL PUSHREAL8(v1(3))
                 v1(3) = x1(i, j, 3) - x2(i, j, 3)
                 CALL PUSHREAL8(dot)
                 ! Determine two times the normal component of this
                 ! vector; this vector must be added to the
                 ! coordinates of the internal node to obtain the
                 ! halo coordinates. Again the offset of +1.
                 dot = two*(v1(1)*norm(1)+v1(2)*norm(2)+v1(3)*norm(3))
                 !x0(i+1,j+1,1) = x2(i+1,j+1,1) + dot*norm(1)
                 !x0(i+1,j+1,2) = x2(i+1,j+1,2) + dot*norm(2)
                 !x0(i+1,j+1,3) = x2(i+1,j+1,3) + dot*norm(3)
                 x0(i, j, 1) = x2(i, j, 1) + dot*norm(1)
                 x0(i, j, 2) = x2(i, j, 2) + dot*norm(2)
                 x0(i, j, 3) = x2(i, j, 3) + dot*norm(3)
              END DO
              CALL PUSHINTEGER4(i - 1)
              CALL PUSHINTEGER4(ad_from0)
           END DO
           CALL PUSHINTEGER4(j - 1)
           CALL PUSHINTEGER4(ad_from)
           CALL PUSHINTEGER4(1)
        ELSE
           CALL PUSHINTEGER4(0)
        END IF
        !print out xAdj
!!$               istart2 = -3
!!$               jstart2 = -3
!!$               kstart2 = -3
!!$               iend2 = 2
!!$               jend2 = 2
!!$               kend2 = 2
!!$               if(icell==2) istart2=-2
!!$               if(jcell==2) jstart2=-2
!!$               if(kcell==2) kstart2=-2
!!$               if(icell==il) iend2=1
!!$               if(jcell==jl) jend2=1
!!$               if(kcell==kl) kend2=1
        !do iiii = istart2,iend2
        !do jjjj = jstart2,jend2
        !     do kkkk = kstart2,kend2
!!$                        do n = 1,3
!!$                           ii = itemp+i
!!$                           jj = jtemp+j
!!$                           
        !                           write(unitxAD,10) i,j,k,n,nnn,v1(1),v1(2),v1(3)
        !10                         format(1x,'res',5I8,3f20.14)
!!$                           write(unitxAD,10) ii,jj,n,itemp,jtemp,x0(i,j,n),x2(i,j,n)!,dot*norm(n)
!!$10                         format(1x,'res',5I8,2f20.14)
!!$                        enddo
        !
!!$                     enddo
!!$                  enddo
!!$               enddo
        !print *,'xhaloAdj', x0(i,j,1) ,x2(i,j,1) , dot,norm(1),icell+i,jcell+j,BCFaceID(mm)
        ! Reset modified xAdj, depending on the block face on
        ! which the subface is located.
        SELECT CASE  (bcfaceid(mm)) 
        CASE (imin) 
           IF (iminoverlap) THEN
              IF (icell .EQ. 2) THEN
                 CALL PUSHREAL8ARRAY(xadj(-2, :, :, :, sps2), 6**2*3)
                 xadj(-2, -3:2, -3:2, 1:3, sps2) = x0(-3:2, -3:2, 1:3)
                 CALL PUSHREAL8ARRAY(xadj(-1, :, :, :, sps2), 6**2*3)
                 xadj(-1, -3:2, -3:2, 1:3, sps2) = x1(-3:2, -3:2, 1:3)
                 CALL PUSHREAL8ARRAY(xadj(0, :, :, :, sps2), 6**2*3)
                 xadj(0, -3:2, -3:2, 1:3, sps2) = x2(-3:2, -3:2, 1:3)
                 CALL PUSHINTEGER4(13)
              ELSE
                 CALL PUSHREAL8ARRAY(xadj(-3, :, :, :, sps2), 6**2*3)
                 xadj(-3, -3:2, -3:2, 1:3, sps2) = x0(-3:2, -3:2, 1:3)
                 CALL PUSHREAL8ARRAY(xadj(-2, :, :, :, sps2), 6**2*3)
                 xadj(-2, -3:2, -3:2, 1:3, sps2) = x1(-3:2, -3:2, 1:3)
                 CALL PUSHREAL8ARRAY(xadj(-1, :, :, :, sps2), 6**2*3)
                 xadj(-1, -3:2, -3:2, 1:3, sps2) = x2(-3:2, -3:2, 1:3)
                 CALL PUSHINTEGER4(14)
              END IF
           ELSE
              CALL PUSHINTEGER4(12)
           END IF
        CASE (imax) 
           IF (imaxoverlap) THEN
              IF (icell .EQ. il) THEN
                 CALL PUSHREAL8ARRAY(xadj(1, :, :, :, sps2), 6**2*3)
                 xadj(1, -3:2, -3:2, 1:3, sps2) = x0(-3:2, -3:2, 1:3)
                 CALL PUSHREAL8ARRAY(xadj(0, :, :, :, sps2), 6**2*3)
                 xadj(0, -3:2, -3:2, 1:3, sps2) = x1(-3:2, -3:2, 1:3)
                 CALL PUSHREAL8ARRAY(xadj(-1, :, :, :, sps2), 6**2*3)
                 xadj(-1, -3:2, -3:2, 1:3, sps2) = x2(-3:2, -3:2, 1:3)
                 CALL PUSHINTEGER4(16)
              ELSE
                 CALL PUSHREAL8ARRAY(xadj(2, :, :, :, sps2), 6**2*3)
                 xadj(2, -3:2, -3:2, 1:3, sps2) = x0(-3:2, -3:2, 1:3)
                 CALL PUSHREAL8ARRAY(xadj(1, :, :, :, sps2), 6**2*3)
                 xadj(1, -3:2, -3:2, 1:3, sps2) = x1(-3:2, -3:2, 1:3)
                 CALL PUSHREAL8ARRAY(xadj(0, :, :, :, sps2), 6**2*3)
                 xadj(0, -3:2, -3:2, 1:3, sps2) = x2(-3:2, -3:2, 1:3)
                 CALL PUSHINTEGER4(17)
              END IF
           ELSE
              CALL PUSHINTEGER4(15)
           END IF
        CASE (jmin) 
           IF (jminoverlap) THEN
              IF (jcell .EQ. 2) THEN
                 CALL PUSHREAL8ARRAY(xadj(:, -2, :, :, sps2), 6**2*3)
                 xadj(-3:2, -2, -3:2, 1:3, sps2) = x0(-3:2, -3:2, 1:3)
                 CALL PUSHREAL8ARRAY(xadj(:, -1, :, :, sps2), 6**2*3)
                 xadj(-3:2, -1, -3:2, 1:3, sps2) = x1(-3:2, -3:2, 1:3)
                 CALL PUSHREAL8ARRAY(xadj(:, 0, :, :, sps2), 6**2*3)
                 xadj(-3:2, 0, -3:2, 1:3, sps2) = x2(-3:2, -3:2, 1:3)
                 CALL PUSHINTEGER4(19)
              ELSE
                 CALL PUSHREAL8ARRAY(xadj(:, -3, :, :, sps2), 6**2*3)
                 xadj(-3:2, -3, -3:2, 1:3, sps2) = x0(-3:2, -3:2, 1:3)
                 CALL PUSHREAL8ARRAY(xadj(:, -2, :, :, sps2), 6**2*3)
                 xadj(-3:2, -2, -3:2, 1:3, sps2) = x1(-3:2, -3:2, 1:3)
                 CALL PUSHREAL8ARRAY(xadj(:, -1, :, :, sps2), 6**2*3)
                 xadj(-3:2, -1, -3:2, 1:3, sps2) = x2(-3:2, -3:2, 1:3)
                 CALL PUSHINTEGER4(20)
              END IF
           ELSE
              CALL PUSHINTEGER4(18)
           END IF
        CASE (jmax) 
           IF (jmaxoverlap) THEN
              IF (jcell .EQ. jl) THEN
                 CALL PUSHREAL8ARRAY(xadj(:, 1, :, :, sps2), 6**2*3)
                 xadj(-3:2, 1, -3:2, 1:3, sps2) = x0(-3:2, -3:2, 1:3)
                 CALL PUSHREAL8ARRAY(xadj(:, 0, :, :, sps2), 6**2*3)
                 xadj(-3:2, 0, -3:2, 1:3, sps2) = x1(-3:2, -3:2, 1:3)
                 CALL PUSHREAL8ARRAY(xadj(:, -1, :, :, sps2), 6**2*3)
                 xadj(-3:2, -1, -3:2, 1:3, sps2) = x2(-3:2, -3:2, 1:3)
                 CALL PUSHINTEGER4(22)
              ELSE
                 CALL PUSHREAL8ARRAY(xadj(:, 2, :, :, sps2), 6**2*3)
                 xadj(-3:2, 2, -3:2, 1:3, sps2) = x0(-3:2, -3:2, 1:3)
                 CALL PUSHREAL8ARRAY(xadj(:, 1, :, :, sps2), 6**2*3)
                 xadj(-3:2, 1, -3:2, 1:3, sps2) = x1(-3:2, -3:2, 1:3)
                 CALL PUSHREAL8ARRAY(xadj(:, 0, :, :, sps2), 6**2*3)
                 xadj(-3:2, 0, -3:2, 1:3, sps2) = x2(-3:2, -3:2, 1:3)
                 CALL PUSHINTEGER4(23)
              END IF
           ELSE
              CALL PUSHINTEGER4(21)
           END IF
        CASE (kmin) 
           IF (kminoverlap) THEN
              IF (kcell .EQ. 2) THEN
                 CALL PUSHREAL8ARRAY(xadj(:, :, -2, :, sps2), 6**2*3)
                 xadj(-3:2, -3:2, -2, 1:3, sps2) = x0(-3:2, -3:2, 1:3)
                 CALL PUSHREAL8ARRAY(xadj(:, :, -1, :, sps2), 6**2*3)
                 xadj(-3:2, -3:2, -1, 1:3, sps2) = x1(-3:2, -3:2, 1:3)
                 CALL PUSHREAL8ARRAY(xadj(:, :, 0, :, sps2), 6**2*3)
                 xadj(-3:2, -3:2, 0, 1:3, sps2) = x2(-3:2, -3:2, 1:3)
                 CALL PUSHINTEGER4(25)
              ELSE
                 CALL PUSHREAL8ARRAY(xadj(:, :, -3, :, sps2), 6**2*3)
                 xadj(-3:2, -3:2, -3, 1:3, sps2) = x0(-3:2, -3:2, 1:3)
                 CALL PUSHREAL8ARRAY(xadj(:, :, -2, :, sps2), 6**2*3)
                 xadj(-3:2, -3:2, -2, 1:3, sps2) = x1(-3:2, -3:2, 1:3)
                 CALL PUSHREAL8ARRAY(xadj(:, :, -1, :, sps2), 6**2*3)
                 xadj(-3:2, -3:2, -1, 1:3, sps2) = x2(-3:2, -3:2, 1:3)
                 CALL PUSHINTEGER4(26)
              END IF
           ELSE
              CALL PUSHINTEGER4(24)
           END IF
        CASE (kmax) 
           IF (kmaxoverlap) THEN
              IF (kcell .EQ. kl) THEN
                 CALL PUSHREAL8ARRAY(xadj(:, :, 1, :, sps2), 6**2*3)
                 xadj(-3:2, -3:2, 1, 1:3, sps2) = x0(-3:2, -3:2, 1:3)
                 CALL PUSHREAL8ARRAY(xadj(:, :, 0, :, sps2), 6**2*3)
                 xadj(-3:2, -3:2, 0, 1:3, sps2) = x1(-3:2, -3:2, 1:3)
                 CALL PUSHREAL8ARRAY(xadj(:, :, -1, :, sps2), 6**2*3)
                 xadj(-3:2, -3:2, -1, 1:3, sps2) = x2(-3:2, -3:2, 1:3)
                 CALL PUSHINTEGER4(28)
              ELSE
                 CALL PUSHREAL8ARRAY(xadj(:, :, 2, :, sps2), 6**2*3)
                 xadj(-3:2, -3:2, 2, 1:3, sps2) = x0(-3:2, -3:2, 1:3)
                 CALL PUSHREAL8ARRAY(xadj(:, :, 1, :, sps2), 6**2*3)
                 xadj(-3:2, -3:2, 1, 1:3, sps2) = x1(-3:2, -3:2, 1:3)
                 CALL PUSHREAL8ARRAY(xadj(:, :, 0, :, sps2), 6**2*3)
                 xadj(-3:2, -3:2, 0, 1:3, sps2) = x2(-3:2, -3:2, 1:3)
                 CALL PUSHINTEGER4(29)
              END IF
           ELSE
              CALL PUSHINTEGER4(27)
           END IF
        CASE DEFAULT
           CALL PUSHINTEGER4(11)
        END SELECT
     ELSE
        CALL PUSHINTEGER4(4)
     END IF
100  CONTINUE
  END DO loopbocos
  v1b(1:3) = 0.0
  v2b(1:3) = 0.0
  xfacecornerb(1:2, 1:2, 1:3) = 0.0
  normb(1:3) = 0.0
  x0b(-3:2, -3:2, 1:3) = 0.0
  x1b(-3:2, -3:2, 1:3) = 0.0
  x2b(-3:2, -3:2, 1:3) = 0.0
  DO mm=nbocos,1,-1
     CALL POPINTEGER4(branch)
     IF (branch .LT. 17) THEN
        IF (branch .LT. 11) THEN
           IF (branch .LT. 8) THEN
              IF (branch .LT. 6) THEN
                 IF (branch .LT. 5) THEN
                    GOTO 190
                 ELSE
                    GOTO 180
                 END IF
              ELSE IF (branch .LT. 7) THEN
                 GOTO 170
              ELSE
                 GOTO 160
              END IF
           ELSE IF (branch .LT. 10) THEN
              IF (branch .LT. 9) THEN
                 GOTO 150
              ELSE
                 GOTO 140
              END IF
           ELSE
              GOTO 130
           END IF
        ELSE IF (branch .LT. 14) THEN
           IF (.NOT.branch .LT. 13) THEN
              CALL POPREAL8ARRAY(xadj(0, :, :, :, sps2), 6**2*3)
              x2b(-3:2, -3:2, 1:3) = x2b(-3:2, -3:2, 1:3) + xadjb(0, -3:2, -&
                   &            3:2, 1:3, sps2)
              xadjb(0, -3:2, -3:2, 1:3, sps2) = 0.0
              CALL POPREAL8ARRAY(xadj(-1, :, :, :, sps2), 6**2*3)
              x1b(-3:2, -3:2, 1:3) = x1b(-3:2, -3:2, 1:3) + xadjb(-1, -3:2, &
                   &            -3:2, 1:3, sps2)
              xadjb(-1, -3:2, -3:2, 1:3, sps2) = 0.0
              CALL POPREAL8ARRAY(xadj(-2, :, :, :, sps2), 6**2*3)
              x0b(-3:2, -3:2, 1:3) = x0b(-3:2, -3:2, 1:3) + xadjb(-2, -3:2, &
                   &            -3:2, 1:3, sps2)
              xadjb(-2, -3:2, -3:2, 1:3, sps2) = 0.0
           END IF
        ELSE IF (branch .LT. 16) THEN
           IF (branch .LT. 15) THEN
              CALL POPREAL8ARRAY(xadj(-1, :, :, :, sps2), 6**2*3)
              x2b(-3:2, -3:2, 1:3) = x2b(-3:2, -3:2, 1:3) + xadjb(-1, -3:2, &
                   &            -3:2, 1:3, sps2)
              xadjb(-1, -3:2, -3:2, 1:3, sps2) = 0.0
              CALL POPREAL8ARRAY(xadj(-2, :, :, :, sps2), 6**2*3)
              x1b(-3:2, -3:2, 1:3) = x1b(-3:2, -3:2, 1:3) + xadjb(-2, -3:2, &
                   &            -3:2, 1:3, sps2)
              xadjb(-2, -3:2, -3:2, 1:3, sps2) = 0.0
              CALL POPREAL8ARRAY(xadj(-3, :, :, :, sps2), 6**2*3)
              x0b(-3:2, -3:2, 1:3) = x0b(-3:2, -3:2, 1:3) + xadjb(-3, -3:2, &
                   &            -3:2, 1:3, sps2)
              xadjb(-3, -3:2, -3:2, 1:3, sps2) = 0.0
           END IF
        ELSE
           CALL POPREAL8ARRAY(xadj(-1, :, :, :, sps2), 6**2*3)
           x2b(-3:2, -3:2, 1:3) = x2b(-3:2, -3:2, 1:3) + xadjb(-1, -3:2, -3&
                &          :2, 1:3, sps2)
           xadjb(-1, -3:2, -3:2, 1:3, sps2) = 0.0
           CALL POPREAL8ARRAY(xadj(0, :, :, :, sps2), 6**2*3)
           x1b(-3:2, -3:2, 1:3) = x1b(-3:2, -3:2, 1:3) + xadjb(0, -3:2, -3:&
                &          2, 1:3, sps2)
           xadjb(0, -3:2, -3:2, 1:3, sps2) = 0.0
           CALL POPREAL8ARRAY(xadj(1, :, :, :, sps2), 6**2*3)
           x0b(-3:2, -3:2, 1:3) = x0b(-3:2, -3:2, 1:3) + xadjb(1, -3:2, -3:&
                &          2, 1:3, sps2)
           xadjb(1, -3:2, -3:2, 1:3, sps2) = 0.0
        END IF
     ELSE IF (branch .LT. 24) THEN
        IF (branch .LT. 21) THEN
           IF (branch .LT. 19) THEN
              IF (branch .LT. 18) THEN
                 CALL POPREAL8ARRAY(xadj(0, :, :, :, sps2), 6**2*3)
                 x2b(-3:2, -3:2, 1:3) = x2b(-3:2, -3:2, 1:3) + xadjb(0, -3:2&
                      &              , -3:2, 1:3, sps2)
                 xadjb(0, -3:2, -3:2, 1:3, sps2) = 0.0
                 CALL POPREAL8ARRAY(xadj(1, :, :, :, sps2), 6**2*3)
                 x1b(-3:2, -3:2, 1:3) = x1b(-3:2, -3:2, 1:3) + xadjb(1, -3:2&
                      &              , -3:2, 1:3, sps2)
                 xadjb(1, -3:2, -3:2, 1:3, sps2) = 0.0
                 CALL POPREAL8ARRAY(xadj(2, :, :, :, sps2), 6**2*3)
                 x0b(-3:2, -3:2, 1:3) = x0b(-3:2, -3:2, 1:3) + xadjb(2, -3:2&
                      &              , -3:2, 1:3, sps2)
                 xadjb(2, -3:2, -3:2, 1:3, sps2) = 0.0
              END IF
           ELSE IF (branch .LT. 20) THEN
              CALL POPREAL8ARRAY(xadj(:, 0, :, :, sps2), 6**2*3)
              x2b(-3:2, -3:2, 1:3) = x2b(-3:2, -3:2, 1:3) + xadjb(-3:2, 0, -&
                   &            3:2, 1:3, sps2)
              xadjb(-3:2, 0, -3:2, 1:3, sps2) = 0.0
              CALL POPREAL8ARRAY(xadj(:, -1, :, :, sps2), 6**2*3)
              x1b(-3:2, -3:2, 1:3) = x1b(-3:2, -3:2, 1:3) + xadjb(-3:2, -1, &
                   &            -3:2, 1:3, sps2)
              xadjb(-3:2, -1, -3:2, 1:3, sps2) = 0.0
              CALL POPREAL8ARRAY(xadj(:, -2, :, :, sps2), 6**2*3)
              x0b(-3:2, -3:2, 1:3) = x0b(-3:2, -3:2, 1:3) + xadjb(-3:2, -2, &
                   &            -3:2, 1:3, sps2)
              xadjb(-3:2, -2, -3:2, 1:3, sps2) = 0.0
           ELSE
              CALL POPREAL8ARRAY(xadj(:, -1, :, :, sps2), 6**2*3)
              x2b(-3:2, -3:2, 1:3) = x2b(-3:2, -3:2, 1:3) + xadjb(-3:2, -1, &
                   &            -3:2, 1:3, sps2)
              xadjb(-3:2, -1, -3:2, 1:3, sps2) = 0.0
              CALL POPREAL8ARRAY(xadj(:, -2, :, :, sps2), 6**2*3)
              x1b(-3:2, -3:2, 1:3) = x1b(-3:2, -3:2, 1:3) + xadjb(-3:2, -2, &
                   &            -3:2, 1:3, sps2)
              xadjb(-3:2, -2, -3:2, 1:3, sps2) = 0.0
              CALL POPREAL8ARRAY(xadj(:, -3, :, :, sps2), 6**2*3)
              x0b(-3:2, -3:2, 1:3) = x0b(-3:2, -3:2, 1:3) + xadjb(-3:2, -3, &
                   &            -3:2, 1:3, sps2)
              xadjb(-3:2, -3, -3:2, 1:3, sps2) = 0.0
           END IF
        ELSE IF (branch .LT. 23) THEN
           IF (.NOT.branch .LT. 22) THEN
              CALL POPREAL8ARRAY(xadj(:, -1, :, :, sps2), 6**2*3)
              x2b(-3:2, -3:2, 1:3) = x2b(-3:2, -3:2, 1:3) + xadjb(-3:2, -1, &
                   &            -3:2, 1:3, sps2)
              xadjb(-3:2, -1, -3:2, 1:3, sps2) = 0.0
              CALL POPREAL8ARRAY(xadj(:, 0, :, :, sps2), 6**2*3)
              x1b(-3:2, -3:2, 1:3) = x1b(-3:2, -3:2, 1:3) + xadjb(-3:2, 0, -&
                   &            3:2, 1:3, sps2)
              xadjb(-3:2, 0, -3:2, 1:3, sps2) = 0.0
              CALL POPREAL8ARRAY(xadj(:, 1, :, :, sps2), 6**2*3)
              x0b(-3:2, -3:2, 1:3) = x0b(-3:2, -3:2, 1:3) + xadjb(-3:2, 1, -&
                   &            3:2, 1:3, sps2)
              xadjb(-3:2, 1, -3:2, 1:3, sps2) = 0.0
           END IF
        ELSE
           CALL POPREAL8ARRAY(xadj(:, 0, :, :, sps2), 6**2*3)
           x2b(-3:2, -3:2, 1:3) = x2b(-3:2, -3:2, 1:3) + xadjb(-3:2, 0, -3:&
                &          2, 1:3, sps2)
           xadjb(-3:2, 0, -3:2, 1:3, sps2) = 0.0
           CALL POPREAL8ARRAY(xadj(:, 1, :, :, sps2), 6**2*3)
           x1b(-3:2, -3:2, 1:3) = x1b(-3:2, -3:2, 1:3) + xadjb(-3:2, 1, -3:&
                &          2, 1:3, sps2)
           xadjb(-3:2, 1, -3:2, 1:3, sps2) = 0.0
           CALL POPREAL8ARRAY(xadj(:, 2, :, :, sps2), 6**2*3)
           x0b(-3:2, -3:2, 1:3) = x0b(-3:2, -3:2, 1:3) + xadjb(-3:2, 2, -3:&
                &          2, 1:3, sps2)
           xadjb(-3:2, 2, -3:2, 1:3, sps2) = 0.0
        END IF
     ELSE IF (branch .LT. 27) THEN
        IF (branch .LT. 26) THEN
           IF (.NOT.branch .LT. 25) THEN
              CALL POPREAL8ARRAY(xadj(:, :, 0, :, sps2), 6**2*3)
              x2b(-3:2, -3:2, 1:3) = x2b(-3:2, -3:2, 1:3) + xadjb(-3:2, -3:2&
                   &            , 0, 1:3, sps2)
              xadjb(-3:2, -3:2, 0, 1:3, sps2) = 0.0
              CALL POPREAL8ARRAY(xadj(:, :, -1, :, sps2), 6**2*3)
              x1b(-3:2, -3:2, 1:3) = x1b(-3:2, -3:2, 1:3) + xadjb(-3:2, -3:2&
                   &            , -1, 1:3, sps2)
              xadjb(-3:2, -3:2, -1, 1:3, sps2) = 0.0
              CALL POPREAL8ARRAY(xadj(:, :, -2, :, sps2), 6**2*3)
              x0b(-3:2, -3:2, 1:3) = x0b(-3:2, -3:2, 1:3) + xadjb(-3:2, -3:2&
                   &            , -2, 1:3, sps2)
              xadjb(-3:2, -3:2, -2, 1:3, sps2) = 0.0
           END IF
        ELSE
           CALL POPREAL8ARRAY(xadj(:, :, -1, :, sps2), 6**2*3)
           x2b(-3:2, -3:2, 1:3) = x2b(-3:2, -3:2, 1:3) + xadjb(-3:2, -3:2, &
                &          -1, 1:3, sps2)
           xadjb(-3:2, -3:2, -1, 1:3, sps2) = 0.0
           CALL POPREAL8ARRAY(xadj(:, :, -2, :, sps2), 6**2*3)
           x1b(-3:2, -3:2, 1:3) = x1b(-3:2, -3:2, 1:3) + xadjb(-3:2, -3:2, &
                &          -2, 1:3, sps2)
           xadjb(-3:2, -3:2, -2, 1:3, sps2) = 0.0
           CALL POPREAL8ARRAY(xadj(:, :, -3, :, sps2), 6**2*3)
           x0b(-3:2, -3:2, 1:3) = x0b(-3:2, -3:2, 1:3) + xadjb(-3:2, -3:2, &
                &          -3, 1:3, sps2)
           xadjb(-3:2, -3:2, -3, 1:3, sps2) = 0.0
        END IF
     ELSE IF (branch .LT. 29) THEN
        IF (.NOT.branch .LT. 28) THEN
           CALL POPREAL8ARRAY(xadj(:, :, -1, :, sps2), 6**2*3)
           x2b(-3:2, -3:2, 1:3) = x2b(-3:2, -3:2, 1:3) + xadjb(-3:2, -3:2, &
                &          -1, 1:3, sps2)
           xadjb(-3:2, -3:2, -1, 1:3, sps2) = 0.0
           CALL POPREAL8ARRAY(xadj(:, :, 0, :, sps2), 6**2*3)
           x1b(-3:2, -3:2, 1:3) = x1b(-3:2, -3:2, 1:3) + xadjb(-3:2, -3:2, &
                &          0, 1:3, sps2)
           xadjb(-3:2, -3:2, 0, 1:3, sps2) = 0.0
           CALL POPREAL8ARRAY(xadj(:, :, 1, :, sps2), 6**2*3)
           x0b(-3:2, -3:2, 1:3) = x0b(-3:2, -3:2, 1:3) + xadjb(-3:2, -3:2, &
                &          1, 1:3, sps2)
           xadjb(-3:2, -3:2, 1, 1:3, sps2) = 0.0
        END IF
     ELSE
        CALL POPREAL8ARRAY(xadj(:, :, 0, :, sps2), 6**2*3)
        x2b(-3:2, -3:2, 1:3) = x2b(-3:2, -3:2, 1:3) + xadjb(-3:2, -3:2, 0&
             &        , 1:3, sps2)
        xadjb(-3:2, -3:2, 0, 1:3, sps2) = 0.0
        CALL POPREAL8ARRAY(xadj(:, :, 1, :, sps2), 6**2*3)
        x1b(-3:2, -3:2, 1:3) = x1b(-3:2, -3:2, 1:3) + xadjb(-3:2, -3:2, 1&
             &        , 1:3, sps2)
        xadjb(-3:2, -3:2, 1, 1:3, sps2) = 0.0
        CALL POPREAL8ARRAY(xadj(:, :, 2, :, sps2), 6**2*3)
        x0b(-3:2, -3:2, 1:3) = x0b(-3:2, -3:2, 1:3) + xadjb(-3:2, -3:2, 2&
             &        , 1:3, sps2)
        xadjb(-3:2, -3:2, 2, 1:3, sps2) = 0.0
     END IF
     CALL POPINTEGER4(branch)
     IF (branch .LT. 1) THEN
        lengthb = 0.0
     ELSE
        CALL POPINTEGER4(ad_from)
        CALL POPINTEGER4(ad_to)
        DO j=ad_to,ad_from,-1
           CALL POPINTEGER4(ad_from0)
           CALL POPINTEGER4(ad_to0)
           DO i=ad_to0,ad_from0,-1
              x2b(i, j, 3) = x2b(i, j, 3) + x0b(i, j, 3)
              dotb = norm(3)*x0b(i, j, 3)
              normb(3) = normb(3) + dot*x0b(i, j, 3)
              x0b(i, j, 3) = 0.0
              x2b(i, j, 2) = x2b(i, j, 2) + x0b(i, j, 2)
              dotb = dotb + norm(2)*x0b(i, j, 2)
              normb(2) = normb(2) + dot*x0b(i, j, 2)
              x0b(i, j, 2) = 0.0
              x2b(i, j, 1) = x2b(i, j, 1) + x0b(i, j, 1)
              dotb = dotb + norm(1)*x0b(i, j, 1)
              tempb0 = two*dotb
              normb(1) = normb(1) + v1(1)*tempb0 + dot*x0b(i, j, 1)
              x0b(i, j, 1) = 0.0
              CALL POPREAL8(dot)
              v1b(1) = v1b(1) + norm(1)*tempb0
              v1b(2) = v1b(2) + norm(2)*tempb0
              normb(2) = normb(2) + v1(2)*tempb0
              v1b(3) = v1b(3) + norm(3)*tempb0
              normb(3) = normb(3) + v1(3)*tempb0
              CALL POPREAL8(v1(3))
              x1b(i, j, 3) = x1b(i, j, 3) + v1b(3)
              x2b(i, j, 3) = x2b(i, j, 3) - v1b(3)
              v1b(3) = 0.0
              CALL POPREAL8(v1(2))
              x1b(i, j, 2) = x1b(i, j, 2) + v1b(2)
              x2b(i, j, 2) = x2b(i, j, 2) - v1b(2)
              v1b(2) = 0.0
              CALL POPREAL8(v1(1))
              x1b(i, j, 1) = x1b(i, j, 1) + v1b(1)
              x2b(i, j, 1) = x2b(i, j, 1) - v1b(1)
              v1b(1) = 0.0
           END DO
        END DO
        CALL POPREAL8(norm(3))
        lengthb = -(norm(3)*normb(3)/length**2)
        normb(3) = normb(3)/length
        CALL POPREAL8(norm(2))
        lengthb = lengthb - norm(2)*normb(2)/length**2
        normb(2) = normb(2)/length
        CALL POPREAL8(norm(1))
        lengthb = lengthb - norm(1)*normb(1)/length**2
        normb(1) = normb(1)/length
     END IF
     CALL POPREAL8(length)
     tempb = lengthb/(2.0*SQRT(norm(1)**2+norm(2)**2+norm(3)**2))
     normb(1) = normb(1) + 2*norm(1)*tempb
     normb(2) = normb(2) + 2*norm(2)*tempb
     normb(3) = normb(3) + 2*norm(3)*tempb
     CALL POPREAL8(norm(3))
     v1b(1) = v1b(1) + v2(2)*normb(3)
     v2b(2) = v2b(2) + v1(1)*normb(3)
     v1b(2) = v1b(2) - v2(1)*normb(3)
     v2b(1) = v2b(1) - v1(2)*normb(3)
     normb(3) = 0.0
     CALL POPREAL8(norm(2))
     v1b(3) = v1b(3) + v2(1)*normb(2)
     v2b(1) = v2b(1) + v1(3)*normb(2)
     v1b(1) = v1b(1) - v2(3)*normb(2)
     v2b(3) = v2b(3) - v1(1)*normb(2)
     normb(2) = 0.0
     CALL POPREAL8(norm(1))
     v1b(2) = v1b(2) + v2(3)*normb(1)
     v2b(3) = v2b(3) + v1(2)*normb(1)
     v1b(3) = v1b(3) - v2(2)*normb(1)
     v2b(2) = v2b(2) - v1(3)*normb(1)
     normb(1) = 0.0
     CALL POPREAL8(v2(3))
     xfacecornerb(2, 1, 3) = xfacecornerb(2, 1, 3) + v2b(3)
     xfacecornerb(1, 2, 3) = xfacecornerb(1, 2, 3) - v2b(3)
     v2b(3) = 0.0
     CALL POPREAL8(v2(2))
     xfacecornerb(2, 1, 2) = xfacecornerb(2, 1, 2) + v2b(2)
     xfacecornerb(1, 2, 2) = xfacecornerb(1, 2, 2) - v2b(2)
     v2b(2) = 0.0
     CALL POPREAL8(v2(1))
     xfacecornerb(2, 1, 1) = xfacecornerb(2, 1, 1) + v2b(1)
     xfacecornerb(1, 2, 1) = xfacecornerb(1, 2, 1) - v2b(1)
     v2b(1) = 0.0
     CALL POPREAL8(v1(3))
     xfacecornerb(2, 2, 3) = xfacecornerb(2, 2, 3) + v1b(3)
     xfacecornerb(1, 1, 3) = xfacecornerb(1, 1, 3) - v1b(3)
     v1b(3) = 0.0
     CALL POPREAL8(v1(2))
     xfacecornerb(2, 2, 2) = xfacecornerb(2, 2, 2) + v1b(2)
     xfacecornerb(1, 1, 2) = xfacecornerb(1, 1, 2) - v1b(2)
     v1b(2) = 0.0
     CALL POPREAL8(v1(1))
     xfacecornerb(2, 2, 1) = xfacecornerb(2, 2, 1) + v1b(1)
     xfacecornerb(1, 1, 1) = xfacecornerb(1, 1, 1) - v1b(1)
     v1b(1) = 0.0
     CALL POPINTEGER4(branch)
     IF (branch .LT. 7) THEN
        IF (branch .LT. 4) THEN
           IF (branch .LT. 2) THEN
              IF (branch .LT. 1) THEN
                 GOTO 190
              ELSE
                 xadjb(0, -3:2, -3:2, 1:3, sps2) = xadjb(0, -3:2, -3:2, 1:3, &
                      &              sps2) + x2b(-3:2, -3:2, 1:3)
                 x2b(-3:2, -3:2, 1:3) = 0.0
                 xadjb(-1, -3:2, -3:2, 1:3, sps2) = xadjb(-1, -3:2, -3:2, 1:3&
                      &              , sps2) + x1b(-3:2, -3:2, 1:3)
                 x1b(-3:2, -3:2, 1:3) = 0.0
                 xadjb(-2, -3:2, -3:2, 1:3, sps2) = xadjb(-2, -3:2, -3:2, 1:3&
                      &              , sps2) + x0b(-3:2, -3:2, 1:3)
                 x0b(-3:2, -3:2, 1:3) = 0.0
              END IF
           ELSE IF (branch .LT. 3) THEN
              xadjb(-1, -3:2, -3:2, 1:3, sps2) = xadjb(-1, -3:2, -3:2, 1:3, &
                   &            sps2) + x2b(-3:2, -3:2, 1:3)
              x2b(-3:2, -3:2, 1:3) = 0.0
              xadjb(-2, -3:2, -3:2, 1:3, sps2) = xadjb(-2, -3:2, -3:2, 1:3, &
                   &            sps2) + x1b(-3:2, -3:2, 1:3)
              x1b(-3:2, -3:2, 1:3) = 0.0
              xadjb(-3, -3:2, -3:2, 1:3, sps2) = xadjb(-3, -3:2, -3:2, 1:3, &
                   &            sps2) + x0b(-3:2, -3:2, 1:3)
              x0b(-3:2, -3:2, 1:3) = 0.0
           ELSE
              xadjb(-1, -3:2, -3:2, 1:3, sps2) = xadjb(-1, -3:2, -3:2, 1:3, &
                   &            sps2) + x2b(-3:2, -3:2, 1:3)
              x2b(-3:2, -3:2, 1:3) = 0.0
              xadjb(0, -3:2, -3:2, 1:3, sps2) = xadjb(0, -3:2, -3:2, 1:3, &
                   &            sps2) + x1b(-3:2, -3:2, 1:3)
              x1b(-3:2, -3:2, 1:3) = 0.0
              xadjb(1, -3:2, -3:2, 1:3, sps2) = xadjb(1, -3:2, -3:2, 1:3, &
                   &            sps2) + x0b(-3:2, -3:2, 1:3)
              x0b(-3:2, -3:2, 1:3) = 0.0
              GOTO 110
           END IF
           xblockcorneradjb(1, :, :, :, sps2) = xblockcorneradjb(1, :, :, :&
                &          , sps2) + xfacecornerb(:, :, :)
           xfacecornerb(:, :, :) = 0.0
           GOTO 180
        ELSE
           IF (branch .LT. 6) THEN
              IF (branch .LT. 5) THEN
                 xadjb(0, -3:2, -3:2, 1:3, sps2) = xadjb(0, -3:2, -3:2, 1:3, &
                      &              sps2) + x2b(-3:2, -3:2, 1:3)
                 x2b(-3:2, -3:2, 1:3) = 0.0
                 xadjb(1, -3:2, -3:2, 1:3, sps2) = xadjb(1, -3:2, -3:2, 1:3, &
                      &              sps2) + x1b(-3:2, -3:2, 1:3)
                 x1b(-3:2, -3:2, 1:3) = 0.0
                 xadjb(2, -3:2, -3:2, 1:3, sps2) = xadjb(2, -3:2, -3:2, 1:3, &
                      &              sps2) + x0b(-3:2, -3:2, 1:3)
                 x0b(-3:2, -3:2, 1:3) = 0.0
                 GOTO 110
              ELSE
                 xadjb(-3:2, 0, -3:2, 1:3, sps2) = xadjb(-3:2, 0, -3:2, 1:3, &
                      &              sps2) + x2b(-3:2, -3:2, 1:3)
                 x2b(-3:2, -3:2, 1:3) = 0.0
                 xadjb(-3:2, -1, -3:2, 1:3, sps2) = xadjb(-3:2, -1, -3:2, 1:3&
                      &              , sps2) + x1b(-3:2, -3:2, 1:3)
                 x1b(-3:2, -3:2, 1:3) = 0.0
                 xadjb(-3:2, -2, -3:2, 1:3, sps2) = xadjb(-3:2, -2, -3:2, 1:3&
                      &              , sps2) + x0b(-3:2, -3:2, 1:3)
                 x0b(-3:2, -3:2, 1:3) = 0.0
              END IF
           ELSE
              xadjb(-3:2, -1, -3:2, 1:3, sps2) = xadjb(-3:2, -1, -3:2, 1:3, &
                   &            sps2) + x2b(-3:2, -3:2, 1:3)
              x2b(-3:2, -3:2, 1:3) = 0.0
              xadjb(-3:2, -2, -3:2, 1:3, sps2) = xadjb(-3:2, -2, -3:2, 1:3, &
                   &            sps2) + x1b(-3:2, -3:2, 1:3)
              x1b(-3:2, -3:2, 1:3) = 0.0
              xadjb(-3:2, -3, -3:2, 1:3, sps2) = xadjb(-3:2, -3, -3:2, 1:3, &
                   &            sps2) + x0b(-3:2, -3:2, 1:3)
              x0b(-3:2, -3:2, 1:3) = 0.0
           END IF
           xblockcorneradjb(:, 1, :, :, sps2) = xblockcorneradjb(:, 1, :, :&
                &          , sps2) + xfacecornerb(:, :, :)
           xfacecornerb(:, :, :) = 0.0
           GOTO 160
        END IF
110     xblockcorneradjb(2, :, :, :, sps2) = xblockcorneradjb(2, :, :, :, &
             &        sps2) + xfacecornerb(:, :, :)
        xfacecornerb(:, :, :) = 0.0
        GOTO 170
     ELSE
        IF (branch .LT. 10) THEN
           IF (branch .LT. 9) THEN
              IF (branch .LT. 8) THEN
                 xadjb(-3:2, -1, -3:2, 1:3, sps2) = xadjb(-3:2, -1, -3:2, 1:3&
                      &              , sps2) + x2b(-3:2, -3:2, 1:3)
                 x2b(-3:2, -3:2, 1:3) = 0.0
                 xadjb(-3:2, 0, -3:2, 1:3, sps2) = xadjb(-3:2, 0, -3:2, 1:3, &
                      &              sps2) + x1b(-3:2, -3:2, 1:3)
                 x1b(-3:2, -3:2, 1:3) = 0.0
                 xadjb(-3:2, 1, -3:2, 1:3, sps2) = xadjb(-3:2, 1, -3:2, 1:3, &
                      &              sps2) + x0b(-3:2, -3:2, 1:3)
                 x0b(-3:2, -3:2, 1:3) = 0.0
              ELSE
                 xadjb(-3:2, 0, -3:2, 1:3, sps2) = xadjb(-3:2, 0, -3:2, 1:3, &
                      &              sps2) + x2b(-3:2, -3:2, 1:3)
                 x2b(-3:2, -3:2, 1:3) = 0.0
                 xadjb(-3:2, 1, -3:2, 1:3, sps2) = xadjb(-3:2, 1, -3:2, 1:3, &
                      &              sps2) + x1b(-3:2, -3:2, 1:3)
                 x1b(-3:2, -3:2, 1:3) = 0.0
                 xadjb(-3:2, 2, -3:2, 1:3, sps2) = xadjb(-3:2, 2, -3:2, 1:3, &
                      &              sps2) + x0b(-3:2, -3:2, 1:3)
                 x0b(-3:2, -3:2, 1:3) = 0.0
              END IF
              xblockcorneradjb(:, 2, :, :, sps2) = xblockcorneradjb(:, 2, :&
                   &            , :, sps2) + xfacecornerb(:, :, :)
              xfacecornerb(:, :, :) = 0.0
              GOTO 150
           ELSE
              xadjb(-3:2, -3:2, 0, 1:3, sps2) = xadjb(-3:2, -3:2, 0, 1:3, &
                   &            sps2) + x2b(-3:2, -3:2, 1:3)
              x2b(-3:2, -3:2, 1:3) = 0.0
              xadjb(-3:2, -3:2, -1, 1:3, sps2) = xadjb(-3:2, -3:2, -1, 1:3, &
                   &            sps2) + x1b(-3:2, -3:2, 1:3)
              x1b(-3:2, -3:2, 1:3) = 0.0
              xadjb(-3:2, -3:2, -2, 1:3, sps2) = xadjb(-3:2, -3:2, -2, 1:3, &
                   &            sps2) + x0b(-3:2, -3:2, 1:3)
              x0b(-3:2, -3:2, 1:3) = 0.0
           END IF
        ELSE
           IF (branch .LT. 12) THEN
              IF (branch .LT. 11) THEN
                 xadjb(-3:2, -3:2, -1, 1:3, sps2) = xadjb(-3:2, -3:2, -1, 1:3&
                      &              , sps2) + x2b(-3:2, -3:2, 1:3)
                 x2b(-3:2, -3:2, 1:3) = 0.0
                 xadjb(-3:2, -3:2, -2, 1:3, sps2) = xadjb(-3:2, -3:2, -2, 1:3&
                      &              , sps2) + x1b(-3:2, -3:2, 1:3)
                 x1b(-3:2, -3:2, 1:3) = 0.0
                 xadjb(-3:2, -3:2, -3, 1:3, sps2) = xadjb(-3:2, -3:2, -3, 1:3&
                      &              , sps2) + x0b(-3:2, -3:2, 1:3)
                 x0b(-3:2, -3:2, 1:3) = 0.0
                 GOTO 120
              ELSE
                 xadjb(-3:2, -3:2, -1, 1:3, sps2) = xadjb(-3:2, -3:2, -1, 1:3&
                      &              , sps2) + x2b(-3:2, -3:2, 1:3)
                 x2b(-3:2, -3:2, 1:3) = 0.0
                 xadjb(-3:2, -3:2, 0, 1:3, sps2) = xadjb(-3:2, -3:2, 0, 1:3, &
                      &              sps2) + x1b(-3:2, -3:2, 1:3)
                 x1b(-3:2, -3:2, 1:3) = 0.0
                 xadjb(-3:2, -3:2, 1, 1:3, sps2) = xadjb(-3:2, -3:2, 1, 1:3, &
                      &              sps2) + x0b(-3:2, -3:2, 1:3)
                 x0b(-3:2, -3:2, 1:3) = 0.0
              END IF
           ELSE
              xadjb(-3:2, -3:2, 0, 1:3, sps2) = xadjb(-3:2, -3:2, 0, 1:3, &
                   &            sps2) + x2b(-3:2, -3:2, 1:3)
              x2b(-3:2, -3:2, 1:3) = 0.0
              xadjb(-3:2, -3:2, 1, 1:3, sps2) = xadjb(-3:2, -3:2, 1, 1:3, &
                   &            sps2) + x1b(-3:2, -3:2, 1:3)
              x1b(-3:2, -3:2, 1:3) = 0.0
              xadjb(-3:2, -3:2, 2, 1:3, sps2) = xadjb(-3:2, -3:2, 2, 1:3, &
                   &            sps2) + x0b(-3:2, -3:2, 1:3)
              x0b(-3:2, -3:2, 1:3) = 0.0
           END IF
           xblockcorneradjb(:, :, 2, :, sps2) = xblockcorneradjb(:, :, 2, :&
                &          , sps2) + xfacecornerb(:, :, :)
           xfacecornerb(:, :, :) = 0.0
           GOTO 130
        END IF
120     xblockcorneradjb(:, :, 1, :, sps2) = xblockcorneradjb(:, :, 1, :, &
             &        sps2) + xfacecornerb(:, :, :)
        xfacecornerb(:, :, :) = 0.0
        GOTO 140
     END IF
130  CALL POPINTEGER4(branch)
     CALL POPINTEGER4(branch)
     CALL POPINTEGER4(branch)
     CALL POPINTEGER4(branch)
     GOTO 190
140  CALL POPINTEGER4(branch)
     CALL POPINTEGER4(branch)
     CALL POPINTEGER4(branch)
     CALL POPINTEGER4(branch)
     GOTO 190
150  CALL POPINTEGER4(branch)
     CALL POPINTEGER4(branch)
     CALL POPINTEGER4(branch)
     CALL POPINTEGER4(branch)
     GOTO 190
160  CALL POPINTEGER4(branch)
     CALL POPINTEGER4(branch)
     CALL POPINTEGER4(branch)
     CALL POPINTEGER4(branch)
     GOTO 190
170  CALL POPINTEGER4(branch)
     CALL POPINTEGER4(branch)
     CALL POPINTEGER4(branch)
     CALL POPINTEGER4(branch)
     GOTO 190
180  CALL POPINTEGER4(branch)
     CALL POPINTEGER4(branch)
     CALL POPINTEGER4(branch)
     CALL POPINTEGER4(branch)
190  CONTINUE
  END DO
  CALL POPINTEGER4(branch)
  IF (.NOT.branch .LT. 2) THEN
     IF (.NOT.branch .LT. 3) THEN
        DO j=2,-3,-1
           DO i=2,-3,-1
              CALL POPINTEGER4(branch)
              IF (.NOT.branch .LT. 3) THEN
                 CALL POPREAL8(xadj(i, j, kmaxoffset, 3, sps2))
                 xadjb(i, j, kmaxoffset-1, 3, sps2) = xadjb(i, j, kmaxoffset-&
                      &              1, 3, sps2) + two*xadjb(i, j, kmaxoffset, 3, sps2)
                 xadjb(i, j, kmaxoffset-2, 3, sps2) = xadjb(i, j, kmaxoffset-&
                      &              2, 3, sps2) - xadjb(i, j, kmaxoffset, 3, sps2)
                 xadjb(i, j, kmaxoffset, 3, sps2) = 0.0
                 CALL POPREAL8(xadj(i, j, kmaxoffset, 2, sps2))
                 xadjb(i, j, kmaxoffset-1, 2, sps2) = xadjb(i, j, kmaxoffset-&
                      &              1, 2, sps2) + two*xadjb(i, j, kmaxoffset, 2, sps2)
                 xadjb(i, j, kmaxoffset-2, 2, sps2) = xadjb(i, j, kmaxoffset-&
                      &              2, 2, sps2) - xadjb(i, j, kmaxoffset, 2, sps2)
                 xadjb(i, j, kmaxoffset, 2, sps2) = 0.0
                 CALL POPREAL8(xadj(i, j, kmaxoffset, 1, sps2))
                 xadjb(i, j, kmaxoffset-1, 1, sps2) = xadjb(i, j, kmaxoffset-&
                      &              1, 1, sps2) + two*xadjb(i, j, kmaxoffset, 1, sps2)
                 xadjb(i, j, kmaxoffset-2, 1, sps2) = xadjb(i, j, kmaxoffset-&
                      &              2, 1, sps2) - xadjb(i, j, kmaxoffset, 1, sps2)
                 xadjb(i, j, kmaxoffset, 1, sps2) = 0.0
              END IF
           END DO
        END DO
     END IF
  END IF
  CALL POPINTEGER4(branch)
  IF (.NOT.branch .LT. 2) THEN
     IF (.NOT.branch .LT. 3) THEN
        DO j=2,-3,-1
           DO i=2,-3,-1
              CALL POPINTEGER4(branch)
              IF (.NOT.branch .LT. 3) THEN
                 CALL POPREAL8(xadj(i, j, kminoffset, 3, sps2))
                 xadjb(i, j, kminoffset+1, 3, sps2) = xadjb(i, j, kminoffset+&
                      &              1, 3, sps2) + two*xadjb(i, j, kminoffset, 3, sps2)
                 xadjb(i, j, kminoffset+2, 3, sps2) = xadjb(i, j, kminoffset+&
                      &              2, 3, sps2) - xadjb(i, j, kminoffset, 3, sps2)
                 xadjb(i, j, kminoffset, 3, sps2) = 0.0
                 CALL POPREAL8(xadj(i, j, kminoffset, 2, sps2))
                 xadjb(i, j, kminoffset+1, 2, sps2) = xadjb(i, j, kminoffset+&
                      &              1, 2, sps2) + two*xadjb(i, j, kminoffset, 2, sps2)
                 xadjb(i, j, kminoffset+2, 2, sps2) = xadjb(i, j, kminoffset+&
                      &              2, 2, sps2) - xadjb(i, j, kminoffset, 2, sps2)
                 xadjb(i, j, kminoffset, 2, sps2) = 0.0
                 CALL POPREAL8(xadj(i, j, kminoffset, 1, sps2))
                 xadjb(i, j, kminoffset+1, 1, sps2) = xadjb(i, j, kminoffset+&
                      &              1, 1, sps2) + two*xadjb(i, j, kminoffset, 1, sps2)
                 xadjb(i, j, kminoffset+2, 1, sps2) = xadjb(i, j, kminoffset+&
                      &              2, 1, sps2) - xadjb(i, j, kminoffset, 1, sps2)
                 xadjb(i, j, kminoffset, 1, sps2) = 0.0
              END IF
           END DO
        END DO
     END IF
  END IF
  CALL POPINTEGER4(branch)
  IF (.NOT.branch .LT. 2) THEN
     IF (.NOT.branch .LT. 3) THEN
        DO k=2,-3,-1
           DO i=2,-3,-1
              CALL POPINTEGER4(branch)
              IF (.NOT.branch .LT. 3) THEN
                 CALL POPREAL8(xadj(i, jmaxoffset, k, 3, sps2))
                 xadjb(i, jmaxoffset-1, k, 3, sps2) = xadjb(i, jmaxoffset-1, &
                      &              k, 3, sps2) + two*xadjb(i, jmaxoffset, k, 3, sps2)
                 xadjb(i, jmaxoffset-2, k, 3, sps2) = xadjb(i, jmaxoffset-2, &
                      &              k, 3, sps2) - xadjb(i, jmaxoffset, k, 3, sps2)
                 xadjb(i, jmaxoffset, k, 3, sps2) = 0.0
                 CALL POPREAL8(xadj(i, jmaxoffset, k, 2, sps2))
                 xadjb(i, jmaxoffset-1, k, 2, sps2) = xadjb(i, jmaxoffset-1, &
                      &              k, 2, sps2) + two*xadjb(i, jmaxoffset, k, 2, sps2)
                 xadjb(i, jmaxoffset-2, k, 2, sps2) = xadjb(i, jmaxoffset-2, &
                      &              k, 2, sps2) - xadjb(i, jmaxoffset, k, 2, sps2)
                 xadjb(i, jmaxoffset, k, 2, sps2) = 0.0
                 CALL POPREAL8(xadj(i, jmaxoffset, k, 1, sps2))
                 xadjb(i, jmaxoffset-1, k, 1, sps2) = xadjb(i, jmaxoffset-1, &
                      &              k, 1, sps2) + two*xadjb(i, jmaxoffset, k, 1, sps2)
                 xadjb(i, jmaxoffset-2, k, 1, sps2) = xadjb(i, jmaxoffset-2, &
                      &              k, 1, sps2) - xadjb(i, jmaxoffset, k, 1, sps2)
                 xadjb(i, jmaxoffset, k, 1, sps2) = 0.0
              END IF
           END DO
        END DO
     END IF
  END IF
  CALL POPINTEGER4(branch)
  IF (.NOT.branch .LT. 2) THEN
     IF (.NOT.branch .LT. 3) THEN
        DO i=2,-3,-1
           DO k=2,-3,-1
              CALL POPINTEGER4(branch)
              IF (.NOT.branch .LT. 3) THEN
                 CALL POPREAL8(xadj(i, jminoffset, k, 3, sps2))
                 xadjb(i, jminoffset+1, k, 3, sps2) = xadjb(i, jminoffset+1, &
                      &              k, 3, sps2) + two*xadjb(i, jminoffset, k, 3, sps2)
                 xadjb(i, jminoffset+2, k, 3, sps2) = xadjb(i, jminoffset+2, &
                      &              k, 3, sps2) - xadjb(i, jminoffset, k, 3, sps2)
                 xadjb(i, jminoffset, k, 3, sps2) = 0.0
                 CALL POPREAL8(xadj(i, jminoffset, k, 2, sps2))
                 xadjb(i, jminoffset+1, k, 2, sps2) = xadjb(i, jminoffset+1, &
                      &              k, 2, sps2) + two*xadjb(i, jminoffset, k, 2, sps2)
                 xadjb(i, jminoffset+2, k, 2, sps2) = xadjb(i, jminoffset+2, &
                      &              k, 2, sps2) - xadjb(i, jminoffset, k, 2, sps2)
                 xadjb(i, jminoffset, k, 2, sps2) = 0.0
                 CALL POPREAL8(xadj(i, jminoffset, k, 1, sps2))
                 xadjb(i, jminoffset+1, k, 1, sps2) = xadjb(i, jminoffset+1, &
                      &              k, 1, sps2) + two*xadjb(i, jminoffset, k, 1, sps2)
                 xadjb(i, jminoffset+2, k, 1, sps2) = xadjb(i, jminoffset+2, &
                      &              k, 1, sps2) - xadjb(i, jminoffset, k, 1, sps2)
                 xadjb(i, jminoffset, k, 1, sps2) = 0.0
              END IF
           END DO
        END DO
     END IF
  END IF
  CALL POPINTEGER4(branch)
  IF (.NOT.branch .LT. 2) THEN
     IF (.NOT.branch .LT. 3) THEN
        DO j=2,-3,-1
           DO k=2,-3,-1
              CALL POPINTEGER4(branch)
              IF (.NOT.branch .LT. 3) THEN
                 CALL POPREAL8(xadj(imaxoffset, j, k, 3, sps2))
                 xadjb(imaxoffset-1, j, k, 3, sps2) = xadjb(imaxoffset-1, j, &
                      &              k, 3, sps2) + two*xadjb(imaxoffset, j, k, 3, sps2)
                 xadjb(imaxoffset-2, j, k, 3, sps2) = xadjb(imaxoffset-2, j, &
                      &              k, 3, sps2) - xadjb(imaxoffset, j, k, 3, sps2)
                 xadjb(imaxoffset, j, k, 3, sps2) = 0.0
                 CALL POPREAL8(xadj(imaxoffset, j, k, 2, sps2))
                 xadjb(imaxoffset-1, j, k, 2, sps2) = xadjb(imaxoffset-1, j, &
                      &              k, 2, sps2) + two*xadjb(imaxoffset, j, k, 2, sps2)
                 xadjb(imaxoffset-2, j, k, 2, sps2) = xadjb(imaxoffset-2, j, &
                      &              k, 2, sps2) - xadjb(imaxoffset, j, k, 2, sps2)
                 xadjb(imaxoffset, j, k, 2, sps2) = 0.0
                 CALL POPREAL8(xadj(imaxoffset, j, k, 1, sps2))
                 xadjb(imaxoffset-1, j, k, 1, sps2) = xadjb(imaxoffset-1, j, &
                      &              k, 1, sps2) + two*xadjb(imaxoffset, j, k, 1, sps2)
                 xadjb(imaxoffset-2, j, k, 1, sps2) = xadjb(imaxoffset-2, j, &
                      &              k, 1, sps2) - xadjb(imaxoffset, j, k, 1, sps2)
                 xadjb(imaxoffset, j, k, 1, sps2) = 0.0
              END IF
           END DO
        END DO
     END IF
  END IF
  CALL POPINTEGER4(branch)
  IF (.NOT.branch .LT. 2) THEN
     IF (.NOT.branch .LT. 3) THEN
        DO j=2,-3,-1
           DO k=2,-3,-1
              CALL POPINTEGER4(branch)
              IF (.NOT.branch .LT. 3) THEN
                 CALL POPREAL8(xadj(iminoffset, j, k, 3, sps2))
                 xadjb(iminoffset+1, j, k, 3, sps2) = xadjb(iminoffset+1, j, &
                      &              k, 3, sps2) + two*xadjb(iminoffset, j, k, 3, sps2)
                 xadjb(iminoffset+2, j, k, 3, sps2) = xadjb(iminoffset+2, j, &
                      &              k, 3, sps2) - xadjb(iminoffset, j, k, 3, sps2)
                 xadjb(iminoffset, j, k, 3, sps2) = 0.0
                 CALL POPREAL8(xadj(iminoffset, j, k, 2, sps2))
                 xadjb(iminoffset+1, j, k, 2, sps2) = xadjb(iminoffset+1, j, &
                      &              k, 2, sps2) + two*xadjb(iminoffset, j, k, 2, sps2)
                 xadjb(iminoffset+2, j, k, 2, sps2) = xadjb(iminoffset+2, j, &
                      &              k, 2, sps2) - xadjb(iminoffset, j, k, 2, sps2)
                 xadjb(iminoffset, j, k, 2, sps2) = 0.0
                 CALL POPREAL8(xadj(iminoffset, j, k, 1, sps2))
                 xadjb(iminoffset+1, j, k, 1, sps2) = xadjb(iminoffset+1, j, &
                      &              k, 1, sps2) + two*xadjb(iminoffset, j, k, 1, sps2)
                 xadjb(iminoffset+2, j, k, 1, sps2) = xadjb(iminoffset+2, j, &
                      &              k, 1, sps2) - xadjb(iminoffset, j, k, 1, sps2)
                 xadjb(iminoffset, j, k, 1, sps2) = 0.0
              END IF
           END DO
        END DO
     END IF
  END IF
  DO mm=nsubface,1,-1
     CALL POPINTEGER4(branch)
  END DO
END SUBROUTINE XHALOADJ_B
