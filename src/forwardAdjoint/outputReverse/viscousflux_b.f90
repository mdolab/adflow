   !        Generated by TAPENADE     (INRIA, Tropics team)
   !  Tapenade 3.10 (r5363) -  9 Sep 2014 09:53
   !
   !  Differentiation of viscousflux in reverse (adjoint) mode (with options i4 dr8 r8 noISIZE):
   !   gradient     of useful results: *p *gamma *w *x *vol *si *sj
   !                *sk *fw *(*viscsubface.tau)
   !   with respect to varying inputs: *rev *p *gamma *w *rlv *x *vol
   !                *si *sj *sk *fw
   !   Plus diff mem management of: rev:in wx:in wy:in wz:in p:in
   !                gamma:in w:in rlv:in x:in qx:in qy:in qz:in ux:in
   !                vol:in uy:in uz:in si:in sj:in sk:in vx:in vy:in
   !                vz:in fw:in viscsubface:in *viscsubface.tau:in
   !
   !      ******************************************************************
   !      *                                                                *
   !      * File:          viscousFlux.f90                                 *
   !      * Author:        Edwin van der Weide                             *
   !      * Starting date: 03-21-2003                                      *
   !      * Last modified: 04-18-2005                                      *
   !      *                                                                *
   !      ******************************************************************
   !
   SUBROUTINE VISCOUSFLUX_B()
   !
   !      ******************************************************************
   !      *                                                                *
   !      * viscousFlux computes the viscous fluxes using a central        *
   !      * difference scheme for a block.                                 *
   !      * It is assumed that the pointers in block pointer already point *
   !      * to the correct block.                                          *
   !      *                                                                *
   !      ******************************************************************
   !
   USE BLOCKPOINTERS_B
   USE FLOWVARREFSTATE
   USE INPUTPHYSICS
   USE ITERATION
   IMPLICIT NONE
   ! Possibly correct the wall shear stress.
   ! Wall function is not ADed
   !
   !      Local parameter.
   !
   REAL(kind=realtype), PARAMETER :: twothird=two*third
   !
   !      Local variables.
   !
   INTEGER(kind=inttype) :: i, j, k
   INTEGER(kind=inttype) :: istart, iend, isize, ii
   INTEGER(kind=inttype) :: jstart, jend, jsize
   INTEGER(kind=inttype) :: kstart, kend, ksize
   REAL(kind=realtype) :: rfilv, por, mul, mue, mut, heatcoef
   REAL(kind=realtype) :: mulb, mueb, mutb, heatcoefb
   REAL(kind=realtype) :: gm1, factlamheat, factturbheat
   REAL(kind=realtype) :: gm1b, factlamheatb, factturbheatb
   REAL(kind=realtype) :: u_x, u_y, u_z, v_x, v_y, v_z, w_x, w_y, w_z
   REAL(kind=realtype) :: u_xb, u_yb, u_zb, v_xb, v_yb, v_zb, w_xb, w_yb&
   & , w_zb
   REAL(kind=realtype) :: q_x, q_y, q_z, ubar, vbar, wbar
   REAL(kind=realtype) :: q_xb, q_yb, q_zb, ubarb, vbarb, wbarb
   REAL(kind=realtype) :: corr, ssx, ssy, ssz, ss, fracdiv
   REAL(kind=realtype) :: corrb, ssxb, ssyb, sszb, ssb, fracdivb
   REAL(kind=realtype) :: tauxx, tauyy, tauzz
   REAL(kind=realtype) :: tauxxb, tauyyb, tauzzb
   REAL(kind=realtype) :: tauxy, tauxz, tauyz
   REAL(kind=realtype) :: tauxyb, tauxzb, tauyzb
   REAL(kind=realtype) :: fmx, fmy, fmz, frhoe
   REAL(kind=realtype) :: fmxb, fmyb, fmzb, frhoeb
   LOGICAL :: correctfork, storewalltensor
   INTRINSIC ABS
   INTRINSIC SQRT
   INTEGER :: branch
   REAL(kind=realtype) :: temp3
   REAL(kind=realtype) :: tempb52
   REAL(kind=realtype) :: temp2
   REAL(kind=realtype) :: tempb51
   REAL(kind=realtype) :: temp1
   REAL(kind=realtype) :: tempb50
   REAL(kind=realtype) :: temp0
   REAL(kind=realtype) :: tempb9
   REAL(kind=realtype) :: tempb8
   REAL(kind=realtype) :: tempb7
   REAL(kind=realtype) :: tempb6
   REAL(kind=realtype) :: tempb5
   REAL(kind=realtype) :: tempb4
   REAL(kind=realtype) :: tempb19
   REAL(kind=realtype) :: tempb3
   REAL(kind=realtype) :: tempb18
   REAL(kind=realtype) :: tempb2
   REAL(kind=realtype) :: tempb17
   REAL(kind=realtype) :: tempb1
   REAL(kind=realtype) :: tempb16
   REAL(kind=realtype) :: tempb0
   REAL(kind=realtype) :: tempb15
   REAL(kind=realtype) :: tempb14
   REAL(kind=realtype) :: tempb13
   REAL(kind=realtype) :: tempb12
   REAL(kind=realtype) :: tempb49
   REAL(kind=realtype) :: tempb11
   REAL(kind=realtype) :: tempb48
   REAL(kind=realtype) :: tempb10
   REAL(kind=realtype) :: tempb47
   REAL(kind=realtype) :: tempb46
   REAL(kind=realtype) :: tempb45
   REAL(kind=realtype) :: tempb44
   REAL(kind=realtype) :: tempb43
   REAL(kind=realtype) :: tempb42
   REAL(kind=realtype) :: tempb41
   REAL(kind=realtype) :: tempb40
   REAL(kind=realtype) :: tempb
   REAL(kind=realtype) :: tempb39
   REAL(kind=realtype) :: tempb38
   REAL(kind=realtype) :: tempb37
   REAL(kind=realtype) :: tempb36
   REAL(kind=realtype) :: tempb35
   REAL(kind=realtype) :: tempb34
   REAL(kind=realtype) :: tempb33
   REAL(kind=realtype) :: tempb32
   REAL(kind=realtype) :: tempb31
   REAL(kind=realtype) :: tempb30
   REAL(kind=realtype) :: tempb60
   REAL(kind=realtype) :: abs0
   REAL(kind=realtype) :: tempb29
   REAL(kind=realtype) :: tempb28
   REAL(kind=realtype) :: tempb27
   REAL(kind=realtype) :: tempb26
   REAL(kind=realtype) :: tempb25
   REAL(kind=realtype) :: temp
   REAL(kind=realtype) :: tempb24
   REAL(kind=realtype) :: tempb23
   REAL(kind=realtype) :: tempb22
   REAL(kind=realtype) :: tempb59
   REAL(kind=realtype) :: tempb21
   REAL(kind=realtype) :: tempb58
   REAL(kind=realtype) :: tempb20
   REAL(kind=realtype) :: tempb57
   REAL(kind=realtype) :: tempb56
   REAL(kind=realtype) :: temp7
   REAL(kind=realtype) :: tempb55
   REAL(kind=realtype) :: temp6
   REAL(kind=realtype) :: temp5
   REAL(kind=realtype) :: tempb54
   REAL(kind=realtype) :: temp4
   REAL(kind=realtype) :: tempb53
   !
   !      ******************************************************************
   !      *                                                                *
   !      * Begin execution                                                *
   !      *                                                                *
   !      ******************************************************************
   ! Set rFilv to rFil to indicate that this is the viscous part.
   ! If rFilv == 0 the viscous residuals need not to be computed
   ! and a return can be made.
   rfilv = rfil
   IF (rfilv .GE. 0.) THEN
   abs0 = rfilv
   ELSE
   abs0 = -rfilv
   END IF
   IF (abs0 .LT. thresholdreal) THEN
   revb = 0.0_8
   rlvb = 0.0_8
   ELSE
   ! Determine whether or not the pressure must be corrected
   ! for the presence of the turbulent kinetic energy.
   IF (kpresent) THEN
   IF (currentlevel .LE. groundlevel .OR. turbcoupled) THEN
   correctfork = .true.
   ELSE
   correctfork = .false.
   END IF
   ELSE
   correctfork = .false.
   END IF
   ! Determine whether or not the wall stress tensor and wall heat
   ! flux must be stored for viscous walls.
   storewalltensor = .false.
   IF (wallfunctions) THEN
   storewalltensor = .true.
   ELSE IF (rkstage .EQ. 0 .AND. currentlevel .EQ. groundlevel) THEN
   storewalltensor = .true.
   END IF
   ! Store the speed of sound squared instead of the pressure.
   ! To be 100 percent correct, substract 2/3*rho*k (if present)
   ! from the pressure to obtain the true presssure. First layer of
   ! halo's, because that's what is needed by the viscous stencil.
   DO k=1,ke
   DO j=1,je
   DO i=1,ie
   IF (correctfork) THEN
   CALL PUSHREAL8(p(i, j, k))
   p(i, j, k) = p(i, j, k) - twothird*w(i, j, k, irho)*w(i, j, &
   &             k, itu1)
   CALL PUSHCONTROL1B(0)
   ELSE
   CALL PUSHCONTROL1B(1)
   END IF
   CALL PUSHREAL8(p(i, j, k))
   p(i, j, k) = gamma(i, j, k)*p(i, j, k)/w(i, j, k, irho)
   END DO
   END DO
   END DO
   ! Compute all nodal gradients:
   CALL ALLNODALGRADIENTS()
   !
   !        ****************************************************************
   !        *                                                              *
   !        * viscous fluxes in the k-direction.                           *
   !        *                                                              *
   !        ****************************************************************
   !
   mue = zero
   DO k=1,kl
   DO j=2,jl
   DO i=2,il
   ! Set the value of the porosity. If not zero, it is set
   ! to average the eddy-viscosity and to take the factor
   ! rFilv into account.
   CALL PUSHREAL8(por)
   por = half*rfilv
   IF (pork(i, j, k) .EQ. noflux) por = zero
   ! Compute the laminar and (if present) the eddy viscosities
   ! multiplied by the porosity. Compute the factor in front of
   ! the gradients of the speed of sound squared for the heat
   ! flux.
   mul = por*(rlv(i, j, k)+rlv(i, j, k+1))
   IF (eddymodel) THEN
   CALL PUSHREAL8(mue)
   mue = por*(rev(i, j, k)+rev(i, j, k+1))
   CALL PUSHCONTROL1B(0)
   ELSE
   CALL PUSHCONTROL1B(1)
   END IF
   CALL PUSHREAL8(mut)
   gm1 = half*(gamma(i, j, k)+gamma(i, j, k+1)) - one
   factlamheat = one/(prandtl*gm1)
   factturbheat = one/(prandtlturb*gm1)
   heatcoef = mul*factlamheat + mue*factturbheat
   ! Compute the gradients at the face by averaging the four
   ! nodal values.
   CALL PUSHREAL8(u_x)
   u_x = fourth*(ux(i-1, j-1, k)+ux(i, j-1, k)+ux(i-1, j, k)+ux(i&
   &           , j, k))
   CALL PUSHREAL8(u_y)
   u_y = fourth*(uy(i-1, j-1, k)+uy(i, j-1, k)+uy(i-1, j, k)+uy(i&
   &           , j, k))
   CALL PUSHREAL8(u_z)
   u_z = fourth*(uz(i-1, j-1, k)+uz(i, j-1, k)+uz(i-1, j, k)+uz(i&
   &           , j, k))
   CALL PUSHREAL8(v_x)
   v_x = fourth*(vx(i-1, j-1, k)+vx(i, j-1, k)+vx(i-1, j, k)+vx(i&
   &           , j, k))
   CALL PUSHREAL8(v_y)
   v_y = fourth*(vy(i-1, j-1, k)+vy(i, j-1, k)+vy(i-1, j, k)+vy(i&
   &           , j, k))
   CALL PUSHREAL8(v_z)
   v_z = fourth*(vz(i-1, j-1, k)+vz(i, j-1, k)+vz(i-1, j, k)+vz(i&
   &           , j, k))
   CALL PUSHREAL8(w_x)
   w_x = fourth*(wx(i-1, j-1, k)+wx(i, j-1, k)+wx(i-1, j, k)+wx(i&
   &           , j, k))
   CALL PUSHREAL8(w_y)
   w_y = fourth*(wy(i-1, j-1, k)+wy(i, j-1, k)+wy(i-1, j, k)+wy(i&
   &           , j, k))
   CALL PUSHREAL8(w_z)
   w_z = fourth*(wz(i-1, j-1, k)+wz(i, j-1, k)+wz(i-1, j, k)+wz(i&
   &           , j, k))
   CALL PUSHREAL8(q_x)
   q_x = fourth*(qx(i-1, j-1, k)+qx(i, j-1, k)+qx(i-1, j, k)+qx(i&
   &           , j, k))
   CALL PUSHREAL8(q_y)
   q_y = fourth*(qy(i-1, j-1, k)+qy(i, j-1, k)+qy(i-1, j, k)+qy(i&
   &           , j, k))
   CALL PUSHREAL8(q_z)
   q_z = fourth*(qz(i-1, j-1, k)+qz(i, j-1, k)+qz(i-1, j, k)+qz(i&
   &           , j, k))
   ! The gradients in the normal direction are corrected, such
   ! that no averaging takes places here.
   ! First determine the vector in the direction from the
   ! cell center k to cell center k+1.
   CALL PUSHREAL8(ssx)
   ssx = eighth*(x(i-1, j-1, k+1, 1)-x(i-1, j-1, k-1, 1)+x(i-1, j&
   &           , k+1, 1)-x(i-1, j, k-1, 1)+x(i, j-1, k+1, 1)-x(i, j-1, k-1&
   &           , 1)+x(i, j, k+1, 1)-x(i, j, k-1, 1))
   CALL PUSHREAL8(ssy)
   ssy = eighth*(x(i-1, j-1, k+1, 2)-x(i-1, j-1, k-1, 2)+x(i-1, j&
   &           , k+1, 2)-x(i-1, j, k-1, 2)+x(i, j-1, k+1, 2)-x(i, j-1, k-1&
   &           , 2)+x(i, j, k+1, 2)-x(i, j, k-1, 2))
   CALL PUSHREAL8(ssz)
   ssz = eighth*(x(i-1, j-1, k+1, 3)-x(i-1, j-1, k-1, 3)+x(i-1, j&
   &           , k+1, 3)-x(i-1, j, k-1, 3)+x(i, j-1, k+1, 3)-x(i, j-1, k-1&
   &           , 3)+x(i, j, k+1, 3)-x(i, j, k-1, 3))
   ! Determine the length of this vector and create the
   ! unit normal.
   CALL PUSHREAL8(ss)
   ss = one/SQRT(ssx*ssx+ssy*ssy+ssz*ssz)
   CALL PUSHREAL8(ssx)
   ssx = ss*ssx
   CALL PUSHREAL8(ssy)
   ssy = ss*ssy
   CALL PUSHREAL8(ssz)
   ssz = ss*ssz
   ! Correct the gradients.
   CALL PUSHREAL8(corr)
   corr = u_x*ssx + u_y*ssy + u_z*ssz - (w(i, j, k+1, ivx)-w(i, j&
   &           , k, ivx))*ss
   CALL PUSHREAL8(u_x)
   u_x = u_x - corr*ssx
   CALL PUSHREAL8(u_y)
   u_y = u_y - corr*ssy
   CALL PUSHREAL8(u_z)
   u_z = u_z - corr*ssz
   CALL PUSHREAL8(corr)
   corr = v_x*ssx + v_y*ssy + v_z*ssz - (w(i, j, k+1, ivy)-w(i, j&
   &           , k, ivy))*ss
   CALL PUSHREAL8(v_x)
   v_x = v_x - corr*ssx
   CALL PUSHREAL8(v_y)
   v_y = v_y - corr*ssy
   CALL PUSHREAL8(v_z)
   v_z = v_z - corr*ssz
   CALL PUSHREAL8(corr)
   corr = w_x*ssx + w_y*ssy + w_z*ssz - (w(i, j, k+1, ivz)-w(i, j&
   &           , k, ivz))*ss
   CALL PUSHREAL8(w_x)
   w_x = w_x - corr*ssx
   CALL PUSHREAL8(w_y)
   w_y = w_y - corr*ssy
   CALL PUSHREAL8(w_z)
   w_z = w_z - corr*ssz
   CALL PUSHREAL8(corr)
   corr = q_x*ssx + q_y*ssy + q_z*ssz + (p(i, j, k+1)-p(i, j, k))&
   &           *ss
   CALL PUSHREAL8(q_x)
   q_x = q_x - corr*ssx
   CALL PUSHREAL8(q_y)
   q_y = q_y - corr*ssy
   CALL PUSHREAL8(q_z)
   q_z = q_z - corr*ssz
   ! Compute the stress tensor and the heat flux vector.
   CALL PUSHREAL8(fracdiv)
   fracdiv = twothird*(u_x+v_y+w_z)
   CALL PUSHREAL8(q_x)
   q_x = heatcoef*q_x
   CALL PUSHREAL8(q_y)
   q_y = heatcoef*q_y
   CALL PUSHREAL8(q_z)
   q_z = heatcoef*q_z
   ! Compute the average velocities for the face. Remember that
   ! the velocities are stored and not the momentum.
   ! Compute the viscous fluxes for this k-face.
   ! Update the residuals of cell k and k+1.
   ! Store the stress tensor and the heat flux vector if this
   ! face is part of a viscous subface. Both the cases k == 1
   ! and k == kl must be tested.
   IF (k .EQ. 1 .AND. storewalltensor .AND. visckminpointer(i, j)&
   &             .GT. 0) THEN
   CALL PUSHCONTROL1B(0)
   ELSE
   CALL PUSHCONTROL1B(1)
   END IF
   ! And the k == kl case.
   IF (k .EQ. kl .AND. storewalltensor .AND. visckmaxpointer(i, j&
   &             ) .GT. 0) THEN
   CALL PUSHCONTROL1B(1)
   ELSE
   CALL PUSHCONTROL1B(0)
   END IF
   END DO
   END DO
   END DO
   !
   !        ****************************************************************
   !        *                                                              *
   !        * Viscous fluxes in the j-direction.                           *
   !        *                                                              *
   !        ****************************************************************
   !
   DO k=2,kl
   DO j=1,jl
   DO i=2,il
   ! Set the value of the porosity. If not zero, it is set
   ! to average the eddy-viscosity and to take the factor
   ! rFilv into account.
   CALL PUSHREAL8(por)
   por = half*rfilv
   IF (porj(i, j, k) .EQ. noflux) por = zero
   ! Compute the laminar and (if present) the eddy viscosities
   ! multiplied by the porosity. Compute the factor in front of
   ! the gradients of the speed of sound squared for the heat
   ! flux.
   mul = por*(rlv(i, j, k)+rlv(i, j+1, k))
   IF (eddymodel) THEN
   CALL PUSHREAL8(mue)
   mue = por*(rev(i, j, k)+rev(i, j+1, k))
   CALL PUSHCONTROL1B(0)
   ELSE
   CALL PUSHCONTROL1B(1)
   END IF
   CALL PUSHREAL8(mut)
   gm1 = half*(gamma(i, j, k)+gamma(i, j+1, k)) - one
   factlamheat = one/(prandtl*gm1)
   factturbheat = one/(prandtlturb*gm1)
   heatcoef = mul*factlamheat + mue*factturbheat
   ! Compute the gradients at the face by averaging the four
   ! nodal values.
   CALL PUSHREAL8(u_x)
   u_x = fourth*(ux(i-1, j, k-1)+ux(i, j, k-1)+ux(i-1, j, k)+ux(i&
   &           , j, k))
   CALL PUSHREAL8(u_y)
   u_y = fourth*(uy(i-1, j, k-1)+uy(i, j, k-1)+uy(i-1, j, k)+uy(i&
   &           , j, k))
   CALL PUSHREAL8(u_z)
   u_z = fourth*(uz(i-1, j, k-1)+uz(i, j, k-1)+uz(i-1, j, k)+uz(i&
   &           , j, k))
   CALL PUSHREAL8(v_x)
   v_x = fourth*(vx(i-1, j, k-1)+vx(i, j, k-1)+vx(i-1, j, k)+vx(i&
   &           , j, k))
   CALL PUSHREAL8(v_y)
   v_y = fourth*(vy(i-1, j, k-1)+vy(i, j, k-1)+vy(i-1, j, k)+vy(i&
   &           , j, k))
   CALL PUSHREAL8(v_z)
   v_z = fourth*(vz(i-1, j, k-1)+vz(i, j, k-1)+vz(i-1, j, k)+vz(i&
   &           , j, k))
   CALL PUSHREAL8(w_x)
   w_x = fourth*(wx(i-1, j, k-1)+wx(i, j, k-1)+wx(i-1, j, k)+wx(i&
   &           , j, k))
   CALL PUSHREAL8(w_y)
   w_y = fourth*(wy(i-1, j, k-1)+wy(i, j, k-1)+wy(i-1, j, k)+wy(i&
   &           , j, k))
   CALL PUSHREAL8(w_z)
   w_z = fourth*(wz(i-1, j, k-1)+wz(i, j, k-1)+wz(i-1, j, k)+wz(i&
   &           , j, k))
   CALL PUSHREAL8(q_x)
   q_x = fourth*(qx(i-1, j, k-1)+qx(i, j, k-1)+qx(i-1, j, k)+qx(i&
   &           , j, k))
   CALL PUSHREAL8(q_y)
   q_y = fourth*(qy(i-1, j, k-1)+qy(i, j, k-1)+qy(i-1, j, k)+qy(i&
   &           , j, k))
   CALL PUSHREAL8(q_z)
   q_z = fourth*(qz(i-1, j, k-1)+qz(i, j, k-1)+qz(i-1, j, k)+qz(i&
   &           , j, k))
   ! The gradients in the normal direction are corrected, such
   ! that no averaging takes places here.
   ! First determine the vector in the direction from the
   ! cell center j to cell center j+1.
   CALL PUSHREAL8(ssx)
   ssx = eighth*(x(i-1, j+1, k-1, 1)-x(i-1, j-1, k-1, 1)+x(i-1, j&
   &           +1, k, 1)-x(i-1, j-1, k, 1)+x(i, j+1, k-1, 1)-x(i, j-1, k-1&
   &           , 1)+x(i, j+1, k, 1)-x(i, j-1, k, 1))
   CALL PUSHREAL8(ssy)
   ssy = eighth*(x(i-1, j+1, k-1, 2)-x(i-1, j-1, k-1, 2)+x(i-1, j&
   &           +1, k, 2)-x(i-1, j-1, k, 2)+x(i, j+1, k-1, 2)-x(i, j-1, k-1&
   &           , 2)+x(i, j+1, k, 2)-x(i, j-1, k, 2))
   CALL PUSHREAL8(ssz)
   ssz = eighth*(x(i-1, j+1, k-1, 3)-x(i-1, j-1, k-1, 3)+x(i-1, j&
   &           +1, k, 3)-x(i-1, j-1, k, 3)+x(i, j+1, k-1, 3)-x(i, j-1, k-1&
   &           , 3)+x(i, j+1, k, 3)-x(i, j-1, k, 3))
   ! Determine the length of this vector and create the
   ! unit normal.
   CALL PUSHREAL8(ss)
   ss = one/SQRT(ssx*ssx+ssy*ssy+ssz*ssz)
   CALL PUSHREAL8(ssx)
   ssx = ss*ssx
   CALL PUSHREAL8(ssy)
   ssy = ss*ssy
   CALL PUSHREAL8(ssz)
   ssz = ss*ssz
   ! Correct the gradients.
   CALL PUSHREAL8(corr)
   corr = u_x*ssx + u_y*ssy + u_z*ssz - (w(i, j+1, k, ivx)-w(i, j&
   &           , k, ivx))*ss
   CALL PUSHREAL8(u_x)
   u_x = u_x - corr*ssx
   CALL PUSHREAL8(u_y)
   u_y = u_y - corr*ssy
   CALL PUSHREAL8(u_z)
   u_z = u_z - corr*ssz
   CALL PUSHREAL8(corr)
   corr = v_x*ssx + v_y*ssy + v_z*ssz - (w(i, j+1, k, ivy)-w(i, j&
   &           , k, ivy))*ss
   CALL PUSHREAL8(v_x)
   v_x = v_x - corr*ssx
   CALL PUSHREAL8(v_y)
   v_y = v_y - corr*ssy
   CALL PUSHREAL8(v_z)
   v_z = v_z - corr*ssz
   CALL PUSHREAL8(corr)
   corr = w_x*ssx + w_y*ssy + w_z*ssz - (w(i, j+1, k, ivz)-w(i, j&
   &           , k, ivz))*ss
   CALL PUSHREAL8(w_x)
   w_x = w_x - corr*ssx
   CALL PUSHREAL8(w_y)
   w_y = w_y - corr*ssy
   CALL PUSHREAL8(w_z)
   w_z = w_z - corr*ssz
   CALL PUSHREAL8(corr)
   corr = q_x*ssx + q_y*ssy + q_z*ssz + (p(i, j+1, k)-p(i, j, k))&
   &           *ss
   CALL PUSHREAL8(q_x)
   q_x = q_x - corr*ssx
   CALL PUSHREAL8(q_y)
   q_y = q_y - corr*ssy
   CALL PUSHREAL8(q_z)
   q_z = q_z - corr*ssz
   ! Compute the stress tensor and the heat flux vector.
   CALL PUSHREAL8(fracdiv)
   fracdiv = twothird*(u_x+v_y+w_z)
   CALL PUSHREAL8(q_x)
   q_x = heatcoef*q_x
   CALL PUSHREAL8(q_y)
   q_y = heatcoef*q_y
   CALL PUSHREAL8(q_z)
   q_z = heatcoef*q_z
   ! Compute the average velocities for the face. Remember that
   ! the velocities are stored and not the momentum.
   ! Compute the viscous fluxes for this j-face.
   ! Update the residuals of cell j and j+1.
   ! Store the stress tensor and the heat flux vector if this
   ! face is part of a viscous subface. Both the cases j == 1
   ! and j == jl must be tested.
   IF (j .EQ. 1 .AND. storewalltensor .AND. viscjminpointer(i, k)&
   &             .GT. 0) THEN
   CALL PUSHCONTROL1B(0)
   ELSE
   CALL PUSHCONTROL1B(1)
   END IF
   ! And the j == jl case.
   IF (j .EQ. jl .AND. storewalltensor .AND. viscjmaxpointer(i, k&
   &             ) .GT. 0) THEN
   CALL PUSHCONTROL1B(1)
   ELSE
   CALL PUSHCONTROL1B(0)
   END IF
   END DO
   END DO
   END DO
   !
   !        ****************************************************************
   !        *                                                              *
   !        * Viscous fluxes in the i-direction.                           *
   !        *                                                              *
   !        ****************************************************************
   !
   DO k=2,kl
   DO j=2,jl
   DO i=1,il
   ! Set the value of the porosity. If not zero, it is set
   ! to average the eddy-viscosity and to take the factor
   ! rFilv into account.
   CALL PUSHREAL8(por)
   por = half*rfilv
   IF (pori(i, j, k) .EQ. noflux) por = zero
   ! Compute the laminar and (if present) the eddy viscosities
   ! multiplied the porosity. Compute the factor in front of
   ! the gradients of the speed of sound squared for the heat
   ! flux.
   mul = por*(rlv(i, j, k)+rlv(i+1, j, k))
   IF (eddymodel) THEN
   CALL PUSHREAL8(mue)
   mue = por*(rev(i, j, k)+rev(i+1, j, k))
   CALL PUSHCONTROL1B(0)
   ELSE
   CALL PUSHCONTROL1B(1)
   END IF
   CALL PUSHREAL8(mut)
   gm1 = half*(gamma(i, j, k)+gamma(i+1, j, k)) - one
   factlamheat = one/(prandtl*gm1)
   factturbheat = one/(prandtlturb*gm1)
   heatcoef = mul*factlamheat + mue*factturbheat
   ! Compute the gradients at the face by averaging the four
   ! nodal values.
   CALL PUSHREAL8(u_x)
   u_x = fourth*(ux(i, j-1, k-1)+ux(i, j, k-1)+ux(i, j-1, k)+ux(i&
   &           , j, k))
   CALL PUSHREAL8(u_y)
   u_y = fourth*(uy(i, j-1, k-1)+uy(i, j, k-1)+uy(i, j-1, k)+uy(i&
   &           , j, k))
   CALL PUSHREAL8(u_z)
   u_z = fourth*(uz(i, j-1, k-1)+uz(i, j, k-1)+uz(i, j-1, k)+uz(i&
   &           , j, k))
   CALL PUSHREAL8(v_x)
   v_x = fourth*(vx(i, j-1, k-1)+vx(i, j, k-1)+vx(i, j-1, k)+vx(i&
   &           , j, k))
   CALL PUSHREAL8(v_y)
   v_y = fourth*(vy(i, j-1, k-1)+vy(i, j, k-1)+vy(i, j-1, k)+vy(i&
   &           , j, k))
   CALL PUSHREAL8(v_z)
   v_z = fourth*(vz(i, j-1, k-1)+vz(i, j, k-1)+vz(i, j-1, k)+vz(i&
   &           , j, k))
   CALL PUSHREAL8(w_x)
   w_x = fourth*(wx(i, j-1, k-1)+wx(i, j, k-1)+wx(i, j-1, k)+wx(i&
   &           , j, k))
   CALL PUSHREAL8(w_y)
   w_y = fourth*(wy(i, j-1, k-1)+wy(i, j, k-1)+wy(i, j-1, k)+wy(i&
   &           , j, k))
   CALL PUSHREAL8(w_z)
   w_z = fourth*(wz(i, j-1, k-1)+wz(i, j, k-1)+wz(i, j-1, k)+wz(i&
   &           , j, k))
   CALL PUSHREAL8(q_x)
   q_x = fourth*(qx(i, j-1, k-1)+qx(i, j, k-1)+qx(i, j-1, k)+qx(i&
   &           , j, k))
   CALL PUSHREAL8(q_y)
   q_y = fourth*(qy(i, j-1, k-1)+qy(i, j, k-1)+qy(i, j-1, k)+qy(i&
   &           , j, k))
   CALL PUSHREAL8(q_z)
   q_z = fourth*(qz(i, j-1, k-1)+qz(i, j, k-1)+qz(i, j-1, k)+qz(i&
   &           , j, k))
   ! The gradients in the normal direction are corrected, such
   ! that no averaging takes places here.
   ! First determine the vector in the direction from the
   ! cell center i to cell center i+1.
   CALL PUSHREAL8(ssx)
   ssx = eighth*(x(i+1, j-1, k-1, 1)-x(i-1, j-1, k-1, 1)+x(i+1, j&
   &           -1, k, 1)-x(i-1, j-1, k, 1)+x(i+1, j, k-1, 1)-x(i-1, j, k-1&
   &           , 1)+x(i+1, j, k, 1)-x(i-1, j, k, 1))
   CALL PUSHREAL8(ssy)
   ssy = eighth*(x(i+1, j-1, k-1, 2)-x(i-1, j-1, k-1, 2)+x(i+1, j&
   &           -1, k, 2)-x(i-1, j-1, k, 2)+x(i+1, j, k-1, 2)-x(i-1, j, k-1&
   &           , 2)+x(i+1, j, k, 2)-x(i-1, j, k, 2))
   CALL PUSHREAL8(ssz)
   ssz = eighth*(x(i+1, j-1, k-1, 3)-x(i-1, j-1, k-1, 3)+x(i+1, j&
   &           -1, k, 3)-x(i-1, j-1, k, 3)+x(i+1, j, k-1, 3)-x(i-1, j, k-1&
   &           , 3)+x(i+1, j, k, 3)-x(i-1, j, k, 3))
   ! Determine the length of this vector and create the
   ! unit normal.
   CALL PUSHREAL8(ss)
   ss = one/SQRT(ssx*ssx+ssy*ssy+ssz*ssz)
   CALL PUSHREAL8(ssx)
   ssx = ss*ssx
   CALL PUSHREAL8(ssy)
   ssy = ss*ssy
   CALL PUSHREAL8(ssz)
   ssz = ss*ssz
   ! Correct the gradients.
   CALL PUSHREAL8(corr)
   corr = u_x*ssx + u_y*ssy + u_z*ssz - (w(i+1, j, k, ivx)-w(i, j&
   &           , k, ivx))*ss
   CALL PUSHREAL8(u_x)
   u_x = u_x - corr*ssx
   CALL PUSHREAL8(u_y)
   u_y = u_y - corr*ssy
   CALL PUSHREAL8(u_z)
   u_z = u_z - corr*ssz
   CALL PUSHREAL8(corr)
   corr = v_x*ssx + v_y*ssy + v_z*ssz - (w(i+1, j, k, ivy)-w(i, j&
   &           , k, ivy))*ss
   CALL PUSHREAL8(v_x)
   v_x = v_x - corr*ssx
   CALL PUSHREAL8(v_y)
   v_y = v_y - corr*ssy
   CALL PUSHREAL8(v_z)
   v_z = v_z - corr*ssz
   CALL PUSHREAL8(corr)
   corr = w_x*ssx + w_y*ssy + w_z*ssz - (w(i+1, j, k, ivz)-w(i, j&
   &           , k, ivz))*ss
   CALL PUSHREAL8(w_x)
   w_x = w_x - corr*ssx
   CALL PUSHREAL8(w_y)
   w_y = w_y - corr*ssy
   CALL PUSHREAL8(w_z)
   w_z = w_z - corr*ssz
   CALL PUSHREAL8(corr)
   corr = q_x*ssx + q_y*ssy + q_z*ssz + (p(i+1, j, k)-p(i, j, k))&
   &           *ss
   CALL PUSHREAL8(q_x)
   q_x = q_x - corr*ssx
   CALL PUSHREAL8(q_y)
   q_y = q_y - corr*ssy
   CALL PUSHREAL8(q_z)
   q_z = q_z - corr*ssz
   ! Compute the stress tensor and the heat flux vector.
   CALL PUSHREAL8(fracdiv)
   fracdiv = twothird*(u_x+v_y+w_z)
   CALL PUSHREAL8(q_x)
   q_x = heatcoef*q_x
   CALL PUSHREAL8(q_y)
   q_y = heatcoef*q_y
   CALL PUSHREAL8(q_z)
   q_z = heatcoef*q_z
   ! Compute the average velocities for the face. Remember that
   ! the velocities are stored and not the momentum.
   ! Compute the viscous fluxes for this i-face.
   ! Update the residuals of cell i and i+1.
   ! Store the stress tensor and the heat flux vector if this
   ! face is part of a viscous subface. Both the cases i == 1
   ! and i == il must be tested.
   IF (i .EQ. 1 .AND. storewalltensor .AND. visciminpointer(j, k)&
   &             .GT. 0) THEN
   CALL PUSHCONTROL1B(0)
   ELSE
   CALL PUSHCONTROL1B(1)
   END IF
   ! And the i == il case.
   IF (i .EQ. il .AND. storewalltensor .AND. viscimaxpointer(j, k&
   &             ) .GT. 0) THEN
   CALL PUSHCONTROL1B(1)
   ELSE
   CALL PUSHCONTROL1B(0)
   END IF
   END DO
   END DO
   END DO
   ! Restore the pressure in p. Again only the first layer of
   ! halo cells.
   DO k=1,ke
   DO j=1,je
   DO i=1,ie
   CALL PUSHREAL8(p(i, j, k))
   p(i, j, k) = w(i, j, k, irho)*p(i, j, k)/gamma(i, j, k)
   END DO
   END DO
   END DO
   IF (correctfork) THEN
   DO k=ke,1,-1
   DO j=je,1,-1
   DO i=ie,1,-1
   wb(i, j, k, irho) = wb(i, j, k, irho) + twothird*w(i, j, k, &
   &             itu1)*pb(i, j, k)
   wb(i, j, k, itu1) = wb(i, j, k, itu1) + twothird*w(i, j, k, &
   &             irho)*pb(i, j, k)
   END DO
   END DO
   END DO
   END IF
   DO k=ke,1,-1
   DO j=je,1,-1
   DO i=ie,1,-1
   CALL POPREAL8(p(i, j, k))
   temp7 = gamma(i, j, k)
   temp6 = p(i, j, k)/temp7
   tempb60 = w(i, j, k, irho)*pb(i, j, k)/temp7
   wb(i, j, k, irho) = wb(i, j, k, irho) + temp6*pb(i, j, k)
   gammab(i, j, k) = gammab(i, j, k) - temp6*tempb60
   pb(i, j, k) = tempb60
   END DO
   END DO
   END DO
   revb = 0.0_8
   wxb = 0.0_8
   wyb = 0.0_8
   wzb = 0.0_8
   rlvb = 0.0_8
   qxb = 0.0_8
   qyb = 0.0_8
   qzb = 0.0_8
   uxb = 0.0_8
   uyb = 0.0_8
   uzb = 0.0_8
   vxb = 0.0_8
   vyb = 0.0_8
   vzb = 0.0_8
   mueb = 0.0_8
   DO k=kl,2,-1
   DO j=jl,2,-1
   DO i=il,1,-1
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   tauzzb = 0.0_8
   tauxxb = 0.0_8
   tauxyb = 0.0_8
   tauxzb = 0.0_8
   tauyyb = 0.0_8
   tauyzb = 0.0_8
   ELSE
   tauyzb = viscsubfaceb(viscimaxpointer(j, k))%tau(j, k, 6)
   viscsubfaceb(viscimaxpointer(j, k))%tau(j, k, 6) = 0.0_8
   tauxzb = viscsubfaceb(viscimaxpointer(j, k))%tau(j, k, 5)
   viscsubfaceb(viscimaxpointer(j, k))%tau(j, k, 5) = 0.0_8
   tauxyb = viscsubfaceb(viscimaxpointer(j, k))%tau(j, k, 4)
   viscsubfaceb(viscimaxpointer(j, k))%tau(j, k, 4) = 0.0_8
   tauzzb = viscsubfaceb(viscimaxpointer(j, k))%tau(j, k, 3)
   viscsubfaceb(viscimaxpointer(j, k))%tau(j, k, 3) = 0.0_8
   tauyyb = viscsubfaceb(viscimaxpointer(j, k))%tau(j, k, 2)
   viscsubfaceb(viscimaxpointer(j, k))%tau(j, k, 2) = 0.0_8
   tauxxb = viscsubfaceb(viscimaxpointer(j, k))%tau(j, k, 1)
   viscsubfaceb(viscimaxpointer(j, k))%tau(j, k, 1) = 0.0_8
   END IF
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   tauyzb = tauyzb + viscsubfaceb(visciminpointer(j, k))%tau(j&
   &             , k, 6)
   viscsubfaceb(visciminpointer(j, k))%tau(j, k, 6) = 0.0_8
   tauxzb = tauxzb + viscsubfaceb(visciminpointer(j, k))%tau(j&
   &             , k, 5)
   viscsubfaceb(visciminpointer(j, k))%tau(j, k, 5) = 0.0_8
   tauxyb = tauxyb + viscsubfaceb(visciminpointer(j, k))%tau(j&
   &             , k, 4)
   viscsubfaceb(visciminpointer(j, k))%tau(j, k, 4) = 0.0_8
   tauzzb = tauzzb + viscsubfaceb(visciminpointer(j, k))%tau(j&
   &             , k, 3)
   viscsubfaceb(visciminpointer(j, k))%tau(j, k, 3) = 0.0_8
   tauyyb = tauyyb + viscsubfaceb(visciminpointer(j, k))%tau(j&
   &             , k, 2)
   viscsubfaceb(visciminpointer(j, k))%tau(j, k, 2) = 0.0_8
   tauxxb = tauxxb + viscsubfaceb(visciminpointer(j, k))%tau(j&
   &             , k, 1)
   viscsubfaceb(visciminpointer(j, k))%tau(j, k, 1) = 0.0_8
   END IF
   frhoeb = fwb(i+1, j, k, irhoe) - fwb(i, j, k, irhoe)
   fmzb = fwb(i+1, j, k, imz) - fwb(i, j, k, imz)
   fmyb = fwb(i+1, j, k, imy) - fwb(i, j, k, imy)
   fmxb = fwb(i+1, j, k, imx) - fwb(i, j, k, imx)
   mul = por*(rlv(i, j, k)+rlv(i+1, j, k))
   mut = mul + mue
   tauzz = mut*(two*w_z-fracdiv)
   wbar = half*(w(i, j, k, ivz)+w(i+1, j, k, ivz))
   vbar = half*(w(i, j, k, ivy)+w(i+1, j, k, ivy))
   tauxx = mut*(two*u_x-fracdiv)
   tauxy = mut*(u_y+v_x)
   tauxz = mut*(u_z+w_x)
   ubar = half*(w(i, j, k, ivx)+w(i+1, j, k, ivx))
   tauyy = mut*(two*v_y-fracdiv)
   tauyz = mut*(v_z+w_y)
   tempb40 = si(i, j, k, 1)*frhoeb
   tempb41 = si(i, j, k, 2)*frhoeb
   tempb42 = si(i, j, k, 3)*frhoeb
   ubarb = tauxz*tempb42 + tauxy*tempb41 + tauxx*tempb40
   tauxxb = tauxxb + si(i, j, k, 1)*fmxb + ubar*tempb40
   vbarb = tauyz*tempb42 + tauyy*tempb41 + tauxy*tempb40
   tauxyb = tauxyb + si(i, j, k, 1)*fmyb + si(i, j, k, 2)*fmxb + &
   &           ubar*tempb41 + vbar*tempb40
   wbarb = tauzz*tempb42 + tauyz*tempb41 + tauxz*tempb40
   tauxzb = tauxzb + si(i, j, k, 1)*fmzb + si(i, j, k, 3)*fmxb + &
   &           ubar*tempb42 + wbar*tempb40
   sib(i, j, k, 1) = sib(i, j, k, 1) + (ubar*tauxx-q_x+vbar*tauxy&
   &           +wbar*tauxz)*frhoeb
   tauyyb = tauyyb + si(i, j, k, 2)*fmyb + vbar*tempb41
   tauyzb = tauyzb + si(i, j, k, 2)*fmzb + si(i, j, k, 3)*fmyb + &
   &           vbar*tempb42 + wbar*tempb41
   sib(i, j, k, 2) = sib(i, j, k, 2) + (ubar*tauxy-q_y+vbar*tauyy&
   &           +wbar*tauyz)*frhoeb
   tauzzb = tauzzb + si(i, j, k, 3)*fmzb + wbar*tempb42
   sib(i, j, k, 3) = sib(i, j, k, 3) + (ubar*tauxz-q_z+vbar*tauyz&
   &           +wbar*tauzz)*frhoeb
   q_xb = -(si(i, j, k, 1)*frhoeb)
   q_yb = -(si(i, j, k, 2)*frhoeb)
   q_zb = -(si(i, j, k, 3)*frhoeb)
   sib(i, j, k, 1) = sib(i, j, k, 1) + tauxz*fmzb
   sib(i, j, k, 2) = sib(i, j, k, 2) + tauyz*fmzb
   sib(i, j, k, 3) = sib(i, j, k, 3) + tauzz*fmzb
   sib(i, j, k, 1) = sib(i, j, k, 1) + tauxy*fmyb
   sib(i, j, k, 2) = sib(i, j, k, 2) + tauyy*fmyb
   sib(i, j, k, 3) = sib(i, j, k, 3) + tauyz*fmyb
   sib(i, j, k, 1) = sib(i, j, k, 1) + tauxx*fmxb
   sib(i, j, k, 2) = sib(i, j, k, 2) + tauxy*fmxb
   sib(i, j, k, 3) = sib(i, j, k, 3) + tauxz*fmxb
   wb(i, j, k, ivz) = wb(i, j, k, ivz) + half*wbarb
   wb(i+1, j, k, ivz) = wb(i+1, j, k, ivz) + half*wbarb
   wb(i, j, k, ivy) = wb(i, j, k, ivy) + half*vbarb
   wb(i+1, j, k, ivy) = wb(i+1, j, k, ivy) + half*vbarb
   wb(i, j, k, ivx) = wb(i, j, k, ivx) + half*ubarb
   wb(i+1, j, k, ivx) = wb(i+1, j, k, ivx) + half*ubarb
   gm1 = half*(gamma(i, j, k)+gamma(i+1, j, k)) - one
   factlamheat = one/(prandtl*gm1)
   factturbheat = one/(prandtlturb*gm1)
   heatcoef = mul*factlamheat + mue*factturbheat
   CALL POPREAL8(q_z)
   CALL POPREAL8(q_y)
   CALL POPREAL8(q_x)
   heatcoefb = q_y*q_yb + q_x*q_xb + q_z*q_zb
   q_zb = heatcoef*q_zb
   q_yb = heatcoef*q_yb
   q_xb = heatcoef*q_xb
   mutb = (u_z+w_x)*tauxzb + (two*w_z-fracdiv)*tauzzb + (two*u_x-&
   &           fracdiv)*tauxxb + (two*v_y-fracdiv)*tauyyb + (u_y+v_x)*&
   &           tauxyb + (v_z+w_y)*tauyzb
   v_zb = mut*tauyzb
   w_yb = mut*tauyzb
   u_zb = mut*tauxzb
   w_xb = mut*tauxzb
   u_yb = mut*tauxyb
   v_xb = mut*tauxyb
   fracdivb = -(mut*tauyyb) - mut*tauxxb - mut*tauzzb
   CALL POPREAL8(fracdiv)
   tempb43 = twothird*fracdivb
   w_zb = tempb43 + mut*two*tauzzb
   v_yb = tempb43 + mut*two*tauyyb
   u_xb = tempb43 + mut*two*tauxxb
   CALL POPREAL8(q_z)
   corrb = -(ssy*q_yb) - ssx*q_xb - ssz*q_zb
   sszb = q_z*corrb - corr*q_zb
   CALL POPREAL8(q_y)
   ssyb = q_y*corrb - corr*q_yb
   CALL POPREAL8(q_x)
   ssxb = q_x*corrb - corr*q_xb
   CALL POPREAL8(corr)
   q_xb = q_xb + ssx*corrb
   q_yb = q_yb + ssy*corrb
   q_zb = q_zb + ssz*corrb
   pb(i+1, j, k) = pb(i+1, j, k) + ss*corrb
   pb(i, j, k) = pb(i, j, k) - ss*corrb
   ssb = (p(i+1, j, k)-p(i, j, k))*corrb
   CALL POPREAL8(w_z)
   corrb = -(ssy*w_yb) - ssx*w_xb - ssz*w_zb
   sszb = sszb + w_z*corrb - corr*w_zb
   CALL POPREAL8(w_y)
   ssyb = ssyb + w_y*corrb - corr*w_yb
   CALL POPREAL8(w_x)
   ssxb = ssxb + w_x*corrb - corr*w_xb
   CALL POPREAL8(corr)
   w_xb = w_xb + ssx*corrb
   w_yb = w_yb + ssy*corrb
   w_zb = w_zb + ssz*corrb
   wb(i+1, j, k, ivz) = wb(i+1, j, k, ivz) - ss*corrb
   wb(i, j, k, ivz) = wb(i, j, k, ivz) + ss*corrb
   ssb = ssb - (w(i+1, j, k, ivz)-w(i, j, k, ivz))*corrb
   CALL POPREAL8(v_z)
   corrb = -(ssy*v_yb) - ssx*v_xb - ssz*v_zb
   sszb = sszb + v_z*corrb - corr*v_zb
   CALL POPREAL8(v_y)
   ssyb = ssyb + v_y*corrb - corr*v_yb
   CALL POPREAL8(v_x)
   ssxb = ssxb + v_x*corrb - corr*v_xb
   CALL POPREAL8(corr)
   v_xb = v_xb + ssx*corrb
   v_yb = v_yb + ssy*corrb
   v_zb = v_zb + ssz*corrb
   wb(i+1, j, k, ivy) = wb(i+1, j, k, ivy) - ss*corrb
   wb(i, j, k, ivy) = wb(i, j, k, ivy) + ss*corrb
   ssb = ssb - (w(i+1, j, k, ivy)-w(i, j, k, ivy))*corrb
   CALL POPREAL8(u_z)
   corrb = -(ssy*u_yb) - ssx*u_xb - ssz*u_zb
   sszb = sszb + u_z*corrb - corr*u_zb
   CALL POPREAL8(u_y)
   ssyb = ssyb + u_y*corrb - corr*u_yb
   CALL POPREAL8(u_x)
   ssxb = ssxb + u_x*corrb - corr*u_xb
   CALL POPREAL8(corr)
   u_xb = u_xb + ssx*corrb
   u_yb = u_yb + ssy*corrb
   u_zb = u_zb + ssz*corrb
   wb(i+1, j, k, ivx) = wb(i+1, j, k, ivx) - ss*corrb
   wb(i, j, k, ivx) = wb(i, j, k, ivx) + ss*corrb
   CALL POPREAL8(ssz)
   CALL POPREAL8(ssy)
   CALL POPREAL8(ssx)
   ssb = ssb + ssz*sszb + ssx*ssxb + ssy*ssyb - (w(i+1, j, k, ivx&
   &           )-w(i, j, k, ivx))*corrb
   temp4 = ssx**2 + ssy**2 + ssz**2
   temp5 = SQRT(temp4)
   IF (temp4 .EQ. 0.0_8) THEN
   tempb44 = 0.0
   ELSE
   tempb44 = -(one*ssb/(temp5**3*2.0))
   END IF
   sszb = 2*ssz*tempb44 + ss*sszb
   ssyb = 2*ssy*tempb44 + ss*ssyb
   ssxb = 2*ssx*tempb44 + ss*ssxb
   CALL POPREAL8(ss)
   CALL POPREAL8(ssz)
   tempb45 = eighth*sszb
   xb(i+1, j-1, k-1, 3) = xb(i+1, j-1, k-1, 3) + tempb45
   xb(i-1, j-1, k-1, 3) = xb(i-1, j-1, k-1, 3) - tempb45
   xb(i+1, j-1, k, 3) = xb(i+1, j-1, k, 3) + tempb45
   xb(i-1, j-1, k, 3) = xb(i-1, j-1, k, 3) - tempb45
   xb(i+1, j, k-1, 3) = xb(i+1, j, k-1, 3) + tempb45
   xb(i-1, j, k-1, 3) = xb(i-1, j, k-1, 3) - tempb45
   xb(i+1, j, k, 3) = xb(i+1, j, k, 3) + tempb45
   xb(i-1, j, k, 3) = xb(i-1, j, k, 3) - tempb45
   CALL POPREAL8(ssy)
   tempb46 = eighth*ssyb
   xb(i+1, j-1, k-1, 2) = xb(i+1, j-1, k-1, 2) + tempb46
   xb(i-1, j-1, k-1, 2) = xb(i-1, j-1, k-1, 2) - tempb46
   xb(i+1, j-1, k, 2) = xb(i+1, j-1, k, 2) + tempb46
   xb(i-1, j-1, k, 2) = xb(i-1, j-1, k, 2) - tempb46
   xb(i+1, j, k-1, 2) = xb(i+1, j, k-1, 2) + tempb46
   xb(i-1, j, k-1, 2) = xb(i-1, j, k-1, 2) - tempb46
   xb(i+1, j, k, 2) = xb(i+1, j, k, 2) + tempb46
   xb(i-1, j, k, 2) = xb(i-1, j, k, 2) - tempb46
   CALL POPREAL8(ssx)
   tempb47 = eighth*ssxb
   xb(i+1, j-1, k-1, 1) = xb(i+1, j-1, k-1, 1) + tempb47
   xb(i-1, j-1, k-1, 1) = xb(i-1, j-1, k-1, 1) - tempb47
   xb(i+1, j-1, k, 1) = xb(i+1, j-1, k, 1) + tempb47
   xb(i-1, j-1, k, 1) = xb(i-1, j-1, k, 1) - tempb47
   xb(i+1, j, k-1, 1) = xb(i+1, j, k-1, 1) + tempb47
   xb(i-1, j, k-1, 1) = xb(i-1, j, k-1, 1) - tempb47
   xb(i+1, j, k, 1) = xb(i+1, j, k, 1) + tempb47
   xb(i-1, j, k, 1) = xb(i-1, j, k, 1) - tempb47
   CALL POPREAL8(q_z)
   tempb48 = fourth*q_zb
   qzb(i, j-1, k-1) = qzb(i, j-1, k-1) + tempb48
   qzb(i, j, k-1) = qzb(i, j, k-1) + tempb48
   qzb(i, j-1, k) = qzb(i, j-1, k) + tempb48
   qzb(i, j, k) = qzb(i, j, k) + tempb48
   CALL POPREAL8(q_y)
   tempb49 = fourth*q_yb
   qyb(i, j-1, k-1) = qyb(i, j-1, k-1) + tempb49
   qyb(i, j, k-1) = qyb(i, j, k-1) + tempb49
   qyb(i, j-1, k) = qyb(i, j-1, k) + tempb49
   qyb(i, j, k) = qyb(i, j, k) + tempb49
   CALL POPREAL8(q_x)
   tempb50 = fourth*q_xb
   qxb(i, j-1, k-1) = qxb(i, j-1, k-1) + tempb50
   qxb(i, j, k-1) = qxb(i, j, k-1) + tempb50
   qxb(i, j-1, k) = qxb(i, j-1, k) + tempb50
   qxb(i, j, k) = qxb(i, j, k) + tempb50
   CALL POPREAL8(w_z)
   tempb51 = fourth*w_zb
   wzb(i, j-1, k-1) = wzb(i, j-1, k-1) + tempb51
   wzb(i, j, k-1) = wzb(i, j, k-1) + tempb51
   wzb(i, j-1, k) = wzb(i, j-1, k) + tempb51
   wzb(i, j, k) = wzb(i, j, k) + tempb51
   CALL POPREAL8(w_y)
   tempb52 = fourth*w_yb
   wyb(i, j-1, k-1) = wyb(i, j-1, k-1) + tempb52
   wyb(i, j, k-1) = wyb(i, j, k-1) + tempb52
   wyb(i, j-1, k) = wyb(i, j-1, k) + tempb52
   wyb(i, j, k) = wyb(i, j, k) + tempb52
   CALL POPREAL8(w_x)
   tempb53 = fourth*w_xb
   wxb(i, j-1, k-1) = wxb(i, j-1, k-1) + tempb53
   wxb(i, j, k-1) = wxb(i, j, k-1) + tempb53
   wxb(i, j-1, k) = wxb(i, j-1, k) + tempb53
   wxb(i, j, k) = wxb(i, j, k) + tempb53
   CALL POPREAL8(v_z)
   tempb54 = fourth*v_zb
   vzb(i, j-1, k-1) = vzb(i, j-1, k-1) + tempb54
   vzb(i, j, k-1) = vzb(i, j, k-1) + tempb54
   vzb(i, j-1, k) = vzb(i, j-1, k) + tempb54
   vzb(i, j, k) = vzb(i, j, k) + tempb54
   CALL POPREAL8(v_y)
   tempb55 = fourth*v_yb
   vyb(i, j-1, k-1) = vyb(i, j-1, k-1) + tempb55
   vyb(i, j, k-1) = vyb(i, j, k-1) + tempb55
   vyb(i, j-1, k) = vyb(i, j-1, k) + tempb55
   vyb(i, j, k) = vyb(i, j, k) + tempb55
   CALL POPREAL8(v_x)
   tempb56 = fourth*v_xb
   vxb(i, j-1, k-1) = vxb(i, j-1, k-1) + tempb56
   vxb(i, j, k-1) = vxb(i, j, k-1) + tempb56
   vxb(i, j-1, k) = vxb(i, j-1, k) + tempb56
   vxb(i, j, k) = vxb(i, j, k) + tempb56
   CALL POPREAL8(u_z)
   tempb57 = fourth*u_zb
   uzb(i, j-1, k-1) = uzb(i, j-1, k-1) + tempb57
   uzb(i, j, k-1) = uzb(i, j, k-1) + tempb57
   uzb(i, j-1, k) = uzb(i, j-1, k) + tempb57
   uzb(i, j, k) = uzb(i, j, k) + tempb57
   CALL POPREAL8(u_y)
   tempb58 = fourth*u_yb
   uyb(i, j-1, k-1) = uyb(i, j-1, k-1) + tempb58
   uyb(i, j, k-1) = uyb(i, j, k-1) + tempb58
   uyb(i, j-1, k) = uyb(i, j-1, k) + tempb58
   uyb(i, j, k) = uyb(i, j, k) + tempb58
   CALL POPREAL8(u_x)
   tempb59 = fourth*u_xb
   uxb(i, j-1, k-1) = uxb(i, j-1, k-1) + tempb59
   uxb(i, j, k-1) = uxb(i, j, k-1) + tempb59
   uxb(i, j-1, k) = uxb(i, j-1, k) + tempb59
   uxb(i, j, k) = uxb(i, j, k) + tempb59
   mulb = mutb + factlamheat*heatcoefb
   factlamheatb = mul*heatcoefb
   mueb = mueb + mutb + factturbheat*heatcoefb
   factturbheatb = mue*heatcoefb
   gm1b = -(one*factlamheatb/(prandtl*gm1**2)) - one*&
   &           factturbheatb/(prandtlturb*gm1**2)
   gammab(i, j, k) = gammab(i, j, k) + half*gm1b
   gammab(i+1, j, k) = gammab(i+1, j, k) + half*gm1b
   CALL POPREAL8(mut)
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   CALL POPREAL8(mue)
   revb(i, j, k) = revb(i, j, k) + por*mueb
   revb(i+1, j, k) = revb(i+1, j, k) + por*mueb
   mueb = 0.0_8
   END IF
   rlvb(i, j, k) = rlvb(i, j, k) + por*mulb
   rlvb(i+1, j, k) = rlvb(i+1, j, k) + por*mulb
   CALL POPREAL8(por)
   END DO
   END DO
   END DO
   DO k=kl,2,-1
   DO j=jl,1,-1
   DO i=il,2,-1
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   tauzzb = 0.0_8
   tauxxb = 0.0_8
   tauxyb = 0.0_8
   tauxzb = 0.0_8
   tauyyb = 0.0_8
   tauyzb = 0.0_8
   ELSE
   tauyzb = viscsubfaceb(viscjmaxpointer(i, k))%tau(i, k, 6)
   viscsubfaceb(viscjmaxpointer(i, k))%tau(i, k, 6) = 0.0_8
   tauxzb = viscsubfaceb(viscjmaxpointer(i, k))%tau(i, k, 5)
   viscsubfaceb(viscjmaxpointer(i, k))%tau(i, k, 5) = 0.0_8
   tauxyb = viscsubfaceb(viscjmaxpointer(i, k))%tau(i, k, 4)
   viscsubfaceb(viscjmaxpointer(i, k))%tau(i, k, 4) = 0.0_8
   tauzzb = viscsubfaceb(viscjmaxpointer(i, k))%tau(i, k, 3)
   viscsubfaceb(viscjmaxpointer(i, k))%tau(i, k, 3) = 0.0_8
   tauyyb = viscsubfaceb(viscjmaxpointer(i, k))%tau(i, k, 2)
   viscsubfaceb(viscjmaxpointer(i, k))%tau(i, k, 2) = 0.0_8
   tauxxb = viscsubfaceb(viscjmaxpointer(i, k))%tau(i, k, 1)
   viscsubfaceb(viscjmaxpointer(i, k))%tau(i, k, 1) = 0.0_8
   END IF
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   tauyzb = tauyzb + viscsubfaceb(viscjminpointer(i, k))%tau(i&
   &             , k, 6)
   viscsubfaceb(viscjminpointer(i, k))%tau(i, k, 6) = 0.0_8
   tauxzb = tauxzb + viscsubfaceb(viscjminpointer(i, k))%tau(i&
   &             , k, 5)
   viscsubfaceb(viscjminpointer(i, k))%tau(i, k, 5) = 0.0_8
   tauxyb = tauxyb + viscsubfaceb(viscjminpointer(i, k))%tau(i&
   &             , k, 4)
   viscsubfaceb(viscjminpointer(i, k))%tau(i, k, 4) = 0.0_8
   tauzzb = tauzzb + viscsubfaceb(viscjminpointer(i, k))%tau(i&
   &             , k, 3)
   viscsubfaceb(viscjminpointer(i, k))%tau(i, k, 3) = 0.0_8
   tauyyb = tauyyb + viscsubfaceb(viscjminpointer(i, k))%tau(i&
   &             , k, 2)
   viscsubfaceb(viscjminpointer(i, k))%tau(i, k, 2) = 0.0_8
   tauxxb = tauxxb + viscsubfaceb(viscjminpointer(i, k))%tau(i&
   &             , k, 1)
   viscsubfaceb(viscjminpointer(i, k))%tau(i, k, 1) = 0.0_8
   END IF
   frhoeb = fwb(i, j+1, k, irhoe) - fwb(i, j, k, irhoe)
   fmzb = fwb(i, j+1, k, imz) - fwb(i, j, k, imz)
   fmyb = fwb(i, j+1, k, imy) - fwb(i, j, k, imy)
   fmxb = fwb(i, j+1, k, imx) - fwb(i, j, k, imx)
   mul = por*(rlv(i, j, k)+rlv(i, j+1, k))
   mut = mul + mue
   tauzz = mut*(two*w_z-fracdiv)
   wbar = half*(w(i, j, k, ivz)+w(i, j+1, k, ivz))
   vbar = half*(w(i, j, k, ivy)+w(i, j+1, k, ivy))
   tauxx = mut*(two*u_x-fracdiv)
   tauxy = mut*(u_y+v_x)
   tauxz = mut*(u_z+w_x)
   ubar = half*(w(i, j, k, ivx)+w(i, j+1, k, ivx))
   tauyy = mut*(two*v_y-fracdiv)
   tauyz = mut*(v_z+w_y)
   tempb20 = sj(i, j, k, 1)*frhoeb
   tempb21 = sj(i, j, k, 2)*frhoeb
   tempb22 = sj(i, j, k, 3)*frhoeb
   ubarb = tauxz*tempb22 + tauxy*tempb21 + tauxx*tempb20
   tauxxb = tauxxb + sj(i, j, k, 1)*fmxb + ubar*tempb20
   vbarb = tauyz*tempb22 + tauyy*tempb21 + tauxy*tempb20
   tauxyb = tauxyb + sj(i, j, k, 1)*fmyb + sj(i, j, k, 2)*fmxb + &
   &           ubar*tempb21 + vbar*tempb20
   wbarb = tauzz*tempb22 + tauyz*tempb21 + tauxz*tempb20
   tauxzb = tauxzb + sj(i, j, k, 1)*fmzb + sj(i, j, k, 3)*fmxb + &
   &           ubar*tempb22 + wbar*tempb20
   sjb(i, j, k, 1) = sjb(i, j, k, 1) + (ubar*tauxx-q_x+vbar*tauxy&
   &           +wbar*tauxz)*frhoeb
   tauyyb = tauyyb + sj(i, j, k, 2)*fmyb + vbar*tempb21
   tauyzb = tauyzb + sj(i, j, k, 2)*fmzb + sj(i, j, k, 3)*fmyb + &
   &           vbar*tempb22 + wbar*tempb21
   sjb(i, j, k, 2) = sjb(i, j, k, 2) + (ubar*tauxy-q_y+vbar*tauyy&
   &           +wbar*tauyz)*frhoeb
   tauzzb = tauzzb + sj(i, j, k, 3)*fmzb + wbar*tempb22
   sjb(i, j, k, 3) = sjb(i, j, k, 3) + (ubar*tauxz-q_z+vbar*tauyz&
   &           +wbar*tauzz)*frhoeb
   q_xb = -(sj(i, j, k, 1)*frhoeb)
   q_yb = -(sj(i, j, k, 2)*frhoeb)
   q_zb = -(sj(i, j, k, 3)*frhoeb)
   sjb(i, j, k, 1) = sjb(i, j, k, 1) + tauxz*fmzb
   sjb(i, j, k, 2) = sjb(i, j, k, 2) + tauyz*fmzb
   sjb(i, j, k, 3) = sjb(i, j, k, 3) + tauzz*fmzb
   sjb(i, j, k, 1) = sjb(i, j, k, 1) + tauxy*fmyb
   sjb(i, j, k, 2) = sjb(i, j, k, 2) + tauyy*fmyb
   sjb(i, j, k, 3) = sjb(i, j, k, 3) + tauyz*fmyb
   sjb(i, j, k, 1) = sjb(i, j, k, 1) + tauxx*fmxb
   sjb(i, j, k, 2) = sjb(i, j, k, 2) + tauxy*fmxb
   sjb(i, j, k, 3) = sjb(i, j, k, 3) + tauxz*fmxb
   wb(i, j, k, ivz) = wb(i, j, k, ivz) + half*wbarb
   wb(i, j+1, k, ivz) = wb(i, j+1, k, ivz) + half*wbarb
   wb(i, j, k, ivy) = wb(i, j, k, ivy) + half*vbarb
   wb(i, j+1, k, ivy) = wb(i, j+1, k, ivy) + half*vbarb
   wb(i, j, k, ivx) = wb(i, j, k, ivx) + half*ubarb
   wb(i, j+1, k, ivx) = wb(i, j+1, k, ivx) + half*ubarb
   gm1 = half*(gamma(i, j, k)+gamma(i, j+1, k)) - one
   factlamheat = one/(prandtl*gm1)
   factturbheat = one/(prandtlturb*gm1)
   heatcoef = mul*factlamheat + mue*factturbheat
   CALL POPREAL8(q_z)
   CALL POPREAL8(q_y)
   CALL POPREAL8(q_x)
   heatcoefb = q_y*q_yb + q_x*q_xb + q_z*q_zb
   q_zb = heatcoef*q_zb
   q_yb = heatcoef*q_yb
   q_xb = heatcoef*q_xb
   mutb = (u_z+w_x)*tauxzb + (two*w_z-fracdiv)*tauzzb + (two*u_x-&
   &           fracdiv)*tauxxb + (two*v_y-fracdiv)*tauyyb + (u_y+v_x)*&
   &           tauxyb + (v_z+w_y)*tauyzb
   v_zb = mut*tauyzb
   w_yb = mut*tauyzb
   u_zb = mut*tauxzb
   w_xb = mut*tauxzb
   u_yb = mut*tauxyb
   v_xb = mut*tauxyb
   fracdivb = -(mut*tauyyb) - mut*tauxxb - mut*tauzzb
   CALL POPREAL8(fracdiv)
   tempb23 = twothird*fracdivb
   w_zb = tempb23 + mut*two*tauzzb
   v_yb = tempb23 + mut*two*tauyyb
   u_xb = tempb23 + mut*two*tauxxb
   CALL POPREAL8(q_z)
   corrb = -(ssy*q_yb) - ssx*q_xb - ssz*q_zb
   sszb = q_z*corrb - corr*q_zb
   CALL POPREAL8(q_y)
   ssyb = q_y*corrb - corr*q_yb
   CALL POPREAL8(q_x)
   ssxb = q_x*corrb - corr*q_xb
   CALL POPREAL8(corr)
   q_xb = q_xb + ssx*corrb
   q_yb = q_yb + ssy*corrb
   q_zb = q_zb + ssz*corrb
   pb(i, j+1, k) = pb(i, j+1, k) + ss*corrb
   pb(i, j, k) = pb(i, j, k) - ss*corrb
   ssb = (p(i, j+1, k)-p(i, j, k))*corrb
   CALL POPREAL8(w_z)
   corrb = -(ssy*w_yb) - ssx*w_xb - ssz*w_zb
   sszb = sszb + w_z*corrb - corr*w_zb
   CALL POPREAL8(w_y)
   ssyb = ssyb + w_y*corrb - corr*w_yb
   CALL POPREAL8(w_x)
   ssxb = ssxb + w_x*corrb - corr*w_xb
   CALL POPREAL8(corr)
   w_xb = w_xb + ssx*corrb
   w_yb = w_yb + ssy*corrb
   w_zb = w_zb + ssz*corrb
   wb(i, j+1, k, ivz) = wb(i, j+1, k, ivz) - ss*corrb
   wb(i, j, k, ivz) = wb(i, j, k, ivz) + ss*corrb
   ssb = ssb - (w(i, j+1, k, ivz)-w(i, j, k, ivz))*corrb
   CALL POPREAL8(v_z)
   corrb = -(ssy*v_yb) - ssx*v_xb - ssz*v_zb
   sszb = sszb + v_z*corrb - corr*v_zb
   CALL POPREAL8(v_y)
   ssyb = ssyb + v_y*corrb - corr*v_yb
   CALL POPREAL8(v_x)
   ssxb = ssxb + v_x*corrb - corr*v_xb
   CALL POPREAL8(corr)
   v_xb = v_xb + ssx*corrb
   v_yb = v_yb + ssy*corrb
   v_zb = v_zb + ssz*corrb
   wb(i, j+1, k, ivy) = wb(i, j+1, k, ivy) - ss*corrb
   wb(i, j, k, ivy) = wb(i, j, k, ivy) + ss*corrb
   ssb = ssb - (w(i, j+1, k, ivy)-w(i, j, k, ivy))*corrb
   CALL POPREAL8(u_z)
   corrb = -(ssy*u_yb) - ssx*u_xb - ssz*u_zb
   sszb = sszb + u_z*corrb - corr*u_zb
   CALL POPREAL8(u_y)
   ssyb = ssyb + u_y*corrb - corr*u_yb
   CALL POPREAL8(u_x)
   ssxb = ssxb + u_x*corrb - corr*u_xb
   CALL POPREAL8(corr)
   u_xb = u_xb + ssx*corrb
   u_yb = u_yb + ssy*corrb
   u_zb = u_zb + ssz*corrb
   wb(i, j+1, k, ivx) = wb(i, j+1, k, ivx) - ss*corrb
   wb(i, j, k, ivx) = wb(i, j, k, ivx) + ss*corrb
   CALL POPREAL8(ssz)
   CALL POPREAL8(ssy)
   CALL POPREAL8(ssx)
   ssb = ssb + ssz*sszb + ssx*ssxb + ssy*ssyb - (w(i, j+1, k, ivx&
   &           )-w(i, j, k, ivx))*corrb
   temp2 = ssx**2 + ssy**2 + ssz**2
   temp3 = SQRT(temp2)
   IF (temp2 .EQ. 0.0_8) THEN
   tempb24 = 0.0
   ELSE
   tempb24 = -(one*ssb/(temp3**3*2.0))
   END IF
   sszb = 2*ssz*tempb24 + ss*sszb
   ssyb = 2*ssy*tempb24 + ss*ssyb
   ssxb = 2*ssx*tempb24 + ss*ssxb
   CALL POPREAL8(ss)
   CALL POPREAL8(ssz)
   tempb25 = eighth*sszb
   xb(i-1, j+1, k-1, 3) = xb(i-1, j+1, k-1, 3) + tempb25
   xb(i-1, j-1, k-1, 3) = xb(i-1, j-1, k-1, 3) - tempb25
   xb(i-1, j+1, k, 3) = xb(i-1, j+1, k, 3) + tempb25
   xb(i-1, j-1, k, 3) = xb(i-1, j-1, k, 3) - tempb25
   xb(i, j+1, k-1, 3) = xb(i, j+1, k-1, 3) + tempb25
   xb(i, j-1, k-1, 3) = xb(i, j-1, k-1, 3) - tempb25
   xb(i, j+1, k, 3) = xb(i, j+1, k, 3) + tempb25
   xb(i, j-1, k, 3) = xb(i, j-1, k, 3) - tempb25
   CALL POPREAL8(ssy)
   tempb26 = eighth*ssyb
   xb(i-1, j+1, k-1, 2) = xb(i-1, j+1, k-1, 2) + tempb26
   xb(i-1, j-1, k-1, 2) = xb(i-1, j-1, k-1, 2) - tempb26
   xb(i-1, j+1, k, 2) = xb(i-1, j+1, k, 2) + tempb26
   xb(i-1, j-1, k, 2) = xb(i-1, j-1, k, 2) - tempb26
   xb(i, j+1, k-1, 2) = xb(i, j+1, k-1, 2) + tempb26
   xb(i, j-1, k-1, 2) = xb(i, j-1, k-1, 2) - tempb26
   xb(i, j+1, k, 2) = xb(i, j+1, k, 2) + tempb26
   xb(i, j-1, k, 2) = xb(i, j-1, k, 2) - tempb26
   CALL POPREAL8(ssx)
   tempb27 = eighth*ssxb
   xb(i-1, j+1, k-1, 1) = xb(i-1, j+1, k-1, 1) + tempb27
   xb(i-1, j-1, k-1, 1) = xb(i-1, j-1, k-1, 1) - tempb27
   xb(i-1, j+1, k, 1) = xb(i-1, j+1, k, 1) + tempb27
   xb(i-1, j-1, k, 1) = xb(i-1, j-1, k, 1) - tempb27
   xb(i, j+1, k-1, 1) = xb(i, j+1, k-1, 1) + tempb27
   xb(i, j-1, k-1, 1) = xb(i, j-1, k-1, 1) - tempb27
   xb(i, j+1, k, 1) = xb(i, j+1, k, 1) + tempb27
   xb(i, j-1, k, 1) = xb(i, j-1, k, 1) - tempb27
   CALL POPREAL8(q_z)
   tempb28 = fourth*q_zb
   qzb(i-1, j, k-1) = qzb(i-1, j, k-1) + tempb28
   qzb(i, j, k-1) = qzb(i, j, k-1) + tempb28
   qzb(i-1, j, k) = qzb(i-1, j, k) + tempb28
   qzb(i, j, k) = qzb(i, j, k) + tempb28
   CALL POPREAL8(q_y)
   tempb29 = fourth*q_yb
   qyb(i-1, j, k-1) = qyb(i-1, j, k-1) + tempb29
   qyb(i, j, k-1) = qyb(i, j, k-1) + tempb29
   qyb(i-1, j, k) = qyb(i-1, j, k) + tempb29
   qyb(i, j, k) = qyb(i, j, k) + tempb29
   CALL POPREAL8(q_x)
   tempb30 = fourth*q_xb
   qxb(i-1, j, k-1) = qxb(i-1, j, k-1) + tempb30
   qxb(i, j, k-1) = qxb(i, j, k-1) + tempb30
   qxb(i-1, j, k) = qxb(i-1, j, k) + tempb30
   qxb(i, j, k) = qxb(i, j, k) + tempb30
   CALL POPREAL8(w_z)
   tempb31 = fourth*w_zb
   wzb(i-1, j, k-1) = wzb(i-1, j, k-1) + tempb31
   wzb(i, j, k-1) = wzb(i, j, k-1) + tempb31
   wzb(i-1, j, k) = wzb(i-1, j, k) + tempb31
   wzb(i, j, k) = wzb(i, j, k) + tempb31
   CALL POPREAL8(w_y)
   tempb32 = fourth*w_yb
   wyb(i-1, j, k-1) = wyb(i-1, j, k-1) + tempb32
   wyb(i, j, k-1) = wyb(i, j, k-1) + tempb32
   wyb(i-1, j, k) = wyb(i-1, j, k) + tempb32
   wyb(i, j, k) = wyb(i, j, k) + tempb32
   CALL POPREAL8(w_x)
   tempb33 = fourth*w_xb
   wxb(i-1, j, k-1) = wxb(i-1, j, k-1) + tempb33
   wxb(i, j, k-1) = wxb(i, j, k-1) + tempb33
   wxb(i-1, j, k) = wxb(i-1, j, k) + tempb33
   wxb(i, j, k) = wxb(i, j, k) + tempb33
   CALL POPREAL8(v_z)
   tempb34 = fourth*v_zb
   vzb(i-1, j, k-1) = vzb(i-1, j, k-1) + tempb34
   vzb(i, j, k-1) = vzb(i, j, k-1) + tempb34
   vzb(i-1, j, k) = vzb(i-1, j, k) + tempb34
   vzb(i, j, k) = vzb(i, j, k) + tempb34
   CALL POPREAL8(v_y)
   tempb35 = fourth*v_yb
   vyb(i-1, j, k-1) = vyb(i-1, j, k-1) + tempb35
   vyb(i, j, k-1) = vyb(i, j, k-1) + tempb35
   vyb(i-1, j, k) = vyb(i-1, j, k) + tempb35
   vyb(i, j, k) = vyb(i, j, k) + tempb35
   CALL POPREAL8(v_x)
   tempb36 = fourth*v_xb
   vxb(i-1, j, k-1) = vxb(i-1, j, k-1) + tempb36
   vxb(i, j, k-1) = vxb(i, j, k-1) + tempb36
   vxb(i-1, j, k) = vxb(i-1, j, k) + tempb36
   vxb(i, j, k) = vxb(i, j, k) + tempb36
   CALL POPREAL8(u_z)
   tempb37 = fourth*u_zb
   uzb(i-1, j, k-1) = uzb(i-1, j, k-1) + tempb37
   uzb(i, j, k-1) = uzb(i, j, k-1) + tempb37
   uzb(i-1, j, k) = uzb(i-1, j, k) + tempb37
   uzb(i, j, k) = uzb(i, j, k) + tempb37
   CALL POPREAL8(u_y)
   tempb38 = fourth*u_yb
   uyb(i-1, j, k-1) = uyb(i-1, j, k-1) + tempb38
   uyb(i, j, k-1) = uyb(i, j, k-1) + tempb38
   uyb(i-1, j, k) = uyb(i-1, j, k) + tempb38
   uyb(i, j, k) = uyb(i, j, k) + tempb38
   CALL POPREAL8(u_x)
   tempb39 = fourth*u_xb
   uxb(i-1, j, k-1) = uxb(i-1, j, k-1) + tempb39
   uxb(i, j, k-1) = uxb(i, j, k-1) + tempb39
   uxb(i-1, j, k) = uxb(i-1, j, k) + tempb39
   uxb(i, j, k) = uxb(i, j, k) + tempb39
   mulb = mutb + factlamheat*heatcoefb
   factlamheatb = mul*heatcoefb
   mueb = mueb + mutb + factturbheat*heatcoefb
   factturbheatb = mue*heatcoefb
   gm1b = -(one*factlamheatb/(prandtl*gm1**2)) - one*&
   &           factturbheatb/(prandtlturb*gm1**2)
   gammab(i, j, k) = gammab(i, j, k) + half*gm1b
   gammab(i, j+1, k) = gammab(i, j+1, k) + half*gm1b
   CALL POPREAL8(mut)
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   CALL POPREAL8(mue)
   revb(i, j, k) = revb(i, j, k) + por*mueb
   revb(i, j+1, k) = revb(i, j+1, k) + por*mueb
   mueb = 0.0_8
   END IF
   rlvb(i, j, k) = rlvb(i, j, k) + por*mulb
   rlvb(i, j+1, k) = rlvb(i, j+1, k) + por*mulb
   CALL POPREAL8(por)
   END DO
   END DO
   END DO
   DO k=kl,1,-1
   DO j=jl,2,-1
   DO i=il,2,-1
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   tauzzb = 0.0_8
   tauxxb = 0.0_8
   tauxyb = 0.0_8
   tauxzb = 0.0_8
   tauyyb = 0.0_8
   tauyzb = 0.0_8
   ELSE
   tauyzb = viscsubfaceb(visckmaxpointer(i, j))%tau(i, j, 6)
   viscsubfaceb(visckmaxpointer(i, j))%tau(i, j, 6) = 0.0_8
   tauxzb = viscsubfaceb(visckmaxpointer(i, j))%tau(i, j, 5)
   viscsubfaceb(visckmaxpointer(i, j))%tau(i, j, 5) = 0.0_8
   tauxyb = viscsubfaceb(visckmaxpointer(i, j))%tau(i, j, 4)
   viscsubfaceb(visckmaxpointer(i, j))%tau(i, j, 4) = 0.0_8
   tauzzb = viscsubfaceb(visckmaxpointer(i, j))%tau(i, j, 3)
   viscsubfaceb(visckmaxpointer(i, j))%tau(i, j, 3) = 0.0_8
   tauyyb = viscsubfaceb(visckmaxpointer(i, j))%tau(i, j, 2)
   viscsubfaceb(visckmaxpointer(i, j))%tau(i, j, 2) = 0.0_8
   tauxxb = viscsubfaceb(visckmaxpointer(i, j))%tau(i, j, 1)
   viscsubfaceb(visckmaxpointer(i, j))%tau(i, j, 1) = 0.0_8
   END IF
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   tauyzb = tauyzb + viscsubfaceb(visckminpointer(i, j))%tau(i&
   &             , j, 6)
   viscsubfaceb(visckminpointer(i, j))%tau(i, j, 6) = 0.0_8
   tauxzb = tauxzb + viscsubfaceb(visckminpointer(i, j))%tau(i&
   &             , j, 5)
   viscsubfaceb(visckminpointer(i, j))%tau(i, j, 5) = 0.0_8
   tauxyb = tauxyb + viscsubfaceb(visckminpointer(i, j))%tau(i&
   &             , j, 4)
   viscsubfaceb(visckminpointer(i, j))%tau(i, j, 4) = 0.0_8
   tauzzb = tauzzb + viscsubfaceb(visckminpointer(i, j))%tau(i&
   &             , j, 3)
   viscsubfaceb(visckminpointer(i, j))%tau(i, j, 3) = 0.0_8
   tauyyb = tauyyb + viscsubfaceb(visckminpointer(i, j))%tau(i&
   &             , j, 2)
   viscsubfaceb(visckminpointer(i, j))%tau(i, j, 2) = 0.0_8
   tauxxb = tauxxb + viscsubfaceb(visckminpointer(i, j))%tau(i&
   &             , j, 1)
   viscsubfaceb(visckminpointer(i, j))%tau(i, j, 1) = 0.0_8
   END IF
   frhoeb = fwb(i, j, k+1, irhoe) - fwb(i, j, k, irhoe)
   fmzb = fwb(i, j, k+1, imz) - fwb(i, j, k, imz)
   fmyb = fwb(i, j, k+1, imy) - fwb(i, j, k, imy)
   fmxb = fwb(i, j, k+1, imx) - fwb(i, j, k, imx)
   q_xb = -(sk(i, j, k, 1)*frhoeb)
   skb(i, j, k, 1) = skb(i, j, k, 1) - q_x*frhoeb
   q_yb = -(sk(i, j, k, 2)*frhoeb)
   skb(i, j, k, 2) = skb(i, j, k, 2) - q_y*frhoeb
   q_zb = -(sk(i, j, k, 3)*frhoeb)
   skb(i, j, k, 3) = skb(i, j, k, 3) - q_z*frhoeb
   mul = por*(rlv(i, j, k)+rlv(i, j, k+1))
   mut = mul + mue
   tauzz = mut*(two*w_z-fracdiv)
   wbar = half*(w(i, j, k, ivz)+w(i, j, k+1, ivz))
   vbar = half*(w(i, j, k, ivy)+w(i, j, k+1, ivy))
   tauxz = mut*(u_z+w_x)
   ubar = half*(w(i, j, k, ivx)+w(i, j, k+1, ivx))
   tauyz = mut*(v_z+w_y)
   tempb0 = sk(i, j, k, 3)*frhoeb
   tauzzb = tauzzb + sk(i, j, k, 3)*fmzb + wbar*tempb0
   skb(i, j, k, 3) = skb(i, j, k, 3) + (ubar*tauxz+vbar*tauyz+&
   &           wbar*tauzz)*frhoeb
   tauxy = mut*(u_y+v_x)
   tauyy = mut*(two*v_y-fracdiv)
   tempb1 = sk(i, j, k, 2)*frhoeb
   tauyzb = tauyzb + wbar*tempb1 + sk(i, j, k, 3)*fmyb + sk(i, j&
   &           , k, 2)*fmzb + vbar*tempb0
   tauyyb = tauyyb + sk(i, j, k, 2)*fmyb + vbar*tempb1
   skb(i, j, k, 2) = skb(i, j, k, 2) + (ubar*tauxy+vbar*tauyy+&
   &           wbar*tauyz)*frhoeb
   tauxx = mut*(two*u_x-fracdiv)
   tempb2 = sk(i, j, k, 1)*frhoeb
   ubarb = tauxy*tempb1 + tauxx*tempb2 + tauxz*tempb0
   tauxzb = tauxzb + wbar*tempb2 + sk(i, j, k, 3)*fmxb + sk(i, j&
   &           , k, 1)*fmzb + ubar*tempb0
   vbarb = tauyy*tempb1 + tauxy*tempb2 + tauyz*tempb0
   wbarb = tauyz*tempb1 + tauxz*tempb2 + tauzz*tempb0
   tauxyb = tauxyb + vbar*tempb2 + sk(i, j, k, 2)*fmxb + sk(i, j&
   &           , k, 1)*fmyb + ubar*tempb1
   tauxxb = tauxxb + sk(i, j, k, 1)*fmxb + ubar*tempb2
   skb(i, j, k, 1) = skb(i, j, k, 1) + (ubar*tauxx+vbar*tauxy+&
   &           wbar*tauxz)*frhoeb
   skb(i, j, k, 1) = skb(i, j, k, 1) + tauxz*fmzb
   skb(i, j, k, 2) = skb(i, j, k, 2) + tauyz*fmzb
   skb(i, j, k, 3) = skb(i, j, k, 3) + tauzz*fmzb
   skb(i, j, k, 1) = skb(i, j, k, 1) + tauxy*fmyb
   skb(i, j, k, 2) = skb(i, j, k, 2) + tauyy*fmyb
   skb(i, j, k, 3) = skb(i, j, k, 3) + tauyz*fmyb
   skb(i, j, k, 1) = skb(i, j, k, 1) + tauxx*fmxb
   skb(i, j, k, 2) = skb(i, j, k, 2) + tauxy*fmxb
   skb(i, j, k, 3) = skb(i, j, k, 3) + tauxz*fmxb
   wb(i, j, k, ivz) = wb(i, j, k, ivz) + half*wbarb
   wb(i, j, k+1, ivz) = wb(i, j, k+1, ivz) + half*wbarb
   wb(i, j, k, ivy) = wb(i, j, k, ivy) + half*vbarb
   wb(i, j, k+1, ivy) = wb(i, j, k+1, ivy) + half*vbarb
   wb(i, j, k, ivx) = wb(i, j, k, ivx) + half*ubarb
   wb(i, j, k+1, ivx) = wb(i, j, k+1, ivx) + half*ubarb
   gm1 = half*(gamma(i, j, k)+gamma(i, j, k+1)) - one
   factlamheat = one/(prandtl*gm1)
   factturbheat = one/(prandtlturb*gm1)
   heatcoef = mul*factlamheat + mue*factturbheat
   CALL POPREAL8(q_z)
   CALL POPREAL8(q_y)
   CALL POPREAL8(q_x)
   heatcoefb = q_y*q_yb + q_x*q_xb + q_z*q_zb
   q_zb = heatcoef*q_zb
   q_yb = heatcoef*q_yb
   q_xb = heatcoef*q_xb
   mutb = (u_z+w_x)*tauxzb + (two*w_z-fracdiv)*tauzzb + (two*u_x-&
   &           fracdiv)*tauxxb + (two*v_y-fracdiv)*tauyyb + (u_y+v_x)*&
   &           tauxyb + (v_z+w_y)*tauyzb
   v_zb = mut*tauyzb
   w_yb = mut*tauyzb
   u_zb = mut*tauxzb
   w_xb = mut*tauxzb
   u_yb = mut*tauxyb
   v_xb = mut*tauxyb
   fracdivb = -(mut*tauyyb) - mut*tauxxb - mut*tauzzb
   CALL POPREAL8(fracdiv)
   tempb3 = twothird*fracdivb
   w_zb = tempb3 + mut*two*tauzzb
   v_yb = tempb3 + mut*two*tauyyb
   u_xb = tempb3 + mut*two*tauxxb
   CALL POPREAL8(q_z)
   corrb = -(ssy*q_yb) - ssx*q_xb - ssz*q_zb
   sszb = q_z*corrb - corr*q_zb
   CALL POPREAL8(q_y)
   ssyb = q_y*corrb - corr*q_yb
   CALL POPREAL8(q_x)
   ssxb = q_x*corrb - corr*q_xb
   CALL POPREAL8(corr)
   q_xb = q_xb + ssx*corrb
   q_yb = q_yb + ssy*corrb
   q_zb = q_zb + ssz*corrb
   pb(i, j, k+1) = pb(i, j, k+1) + ss*corrb
   pb(i, j, k) = pb(i, j, k) - ss*corrb
   ssb = (p(i, j, k+1)-p(i, j, k))*corrb
   CALL POPREAL8(w_z)
   corrb = -(ssy*w_yb) - ssx*w_xb - ssz*w_zb
   sszb = sszb + w_z*corrb - corr*w_zb
   CALL POPREAL8(w_y)
   ssyb = ssyb + w_y*corrb - corr*w_yb
   CALL POPREAL8(w_x)
   ssxb = ssxb + w_x*corrb - corr*w_xb
   CALL POPREAL8(corr)
   w_xb = w_xb + ssx*corrb
   w_yb = w_yb + ssy*corrb
   w_zb = w_zb + ssz*corrb
   wb(i, j, k+1, ivz) = wb(i, j, k+1, ivz) - ss*corrb
   wb(i, j, k, ivz) = wb(i, j, k, ivz) + ss*corrb
   ssb = ssb - (w(i, j, k+1, ivz)-w(i, j, k, ivz))*corrb
   CALL POPREAL8(v_z)
   corrb = -(ssy*v_yb) - ssx*v_xb - ssz*v_zb
   sszb = sszb + v_z*corrb - corr*v_zb
   CALL POPREAL8(v_y)
   ssyb = ssyb + v_y*corrb - corr*v_yb
   CALL POPREAL8(v_x)
   ssxb = ssxb + v_x*corrb - corr*v_xb
   CALL POPREAL8(corr)
   v_xb = v_xb + ssx*corrb
   v_yb = v_yb + ssy*corrb
   v_zb = v_zb + ssz*corrb
   wb(i, j, k+1, ivy) = wb(i, j, k+1, ivy) - ss*corrb
   wb(i, j, k, ivy) = wb(i, j, k, ivy) + ss*corrb
   ssb = ssb - (w(i, j, k+1, ivy)-w(i, j, k, ivy))*corrb
   CALL POPREAL8(u_z)
   corrb = -(ssy*u_yb) - ssx*u_xb - ssz*u_zb
   sszb = sszb + u_z*corrb - corr*u_zb
   CALL POPREAL8(u_y)
   ssyb = ssyb + u_y*corrb - corr*u_yb
   CALL POPREAL8(u_x)
   ssxb = ssxb + u_x*corrb - corr*u_xb
   CALL POPREAL8(corr)
   u_xb = u_xb + ssx*corrb
   u_yb = u_yb + ssy*corrb
   u_zb = u_zb + ssz*corrb
   wb(i, j, k+1, ivx) = wb(i, j, k+1, ivx) - ss*corrb
   wb(i, j, k, ivx) = wb(i, j, k, ivx) + ss*corrb
   CALL POPREAL8(ssz)
   CALL POPREAL8(ssy)
   CALL POPREAL8(ssx)
   ssb = ssb + ssz*sszb + ssx*ssxb + ssy*ssyb - (w(i, j, k+1, ivx&
   &           )-w(i, j, k, ivx))*corrb
   temp0 = ssx**2 + ssy**2 + ssz**2
   temp1 = SQRT(temp0)
   IF (temp0 .EQ. 0.0_8) THEN
   tempb4 = 0.0
   ELSE
   tempb4 = -(one*ssb/(temp1**3*2.0))
   END IF
   sszb = 2*ssz*tempb4 + ss*sszb
   ssyb = 2*ssy*tempb4 + ss*ssyb
   ssxb = 2*ssx*tempb4 + ss*ssxb
   CALL POPREAL8(ss)
   CALL POPREAL8(ssz)
   tempb5 = eighth*sszb
   xb(i-1, j-1, k+1, 3) = xb(i-1, j-1, k+1, 3) + tempb5
   xb(i-1, j-1, k-1, 3) = xb(i-1, j-1, k-1, 3) - tempb5
   xb(i-1, j, k+1, 3) = xb(i-1, j, k+1, 3) + tempb5
   xb(i-1, j, k-1, 3) = xb(i-1, j, k-1, 3) - tempb5
   xb(i, j-1, k+1, 3) = xb(i, j-1, k+1, 3) + tempb5
   xb(i, j-1, k-1, 3) = xb(i, j-1, k-1, 3) - tempb5
   xb(i, j, k+1, 3) = xb(i, j, k+1, 3) + tempb5
   xb(i, j, k-1, 3) = xb(i, j, k-1, 3) - tempb5
   CALL POPREAL8(ssy)
   tempb6 = eighth*ssyb
   xb(i-1, j-1, k+1, 2) = xb(i-1, j-1, k+1, 2) + tempb6
   xb(i-1, j-1, k-1, 2) = xb(i-1, j-1, k-1, 2) - tempb6
   xb(i-1, j, k+1, 2) = xb(i-1, j, k+1, 2) + tempb6
   xb(i-1, j, k-1, 2) = xb(i-1, j, k-1, 2) - tempb6
   xb(i, j-1, k+1, 2) = xb(i, j-1, k+1, 2) + tempb6
   xb(i, j-1, k-1, 2) = xb(i, j-1, k-1, 2) - tempb6
   xb(i, j, k+1, 2) = xb(i, j, k+1, 2) + tempb6
   xb(i, j, k-1, 2) = xb(i, j, k-1, 2) - tempb6
   CALL POPREAL8(ssx)
   tempb7 = eighth*ssxb
   xb(i-1, j-1, k+1, 1) = xb(i-1, j-1, k+1, 1) + tempb7
   xb(i-1, j-1, k-1, 1) = xb(i-1, j-1, k-1, 1) - tempb7
   xb(i-1, j, k+1, 1) = xb(i-1, j, k+1, 1) + tempb7
   xb(i-1, j, k-1, 1) = xb(i-1, j, k-1, 1) - tempb7
   xb(i, j-1, k+1, 1) = xb(i, j-1, k+1, 1) + tempb7
   xb(i, j-1, k-1, 1) = xb(i, j-1, k-1, 1) - tempb7
   xb(i, j, k+1, 1) = xb(i, j, k+1, 1) + tempb7
   xb(i, j, k-1, 1) = xb(i, j, k-1, 1) - tempb7
   CALL POPREAL8(q_z)
   tempb8 = fourth*q_zb
   qzb(i-1, j-1, k) = qzb(i-1, j-1, k) + tempb8
   qzb(i, j-1, k) = qzb(i, j-1, k) + tempb8
   qzb(i-1, j, k) = qzb(i-1, j, k) + tempb8
   qzb(i, j, k) = qzb(i, j, k) + tempb8
   CALL POPREAL8(q_y)
   tempb9 = fourth*q_yb
   qyb(i-1, j-1, k) = qyb(i-1, j-1, k) + tempb9
   qyb(i, j-1, k) = qyb(i, j-1, k) + tempb9
   qyb(i-1, j, k) = qyb(i-1, j, k) + tempb9
   qyb(i, j, k) = qyb(i, j, k) + tempb9
   CALL POPREAL8(q_x)
   tempb10 = fourth*q_xb
   qxb(i-1, j-1, k) = qxb(i-1, j-1, k) + tempb10
   qxb(i, j-1, k) = qxb(i, j-1, k) + tempb10
   qxb(i-1, j, k) = qxb(i-1, j, k) + tempb10
   qxb(i, j, k) = qxb(i, j, k) + tempb10
   CALL POPREAL8(w_z)
   tempb11 = fourth*w_zb
   wzb(i-1, j-1, k) = wzb(i-1, j-1, k) + tempb11
   wzb(i, j-1, k) = wzb(i, j-1, k) + tempb11
   wzb(i-1, j, k) = wzb(i-1, j, k) + tempb11
   wzb(i, j, k) = wzb(i, j, k) + tempb11
   CALL POPREAL8(w_y)
   tempb12 = fourth*w_yb
   wyb(i-1, j-1, k) = wyb(i-1, j-1, k) + tempb12
   wyb(i, j-1, k) = wyb(i, j-1, k) + tempb12
   wyb(i-1, j, k) = wyb(i-1, j, k) + tempb12
   wyb(i, j, k) = wyb(i, j, k) + tempb12
   CALL POPREAL8(w_x)
   tempb13 = fourth*w_xb
   wxb(i-1, j-1, k) = wxb(i-1, j-1, k) + tempb13
   wxb(i, j-1, k) = wxb(i, j-1, k) + tempb13
   wxb(i-1, j, k) = wxb(i-1, j, k) + tempb13
   wxb(i, j, k) = wxb(i, j, k) + tempb13
   CALL POPREAL8(v_z)
   tempb14 = fourth*v_zb
   vzb(i-1, j-1, k) = vzb(i-1, j-1, k) + tempb14
   vzb(i, j-1, k) = vzb(i, j-1, k) + tempb14
   vzb(i-1, j, k) = vzb(i-1, j, k) + tempb14
   vzb(i, j, k) = vzb(i, j, k) + tempb14
   CALL POPREAL8(v_y)
   tempb15 = fourth*v_yb
   vyb(i-1, j-1, k) = vyb(i-1, j-1, k) + tempb15
   vyb(i, j-1, k) = vyb(i, j-1, k) + tempb15
   vyb(i-1, j, k) = vyb(i-1, j, k) + tempb15
   vyb(i, j, k) = vyb(i, j, k) + tempb15
   CALL POPREAL8(v_x)
   tempb16 = fourth*v_xb
   vxb(i-1, j-1, k) = vxb(i-1, j-1, k) + tempb16
   vxb(i, j-1, k) = vxb(i, j-1, k) + tempb16
   vxb(i-1, j, k) = vxb(i-1, j, k) + tempb16
   vxb(i, j, k) = vxb(i, j, k) + tempb16
   CALL POPREAL8(u_z)
   tempb17 = fourth*u_zb
   uzb(i-1, j-1, k) = uzb(i-1, j-1, k) + tempb17
   uzb(i, j-1, k) = uzb(i, j-1, k) + tempb17
   uzb(i-1, j, k) = uzb(i-1, j, k) + tempb17
   uzb(i, j, k) = uzb(i, j, k) + tempb17
   CALL POPREAL8(u_y)
   tempb18 = fourth*u_yb
   uyb(i-1, j-1, k) = uyb(i-1, j-1, k) + tempb18
   uyb(i, j-1, k) = uyb(i, j-1, k) + tempb18
   uyb(i-1, j, k) = uyb(i-1, j, k) + tempb18
   uyb(i, j, k) = uyb(i, j, k) + tempb18
   CALL POPREAL8(u_x)
   tempb19 = fourth*u_xb
   uxb(i-1, j-1, k) = uxb(i-1, j-1, k) + tempb19
   uxb(i, j-1, k) = uxb(i, j-1, k) + tempb19
   uxb(i-1, j, k) = uxb(i-1, j, k) + tempb19
   uxb(i, j, k) = uxb(i, j, k) + tempb19
   mulb = mutb + factlamheat*heatcoefb
   factlamheatb = mul*heatcoefb
   mueb = mueb + mutb + factturbheat*heatcoefb
   factturbheatb = mue*heatcoefb
   gm1b = -(one*factlamheatb/(prandtl*gm1**2)) - one*&
   &           factturbheatb/(prandtlturb*gm1**2)
   gammab(i, j, k) = gammab(i, j, k) + half*gm1b
   gammab(i, j, k+1) = gammab(i, j, k+1) + half*gm1b
   CALL POPREAL8(mut)
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   CALL POPREAL8(mue)
   revb(i, j, k) = revb(i, j, k) + por*mueb
   revb(i, j, k+1) = revb(i, j, k+1) + por*mueb
   mueb = 0.0_8
   END IF
   rlvb(i, j, k) = rlvb(i, j, k) + por*mulb
   rlvb(i, j, k+1) = rlvb(i, j, k+1) + por*mulb
   CALL POPREAL8(por)
   END DO
   END DO
   END DO
   CALL ALLNODALGRADIENTS_B()
   DO k=ke,1,-1
   DO j=je,1,-1
   DO i=ie,1,-1
   CALL POPREAL8(p(i, j, k))
   temp = w(i, j, k, irho)
   tempb = pb(i, j, k)/temp
   gammab(i, j, k) = gammab(i, j, k) + p(i, j, k)*tempb
   wb(i, j, k, irho) = wb(i, j, k, irho) - gamma(i, j, k)*p(i, j&
   &           , k)*tempb/temp
   pb(i, j, k) = gamma(i, j, k)*tempb
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   CALL POPREAL8(p(i, j, k))
   wb(i, j, k, irho) = wb(i, j, k, irho) - twothird*w(i, j, k, &
   &             itu1)*pb(i, j, k)
   wb(i, j, k, itu1) = wb(i, j, k, itu1) - twothird*w(i, j, k, &
   &             irho)*pb(i, j, k)
   END IF
   END DO
   END DO
   END DO
   END IF
   END SUBROUTINE VISCOUSFLUX_B
