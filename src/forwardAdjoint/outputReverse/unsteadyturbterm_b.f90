   !        Generated by TAPENADE     (INRIA, Tropics team)
   !  Tapenade 3.10 (r5363) -  9 Sep 2014 09:53
   !
   !  Differentiation of unsteadyturbterm in reverse (adjoint) mode (with options i4 dr8 r8 noISIZE):
   !   gradient     of useful results: *dw *w timeref
   !   with respect to varying inputs: *dw *w timeref
   !   Plus diff mem management of: dw:in w:in
   !
   !      ******************************************************************
   !      *                                                                *
   !      * File:          unsteadyTurbTerm.f90                            *
   !      * Author:        Edwin van der Weide                             *
   !      * Starting date: 02-09-2004                                      *
   !      * Last modified: 11-27-2007                                      *
   !      *                                                                *
   !      ******************************************************************
   !
   SUBROUTINE UNSTEADYTURBTERM_B(madv, nadv, offset, qq)
   !
   !      ******************************************************************
   !      *                                                                *
   !      * unsteadyTurbTerm discretizes the time derivative of the        *
   !      * turbulence transport equations and add it to the residual.     *
   !      * As the time derivative is the same for all turbulence models,  *
   !      * this generic routine can be used; both the discretization of   *
   !      * the time derivative and its contribution to the central        *
   !      * jacobian are computed by this routine.                         *
   !      *                                                                *
   !      * Only nAdv equations are treated, while the actual system has   *
   !      * size mAdv. The reason is that some equations for some          *
   !      * turbulence equations do not have a time derivative, e.g. the   *
   !      * f equation in the v2-f model. The argument offset indicates    *
   !      * the offset in the w vector where this subsystem starts. As a   *
   !      * consequence it is assumed that the indices of the current      *
   !      * subsystem are contiguous, e.g. if a 2*2 system is solved the   *
   !      * Last index in w is offset+1 and offset+2 respectively.         *
   !      *                                                                *
   !      ******************************************************************
   !
   USE BLOCKPOINTERS_B
   USE FLOWVARREFSTATE
   USE INPUTPHYSICS
   USE INPUTTIMESPECTRAL
   USE INPUTUNSTEADY
   USE ITERATION
   USE SECTION
   USE TURBMOD
   IMPLICIT NONE
   !
   !      Subroutine arguments.
   !
   INTEGER(kind=inttype), INTENT(IN) :: madv, nadv, offset
   REAL(kind=realtype), DIMENSION(2:il, 2:jl, 2:kl, madv, madv), INTENT(&
   & INOUT) :: qq
   !
   !      Local variables.
   !
   INTEGER(kind=inttype) :: i, j, k, ii, jj, nn
   REAL(kind=realtype) :: oneoverdt, tmp
   REAL(kind=realtype) :: oneoverdtb, tmpb
   REAL(kind=realtype) :: tmp0
   REAL(kind=realtype) :: tmpb0
   !
   !      ******************************************************************
   !      *                                                                *
   !      * Begin execution                                                *
   !      *                                                                *
   !      ******************************************************************
   !
   ! Determine the equation mode.
   SELECT CASE  (equationmode) 
   CASE (steady) 
      CASE (unsteady) 
   !===============================================================
   ! The time deritvative term depends on the integration
   ! scheme used.
   SELECT CASE  (timeintegrationscheme) 
   CASE (bdf) 
   ! Backward difference formula is used as time
   ! integration scheme.
   ! Store the inverse of the physical nonDimensional
   ! time step a bit easier.
   oneoverdt = timeref/deltat
   ! Loop over the number of turbulent transport equations.
   nadvloopunsteady:DO ii=1,nadv
   ! Store the index of the current turbulent variable in jj.
   CALL PUSHINTEGER4(jj)
   jj = ii + offset
   ! Loop over the owned cells of this block to compute the
   ! time derivative.
   DO k=2,kl
   DO j=2,jl
   DO i=2,il
   ! Initialize tmp to the value of the current
   ! level multiplied by the corresponding coefficient
   ! in the time integration scheme.
   CALL PUSHREAL8(tmp)
   tmp = coeftime(0)*w(i, j, k, jj)
   ! Loop over the old time levels and add the
   ! corresponding contribution to tmp.
   DO nn=1,noldlevels
   tmp = tmp + coeftime(nn)*wold(nn, i, j, k, jj)
   END DO
   END DO
   END DO
   END DO
   END DO nadvloopunsteady
   oneoverdtb = 0.0_8
   DO ii=nadv,1,-1
   DO k=kl,2,-1
   DO j=jl,2,-1
   DO i=il,2,-1
   oneoverdtb = oneoverdtb - tmp*dwb(i, j, k, idvt+ii-1)
   tmpb = -(oneoverdt*dwb(i, j, k, idvt+ii-1))
   CALL POPREAL8(tmp)
   wb(i, j, k, jj) = wb(i, j, k, jj) + coeftime(0)*tmpb
   END DO
   END DO
   END DO
   CALL POPINTEGER4(jj)
   END DO
   timerefb = timerefb + oneoverdtb/deltat
   END SELECT
   CASE (timespectral) 
   !===============================================================
   ! Time spectral method.
   ! Loop over the number of turbulent transport equations.
   nadvloopspectral:DO ii=1,nadv
   ! Store the index of the current turbulent variable in jj.
   CALL PUSHINTEGER4(jj)
   jj = ii + offset
   ! The time derivative has been computed earlier in
   ! unsteadyTurbSpectral and stored in entry jj of dw.
   ! Substract this value for all owned cells. It must be
   ! substracted, because in the turbulent routines the
   ! residual is defined with an opposite sign compared to
   ! the residual of the flow equations.
   ! Also add a term to the diagonal matrix, which corresponds
   ! to to the contribution of the highest frequency. This is
   ! equivalent to an explicit treatment of the time derivative
   ! and may need to be changed.
   END DO nadvloopspectral
   DO ii=nadv,1,-1
   DO k=kl,2,-1
   DO j=jl,2,-1
   DO i=il,2,-1
   tmpb0 = dwb(i, j, k, idvt+ii-1)
   dwb(i, j, k, idvt+ii-1) = tmpb0
   dwb(i, j, k, jj) = dwb(i, j, k, jj) - tmpb0
   END DO
   END DO
   END DO
   CALL POPINTEGER4(jj)
   END DO
   END SELECT
   END SUBROUTINE UNSTEADYTURBTERM_B
