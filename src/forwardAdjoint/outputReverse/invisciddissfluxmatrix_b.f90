   !        Generated by TAPENADE     (INRIA, Tropics team)
   !  Tapenade 3.10 (r5363) -  9 Sep 2014 09:53
   !
   !  Differentiation of invisciddissfluxmatrix in reverse (adjoint) mode (with options i4 dr8 r8 noISIZE):
   !   gradient     of useful results: *p *w *si *sj *sk *fw
   !   with respect to varying inputs: pinfcorr *p *w *si *sj *sk
   !   Plus diff mem management of: p:in w:in si:in sj:in sk:in fw:in
   !
   !      ******************************************************************
   !      *                                                                *
   !      * File:          inviscidDissFluxMatrix.f90                      *
   !      * Author:        Edwin van der Weide                             *
   !      * Starting date: 03-25-2003                                      *
   !      * Last modified: 10-29-2007                                      *
   !      *                                                                *
   !      ******************************************************************
   !
   SUBROUTINE INVISCIDDISSFLUXMATRIX_B()
   !
   !      ******************************************************************
   !      *                                                                *
   !      * inviscidDissFluxMatrix computes the matrix artificial          *
   !      * dissipation term. Instead of the spectral radius, as used in   *
   !      * the scalar dissipation scheme, the absolute value of the flux  *
   !      * jacobian is used. This leads to a less diffusive and           *
   !      * consequently more accurate scheme. It is assumed that the      *
   !      * pointers in blockPointers already point to the correct block.  *
   !      *                                                                *
   !      ******************************************************************
   !
   USE BLOCKPOINTERS
   USE CGNSGRID
   USE CONSTANTS
   USE FLOWVARREFSTATE
   USE INPUTDISCRETIZATION
   USE INPUTPHYSICS
   USE ITERATION
   IMPLICIT NONE
   !
   !      Local parameters.
   !
   REAL(kind=realtype), PARAMETER :: dpmax=0.25_realType
   REAL(kind=realtype), PARAMETER :: epsacoustic=0.25_realType
   REAL(kind=realtype), PARAMETER :: epsshear=0.025_realType
   REAL(kind=realtype), PARAMETER :: omega=0.5_realType
   REAL(kind=realtype), PARAMETER :: oneminomega=one-omega
   !
   !      Local variables.
   !
   INTEGER(kind=inttype) :: i, j, k, ind
   REAL(kind=realtype) :: plim, sface
   REAL(kind=realtype) :: plimd, sfaced
   REAL(kind=realtype) :: sfil, fis2, fis4
   REAL(kind=realtype) :: gammaavg, gm1, ovgm1, gm53
   REAL(kind=realtype) :: ppor, rrad, dis2, dis4
   REAL(kind=realtype) :: rradd, dis2d, dis4d
   REAL(kind=realtype) :: dp1, dp2, ddw, tmp, fs
   REAL(kind=realtype) :: dp1d, dp2d, ddwd, tmpd, fsd
   REAL(kind=realtype) :: dr, dru, drv, drw, dre, drk, sx, sy, sz
   REAL(kind=realtype) :: drd, drud, drvd, drwd, dred, drkd, sxd, syd, &
   & szd
   REAL(kind=realtype) :: uavg, vavg, wavg, a2avg, aavg, havg
   REAL(kind=realtype) :: uavgd, vavgd, wavgd, a2avgd, aavgd, havgd
   REAL(kind=realtype) :: alphaavg, unavg, ovaavg, ova2avg
   REAL(kind=realtype) :: alphaavgd, unavgd, ovaavgd, ova2avgd
   REAL(kind=realtype) :: kavg, lam1, lam2, lam3, area
   REAL(kind=realtype) :: kavgd, lam1d, lam2d, lam3d, aread
   REAL(kind=realtype) :: abv1, abv2, abv3, abv4, abv5, abv6, abv7
   REAL(kind=realtype) :: abv1d, abv2d, abv3d, abv4d, abv5d, abv6d, abv7d
   LOGICAL :: correctfork
   INTRINSIC ABS
   INTRINSIC MAX
   INTRINSIC MIN
   REAL(kind=realtype) :: DIM
   INTRINSIC SQRT
   REAL(kind=realtype) :: arg1
   REAL(kind=realtype) :: arg1d
   INTEGER :: branch
   REAL(kind=realtype) :: temp3
   REAL(kind=realtype) :: tempd14
   REAL(kind=realtype) :: temp29
   REAL(kind=realtype) :: temp2
   REAL(kind=realtype) :: tempd13
   REAL(kind=realtype) :: temp28
   REAL(kind=realtype) :: temp1
   REAL(kind=realtype) :: tempd12
   REAL(kind=realtype) :: temp27
   REAL(kind=realtype) :: min5d
   REAL(kind=realtype) :: tempd49
   REAL(kind=realtype) :: temp0
   REAL(kind=realtype) :: tempd11
   REAL(kind=realtype) :: temp26
   REAL(kind=realtype) :: tempd48
   REAL(kind=realtype) :: tempd10
   REAL(kind=realtype) :: temp25
   REAL(kind=realtype) :: tempd47
   REAL(kind=realtype) :: temp24
   REAL(kind=realtype) :: x6d
   REAL(kind=realtype) :: tempd46
   REAL(kind=realtype) :: y4d
   REAL(kind=realtype) :: temp23
   REAL(kind=realtype) :: tempd45
   REAL(kind=realtype) :: temp22
   REAL(kind=realtype) :: tempd44
   REAL(kind=realtype) :: temp21
   REAL(kind=realtype) :: tempd43
   REAL(kind=realtype) :: temp58
   REAL(kind=realtype) :: temp20
   REAL(kind=realtype) :: tempd42
   REAL(kind=realtype) :: temp57
   REAL(kind=realtype) :: abs1d
   REAL(kind=realtype) :: tempd41
   REAL(kind=realtype) :: temp56
   REAL(kind=realtype) :: min6
   REAL(kind=realtype) :: tempd40
   REAL(kind=realtype) :: temp55
   REAL(kind=realtype) :: min5
   REAL(kind=realtype) :: temp54
   REAL(kind=realtype) :: min4
   REAL(kind=realtype) :: max2d
   REAL(kind=realtype) :: temp53
   REAL(kind=realtype) :: min3
   REAL(kind=realtype) :: temp52
   REAL(kind=realtype) :: min2
   REAL(kind=realtype) :: temp51
   REAL(kind=realtype) :: min1
   REAL(kind=realtype) :: temp50
   REAL(kind=realtype) :: abs4d
   REAL(kind=realtype) :: abs11d
   REAL(kind=realtype) :: abs7d
   REAL(kind=realtype) :: x6
   REAL(kind=realtype) :: x5
   REAL(kind=realtype) :: min1d
   REAL(kind=realtype) :: x4
   REAL(kind=realtype) :: x3
   REAL(kind=realtype) :: x2
   REAL(kind=realtype) :: x2d
   REAL(kind=realtype) :: x1
   REAL(kind=realtype) :: temp19
   REAL(kind=realtype) :: temp18
   REAL(kind=realtype) :: temp17
   REAL(kind=realtype) :: min4d
   REAL(kind=realtype) :: tempd39
   REAL(kind=realtype) :: temp16
   REAL(kind=realtype) :: tempd38
   REAL(kind=realtype) :: temp15
   REAL(kind=realtype) :: tempd37
   REAL(kind=realtype) :: temp14
   REAL(kind=realtype) :: x5d
   REAL(kind=realtype) :: tempd36
   REAL(kind=realtype) :: temp13
   REAL(kind=realtype) :: y3d
   REAL(kind=realtype) :: tempd35
   REAL(kind=realtype) :: temp12
   REAL(kind=realtype) :: tempd34
   REAL(kind=realtype) :: temp49
   REAL(kind=realtype) :: temp11
   REAL(kind=realtype) :: tempd33
   REAL(kind=realtype) :: temp48
   REAL(kind=realtype) :: temp10
   REAL(kind=realtype) :: tempd32
   REAL(kind=realtype) :: temp47
   REAL(kind=realtype) :: tempd31
   REAL(kind=realtype) :: temp46
   REAL(kind=realtype) :: tempd30
   REAL(kind=realtype) :: temp45
   REAL(kind=realtype) :: temp44
   REAL(kind=realtype) :: max1d
   REAL(kind=realtype) :: y6d
   REAL(kind=realtype) :: temp43
   REAL(kind=realtype) :: temp42
   REAL(kind=realtype) :: temp41
   REAL(kind=realtype) :: temp40
   REAL(kind=realtype) :: abs3d
   REAL(kind=realtype) :: abs10d
   REAL(kind=realtype) :: tempd9
   REAL(kind=realtype) :: tempd
   REAL(kind=realtype) :: tempd8
   REAL(kind=realtype) :: tempd7
   REAL(kind=realtype) :: tempd6
   REAL(kind=realtype) :: tempd5
   REAL(kind=realtype) :: tempd4
   REAL(kind=realtype) :: abs6d
   REAL(kind=realtype) :: tempd3
   REAL(kind=realtype) :: tempd2
   REAL(kind=realtype) :: tempd1
   REAL(kind=realtype) :: tempd0
   REAL(kind=realtype) :: abs12
   REAL(kind=realtype) :: x1d
   REAL(kind=realtype) :: abs11
   REAL(kind=realtype) :: abs10
   REAL(kind=realtype) :: abs9d
   REAL(kind=realtype) :: min3d
   REAL(kind=realtype) :: tempd29
   REAL(kind=realtype) :: tempd28
   REAL(kind=realtype) :: tempd27
   REAL(kind=realtype) :: x4d
   REAL(kind=realtype) :: tempd26
   REAL(kind=realtype) :: y2d
   REAL(kind=realtype) :: tempd25
   REAL(kind=realtype) :: tempd24
   REAL(kind=realtype) :: temp39
   REAL(kind=realtype) :: tempd23
   REAL(kind=realtype) :: temp38
   REAL(kind=realtype) :: tempd22
   REAL(kind=realtype) :: temp37
   REAL(kind=realtype) :: min6d
   REAL(kind=realtype) :: abs9
   REAL(kind=realtype) :: tempd21
   REAL(kind=realtype) :: temp36
   REAL(kind=realtype) :: abs8
   REAL(kind=realtype) :: tempd20
   REAL(kind=realtype) :: temp35
   REAL(kind=realtype) :: abs7
   REAL(kind=realtype) :: temp34
   REAL(kind=realtype) :: abs6
   REAL(kind=realtype) :: temp33
   REAL(kind=realtype) :: y5d
   REAL(kind=realtype) :: abs5
   REAL(kind=realtype) :: temp32
   REAL(kind=realtype) :: abs4
   REAL(kind=realtype) :: temp31
   REAL(kind=realtype) :: abs3
   REAL(kind=realtype) :: temp30
   REAL(kind=realtype) :: abs2
   REAL(kind=realtype) :: abs2d
   REAL(kind=realtype) :: abs1
   REAL(kind=realtype) :: abs0
   REAL(kind=realtype) :: max3d
   REAL(kind=realtype) :: abs5d
   REAL(kind=realtype) :: abs12d
   REAL(kind=realtype) :: temp
   REAL(kind=realtype) :: max3
   REAL(kind=realtype) :: max2
   REAL(kind=realtype) :: abs8d
   REAL(kind=realtype) :: y6
   REAL(kind=realtype) :: max1
   REAL(kind=realtype) :: temp9
   REAL(kind=realtype) :: y5
   REAL(kind=realtype) :: min2d
   REAL(kind=realtype) :: temp8
   REAL(kind=realtype) :: tempd19
   REAL(kind=realtype) :: y4
   REAL(kind=realtype) :: temp7
   REAL(kind=realtype) :: tempd18
   REAL(kind=realtype) :: y3
   REAL(kind=realtype) :: temp6
   REAL(kind=realtype) :: tempd17
   REAL(kind=realtype) :: y2
   REAL(kind=realtype) :: temp5
   REAL(kind=realtype) :: x3d
   REAL(kind=realtype) :: tempd16
   REAL(kind=realtype) :: y1
   REAL(kind=realtype) :: y1d
   REAL(kind=realtype) :: temp4
   REAL(kind=realtype) :: tempd15
   IF (rfil .GE. 0.) THEN
   abs0 = rfil
   ELSE
   abs0 = -rfil
   END IF
   !
   !      ******************************************************************
   !      *                                                                *
   !      * Begin execution                                                *
   !      *                                                                *
   !      ******************************************************************
   !
   ! Check if rFil == 0. If so, the dissipative flux needs not to
   ! be computed.
   IF (abs0 .LT. thresholdreal) THEN
   pinfcorrd = 0.0_8
   ELSE
   ! Set the value of plim. To be fully consistent this must have
   ! the dimension of a pressure. Therefore a fraction of pInfCorr
   ! is used.
   plim = 0.001_realType*pinfcorr
   ! Determine whether or not the total energy must be corrected
   ! for the presence of the turbulent kinetic energy.
   IF (kpresent) THEN
   IF (currentlevel .EQ. groundlevel .OR. turbcoupled) THEN
   correctfork = .true.
   ELSE
   correctfork = .false.
   END IF
   ELSE
   correctfork = .false.
   END IF
   ! Initialize sface to zero. This value will be used if the
   ! block is not moving.
   sface = zero
   ! Set a couple of constants for the scheme.
   fis2 = rfil*vis2
   fis4 = rfil*vis4
   !
   !      ******************************************************************
   !      *                                                                *
   !      * Dissipative fluxes in the i-direction.                         *
   !      *                                                                *
   !      ******************************************************************
   !
   DO k=2,kl
   DO j=2,jl
   IF (p(2, j, k) - p(1, j, k) .GE. 0.) THEN
   CALL PUSHREAL8(abs1)
   abs1 = p(2, j, k) - p(1, j, k)
   CALL PUSHCONTROL1B(1)
   ELSE
   CALL PUSHREAL8(abs1)
   abs1 = -(p(2, j, k)-p(1, j, k))
   CALL PUSHCONTROL1B(0)
   END IF
   IF (p(1, j, k) - p(0, j, k) .GE. 0.) THEN
   CALL PUSHREAL8(abs7)
   abs7 = p(1, j, k) - p(0, j, k)
   CALL PUSHCONTROL1B(0)
   ELSE
   CALL PUSHREAL8(abs7)
   abs7 = -(p(1, j, k)-p(0, j, k))
   CALL PUSHCONTROL1B(1)
   END IF
   x1 = (p(2, j, k)-two*p(1, j, k)+p(0, j, k))/(omega*(p(2, j, k)+&
   &         two*p(1, j, k)+p(0, j, k))+oneminomega*(abs1+abs7)+plim)
   IF (x1 .GE. 0.) THEN
   dp1 = x1
   CALL PUSHCONTROL1B(0)
   ELSE
   dp1 = -x1
   CALL PUSHCONTROL1B(1)
   END IF
   ! Loop in i-direction.
   DO i=1,il
   IF (p(i+2, j, k) - p(i+1, j, k) .GE. 0.) THEN
   CALL PUSHREAL8(abs2)
   abs2 = p(i+2, j, k) - p(i+1, j, k)
   CALL PUSHCONTROL1B(1)
   ELSE
   CALL PUSHREAL8(abs2)
   abs2 = -(p(i+2, j, k)-p(i+1, j, k))
   CALL PUSHCONTROL1B(0)
   END IF
   IF (p(i+1, j, k) - p(i, j, k) .GE. 0.) THEN
   CALL PUSHREAL8(abs8)
   abs8 = p(i+1, j, k) - p(i, j, k)
   CALL PUSHCONTROL1B(0)
   ELSE
   CALL PUSHREAL8(abs8)
   abs8 = -(p(i+1, j, k)-p(i, j, k))
   CALL PUSHCONTROL1B(1)
   END IF
   x2 = (p(i+2, j, k)-two*p(i+1, j, k)+p(i, j, k))/(omega*(p(i+2&
   &           , j, k)+two*p(i+1, j, k)+p(i, j, k))+oneminomega*(abs2+abs8)&
   &           +plim)
   IF (x2 .GE. 0.) THEN
   dp2 = x2
   CALL PUSHCONTROL1B(0)
   ELSE
   dp2 = -x2
   CALL PUSHCONTROL1B(1)
   END IF
   ! Compute the dissipation coefficients for this face.
   CALL PUSHREAL8(ppor)
   ppor = zero
   IF (pori(i, j, k) .EQ. normalflux) ppor = one
   IF (lumpeddiss) THEN
   IF (dp1 .LT. dp2) THEN
   y1 = dp2
   CALL PUSHCONTROL1B(0)
   ELSE
   y1 = dp1
   CALL PUSHCONTROL1B(1)
   END IF
   IF (dpmax .GT. y1) THEN
   min1 = y1
   CALL PUSHCONTROL1B(0)
   ELSE
   min1 = dpmax
   CALL PUSHCONTROL1B(1)
   END IF
   CALL PUSHREAL8(dis2)
   dis2 = fis2*ppor*min1 + sigma*fis4*ppor
   CALL PUSHREAL8(dis4)
   dis4 = 0.0
   CALL PUSHCONTROL1B(0)
   ELSE
   IF (dp1 .LT. dp2) THEN
   y2 = dp2
   CALL PUSHCONTROL1B(0)
   ELSE
   y2 = dp1
   CALL PUSHCONTROL1B(1)
   END IF
   IF (dpmax .GT. y2) THEN
   min2 = y2
   CALL PUSHCONTROL1B(0)
   ELSE
   min2 = dpmax
   CALL PUSHCONTROL1B(1)
   END IF
   CALL PUSHREAL8(dis2)
   dis2 = ppor*fis2*min2
   arg1 = ppor*fis4
   CALL PUSHREAL8(dis4)
   dis4 = DIM(arg1, dis2)
   CALL PUSHCONTROL1B(1)
   END IF
   ! Construct the vector of the first and third differences
   ! multiplied by the appropriate constants.
   CALL PUSHREAL8(ddw)
   ddw = w(i+1, j, k, irho) - w(i, j, k, irho)
   CALL PUSHREAL8(dr)
   dr = dis2*ddw - dis4*(w(i+2, j, k, irho)-w(i-1, j, k, irho)-&
   &           three*ddw)
   ddw = w(i+1, j, k, irho)*w(i+1, j, k, ivx) - w(i, j, k, irho)*&
   &           w(i, j, k, ivx)
   CALL PUSHREAL8(dru)
   dru = dis2*ddw - dis4*(w(i+2, j, k, irho)*w(i+2, j, k, ivx)-w(&
   &           i-1, j, k, irho)*w(i-1, j, k, ivx)-three*ddw)
   CALL PUSHREAL8(ddw)
   ddw = w(i+1, j, k, irho)*w(i+1, j, k, ivy) - w(i, j, k, irho)*&
   &           w(i, j, k, ivy)
   CALL PUSHREAL8(drv)
   drv = dis2*ddw - dis4*(w(i+2, j, k, irho)*w(i+2, j, k, ivy)-w(&
   &           i-1, j, k, irho)*w(i-1, j, k, ivy)-three*ddw)
   CALL PUSHREAL8(ddw)
   ddw = w(i+1, j, k, irho)*w(i+1, j, k, ivz) - w(i, j, k, irho)*&
   &           w(i, j, k, ivz)
   CALL PUSHREAL8(drw)
   drw = dis2*ddw - dis4*(w(i+2, j, k, irho)*w(i+2, j, k, ivz)-w(&
   &           i-1, j, k, irho)*w(i-1, j, k, ivz)-three*ddw)
   CALL PUSHREAL8(ddw)
   ddw = w(i+1, j, k, irhoe) - w(i, j, k, irhoe)
   CALL PUSHREAL8(dre)
   dre = dis2*ddw - dis4*(w(i+2, j, k, irhoe)-w(i-1, j, k, irhoe)&
   &           -three*ddw)
   ! In case a k-equation is present, compute the difference
   ! of rhok and store the average value of k. If not present,
   ! set both these values to zero, such that later on no
   ! decision needs to be made anymore.
   IF (correctfork) THEN
   ddw = w(i+1, j, k, irho)*w(i+1, j, k, itu1) - w(i, j, k, &
   &             irho)*w(i, j, k, itu1)
   drk = dis2*ddw - dis4*(w(i+2, j, k, irho)*w(i+2, j, k, itu1)&
   &             -w(i-1, j, k, irho)*w(i-1, j, k, itu1)-three*ddw)
   kavg = half*(w(i, j, k, itu1)+w(i+1, j, k, itu1))
   CALL PUSHCONTROL1B(1)
   ELSE
   drk = zero
   kavg = zero
   CALL PUSHCONTROL1B(0)
   END IF
   ! Compute the average value of gamma and compute some
   ! expressions in which it occurs.
   gammaavg = half*(gamma(i+1, j, k)+gamma(i, j, k))
   gm1 = gammaavg - one
   ovgm1 = one/gm1
   gm53 = gammaavg - five*third
   ! Compute the average state at the interface.
   uavg = half*(w(i+1, j, k, ivx)+w(i, j, k, ivx))
   vavg = half*(w(i+1, j, k, ivy)+w(i, j, k, ivy))
   wavg = half*(w(i+1, j, k, ivz)+w(i, j, k, ivz))
   CALL PUSHREAL8(a2avg)
   a2avg = half*(gamma(i+1, j, k)*p(i+1, j, k)/w(i+1, j, k, irho)&
   &           +gamma(i, j, k)*p(i, j, k)/w(i, j, k, irho))
   CALL PUSHREAL8(sx)
   sx = si(i, j, k, 1)
   CALL PUSHREAL8(sy)
   sy = si(i, j, k, 2)
   CALL PUSHREAL8(sz)
   sz = si(i, j, k, 3)
   CALL PUSHREAL8(area)
   area = SQRT(sx**2 + sy**2 + sz**2)
   IF (1.e-25_realType .LT. area) THEN
   CALL PUSHREAL8(max1)
   max1 = area
   CALL PUSHCONTROL1B(0)
   ELSE
   CALL PUSHREAL8(max1)
   max1 = 1.e-25_realType
   CALL PUSHCONTROL1B(1)
   END IF
   tmp = one/max1
   CALL PUSHREAL8(sx)
   sx = sx*tmp
   CALL PUSHREAL8(sy)
   sy = sy*tmp
   CALL PUSHREAL8(sz)
   sz = sz*tmp
   alphaavg = half*(uavg**2+vavg**2+wavg**2)
   CALL PUSHREAL8(havg)
   havg = alphaavg + ovgm1*(a2avg-gm53*kavg)
   CALL PUSHREAL8(aavg)
   aavg = SQRT(a2avg)
   unavg = uavg*sx + vavg*sy + wavg*sz
   ! The mesh velocity if the face is moving. It must be
   ! divided by the area to obtain a true velocity.
   IF (addgridvelocities) THEN
   sface = sfacei(i, j, k)*tmp
   CALL PUSHCONTROL1B(1)
   ELSE
   CALL PUSHCONTROL1B(0)
   END IF
   IF (unavg - sface + aavg .GE. 0.) THEN
   lam1 = unavg - sface + aavg
   CALL PUSHCONTROL1B(0)
   ELSE
   lam1 = -(unavg-sface+aavg)
   CALL PUSHCONTROL1B(1)
   END IF
   IF (unavg - sface - aavg .GE. 0.) THEN
   lam2 = unavg - sface - aavg
   CALL PUSHCONTROL1B(0)
   ELSE
   lam2 = -(unavg-sface-aavg)
   CALL PUSHCONTROL1B(1)
   END IF
   IF (unavg - sface .GE. 0.) THEN
   CALL PUSHREAL8(lam3)
   lam3 = unavg - sface
   CALL PUSHCONTROL1B(0)
   ELSE
   CALL PUSHREAL8(lam3)
   lam3 = -(unavg-sface)
   CALL PUSHCONTROL1B(1)
   END IF
   rrad = lam3 + aavg
   IF (lam1 .LT. epsacoustic*rrad) THEN
   lam1 = epsacoustic*rrad
   CALL PUSHCONTROL1B(0)
   ELSE
   CALL PUSHCONTROL1B(1)
   lam1 = lam1
   END IF
   IF (lam2 .LT. epsacoustic*rrad) THEN
   lam2 = epsacoustic*rrad
   CALL PUSHCONTROL1B(0)
   ELSE
   CALL PUSHCONTROL1B(1)
   lam2 = lam2
   END IF
   IF (lam3 .LT. epsshear*rrad) THEN
   lam3 = epsshear*rrad
   CALL PUSHCONTROL1B(0)
   ELSE
   lam3 = lam3
   CALL PUSHCONTROL1B(1)
   END IF
   ! Multiply the eigenvalues by the area to obtain
   ! the correct values for the dissipation term.
   CALL PUSHREAL8(lam1)
   lam1 = lam1*area
   CALL PUSHREAL8(lam2)
   lam2 = lam2*area
   CALL PUSHREAL8(lam3)
   lam3 = lam3*area
   ! Some abbreviations, which occur quite often in the
   ! dissipation terms.
   abv1 = half*(lam1+lam2)
   CALL PUSHREAL8(abv2)
   abv2 = half*(lam1-lam2)
   CALL PUSHREAL8(abv3)
   abv3 = abv1 - lam3
   CALL PUSHREAL8(abv4)
   abv4 = gm1*(alphaavg*dr-uavg*dru-vavg*drv-wavg*drw+dre) - gm53&
   &           *drk
   ! Compute and scatter the dissipative flux.
   ! Density.
   ! X-momentum.
   ! Y-momentum.
   ! Z-momentum.
   ! Energy.
   ! Set dp1 to dp2 for the next face.
   dp1 = dp2
   END DO
   END DO
   END DO
   !
   !      ******************************************************************
   !      *                                                                *
   !      * Dissipative fluxes in the j-direction.                         *
   !      *                                                                *
   !      ******************************************************************
   !
   DO k=2,kl
   DO i=2,il
   IF (p(i, 2, k) - p(i, 1, k) .GE. 0.) THEN
   CALL PUSHREAL8(abs3)
   abs3 = p(i, 2, k) - p(i, 1, k)
   CALL PUSHCONTROL1B(1)
   ELSE
   CALL PUSHREAL8(abs3)
   abs3 = -(p(i, 2, k)-p(i, 1, k))
   CALL PUSHCONTROL1B(0)
   END IF
   IF (p(i, 1, k) - p(i, 0, k) .GE. 0.) THEN
   CALL PUSHREAL8(abs9)
   abs9 = p(i, 1, k) - p(i, 0, k)
   CALL PUSHCONTROL1B(0)
   ELSE
   CALL PUSHREAL8(abs9)
   abs9 = -(p(i, 1, k)-p(i, 0, k))
   CALL PUSHCONTROL1B(1)
   END IF
   x3 = (p(i, 2, k)-two*p(i, 1, k)+p(i, 0, k))/(omega*(p(i, 2, k)+&
   &         two*p(i, 1, k)+p(i, 0, k))+oneminomega*(abs3+abs9)+plim)
   IF (x3 .GE. 0.) THEN
   dp1 = x3
   CALL PUSHCONTROL1B(0)
   ELSE
   dp1 = -x3
   CALL PUSHCONTROL1B(1)
   END IF
   ! Loop in j-direction.
   DO j=1,jl
   IF (p(i, j+2, k) - p(i, j+1, k) .GE. 0.) THEN
   CALL PUSHREAL8(abs4)
   abs4 = p(i, j+2, k) - p(i, j+1, k)
   CALL PUSHCONTROL1B(1)
   ELSE
   CALL PUSHREAL8(abs4)
   abs4 = -(p(i, j+2, k)-p(i, j+1, k))
   CALL PUSHCONTROL1B(0)
   END IF
   IF (p(i, j+1, k) - p(i, j, k) .GE. 0.) THEN
   CALL PUSHREAL8(abs10)
   abs10 = p(i, j+1, k) - p(i, j, k)
   CALL PUSHCONTROL1B(0)
   ELSE
   CALL PUSHREAL8(abs10)
   abs10 = -(p(i, j+1, k)-p(i, j, k))
   CALL PUSHCONTROL1B(1)
   END IF
   x4 = (p(i, j+2, k)-two*p(i, j+1, k)+p(i, j, k))/(omega*(p(i, j&
   &           +2, k)+two*p(i, j+1, k)+p(i, j, k))+oneminomega*(abs4+abs10)&
   &           +plim)
   IF (x4 .GE. 0.) THEN
   dp2 = x4
   CALL PUSHCONTROL1B(0)
   ELSE
   dp2 = -x4
   CALL PUSHCONTROL1B(1)
   END IF
   ! Compute the dissipation coefficients for this face.
   CALL PUSHREAL8(ppor)
   ppor = zero
   IF (porj(i, j, k) .EQ. normalflux) ppor = one
   IF (lumpeddiss) THEN
   IF (dp1 .LT. dp2) THEN
   y3 = dp2
   CALL PUSHCONTROL1B(0)
   ELSE
   y3 = dp1
   CALL PUSHCONTROL1B(1)
   END IF
   IF (dpmax .GT. y3) THEN
   min3 = y3
   CALL PUSHCONTROL1B(0)
   ELSE
   min3 = dpmax
   CALL PUSHCONTROL1B(1)
   END IF
   CALL PUSHREAL8(dis2)
   dis2 = fis2*ppor*min3 + sigma*fis4*ppor
   CALL PUSHREAL8(dis4)
   dis4 = 0.0
   CALL PUSHCONTROL1B(0)
   ELSE
   IF (dp1 .LT. dp2) THEN
   y4 = dp2
   CALL PUSHCONTROL1B(0)
   ELSE
   y4 = dp1
   CALL PUSHCONTROL1B(1)
   END IF
   IF (dpmax .GT. y4) THEN
   min4 = y4
   CALL PUSHCONTROL1B(0)
   ELSE
   min4 = dpmax
   CALL PUSHCONTROL1B(1)
   END IF
   CALL PUSHREAL8(dis2)
   dis2 = ppor*fis2*min4
   arg1 = ppor*fis4
   CALL PUSHREAL8(dis4)
   dis4 = DIM(arg1, dis2)
   CALL PUSHCONTROL1B(1)
   END IF
   ! Construct the vector of the first and third differences
   ! multiplied by the appropriate constants.
   CALL PUSHREAL8(ddw)
   ddw = w(i, j+1, k, irho) - w(i, j, k, irho)
   CALL PUSHREAL8(dr)
   dr = dis2*ddw - dis4*(w(i, j+2, k, irho)-w(i, j-1, k, irho)-&
   &           three*ddw)
   ddw = w(i, j+1, k, irho)*w(i, j+1, k, ivx) - w(i, j, k, irho)*&
   &           w(i, j, k, ivx)
   CALL PUSHREAL8(dru)
   dru = dis2*ddw - dis4*(w(i, j+2, k, irho)*w(i, j+2, k, ivx)-w(&
   &           i, j-1, k, irho)*w(i, j-1, k, ivx)-three*ddw)
   CALL PUSHREAL8(ddw)
   ddw = w(i, j+1, k, irho)*w(i, j+1, k, ivy) - w(i, j, k, irho)*&
   &           w(i, j, k, ivy)
   CALL PUSHREAL8(drv)
   drv = dis2*ddw - dis4*(w(i, j+2, k, irho)*w(i, j+2, k, ivy)-w(&
   &           i, j-1, k, irho)*w(i, j-1, k, ivy)-three*ddw)
   CALL PUSHREAL8(ddw)
   ddw = w(i, j+1, k, irho)*w(i, j+1, k, ivz) - w(i, j, k, irho)*&
   &           w(i, j, k, ivz)
   CALL PUSHREAL8(drw)
   drw = dis2*ddw - dis4*(w(i, j+2, k, irho)*w(i, j+2, k, ivz)-w(&
   &           i, j-1, k, irho)*w(i, j-1, k, ivz)-three*ddw)
   CALL PUSHREAL8(ddw)
   ddw = w(i, j+1, k, irhoe) - w(i, j, k, irhoe)
   CALL PUSHREAL8(dre)
   dre = dis2*ddw - dis4*(w(i, j+2, k, irhoe)-w(i, j-1, k, irhoe)&
   &           -three*ddw)
   ! In case a k-equation is present, compute the difference
   ! of rhok and store the average value of k. If not present,
   ! set both these values to zero, such that later on no
   ! decision needs to be made anymore.
   IF (correctfork) THEN
   ddw = w(i, j+1, k, irho)*w(i, j+1, k, itu1) - w(i, j, k, &
   &             irho)*w(i, j, k, itu1)
   drk = dis2*ddw - dis4*(w(i, j+2, k, irho)*w(i, j+2, k, itu1)&
   &             -w(i, j-1, k, irho)*w(i, j-1, k, itu1)-three*ddw)
   kavg = half*(w(i, j, k, itu1)+w(i, j+1, k, itu1))
   CALL PUSHCONTROL1B(1)
   ELSE
   drk = zero
   kavg = zero
   CALL PUSHCONTROL1B(0)
   END IF
   ! Compute the average value of gamma and compute some
   ! expressions in which it occurs.
   gammaavg = half*(gamma(i, j+1, k)+gamma(i, j, k))
   gm1 = gammaavg - one
   ovgm1 = one/gm1
   gm53 = gammaavg - five*third
   ! Compute the average state at the interface.
   uavg = half*(w(i, j+1, k, ivx)+w(i, j, k, ivx))
   vavg = half*(w(i, j+1, k, ivy)+w(i, j, k, ivy))
   wavg = half*(w(i, j+1, k, ivz)+w(i, j, k, ivz))
   CALL PUSHREAL8(a2avg)
   a2avg = half*(gamma(i, j+1, k)*p(i, j+1, k)/w(i, j+1, k, irho)&
   &           +gamma(i, j, k)*p(i, j, k)/w(i, j, k, irho))
   CALL PUSHREAL8(sx)
   sx = sj(i, j, k, 1)
   CALL PUSHREAL8(sy)
   sy = sj(i, j, k, 2)
   CALL PUSHREAL8(sz)
   sz = sj(i, j, k, 3)
   CALL PUSHREAL8(area)
   area = SQRT(sx**2 + sy**2 + sz**2)
   IF (1.e-25_realType .LT. area) THEN
   CALL PUSHREAL8(max2)
   max2 = area
   CALL PUSHCONTROL1B(0)
   ELSE
   CALL PUSHREAL8(max2)
   max2 = 1.e-25_realType
   CALL PUSHCONTROL1B(1)
   END IF
   tmp = one/max2
   CALL PUSHREAL8(sx)
   sx = sx*tmp
   CALL PUSHREAL8(sy)
   sy = sy*tmp
   CALL PUSHREAL8(sz)
   sz = sz*tmp
   alphaavg = half*(uavg**2+vavg**2+wavg**2)
   CALL PUSHREAL8(havg)
   havg = alphaavg + ovgm1*(a2avg-gm53*kavg)
   CALL PUSHREAL8(aavg)
   aavg = SQRT(a2avg)
   unavg = uavg*sx + vavg*sy + wavg*sz
   ! The mesh velocity if the face is moving. It must be
   ! divided by the area to obtain a true velocity.
   IF (addgridvelocities) THEN
   sface = sfacej(i, j, k)*tmp
   CALL PUSHCONTROL1B(1)
   ELSE
   CALL PUSHCONTROL1B(0)
   END IF
   IF (unavg - sface + aavg .GE. 0.) THEN
   lam1 = unavg - sface + aavg
   CALL PUSHCONTROL1B(0)
   ELSE
   lam1 = -(unavg-sface+aavg)
   CALL PUSHCONTROL1B(1)
   END IF
   IF (unavg - sface - aavg .GE. 0.) THEN
   lam2 = unavg - sface - aavg
   CALL PUSHCONTROL1B(0)
   ELSE
   lam2 = -(unavg-sface-aavg)
   CALL PUSHCONTROL1B(1)
   END IF
   IF (unavg - sface .GE. 0.) THEN
   CALL PUSHREAL8(lam3)
   lam3 = unavg - sface
   CALL PUSHCONTROL1B(0)
   ELSE
   CALL PUSHREAL8(lam3)
   lam3 = -(unavg-sface)
   CALL PUSHCONTROL1B(1)
   END IF
   rrad = lam3 + aavg
   IF (lam1 .LT. epsacoustic*rrad) THEN
   lam1 = epsacoustic*rrad
   CALL PUSHCONTROL1B(0)
   ELSE
   CALL PUSHCONTROL1B(1)
   lam1 = lam1
   END IF
   IF (lam2 .LT. epsacoustic*rrad) THEN
   lam2 = epsacoustic*rrad
   CALL PUSHCONTROL1B(0)
   ELSE
   CALL PUSHCONTROL1B(1)
   lam2 = lam2
   END IF
   IF (lam3 .LT. epsshear*rrad) THEN
   lam3 = epsshear*rrad
   CALL PUSHCONTROL1B(0)
   ELSE
   lam3 = lam3
   CALL PUSHCONTROL1B(1)
   END IF
   ! Multiply the eigenvalues by the area to obtain
   ! the correct values for the dissipation term.
   CALL PUSHREAL8(lam1)
   lam1 = lam1*area
   CALL PUSHREAL8(lam2)
   lam2 = lam2*area
   CALL PUSHREAL8(lam3)
   lam3 = lam3*area
   ! Some abbreviations, which occur quite often in the
   ! dissipation terms.
   abv1 = half*(lam1+lam2)
   CALL PUSHREAL8(abv2)
   abv2 = half*(lam1-lam2)
   CALL PUSHREAL8(abv3)
   abv3 = abv1 - lam3
   CALL PUSHREAL8(abv4)
   abv4 = gm1*(alphaavg*dr-uavg*dru-vavg*drv-wavg*drw+dre) - gm53&
   &           *drk
   ! Compute and scatter the dissipative flux.
   ! Density.
   ! X-momentum.
   ! Y-momentum.
   ! Z-momentum.
   ! Energy.
   ! Set dp1 to dp2 for the next face.
   dp1 = dp2
   END DO
   END DO
   END DO
   !
   !      ******************************************************************
   !      *                                                                *
   !      * Dissipative fluxes in the k-direction.                         *
   !      *                                                                *
   !      ******************************************************************
   !
   DO j=2,jl
   DO i=2,il
   IF (p(i, j, 2) - p(i, j, 1) .GE. 0.) THEN
   CALL PUSHREAL8(abs5)
   abs5 = p(i, j, 2) - p(i, j, 1)
   CALL PUSHCONTROL1B(1)
   ELSE
   CALL PUSHREAL8(abs5)
   abs5 = -(p(i, j, 2)-p(i, j, 1))
   CALL PUSHCONTROL1B(0)
   END IF
   IF (p(i, j, 1) - p(i, j, 0) .GE. 0.) THEN
   CALL PUSHREAL8(abs11)
   abs11 = p(i, j, 1) - p(i, j, 0)
   CALL PUSHCONTROL1B(0)
   ELSE
   CALL PUSHREAL8(abs11)
   abs11 = -(p(i, j, 1)-p(i, j, 0))
   CALL PUSHCONTROL1B(1)
   END IF
   x5 = (p(i, j, 2)-two*p(i, j, 1)+p(i, j, 0))/(omega*(p(i, j, 2)+&
   &         two*p(i, j, 1)+p(i, j, 0))+oneminomega*(abs5+abs11)+plim)
   IF (x5 .GE. 0.) THEN
   dp1 = x5
   CALL PUSHCONTROL1B(0)
   ELSE
   dp1 = -x5
   CALL PUSHCONTROL1B(1)
   END IF
   ! Loop in k-direction.
   DO k=1,kl
   IF (p(i, j, k+2) - p(i, j, k+1) .GE. 0.) THEN
   CALL PUSHREAL8(abs6)
   abs6 = p(i, j, k+2) - p(i, j, k+1)
   CALL PUSHCONTROL1B(1)
   ELSE
   CALL PUSHREAL8(abs6)
   abs6 = -(p(i, j, k+2)-p(i, j, k+1))
   CALL PUSHCONTROL1B(0)
   END IF
   IF (p(i, j, k+1) - p(i, j, k) .GE. 0.) THEN
   CALL PUSHREAL8(abs12)
   abs12 = p(i, j, k+1) - p(i, j, k)
   CALL PUSHCONTROL1B(0)
   ELSE
   CALL PUSHREAL8(abs12)
   abs12 = -(p(i, j, k+1)-p(i, j, k))
   CALL PUSHCONTROL1B(1)
   END IF
   x6 = (p(i, j, k+2)-two*p(i, j, k+1)+p(i, j, k))/(omega*(p(i, j&
   &           , k+2)+two*p(i, j, k+1)+p(i, j, k))+oneminomega*(abs6+abs12)&
   &           +plim)
   IF (x6 .GE. 0.) THEN
   dp2 = x6
   CALL PUSHCONTROL1B(0)
   ELSE
   dp2 = -x6
   CALL PUSHCONTROL1B(1)
   END IF
   ! Compute the dissipation coefficients for this face.
   CALL PUSHREAL8(ppor)
   ppor = zero
   IF (pork(i, j, k) .EQ. normalflux) ppor = one
   IF (lumpeddiss) THEN
   IF (dp1 .LT. dp2) THEN
   y5 = dp2
   CALL PUSHCONTROL1B(0)
   ELSE
   y5 = dp1
   CALL PUSHCONTROL1B(1)
   END IF
   IF (dpmax .GT. y5) THEN
   min5 = y5
   CALL PUSHCONTROL1B(0)
   ELSE
   min5 = dpmax
   CALL PUSHCONTROL1B(1)
   END IF
   CALL PUSHREAL8(dis2)
   dis2 = fis2*ppor*min5 + sigma*fis4*ppor
   CALL PUSHREAL8(dis4)
   dis4 = 0.0
   CALL PUSHCONTROL1B(0)
   ELSE
   IF (dp1 .LT. dp2) THEN
   y6 = dp2
   CALL PUSHCONTROL1B(0)
   ELSE
   y6 = dp1
   CALL PUSHCONTROL1B(1)
   END IF
   IF (dpmax .GT. y6) THEN
   min6 = y6
   CALL PUSHCONTROL1B(0)
   ELSE
   min6 = dpmax
   CALL PUSHCONTROL1B(1)
   END IF
   CALL PUSHREAL8(dis2)
   dis2 = ppor*fis2*min6
   arg1 = ppor*fis4
   CALL PUSHREAL8(dis4)
   dis4 = DIM(arg1, dis2)
   CALL PUSHCONTROL1B(1)
   END IF
   ! Construct the vector of the first and third differences
   ! multiplied by the appropriate constants.
   CALL PUSHREAL8(ddw)
   ddw = w(i, j, k+1, irho) - w(i, j, k, irho)
   CALL PUSHREAL8(dr)
   dr = dis2*ddw - dis4*(w(i, j, k+2, irho)-w(i, j, k-1, irho)-&
   &           three*ddw)
   ddw = w(i, j, k+1, irho)*w(i, j, k+1, ivx) - w(i, j, k, irho)*&
   &           w(i, j, k, ivx)
   CALL PUSHREAL8(dru)
   dru = dis2*ddw - dis4*(w(i, j, k+2, irho)*w(i, j, k+2, ivx)-w(&
   &           i, j, k-1, irho)*w(i, j, k-1, ivx)-three*ddw)
   CALL PUSHREAL8(ddw)
   ddw = w(i, j, k+1, irho)*w(i, j, k+1, ivy) - w(i, j, k, irho)*&
   &           w(i, j, k, ivy)
   CALL PUSHREAL8(drv)
   drv = dis2*ddw - dis4*(w(i, j, k+2, irho)*w(i, j, k+2, ivy)-w(&
   &           i, j, k-1, irho)*w(i, j, k-1, ivy)-three*ddw)
   CALL PUSHREAL8(ddw)
   ddw = w(i, j, k+1, irho)*w(i, j, k+1, ivz) - w(i, j, k, irho)*&
   &           w(i, j, k, ivz)
   CALL PUSHREAL8(drw)
   drw = dis2*ddw - dis4*(w(i, j, k+2, irho)*w(i, j, k+2, ivz)-w(&
   &           i, j, k-1, irho)*w(i, j, k-1, ivz)-three*ddw)
   CALL PUSHREAL8(ddw)
   ddw = w(i, j, k+1, irhoe) - w(i, j, k, irhoe)
   CALL PUSHREAL8(dre)
   dre = dis2*ddw - dis4*(w(i, j, k+2, irhoe)-w(i, j, k-1, irhoe)&
   &           -three*ddw)
   ! In case a k-equation is present, compute the difference
   ! of rhok and store the average value of k. If not present,
   ! set both these values to zero, such that later on no
   ! decision needs to be made anymore.
   IF (correctfork) THEN
   ddw = w(i, j, k+1, irho)*w(i, j, k+1, itu1) - w(i, j, k, &
   &             irho)*w(i, j, k, itu1)
   drk = dis2*ddw - dis4*(w(i, j, k+2, irho)*w(i, j, k+2, itu1)&
   &             -w(i, j, k-1, irho)*w(i, j, k-1, itu1)-three*ddw)
   kavg = half*(w(i, j, k+1, itu1)+w(i, j, k, itu1))
   CALL PUSHCONTROL1B(1)
   ELSE
   drk = zero
   kavg = zero
   CALL PUSHCONTROL1B(0)
   END IF
   ! Compute the average value of gamma and compute some
   ! expressions in which it occurs.
   gammaavg = half*(gamma(i, j, k+1)+gamma(i, j, k))
   gm1 = gammaavg - one
   ovgm1 = one/gm1
   gm53 = gammaavg - five*third
   ! Compute the average state at the interface.
   uavg = half*(w(i, j, k+1, ivx)+w(i, j, k, ivx))
   vavg = half*(w(i, j, k+1, ivy)+w(i, j, k, ivy))
   wavg = half*(w(i, j, k+1, ivz)+w(i, j, k, ivz))
   CALL PUSHREAL8(a2avg)
   a2avg = half*(gamma(i, j, k+1)*p(i, j, k+1)/w(i, j, k+1, irho)&
   &           +gamma(i, j, k)*p(i, j, k)/w(i, j, k, irho))
   CALL PUSHREAL8(sx)
   sx = sk(i, j, k, 1)
   CALL PUSHREAL8(sy)
   sy = sk(i, j, k, 2)
   CALL PUSHREAL8(sz)
   sz = sk(i, j, k, 3)
   CALL PUSHREAL8(area)
   area = SQRT(sx**2 + sy**2 + sz**2)
   IF (1.e-25_realType .LT. area) THEN
   CALL PUSHREAL8(max3)
   max3 = area
   CALL PUSHCONTROL1B(0)
   ELSE
   CALL PUSHREAL8(max3)
   max3 = 1.e-25_realType
   CALL PUSHCONTROL1B(1)
   END IF
   tmp = one/max3
   CALL PUSHREAL8(sx)
   sx = sx*tmp
   CALL PUSHREAL8(sy)
   sy = sy*tmp
   CALL PUSHREAL8(sz)
   sz = sz*tmp
   alphaavg = half*(uavg**2+vavg**2+wavg**2)
   CALL PUSHREAL8(havg)
   havg = alphaavg + ovgm1*(a2avg-gm53*kavg)
   CALL PUSHREAL8(aavg)
   aavg = SQRT(a2avg)
   unavg = uavg*sx + vavg*sy + wavg*sz
   ! The mesh velocity if the face is moving. It must be
   ! divided by the area to obtain a true velocity.
   IF (addgridvelocities) THEN
   sface = sfacek(i, j, k)*tmp
   CALL PUSHCONTROL1B(1)
   ELSE
   CALL PUSHCONTROL1B(0)
   END IF
   IF (unavg - sface + aavg .GE. 0.) THEN
   lam1 = unavg - sface + aavg
   CALL PUSHCONTROL1B(0)
   ELSE
   lam1 = -(unavg-sface+aavg)
   CALL PUSHCONTROL1B(1)
   END IF
   IF (unavg - sface - aavg .GE. 0.) THEN
   lam2 = unavg - sface - aavg
   CALL PUSHCONTROL1B(0)
   ELSE
   lam2 = -(unavg-sface-aavg)
   CALL PUSHCONTROL1B(1)
   END IF
   IF (unavg - sface .GE. 0.) THEN
   CALL PUSHREAL8(lam3)
   lam3 = unavg - sface
   CALL PUSHCONTROL1B(0)
   ELSE
   CALL PUSHREAL8(lam3)
   lam3 = -(unavg-sface)
   CALL PUSHCONTROL1B(1)
   END IF
   rrad = lam3 + aavg
   IF (lam1 .LT. epsacoustic*rrad) THEN
   lam1 = epsacoustic*rrad
   CALL PUSHCONTROL1B(0)
   ELSE
   CALL PUSHCONTROL1B(1)
   lam1 = lam1
   END IF
   IF (lam2 .LT. epsacoustic*rrad) THEN
   lam2 = epsacoustic*rrad
   CALL PUSHCONTROL1B(0)
   ELSE
   CALL PUSHCONTROL1B(1)
   lam2 = lam2
   END IF
   IF (lam3 .LT. epsshear*rrad) THEN
   lam3 = epsshear*rrad
   CALL PUSHCONTROL1B(0)
   ELSE
   lam3 = lam3
   CALL PUSHCONTROL1B(1)
   END IF
   ! Multiply the eigenvalues by the area to obtain
   ! the correct values for the dissipation term.
   CALL PUSHREAL8(lam1)
   lam1 = lam1*area
   CALL PUSHREAL8(lam2)
   lam2 = lam2*area
   CALL PUSHREAL8(lam3)
   lam3 = lam3*area
   ! Some abbreviations, which occur quite often in the
   ! dissipation terms.
   abv1 = half*(lam1+lam2)
   CALL PUSHREAL8(abv2)
   abv2 = half*(lam1-lam2)
   CALL PUSHREAL8(abv3)
   abv3 = abv1 - lam3
   CALL PUSHREAL8(abv4)
   abv4 = gm1*(alphaavg*dr-uavg*dru-vavg*drv-wavg*drw+dre) - gm53&
   &           *drk
   ! Compute and scatter the dissipative flux.
   ! Density.
   ! X-momentum.
   ! Y-momentum.
   ! Z-momentum.
   ! Energy.
   ! Set dp1 to dp2 for the next face.
   dp1 = dp2
   END DO
   END DO
   END DO
   plimd = 0.0_8
   sfaced = 0.0_8
   DO j=jl,2,-1
   DO i=il,2,-1
   dp1d = 0.0_8
   DO k=kl,1,-1
   dp2d = dp1d
   fsd = fwd(i, j, k+1, irhoe) - fwd(i, j, k, irhoe)
   wavg = half*(w(i, j, k+1, ivz)+w(i, j, k, ivz))
   vavg = half*(w(i, j, k+1, ivy)+w(i, j, k, ivy))
   uavg = half*(w(i, j, k+1, ivx)+w(i, j, k, ivx))
   unavg = uavg*sx + vavg*sy + wavg*sz
   abv5 = sx*dru + sy*drv + sz*drw - unavg*dr
   ovaavg = one/aavg
   ova2avg = one/a2avg
   abv6 = abv3*abv4*ova2avg + abv2*abv5*ovaavg
   abv7 = abv2*abv4*ovaavg + abv3*abv5
   lam3d = dre*fsd
   dred = lam3*fsd
   havgd = abv6*fsd
   abv6d = havg*fsd
   unavgd = abv7*fsd
   abv7d = unavg*fsd
   fsd = fwd(i, j, k+1, imz) - fwd(i, j, k, imz)
   lam3d = lam3d + drw*fsd
   drwd = lam3*fsd
   wavgd = abv6*fsd
   abv6d = abv6d + wavg*fsd
   szd = abv7*fsd
   abv7d = abv7d + sz*fsd
   fsd = fwd(i, j, k+1, imy) - fwd(i, j, k, imy)
   lam3d = lam3d + drv*fsd
   drvd = lam3*fsd
   vavgd = abv6*fsd
   abv6d = abv6d + vavg*fsd
   syd = abv7*fsd
   abv7d = abv7d + sy*fsd
   fsd = fwd(i, j, k+1, imx) - fwd(i, j, k, imx)
   lam3d = lam3d + dru*fsd
   drud = lam3*fsd
   uavgd = abv6*fsd
   abv6d = abv6d + uavg*fsd
   sxd = abv7*fsd
   abv7d = abv7d + sx*fsd
   fsd = fwd(i, j, k+1, irho) - fwd(i, j, k, irho)
   abv6d = abv6d + fsd
   abv2d = ovaavg*abv5*abv6d + ovaavg*abv4*abv7d
   abv4d = ova2avg*abv3*abv6d + ovaavg*abv2*abv7d
   ovaavgd = abv2*abv5*abv6d + abv2*abv4*abv7d
   abv3d = ova2avg*abv4*abv6d + abv5*abv7d
   lam3d = lam3d + dr*fsd - abv3d
   abv5d = ovaavg*abv2*abv6d + abv3*abv7d
   ova2avgd = abv3*abv4*abv6d
   sxd = sxd + dru*abv5d
   syd = syd + drv*abv5d
   szd = szd + drw*abv5d
   unavgd = unavgd - dr*abv5d
   gammaavg = half*(gamma(i, j, k+1)+gamma(i, j, k))
   gm1 = gammaavg - one
   gm53 = gammaavg - five*third
   alphaavg = half*(uavg**2+vavg**2+wavg**2)
   CALL POPREAL8(abv4)
   tempd49 = gm1*abv4d
   drd = alphaavg*tempd49 - unavg*abv5d + lam3*fsd
   drud = drud + sx*abv5d - uavg*tempd49
   drvd = drvd + sy*abv5d - vavg*tempd49
   drwd = drwd + sz*abv5d - wavg*tempd49
   alphaavgd = dr*tempd49
   uavgd = uavgd - dru*tempd49
   vavgd = vavgd - drv*tempd49
   dred = dred + tempd49
   wavgd = wavgd - drw*tempd49
   drkd = -(gm53*abv4d)
   CALL POPREAL8(abv3)
   abv1d = abv3d
   CALL POPREAL8(abv2)
   lam1d = half*abv1d + half*abv2d
   lam2d = half*abv1d - half*abv2d
   CALL POPREAL8(lam3)
   CALL POPREAL8(lam2)
   CALL POPREAL8(lam1)
   aread = lam2*lam2d + lam1*lam1d + lam3*lam3d
   lam3d = area*lam3d
   lam2d = area*lam2d
   lam1d = area*lam1d
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   rradd = epsshear*lam3d
   lam3d = 0.0_8
   ELSE
   rradd = 0.0_8
   END IF
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   rradd = rradd + epsacoustic*lam2d
   lam2d = 0.0_8
   END IF
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   rradd = rradd + epsacoustic*lam1d
   lam1d = 0.0_8
   END IF
   lam3d = lam3d + rradd
   aavgd = rradd
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   CALL POPREAL8(lam3)
   unavgd = unavgd + lam3d
   sfaced = sfaced - lam3d
   ELSE
   CALL POPREAL8(lam3)
   sfaced = sfaced + lam3d
   unavgd = unavgd - lam3d
   END IF
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   unavgd = unavgd + lam2d
   sfaced = sfaced - lam2d
   aavgd = aavgd - lam2d
   ELSE
   sfaced = sfaced + lam2d
   unavgd = unavgd - lam2d
   aavgd = aavgd + lam2d
   END IF
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   unavgd = unavgd + lam1d
   sfaced = sfaced - lam1d
   aavgd = aavgd + lam1d
   ELSE
   sfaced = sfaced + lam1d
   unavgd = unavgd - lam1d
   aavgd = aavgd - lam1d
   END IF
   tmp = one/max3
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   tmpd = 0.0_8
   ELSE
   tmpd = sfacek(i, j, k)*sfaced
   sfaced = 0.0_8
   END IF
   alphaavgd = alphaavgd + havgd
   tempd48 = half*alphaavgd
   ovgm1 = one/gm1
   aavgd = aavgd - one*ovaavgd/aavg**2
   IF (a2avg .EQ. 0.0_8) THEN
   a2avgd = ovgm1*havgd - one*ova2avgd/a2avg**2
   ELSE
   a2avgd = aavgd/(2.0*SQRT(a2avg)) + ovgm1*havgd - one*&
   &             ova2avgd/a2avg**2
   END IF
   uavgd = uavgd + 2*uavg*tempd48 + sx*unavgd
   sxd = sxd + uavg*unavgd
   vavgd = vavgd + 2*vavg*tempd48 + sy*unavgd
   syd = syd + vavg*unavgd
   wavgd = wavgd + 2*wavg*tempd48 + sz*unavgd
   szd = szd + wavg*unavgd
   CALL POPREAL8(aavg)
   CALL POPREAL8(havg)
   kavgd = -(ovgm1*gm53*havgd)
   CALL POPREAL8(sz)
   CALL POPREAL8(sy)
   CALL POPREAL8(sx)
   tmpd = tmpd + sy*syd + sx*sxd + sz*szd
   szd = tmp*szd
   syd = tmp*syd
   sxd = tmp*sxd
   max3d = -(one*tmpd/max3**2)
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   CALL POPREAL8(max3)
   aread = aread + max3d
   ELSE
   CALL POPREAL8(max3)
   END IF
   CALL POPREAL8(area)
   IF (sx**2 + sy**2 + sz**2 .EQ. 0.0_8) THEN
   tempd45 = 0.0
   ELSE
   tempd45 = aread/(2.0*SQRT(sx**2+sy**2+sz**2))
   END IF
   sxd = sxd + 2*sx*tempd45
   syd = syd + 2*sy*tempd45
   szd = szd + 2*sz*tempd45
   CALL POPREAL8(sz)
   skd(i, j, k, 3) = skd(i, j, k, 3) + szd
   CALL POPREAL8(sy)
   skd(i, j, k, 2) = skd(i, j, k, 2) + syd
   CALL POPREAL8(sx)
   skd(i, j, k, 1) = skd(i, j, k, 1) + sxd
   CALL POPREAL8(a2avg)
   temp58 = w(i, j, k, irho)
   temp57 = w(i, j, k+1, irho)
   tempd46 = gamma(i, j, k+1)*half*a2avgd/temp57
   tempd47 = gamma(i, j, k)*half*a2avgd/temp58
   pd(i, j, k+1) = pd(i, j, k+1) + tempd46
   wd(i, j, k+1, irho) = wd(i, j, k+1, irho) - p(i, j, k+1)*&
   &           tempd46/temp57
   pd(i, j, k) = pd(i, j, k) + tempd47
   wd(i, j, k, irho) = wd(i, j, k, irho) - p(i, j, k)*tempd47/&
   &           temp58
   wd(i, j, k+1, ivz) = wd(i, j, k+1, ivz) + half*wavgd
   wd(i, j, k, ivz) = wd(i, j, k, ivz) + half*wavgd
   wd(i, j, k+1, ivy) = wd(i, j, k+1, ivy) + half*vavgd
   wd(i, j, k, ivy) = wd(i, j, k, ivy) + half*vavgd
   wd(i, j, k+1, ivx) = wd(i, j, k+1, ivx) + half*uavgd
   wd(i, j, k, ivx) = wd(i, j, k, ivx) + half*uavgd
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   dis2d = 0.0_8
   dis4d = 0.0_8
   ELSE
   wd(i, j, k+1, itu1) = wd(i, j, k+1, itu1) + half*kavgd
   wd(i, j, k, itu1) = wd(i, j, k, itu1) + half*kavgd
   temp56 = w(i, j, k-1, itu1)
   temp55 = w(i, j, k-1, irho)
   temp54 = w(i, j, k+2, itu1)
   temp53 = w(i, j, k+2, irho)
   tempd44 = -(dis4*drkd)
   dis2d = ddw*drkd
   ddwd = dis2*drkd - three*tempd44
   dis4d = -((temp53*temp54-temp55*temp56-three*ddw)*drkd)
   wd(i, j, k+2, irho) = wd(i, j, k+2, irho) + temp54*tempd44
   wd(i, j, k+2, itu1) = wd(i, j, k+2, itu1) + temp53*tempd44
   wd(i, j, k-1, irho) = wd(i, j, k-1, irho) - temp56*tempd44
   wd(i, j, k-1, itu1) = wd(i, j, k-1, itu1) - temp55*tempd44
   wd(i, j, k+1, irho) = wd(i, j, k+1, irho) + w(i, j, k+1, &
   &             itu1)*ddwd
   wd(i, j, k+1, itu1) = wd(i, j, k+1, itu1) + w(i, j, k+1, &
   &             irho)*ddwd
   wd(i, j, k, irho) = wd(i, j, k, irho) - w(i, j, k, itu1)*&
   &             ddwd
   wd(i, j, k, itu1) = wd(i, j, k, itu1) - w(i, j, k, irho)*&
   &             ddwd
   END IF
   ddw = w(i, j, k+1, irhoe) - w(i, j, k, irhoe)
   CALL POPREAL8(dre)
   tempd39 = -(dis4*dred)
   dis2d = dis2d + ddw*dred
   ddwd = dis2*dred - three*tempd39
   dis4d = dis4d - (w(i, j, k+2, irhoe)-w(i, j, k-1, irhoe)-three&
   &           *ddw)*dred
   wd(i, j, k+2, irhoe) = wd(i, j, k+2, irhoe) + tempd39
   wd(i, j, k-1, irhoe) = wd(i, j, k-1, irhoe) - tempd39
   CALL POPREAL8(ddw)
   wd(i, j, k+1, irhoe) = wd(i, j, k+1, irhoe) + ddwd
   wd(i, j, k, irhoe) = wd(i, j, k, irhoe) - ddwd
   CALL POPREAL8(drw)
   temp52 = w(i, j, k-1, ivz)
   temp51 = w(i, j, k-1, irho)
   temp50 = w(i, j, k+2, ivz)
   temp49 = w(i, j, k+2, irho)
   tempd40 = -(dis4*drwd)
   dis2d = dis2d + ddw*drwd
   ddwd = dis2*drwd - three*tempd40
   dis4d = dis4d - (temp49*temp50-temp51*temp52-three*ddw)*drwd
   wd(i, j, k+2, irho) = wd(i, j, k+2, irho) + temp50*tempd40
   wd(i, j, k+2, ivz) = wd(i, j, k+2, ivz) + temp49*tempd40
   wd(i, j, k-1, irho) = wd(i, j, k-1, irho) - temp52*tempd40
   wd(i, j, k-1, ivz) = wd(i, j, k-1, ivz) - temp51*tempd40
   CALL POPREAL8(ddw)
   wd(i, j, k+1, irho) = wd(i, j, k+1, irho) + w(i, j, k+1, ivz)*&
   &           ddwd
   wd(i, j, k+1, ivz) = wd(i, j, k+1, ivz) + w(i, j, k+1, irho)*&
   &           ddwd
   wd(i, j, k, irho) = wd(i, j, k, irho) - w(i, j, k, ivz)*ddwd
   wd(i, j, k, ivz) = wd(i, j, k, ivz) - w(i, j, k, irho)*ddwd
   CALL POPREAL8(drv)
   temp48 = w(i, j, k-1, ivy)
   temp47 = w(i, j, k-1, irho)
   temp46 = w(i, j, k+2, ivy)
   temp45 = w(i, j, k+2, irho)
   tempd41 = -(dis4*drvd)
   dis2d = dis2d + ddw*drvd
   ddwd = dis2*drvd - three*tempd41
   dis4d = dis4d - (temp45*temp46-temp47*temp48-three*ddw)*drvd
   wd(i, j, k+2, irho) = wd(i, j, k+2, irho) + temp46*tempd41
   wd(i, j, k+2, ivy) = wd(i, j, k+2, ivy) + temp45*tempd41
   wd(i, j, k-1, irho) = wd(i, j, k-1, irho) - temp48*tempd41
   wd(i, j, k-1, ivy) = wd(i, j, k-1, ivy) - temp47*tempd41
   CALL POPREAL8(ddw)
   wd(i, j, k+1, irho) = wd(i, j, k+1, irho) + w(i, j, k+1, ivy)*&
   &           ddwd
   wd(i, j, k+1, ivy) = wd(i, j, k+1, ivy) + w(i, j, k+1, irho)*&
   &           ddwd
   wd(i, j, k, irho) = wd(i, j, k, irho) - w(i, j, k, ivy)*ddwd
   wd(i, j, k, ivy) = wd(i, j, k, ivy) - w(i, j, k, irho)*ddwd
   CALL POPREAL8(dru)
   temp44 = w(i, j, k-1, ivx)
   temp43 = w(i, j, k-1, irho)
   temp42 = w(i, j, k+2, ivx)
   temp41 = w(i, j, k+2, irho)
   tempd42 = -(dis4*drud)
   dis2d = dis2d + ddw*drud
   ddwd = dis2*drud - three*tempd42
   dis4d = dis4d - (temp41*temp42-temp43*temp44-three*ddw)*drud
   wd(i, j, k+2, irho) = wd(i, j, k+2, irho) + temp42*tempd42
   wd(i, j, k+2, ivx) = wd(i, j, k+2, ivx) + temp41*tempd42
   wd(i, j, k-1, irho) = wd(i, j, k-1, irho) - temp44*tempd42
   wd(i, j, k-1, ivx) = wd(i, j, k-1, ivx) - temp43*tempd42
   wd(i, j, k+1, irho) = wd(i, j, k+1, irho) + w(i, j, k+1, ivx)*&
   &           ddwd
   wd(i, j, k+1, ivx) = wd(i, j, k+1, ivx) + w(i, j, k+1, irho)*&
   &           ddwd
   wd(i, j, k, irho) = wd(i, j, k, irho) - w(i, j, k, ivx)*ddwd
   wd(i, j, k, ivx) = wd(i, j, k, ivx) - w(i, j, k, irho)*ddwd
   ddw = w(i, j, k+1, irho) - w(i, j, k, irho)
   CALL POPREAL8(dr)
   tempd43 = -(dis4*drd)
   dis2d = dis2d + ddw*drd
   ddwd = dis2*drd - three*tempd43
   dis4d = dis4d - (w(i, j, k+2, irho)-w(i, j, k-1, irho)-three*&
   &           ddw)*drd
   wd(i, j, k+2, irho) = wd(i, j, k+2, irho) + tempd43
   wd(i, j, k-1, irho) = wd(i, j, k-1, irho) - tempd43
   CALL POPREAL8(ddw)
   wd(i, j, k+1, irho) = wd(i, j, k+1, irho) + ddwd
   wd(i, j, k, irho) = wd(i, j, k, irho) - ddwd
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   CALL POPREAL8(dis4)
   CALL POPREAL8(dis2)
   min5d = fis2*ppor*dis2d
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   y5d = min5d
   ELSE
   y5d = 0.0_8
   END IF
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   dp2d = dp2d + y5d
   dp1d = 0.0_8
   ELSE
   dp1d = y5d
   END IF
   ELSE
   arg1 = ppor*fis4
   CALL POPREAL8(dis4)
   arg1d = 0.0_8
   CALL DIM_B(arg1, arg1d, dis2, dis2d, dis4d)
   CALL POPREAL8(dis2)
   min6d = ppor*fis2*dis2d
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   y6d = min6d
   ELSE
   y6d = 0.0_8
   END IF
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   dp2d = dp2d + y6d
   dp1d = 0.0_8
   ELSE
   dp1d = y6d
   END IF
   END IF
   CALL POPREAL8(ppor)
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   x6d = dp2d
   ELSE
   x6d = -dp2d
   END IF
   temp40 = omega*(p(i, j, k+2)+two*p(i, j, k+1)+p(i, j, k)) + &
   &           oneminomega*(abs6+abs12) + plim
   tempd36 = x6d/temp40
   tempd37 = -((p(i, j, k+2)-two*p(i, j, k+1)+p(i, j, k))*tempd36&
   &           /temp40)
   tempd38 = omega*tempd37
   pd(i, j, k+2) = pd(i, j, k+2) + tempd38 + tempd36
   pd(i, j, k+1) = pd(i, j, k+1) + two*tempd38 - two*tempd36
   pd(i, j, k) = pd(i, j, k) + tempd38 + tempd36
   abs6d = oneminomega*tempd37
   abs12d = oneminomega*tempd37
   plimd = plimd + tempd37
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   CALL POPREAL8(abs12)
   pd(i, j, k+1) = pd(i, j, k+1) + abs12d
   pd(i, j, k) = pd(i, j, k) - abs12d
   ELSE
   CALL POPREAL8(abs12)
   pd(i, j, k) = pd(i, j, k) + abs12d
   pd(i, j, k+1) = pd(i, j, k+1) - abs12d
   END IF
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   CALL POPREAL8(abs6)
   pd(i, j, k+1) = pd(i, j, k+1) + abs6d
   pd(i, j, k+2) = pd(i, j, k+2) - abs6d
   ELSE
   CALL POPREAL8(abs6)
   pd(i, j, k+2) = pd(i, j, k+2) + abs6d
   pd(i, j, k+1) = pd(i, j, k+1) - abs6d
   END IF
   END DO
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   x5d = dp1d
   ELSE
   x5d = -dp1d
   END IF
   temp39 = omega*(p(i, j, 2)+two*p(i, j, 1)+p(i, j, 0)) + &
   &         oneminomega*(abs5+abs11) + plim
   tempd33 = x5d/temp39
   tempd34 = -((p(i, j, 2)-two*p(i, j, 1)+p(i, j, 0))*tempd33/&
   &         temp39)
   tempd35 = omega*tempd34
   pd(i, j, 2) = pd(i, j, 2) + tempd35 + tempd33
   pd(i, j, 1) = pd(i, j, 1) + two*tempd35 - two*tempd33
   pd(i, j, 0) = pd(i, j, 0) + tempd35 + tempd33
   abs5d = oneminomega*tempd34
   abs11d = oneminomega*tempd34
   plimd = plimd + tempd34
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   CALL POPREAL8(abs11)
   pd(i, j, 1) = pd(i, j, 1) + abs11d
   pd(i, j, 0) = pd(i, j, 0) - abs11d
   ELSE
   CALL POPREAL8(abs11)
   pd(i, j, 0) = pd(i, j, 0) + abs11d
   pd(i, j, 1) = pd(i, j, 1) - abs11d
   END IF
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   CALL POPREAL8(abs5)
   pd(i, j, 1) = pd(i, j, 1) + abs5d
   pd(i, j, 2) = pd(i, j, 2) - abs5d
   ELSE
   CALL POPREAL8(abs5)
   pd(i, j, 2) = pd(i, j, 2) + abs5d
   pd(i, j, 1) = pd(i, j, 1) - abs5d
   END IF
   END DO
   END DO
   DO k=kl,2,-1
   DO i=il,2,-1
   dp1d = 0.0_8
   DO j=jl,1,-1
   dp2d = dp1d
   fsd = fwd(i, j+1, k, irhoe) - fwd(i, j, k, irhoe)
   wavg = half*(w(i, j+1, k, ivz)+w(i, j, k, ivz))
   vavg = half*(w(i, j+1, k, ivy)+w(i, j, k, ivy))
   uavg = half*(w(i, j+1, k, ivx)+w(i, j, k, ivx))
   unavg = uavg*sx + vavg*sy + wavg*sz
   abv5 = sx*dru + sy*drv + sz*drw - unavg*dr
   ovaavg = one/aavg
   ova2avg = one/a2avg
   abv6 = abv3*abv4*ova2avg + abv2*abv5*ovaavg
   abv7 = abv2*abv4*ovaavg + abv3*abv5
   lam3d = dre*fsd
   dred = lam3*fsd
   havgd = abv6*fsd
   abv6d = havg*fsd
   unavgd = abv7*fsd
   abv7d = unavg*fsd
   fsd = fwd(i, j+1, k, imz) - fwd(i, j, k, imz)
   lam3d = lam3d + drw*fsd
   drwd = lam3*fsd
   wavgd = abv6*fsd
   abv6d = abv6d + wavg*fsd
   szd = abv7*fsd
   abv7d = abv7d + sz*fsd
   fsd = fwd(i, j+1, k, imy) - fwd(i, j, k, imy)
   lam3d = lam3d + drv*fsd
   drvd = lam3*fsd
   vavgd = abv6*fsd
   abv6d = abv6d + vavg*fsd
   syd = abv7*fsd
   abv7d = abv7d + sy*fsd
   fsd = fwd(i, j+1, k, imx) - fwd(i, j, k, imx)
   lam3d = lam3d + dru*fsd
   drud = lam3*fsd
   uavgd = abv6*fsd
   abv6d = abv6d + uavg*fsd
   sxd = abv7*fsd
   abv7d = abv7d + sx*fsd
   fsd = fwd(i, j+1, k, irho) - fwd(i, j, k, irho)
   abv6d = abv6d + fsd
   abv2d = ovaavg*abv5*abv6d + ovaavg*abv4*abv7d
   abv4d = ova2avg*abv3*abv6d + ovaavg*abv2*abv7d
   ovaavgd = abv2*abv5*abv6d + abv2*abv4*abv7d
   abv3d = ova2avg*abv4*abv6d + abv5*abv7d
   lam3d = lam3d + dr*fsd - abv3d
   abv5d = ovaavg*abv2*abv6d + abv3*abv7d
   ova2avgd = abv3*abv4*abv6d
   sxd = sxd + dru*abv5d
   syd = syd + drv*abv5d
   szd = szd + drw*abv5d
   unavgd = unavgd - dr*abv5d
   gammaavg = half*(gamma(i, j+1, k)+gamma(i, j, k))
   gm1 = gammaavg - one
   gm53 = gammaavg - five*third
   alphaavg = half*(uavg**2+vavg**2+wavg**2)
   CALL POPREAL8(abv4)
   tempd32 = gm1*abv4d
   drd = alphaavg*tempd32 - unavg*abv5d + lam3*fsd
   drud = drud + sx*abv5d - uavg*tempd32
   drvd = drvd + sy*abv5d - vavg*tempd32
   drwd = drwd + sz*abv5d - wavg*tempd32
   alphaavgd = dr*tempd32
   uavgd = uavgd - dru*tempd32
   vavgd = vavgd - drv*tempd32
   dred = dred + tempd32
   wavgd = wavgd - drw*tempd32
   drkd = -(gm53*abv4d)
   CALL POPREAL8(abv3)
   abv1d = abv3d
   CALL POPREAL8(abv2)
   lam1d = half*abv1d + half*abv2d
   lam2d = half*abv1d - half*abv2d
   CALL POPREAL8(lam3)
   CALL POPREAL8(lam2)
   CALL POPREAL8(lam1)
   aread = lam2*lam2d + lam1*lam1d + lam3*lam3d
   lam3d = area*lam3d
   lam2d = area*lam2d
   lam1d = area*lam1d
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   rradd = epsshear*lam3d
   lam3d = 0.0_8
   ELSE
   rradd = 0.0_8
   END IF
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   rradd = rradd + epsacoustic*lam2d
   lam2d = 0.0_8
   END IF
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   rradd = rradd + epsacoustic*lam1d
   lam1d = 0.0_8
   END IF
   lam3d = lam3d + rradd
   aavgd = rradd
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   CALL POPREAL8(lam3)
   unavgd = unavgd + lam3d
   sfaced = sfaced - lam3d
   ELSE
   CALL POPREAL8(lam3)
   sfaced = sfaced + lam3d
   unavgd = unavgd - lam3d
   END IF
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   unavgd = unavgd + lam2d
   sfaced = sfaced - lam2d
   aavgd = aavgd - lam2d
   ELSE
   sfaced = sfaced + lam2d
   unavgd = unavgd - lam2d
   aavgd = aavgd + lam2d
   END IF
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   unavgd = unavgd + lam1d
   sfaced = sfaced - lam1d
   aavgd = aavgd + lam1d
   ELSE
   sfaced = sfaced + lam1d
   unavgd = unavgd - lam1d
   aavgd = aavgd - lam1d
   END IF
   tmp = one/max2
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   tmpd = 0.0_8
   ELSE
   tmpd = sfacej(i, j, k)*sfaced
   sfaced = 0.0_8
   END IF
   alphaavgd = alphaavgd + havgd
   tempd31 = half*alphaavgd
   ovgm1 = one/gm1
   aavgd = aavgd - one*ovaavgd/aavg**2
   IF (a2avg .EQ. 0.0_8) THEN
   a2avgd = ovgm1*havgd - one*ova2avgd/a2avg**2
   ELSE
   a2avgd = aavgd/(2.0*SQRT(a2avg)) + ovgm1*havgd - one*&
   &             ova2avgd/a2avg**2
   END IF
   uavgd = uavgd + 2*uavg*tempd31 + sx*unavgd
   sxd = sxd + uavg*unavgd
   vavgd = vavgd + 2*vavg*tempd31 + sy*unavgd
   syd = syd + vavg*unavgd
   wavgd = wavgd + 2*wavg*tempd31 + sz*unavgd
   szd = szd + wavg*unavgd
   CALL POPREAL8(aavg)
   CALL POPREAL8(havg)
   kavgd = -(ovgm1*gm53*havgd)
   CALL POPREAL8(sz)
   CALL POPREAL8(sy)
   CALL POPREAL8(sx)
   tmpd = tmpd + sy*syd + sx*sxd + sz*szd
   szd = tmp*szd
   syd = tmp*syd
   sxd = tmp*sxd
   max2d = -(one*tmpd/max2**2)
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   CALL POPREAL8(max2)
   aread = aread + max2d
   ELSE
   CALL POPREAL8(max2)
   END IF
   CALL POPREAL8(area)
   IF (sx**2 + sy**2 + sz**2 .EQ. 0.0_8) THEN
   tempd28 = 0.0
   ELSE
   tempd28 = aread/(2.0*SQRT(sx**2+sy**2+sz**2))
   END IF
   sxd = sxd + 2*sx*tempd28
   syd = syd + 2*sy*tempd28
   szd = szd + 2*sz*tempd28
   CALL POPREAL8(sz)
   sjd(i, j, k, 3) = sjd(i, j, k, 3) + szd
   CALL POPREAL8(sy)
   sjd(i, j, k, 2) = sjd(i, j, k, 2) + syd
   CALL POPREAL8(sx)
   sjd(i, j, k, 1) = sjd(i, j, k, 1) + sxd
   CALL POPREAL8(a2avg)
   temp38 = w(i, j, k, irho)
   temp37 = w(i, j+1, k, irho)
   tempd29 = gamma(i, j+1, k)*half*a2avgd/temp37
   tempd30 = gamma(i, j, k)*half*a2avgd/temp38
   pd(i, j+1, k) = pd(i, j+1, k) + tempd29
   wd(i, j+1, k, irho) = wd(i, j+1, k, irho) - p(i, j+1, k)*&
   &           tempd29/temp37
   pd(i, j, k) = pd(i, j, k) + tempd30
   wd(i, j, k, irho) = wd(i, j, k, irho) - p(i, j, k)*tempd30/&
   &           temp38
   wd(i, j+1, k, ivz) = wd(i, j+1, k, ivz) + half*wavgd
   wd(i, j, k, ivz) = wd(i, j, k, ivz) + half*wavgd
   wd(i, j+1, k, ivy) = wd(i, j+1, k, ivy) + half*vavgd
   wd(i, j, k, ivy) = wd(i, j, k, ivy) + half*vavgd
   wd(i, j+1, k, ivx) = wd(i, j+1, k, ivx) + half*uavgd
   wd(i, j, k, ivx) = wd(i, j, k, ivx) + half*uavgd
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   dis2d = 0.0_8
   dis4d = 0.0_8
   ELSE
   wd(i, j, k, itu1) = wd(i, j, k, itu1) + half*kavgd
   wd(i, j+1, k, itu1) = wd(i, j+1, k, itu1) + half*kavgd
   temp36 = w(i, j-1, k, itu1)
   temp35 = w(i, j-1, k, irho)
   temp34 = w(i, j+2, k, itu1)
   temp33 = w(i, j+2, k, irho)
   tempd27 = -(dis4*drkd)
   dis2d = ddw*drkd
   ddwd = dis2*drkd - three*tempd27
   dis4d = -((temp33*temp34-temp35*temp36-three*ddw)*drkd)
   wd(i, j+2, k, irho) = wd(i, j+2, k, irho) + temp34*tempd27
   wd(i, j+2, k, itu1) = wd(i, j+2, k, itu1) + temp33*tempd27
   wd(i, j-1, k, irho) = wd(i, j-1, k, irho) - temp36*tempd27
   wd(i, j-1, k, itu1) = wd(i, j-1, k, itu1) - temp35*tempd27
   wd(i, j+1, k, irho) = wd(i, j+1, k, irho) + w(i, j+1, k, &
   &             itu1)*ddwd
   wd(i, j+1, k, itu1) = wd(i, j+1, k, itu1) + w(i, j+1, k, &
   &             irho)*ddwd
   wd(i, j, k, irho) = wd(i, j, k, irho) - w(i, j, k, itu1)*&
   &             ddwd
   wd(i, j, k, itu1) = wd(i, j, k, itu1) - w(i, j, k, irho)*&
   &             ddwd
   END IF
   ddw = w(i, j+1, k, irhoe) - w(i, j, k, irhoe)
   CALL POPREAL8(dre)
   tempd22 = -(dis4*dred)
   dis2d = dis2d + ddw*dred
   ddwd = dis2*dred - three*tempd22
   dis4d = dis4d - (w(i, j+2, k, irhoe)-w(i, j-1, k, irhoe)-three&
   &           *ddw)*dred
   wd(i, j+2, k, irhoe) = wd(i, j+2, k, irhoe) + tempd22
   wd(i, j-1, k, irhoe) = wd(i, j-1, k, irhoe) - tempd22
   CALL POPREAL8(ddw)
   wd(i, j+1, k, irhoe) = wd(i, j+1, k, irhoe) + ddwd
   wd(i, j, k, irhoe) = wd(i, j, k, irhoe) - ddwd
   CALL POPREAL8(drw)
   temp32 = w(i, j-1, k, ivz)
   temp31 = w(i, j-1, k, irho)
   temp30 = w(i, j+2, k, ivz)
   temp29 = w(i, j+2, k, irho)
   tempd23 = -(dis4*drwd)
   dis2d = dis2d + ddw*drwd
   ddwd = dis2*drwd - three*tempd23
   dis4d = dis4d - (temp29*temp30-temp31*temp32-three*ddw)*drwd
   wd(i, j+2, k, irho) = wd(i, j+2, k, irho) + temp30*tempd23
   wd(i, j+2, k, ivz) = wd(i, j+2, k, ivz) + temp29*tempd23
   wd(i, j-1, k, irho) = wd(i, j-1, k, irho) - temp32*tempd23
   wd(i, j-1, k, ivz) = wd(i, j-1, k, ivz) - temp31*tempd23
   CALL POPREAL8(ddw)
   wd(i, j+1, k, irho) = wd(i, j+1, k, irho) + w(i, j+1, k, ivz)*&
   &           ddwd
   wd(i, j+1, k, ivz) = wd(i, j+1, k, ivz) + w(i, j+1, k, irho)*&
   &           ddwd
   wd(i, j, k, irho) = wd(i, j, k, irho) - w(i, j, k, ivz)*ddwd
   wd(i, j, k, ivz) = wd(i, j, k, ivz) - w(i, j, k, irho)*ddwd
   CALL POPREAL8(drv)
   temp28 = w(i, j-1, k, ivy)
   temp27 = w(i, j-1, k, irho)
   temp26 = w(i, j+2, k, ivy)
   temp25 = w(i, j+2, k, irho)
   tempd24 = -(dis4*drvd)
   dis2d = dis2d + ddw*drvd
   ddwd = dis2*drvd - three*tempd24
   dis4d = dis4d - (temp25*temp26-temp27*temp28-three*ddw)*drvd
   wd(i, j+2, k, irho) = wd(i, j+2, k, irho) + temp26*tempd24
   wd(i, j+2, k, ivy) = wd(i, j+2, k, ivy) + temp25*tempd24
   wd(i, j-1, k, irho) = wd(i, j-1, k, irho) - temp28*tempd24
   wd(i, j-1, k, ivy) = wd(i, j-1, k, ivy) - temp27*tempd24
   CALL POPREAL8(ddw)
   wd(i, j+1, k, irho) = wd(i, j+1, k, irho) + w(i, j+1, k, ivy)*&
   &           ddwd
   wd(i, j+1, k, ivy) = wd(i, j+1, k, ivy) + w(i, j+1, k, irho)*&
   &           ddwd
   wd(i, j, k, irho) = wd(i, j, k, irho) - w(i, j, k, ivy)*ddwd
   wd(i, j, k, ivy) = wd(i, j, k, ivy) - w(i, j, k, irho)*ddwd
   CALL POPREAL8(dru)
   temp24 = w(i, j-1, k, ivx)
   temp23 = w(i, j-1, k, irho)
   temp22 = w(i, j+2, k, ivx)
   temp21 = w(i, j+2, k, irho)
   tempd25 = -(dis4*drud)
   dis2d = dis2d + ddw*drud
   ddwd = dis2*drud - three*tempd25
   dis4d = dis4d - (temp21*temp22-temp23*temp24-three*ddw)*drud
   wd(i, j+2, k, irho) = wd(i, j+2, k, irho) + temp22*tempd25
   wd(i, j+2, k, ivx) = wd(i, j+2, k, ivx) + temp21*tempd25
   wd(i, j-1, k, irho) = wd(i, j-1, k, irho) - temp24*tempd25
   wd(i, j-1, k, ivx) = wd(i, j-1, k, ivx) - temp23*tempd25
   wd(i, j+1, k, irho) = wd(i, j+1, k, irho) + w(i, j+1, k, ivx)*&
   &           ddwd
   wd(i, j+1, k, ivx) = wd(i, j+1, k, ivx) + w(i, j+1, k, irho)*&
   &           ddwd
   wd(i, j, k, irho) = wd(i, j, k, irho) - w(i, j, k, ivx)*ddwd
   wd(i, j, k, ivx) = wd(i, j, k, ivx) - w(i, j, k, irho)*ddwd
   ddw = w(i, j+1, k, irho) - w(i, j, k, irho)
   CALL POPREAL8(dr)
   tempd26 = -(dis4*drd)
   dis2d = dis2d + ddw*drd
   ddwd = dis2*drd - three*tempd26
   dis4d = dis4d - (w(i, j+2, k, irho)-w(i, j-1, k, irho)-three*&
   &           ddw)*drd
   wd(i, j+2, k, irho) = wd(i, j+2, k, irho) + tempd26
   wd(i, j-1, k, irho) = wd(i, j-1, k, irho) - tempd26
   CALL POPREAL8(ddw)
   wd(i, j+1, k, irho) = wd(i, j+1, k, irho) + ddwd
   wd(i, j, k, irho) = wd(i, j, k, irho) - ddwd
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   CALL POPREAL8(dis4)
   CALL POPREAL8(dis2)
   min3d = fis2*ppor*dis2d
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   y3d = min3d
   ELSE
   y3d = 0.0_8
   END IF
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   dp2d = dp2d + y3d
   dp1d = 0.0_8
   ELSE
   dp1d = y3d
   END IF
   ELSE
   arg1 = ppor*fis4
   CALL POPREAL8(dis4)
   arg1d = 0.0_8
   CALL DIM_B(arg1, arg1d, dis2, dis2d, dis4d)
   CALL POPREAL8(dis2)
   min4d = ppor*fis2*dis2d
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   y4d = min4d
   ELSE
   y4d = 0.0_8
   END IF
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   dp2d = dp2d + y4d
   dp1d = 0.0_8
   ELSE
   dp1d = y4d
   END IF
   END IF
   CALL POPREAL8(ppor)
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   x4d = dp2d
   ELSE
   x4d = -dp2d
   END IF
   temp20 = omega*(p(i, j+2, k)+two*p(i, j+1, k)+p(i, j, k)) + &
   &           oneminomega*(abs4+abs10) + plim
   tempd19 = x4d/temp20
   tempd20 = -((p(i, j+2, k)-two*p(i, j+1, k)+p(i, j, k))*tempd19&
   &           /temp20)
   tempd21 = omega*tempd20
   pd(i, j+2, k) = pd(i, j+2, k) + tempd21 + tempd19
   pd(i, j+1, k) = pd(i, j+1, k) + two*tempd21 - two*tempd19
   pd(i, j, k) = pd(i, j, k) + tempd21 + tempd19
   abs4d = oneminomega*tempd20
   abs10d = oneminomega*tempd20
   plimd = plimd + tempd20
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   CALL POPREAL8(abs10)
   pd(i, j+1, k) = pd(i, j+1, k) + abs10d
   pd(i, j, k) = pd(i, j, k) - abs10d
   ELSE
   CALL POPREAL8(abs10)
   pd(i, j, k) = pd(i, j, k) + abs10d
   pd(i, j+1, k) = pd(i, j+1, k) - abs10d
   END IF
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   CALL POPREAL8(abs4)
   pd(i, j+1, k) = pd(i, j+1, k) + abs4d
   pd(i, j+2, k) = pd(i, j+2, k) - abs4d
   ELSE
   CALL POPREAL8(abs4)
   pd(i, j+2, k) = pd(i, j+2, k) + abs4d
   pd(i, j+1, k) = pd(i, j+1, k) - abs4d
   END IF
   END DO
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   x3d = dp1d
   ELSE
   x3d = -dp1d
   END IF
   temp19 = omega*(p(i, 2, k)+two*p(i, 1, k)+p(i, 0, k)) + &
   &         oneminomega*(abs3+abs9) + plim
   tempd16 = x3d/temp19
   tempd17 = -((p(i, 2, k)-two*p(i, 1, k)+p(i, 0, k))*tempd16/&
   &         temp19)
   tempd18 = omega*tempd17
   pd(i, 2, k) = pd(i, 2, k) + tempd18 + tempd16
   pd(i, 1, k) = pd(i, 1, k) + two*tempd18 - two*tempd16
   pd(i, 0, k) = pd(i, 0, k) + tempd18 + tempd16
   abs3d = oneminomega*tempd17
   abs9d = oneminomega*tempd17
   plimd = plimd + tempd17
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   CALL POPREAL8(abs9)
   pd(i, 1, k) = pd(i, 1, k) + abs9d
   pd(i, 0, k) = pd(i, 0, k) - abs9d
   ELSE
   CALL POPREAL8(abs9)
   pd(i, 0, k) = pd(i, 0, k) + abs9d
   pd(i, 1, k) = pd(i, 1, k) - abs9d
   END IF
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   CALL POPREAL8(abs3)
   pd(i, 1, k) = pd(i, 1, k) + abs3d
   pd(i, 2, k) = pd(i, 2, k) - abs3d
   ELSE
   CALL POPREAL8(abs3)
   pd(i, 2, k) = pd(i, 2, k) + abs3d
   pd(i, 1, k) = pd(i, 1, k) - abs3d
   END IF
   END DO
   END DO
   DO k=kl,2,-1
   DO j=jl,2,-1
   dp1d = 0.0_8
   DO i=il,1,-1
   dp2d = dp1d
   fsd = fwd(i+1, j, k, irhoe) - fwd(i, j, k, irhoe)
   wavg = half*(w(i+1, j, k, ivz)+w(i, j, k, ivz))
   vavg = half*(w(i+1, j, k, ivy)+w(i, j, k, ivy))
   uavg = half*(w(i+1, j, k, ivx)+w(i, j, k, ivx))
   unavg = uavg*sx + vavg*sy + wavg*sz
   abv5 = sx*dru + sy*drv + sz*drw - unavg*dr
   ovaavg = one/aavg
   ova2avg = one/a2avg
   abv6 = abv3*abv4*ova2avg + abv2*abv5*ovaavg
   abv7 = abv2*abv4*ovaavg + abv3*abv5
   lam3d = dre*fsd
   dred = lam3*fsd
   havgd = abv6*fsd
   abv6d = havg*fsd
   unavgd = abv7*fsd
   abv7d = unavg*fsd
   fsd = fwd(i+1, j, k, imz) - fwd(i, j, k, imz)
   lam3d = lam3d + drw*fsd
   drwd = lam3*fsd
   wavgd = abv6*fsd
   abv6d = abv6d + wavg*fsd
   szd = abv7*fsd
   abv7d = abv7d + sz*fsd
   fsd = fwd(i+1, j, k, imy) - fwd(i, j, k, imy)
   lam3d = lam3d + drv*fsd
   drvd = lam3*fsd
   vavgd = abv6*fsd
   abv6d = abv6d + vavg*fsd
   syd = abv7*fsd
   abv7d = abv7d + sy*fsd
   fsd = fwd(i+1, j, k, imx) - fwd(i, j, k, imx)
   lam3d = lam3d + dru*fsd
   drud = lam3*fsd
   uavgd = abv6*fsd
   abv6d = abv6d + uavg*fsd
   sxd = abv7*fsd
   abv7d = abv7d + sx*fsd
   fsd = fwd(i+1, j, k, irho) - fwd(i, j, k, irho)
   abv6d = abv6d + fsd
   abv2d = ovaavg*abv5*abv6d + ovaavg*abv4*abv7d
   abv4d = ova2avg*abv3*abv6d + ovaavg*abv2*abv7d
   ovaavgd = abv2*abv5*abv6d + abv2*abv4*abv7d
   abv3d = ova2avg*abv4*abv6d + abv5*abv7d
   lam3d = lam3d + dr*fsd - abv3d
   abv5d = ovaavg*abv2*abv6d + abv3*abv7d
   ova2avgd = abv3*abv4*abv6d
   sxd = sxd + dru*abv5d
   syd = syd + drv*abv5d
   szd = szd + drw*abv5d
   unavgd = unavgd - dr*abv5d
   gammaavg = half*(gamma(i+1, j, k)+gamma(i, j, k))
   gm1 = gammaavg - one
   gm53 = gammaavg - five*third
   alphaavg = half*(uavg**2+vavg**2+wavg**2)
   CALL POPREAL8(abv4)
   tempd15 = gm1*abv4d
   drd = alphaavg*tempd15 - unavg*abv5d + lam3*fsd
   drud = drud + sx*abv5d - uavg*tempd15
   drvd = drvd + sy*abv5d - vavg*tempd15
   drwd = drwd + sz*abv5d - wavg*tempd15
   alphaavgd = dr*tempd15
   uavgd = uavgd - dru*tempd15
   vavgd = vavgd - drv*tempd15
   dred = dred + tempd15
   wavgd = wavgd - drw*tempd15
   drkd = -(gm53*abv4d)
   CALL POPREAL8(abv3)
   abv1d = abv3d
   CALL POPREAL8(abv2)
   lam1d = half*abv1d + half*abv2d
   lam2d = half*abv1d - half*abv2d
   CALL POPREAL8(lam3)
   CALL POPREAL8(lam2)
   CALL POPREAL8(lam1)
   aread = lam2*lam2d + lam1*lam1d + lam3*lam3d
   lam3d = area*lam3d
   lam2d = area*lam2d
   lam1d = area*lam1d
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   rradd = epsshear*lam3d
   lam3d = 0.0_8
   ELSE
   rradd = 0.0_8
   END IF
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   rradd = rradd + epsacoustic*lam2d
   lam2d = 0.0_8
   END IF
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   rradd = rradd + epsacoustic*lam1d
   lam1d = 0.0_8
   END IF
   lam3d = lam3d + rradd
   aavgd = rradd
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   CALL POPREAL8(lam3)
   unavgd = unavgd + lam3d
   sfaced = sfaced - lam3d
   ELSE
   CALL POPREAL8(lam3)
   sfaced = sfaced + lam3d
   unavgd = unavgd - lam3d
   END IF
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   unavgd = unavgd + lam2d
   sfaced = sfaced - lam2d
   aavgd = aavgd - lam2d
   ELSE
   sfaced = sfaced + lam2d
   unavgd = unavgd - lam2d
   aavgd = aavgd + lam2d
   END IF
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   unavgd = unavgd + lam1d
   sfaced = sfaced - lam1d
   aavgd = aavgd + lam1d
   ELSE
   sfaced = sfaced + lam1d
   unavgd = unavgd - lam1d
   aavgd = aavgd - lam1d
   END IF
   tmp = one/max1
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   tmpd = 0.0_8
   ELSE
   tmpd = sfacei(i, j, k)*sfaced
   sfaced = 0.0_8
   END IF
   alphaavgd = alphaavgd + havgd
   tempd14 = half*alphaavgd
   ovgm1 = one/gm1
   aavgd = aavgd - one*ovaavgd/aavg**2
   IF (a2avg .EQ. 0.0_8) THEN
   a2avgd = ovgm1*havgd - one*ova2avgd/a2avg**2
   ELSE
   a2avgd = aavgd/(2.0*SQRT(a2avg)) + ovgm1*havgd - one*&
   &             ova2avgd/a2avg**2
   END IF
   uavgd = uavgd + 2*uavg*tempd14 + sx*unavgd
   sxd = sxd + uavg*unavgd
   vavgd = vavgd + 2*vavg*tempd14 + sy*unavgd
   syd = syd + vavg*unavgd
   wavgd = wavgd + 2*wavg*tempd14 + sz*unavgd
   szd = szd + wavg*unavgd
   CALL POPREAL8(aavg)
   CALL POPREAL8(havg)
   kavgd = -(ovgm1*gm53*havgd)
   CALL POPREAL8(sz)
   CALL POPREAL8(sy)
   CALL POPREAL8(sx)
   tmpd = tmpd + sy*syd + sx*sxd + sz*szd
   szd = tmp*szd
   syd = tmp*syd
   sxd = tmp*sxd
   max1d = -(one*tmpd/max1**2)
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   CALL POPREAL8(max1)
   aread = aread + max1d
   ELSE
   CALL POPREAL8(max1)
   END IF
   CALL POPREAL8(area)
   IF (sx**2 + sy**2 + sz**2 .EQ. 0.0_8) THEN
   tempd11 = 0.0
   ELSE
   tempd11 = aread/(2.0*SQRT(sx**2+sy**2+sz**2))
   END IF
   sxd = sxd + 2*sx*tempd11
   syd = syd + 2*sy*tempd11
   szd = szd + 2*sz*tempd11
   CALL POPREAL8(sz)
   sid(i, j, k, 3) = sid(i, j, k, 3) + szd
   CALL POPREAL8(sy)
   sid(i, j, k, 2) = sid(i, j, k, 2) + syd
   CALL POPREAL8(sx)
   sid(i, j, k, 1) = sid(i, j, k, 1) + sxd
   CALL POPREAL8(a2avg)
   temp18 = w(i, j, k, irho)
   temp17 = w(i+1, j, k, irho)
   tempd12 = gamma(i+1, j, k)*half*a2avgd/temp17
   tempd13 = gamma(i, j, k)*half*a2avgd/temp18
   pd(i+1, j, k) = pd(i+1, j, k) + tempd12
   wd(i+1, j, k, irho) = wd(i+1, j, k, irho) - p(i+1, j, k)*&
   &           tempd12/temp17
   pd(i, j, k) = pd(i, j, k) + tempd13
   wd(i, j, k, irho) = wd(i, j, k, irho) - p(i, j, k)*tempd13/&
   &           temp18
   wd(i+1, j, k, ivz) = wd(i+1, j, k, ivz) + half*wavgd
   wd(i, j, k, ivz) = wd(i, j, k, ivz) + half*wavgd
   wd(i+1, j, k, ivy) = wd(i+1, j, k, ivy) + half*vavgd
   wd(i, j, k, ivy) = wd(i, j, k, ivy) + half*vavgd
   wd(i+1, j, k, ivx) = wd(i+1, j, k, ivx) + half*uavgd
   wd(i, j, k, ivx) = wd(i, j, k, ivx) + half*uavgd
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   dis2d = 0.0_8
   dis4d = 0.0_8
   ELSE
   wd(i, j, k, itu1) = wd(i, j, k, itu1) + half*kavgd
   wd(i+1, j, k, itu1) = wd(i+1, j, k, itu1) + half*kavgd
   temp16 = w(i-1, j, k, itu1)
   temp15 = w(i-1, j, k, irho)
   temp14 = w(i+2, j, k, itu1)
   temp13 = w(i+2, j, k, irho)
   tempd10 = -(dis4*drkd)
   dis2d = ddw*drkd
   ddwd = dis2*drkd - three*tempd10
   dis4d = -((temp13*temp14-temp15*temp16-three*ddw)*drkd)
   wd(i+2, j, k, irho) = wd(i+2, j, k, irho) + temp14*tempd10
   wd(i+2, j, k, itu1) = wd(i+2, j, k, itu1) + temp13*tempd10
   wd(i-1, j, k, irho) = wd(i-1, j, k, irho) - temp16*tempd10
   wd(i-1, j, k, itu1) = wd(i-1, j, k, itu1) - temp15*tempd10
   wd(i+1, j, k, irho) = wd(i+1, j, k, irho) + w(i+1, j, k, &
   &             itu1)*ddwd
   wd(i+1, j, k, itu1) = wd(i+1, j, k, itu1) + w(i+1, j, k, &
   &             irho)*ddwd
   wd(i, j, k, irho) = wd(i, j, k, irho) - w(i, j, k, itu1)*&
   &             ddwd
   wd(i, j, k, itu1) = wd(i, j, k, itu1) - w(i, j, k, irho)*&
   &             ddwd
   END IF
   ddw = w(i+1, j, k, irhoe) - w(i, j, k, irhoe)
   CALL POPREAL8(dre)
   tempd5 = -(dis4*dred)
   dis2d = dis2d + ddw*dred
   ddwd = dis2*dred - three*tempd5
   dis4d = dis4d - (w(i+2, j, k, irhoe)-w(i-1, j, k, irhoe)-three&
   &           *ddw)*dred
   wd(i+2, j, k, irhoe) = wd(i+2, j, k, irhoe) + tempd5
   wd(i-1, j, k, irhoe) = wd(i-1, j, k, irhoe) - tempd5
   CALL POPREAL8(ddw)
   wd(i+1, j, k, irhoe) = wd(i+1, j, k, irhoe) + ddwd
   wd(i, j, k, irhoe) = wd(i, j, k, irhoe) - ddwd
   CALL POPREAL8(drw)
   temp12 = w(i-1, j, k, ivz)
   temp11 = w(i-1, j, k, irho)
   temp10 = w(i+2, j, k, ivz)
   temp9 = w(i+2, j, k, irho)
   tempd6 = -(dis4*drwd)
   dis2d = dis2d + ddw*drwd
   ddwd = dis2*drwd - three*tempd6
   dis4d = dis4d - (temp9*temp10-temp11*temp12-three*ddw)*drwd
   wd(i+2, j, k, irho) = wd(i+2, j, k, irho) + temp10*tempd6
   wd(i+2, j, k, ivz) = wd(i+2, j, k, ivz) + temp9*tempd6
   wd(i-1, j, k, irho) = wd(i-1, j, k, irho) - temp12*tempd6
   wd(i-1, j, k, ivz) = wd(i-1, j, k, ivz) - temp11*tempd6
   CALL POPREAL8(ddw)
   wd(i+1, j, k, irho) = wd(i+1, j, k, irho) + w(i+1, j, k, ivz)*&
   &           ddwd
   wd(i+1, j, k, ivz) = wd(i+1, j, k, ivz) + w(i+1, j, k, irho)*&
   &           ddwd
   wd(i, j, k, irho) = wd(i, j, k, irho) - w(i, j, k, ivz)*ddwd
   wd(i, j, k, ivz) = wd(i, j, k, ivz) - w(i, j, k, irho)*ddwd
   CALL POPREAL8(drv)
   temp8 = w(i-1, j, k, ivy)
   temp7 = w(i-1, j, k, irho)
   temp6 = w(i+2, j, k, ivy)
   temp5 = w(i+2, j, k, irho)
   tempd7 = -(dis4*drvd)
   dis2d = dis2d + ddw*drvd
   ddwd = dis2*drvd - three*tempd7
   dis4d = dis4d - (temp5*temp6-temp7*temp8-three*ddw)*drvd
   wd(i+2, j, k, irho) = wd(i+2, j, k, irho) + temp6*tempd7
   wd(i+2, j, k, ivy) = wd(i+2, j, k, ivy) + temp5*tempd7
   wd(i-1, j, k, irho) = wd(i-1, j, k, irho) - temp8*tempd7
   wd(i-1, j, k, ivy) = wd(i-1, j, k, ivy) - temp7*tempd7
   CALL POPREAL8(ddw)
   wd(i+1, j, k, irho) = wd(i+1, j, k, irho) + w(i+1, j, k, ivy)*&
   &           ddwd
   wd(i+1, j, k, ivy) = wd(i+1, j, k, ivy) + w(i+1, j, k, irho)*&
   &           ddwd
   wd(i, j, k, irho) = wd(i, j, k, irho) - w(i, j, k, ivy)*ddwd
   wd(i, j, k, ivy) = wd(i, j, k, ivy) - w(i, j, k, irho)*ddwd
   CALL POPREAL8(dru)
   temp4 = w(i-1, j, k, ivx)
   temp3 = w(i-1, j, k, irho)
   temp2 = w(i+2, j, k, ivx)
   temp1 = w(i+2, j, k, irho)
   tempd8 = -(dis4*drud)
   dis2d = dis2d + ddw*drud
   ddwd = dis2*drud - three*tempd8
   dis4d = dis4d - (temp1*temp2-temp3*temp4-three*ddw)*drud
   wd(i+2, j, k, irho) = wd(i+2, j, k, irho) + temp2*tempd8
   wd(i+2, j, k, ivx) = wd(i+2, j, k, ivx) + temp1*tempd8
   wd(i-1, j, k, irho) = wd(i-1, j, k, irho) - temp4*tempd8
   wd(i-1, j, k, ivx) = wd(i-1, j, k, ivx) - temp3*tempd8
   wd(i+1, j, k, irho) = wd(i+1, j, k, irho) + w(i+1, j, k, ivx)*&
   &           ddwd
   wd(i+1, j, k, ivx) = wd(i+1, j, k, ivx) + w(i+1, j, k, irho)*&
   &           ddwd
   wd(i, j, k, irho) = wd(i, j, k, irho) - w(i, j, k, ivx)*ddwd
   wd(i, j, k, ivx) = wd(i, j, k, ivx) - w(i, j, k, irho)*ddwd
   ddw = w(i+1, j, k, irho) - w(i, j, k, irho)
   CALL POPREAL8(dr)
   tempd9 = -(dis4*drd)
   dis2d = dis2d + ddw*drd
   ddwd = dis2*drd - three*tempd9
   dis4d = dis4d - (w(i+2, j, k, irho)-w(i-1, j, k, irho)-three*&
   &           ddw)*drd
   wd(i+2, j, k, irho) = wd(i+2, j, k, irho) + tempd9
   wd(i-1, j, k, irho) = wd(i-1, j, k, irho) - tempd9
   CALL POPREAL8(ddw)
   wd(i+1, j, k, irho) = wd(i+1, j, k, irho) + ddwd
   wd(i, j, k, irho) = wd(i, j, k, irho) - ddwd
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   CALL POPREAL8(dis4)
   CALL POPREAL8(dis2)
   min1d = fis2*ppor*dis2d
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   y1d = min1d
   ELSE
   y1d = 0.0_8
   END IF
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   dp2d = dp2d + y1d
   dp1d = 0.0_8
   ELSE
   dp1d = y1d
   END IF
   ELSE
   arg1 = ppor*fis4
   CALL POPREAL8(dis4)
   arg1d = 0.0_8
   CALL DIM_B(arg1, arg1d, dis2, dis2d, dis4d)
   CALL POPREAL8(dis2)
   min2d = ppor*fis2*dis2d
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   y2d = min2d
   ELSE
   y2d = 0.0_8
   END IF
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   dp2d = dp2d + y2d
   dp1d = 0.0_8
   ELSE
   dp1d = y2d
   END IF
   END IF
   CALL POPREAL8(ppor)
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   x2d = dp2d
   ELSE
   x2d = -dp2d
   END IF
   temp0 = omega*(p(i+2, j, k)+two*p(i+1, j, k)+p(i, j, k)) + &
   &           oneminomega*(abs2+abs8) + plim
   tempd2 = x2d/temp0
   tempd3 = -((p(i+2, j, k)-two*p(i+1, j, k)+p(i, j, k))*tempd2/&
   &           temp0)
   tempd4 = omega*tempd3
   pd(i+2, j, k) = pd(i+2, j, k) + tempd4 + tempd2
   pd(i+1, j, k) = pd(i+1, j, k) + two*tempd4 - two*tempd2
   pd(i, j, k) = pd(i, j, k) + tempd4 + tempd2
   abs2d = oneminomega*tempd3
   abs8d = oneminomega*tempd3
   plimd = plimd + tempd3
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   CALL POPREAL8(abs8)
   pd(i+1, j, k) = pd(i+1, j, k) + abs8d
   pd(i, j, k) = pd(i, j, k) - abs8d
   ELSE
   CALL POPREAL8(abs8)
   pd(i, j, k) = pd(i, j, k) + abs8d
   pd(i+1, j, k) = pd(i+1, j, k) - abs8d
   END IF
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   CALL POPREAL8(abs2)
   pd(i+1, j, k) = pd(i+1, j, k) + abs2d
   pd(i+2, j, k) = pd(i+2, j, k) - abs2d
   ELSE
   CALL POPREAL8(abs2)
   pd(i+2, j, k) = pd(i+2, j, k) + abs2d
   pd(i+1, j, k) = pd(i+1, j, k) - abs2d
   END IF
   END DO
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   x1d = dp1d
   ELSE
   x1d = -dp1d
   END IF
   temp = omega*(p(2, j, k)+two*p(1, j, k)+p(0, j, k)) + &
   &         oneminomega*(abs1+abs7) + plim
   tempd = x1d/temp
   tempd0 = -((p(2, j, k)-two*p(1, j, k)+p(0, j, k))*tempd/temp)
   tempd1 = omega*tempd0
   pd(2, j, k) = pd(2, j, k) + tempd1 + tempd
   pd(1, j, k) = pd(1, j, k) + two*tempd1 - two*tempd
   pd(0, j, k) = pd(0, j, k) + tempd1 + tempd
   abs1d = oneminomega*tempd0
   abs7d = oneminomega*tempd0
   plimd = plimd + tempd0
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   CALL POPREAL8(abs7)
   pd(1, j, k) = pd(1, j, k) + abs7d
   pd(0, j, k) = pd(0, j, k) - abs7d
   ELSE
   CALL POPREAL8(abs7)
   pd(0, j, k) = pd(0, j, k) + abs7d
   pd(1, j, k) = pd(1, j, k) - abs7d
   END IF
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   CALL POPREAL8(abs1)
   pd(1, j, k) = pd(1, j, k) + abs1d
   pd(2, j, k) = pd(2, j, k) - abs1d
   ELSE
   CALL POPREAL8(abs1)
   pd(2, j, k) = pd(2, j, k) + abs1d
   pd(1, j, k) = pd(1, j, k) - abs1d
   END IF
   END DO
   END DO
   pinfcorrd = 0.001_realType*plimd
   END IF
   END SUBROUTINE INVISCIDDISSFLUXMATRIX_B
