   !        Generated by TAPENADE     (INRIA, Tropics team)
   !  Tapenade 3.10 (r5363) -  9 Sep 2014 09:53
   !
   !  Differentiation of setflowinfinitystate in reverse (adjoint) mode (with options i4 dr8 r8 noISIZE):
   !   gradient     of useful results: veldirfreestream machcoef gammainf
   !                pinf rhoinf tref winf pinfcorr rgas
   !   with respect to varying inputs: veldirfreestream machcoef gammainf
   !                pinf rhoinf tref muinf uinf rgas
   !
   !      ******************************************************************
   !      *                                                                *
   !      * File:          setFlowInfinityState.f90                        *
   !      * Author:        Edwin van der Weide, Georgi Kalitzin            *
   !      * Starting date: 02-21-2003                                      *
   !      * Last modified: 06-12-2005                                      *
   !      *                                                                *
   !      ******************************************************************
   !
   SUBROUTINE SETFLOWINFINITYSTATE_B()
   !
   !      ******************************************************************
   !      *                                                                *
   !      * setFlowInfinityState sets the free stream state vector of      *
   !      * the flow variables. If nothing is specified for each of the    *
   !      * farfield boundaries, these values will be taken to define the  *
   !      * free stream.                                                   *
   !      *                                                                *
   !      ******************************************************************
   !
   USE CONSTANTS
   USE FLOWVARREFSTATE
   USE INPUTPHYSICS
   USE PARAMTURB
   IMPLICIT NONE
   !
   !      Local variables
   !
   INTEGER(kind=inttype) :: ierr
   REAL(kind=realtype) :: nuinf, ktmp, uinf2
   REAL(kind=realtype) :: nuinfb, ktmpb, uinf2b
   !
   !      Function definition
   !
   REAL(kind=realtype) :: SANUKNOWNEDDYRATIO
   ! Dummy parameters
   REAL(kind=realtype) :: vinf, zinf
   REAL(kind=realtype) :: vinfb, zinfb
   REAL(kind=realtype) :: tmp
   REAL(kind=realtype) :: tmp0
   REAL(kind=realtype) :: tmp1
   REAL(kind=realtype) :: tmp2
   INTEGER :: branch
   REAL(kind=realtype) :: tempb3
   REAL(kind=realtype) :: tempb2
   REAL(kind=realtype) :: tempb1
   REAL(kind=realtype) :: tempb0
   REAL(kind=realtype) :: tmpb
   REAL(kind=realtype) :: tmpb2
   REAL(kind=realtype) :: tmpb1
   REAL(kind=realtype) :: tmpb0
   REAL(kind=realtype) :: tempb
   REAL(kind=realtype) :: temp
   !
   !      ******************************************************************
   !      *                                                                *
   !      * Begin execution                                                *
   !      *                                                                *
   !      ******************************************************************
   !
   ! Compute the velocity squared based on MachCoef;
   ! needed for the initialization of the turbulent energy,
   ! especially for moving geometries.
   uinf2 = machcoef*machcoef*gammainf*pinf/rhoinf
   ! Allocate the memory for wInf.
   ! zero out the winf first
   winf(:) = zero
   ! Set the reference value of the flow variables, except the total
   ! energy. This will be computed at the end of this routine.
   winf(irho) = rhoinf
   winf(ivx) = uinf*veldirfreestream(1)
   winf(ivy) = uinf*veldirfreestream(2)
   winf(ivz) = uinf*veldirfreestream(3)
   ! Set the turbulent variables if transport variables are
   ! to be solved.
   IF (equations .EQ. ransequations) THEN
   nuinf = muinf/rhoinf
   SELECT CASE  (turbmodel) 
   CASE (spalartallmaras, spalartallmarasedwards) 
   winf(itu1) = SANUKNOWNEDDYRATIO(eddyvisinfratio, nuinf)
   CALL PUSHCONTROL3B(1)
   CASE (komegawilcox, komegamodified, mentersst) 
   !   wInf(itu1) = 1.341946*nuInf   ! eddyVis = 0.009*lamVis
   !=============================================================
   winf(itu1) = 1.5_realType*uinf2*turbintensityinf**2
   tmp = winf(itu1)/(eddyvisinfratio*nuinf)
   CALL PUSHREAL8(winf(itu2))
   winf(itu2) = tmp
   CALL PUSHCONTROL3B(2)
   CASE (ktau) 
   !=============================================================
   winf(itu1) = 1.5_realType*uinf2*turbintensityinf**2
   tmp0 = eddyvisinfratio*nuinf/winf(itu1)
   CALL PUSHREAL8(winf(itu2))
   winf(itu2) = tmp0
   CALL PUSHCONTROL3B(3)
   CASE (v2f) 
   !=============================================================
   winf(itu1) = 1.5_realType*uinf2*turbintensityinf**2
   tmp1 = 0.09_realType*winf(itu1)**2/(eddyvisinfratio*nuinf)
   CALL PUSHREAL8(winf(itu2))
   winf(itu2) = tmp1
   tmp2 = 0.666666_realType*winf(itu1)
   CALL PUSHREAL8(winf(itu3))
   winf(itu3) = tmp2
   CALL PUSHREAL8(winf(itu4))
   winf(itu4) = 0.0_realType
   CALL PUSHCONTROL3B(4)
   CASE DEFAULT
   CALL PUSHCONTROL3B(0)
   END SELECT
   ELSE
   CALL PUSHCONTROL3B(5)
   END IF
   ! Set the value of pInfCorr. In case a k-equation is present
   ! add 2/3 times rho*k.
   pinfcorr = pinf
   IF (kpresent) THEN
   pinfcorr = pinf + two*third*rhoinf*winf(itu1)
   CALL PUSHCONTROL1B(0)
   ELSE
   CALL PUSHCONTROL1B(1)
   END IF
   ! Compute the free stream total energy.
   ktmp = zero
   IF (kpresent) THEN
   ktmp = winf(itu1)
   CALL PUSHCONTROL1B(0)
   ELSE
   CALL PUSHCONTROL1B(1)
   END IF
   vinf = zero
   zinf = zero
   CALL ETOTARRAY_B(rhoinf, rhoinfb, uinf, uinfb, vinf, vinfb, zinf, &
   &            zinfb, pinfcorr, pinfcorrb, ktmp, ktmpb, winf(irhoe), winfb&
   &            (irhoe), kpresent, 1)
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) winfb(itu1) = winfb(itu1) + ktmpb
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   tempb3 = two*third*pinfcorrb
   pinfb = pinfb + pinfcorrb
   rhoinfb = rhoinfb + winf(itu1)*tempb3
   winfb(itu1) = winfb(itu1) + rhoinf*tempb3
   pinfcorrb = 0.0_8
   END IF
   pinfb = pinfb + pinfcorrb
   CALL POPCONTROL3B(branch)
   IF (branch .LT. 3) THEN
   IF (branch .EQ. 0) THEN
   uinf2b = 0.0_8
   nuinfb = 0.0_8
   ELSE IF (branch .EQ. 1) THEN
   CALL SANUKNOWNEDDYRATIO_B(eddyvisinfratio, nuinf, nuinfb, winfb(&
   &                         itu1))
   winfb(itu1) = 0.0_8
   uinf2b = 0.0_8
   ELSE
   CALL POPREAL8(winf(itu2))
   tmpb = winfb(itu2)
   winfb(itu2) = 0.0_8
   tempb0 = tmpb/(eddyvisinfratio*nuinf)
   winfb(itu1) = winfb(itu1) + tempb0
   nuinfb = -(winf(itu1)*tempb0/nuinf)
   uinf2b = turbintensityinf**2*1.5_realType*winfb(itu1)
   winfb(itu1) = 0.0_8
   END IF
   ELSE IF (branch .EQ. 3) THEN
   CALL POPREAL8(winf(itu2))
   tmpb0 = winfb(itu2)
   winfb(itu2) = 0.0_8
   tempb1 = eddyvisinfratio*tmpb0/winf(itu1)
   nuinfb = tempb1
   winfb(itu1) = winfb(itu1) - nuinf*tempb1/winf(itu1)
   uinf2b = turbintensityinf**2*1.5_realType*winfb(itu1)
   winfb(itu1) = 0.0_8
   ELSE IF (branch .EQ. 4) THEN
   CALL POPREAL8(winf(itu4))
   winfb(itu4) = 0.0_8
   CALL POPREAL8(winf(itu3))
   tmpb1 = winfb(itu3)
   winfb(itu3) = 0.0_8
   winfb(itu1) = winfb(itu1) + 0.666666_realType*tmpb1
   CALL POPREAL8(winf(itu2))
   tmpb2 = winfb(itu2)
   winfb(itu2) = 0.0_8
   tempb2 = 0.09_realType*tmpb2/(eddyvisinfratio*nuinf)
   winfb(itu1) = winfb(itu1) + 2*winf(itu1)*tempb2
   nuinfb = -(winf(itu1)**2*tempb2/nuinf)
   uinf2b = turbintensityinf**2*1.5_realType*winfb(itu1)
   winfb(itu1) = 0.0_8
   ELSE
   muinfb = 0.0_8
   uinf2b = 0.0_8
   GOTO 100
   END IF
   muinfb = nuinfb/rhoinf
   rhoinfb = rhoinfb - muinf*nuinfb/rhoinf**2
   100 temp = machcoef**2/rhoinf
   tempb = gammainf*pinf*uinf2b/rhoinf
   uinfb = uinfb + veldirfreestream(3)*winfb(ivz)
   veldirfreestreamb(3) = veldirfreestreamb(3) + uinf*winfb(ivz)
   winfb(ivz) = 0.0_8
   uinfb = uinfb + veldirfreestream(2)*winfb(ivy)
   veldirfreestreamb(2) = veldirfreestreamb(2) + uinf*winfb(ivy)
   winfb(ivy) = 0.0_8
   uinfb = uinfb + veldirfreestream(1)*winfb(ivx)
   veldirfreestreamb(1) = veldirfreestreamb(1) + uinf*winfb(ivx)
   winfb(ivx) = 0.0_8
   rhoinfb = rhoinfb + winfb(irho) - temp*tempb
   machcoefb = machcoefb + 2*machcoef*tempb
   gammainfb = gammainfb + temp*pinf*uinf2b
   pinfb = pinfb + temp*gammainf*uinf2b
   END SUBROUTINE SETFLOWINFINITYSTATE_B
