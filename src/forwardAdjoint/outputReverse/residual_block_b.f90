   !        Generated by TAPENADE     (INRIA, Tropics team)
   !  Tapenade 3.10 (r5363) -  9 Sep 2014 09:53
   !
   !  Differentiation of residual_block in reverse (adjoint) mode (with options i4 dr8 r8 noISIZE):
   !   gradient     of useful results: *p *dw *w *x *vol *si *sj *sk
   !                *(*viscsubface.tau) gammainf
   !   with respect to varying inputs: *rev *p *gamma *dw *w *rlv
   !                *x *vol *si *sj *sk *radi *radj *radk gammainf
   !                timeref rhoinf winf pinfcorr
   !   Plus diff mem management of: rev:in p:in gamma:in dw:in w:in
   !                rlv:in x:in vol:in si:in sj:in sk:in fw:in viscsubface:in
   !                *viscsubface.tau:in radi:in radj:in radk:in
   !
   !      ******************************************************************
   !      *                                                                *
   !      * File:          residual.f90                                    *
   !      * Author:        Edwin van der Weide, Steve Repsher (blanking)   *
   !      * Starting date: 03-15-2003                                      *
   !      * Last modified: 10-29-2007                                      *
   !      *                                                                *
   !      ******************************************************************
   !
   SUBROUTINE RESIDUAL_BLOCK_B()
   !
   !      ******************************************************************
   !      *                                                                *
   !      * residual computes the residual of the mean flow equations on   *
   !      * the current MG level.                                          *
   !      *                                                                *
   !      ******************************************************************
   !
   USE BLOCKPOINTERS_B
   USE CGNSGRID
   USE FLOWVARREFSTATE
   USE INPUTITERATION
   USE INPUTDISCRETIZATION
   USE INPUTTIMESPECTRAL
   USE ITERATION
   USE INPUTADJOINT
   IMPLICIT NONE
   !
   !      Local variables.
   !
   INTEGER(kind=inttype) :: discr
   INTEGER(kind=inttype) :: i, j, k, l
   REAL(kind=realtype), PARAMETER :: k1=1.05_realType
   ! Random given number
   REAL(kind=realtype), PARAMETER :: k2=0.6_realType
   ! Mach number preconditioner activation
   REAL(kind=realtype), PARAMETER :: m0=0.2_realType
   REAL(kind=realtype), PARAMETER :: alpha=0_realType
   REAL(kind=realtype), PARAMETER :: delta=0_realType
   !real(kind=realType), parameter :: hinf = 2_realType ! Test phase 
   ! Test phase
   REAL(kind=realtype), PARAMETER :: cpres=4.18_realType
   REAL(kind=realtype), PARAMETER :: temp=297.15_realType
   !
   !     Local variables
   !
   REAL(kind=realtype) :: k3, h, velxrho, velyrho, velzrho, sos, hinf, &
   & resm, a11, a12, a13, a14, a15, a21, a22, a23, a24, a25, a31, a32, a33&
   & , a34, a35
   REAL(kind=realtype) :: k3b, velxrhob, velyrhob, velzrhob, sosb, resmb&
   & , a11b, a15b, a21b, a22b, a25b, a31b, a33b, a35b
   REAL(kind=realtype) :: a41, a42, a43, a44, a45, a51, a52, a53, a54, &
   & a55, b11, b12, b13, b14, b15, b21, b22, b23, b24, b25, b31, b32, b33, &
   & b34, b35
   REAL(kind=realtype) :: a41b, a44b, a45b, a51b, a52b, a53b, a54b, a55b&
   & , b11b, b12b, b13b, b14b, b15b, b21b, b22b, b23b, b24b, b25b, b31b, &
   & b32b, b33b, b34b, b35b
   REAL(kind=realtype) :: b41, b42, b43, b44, b45, b51, b52, b53, b54, &
   & b55
   REAL(kind=realtype) :: b41b, b42b, b43b, b44b, b45b, b51b, b52b, b53b&
   & , b54b, b55b
   REAL(kind=realtype) :: rhohdash, betamr2
   REAL(kind=realtype) :: betamr2b
   REAL(kind=realtype) :: g, q
   REAL(kind=realtype) :: qb
   REAL(kind=realtype) :: b1, b2, b3, b4, b5
   REAL(kind=realtype) :: dwo(nwf)
   REAL(kind=realtype) :: dwob(nwf)
   LOGICAL :: finegrid
   INTRINSIC SQRT
   INTRINSIC MAX
   INTRINSIC MIN
   INTRINSIC REAL
   INTEGER :: branch
   REAL(kind=realtype) :: temp3
   REAL(kind=realtype) :: temp29
   REAL(kind=realtype) :: tempb52
   REAL(kind=realtype) :: temp2
   REAL(kind=realtype) :: temp28
   REAL(kind=realtype) :: tempb51
   REAL(kind=realtype) :: temp1
   REAL(kind=realtype) :: temp27
   REAL(kind=realtype) :: tempb50
   REAL(kind=realtype) :: temp0
   REAL(kind=realtype) :: temp26
   REAL(kind=realtype) :: temp25
   REAL(kind=realtype) :: temp24
   REAL(kind=realtype) :: temp23
   REAL(kind=realtype) :: temp22
   REAL(kind=realtype) :: temp21
   REAL(kind=realtype) :: temp20
   REAL(kind=realtype) :: tempb9
   REAL(kind=realtype) :: tempb8
   REAL(kind=realtype) :: tempb7
   REAL(kind=realtype) :: tempb6
   REAL(kind=realtype) :: tempb5
   REAL(kind=realtype) :: tempb4
   REAL(kind=realtype) :: tempb19
   REAL(kind=realtype) :: tempb3
   REAL(kind=realtype) :: tempb18
   REAL(kind=realtype) :: tempb2
   REAL(kind=realtype) :: tempb17
   REAL(kind=realtype) :: tempb1
   REAL(kind=realtype) :: tempb16
   REAL(kind=realtype) :: tempb0
   REAL(kind=realtype) :: tempb15
   REAL(kind=realtype) :: tempb14
   REAL(kind=realtype) :: tempb13
   REAL(kind=realtype) :: tempb12
   REAL(kind=realtype) :: tempb49
   REAL(kind=realtype) :: tempb11
   REAL(kind=realtype) :: tempb48
   REAL(kind=realtype) :: tempb10
   REAL(kind=realtype) :: tempb47
   REAL(kind=realtype) :: tempb46
   REAL(kind=realtype) :: tempb45
   REAL(kind=realtype) :: tempb44
   REAL(kind=realtype) :: x1
   REAL(kind=realtype) :: tempb43
   REAL(kind=realtype) :: temp19
   REAL(kind=realtype) :: tempb42
   REAL(kind=realtype) :: temp18
   REAL(kind=realtype) :: tempb41
   REAL(kind=realtype) :: temp17
   REAL(kind=realtype) :: tempb40
   REAL(kind=realtype) :: temp16
   REAL(kind=realtype) :: temp15
   REAL(kind=realtype) :: temp14
   REAL(kind=realtype) :: temp13
   REAL(kind=realtype) :: temp12
   REAL(kind=realtype) :: temp11
   REAL(kind=realtype) :: temp10
   REAL(kind=realtype) :: temp41
   REAL(kind=realtype) :: temp40
   REAL(kind=realtype) :: tempb
   REAL(kind=realtype) :: tempb39
   REAL(kind=realtype) :: tempb38
   REAL(kind=realtype) :: tempb37
   REAL(kind=realtype) :: tempb36
   REAL(kind=realtype) :: tempb35
   REAL(kind=realtype) :: tempb34
   REAL(kind=realtype) :: tempb33
   REAL(kind=realtype) :: x1b
   REAL(kind=realtype) :: tempb32
   REAL(kind=realtype) :: tempb31
   REAL(kind=realtype) :: tempb30
   REAL(kind=realtype) :: tempb65
   REAL(kind=realtype) :: tempb64
   REAL(kind=realtype) :: tempb63
   REAL(kind=realtype) :: temp39
   REAL(kind=realtype) :: tempb62
   REAL(kind=realtype) :: temp38
   REAL(kind=realtype) :: tempb61
   REAL(kind=realtype) :: temp37
   REAL(kind=realtype) :: tempb60
   REAL(kind=realtype) :: temp36
   REAL(kind=realtype) :: temp35
   REAL(kind=realtype) :: temp34
   REAL(kind=realtype) :: temp33
   REAL(kind=realtype) :: temp32
   REAL(kind=realtype) :: temp31
   REAL(kind=realtype) :: temp30
   REAL(kind=realtype) :: tempb29
   REAL(kind=realtype) :: tempb28
   REAL(kind=realtype) :: tempb27
   REAL(kind=realtype) :: tempb26
   REAL(kind=realtype) :: tempb25
   REAL(kind=realtype) :: tempb24
   REAL(kind=realtype) :: tempb23
   REAL(kind=realtype) :: tempb22
   REAL(kind=realtype) :: tempb59
   REAL(kind=realtype) :: temp9
   REAL(kind=realtype) :: tempb21
   REAL(kind=realtype) :: tempb58
   REAL(kind=realtype) :: temp8
   REAL(kind=realtype) :: tempb20
   REAL(kind=realtype) :: tempb57
   REAL(kind=realtype) :: temp7
   REAL(kind=realtype) :: tempb56
   REAL(kind=realtype) :: temp6
   REAL(kind=realtype) :: tempb55
   REAL(kind=realtype) :: temp5
   REAL(kind=realtype) :: tempb54
   REAL(kind=realtype) :: temp4
   REAL(kind=realtype) :: tempb53
   !
   !      ******************************************************************
   !      *                                                                *
   !      * Begin execution                                                *
   !      *                                                                *
   !      ******************************************************************
   !
   ! Add the source terms from the level 0 cooling model.
   ! Set the value of rFil, which controls the fraction of the old
   ! dissipation residual to be used. This is only for the runge-kutta
   ! schemes; for other smoothers rFil is simply set to 1.0.
   ! Note the index rkStage+1 for cdisRK. The reason is that the
   ! residual computation is performed before rkStage is incremented.
   IF (smoother .EQ. rungekutta) THEN
   rfil = cdisrk(rkstage+1)
   ELSE
   rfil = one
   END IF
   ! Initialize the local arrays to monitor the massflows to zero.
   ! Set the value of the discretization, depending on the grid level,
   ! and the logical fineGrid, which indicates whether or not this
   ! is the finest grid level of the current mg cycle.
   discr = spacediscrcoarse
   IF (currentlevel .EQ. 1) discr = spacediscr
   finegrid = .false.
   IF (currentlevel .EQ. groundlevel) finegrid = .true.
   CALL INVISCIDCENTRALFLUX()
   ! Reverse adjoint currently only work with invisciddissscalar
   ! Compute the artificial dissipation fluxes.
   ! This depends on the parameter discr.
   SELECT CASE  (discr) 
   CASE (dissscalar) 
   ! Standard scalar dissipation scheme.
   IF (finegrid) THEN
   CALL PUSHREAL8ARRAY(w, SIZE(w, 1)*SIZE(w, 2)*SIZE(w, 3)*SIZE(w, 4)&
   &                  )
   CALL INVISCIDDISSFLUXSCALAR()
   CALL PUSHCONTROL2B(1)
   ELSE
   CALL PUSHREAL8ARRAY(w, SIZE(w, 1)*SIZE(w, 2)*SIZE(w, 3)*SIZE(w, 4)&
   &                  )
   CALL INVISCIDDISSFLUXSCALARCOARSE()
   CALL PUSHCONTROL2B(2)
   END IF
   CASE DEFAULT
   CALL PUSHCONTROL2B(0)
   END SELECT
   ! Compute the viscous flux in case of a viscous computation.
   IF (viscous) THEN
   ! not lumpedDiss means it isn't the PC...call the vicousFlux
   IF (.NOT.lumpeddiss) THEN
   CALL PUSHREAL8ARRAY(p, SIZE(p, 1)*SIZE(p, 2)*SIZE(p, 3))
   CALL VISCOUSFLUX()
   CALL PUSHCONTROL2B(0)
   ELSE IF (viscpc) THEN
   ! This is a PC calc...only include viscous fluxes if viscPC
   ! is used
   CALL PUSHREAL8ARRAY(p, SIZE(p, 1)*SIZE(p, 2)*SIZE(p, 3))
   CALL VISCOUSFLUX()
   CALL PUSHCONTROL2B(1)
   ELSE
   CALL PUSHREAL8ARRAY(p, SIZE(p, 1)*SIZE(p, 2)*SIZE(p, 3))
   CALL VISCOUSFLUXAPPROX()
   CALL PUSHCONTROL2B(2)
   END IF
   ELSE
   CALL PUSHCONTROL2B(3)
   END IF
   ! Add the dissipative and possibly viscous fluxes to the
   ! Euler fluxes. Loop over the owned cells and add fw to dw.
   ! Also multiply by iblank so that no updates occur in holes
   ! or on the overset boundary.
   IF (lowspeedpreconditioner) THEN
   DO k=2,kl
   DO j=2,jl
   DO i=2,il
   !    Compute speed of sound
   CALL PUSHREAL8(sos)
   sos = SQRT(gamma(i, j, k)*p(i, j, k)/w(i, j, k, irho))
   ! Coompute velocities without rho from state vector
   velxrho = w(i, j, k, ivx)
   velyrho = w(i, j, k, ivy)
   velzrho = w(i, j, k, ivz)
   q = velxrho**2 + velyrho**2 + velzrho**2
   CALL PUSHREAL8(resm)
   resm = SQRT(q)/sos
   !
   !    Compute K3
   CALL PUSHREAL8(k3)
   k3 = k1*(1+(1-k1*m0**2)*resm**2/(k1*m0**4))
   IF (k3*(velxrho**2+velyrho**2+velzrho**2) .LT. k2*(winf(ivx)**&
   &             2+winf(ivy)**2+winf(ivz)**2)) THEN
   x1 = k2*(winf(ivx)**2+winf(ivy)**2+winf(ivz)**2)
   CALL PUSHCONTROL1B(0)
   ELSE
   x1 = k3*(velxrho**2+velyrho**2+velzrho**2)
   CALL PUSHCONTROL1B(1)
   END IF
   IF (x1 .GT. sos**2) THEN
   CALL PUSHREAL8(betamr2)
   betamr2 = sos**2
   CALL PUSHCONTROL1B(0)
   ELSE
   CALL PUSHREAL8(betamr2)
   betamr2 = x1
   CALL PUSHCONTROL1B(1)
   END IF
   a11 = betamr2*(1/sos**4)
   a12 = zero
   a13 = zero
   a14 = zero
   a15 = (-betamr2)/sos**4
   a21 = one*velxrho/sos**2
   a22 = one*w(i, j, k, irho)
   a23 = zero
   a24 = zero
   a25 = one*(-velxrho)/sos**2
   a31 = one*velyrho/sos**2
   a32 = zero
   a33 = one*w(i, j, k, irho)
   a34 = zero
   a35 = one*(-velyrho)/sos**2
   a41 = one*velzrho/sos**2
   a42 = zero
   a43 = zero
   a44 = one*w(i, j, k, irho)
   a45 = zero + one*(-velzrho)/sos**2
   a51 = one*(1/(gamma(i, j, k)-1)+resm**2/2)
   a52 = one*w(i, j, k, irho)*velxrho
   a53 = one*w(i, j, k, irho)*velyrho
   a54 = one*w(i, j, k, irho)*velzrho
   a55 = one*((-(resm**2))/2)
   CALL PUSHREAL8(b11)
   b11 = a11*(gamma(i, j, k)-1)*q/2 + a12*(-velxrho)/w(i, j, k, &
   &           irho) + a13*(-velyrho)/w(i, j, k, irho) + a14*(-velzrho)/w(i&
   &           , j, k, irho) + a15*((gamma(i, j, k)-1)*q/2-sos**2)
   CALL PUSHREAL8(b12)
   b12 = a11*(1-gamma(i, j, k))*velxrho + a12*1/w(i, j, k, irho) &
   &           + a15*(1-gamma(i, j, k))*velxrho
   CALL PUSHREAL8(b13)
   b13 = a11*(1-gamma(i, j, k))*velyrho + a13/w(i, j, k, irho) + &
   &           a15*(1-gamma(i, j, k))*velyrho
   CALL PUSHREAL8(b14)
   b14 = a11*(1-gamma(i, j, k))*velzrho + a14/w(i, j, k, irho) + &
   &           a15*(1-gamma(i, j, k))*velzrho
   b15 = a11*(gamma(i, j, k)-1) + a15*(gamma(i, j, k)-1)
   CALL PUSHREAL8(b21)
   b21 = a21*(gamma(i, j, k)-1)*q/2 + a22*(-velxrho)/w(i, j, k, &
   &           irho) + a23*(-velyrho)/w(i, j, k, irho) + a24*(-velzrho)/w(i&
   &           , j, k, irho) + a25*((gamma(i, j, k)-1)*q/2-sos**2)
   CALL PUSHREAL8(b22)
   b22 = a21*(1-gamma(i, j, k))*velxrho + a22/w(i, j, k, irho) + &
   &           a25*(1-gamma(i, j, k))*velxrho
   CALL PUSHREAL8(b23)
   b23 = a21*(1-gamma(i, j, k))*velyrho + a23*1/w(i, j, k, irho) &
   &           + a25*(1-gamma(i, j, k))*velyrho
   CALL PUSHREAL8(b24)
   b24 = a21*(1-gamma(i, j, k))*velzrho + a24*1/w(i, j, k, irho) &
   &           + a25*(1-gamma(i, j, k))*velzrho
   b25 = a21*(gamma(i, j, k)-1) + a25*(gamma(i, j, k)-1)
   CALL PUSHREAL8(b31)
   b31 = a31*(gamma(i, j, k)-1)*q/2 + a32*(-velxrho)/w(i, j, k, &
   &           irho) + a33*(-velyrho)/w(i, j, k, irho) + a34*(-velzrho)/w(i&
   &           , j, k, irho) + a35*((gamma(i, j, k)-1)*q/2-sos**2)
   CALL PUSHREAL8(b32)
   b32 = a31*(1-gamma(i, j, k))*velxrho + a32/w(i, j, k, irho) + &
   &           a35*(1-gamma(i, j, k))*velxrho
   CALL PUSHREAL8(b33)
   b33 = a31*(1-gamma(i, j, k))*velyrho + a33*1/w(i, j, k, irho) &
   &           + a35*(1-gamma(i, j, k))*velyrho
   CALL PUSHREAL8(b34)
   b34 = a31*(1-gamma(i, j, k))*velzrho + a34*1/w(i, j, k, irho) &
   &           + a35*(1-gamma(i, j, k))*velzrho
   b35 = a31*(gamma(i, j, k)-1) + a35*(gamma(i, j, k)-1)
   CALL PUSHREAL8(b41)
   b41 = a41*(gamma(i, j, k)-1)*q/2 + a42*(-velxrho)/w(i, j, k, &
   &           irho) + a43*(-velyrho)/w(i, j, k, irho) + a44*(-velzrho)/w(i&
   &           , j, k, irho) + a45*((gamma(i, j, k)-1)*q/2-sos**2)
   CALL PUSHREAL8(b42)
   b42 = a41*(1-gamma(i, j, k))*velxrho + a42/w(i, j, k, irho) + &
   &           a45*(1-gamma(i, j, k))*velxrho
   CALL PUSHREAL8(b43)
   b43 = a41*(1-gamma(i, j, k))*velyrho + a43*1/w(i, j, k, irho) &
   &           + a45*(1-gamma(i, j, k))*velyrho
   CALL PUSHREAL8(b44)
   b44 = a41*(1-gamma(i, j, k))*velzrho + a44*1/w(i, j, k, irho) &
   &           + a45*(1-gamma(i, j, k))*velzrho
   b45 = a41*(gamma(i, j, k)-1) + a45*(gamma(i, j, k)-1)
   CALL PUSHREAL8(b51)
   b51 = a51*(gamma(i, j, k)-1)*q/2 + a52*(-velxrho)/w(i, j, k, &
   &           irho) + a53*(-velyrho)/w(i, j, k, irho) + a54*(-velzrho)/w(i&
   &           , j, k, irho) + a55*((gamma(i, j, k)-1)*q/2-sos**2)
   CALL PUSHREAL8(b52)
   b52 = a51*(1-gamma(i, j, k))*velxrho + a52/w(i, j, k, irho) + &
   &           a55*(1-gamma(i, j, k))*velxrho
   CALL PUSHREAL8(b53)
   b53 = a51*(1-gamma(i, j, k))*velyrho + a53*1/w(i, j, k, irho) &
   &           + a55*(1-gamma(i, j, k))*velyrho
   CALL PUSHREAL8(b54)
   b54 = a51*(1-gamma(i, j, k))*velzrho + a54*1/w(i, j, k, irho) &
   &           + a55*(1-gamma(i, j, k))*velzrho
   b55 = a51*(gamma(i, j, k)-1) + a55*(gamma(i, j, k)-1)
   ! dwo is the orginal redisual
   DO l=1,nwf
   CALL PUSHREAL8(dwo(l))
   dwo(l) = (dw(i, j, k, l)+fw(i, j, k, l))*REAL(iblank(i, j, k&
   &             ), realtype)
   END DO
   dw(i, j, k, 1) = b11*dwo(1) + b12*dwo(2) + b13*dwo(3) + b14*&
   &           dwo(4) + b15*dwo(5)
   dw(i, j, k, 2) = b21*dwo(1) + b22*dwo(2) + b23*dwo(3) + b24*&
   &           dwo(4) + b25*dwo(5)
   dw(i, j, k, 3) = b31*dwo(1) + b32*dwo(2) + b33*dwo(3) + b34*&
   &           dwo(4) + b35*dwo(5)
   dw(i, j, k, 4) = b41*dwo(1) + b42*dwo(2) + b43*dwo(3) + b44*&
   &           dwo(4) + b45*dwo(5)
   dw(i, j, k, 5) = b51*dwo(1) + b52*dwo(2) + b53*dwo(3) + b54*&
   &           dwo(4) + b55*dwo(5)
   ! Regular copy (identity) for the turbulence variables
   DO l=nt1,nt2
   dw(i, j, k, l) = (dw(i, j, k, l)+fw(i, j, k, l))*REAL(iblank&
   &             (i, j, k), realtype)
   END DO
   END DO
   END DO
   END DO
   gammab = 0.0_8
   fwb = 0.0_8
   winfb = 0.0_8
   dwob = 0.0_8
   DO k=kl,2,-1
   DO j=jl,2,-1
   DO i=il,2,-1
   DO l=nt2,nt1,-1
   tempb64 = REAL(iblank(i, j, k), realtype)*dwb(i, j, k, l)
   fwb(i, j, k, l) = fwb(i, j, k, l) + tempb64
   dwb(i, j, k, l) = tempb64
   END DO
   a51 = one*(1/(gamma(i, j, k)-1)+resm**2/2)
   a55 = one*((-(resm**2))/2)
   b55 = a51*(gamma(i, j, k)-1) + a55*(gamma(i, j, k)-1)
   b51b = dwo(1)*dwb(i, j, k, 5)
   dwob(1) = dwob(1) + b51*dwb(i, j, k, 5)
   b52b = dwo(2)*dwb(i, j, k, 5)
   dwob(2) = dwob(2) + b52*dwb(i, j, k, 5)
   b53b = dwo(3)*dwb(i, j, k, 5)
   dwob(3) = dwob(3) + b53*dwb(i, j, k, 5)
   b54b = dwo(4)*dwb(i, j, k, 5)
   dwob(4) = dwob(4) + b54*dwb(i, j, k, 5)
   b55b = dwo(5)*dwb(i, j, k, 5)
   dwob(5) = dwob(5) + b55*dwb(i, j, k, 5)
   dwb(i, j, k, 5) = 0.0_8
   velzrho = w(i, j, k, ivz)
   a41 = one*velzrho/sos**2
   a45 = zero + one*(-velzrho)/sos**2
   b45 = a41*(gamma(i, j, k)-1) + a45*(gamma(i, j, k)-1)
   b41b = dwo(1)*dwb(i, j, k, 4)
   dwob(1) = dwob(1) + b41*dwb(i, j, k, 4)
   b42b = dwo(2)*dwb(i, j, k, 4)
   dwob(2) = dwob(2) + b42*dwb(i, j, k, 4)
   b43b = dwo(3)*dwb(i, j, k, 4)
   dwob(3) = dwob(3) + b43*dwb(i, j, k, 4)
   b44b = dwo(4)*dwb(i, j, k, 4)
   dwob(4) = dwob(4) + b44*dwb(i, j, k, 4)
   b45b = dwo(5)*dwb(i, j, k, 4)
   dwob(5) = dwob(5) + b45*dwb(i, j, k, 4)
   dwb(i, j, k, 4) = 0.0_8
   velyrho = w(i, j, k, ivy)
   a31 = one*velyrho/sos**2
   a35 = one*(-velyrho)/sos**2
   b35 = a31*(gamma(i, j, k)-1) + a35*(gamma(i, j, k)-1)
   b31b = dwo(1)*dwb(i, j, k, 3)
   dwob(1) = dwob(1) + b31*dwb(i, j, k, 3)
   b32b = dwo(2)*dwb(i, j, k, 3)
   dwob(2) = dwob(2) + b32*dwb(i, j, k, 3)
   b33b = dwo(3)*dwb(i, j, k, 3)
   dwob(3) = dwob(3) + b33*dwb(i, j, k, 3)
   b34b = dwo(4)*dwb(i, j, k, 3)
   dwob(4) = dwob(4) + b34*dwb(i, j, k, 3)
   b35b = dwo(5)*dwb(i, j, k, 3)
   dwob(5) = dwob(5) + b35*dwb(i, j, k, 3)
   dwb(i, j, k, 3) = 0.0_8
   velxrho = w(i, j, k, ivx)
   a21 = one*velxrho/sos**2
   a25 = one*(-velxrho)/sos**2
   b25 = a21*(gamma(i, j, k)-1) + a25*(gamma(i, j, k)-1)
   b21b = dwo(1)*dwb(i, j, k, 2)
   dwob(1) = dwob(1) + b21*dwb(i, j, k, 2)
   b22b = dwo(2)*dwb(i, j, k, 2)
   dwob(2) = dwob(2) + b22*dwb(i, j, k, 2)
   b23b = dwo(3)*dwb(i, j, k, 2)
   dwob(3) = dwob(3) + b23*dwb(i, j, k, 2)
   b24b = dwo(4)*dwb(i, j, k, 2)
   dwob(4) = dwob(4) + b24*dwb(i, j, k, 2)
   b25b = dwo(5)*dwb(i, j, k, 2)
   dwob(5) = dwob(5) + b25*dwb(i, j, k, 2)
   dwb(i, j, k, 2) = 0.0_8
   a11 = betamr2*(1/sos**4)
   a15 = (-betamr2)/sos**4
   b15 = a11*(gamma(i, j, k)-1) + a15*(gamma(i, j, k)-1)
   b11b = dwo(1)*dwb(i, j, k, 1)
   dwob(1) = dwob(1) + b11*dwb(i, j, k, 1)
   b12b = dwo(2)*dwb(i, j, k, 1)
   dwob(2) = dwob(2) + b12*dwb(i, j, k, 1)
   b13b = dwo(3)*dwb(i, j, k, 1)
   dwob(3) = dwob(3) + b13*dwb(i, j, k, 1)
   b14b = dwo(4)*dwb(i, j, k, 1)
   dwob(4) = dwob(4) + b14*dwb(i, j, k, 1)
   b15b = dwo(5)*dwb(i, j, k, 1)
   dwob(5) = dwob(5) + b15*dwb(i, j, k, 1)
   dwb(i, j, k, 1) = 0.0_8
   DO l=nwf,1,-1
   CALL POPREAL8(dwo(l))
   tempb63 = REAL(iblank(i, j, k), realtype)*dwob(l)
   dwb(i, j, k, l) = dwb(i, j, k, l) + tempb63
   fwb(i, j, k, l) = fwb(i, j, k, l) + tempb63
   dwob(l) = 0.0_8
   END DO
   temp4 = sos**4
   temp5 = sos**4
   temp8 = gamma(i, j, k) - 1
   tempb60 = (gamma(i, j, k)-1)*b11b
   tempb46 = (1-gamma(i, j, k))*b12b
   tempb47 = (1-gamma(i, j, k))*b12b
   tempb31 = (1-gamma(i, j, k))*b13b
   tempb32 = (1-gamma(i, j, k))*b13b
   tempb16 = (1-gamma(i, j, k))*b14b
   tempb17 = (1-gamma(i, j, k))*b14b
   temp15 = gamma(i, j, k) - 1
   tempb57 = (gamma(i, j, k)-1)*b21b
   tempb48 = (1-gamma(i, j, k))*b22b
   tempb49 = (1-gamma(i, j, k))*b22b
   tempb33 = (1-gamma(i, j, k))*b23b
   tempb34 = (1-gamma(i, j, k))*b23b
   tempb18 = (1-gamma(i, j, k))*b24b
   tempb19 = (1-gamma(i, j, k))*b24b
   temp22 = gamma(i, j, k) - 1
   tempb62 = (gamma(i, j, k)-1)*b31b
   tempb50 = (1-gamma(i, j, k))*b32b
   tempb51 = (1-gamma(i, j, k))*b32b
   tempb35 = (1-gamma(i, j, k))*b33b
   tempb36 = (1-gamma(i, j, k))*b33b
   tempb20 = (1-gamma(i, j, k))*b34b
   tempb21 = (1-gamma(i, j, k))*b34b
   temp29 = gamma(i, j, k) - 1
   tempb55 = (gamma(i, j, k)-1)*b41b
   tempb52 = (1-gamma(i, j, k))*b42b
   tempb53 = (1-gamma(i, j, k))*b42b
   tempb37 = (1-gamma(i, j, k))*b43b
   tempb38 = (1-gamma(i, j, k))*b43b
   tempb22 = (1-gamma(i, j, k))*b44b
   tempb23 = (1-gamma(i, j, k))*b44b
   q = velxrho**2 + velyrho**2 + velzrho**2
   tempb4 = (gamma(i, j, k)-1)*b51b
   temp38 = w(i, j, k, irho)
   tempb39 = -(b51b/temp38)
   temp37 = w(i, j, k, irho)
   tempb24 = -(b51b/temp37)
   temp36 = gamma(i, j, k) - 1
   temp35 = w(i, j, k, irho)
   tempb9 = -(b51b/temp35)
   a41b = velzrho*tempb23 + velxrho*tempb53 + q*tempb55/2 + &
   &           velyrho*tempb38 + (gamma(i, j, k)-1)*b45b
   a45b = velzrho*tempb22 + velxrho*tempb52 + (temp29*(q/2)-sos**&
   &           2)*b41b + velyrho*tempb37 + (gamma(i, j, k)-1)*b45b
   a44 = one*w(i, j, k, irho)
   a43 = zero
   a42 = zero
   temp31 = w(i, j, k, irho)
   tempb40 = -(a42*b41b/temp31)
   temp30 = w(i, j, k, irho)
   tempb25 = -(a43*b41b/temp30)
   tempb56 = a45*b41b
   temp28 = w(i, j, k, irho)
   tempb10 = -(b41b/temp28)
   a31b = velzrho*tempb21 + velxrho*tempb51 + q*tempb62/2 + &
   &           velyrho*tempb36 + (gamma(i, j, k)-1)*b35b
   a35b = velzrho*tempb20 + velxrho*tempb50 + (temp22*(q/2)-sos**&
   &           2)*b31b + velyrho*tempb35 + (gamma(i, j, k)-1)*b35b
   a34 = zero
   a33 = one*w(i, j, k, irho)
   a32 = zero
   temp24 = w(i, j, k, irho)
   tempb41 = -(a32*b31b/temp24)
   temp23 = w(i, j, k, irho)
   tempb26 = -(b31b/temp23)
   tempb61 = a35*b31b
   temp21 = w(i, j, k, irho)
   tempb11 = -(a34*b31b/temp21)
   a21b = velzrho*tempb19 + velxrho*tempb49 + q*tempb57/2 + &
   &           velyrho*tempb34 + (gamma(i, j, k)-1)*b25b
   a25b = velzrho*tempb18 + velxrho*tempb48 + (temp15*(q/2)-sos**&
   &           2)*b21b + velyrho*tempb33 + (gamma(i, j, k)-1)*b25b
   a24 = zero
   a23 = zero
   a22 = one*w(i, j, k, irho)
   temp17 = w(i, j, k, irho)
   tempb42 = -(b21b/temp17)
   temp16 = w(i, j, k, irho)
   tempb27 = -(a23*b21b/temp16)
   tempb58 = a25*b21b
   temp14 = w(i, j, k, irho)
   tempb12 = -(a24*b21b/temp14)
   a11b = velzrho*tempb17 + velxrho*tempb47 + q*tempb60/2 + &
   &           velyrho*tempb32 + (gamma(i, j, k)-1)*b15b
   a15b = velzrho*tempb16 + velxrho*tempb46 + (temp8*(q/2)-sos**2&
   &           )*b11b + velyrho*tempb31 + (gamma(i, j, k)-1)*b15b
   a14 = zero
   a13 = zero
   a12 = zero
   temp10 = w(i, j, k, irho)
   tempb43 = -(a12*b11b/temp10)
   temp9 = w(i, j, k, irho)
   tempb28 = -(a13*b11b/temp9)
   tempb59 = a15*b11b
   temp7 = w(i, j, k, irho)
   tempb13 = -(a14*b11b/temp7)
   tempb14 = -(one*a45b/sos**2)
   tempb15 = one*a41b/sos**2
   tempb29 = -(one*a35b/sos**2)
   tempb30 = one*a31b/sos**2
   tempb44 = -(one*a25b/sos**2)
   tempb45 = one*a21b/sos**2
   tempb7 = (1-gamma(i, j, k))*b52b
   tempb3 = (1-gamma(i, j, k))*b52b
   tempb8 = (1-gamma(i, j, k))*b53b
   tempb5 = (1-gamma(i, j, k))*b53b
   tempb6 = (1-gamma(i, j, k))*b54b
   tempb2 = (1-gamma(i, j, k))*b54b
   a51b = velzrho*tempb2 + velxrho*tempb3 + q*tempb4/2 + velyrho*&
   &           tempb5 + (gamma(i, j, k)-1)*b55b
   gammab(i, j, k) = gammab(i, j, k) + (a55+a51)*b55b
   a55b = velzrho*tempb6 + velxrho*tempb7 + (temp36*(q/2)-sos**2)&
   &           *b51b + velyrho*tempb8 + (gamma(i, j, k)-1)*b55b
   a54 = one*w(i, j, k, irho)*velzrho
   CALL POPREAL8(b54)
   temp41 = w(i, j, k, irho)
   gammab(i, j, k) = gammab(i, j, k) + (-(a55*velzrho)-a51*&
   &           velzrho)*b54b
   a54b = velzrho*tempb9 + b54b/temp41
   velzrhob = a54*tempb9 + a44*tempb10 + tempb11 + tempb12 + &
   &           tempb13 + tempb14 + tempb15 + one*w(i, j, k, irho)*a54b + &
   &           a15*tempb16 + a11*tempb17 + a25*tempb18 + a21*tempb19 + a35*&
   &           tempb20 + a31*tempb21 + a45*tempb22 + a41*tempb23 + a55*&
   &           tempb6 + a51*tempb2
   wb(i, j, k, irho) = wb(i, j, k, irho) - a54*b54b/temp41**2
   a53 = one*w(i, j, k, irho)*velyrho
   CALL POPREAL8(b53)
   temp40 = w(i, j, k, irho)
   gammab(i, j, k) = gammab(i, j, k) + (-(a55*velyrho)-a51*&
   &           velyrho)*b53b
   a53b = velyrho*tempb24 + b53b/temp40
   velyrhob = a53*tempb24 + tempb25 + a33*tempb26 + tempb27 + &
   &           tempb28 + tempb29 + tempb30 + one*w(i, j, k, irho)*a53b + &
   &           a15*tempb31 + a11*tempb32 + a25*tempb33 + a21*tempb34 + a35*&
   &           tempb35 + a31*tempb36 + a45*tempb37 + a41*tempb38 + a55*&
   &           tempb8 + a51*tempb5
   wb(i, j, k, irho) = wb(i, j, k, irho) - a53*b53b/temp40**2
   a52 = one*w(i, j, k, irho)*velxrho
   CALL POPREAL8(b52)
   temp39 = w(i, j, k, irho)
   gammab(i, j, k) = gammab(i, j, k) + (-(a55*velxrho)-a51*&
   &           velxrho)*b52b
   a52b = velxrho*tempb39 + b52b/temp39
   velxrhob = a52*tempb39 + tempb40 + tempb41 + a22*tempb42 + &
   &           tempb43 + tempb44 + tempb45 + one*w(i, j, k, irho)*a52b + &
   &           a15*tempb46 + a11*tempb47 + a25*tempb48 + a21*tempb49 + a35*&
   &           tempb50 + a31*tempb51 + a45*tempb52 + a41*tempb53 + a55*&
   &           tempb7 + a51*tempb3
   wb(i, j, k, irho) = wb(i, j, k, irho) - a52*b52b/temp39**2
   CALL POPREAL8(b51)
   tempb54 = a55*b51b
   qb = a41*tempb55/2 + temp29*tempb56/2 + a21*tempb57/2 + temp15&
   &           *tempb58/2 + temp8*tempb59/2 + a11*tempb60/2 + temp22*&
   &           tempb61/2 + a31*tempb62/2 + temp36*tempb54/2 + a51*tempb4/2
   gammab(i, j, k) = gammab(i, j, k) + q*tempb54/2 + a51*q*b51b/2
   wb(i, j, k, irho) = wb(i, j, k, irho) - a54*velzrho*tempb9/&
   &           temp35 - a53*velyrho*tempb24/temp37 - a52*velxrho*tempb39/&
   &           temp38
   sosb = betamr2*4*sos**3*a15b/temp5**2 - 2*sos*tempb58 - &
   &           velzrho*2*tempb14/sos - velyrho*2*tempb29/sos - velxrho*2*&
   &           tempb44/sos - 2*sos*tempb56 - betamr2*4*sos**3*a11b/temp4**2&
   &           - velxrho*2*tempb45/sos - velyrho*2*tempb30/sos - velzrho*2*&
   &           tempb15/sos - 2*sos*tempb59 - 2*sos*tempb61 - 2*sos*tempb54
   gammab(i, j, k) = gammab(i, j, k) + (a45+a41)*b45b
   CALL POPREAL8(b44)
   temp34 = w(i, j, k, irho)
   gammab(i, j, k) = gammab(i, j, k) + (-(a45*velzrho)-a41*&
   &           velzrho)*b44b
   a44b = velzrho*tempb10 + b44b/temp34
   wb(i, j, k, irho) = wb(i, j, k, irho) - a44*b44b/temp34**2
   CALL POPREAL8(b43)
   temp33 = w(i, j, k, irho)
   gammab(i, j, k) = gammab(i, j, k) + (-(a45*velyrho)-a41*&
   &           velyrho)*b43b
   wb(i, j, k, irho) = wb(i, j, k, irho) - a43*b43b/temp33**2
   CALL POPREAL8(b42)
   temp32 = w(i, j, k, irho)
   gammab(i, j, k) = gammab(i, j, k) + (-(a45*velxrho)-a41*&
   &           velxrho)*b42b
   wb(i, j, k, irho) = wb(i, j, k, irho) - a42*b42b/temp32**2
   CALL POPREAL8(b41)
   gammab(i, j, k) = gammab(i, j, k) + q*tempb56/2 + a41*q*b41b/2
   wb(i, j, k, irho) = wb(i, j, k, irho) - a44*velzrho*tempb10/&
   &           temp28 - velyrho*tempb25/temp30 - velxrho*tempb40/temp31
   gammab(i, j, k) = gammab(i, j, k) + (a35+a31)*b35b
   CALL POPREAL8(b34)
   temp27 = w(i, j, k, irho)
   gammab(i, j, k) = gammab(i, j, k) + (-(a35*velzrho)-a31*&
   &           velzrho)*b34b
   wb(i, j, k, irho) = wb(i, j, k, irho) - a34*b34b/temp27**2
   CALL POPREAL8(b33)
   temp26 = w(i, j, k, irho)
   gammab(i, j, k) = gammab(i, j, k) + (-(a35*velyrho)-a31*&
   &           velyrho)*b33b
   a33b = velyrho*tempb26 + b33b/temp26
   wb(i, j, k, irho) = wb(i, j, k, irho) - a33*b33b/temp26**2
   CALL POPREAL8(b32)
   temp25 = w(i, j, k, irho)
   gammab(i, j, k) = gammab(i, j, k) + (-(a35*velxrho)-a31*&
   &           velxrho)*b32b
   wb(i, j, k, irho) = wb(i, j, k, irho) - a32*b32b/temp25**2
   CALL POPREAL8(b31)
   gammab(i, j, k) = gammab(i, j, k) + q*tempb61/2 + a31*q*b31b/2
   wb(i, j, k, irho) = wb(i, j, k, irho) - velzrho*tempb11/temp21&
   &           - a33*velyrho*tempb26/temp23 - velxrho*tempb41/temp24
   gammab(i, j, k) = gammab(i, j, k) + (a25+a21)*b25b
   CALL POPREAL8(b24)
   temp20 = w(i, j, k, irho)
   gammab(i, j, k) = gammab(i, j, k) + (-(a25*velzrho)-a21*&
   &           velzrho)*b24b
   wb(i, j, k, irho) = wb(i, j, k, irho) - a24*b24b/temp20**2
   CALL POPREAL8(b23)
   temp19 = w(i, j, k, irho)
   gammab(i, j, k) = gammab(i, j, k) + (-(a25*velyrho)-a21*&
   &           velyrho)*b23b
   wb(i, j, k, irho) = wb(i, j, k, irho) - a23*b23b/temp19**2
   CALL POPREAL8(b22)
   temp18 = w(i, j, k, irho)
   gammab(i, j, k) = gammab(i, j, k) + (-(a25*velxrho)-a21*&
   &           velxrho)*b22b
   a22b = velxrho*tempb42 + b22b/temp18
   wb(i, j, k, irho) = wb(i, j, k, irho) - a22*b22b/temp18**2
   CALL POPREAL8(b21)
   gammab(i, j, k) = gammab(i, j, k) + q*tempb58/2 + a21*q*b21b/2
   wb(i, j, k, irho) = wb(i, j, k, irho) - velzrho*tempb12/temp14&
   &           - velyrho*tempb27/temp16 - a22*velxrho*tempb42/temp17
   gammab(i, j, k) = gammab(i, j, k) + (a15+a11)*b15b
   CALL POPREAL8(b14)
   temp13 = w(i, j, k, irho)
   gammab(i, j, k) = gammab(i, j, k) + (-(a15*velzrho)-a11*&
   &           velzrho)*b14b
   wb(i, j, k, irho) = wb(i, j, k, irho) - a14*b14b/temp13**2
   CALL POPREAL8(b13)
   temp12 = w(i, j, k, irho)
   gammab(i, j, k) = gammab(i, j, k) + (-(a15*velyrho)-a11*&
   &           velyrho)*b13b
   wb(i, j, k, irho) = wb(i, j, k, irho) - a13*b13b/temp12**2
   CALL POPREAL8(b12)
   temp11 = w(i, j, k, irho)
   gammab(i, j, k) = gammab(i, j, k) + (-(a15*velxrho)-a11*&
   &           velxrho)*b12b
   wb(i, j, k, irho) = wb(i, j, k, irho) - a12*b12b/temp11**2
   CALL POPREAL8(b11)
   gammab(i, j, k) = gammab(i, j, k) + q*tempb59/2 + a11*q*b11b/2
   wb(i, j, k, irho) = wb(i, j, k, irho) - velzrho*tempb13/temp7 &
   &           - velyrho*tempb28/temp9 - velxrho*tempb43/temp10
   resmb = one*resm*a51b - one*resm*a55b
   wb(i, j, k, irho) = wb(i, j, k, irho) + one*velzrho*a54b
   wb(i, j, k, irho) = wb(i, j, k, irho) + one*velyrho*a53b
   wb(i, j, k, irho) = wb(i, j, k, irho) + one*velxrho*a52b
   temp6 = gamma(i, j, k) - 1
   gammab(i, j, k) = gammab(i, j, k) - one*a51b/temp6**2
   wb(i, j, k, irho) = wb(i, j, k, irho) + one*a44b
   wb(i, j, k, irho) = wb(i, j, k, irho) + one*a33b
   wb(i, j, k, irho) = wb(i, j, k, irho) + one*a22b
   betamr2b = a11b/temp4 - a15b/temp5
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   CALL POPREAL8(betamr2)
   sosb = sosb + 2*sos*betamr2b
   x1b = 0.0_8
   ELSE
   CALL POPREAL8(betamr2)
   x1b = betamr2b
   END IF
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   tempb0 = k2*x1b
   winfb(ivx) = winfb(ivx) + 2*winf(ivx)*tempb0
   winfb(ivy) = winfb(ivy) + 2*winf(ivy)*tempb0
   winfb(ivz) = winfb(ivz) + 2*winf(ivz)*tempb0
   k3b = 0.0_8
   ELSE
   tempb1 = k3*x1b
   k3b = (velxrho**2+velyrho**2+velzrho**2)*x1b
   velxrhob = velxrhob + 2*velxrho*tempb1
   velyrhob = velyrhob + 2*velyrho*tempb1
   velzrhob = velzrhob + 2*velzrho*tempb1
   END IF
   CALL POPREAL8(k3)
   resmb = resmb + (1-k1*m0**2)*2*resm*k3b/m0**4
   CALL POPREAL8(resm)
   temp3 = SQRT(q)
   IF (.NOT.q .EQ. 0.0_8) qb = qb + resmb/(sos*2.0*temp3)
   sosb = sosb - temp3*resmb/sos**2
   velxrhob = velxrhob + 2*velxrho*qb
   velyrhob = velyrhob + 2*velyrho*qb
   velzrhob = velzrhob + 2*velzrho*qb
   wb(i, j, k, ivz) = wb(i, j, k, ivz) + velzrhob
   wb(i, j, k, ivy) = wb(i, j, k, ivy) + velyrhob
   wb(i, j, k, ivx) = wb(i, j, k, ivx) + velxrhob
   CALL POPREAL8(sos)
   temp2 = w(i, j, k, irho)
   temp1 = gamma(i, j, k)*p(i, j, k)
   temp0 = temp1/temp2
   IF (temp0 .EQ. 0.0_8) THEN
   tempb = 0.0
   ELSE
   tempb = sosb/(2.0*SQRT(temp0)*temp2)
   END IF
   gammab(i, j, k) = gammab(i, j, k) + p(i, j, k)*tempb
   pb(i, j, k) = pb(i, j, k) + gamma(i, j, k)*tempb
   wb(i, j, k, irho) = wb(i, j, k, irho) - temp0*tempb
   END DO
   END DO
   END DO
   ELSE
   fwb = 0.0_8
   DO l=nwf,1,-1
   DO k=kl,2,-1
   DO j=jl,2,-1
   DO i=il,2,-1
   tempb65 = REAL(iblank(i, j, k), realtype)*dwb(i, j, k, l)
   fwb(i, j, k, l) = fwb(i, j, k, l) + tempb65
   dwb(i, j, k, l) = tempb65
   END DO
   END DO
   END DO
   END DO
   gammab = 0.0_8
   winfb = 0.0_8
   END IF
   CALL POPCONTROL2B(branch)
   IF (branch .LT. 2) THEN
   IF (branch .EQ. 0) THEN
   CALL POPREAL8ARRAY(p, SIZE(p, 1)*SIZE(p, 2)*SIZE(p, 3))
   CALL VISCOUSFLUX_B()
   ELSE
   CALL POPREAL8ARRAY(p, SIZE(p, 1)*SIZE(p, 2)*SIZE(p, 3))
   CALL VISCOUSFLUX_B()
   END IF
   ELSE IF (branch .EQ. 2) THEN
   CALL POPREAL8ARRAY(p, SIZE(p, 1)*SIZE(p, 2)*SIZE(p, 3))
   CALL VISCOUSFLUXAPPROX_B()
   ELSE
   revb = 0.0_8
   rlvb = 0.0_8
   END IF
   CALL POPCONTROL2B(branch)
   IF (branch .EQ. 0) THEN
   radib = 0.0_8
   radjb = 0.0_8
   radkb = 0.0_8
   rhoinfb = 0.0_8
   pinfcorrb = 0.0_8
   ELSE IF (branch .EQ. 1) THEN
   CALL POPREAL8ARRAY(w, SIZE(w, 1)*SIZE(w, 2)*SIZE(w, 3)*SIZE(w, 4))
   CALL INVISCIDDISSFLUXSCALAR_B()
   ELSE
   CALL POPREAL8ARRAY(w, SIZE(w, 1)*SIZE(w, 2)*SIZE(w, 3)*SIZE(w, 4))
   CALL INVISCIDDISSFLUXSCALARCOARSE_B()
   rhoinfb = 0.0_8
   pinfcorrb = 0.0_8
   END IF
   CALL INVISCIDCENTRALFLUX_B()
   END SUBROUTINE RESIDUAL_BLOCK_B
