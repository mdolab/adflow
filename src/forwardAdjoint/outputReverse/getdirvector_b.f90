   !        Generated by TAPENADE     (INRIA, Tropics team)
   !  Tapenade 3.10 (r5363) -  9 Sep 2014 09:53
   !
   !  Differentiation of getdirvector in reverse (adjoint) mode (with options i4 dr8 r8 noISIZE):
   !   gradient     of useful results: alpha beta winddirection
   !   with respect to varying inputs: alpha beta
   !
   !     ******************************************************************
   !     *                                                                *
   !     * File:          getDirVector.f90                                *
   !     * Author:        Andre C. Marta                                  *
   !     * Starting date: 10-25-2005                                      *
   !     * Last modified: 10-26-2006                                      *
   !     *                                                                *
   !     ******************************************************************
   !
   SUBROUTINE GETDIRVECTOR_B(refdirection, alpha, alphad, beta, betad, &
   & winddirection, winddirectiond, liftindex)
   !(xb,yb,zb,alpha,beta,xw,yw,zw)
   !
   !     ******************************************************************
   !     *                                                                *
   !     * Convert the angle of attack and side slip angle to wind axes.  *
   !     * The components of the wind direction vector (xw,yw,zw) are     *
   !     * computed given the direction angles in radians and the body    *
   !     * direction by performing two rotations on the original          *
   !     * direction vector:                                              *
   !     *   1) Rotation about the zb or yb-axis: alpha clockwise (CW)    *
   !     *      (xb,yb,zb) -> (x1,y1,z1)                                  *
   !     *                                                                *
   !     *   2) Rotation about the yl or z1-axis: beta counter-clockwise  *
   !     *      (CCW)  (x1,y1,z1) -> (xw,yw,zw)                           *
   !     *                                                                *
   !     *    input arguments:                                            *
   !     *       alpha    = angle of attack in radians                    *
   !     *       beta     = side slip angle in radians                    *
   !     *       refDirection = reference direction vector                *
   !     *    output arguments:                                           *
   !     *       windDirection = unit wind vector in body axes            *
   !     *                                                                *
   !     ******************************************************************
   !
   USE CONSTANTS
   IMPLICIT NONE
   !
   !     Subroutine arguments.
   !
   REAL(kind=realtype), DIMENSION(3), INTENT(IN) :: refdirection
   REAL(kind=realtype) :: alpha, beta
   REAL(kind=realtype) :: alphad, betad
   REAL(kind=realtype), DIMENSION(3) :: winddirection
   REAL(kind=realtype), DIMENSION(3) :: winddirectiond
   INTEGER(kind=inttype) :: liftindex
   !
   !     Local variables.
   !
   REAL(kind=realtype) :: rnorm, x1, y1, z1, xbn, ybn, zbn, xw, yw, zw
   REAL(kind=realtype) :: x1d, y1d, z1d, xbnd, ybnd, zbnd, xwd, ywd, zwd
   REAL(kind=realtype) :: tmp
   REAL(kind=realtype) :: tmpd
   INTRINSIC SQRT
   INTEGER :: branch
   !     ******************************************************************
   !     *                                                                *
   !     * Begin execution.                                               *
   !     *                                                                *
   !     ******************************************************************
   !
   ! Normalize the input vector.
   rnorm = SQRT(refdirection(1)**2 + refdirection(2)**2 + refdirection(3)&
   &   **2)
   xbn = refdirection(1)/rnorm
   ybn = refdirection(2)/rnorm
   zbn = refdirection(3)/rnorm
   !!$      ! Compute the wind direction vector.
   !!$
   !!$      ! 1) rotate alpha radians cw about y-axis
   !!$      !    ( <=> rotate y-axis alpha radians ccw)
   !!$
   !!$      call vectorRotation(x1, y1, z1, 2, alpha, xbn, ybn, zbn)
   !!$
   !!$      ! 2) rotate beta radians ccw about z-axis
   !!$      !    ( <=> rotate z-axis -beta radians ccw)
   !!$
   !!$      call vectorRotation(xw, yw, zw, 3, -beta, x1, y1, z1)
   IF (liftindex .EQ. 2) THEN
   ! Compute the wind direction vector.Aerosurf axes different!!
   ! 1) rotate alpha radians cw about z-axis
   !    ( <=> rotate z-axis alpha radians ccw)
   tmp = -alpha
   CALL VECTORROTATION(x1, y1, z1, 3, tmp, xbn, ybn, zbn)
   ! 2) rotate beta radians ccw about y-axis
   !    ( <=> rotate z-axis -beta radians ccw)
   tmp = -beta
   CALL PUSHCONTROL2B(0)
   ELSE IF (liftindex .EQ. 3) THEN
   ! Compute the wind direction vector.Aerosurf axes different!!
   ! 1) rotate alpha radians cw about z-axis
   !    ( <=> rotate z-axis alpha radians ccw)
   CALL VECTORROTATION(x1, y1, z1, 2, alpha, xbn, ybn, zbn)
   ! 2) rotate beta radians ccw about y-axis
   !    ( <=> rotate z-axis -beta radians ccw)
   CALL PUSHCONTROL2B(1)
   ELSE
   CALL PUSHCONTROL2B(2)
   END IF
   zwd = winddirectiond(3)
   winddirectiond(3) = 0.0_8
   ywd = winddirectiond(2)
   winddirectiond(2) = 0.0_8
   xwd = winddirectiond(1)
   CALL POPCONTROL2B(branch)
   IF (branch .EQ. 0) THEN
   tmpd = 0.0_8
   CALL VECTORROTATION_B(xw, xwd, yw, ywd, zw, zwd, 2, tmp, tmpd, x1, &
   &                   x1d, y1, y1d, z1, z1d)
   betad = betad - tmpd
   tmp = -alpha
   tmpd = 0.0_8
   CALL VECTORROTATION_B(x1, x1d, y1, y1d, z1, z1d, 3, tmp, tmpd, xbn, &
   &                   xbnd, ybn, ybnd, zbn, zbnd)
   alphad = alphad - tmpd
   ELSE IF (branch .EQ. 1) THEN
   CALL VECTORROTATION_B(xw, xwd, yw, ywd, zw, zwd, 3, beta, betad, x1&
   &                   , x1d, y1, y1d, z1, z1d)
   CALL VECTORROTATION_B(x1, x1d, y1, y1d, z1, z1d, 2, alpha, alphad, &
   &                   xbn, xbnd, ybn, ybnd, zbn, zbnd)
   END IF
   END SUBROUTINE GETDIRVECTOR_B
