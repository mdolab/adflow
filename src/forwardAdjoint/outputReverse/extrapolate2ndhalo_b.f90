   !        Generated by TAPENADE     (INRIA, Tropics team)
   !  Tapenade 3.10 (r5363) -  9 Sep 2014 09:53
   !
   !  Differentiation of extrapolate2ndhalo in reverse (adjoint) mode (with options i4 dr8 r8 noISIZE):
   !   gradient     of useful results: *rev *p *gamma *w *rlv tref
   !                rgas
   !   with respect to varying inputs: *rev *p *gamma *w *rlv tref
   !                rgas
   !   Plus diff mem management of: rev:in p:in gamma:in w:in rlv:in
   !                bcdata:in
   !
   !      ******************************************************************
   !      *                                                                *
   !      * File:          extrapolate2ndHalo.f90                          *
   !      * Author:        Edwin van der Weide                             *
   !      * Starting date: 03-10-2003                                      *
   !      * Last modified: 06-12-2005                                      *
   !      *                                                                *
   !      ******************************************************************
   !
   SUBROUTINE EXTRAPOLATE2NDHALO_B(nn, correctfork)
   !
   !      ******************************************************************
   !      *                                                                *
   !      * extrapolate2ndHalo determines the states of the second layer   *
   !      * halo cells for the given subface of the block. It is assumed   *
   !      * that the pointers in blockPointers are already set to the      *
   !      * correct block on the correct grid level.                       *
   !      *                                                                *
   !      ******************************************************************
   !
   USE BCTYPES
   USE BLOCKPOINTERS
   USE CONSTANTS
   USE FLOWVARREFSTATE
   USE ITERATION
   USE INPUTPHYSICS
   IMPLICIT NONE
   !
   !      Subroutine arguments.
   !
   INTEGER(kind=inttype), INTENT(IN) :: nn
   LOGICAL, INTENT(IN) :: correctfork
   !
   !      Local parameter.
   !
   REAL(kind=realtype), PARAMETER :: factor=0.5_realType
   !
   !      Local variables.
   !
   INTEGER(kind=inttype) :: i, j, l, idim, ddim
   INTEGER(kind=inttype), DIMENSION(3, 2) :: crange
   INTRINSIC MAX
   REAL(kind=realtype) :: tmp
   REAL(kind=realtype) :: tmp0
   REAL(kind=realtype) :: tmp1
   REAL(kind=realtype) :: tmp2
   REAL(kind=realtype) :: tmp3
   REAL(kind=realtype) :: tmp4
   REAL(kind=realtype) :: tmp5
   REAL(kind=realtype) :: tmp6
   REAL(kind=realtype) :: tmp7
   REAL(kind=realtype) :: tmp8
   REAL(kind=realtype) :: tmp9
   REAL(kind=realtype) :: tmp10
   REAL(kind=realtype) :: tmp11
   REAL(kind=realtype) :: tmp12
   REAL(kind=realtype) :: tmp13
   REAL(kind=realtype) :: tmp14
   REAL(kind=realtype) :: tmp15
   REAL(kind=realtype) :: tmp16
   REAL(kind=realtype) :: tmp17
   REAL(kind=realtype) :: tmp18
   REAL(kind=realtype) :: tmp19
   REAL(kind=realtype) :: tmp20
   REAL(kind=realtype) :: tmp21
   REAL(kind=realtype) :: tmp22
   REAL(kind=realtype) :: tmp23
   REAL(kind=realtype) :: tmp24
   REAL(kind=realtype) :: tmp25
   REAL(kind=realtype) :: tmp26
   REAL(kind=realtype) :: tmp27
   REAL(kind=realtype) :: tmp28
   INTEGER :: branch
   REAL(kind=realtype) :: tmpd20
   REAL(kind=realtype) :: tmpd
   REAL(kind=realtype) :: tmpd19
   REAL(kind=realtype) :: tmpd18
   REAL(kind=realtype) :: tmpd17
   REAL(kind=realtype) :: tmpd16
   REAL(kind=realtype) :: tmpd15
   REAL(kind=realtype) :: tmpd14
   REAL(kind=realtype) :: tmpd13
   REAL(kind=realtype) :: tmpd12
   REAL(kind=realtype) :: tmpd11
   REAL(kind=realtype) :: tmpd10
   REAL(kind=realtype) :: tmpd9
   REAL(kind=realtype) :: tmpd8
   REAL(kind=realtype) :: tmpd7
   REAL(kind=realtype) :: tmpd6
   REAL(kind=realtype) :: tmpd5
   REAL(kind=realtype) :: tmpd4
   REAL(kind=realtype) :: tmpd3
   REAL(kind=realtype) :: tmpd2
   REAL(kind=realtype) :: tmpd1
   REAL(kind=realtype) :: tmpd0
   REAL(kind=realtype) :: tmpd28
   REAL(kind=realtype) :: tmpd27
   REAL(kind=realtype) :: tmpd26
   REAL(kind=realtype) :: tmpd25
   REAL(kind=realtype) :: tmpd24
   REAL(kind=realtype) :: tmpd23
   REAL(kind=realtype) :: tmpd22
   REAL(kind=realtype) :: tmpd21
   SELECT CASE  (bcfaceid(nn)) 
   CASE (imin) 
   DO j=bcdata(nn)%jcbeg,bcdata(nn)%jcend
   DO i=bcdata(nn)%icbeg,bcdata(nn)%icend
   ! Extrapolate the density, momentum and pressure.
   ! Make sure that a certain threshold is kept.
   w(0, i, j, irho) = two*w(1, i, j, irho) - w(2, i, j, irho)
   IF (factor*w(1, i, j, irho) .LT. w(0, i, j, irho)) THEN
   CALL PUSHCONTROL1B(0)
   w(0, i, j, irho) = w(0, i, j, irho)
   ELSE
   w(0, i, j, irho) = factor*w(1, i, j, irho)
   CALL PUSHCONTROL1B(1)
   END IF
   w(0, i, j, ivx) = two*w(1, i, j, ivx) - w(2, i, j, ivx)
   w(0, i, j, ivy) = two*w(1, i, j, ivy) - w(2, i, j, ivy)
   w(0, i, j, ivz) = two*w(1, i, j, ivz) - w(2, i, j, ivz)
   IF (factor*p(1, i, j) .LT. two*p(1, i, j) - p(2, i, j)) THEN
   CALL PUSHREAL8(p(0, i, j))
   p(0, i, j) = two*p(1, i, j) - p(2, i, j)
   CALL PUSHCONTROL1B(0)
   ELSE
   CALL PUSHREAL8(p(0, i, j))
   p(0, i, j) = factor*p(1, i, j)
   CALL PUSHCONTROL1B(1)
   END IF
   ! Extrapolate the turbulent variables. Use constant
   ! extrapolation.
   DO l=nt1mg,nt2mg
   w(0, i, j, l) = w(1, i, j, l)
   END DO
   ! The laminar and eddy viscosity, if present. These values
   ! are simply taken constant. Their values do not matter.
   IF (viscous) THEN
   CALL PUSHCONTROL1B(0)
   ELSE
   CALL PUSHCONTROL1B(1)
   END IF
   IF (eddymodel) THEN
   CALL PUSHCONTROL1B(1)
   ELSE
   CALL PUSHCONTROL1B(0)
   END IF
   END DO
   END DO
   CALL PUSHCONTROL3B(1)
   idim = 1
   ddim = 0
   CASE (imax) 
   DO j=bcdata(nn)%jcbeg,bcdata(nn)%jcend
   DO i=bcdata(nn)%icbeg,bcdata(nn)%icend
   tmp = two*w(ie, i, j, irho) - w(il, i, j, irho)
   w(ib, i, j, irho) = tmp
   IF (factor*w(ie, i, j, irho) .LT. w(ib, i, j, irho)) THEN
   CALL PUSHCONTROL1B(0)
   w(ib, i, j, irho) = w(ib, i, j, irho)
   ELSE
   tmp0 = factor*w(ie, i, j, irho)
   w(ib, i, j, irho) = tmp0
   CALL PUSHCONTROL1B(1)
   END IF
   tmp1 = two*w(ie, i, j, ivx) - w(il, i, j, ivx)
   w(ib, i, j, ivx) = tmp1
   tmp2 = two*w(ie, i, j, ivy) - w(il, i, j, ivy)
   w(ib, i, j, ivy) = tmp2
   tmp3 = two*w(ie, i, j, ivz) - w(il, i, j, ivz)
   w(ib, i, j, ivz) = tmp3
   IF (factor*p(ie, i, j) .LT. two*p(ie, i, j) - p(il, i, j)) THEN
   tmp4 = two*p(ie, i, j) - p(il, i, j)
   CALL PUSHREAL8(p(ib, i, j))
   p(ib, i, j) = tmp4
   CALL PUSHCONTROL1B(0)
   ELSE
   tmp5 = factor*p(ie, i, j)
   CALL PUSHREAL8(p(ib, i, j))
   p(ib, i, j) = tmp5
   CALL PUSHCONTROL1B(1)
   END IF
   DO l=nt1mg,nt2mg
   tmp6 = w(ie, i, j, l)
   w(ib, i, j, l) = tmp6
   END DO
   IF (viscous) THEN
   CALL PUSHCONTROL1B(0)
   ELSE
   CALL PUSHCONTROL1B(1)
   END IF
   IF (eddymodel) THEN
   CALL PUSHCONTROL1B(1)
   ELSE
   CALL PUSHCONTROL1B(0)
   END IF
   END DO
   END DO
   CALL PUSHCONTROL3B(2)
   idim = 1
   ddim = ib
   CASE (jmin) 
   DO j=bcdata(nn)%jcbeg,bcdata(nn)%jcend
   DO i=bcdata(nn)%icbeg,bcdata(nn)%icend
   w(i, 0, j, irho) = two*w(i, 1, j, irho) - w(i, 2, j, irho)
   IF (factor*w(i, 1, j, irho) .LT. w(i, 0, j, irho)) THEN
   CALL PUSHCONTROL1B(0)
   w(i, 0, j, irho) = w(i, 0, j, irho)
   ELSE
   w(i, 0, j, irho) = factor*w(i, 1, j, irho)
   CALL PUSHCONTROL1B(1)
   END IF
   w(i, 0, j, ivx) = two*w(i, 1, j, ivx) - w(i, 2, j, ivx)
   w(i, 0, j, ivy) = two*w(i, 1, j, ivy) - w(i, 2, j, ivy)
   w(i, 0, j, ivz) = two*w(i, 1, j, ivz) - w(i, 2, j, ivz)
   IF (factor*p(i, 1, j) .LT. two*p(i, 1, j) - p(i, 2, j)) THEN
   CALL PUSHREAL8(p(i, 0, j))
   p(i, 0, j) = two*p(i, 1, j) - p(i, 2, j)
   CALL PUSHCONTROL1B(0)
   ELSE
   CALL PUSHREAL8(p(i, 0, j))
   p(i, 0, j) = factor*p(i, 1, j)
   CALL PUSHCONTROL1B(1)
   END IF
   DO l=nt1mg,nt2mg
   w(i, 0, j, l) = w(i, 1, j, l)
   END DO
   IF (viscous) THEN
   CALL PUSHCONTROL1B(0)
   ELSE
   CALL PUSHCONTROL1B(1)
   END IF
   IF (eddymodel) THEN
   CALL PUSHCONTROL1B(1)
   ELSE
   CALL PUSHCONTROL1B(0)
   END IF
   END DO
   END DO
   CALL PUSHCONTROL3B(3)
   idim = 2
   ddim = 0
   CASE (jmax) 
   DO j=bcdata(nn)%jcbeg,bcdata(nn)%jcend
   DO i=bcdata(nn)%icbeg,bcdata(nn)%icend
   tmp9 = two*w(i, je, j, irho) - w(i, jl, j, irho)
   w(i, jb, j, irho) = tmp9
   IF (factor*w(i, je, j, irho) .LT. w(i, jb, j, irho)) THEN
   CALL PUSHCONTROL1B(0)
   w(i, jb, j, irho) = w(i, jb, j, irho)
   ELSE
   tmp10 = factor*w(i, je, j, irho)
   w(i, jb, j, irho) = tmp10
   CALL PUSHCONTROL1B(1)
   END IF
   tmp11 = two*w(i, je, j, ivx) - w(i, jl, j, ivx)
   w(i, jb, j, ivx) = tmp11
   tmp12 = two*w(i, je, j, ivy) - w(i, jl, j, ivy)
   w(i, jb, j, ivy) = tmp12
   tmp13 = two*w(i, je, j, ivz) - w(i, jl, j, ivz)
   w(i, jb, j, ivz) = tmp13
   IF (factor*p(i, je, j) .LT. two*p(i, je, j) - p(i, jl, j)) THEN
   tmp14 = two*p(i, je, j) - p(i, jl, j)
   CALL PUSHREAL8(p(i, jb, j))
   p(i, jb, j) = tmp14
   CALL PUSHCONTROL1B(0)
   ELSE
   tmp15 = factor*p(i, je, j)
   CALL PUSHREAL8(p(i, jb, j))
   p(i, jb, j) = tmp15
   CALL PUSHCONTROL1B(1)
   END IF
   DO l=nt1mg,nt2mg
   tmp16 = w(i, je, j, l)
   w(i, jb, j, l) = tmp16
   END DO
   IF (viscous) THEN
   CALL PUSHCONTROL1B(0)
   ELSE
   CALL PUSHCONTROL1B(1)
   END IF
   IF (eddymodel) THEN
   CALL PUSHCONTROL1B(1)
   ELSE
   CALL PUSHCONTROL1B(0)
   END IF
   END DO
   END DO
   CALL PUSHCONTROL3B(4)
   idim = 2
   ddim = jb
   CASE (kmin) 
   DO j=bcdata(nn)%jcbeg,bcdata(nn)%jcend
   DO i=bcdata(nn)%icbeg,bcdata(nn)%icend
   w(i, j, 0, irho) = two*w(i, j, 1, irho) - w(i, j, 2, irho)
   IF (factor*w(i, j, 1, irho) .LT. w(i, j, 0, irho)) THEN
   CALL PUSHCONTROL1B(0)
   w(i, j, 0, irho) = w(i, j, 0, irho)
   ELSE
   w(i, j, 0, irho) = factor*w(i, j, 1, irho)
   CALL PUSHCONTROL1B(1)
   END IF
   w(i, j, 0, ivx) = two*w(i, j, 1, ivx) - w(i, j, 2, ivx)
   w(i, j, 0, ivy) = two*w(i, j, 1, ivy) - w(i, j, 2, ivy)
   w(i, j, 0, ivz) = two*w(i, j, 1, ivz) - w(i, j, 2, ivz)
   IF (factor*p(i, j, 1) .LT. two*p(i, j, 1) - p(i, j, 2)) THEN
   CALL PUSHREAL8(p(i, j, 0))
   p(i, j, 0) = two*p(i, j, 1) - p(i, j, 2)
   CALL PUSHCONTROL1B(0)
   ELSE
   CALL PUSHREAL8(p(i, j, 0))
   p(i, j, 0) = factor*p(i, j, 1)
   CALL PUSHCONTROL1B(1)
   END IF
   DO l=nt1mg,nt2mg
   w(i, j, 0, l) = w(i, j, 1, l)
   END DO
   IF (viscous) THEN
   CALL PUSHCONTROL1B(0)
   ELSE
   CALL PUSHCONTROL1B(1)
   END IF
   IF (eddymodel) THEN
   CALL PUSHCONTROL1B(1)
   ELSE
   CALL PUSHCONTROL1B(0)
   END IF
   END DO
   END DO
   CALL PUSHCONTROL3B(5)
   idim = 3
   ddim = 0
   CASE (kmax) 
   DO j=bcdata(nn)%jcbeg,bcdata(nn)%jcend
   DO i=bcdata(nn)%icbeg,bcdata(nn)%icend
   tmp19 = two*w(i, j, ke, irho) - w(i, j, kl, irho)
   w(i, j, kb, irho) = tmp19
   IF (factor*w(i, j, ke, irho) .LT. w(i, j, kb, irho)) THEN
   CALL PUSHCONTROL1B(0)
   w(i, j, kb, irho) = w(i, j, kb, irho)
   ELSE
   tmp20 = factor*w(i, j, ke, irho)
   w(i, j, kb, irho) = tmp20
   CALL PUSHCONTROL1B(1)
   END IF
   tmp21 = two*w(i, j, ke, ivx) - w(i, j, kl, ivx)
   w(i, j, kb, ivx) = tmp21
   tmp22 = two*w(i, j, ke, ivy) - w(i, j, kl, ivy)
   w(i, j, kb, ivy) = tmp22
   tmp23 = two*w(i, j, ke, ivz) - w(i, j, kl, ivz)
   w(i, j, kb, ivz) = tmp23
   IF (factor*p(i, j, ke) .LT. two*p(i, j, ke) - p(i, j, kl)) THEN
   tmp24 = two*p(i, j, ke) - p(i, j, kl)
   CALL PUSHREAL8(p(i, j, kb))
   p(i, j, kb) = tmp24
   CALL PUSHCONTROL1B(0)
   ELSE
   tmp25 = factor*p(i, j, ke)
   CALL PUSHREAL8(p(i, j, kb))
   p(i, j, kb) = tmp25
   CALL PUSHCONTROL1B(1)
   END IF
   DO l=nt1mg,nt2mg
   tmp26 = w(i, j, ke, l)
   w(i, j, kb, l) = tmp26
   END DO
   IF (viscous) THEN
   CALL PUSHCONTROL1B(0)
   ELSE
   CALL PUSHCONTROL1B(1)
   END IF
   IF (eddymodel) THEN
   CALL PUSHCONTROL1B(1)
   ELSE
   CALL PUSHCONTROL1B(0)
   END IF
   END DO
   END DO
   CALL PUSHCONTROL3B(6)
   idim = 3
   ddim = kb
   CASE DEFAULT
   CALL PUSHCONTROL3B(0)
   END SELECT
   ! Set the range for the halo cells for the energy computation.
   crange(1, 1) = icbeg(nn)
   crange(1, 2) = icend(nn)
   crange(2, 1) = jcbeg(nn)
   crange(2, 2) = jcend(nn)
   crange(3, 1) = kcbeg(nn)
   crange(3, 2) = kcend(nn)
   crange(idim, 1) = ddim
   crange(idim, 2) = ddim
   ! Compute the energy for this halo range.
   CALL COMPUTEETOT_B(crange(1, 1), crange(1, 2), crange(2, 1), crange(2&
   &              , 2), crange(3, 1), crange(3, 2), correctfork)
   CALL POPCONTROL3B(branch)
   IF (branch .LT. 3) THEN
   IF (branch .NE. 0) THEN
   IF (branch .EQ. 1) THEN
   DO j=bcdata(nn)%jcend,bcdata(nn)%jcbeg,-1
   DO i=bcdata(nn)%icend,bcdata(nn)%icbeg,-1
   CALL POPCONTROL1B(branch)
   IF (branch .NE. 0) THEN
   revd(1, i, j) = revd(1, i, j) + revd(0, i, j)
   revd(0, i, j) = 0.0_8
   END IF
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   rlvd(1, i, j) = rlvd(1, i, j) + rlvd(0, i, j)
   rlvd(0, i, j) = 0.0_8
   END IF
   DO l=nt2mg,nt1mg,-1
   wd(1, i, j, l) = wd(1, i, j, l) + wd(0, i, j, l)
   wd(0, i, j, l) = 0.0_8
   END DO
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   CALL POPREAL8(p(0, i, j))
   pd(1, i, j) = pd(1, i, j) + two*pd(0, i, j)
   pd(2, i, j) = pd(2, i, j) - pd(0, i, j)
   pd(0, i, j) = 0.0_8
   ELSE
   CALL POPREAL8(p(0, i, j))
   pd(1, i, j) = pd(1, i, j) + factor*pd(0, i, j)
   pd(0, i, j) = 0.0_8
   END IF
   wd(1, i, j, ivz) = wd(1, i, j, ivz) + two*wd(0, i, j, ivz)
   wd(2, i, j, ivz) = wd(2, i, j, ivz) - wd(0, i, j, ivz)
   wd(0, i, j, ivz) = 0.0_8
   wd(1, i, j, ivy) = wd(1, i, j, ivy) + two*wd(0, i, j, ivy)
   wd(2, i, j, ivy) = wd(2, i, j, ivy) - wd(0, i, j, ivy)
   wd(0, i, j, ivy) = 0.0_8
   wd(1, i, j, ivx) = wd(1, i, j, ivx) + two*wd(0, i, j, ivx)
   wd(2, i, j, ivx) = wd(2, i, j, ivx) - wd(0, i, j, ivx)
   wd(0, i, j, ivx) = 0.0_8
   CALL POPCONTROL1B(branch)
   IF (branch .NE. 0) THEN
   wd(1, i, j, irho) = wd(1, i, j, irho) + factor*wd(0, i, j&
   &               , irho)
   wd(0, i, j, irho) = 0.0_8
   END IF
   wd(1, i, j, irho) = wd(1, i, j, irho) + two*wd(0, i, j, irho&
   &             )
   wd(2, i, j, irho) = wd(2, i, j, irho) - wd(0, i, j, irho)
   wd(0, i, j, irho) = 0.0_8
   END DO
   END DO
   ELSE
   DO j=bcdata(nn)%jcend,bcdata(nn)%jcbeg,-1
   DO i=bcdata(nn)%icend,bcdata(nn)%icbeg,-1
   CALL POPCONTROL1B(branch)
   IF (branch .NE. 0) THEN
   tmpd8 = revd(ib, i, j)
   revd(ib, i, j) = 0.0_8
   revd(ie, i, j) = revd(ie, i, j) + tmpd8
   END IF
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   tmpd7 = rlvd(ib, i, j)
   rlvd(ib, i, j) = 0.0_8
   rlvd(ie, i, j) = rlvd(ie, i, j) + tmpd7
   END IF
   DO l=nt2mg,nt1mg,-1
   tmpd6 = wd(ib, i, j, l)
   wd(ib, i, j, l) = 0.0_8
   wd(ie, i, j, l) = wd(ie, i, j, l) + tmpd6
   END DO
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   CALL POPREAL8(p(ib, i, j))
   tmpd4 = pd(ib, i, j)
   pd(ib, i, j) = 0.0_8
   pd(ie, i, j) = pd(ie, i, j) + two*tmpd4
   pd(il, i, j) = pd(il, i, j) - tmpd4
   ELSE
   CALL POPREAL8(p(ib, i, j))
   tmpd5 = pd(ib, i, j)
   pd(ib, i, j) = 0.0_8
   pd(ie, i, j) = pd(ie, i, j) + factor*tmpd5
   END IF
   tmpd1 = wd(ib, i, j, ivz)
   wd(ib, i, j, ivz) = 0.0_8
   wd(ie, i, j, ivz) = wd(ie, i, j, ivz) + two*tmpd1
   wd(il, i, j, ivz) = wd(il, i, j, ivz) - tmpd1
   tmpd2 = wd(ib, i, j, ivy)
   wd(ib, i, j, ivy) = 0.0_8
   wd(ie, i, j, ivy) = wd(ie, i, j, ivy) + two*tmpd2
   wd(il, i, j, ivy) = wd(il, i, j, ivy) - tmpd2
   tmpd3 = wd(ib, i, j, ivx)
   wd(ib, i, j, ivx) = 0.0_8
   wd(ie, i, j, ivx) = wd(ie, i, j, ivx) + two*tmpd3
   wd(il, i, j, ivx) = wd(il, i, j, ivx) - tmpd3
   CALL POPCONTROL1B(branch)
   IF (branch .NE. 0) THEN
   tmpd0 = wd(ib, i, j, irho)
   wd(ib, i, j, irho) = 0.0_8
   wd(ie, i, j, irho) = wd(ie, i, j, irho) + factor*tmpd0
   END IF
   tmpd = wd(ib, i, j, irho)
   wd(ib, i, j, irho) = 0.0_8
   wd(ie, i, j, irho) = wd(ie, i, j, irho) + two*tmpd
   wd(il, i, j, irho) = wd(il, i, j, irho) - tmpd
   END DO
   END DO
   END IF
   END IF
   ELSE IF (branch .LT. 5) THEN
   IF (branch .EQ. 3) THEN
   DO j=bcdata(nn)%jcend,bcdata(nn)%jcbeg,-1
   DO i=bcdata(nn)%icend,bcdata(nn)%icbeg,-1
   CALL POPCONTROL1B(branch)
   IF (branch .NE. 0) THEN
   revd(i, 1, j) = revd(i, 1, j) + revd(i, 0, j)
   revd(i, 0, j) = 0.0_8
   END IF
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   rlvd(i, 1, j) = rlvd(i, 1, j) + rlvd(i, 0, j)
   rlvd(i, 0, j) = 0.0_8
   END IF
   DO l=nt2mg,nt1mg,-1
   wd(i, 1, j, l) = wd(i, 1, j, l) + wd(i, 0, j, l)
   wd(i, 0, j, l) = 0.0_8
   END DO
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   CALL POPREAL8(p(i, 0, j))
   pd(i, 1, j) = pd(i, 1, j) + two*pd(i, 0, j)
   pd(i, 2, j) = pd(i, 2, j) - pd(i, 0, j)
   pd(i, 0, j) = 0.0_8
   ELSE
   CALL POPREAL8(p(i, 0, j))
   pd(i, 1, j) = pd(i, 1, j) + factor*pd(i, 0, j)
   pd(i, 0, j) = 0.0_8
   END IF
   wd(i, 1, j, ivz) = wd(i, 1, j, ivz) + two*wd(i, 0, j, ivz)
   wd(i, 2, j, ivz) = wd(i, 2, j, ivz) - wd(i, 0, j, ivz)
   wd(i, 0, j, ivz) = 0.0_8
   wd(i, 1, j, ivy) = wd(i, 1, j, ivy) + two*wd(i, 0, j, ivy)
   wd(i, 2, j, ivy) = wd(i, 2, j, ivy) - wd(i, 0, j, ivy)
   wd(i, 0, j, ivy) = 0.0_8
   wd(i, 1, j, ivx) = wd(i, 1, j, ivx) + two*wd(i, 0, j, ivx)
   wd(i, 2, j, ivx) = wd(i, 2, j, ivx) - wd(i, 0, j, ivx)
   wd(i, 0, j, ivx) = 0.0_8
   CALL POPCONTROL1B(branch)
   IF (branch .NE. 0) THEN
   wd(i, 1, j, irho) = wd(i, 1, j, irho) + factor*wd(i, 0, j, &
   &             irho)
   wd(i, 0, j, irho) = 0.0_8
   END IF
   wd(i, 1, j, irho) = wd(i, 1, j, irho) + two*wd(i, 0, j, irho)
   wd(i, 2, j, irho) = wd(i, 2, j, irho) - wd(i, 0, j, irho)
   wd(i, 0, j, irho) = 0.0_8
   END DO
   END DO
   ELSE
   DO j=bcdata(nn)%jcend,bcdata(nn)%jcbeg,-1
   DO i=bcdata(nn)%icend,bcdata(nn)%icbeg,-1
   CALL POPCONTROL1B(branch)
   IF (branch .NE. 0) THEN
   tmpd18 = revd(i, jb, j)
   revd(i, jb, j) = 0.0_8
   revd(i, je, j) = revd(i, je, j) + tmpd18
   END IF
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   tmpd17 = rlvd(i, jb, j)
   rlvd(i, jb, j) = 0.0_8
   rlvd(i, je, j) = rlvd(i, je, j) + tmpd17
   END IF
   DO l=nt2mg,nt1mg,-1
   tmpd16 = wd(i, jb, j, l)
   wd(i, jb, j, l) = 0.0_8
   wd(i, je, j, l) = wd(i, je, j, l) + tmpd16
   END DO
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   CALL POPREAL8(p(i, jb, j))
   tmpd14 = pd(i, jb, j)
   pd(i, jb, j) = 0.0_8
   pd(i, je, j) = pd(i, je, j) + two*tmpd14
   pd(i, jl, j) = pd(i, jl, j) - tmpd14
   ELSE
   CALL POPREAL8(p(i, jb, j))
   tmpd15 = pd(i, jb, j)
   pd(i, jb, j) = 0.0_8
   pd(i, je, j) = pd(i, je, j) + factor*tmpd15
   END IF
   tmpd11 = wd(i, jb, j, ivz)
   wd(i, jb, j, ivz) = 0.0_8
   wd(i, je, j, ivz) = wd(i, je, j, ivz) + two*tmpd11
   wd(i, jl, j, ivz) = wd(i, jl, j, ivz) - tmpd11
   tmpd12 = wd(i, jb, j, ivy)
   wd(i, jb, j, ivy) = 0.0_8
   wd(i, je, j, ivy) = wd(i, je, j, ivy) + two*tmpd12
   wd(i, jl, j, ivy) = wd(i, jl, j, ivy) - tmpd12
   tmpd13 = wd(i, jb, j, ivx)
   wd(i, jb, j, ivx) = 0.0_8
   wd(i, je, j, ivx) = wd(i, je, j, ivx) + two*tmpd13
   wd(i, jl, j, ivx) = wd(i, jl, j, ivx) - tmpd13
   CALL POPCONTROL1B(branch)
   IF (branch .NE. 0) THEN
   tmpd10 = wd(i, jb, j, irho)
   wd(i, jb, j, irho) = 0.0_8
   wd(i, je, j, irho) = wd(i, je, j, irho) + factor*tmpd10
   END IF
   tmpd9 = wd(i, jb, j, irho)
   wd(i, jb, j, irho) = 0.0_8
   wd(i, je, j, irho) = wd(i, je, j, irho) + two*tmpd9
   wd(i, jl, j, irho) = wd(i, jl, j, irho) - tmpd9
   END DO
   END DO
   END IF
   ELSE IF (branch .EQ. 5) THEN
   DO j=bcdata(nn)%jcend,bcdata(nn)%jcbeg,-1
   DO i=bcdata(nn)%icend,bcdata(nn)%icbeg,-1
   CALL POPCONTROL1B(branch)
   IF (branch .NE. 0) THEN
   revd(i, j, 1) = revd(i, j, 1) + revd(i, j, 0)
   revd(i, j, 0) = 0.0_8
   END IF
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   rlvd(i, j, 1) = rlvd(i, j, 1) + rlvd(i, j, 0)
   rlvd(i, j, 0) = 0.0_8
   END IF
   DO l=nt2mg,nt1mg,-1
   wd(i, j, 1, l) = wd(i, j, 1, l) + wd(i, j, 0, l)
   wd(i, j, 0, l) = 0.0_8
   END DO
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   CALL POPREAL8(p(i, j, 0))
   pd(i, j, 1) = pd(i, j, 1) + two*pd(i, j, 0)
   pd(i, j, 2) = pd(i, j, 2) - pd(i, j, 0)
   pd(i, j, 0) = 0.0_8
   ELSE
   CALL POPREAL8(p(i, j, 0))
   pd(i, j, 1) = pd(i, j, 1) + factor*pd(i, j, 0)
   pd(i, j, 0) = 0.0_8
   END IF
   wd(i, j, 1, ivz) = wd(i, j, 1, ivz) + two*wd(i, j, 0, ivz)
   wd(i, j, 2, ivz) = wd(i, j, 2, ivz) - wd(i, j, 0, ivz)
   wd(i, j, 0, ivz) = 0.0_8
   wd(i, j, 1, ivy) = wd(i, j, 1, ivy) + two*wd(i, j, 0, ivy)
   wd(i, j, 2, ivy) = wd(i, j, 2, ivy) - wd(i, j, 0, ivy)
   wd(i, j, 0, ivy) = 0.0_8
   wd(i, j, 1, ivx) = wd(i, j, 1, ivx) + two*wd(i, j, 0, ivx)
   wd(i, j, 2, ivx) = wd(i, j, 2, ivx) - wd(i, j, 0, ivx)
   wd(i, j, 0, ivx) = 0.0_8
   CALL POPCONTROL1B(branch)
   IF (branch .NE. 0) THEN
   wd(i, j, 1, irho) = wd(i, j, 1, irho) + factor*wd(i, j, 0, &
   &           irho)
   wd(i, j, 0, irho) = 0.0_8
   END IF
   wd(i, j, 1, irho) = wd(i, j, 1, irho) + two*wd(i, j, 0, irho)
   wd(i, j, 2, irho) = wd(i, j, 2, irho) - wd(i, j, 0, irho)
   wd(i, j, 0, irho) = 0.0_8
   END DO
   END DO
   ELSE
   DO j=bcdata(nn)%jcend,bcdata(nn)%jcbeg,-1
   DO i=bcdata(nn)%icend,bcdata(nn)%icbeg,-1
   CALL POPCONTROL1B(branch)
   IF (branch .NE. 0) THEN
   tmpd28 = revd(i, j, kb)
   revd(i, j, kb) = 0.0_8
   revd(i, j, ke) = revd(i, j, ke) + tmpd28
   END IF
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   tmpd27 = rlvd(i, j, kb)
   rlvd(i, j, kb) = 0.0_8
   rlvd(i, j, ke) = rlvd(i, j, ke) + tmpd27
   END IF
   DO l=nt2mg,nt1mg,-1
   tmpd26 = wd(i, j, kb, l)
   wd(i, j, kb, l) = 0.0_8
   wd(i, j, ke, l) = wd(i, j, ke, l) + tmpd26
   END DO
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   CALL POPREAL8(p(i, j, kb))
   tmpd24 = pd(i, j, kb)
   pd(i, j, kb) = 0.0_8
   pd(i, j, ke) = pd(i, j, ke) + two*tmpd24
   pd(i, j, kl) = pd(i, j, kl) - tmpd24
   ELSE
   CALL POPREAL8(p(i, j, kb))
   tmpd25 = pd(i, j, kb)
   pd(i, j, kb) = 0.0_8
   pd(i, j, ke) = pd(i, j, ke) + factor*tmpd25
   END IF
   tmpd21 = wd(i, j, kb, ivz)
   wd(i, j, kb, ivz) = 0.0_8
   wd(i, j, ke, ivz) = wd(i, j, ke, ivz) + two*tmpd21
   wd(i, j, kl, ivz) = wd(i, j, kl, ivz) - tmpd21
   tmpd22 = wd(i, j, kb, ivy)
   wd(i, j, kb, ivy) = 0.0_8
   wd(i, j, ke, ivy) = wd(i, j, ke, ivy) + two*tmpd22
   wd(i, j, kl, ivy) = wd(i, j, kl, ivy) - tmpd22
   tmpd23 = wd(i, j, kb, ivx)
   wd(i, j, kb, ivx) = 0.0_8
   wd(i, j, ke, ivx) = wd(i, j, ke, ivx) + two*tmpd23
   wd(i, j, kl, ivx) = wd(i, j, kl, ivx) - tmpd23
   CALL POPCONTROL1B(branch)
   IF (branch .NE. 0) THEN
   tmpd20 = wd(i, j, kb, irho)
   wd(i, j, kb, irho) = 0.0_8
   wd(i, j, ke, irho) = wd(i, j, ke, irho) + factor*tmpd20
   END IF
   tmpd19 = wd(i, j, kb, irho)
   wd(i, j, kb, irho) = 0.0_8
   wd(i, j, ke, irho) = wd(i, j, ke, irho) + two*tmpd19
   wd(i, j, kl, irho) = wd(i, j, kl, irho) - tmpd19
   END DO
   END DO
   END IF
   END SUBROUTINE EXTRAPOLATE2NDHALO_B
