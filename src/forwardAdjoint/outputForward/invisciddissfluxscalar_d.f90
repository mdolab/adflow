   !        Generated by TAPENADE     (INRIA, Tropics team)
   !  Tapenade 3.10 (r5363) -  9 Sep 2014 09:53
   !
   !  Differentiation of invisciddissfluxscalar in forward (tangent) mode (with options i4 dr8 r8):
   !   variations   of useful results: *fw
   !   with respect to varying inputs: gammainf rhoinf pinfcorr *p
   !                *w *radi *radj *radk
   !   Plus diff mem management of: p:in w:in fw:in radi:in radj:in
   !                radk:in
   !
   !      ******************************************************************
   !      *                                                                *
   !      * File:          inviscidDissFluxScalar.f90                      *
   !      * Author:        Edwin van der Weide                             *
   !      * Starting date: 03-24-2003                                      *
   !      * Last modified: 10-29-2007                                      *
   !      *                                                                *
   !      ******************************************************************
   !
   SUBROUTINE INVISCIDDISSFLUXSCALAR_D()
   !
   !      ******************************************************************
   !      *                                                                *
   !      * inviscidDissFluxScalar computes the scalar artificial          *
   !      * dissipation, see AIAA paper 81-1259, for a given block.        *
   !      * Therefore it is assumed that the pointers in  blockPointers    *
   !      * already point to the correct block.                            *
   !      *                                                                *
   !      ******************************************************************
   !
   USE BLOCKPOINTERS
   USE CGNSGRID
   USE CONSTANTS
   USE FLOWVARREFSTATE
   USE INPUTDISCRETIZATION
   USE INPUTPHYSICS
   USE ITERATION
   IMPLICIT NONE
   !
   !      Local parameter.
   !
   REAL(kind=realtype), PARAMETER :: dssmax=0.25_realType
   !
   !      Local variables.
   !
   INTEGER(kind=inttype) :: i, j, k, ind, ii
   REAL(kind=realtype) :: sslim, rhoi
   REAL(kind=realtype) :: sslimd
   REAL(kind=realtype) :: sfil, fis2, fis4
   REAL(kind=realtype) :: ppor, rrad, dis2, dis4
   REAL(kind=realtype) :: rradd, dis2d, dis4d
   REAL(kind=realtype) :: ddw1, ddw2, ddw3, ddw4, ddw5, fs
   REAL(kind=realtype) :: ddw1d, ddw2d, ddw3d, ddw4d, ddw5d, fsd
   REAL(kind=realtype), DIMENSION(ie, je, ke, 3) :: dss
   REAL(kind=realtype), DIMENSION(ie, je, ke, 3) :: dssd
   REAL(kind=realtype), DIMENSION(0:ib, 0:jb, 0:kb) :: ss
   REAL(kind=realtype), DIMENSION(0:ib, 0:jb, 0:kb) :: ssd
   INTRINSIC ABS
   INTRINSIC MAX
   INTRINSIC MIN
   REAL(kind=realtype) :: DIM
   REAL(kind=realtype) :: DIM_D
   REAL(kind=realtype) :: pwr1
   REAL(kind=realtype) :: pwr1d
   REAL(kind=realtype) :: min3
   REAL(kind=realtype) :: min2
   REAL(kind=realtype) :: min1
   REAL(kind=realtype) :: min1d
   REAL(kind=realtype) :: x3
   REAL(kind=realtype) :: x2
   REAL(kind=realtype) :: x2d
   REAL(kind=realtype) :: x1
   REAL(kind=realtype) :: y3d
   REAL(kind=realtype) :: x1d
   REAL(kind=realtype) :: min3d
   REAL(kind=realtype) :: y2d
   REAL(kind=realtype) :: abs0
   REAL(kind=realtype) :: min2d
   REAL(kind=realtype) :: y3
   REAL(kind=realtype) :: y2
   REAL(kind=realtype) :: x3d
   REAL(kind=realtype) :: y1
   REAL(kind=realtype) :: y1d
   IF (rfil .GE. 0.) THEN
   abs0 = rfil
   ELSE
   abs0 = -rfil
   END IF
   !
   !      ******************************************************************
   !      *                                                                *
   !      * Begin execution                                                *
   !      *                                                                *
   !      ******************************************************************
   !
   ! Check if rFil == 0. If so, the dissipative flux needs not to
   ! be computed.
   IF (abs0 .LT. thresholdreal) THEN
   fwd = 0.0_8
   RETURN
   ELSE
   ! Determine the variables used to compute the switch.
   ! For the inviscid case this is the pressure; for the viscous
   ! case it is the entropy.
   SELECT CASE  (equations) 
   CASE (eulerequations) 
   ! Inviscid case. Pressure switch is based on the pressure.
   ! Also set the value of sslim. To be fully consistent this
   ! must have the dimension of pressure and it is therefore
   ! set to a fraction of the free stream value.
   sslimd = 0.001_realType*pinfcorrd
   sslim = 0.001_realType*pinfcorr
   ! Copy the pressure in ss. Only need the entries used in the
   ! discretization, i.e. not including the corner halo's, but we'll
   ! just copy all anyway. 
   ssd = pd
   ss = p
   dssd = 0.0_8
   CASE (nsequations, ransequations) 
   !===============================================================
   ! Viscous case. Pressure switch is based on the entropy.
   ! Also set the value of sslim. To be fully consistent this
   ! must have the dimension of entropy and it is therefore
   ! set to a fraction of the free stream value.
   IF (rhoinf .GT. 0.0_8) THEN
   pwr1d = rhoinf**gammainf*(LOG(rhoinf)*gammainfd+gammainf*rhoinfd&
   &         /rhoinf)
   ELSE IF (rhoinf .EQ. 0.0_8) THEN
   IF (gammainf .EQ. 1.0) THEN
   pwr1d = rhoinfd
   ELSE
   pwr1d = 0.0_8
   END IF
   ELSE IF (gammainf .EQ. INT(gammainf)) THEN
   pwr1d = gammainf*rhoinf**(gammainf-1)*rhoinfd
   ELSE
   pwr1d = 0.0_8
   END IF
   pwr1 = rhoinf**gammainf
   sslimd = (0.001_realType*pinfcorrd*pwr1-0.001_realType*pinfcorr*&
   &       pwr1d)/pwr1**2
   sslim = 0.001_realType*pinfcorr/pwr1
   ssd = 0.0_8
   ! Store the entropy in ss. See above. 
   DO k=0,kb
   DO j=0,jb
   DO i=0,ib
   IF (w(i, j, k, irho) .GT. 0.0_8 .OR. (w(i, j, k, irho) .LT. &
   &               0.0_8 .AND. gamma(i, j, k) .EQ. INT(gamma(i, j, k)))) &
   &           THEN
   pwr1d = gamma(i, j, k)*w(i, j, k, irho)**(gamma(i, j, k)-1&
   &               )*wd(i, j, k, irho)
   ELSE IF (w(i, j, k, irho) .EQ. 0.0_8 .AND. gamma(i, j, k) &
   &               .EQ. 1.0) THEN
   pwr1d = wd(i, j, k, irho)
   ELSE
   pwr1d = 0.0_8
   END IF
   pwr1 = w(i, j, k, irho)**gamma(i, j, k)
   ssd(i, j, k) = (pd(i, j, k)*pwr1-p(i, j, k)*pwr1d)/pwr1**2
   ss(i, j, k) = p(i, j, k)/pwr1
   END DO
   END DO
   END DO
   dssd = 0.0_8
   CASE DEFAULT
   sslimd = 0.0_8
   ssd = 0.0_8
   dssd = 0.0_8
   END SELECT
   ! Compute the pressure sensor for each cell, in each direction:
   DO k=1,ke
   DO j=1,je
   DO i=1,ie
   x1d = ((ssd(i+1, j, k)-two*ssd(i, j, k)+ssd(i-1, j, k))*(ss(i+&
   &           1, j, k)+two*ss(i, j, k)+ss(i-1, j, k)+sslim)-(ss(i+1, j, k)&
   &           -two*ss(i, j, k)+ss(i-1, j, k))*(ssd(i+1, j, k)+two*ssd(i, j&
   &           , k)+ssd(i-1, j, k)+sslimd))/(ss(i+1, j, k)+two*ss(i, j, k)+&
   &           ss(i-1, j, k)+sslim)**2
   x1 = (ss(i+1, j, k)-two*ss(i, j, k)+ss(i-1, j, k))/(ss(i+1, j&
   &           , k)+two*ss(i, j, k)+ss(i-1, j, k)+sslim)
   IF (x1 .GE. 0.) THEN
   dssd(i, j, k, 1) = x1d
   dss(i, j, k, 1) = x1
   ELSE
   dssd(i, j, k, 1) = -x1d
   dss(i, j, k, 1) = -x1
   END IF
   x2d = ((ssd(i, j+1, k)-two*ssd(i, j, k)+ssd(i, j-1, k))*(ss(i&
   &           , j+1, k)+two*ss(i, j, k)+ss(i, j-1, k)+sslim)-(ss(i, j+1, k&
   &           )-two*ss(i, j, k)+ss(i, j-1, k))*(ssd(i, j+1, k)+two*ssd(i, &
   &           j, k)+ssd(i, j-1, k)+sslimd))/(ss(i, j+1, k)+two*ss(i, j, k)&
   &           +ss(i, j-1, k)+sslim)**2
   x2 = (ss(i, j+1, k)-two*ss(i, j, k)+ss(i, j-1, k))/(ss(i, j+1&
   &           , k)+two*ss(i, j, k)+ss(i, j-1, k)+sslim)
   IF (x2 .GE. 0.) THEN
   dssd(i, j, k, 2) = x2d
   dss(i, j, k, 2) = x2
   ELSE
   dssd(i, j, k, 2) = -x2d
   dss(i, j, k, 2) = -x2
   END IF
   x3d = ((ssd(i, j, k+1)-two*ssd(i, j, k)+ssd(i, j, k-1))*(ss(i&
   &           , j, k+1)+two*ss(i, j, k)+ss(i, j, k-1)+sslim)-(ss(i, j, k+1&
   &           )-two*ss(i, j, k)+ss(i, j, k-1))*(ssd(i, j, k+1)+two*ssd(i, &
   &           j, k)+ssd(i, j, k-1)+sslimd))/(ss(i, j, k+1)+two*ss(i, j, k)&
   &           +ss(i, j, k-1)+sslim)**2
   x3 = (ss(i, j, k+1)-two*ss(i, j, k)+ss(i, j, k-1))/(ss(i, j, k&
   &           +1)+two*ss(i, j, k)+ss(i, j, k-1)+sslim)
   IF (x3 .GE. 0.) THEN
   dssd(i, j, k, 3) = x3d
   dss(i, j, k, 3) = x3
   ELSE
   dssd(i, j, k, 3) = -x3d
   dss(i, j, k, 3) = -x3
   END IF
   END DO
   END DO
   END DO
   ! Set a couple of constants for the scheme.
   fis2 = rfil*vis2
   fis4 = rfil*vis4
   sfil = one - rfil
   ! Initialize the dissipative residual to a certain times,
   ! possibly zero, the previously stored value. Owned cells
   ! only, because the halo values do not matter.
   fwd = 0.0_8
   fw = sfil*fw
   fwd = 0.0_8
   !
   !      ******************************************************************
   !      *                                                                *
   !      * Dissipative fluxes in the i-direction.                         *
   !      *                                                                *
   !      ******************************************************************
   !
   DO k=2,kl
   DO j=2,jl
   DO i=1,il
   ! Compute the dissipation coefficients for this face.
   ppor = zero
   IF (pori(i, j, k) .EQ. normalflux) ppor = half
   rradd = ppor*(radid(i, j, k)+radid(i+1, j, k))
   rrad = ppor*(radi(i, j, k)+radi(i+1, j, k))
   IF (dss(i, j, k, 1) .LT. dss(i+1, j, k, 1)) THEN
   y1d = dssd(i+1, j, k, 1)
   y1 = dss(i+1, j, k, 1)
   ELSE
   y1d = dssd(i, j, k, 1)
   y1 = dss(i, j, k, 1)
   END IF
   IF (dssmax .GT. y1) THEN
   min1d = y1d
   min1 = y1
   ELSE
   min1 = dssmax
   min1d = 0.0_8
   END IF
   dis2d = fis2*(rradd*min1+rrad*min1d)
   dis2 = fis2*rrad*min1
   dis4d = DIM_D(fis4*rrad, fis4*rradd, dis2, dis2d, dis4)
   ! Compute and scatter the dissipative flux.
   ! Density. Store it in the mass flow of the
   ! appropriate sliding mesh interface.
   ddw1d = wd(i+1, j, k, irho) - wd(i, j, k, irho)
   ddw1 = w(i+1, j, k, irho) - w(i, j, k, irho)
   fsd = dis2d*ddw1 + dis2*ddw1d - dis4d*(w(i+2, j, k, irho)-w(i-&
   &           1, j, k, irho)-three*ddw1) - dis4*(wd(i+2, j, k, irho)-wd(i-&
   &           1, j, k, irho)-three*ddw1d)
   fs = dis2*ddw1 - dis4*(w(i+2, j, k, irho)-w(i-1, j, k, irho)-&
   &           three*ddw1)
   fwd(i+1, j, k, irho) = fwd(i+1, j, k, irho) + fsd
   fw(i+1, j, k, irho) = fw(i+1, j, k, irho) + fs
   fwd(i, j, k, irho) = fwd(i, j, k, irho) - fsd
   fw(i, j, k, irho) = fw(i, j, k, irho) - fs
   ! X-momentum.
   ddw2d = wd(i+1, j, k, ivx)*w(i+1, j, k, irho) + w(i+1, j, k, &
   &           ivx)*wd(i+1, j, k, irho) - wd(i, j, k, ivx)*w(i, j, k, irho)&
   &           - w(i, j, k, ivx)*wd(i, j, k, irho)
   ddw2 = w(i+1, j, k, ivx)*w(i+1, j, k, irho) - w(i, j, k, ivx)*&
   &           w(i, j, k, irho)
   fsd = dis2d*ddw2 + dis2*ddw2d - dis4d*(w(i+2, j, k, ivx)*w(i+2&
   &           , j, k, irho)-w(i-1, j, k, ivx)*w(i-1, j, k, irho)-three*&
   &           ddw2) - dis4*(wd(i+2, j, k, ivx)*w(i+2, j, k, irho)+w(i+2, j&
   &           , k, ivx)*wd(i+2, j, k, irho)-wd(i-1, j, k, ivx)*w(i-1, j, k&
   &           , irho)-w(i-1, j, k, ivx)*wd(i-1, j, k, irho)-three*ddw2d)
   fs = dis2*ddw2 - dis4*(w(i+2, j, k, ivx)*w(i+2, j, k, irho)-w(&
   &           i-1, j, k, ivx)*w(i-1, j, k, irho)-three*ddw2)
   fwd(i+1, j, k, imx) = fwd(i+1, j, k, imx) + fsd
   fw(i+1, j, k, imx) = fw(i+1, j, k, imx) + fs
   fwd(i, j, k, imx) = fwd(i, j, k, imx) - fsd
   fw(i, j, k, imx) = fw(i, j, k, imx) - fs
   ! Y-momentum.
   ddw3d = wd(i+1, j, k, ivy)*w(i+1, j, k, irho) + w(i+1, j, k, &
   &           ivy)*wd(i+1, j, k, irho) - wd(i, j, k, ivy)*w(i, j, k, irho)&
   &           - w(i, j, k, ivy)*wd(i, j, k, irho)
   ddw3 = w(i+1, j, k, ivy)*w(i+1, j, k, irho) - w(i, j, k, ivy)*&
   &           w(i, j, k, irho)
   fsd = dis2d*ddw3 + dis2*ddw3d - dis4d*(w(i+2, j, k, ivy)*w(i+2&
   &           , j, k, irho)-w(i-1, j, k, ivy)*w(i-1, j, k, irho)-three*&
   &           ddw3) - dis4*(wd(i+2, j, k, ivy)*w(i+2, j, k, irho)+w(i+2, j&
   &           , k, ivy)*wd(i+2, j, k, irho)-wd(i-1, j, k, ivy)*w(i-1, j, k&
   &           , irho)-w(i-1, j, k, ivy)*wd(i-1, j, k, irho)-three*ddw3d)
   fs = dis2*ddw3 - dis4*(w(i+2, j, k, ivy)*w(i+2, j, k, irho)-w(&
   &           i-1, j, k, ivy)*w(i-1, j, k, irho)-three*ddw3)
   fwd(i+1, j, k, imy) = fwd(i+1, j, k, imy) + fsd
   fw(i+1, j, k, imy) = fw(i+1, j, k, imy) + fs
   fwd(i, j, k, imy) = fwd(i, j, k, imy) - fsd
   fw(i, j, k, imy) = fw(i, j, k, imy) - fs
   ! Z-momentum.
   ddw4d = wd(i+1, j, k, ivz)*w(i+1, j, k, irho) + w(i+1, j, k, &
   &           ivz)*wd(i+1, j, k, irho) - wd(i, j, k, ivz)*w(i, j, k, irho)&
   &           - w(i, j, k, ivz)*wd(i, j, k, irho)
   ddw4 = w(i+1, j, k, ivz)*w(i+1, j, k, irho) - w(i, j, k, ivz)*&
   &           w(i, j, k, irho)
   fsd = dis2d*ddw4 + dis2*ddw4d - dis4d*(w(i+2, j, k, ivz)*w(i+2&
   &           , j, k, irho)-w(i-1, j, k, ivz)*w(i-1, j, k, irho)-three*&
   &           ddw4) - dis4*(wd(i+2, j, k, ivz)*w(i+2, j, k, irho)+w(i+2, j&
   &           , k, ivz)*wd(i+2, j, k, irho)-wd(i-1, j, k, ivz)*w(i-1, j, k&
   &           , irho)-w(i-1, j, k, ivz)*wd(i-1, j, k, irho)-three*ddw4d)
   fs = dis2*ddw4 - dis4*(w(i+2, j, k, ivz)*w(i+2, j, k, irho)-w(&
   &           i-1, j, k, ivz)*w(i-1, j, k, irho)-three*ddw4)
   fwd(i+1, j, k, imz) = fwd(i+1, j, k, imz) + fsd
   fw(i+1, j, k, imz) = fw(i+1, j, k, imz) + fs
   fwd(i, j, k, imz) = fwd(i, j, k, imz) - fsd
   fw(i, j, k, imz) = fw(i, j, k, imz) - fs
   ! Energy.
   ddw5d = wd(i+1, j, k, irhoe) + pd(i+1, j, k) - wd(i, j, k, &
   &           irhoe) - pd(i, j, k)
   ddw5 = w(i+1, j, k, irhoe) + p(i+1, j, k) - (w(i, j, k, irhoe)&
   &           +p(i, j, k))
   fsd = dis2d*ddw5 + dis2*ddw5d - dis4d*(w(i+2, j, k, irhoe)+p(i&
   &           +2, j, k)-(w(i-1, j, k, irhoe)+p(i-1, j, k))-three*ddw5) - &
   &           dis4*(wd(i+2, j, k, irhoe)+pd(i+2, j, k)-wd(i-1, j, k, irhoe&
   &           )-pd(i-1, j, k)-three*ddw5d)
   fs = dis2*ddw5 - dis4*(w(i+2, j, k, irhoe)+p(i+2, j, k)-(w(i-1&
   &           , j, k, irhoe)+p(i-1, j, k))-three*ddw5)
   fwd(i+1, j, k, irhoe) = fwd(i+1, j, k, irhoe) + fsd
   fw(i+1, j, k, irhoe) = fw(i+1, j, k, irhoe) + fs
   fwd(i, j, k, irhoe) = fwd(i, j, k, irhoe) - fsd
   fw(i, j, k, irhoe) = fw(i, j, k, irhoe) - fs
   END DO
   END DO
   END DO
   !
   !      ******************************************************************
   !      *                                                                *
   !      * Dissipative fluxes in the j-direction.                         *
   !      *                                                                *
   !      ******************************************************************
   !
   DO k=2,kl
   DO j=1,jl
   DO i=2,il
   ! Compute the dissipation coefficients for this face.
   ppor = zero
   IF (porj(i, j, k) .EQ. normalflux) ppor = half
   rradd = ppor*(radjd(i, j, k)+radjd(i, j+1, k))
   rrad = ppor*(radj(i, j, k)+radj(i, j+1, k))
   IF (dss(i, j, k, 2) .LT. dss(i, j+1, k, 2)) THEN
   y2d = dssd(i, j+1, k, 2)
   y2 = dss(i, j+1, k, 2)
   ELSE
   y2d = dssd(i, j, k, 2)
   y2 = dss(i, j, k, 2)
   END IF
   IF (dssmax .GT. y2) THEN
   min2d = y2d
   min2 = y2
   ELSE
   min2 = dssmax
   min2d = 0.0_8
   END IF
   dis2d = fis2*(rradd*min2+rrad*min2d)
   dis2 = fis2*rrad*min2
   dis4d = DIM_D(fis4*rrad, fis4*rradd, dis2, dis2d, dis4)
   ! Compute and scatter the dissipative flux.
   ! Density. Store it in the mass flow of the
   ! appropriate sliding mesh interface.
   ddw1d = wd(i, j+1, k, irho) - wd(i, j, k, irho)
   ddw1 = w(i, j+1, k, irho) - w(i, j, k, irho)
   fsd = dis2d*ddw1 + dis2*ddw1d - dis4d*(w(i, j+2, k, irho)-w(i&
   &           , j-1, k, irho)-three*ddw1) - dis4*(wd(i, j+2, k, irho)-wd(i&
   &           , j-1, k, irho)-three*ddw1d)
   fs = dis2*ddw1 - dis4*(w(i, j+2, k, irho)-w(i, j-1, k, irho)-&
   &           three*ddw1)
   fwd(i, j+1, k, irho) = fwd(i, j+1, k, irho) + fsd
   fw(i, j+1, k, irho) = fw(i, j+1, k, irho) + fs
   fwd(i, j, k, irho) = fwd(i, j, k, irho) - fsd
   fw(i, j, k, irho) = fw(i, j, k, irho) - fs
   ! X-momentum.
   ddw2d = wd(i, j+1, k, ivx)*w(i, j+1, k, irho) + w(i, j+1, k, &
   &           ivx)*wd(i, j+1, k, irho) - wd(i, j, k, ivx)*w(i, j, k, irho)&
   &           - w(i, j, k, ivx)*wd(i, j, k, irho)
   ddw2 = w(i, j+1, k, ivx)*w(i, j+1, k, irho) - w(i, j, k, ivx)*&
   &           w(i, j, k, irho)
   fsd = dis2d*ddw2 + dis2*ddw2d - dis4d*(w(i, j+2, k, ivx)*w(i, &
   &           j+2, k, irho)-w(i, j-1, k, ivx)*w(i, j-1, k, irho)-three*&
   &           ddw2) - dis4*(wd(i, j+2, k, ivx)*w(i, j+2, k, irho)+w(i, j+2&
   &           , k, ivx)*wd(i, j+2, k, irho)-wd(i, j-1, k, ivx)*w(i, j-1, k&
   &           , irho)-w(i, j-1, k, ivx)*wd(i, j-1, k, irho)-three*ddw2d)
   fs = dis2*ddw2 - dis4*(w(i, j+2, k, ivx)*w(i, j+2, k, irho)-w(&
   &           i, j-1, k, ivx)*w(i, j-1, k, irho)-three*ddw2)
   fwd(i, j+1, k, imx) = fwd(i, j+1, k, imx) + fsd
   fw(i, j+1, k, imx) = fw(i, j+1, k, imx) + fs
   fwd(i, j, k, imx) = fwd(i, j, k, imx) - fsd
   fw(i, j, k, imx) = fw(i, j, k, imx) - fs
   ! Y-momentum.
   ddw3d = wd(i, j+1, k, ivy)*w(i, j+1, k, irho) + w(i, j+1, k, &
   &           ivy)*wd(i, j+1, k, irho) - wd(i, j, k, ivy)*w(i, j, k, irho)&
   &           - w(i, j, k, ivy)*wd(i, j, k, irho)
   ddw3 = w(i, j+1, k, ivy)*w(i, j+1, k, irho) - w(i, j, k, ivy)*&
   &           w(i, j, k, irho)
   fsd = dis2d*ddw3 + dis2*ddw3d - dis4d*(w(i, j+2, k, ivy)*w(i, &
   &           j+2, k, irho)-w(i, j-1, k, ivy)*w(i, j-1, k, irho)-three*&
   &           ddw3) - dis4*(wd(i, j+2, k, ivy)*w(i, j+2, k, irho)+w(i, j+2&
   &           , k, ivy)*wd(i, j+2, k, irho)-wd(i, j-1, k, ivy)*w(i, j-1, k&
   &           , irho)-w(i, j-1, k, ivy)*wd(i, j-1, k, irho)-three*ddw3d)
   fs = dis2*ddw3 - dis4*(w(i, j+2, k, ivy)*w(i, j+2, k, irho)-w(&
   &           i, j-1, k, ivy)*w(i, j-1, k, irho)-three*ddw3)
   fwd(i, j+1, k, imy) = fwd(i, j+1, k, imy) + fsd
   fw(i, j+1, k, imy) = fw(i, j+1, k, imy) + fs
   fwd(i, j, k, imy) = fwd(i, j, k, imy) - fsd
   fw(i, j, k, imy) = fw(i, j, k, imy) - fs
   ! Z-momentum.
   ddw4d = wd(i, j+1, k, ivz)*w(i, j+1, k, irho) + w(i, j+1, k, &
   &           ivz)*wd(i, j+1, k, irho) - wd(i, j, k, ivz)*w(i, j, k, irho)&
   &           - w(i, j, k, ivz)*wd(i, j, k, irho)
   ddw4 = w(i, j+1, k, ivz)*w(i, j+1, k, irho) - w(i, j, k, ivz)*&
   &           w(i, j, k, irho)
   fsd = dis2d*ddw4 + dis2*ddw4d - dis4d*(w(i, j+2, k, ivz)*w(i, &
   &           j+2, k, irho)-w(i, j-1, k, ivz)*w(i, j-1, k, irho)-three*&
   &           ddw4) - dis4*(wd(i, j+2, k, ivz)*w(i, j+2, k, irho)+w(i, j+2&
   &           , k, ivz)*wd(i, j+2, k, irho)-wd(i, j-1, k, ivz)*w(i, j-1, k&
   &           , irho)-w(i, j-1, k, ivz)*wd(i, j-1, k, irho)-three*ddw4d)
   fs = dis2*ddw4 - dis4*(w(i, j+2, k, ivz)*w(i, j+2, k, irho)-w(&
   &           i, j-1, k, ivz)*w(i, j-1, k, irho)-three*ddw4)
   fwd(i, j+1, k, imz) = fwd(i, j+1, k, imz) + fsd
   fw(i, j+1, k, imz) = fw(i, j+1, k, imz) + fs
   fwd(i, j, k, imz) = fwd(i, j, k, imz) - fsd
   fw(i, j, k, imz) = fw(i, j, k, imz) - fs
   ! Energy.
   ddw5d = wd(i, j+1, k, irhoe) + pd(i, j+1, k) - wd(i, j, k, &
   &           irhoe) - pd(i, j, k)
   ddw5 = w(i, j+1, k, irhoe) + p(i, j+1, k) - (w(i, j, k, irhoe)&
   &           +p(i, j, k))
   fsd = dis2d*ddw5 + dis2*ddw5d - dis4d*(w(i, j+2, k, irhoe)+p(i&
   &           , j+2, k)-(w(i, j-1, k, irhoe)+p(i, j-1, k))-three*ddw5) - &
   &           dis4*(wd(i, j+2, k, irhoe)+pd(i, j+2, k)-wd(i, j-1, k, irhoe&
   &           )-pd(i, j-1, k)-three*ddw5d)
   fs = dis2*ddw5 - dis4*(w(i, j+2, k, irhoe)+p(i, j+2, k)-(w(i, &
   &           j-1, k, irhoe)+p(i, j-1, k))-three*ddw5)
   fwd(i, j+1, k, irhoe) = fwd(i, j+1, k, irhoe) + fsd
   fw(i, j+1, k, irhoe) = fw(i, j+1, k, irhoe) + fs
   fwd(i, j, k, irhoe) = fwd(i, j, k, irhoe) - fsd
   fw(i, j, k, irhoe) = fw(i, j, k, irhoe) - fs
   END DO
   END DO
   END DO
   !
   !      ******************************************************************
   !      *                                                                *
   !      * Dissipative fluxes in the k-direction.                         *
   !      *                                                                *
   !      ******************************************************************
   !
   DO k=1,kl
   DO j=2,jl
   DO i=2,il
   ! Compute the dissipation coefficients for this face.
   ppor = zero
   IF (pork(i, j, k) .EQ. normalflux) ppor = half
   rradd = ppor*(radkd(i, j, k)+radkd(i, j, k+1))
   rrad = ppor*(radk(i, j, k)+radk(i, j, k+1))
   IF (dss(i, j, k, 3) .LT. dss(i, j, k+1, 3)) THEN
   y3d = dssd(i, j, k+1, 3)
   y3 = dss(i, j, k+1, 3)
   ELSE
   y3d = dssd(i, j, k, 3)
   y3 = dss(i, j, k, 3)
   END IF
   IF (dssmax .GT. y3) THEN
   min3d = y3d
   min3 = y3
   ELSE
   min3 = dssmax
   min3d = 0.0_8
   END IF
   dis2d = fis2*(rradd*min3+rrad*min3d)
   dis2 = fis2*rrad*min3
   dis4d = DIM_D(fis4*rrad, fis4*rradd, dis2, dis2d, dis4)
   ! Compute and scatter the dissipative flux.
   ! Density. Store it in the mass flow of the
   ! appropriate sliding mesh interface.
   ddw1d = wd(i, j, k+1, irho) - wd(i, j, k, irho)
   ddw1 = w(i, j, k+1, irho) - w(i, j, k, irho)
   fsd = dis2d*ddw1 + dis2*ddw1d - dis4d*(w(i, j, k+2, irho)-w(i&
   &           , j, k-1, irho)-three*ddw1) - dis4*(wd(i, j, k+2, irho)-wd(i&
   &           , j, k-1, irho)-three*ddw1d)
   fs = dis2*ddw1 - dis4*(w(i, j, k+2, irho)-w(i, j, k-1, irho)-&
   &           three*ddw1)
   fwd(i, j, k+1, irho) = fwd(i, j, k+1, irho) + fsd
   fw(i, j, k+1, irho) = fw(i, j, k+1, irho) + fs
   fwd(i, j, k, irho) = fwd(i, j, k, irho) - fsd
   fw(i, j, k, irho) = fw(i, j, k, irho) - fs
   ! X-momentum.
   ddw2d = wd(i, j, k+1, ivx)*w(i, j, k+1, irho) + w(i, j, k+1, &
   &           ivx)*wd(i, j, k+1, irho) - wd(i, j, k, ivx)*w(i, j, k, irho)&
   &           - w(i, j, k, ivx)*wd(i, j, k, irho)
   ddw2 = w(i, j, k+1, ivx)*w(i, j, k+1, irho) - w(i, j, k, ivx)*&
   &           w(i, j, k, irho)
   fsd = dis2d*ddw2 + dis2*ddw2d - dis4d*(w(i, j, k+2, ivx)*w(i, &
   &           j, k+2, irho)-w(i, j, k-1, ivx)*w(i, j, k-1, irho)-three*&
   &           ddw2) - dis4*(wd(i, j, k+2, ivx)*w(i, j, k+2, irho)+w(i, j, &
   &           k+2, ivx)*wd(i, j, k+2, irho)-wd(i, j, k-1, ivx)*w(i, j, k-1&
   &           , irho)-w(i, j, k-1, ivx)*wd(i, j, k-1, irho)-three*ddw2d)
   fs = dis2*ddw2 - dis4*(w(i, j, k+2, ivx)*w(i, j, k+2, irho)-w(&
   &           i, j, k-1, ivx)*w(i, j, k-1, irho)-three*ddw2)
   fwd(i, j, k+1, imx) = fwd(i, j, k+1, imx) + fsd
   fw(i, j, k+1, imx) = fw(i, j, k+1, imx) + fs
   fwd(i, j, k, imx) = fwd(i, j, k, imx) - fsd
   fw(i, j, k, imx) = fw(i, j, k, imx) - fs
   ! Y-momentum.
   ddw3d = wd(i, j, k+1, ivy)*w(i, j, k+1, irho) + w(i, j, k+1, &
   &           ivy)*wd(i, j, k+1, irho) - wd(i, j, k, ivy)*w(i, j, k, irho)&
   &           - w(i, j, k, ivy)*wd(i, j, k, irho)
   ddw3 = w(i, j, k+1, ivy)*w(i, j, k+1, irho) - w(i, j, k, ivy)*&
   &           w(i, j, k, irho)
   fsd = dis2d*ddw3 + dis2*ddw3d - dis4d*(w(i, j, k+2, ivy)*w(i, &
   &           j, k+2, irho)-w(i, j, k-1, ivy)*w(i, j, k-1, irho)-three*&
   &           ddw3) - dis4*(wd(i, j, k+2, ivy)*w(i, j, k+2, irho)+w(i, j, &
   &           k+2, ivy)*wd(i, j, k+2, irho)-wd(i, j, k-1, ivy)*w(i, j, k-1&
   &           , irho)-w(i, j, k-1, ivy)*wd(i, j, k-1, irho)-three*ddw3d)
   fs = dis2*ddw3 - dis4*(w(i, j, k+2, ivy)*w(i, j, k+2, irho)-w(&
   &           i, j, k-1, ivy)*w(i, j, k-1, irho)-three*ddw3)
   fwd(i, j, k+1, imy) = fwd(i, j, k+1, imy) + fsd
   fw(i, j, k+1, imy) = fw(i, j, k+1, imy) + fs
   fwd(i, j, k, imy) = fwd(i, j, k, imy) - fsd
   fw(i, j, k, imy) = fw(i, j, k, imy) - fs
   ! Z-momentum.
   ddw4d = wd(i, j, k+1, ivz)*w(i, j, k+1, irho) + w(i, j, k+1, &
   &           ivz)*wd(i, j, k+1, irho) - wd(i, j, k, ivz)*w(i, j, k, irho)&
   &           - w(i, j, k, ivz)*wd(i, j, k, irho)
   ddw4 = w(i, j, k+1, ivz)*w(i, j, k+1, irho) - w(i, j, k, ivz)*&
   &           w(i, j, k, irho)
   fsd = dis2d*ddw4 + dis2*ddw4d - dis4d*(w(i, j, k+2, ivz)*w(i, &
   &           j, k+2, irho)-w(i, j, k-1, ivz)*w(i, j, k-1, irho)-three*&
   &           ddw4) - dis4*(wd(i, j, k+2, ivz)*w(i, j, k+2, irho)+w(i, j, &
   &           k+2, ivz)*wd(i, j, k+2, irho)-wd(i, j, k-1, ivz)*w(i, j, k-1&
   &           , irho)-w(i, j, k-1, ivz)*wd(i, j, k-1, irho)-three*ddw4d)
   fs = dis2*ddw4 - dis4*(w(i, j, k+2, ivz)*w(i, j, k+2, irho)-w(&
   &           i, j, k-1, ivz)*w(i, j, k-1, irho)-three*ddw4)
   fwd(i, j, k+1, imz) = fwd(i, j, k+1, imz) + fsd
   fw(i, j, k+1, imz) = fw(i, j, k+1, imz) + fs
   fwd(i, j, k, imz) = fwd(i, j, k, imz) - fsd
   fw(i, j, k, imz) = fw(i, j, k, imz) - fs
   ! Energy.
   ddw5d = wd(i, j, k+1, irhoe) + pd(i, j, k+1) - wd(i, j, k, &
   &           irhoe) - pd(i, j, k)
   ddw5 = w(i, j, k+1, irhoe) + p(i, j, k+1) - (w(i, j, k, irhoe)&
   &           +p(i, j, k))
   fsd = dis2d*ddw5 + dis2*ddw5d - dis4d*(w(i, j, k+2, irhoe)+p(i&
   &           , j, k+2)-(w(i, j, k-1, irhoe)+p(i, j, k-1))-three*ddw5) - &
   &           dis4*(wd(i, j, k+2, irhoe)+pd(i, j, k+2)-wd(i, j, k-1, irhoe&
   &           )-pd(i, j, k-1)-three*ddw5d)
   fs = dis2*ddw5 - dis4*(w(i, j, k+2, irhoe)+p(i, j, k+2)-(w(i, &
   &           j, k-1, irhoe)+p(i, j, k-1))-three*ddw5)
   fwd(i, j, k+1, irhoe) = fwd(i, j, k+1, irhoe) + fsd
   fw(i, j, k+1, irhoe) = fw(i, j, k+1, irhoe) + fs
   fwd(i, j, k, irhoe) = fwd(i, j, k, irhoe) - fsd
   fw(i, j, k, irhoe) = fw(i, j, k, irhoe) - fs
   END DO
   END DO
   END DO
   END IF
   END SUBROUTINE INVISCIDDISSFLUXSCALAR_D
