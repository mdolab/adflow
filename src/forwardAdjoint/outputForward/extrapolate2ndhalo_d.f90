   !        Generated by TAPENADE     (INRIA, Tropics team)
   !  Tapenade 3.10 (r5363) -  9 Sep 2014 09:53
   !
   !  Differentiation of extrapolate2ndhalo in forward (tangent) mode (with options i4 dr8 r8):
   !   variations   of useful results: *rev *p *gamma *w *rlv
   !   with respect to varying inputs: *rev *p *gamma *w *rlv tref
   !                rgas
   !   Plus diff mem management of: rev:in p:in gamma:in w:in rlv:in
   !                bcdata:in
   !
   !      ******************************************************************
   !      *                                                                *
   !      * File:          extrapolate2ndHalo.f90                          *
   !      * Author:        Edwin van der Weide                             *
   !      * Starting date: 03-10-2003                                      *
   !      * Last modified: 06-12-2005                                      *
   !      *                                                                *
   !      ******************************************************************
   !
   SUBROUTINE EXTRAPOLATE2NDHALO_D(nn, correctfork)
   !
   !      ******************************************************************
   !      *                                                                *
   !      * extrapolate2ndHalo determines the states of the second layer   *
   !      * halo cells for the given subface of the block. It is assumed   *
   !      * that the pointers in blockPointers are already set to the      *
   !      * correct block on the correct grid level.                       *
   !      *                                                                *
   !      ******************************************************************
   !
   USE BCTYPES
   USE BLOCKPOINTERS_D
   USE CONSTANTS
   USE FLOWVARREFSTATE
   USE ITERATION
   USE INPUTPHYSICS
   IMPLICIT NONE
   !
   !      Subroutine arguments.
   !
   INTEGER(kind=inttype), INTENT(IN) :: nn
   LOGICAL, INTENT(IN) :: correctfork
   !
   !      Local parameter.
   !
   REAL(kind=realtype), PARAMETER :: factor=0.5_realType
   !
   !      Local variables.
   !
   INTEGER(kind=inttype) :: i, j, l, idim, ddim
   INTEGER(kind=inttype), DIMENSION(3, 2) :: crange
   INTRINSIC MAX
   SELECT CASE  (bcfaceid(nn)) 
   CASE (imin) 
   DO j=bcdata(nn)%jcbeg,bcdata(nn)%jcend
   DO i=bcdata(nn)%icbeg,bcdata(nn)%icend
   ! Extrapolate the density, momentum and pressure.
   ! Make sure that a certain threshold is kept.
   wd(0, i, j, irho) = two*wd(1, i, j, irho) - wd(2, i, j, irho)
   w(0, i, j, irho) = two*w(1, i, j, irho) - w(2, i, j, irho)
   IF (factor*w(1, i, j, irho) .LT. w(0, i, j, irho)) THEN
   w(0, i, j, irho) = w(0, i, j, irho)
   ELSE
   wd(0, i, j, irho) = factor*wd(1, i, j, irho)
   w(0, i, j, irho) = factor*w(1, i, j, irho)
   END IF
   wd(0, i, j, ivx) = two*wd(1, i, j, ivx) - wd(2, i, j, ivx)
   w(0, i, j, ivx) = two*w(1, i, j, ivx) - w(2, i, j, ivx)
   wd(0, i, j, ivy) = two*wd(1, i, j, ivy) - wd(2, i, j, ivy)
   w(0, i, j, ivy) = two*w(1, i, j, ivy) - w(2, i, j, ivy)
   wd(0, i, j, ivz) = two*wd(1, i, j, ivz) - wd(2, i, j, ivz)
   w(0, i, j, ivz) = two*w(1, i, j, ivz) - w(2, i, j, ivz)
   IF (factor*p(1, i, j) .LT. two*p(1, i, j) - p(2, i, j)) THEN
   pd(0, i, j) = two*pd(1, i, j) - pd(2, i, j)
   p(0, i, j) = two*p(1, i, j) - p(2, i, j)
   ELSE
   pd(0, i, j) = factor*pd(1, i, j)
   p(0, i, j) = factor*p(1, i, j)
   END IF
   ! Extrapolate the turbulent variables. Use constant
   ! extrapolation.
   DO l=nt1mg,nt2mg
   wd(0, i, j, l) = wd(1, i, j, l)
   w(0, i, j, l) = w(1, i, j, l)
   END DO
   ! The laminar and eddy viscosity, if present. These values
   ! are simply taken constant. Their values do not matter.
   IF (viscous) THEN
   rlvd(0, i, j) = rlvd(1, i, j)
   rlv(0, i, j) = rlv(1, i, j)
   END IF
   IF (eddymodel) THEN
   revd(0, i, j) = revd(1, i, j)
   rev(0, i, j) = rev(1, i, j)
   END IF
   END DO
   END DO
   idim = 1
   ddim = 0
   CASE (imax) 
   DO j=bcdata(nn)%jcbeg,bcdata(nn)%jcend
   DO i=bcdata(nn)%icbeg,bcdata(nn)%icend
   wd(ib, i, j, irho) = two*wd(ie, i, j, irho) - wd(il, i, j, irho)
   w(ib, i, j, irho) = two*w(ie, i, j, irho) - w(il, i, j, irho)
   IF (factor*w(ie, i, j, irho) .LT. w(ib, i, j, irho)) THEN
   w(ib, i, j, irho) = w(ib, i, j, irho)
   ELSE
   wd(ib, i, j, irho) = factor*wd(ie, i, j, irho)
   w(ib, i, j, irho) = factor*w(ie, i, j, irho)
   END IF
   wd(ib, i, j, ivx) = two*wd(ie, i, j, ivx) - wd(il, i, j, ivx)
   w(ib, i, j, ivx) = two*w(ie, i, j, ivx) - w(il, i, j, ivx)
   wd(ib, i, j, ivy) = two*wd(ie, i, j, ivy) - wd(il, i, j, ivy)
   w(ib, i, j, ivy) = two*w(ie, i, j, ivy) - w(il, i, j, ivy)
   wd(ib, i, j, ivz) = two*wd(ie, i, j, ivz) - wd(il, i, j, ivz)
   w(ib, i, j, ivz) = two*w(ie, i, j, ivz) - w(il, i, j, ivz)
   IF (factor*p(ie, i, j) .LT. two*p(ie, i, j) - p(il, i, j)) THEN
   pd(ib, i, j) = two*pd(ie, i, j) - pd(il, i, j)
   p(ib, i, j) = two*p(ie, i, j) - p(il, i, j)
   ELSE
   pd(ib, i, j) = factor*pd(ie, i, j)
   p(ib, i, j) = factor*p(ie, i, j)
   END IF
   DO l=nt1mg,nt2mg
   wd(ib, i, j, l) = wd(ie, i, j, l)
   w(ib, i, j, l) = w(ie, i, j, l)
   END DO
   IF (viscous) THEN
   rlvd(ib, i, j) = rlvd(ie, i, j)
   rlv(ib, i, j) = rlv(ie, i, j)
   END IF
   IF (eddymodel) THEN
   revd(ib, i, j) = revd(ie, i, j)
   rev(ib, i, j) = rev(ie, i, j)
   END IF
   END DO
   END DO
   idim = 1
   ddim = ib
   CASE (jmin) 
   DO j=bcdata(nn)%jcbeg,bcdata(nn)%jcend
   DO i=bcdata(nn)%icbeg,bcdata(nn)%icend
   wd(i, 0, j, irho) = two*wd(i, 1, j, irho) - wd(i, 2, j, irho)
   w(i, 0, j, irho) = two*w(i, 1, j, irho) - w(i, 2, j, irho)
   IF (factor*w(i, 1, j, irho) .LT. w(i, 0, j, irho)) THEN
   w(i, 0, j, irho) = w(i, 0, j, irho)
   ELSE
   wd(i, 0, j, irho) = factor*wd(i, 1, j, irho)
   w(i, 0, j, irho) = factor*w(i, 1, j, irho)
   END IF
   wd(i, 0, j, ivx) = two*wd(i, 1, j, ivx) - wd(i, 2, j, ivx)
   w(i, 0, j, ivx) = two*w(i, 1, j, ivx) - w(i, 2, j, ivx)
   wd(i, 0, j, ivy) = two*wd(i, 1, j, ivy) - wd(i, 2, j, ivy)
   w(i, 0, j, ivy) = two*w(i, 1, j, ivy) - w(i, 2, j, ivy)
   wd(i, 0, j, ivz) = two*wd(i, 1, j, ivz) - wd(i, 2, j, ivz)
   w(i, 0, j, ivz) = two*w(i, 1, j, ivz) - w(i, 2, j, ivz)
   IF (factor*p(i, 1, j) .LT. two*p(i, 1, j) - p(i, 2, j)) THEN
   pd(i, 0, j) = two*pd(i, 1, j) - pd(i, 2, j)
   p(i, 0, j) = two*p(i, 1, j) - p(i, 2, j)
   ELSE
   pd(i, 0, j) = factor*pd(i, 1, j)
   p(i, 0, j) = factor*p(i, 1, j)
   END IF
   DO l=nt1mg,nt2mg
   wd(i, 0, j, l) = wd(i, 1, j, l)
   w(i, 0, j, l) = w(i, 1, j, l)
   END DO
   IF (viscous) THEN
   rlvd(i, 0, j) = rlvd(i, 1, j)
   rlv(i, 0, j) = rlv(i, 1, j)
   END IF
   IF (eddymodel) THEN
   revd(i, 0, j) = revd(i, 1, j)
   rev(i, 0, j) = rev(i, 1, j)
   END IF
   END DO
   END DO
   idim = 2
   ddim = 0
   CASE (jmax) 
   DO j=bcdata(nn)%jcbeg,bcdata(nn)%jcend
   DO i=bcdata(nn)%icbeg,bcdata(nn)%icend
   wd(i, jb, j, irho) = two*wd(i, je, j, irho) - wd(i, jl, j, irho)
   w(i, jb, j, irho) = two*w(i, je, j, irho) - w(i, jl, j, irho)
   IF (factor*w(i, je, j, irho) .LT. w(i, jb, j, irho)) THEN
   w(i, jb, j, irho) = w(i, jb, j, irho)
   ELSE
   wd(i, jb, j, irho) = factor*wd(i, je, j, irho)
   w(i, jb, j, irho) = factor*w(i, je, j, irho)
   END IF
   wd(i, jb, j, ivx) = two*wd(i, je, j, ivx) - wd(i, jl, j, ivx)
   w(i, jb, j, ivx) = two*w(i, je, j, ivx) - w(i, jl, j, ivx)
   wd(i, jb, j, ivy) = two*wd(i, je, j, ivy) - wd(i, jl, j, ivy)
   w(i, jb, j, ivy) = two*w(i, je, j, ivy) - w(i, jl, j, ivy)
   wd(i, jb, j, ivz) = two*wd(i, je, j, ivz) - wd(i, jl, j, ivz)
   w(i, jb, j, ivz) = two*w(i, je, j, ivz) - w(i, jl, j, ivz)
   IF (factor*p(i, je, j) .LT. two*p(i, je, j) - p(i, jl, j)) THEN
   pd(i, jb, j) = two*pd(i, je, j) - pd(i, jl, j)
   p(i, jb, j) = two*p(i, je, j) - p(i, jl, j)
   ELSE
   pd(i, jb, j) = factor*pd(i, je, j)
   p(i, jb, j) = factor*p(i, je, j)
   END IF
   DO l=nt1mg,nt2mg
   wd(i, jb, j, l) = wd(i, je, j, l)
   w(i, jb, j, l) = w(i, je, j, l)
   END DO
   IF (viscous) THEN
   rlvd(i, jb, j) = rlvd(i, je, j)
   rlv(i, jb, j) = rlv(i, je, j)
   END IF
   IF (eddymodel) THEN
   revd(i, jb, j) = revd(i, je, j)
   rev(i, jb, j) = rev(i, je, j)
   END IF
   END DO
   END DO
   idim = 2
   ddim = jb
   CASE (kmin) 
   DO j=bcdata(nn)%jcbeg,bcdata(nn)%jcend
   DO i=bcdata(nn)%icbeg,bcdata(nn)%icend
   wd(i, j, 0, irho) = two*wd(i, j, 1, irho) - wd(i, j, 2, irho)
   w(i, j, 0, irho) = two*w(i, j, 1, irho) - w(i, j, 2, irho)
   IF (factor*w(i, j, 1, irho) .LT. w(i, j, 0, irho)) THEN
   w(i, j, 0, irho) = w(i, j, 0, irho)
   ELSE
   wd(i, j, 0, irho) = factor*wd(i, j, 1, irho)
   w(i, j, 0, irho) = factor*w(i, j, 1, irho)
   END IF
   wd(i, j, 0, ivx) = two*wd(i, j, 1, ivx) - wd(i, j, 2, ivx)
   w(i, j, 0, ivx) = two*w(i, j, 1, ivx) - w(i, j, 2, ivx)
   wd(i, j, 0, ivy) = two*wd(i, j, 1, ivy) - wd(i, j, 2, ivy)
   w(i, j, 0, ivy) = two*w(i, j, 1, ivy) - w(i, j, 2, ivy)
   wd(i, j, 0, ivz) = two*wd(i, j, 1, ivz) - wd(i, j, 2, ivz)
   w(i, j, 0, ivz) = two*w(i, j, 1, ivz) - w(i, j, 2, ivz)
   IF (factor*p(i, j, 1) .LT. two*p(i, j, 1) - p(i, j, 2)) THEN
   pd(i, j, 0) = two*pd(i, j, 1) - pd(i, j, 2)
   p(i, j, 0) = two*p(i, j, 1) - p(i, j, 2)
   ELSE
   pd(i, j, 0) = factor*pd(i, j, 1)
   p(i, j, 0) = factor*p(i, j, 1)
   END IF
   DO l=nt1mg,nt2mg
   wd(i, j, 0, l) = wd(i, j, 1, l)
   w(i, j, 0, l) = w(i, j, 1, l)
   END DO
   IF (viscous) THEN
   rlvd(i, j, 0) = rlvd(i, j, 1)
   rlv(i, j, 0) = rlv(i, j, 1)
   END IF
   IF (eddymodel) THEN
   revd(i, j, 0) = revd(i, j, 1)
   rev(i, j, 0) = rev(i, j, 1)
   END IF
   END DO
   END DO
   idim = 3
   ddim = 0
   CASE (kmax) 
   DO j=bcdata(nn)%jcbeg,bcdata(nn)%jcend
   DO i=bcdata(nn)%icbeg,bcdata(nn)%icend
   wd(i, j, kb, irho) = two*wd(i, j, ke, irho) - wd(i, j, kl, irho)
   w(i, j, kb, irho) = two*w(i, j, ke, irho) - w(i, j, kl, irho)
   IF (factor*w(i, j, ke, irho) .LT. w(i, j, kb, irho)) THEN
   w(i, j, kb, irho) = w(i, j, kb, irho)
   ELSE
   wd(i, j, kb, irho) = factor*wd(i, j, ke, irho)
   w(i, j, kb, irho) = factor*w(i, j, ke, irho)
   END IF
   wd(i, j, kb, ivx) = two*wd(i, j, ke, ivx) - wd(i, j, kl, ivx)
   w(i, j, kb, ivx) = two*w(i, j, ke, ivx) - w(i, j, kl, ivx)
   wd(i, j, kb, ivy) = two*wd(i, j, ke, ivy) - wd(i, j, kl, ivy)
   w(i, j, kb, ivy) = two*w(i, j, ke, ivy) - w(i, j, kl, ivy)
   wd(i, j, kb, ivz) = two*wd(i, j, ke, ivz) - wd(i, j, kl, ivz)
   w(i, j, kb, ivz) = two*w(i, j, ke, ivz) - w(i, j, kl, ivz)
   IF (factor*p(i, j, ke) .LT. two*p(i, j, ke) - p(i, j, kl)) THEN
   pd(i, j, kb) = two*pd(i, j, ke) - pd(i, j, kl)
   p(i, j, kb) = two*p(i, j, ke) - p(i, j, kl)
   ELSE
   pd(i, j, kb) = factor*pd(i, j, ke)
   p(i, j, kb) = factor*p(i, j, ke)
   END IF
   DO l=nt1mg,nt2mg
   wd(i, j, kb, l) = wd(i, j, ke, l)
   w(i, j, kb, l) = w(i, j, ke, l)
   END DO
   IF (viscous) THEN
   rlvd(i, j, kb) = rlvd(i, j, ke)
   rlv(i, j, kb) = rlv(i, j, ke)
   END IF
   IF (eddymodel) THEN
   revd(i, j, kb) = revd(i, j, ke)
   rev(i, j, kb) = rev(i, j, ke)
   END IF
   END DO
   END DO
   idim = 3
   ddim = kb
   END SELECT
   ! Set the range for the halo cells for the energy computation.
   crange(1, 1) = icbeg(nn)
   crange(1, 2) = icend(nn)
   crange(2, 1) = jcbeg(nn)
   crange(2, 2) = jcend(nn)
   crange(3, 1) = kcbeg(nn)
   crange(3, 2) = kcend(nn)
   crange(idim, 1) = ddim
   crange(idim, 2) = ddim
   ! Compute the energy for this halo range.
   CALL COMPUTEETOT_D(crange(1, 1), crange(1, 2), crange(2, 1), crange(2&
   &              , 2), crange(3, 1), crange(3, 2), correctfork)
   END SUBROUTINE EXTRAPOLATE2NDHALO_D
