   !        Generated by TAPENADE     (INRIA, Tropics team)
   !  Tapenade 3.10 (r5363) -  9 Sep 2014 09:53
   !
   !  Differentiation of viscousfluxapprox in forward (tangent) mode (with options i4 dr8 r8):
   !   variations   of useful results: *p *fw
   !   with respect to varying inputs: *rev *p *gamma *w *rlv *x *si
   !                *sj *sk *fw
   !   Plus diff mem management of: rev:in p:in gamma:in w:in rlv:in
   !                x:in si:in sj:in sk:in fw:in
   SUBROUTINE VISCOUSFLUXAPPROX_D()
   USE BLOCKPOINTERS
   USE FLOWVARREFSTATE
   USE INPUTPHYSICS
   USE ITERATION
   IMPLICIT NONE
   !
   !      Local parameter.
   !
   REAL(kind=realtype), PARAMETER :: twothird=two*third
   !
   !      Local variables.
   !
   INTEGER(kind=inttype) :: i, j, k
   INTEGER(kind=inttype) :: ii, jj, kk
   REAL(kind=realtype) :: rfilv, por, mul, mue, mut, heatcoef
   REAL(kind=realtype) :: muld, mued, mutd, heatcoefd
   REAL(kind=realtype) :: gm1, factlamheat, factturbheat
   REAL(kind=realtype) :: gm1d, factlamheatd, factturbheatd
   REAL(kind=realtype) :: u_x, u_y, u_z, v_x, v_y, v_z, w_x, w_y, w_z
   REAL(kind=realtype) :: u_xd, u_yd, u_zd, v_xd, v_yd, v_zd, w_xd, w_yd&
   & , w_zd
   REAL(kind=realtype) :: q_x, q_y, q_z, ubar, vbar, wbar
   REAL(kind=realtype) :: q_xd, q_yd, q_zd, ubard, vbard, wbard
   REAL(kind=realtype) :: corr, ssx, ssy, ssz, ss, fracdiv
   REAL(kind=realtype) :: ssxd, ssyd, sszd, ssd, fracdivd
   REAL(kind=realtype) :: tauxx, tauyy, tauzz
   REAL(kind=realtype) :: tauxxd, tauyyd, tauzzd
   REAL(kind=realtype) :: tauxy, tauxz, tauyz
   REAL(kind=realtype) :: tauxyd, tauxzd, tauyzd
   REAL(kind=realtype) :: fmx, fmy, fmz, frhoe
   REAL(kind=realtype) :: fmxd, fmyd, fmzd, frhoed
   REAL(kind=realtype) :: dd
   REAL(kind=realtype) :: ddd
   LOGICAL :: correctfork
   INTRINSIC ABS
   REAL(kind=realtype) :: abs0
   ! Set rFilv to rFil to indicate that this is the viscous part.
   ! If rFilv == 0 the viscous residuals need not to be computed
   ! and a return can be made.
   rfilv = rfil
   IF (rfilv .GE. 0.) THEN
   abs0 = rfilv
   ELSE
   abs0 = -rfilv
   END IF
   IF (abs0 .LT. thresholdreal) THEN
   RETURN
   ELSE
   ! Determine whether or not the pressure must be corrected
   ! for the presence of the turbulent kinetic energy.
   IF (kpresent) THEN
   IF (currentlevel .LE. groundlevel .OR. turbcoupled) THEN
   correctfork = .true.
   ELSE
   correctfork = .false.
   END IF
   ELSE
   correctfork = .false.
   END IF
   ! Store the speed of sound squared instead of the pressure.
   ! To be 100 percent correct, substract 2/3*rho*k (if present)
   ! from the pressure to obtain the true presssure. First layer of
   ! halo's, because that's what is needed by the viscous stencil.
   DO k=1,ke
   DO j=1,je
   DO i=1,ie
   IF (correctfork) THEN
   pd(i, j, k) = pd(i, j, k) - twothird*(wd(i, j, k, irho)*w(i&
   &             , j, k, itu1)+w(i, j, k, irho)*wd(i, j, k, itu1))
   p(i, j, k) = p(i, j, k) - twothird*w(i, j, k, irho)*w(i, j, &
   &             k, itu1)
   END IF
   pd(i, j, k) = ((gammad(i, j, k)*p(i, j, k)+gamma(i, j, k)*pd(i&
   &           , j, k))*w(i, j, k, irho)-gamma(i, j, k)*p(i, j, k)*wd(i, j&
   &           , k, irho))/w(i, j, k, irho)**2
   p(i, j, k) = gamma(i, j, k)*p(i, j, k)/w(i, j, k, irho)
   END DO
   END DO
   END DO
   mue = zero
   mued = 0.0_8
   ! Viscous fluxes in the I-direction
   DO k=2,kl
   DO j=2,jl
   DO i=1,il
   ! Compute the vector from the center of cell i to cell i+1           
   ssxd = eighth*(xd(i+1, j-1, k-1, 1)-xd(i-1, j-1, k-1, 1)+xd(i+&
   &           1, j-1, k, 1)-xd(i-1, j-1, k, 1)+xd(i+1, j, k-1, 1)-xd(i-1, &
   &           j, k-1, 1)+xd(i+1, j, k, 1)-xd(i-1, j, k, 1))
   ssx = eighth*(x(i+1, j-1, k-1, 1)-x(i-1, j-1, k-1, 1)+x(i+1, j&
   &           -1, k, 1)-x(i-1, j-1, k, 1)+x(i+1, j, k-1, 1)-x(i-1, j, k-1&
   &           , 1)+x(i+1, j, k, 1)-x(i-1, j, k, 1))
   ssyd = eighth*(xd(i+1, j-1, k-1, 2)-xd(i-1, j-1, k-1, 2)+xd(i+&
   &           1, j-1, k, 2)-xd(i-1, j-1, k, 2)+xd(i+1, j, k-1, 2)-xd(i-1, &
   &           j, k-1, 2)+xd(i+1, j, k, 2)-xd(i-1, j, k, 2))
   ssy = eighth*(x(i+1, j-1, k-1, 2)-x(i-1, j-1, k-1, 2)+x(i+1, j&
   &           -1, k, 2)-x(i-1, j-1, k, 2)+x(i+1, j, k-1, 2)-x(i-1, j, k-1&
   &           , 2)+x(i+1, j, k, 2)-x(i-1, j, k, 2))
   sszd = eighth*(xd(i+1, j-1, k-1, 3)-xd(i-1, j-1, k-1, 3)+xd(i+&
   &           1, j-1, k, 3)-xd(i-1, j-1, k, 3)+xd(i+1, j, k-1, 3)-xd(i-1, &
   &           j, k-1, 3)+xd(i+1, j, k, 3)-xd(i-1, j, k, 3))
   ssz = eighth*(x(i+1, j-1, k-1, 3)-x(i-1, j-1, k-1, 3)+x(i+1, j&
   &           -1, k, 3)-x(i-1, j-1, k, 3)+x(i+1, j, k-1, 3)-x(i-1, j, k-1&
   &           , 3)+x(i+1, j, k, 3)-x(i-1, j, k, 3))
   ! And determine one/ length of vector squared
   ssd = -(one*(ssxd*ssx+ssx*ssxd+ssyd*ssy+ssy*ssyd+sszd*ssz+ssz*&
   &           sszd)/(ssx*ssx+ssy*ssy+ssz*ssz)**2)
   ss = one/(ssx*ssx+ssy*ssy+ssz*ssz)
   ssxd = ssd*ssx + ss*ssxd
   ssx = ss*ssx
   ssyd = ssd*ssy + ss*ssyd
   ssy = ss*ssy
   sszd = ssd*ssz + ss*sszd
   ssz = ss*ssz
   ! Now compute each gradient
   ddd = wd(i+1, j, k, ivx) - wd(i, j, k, ivx)
   dd = w(i+1, j, k, ivx) - w(i, j, k, ivx)
   u_xd = ddd*ssx + dd*ssxd
   u_x = dd*ssx
   u_yd = ddd*ssy + dd*ssyd
   u_y = dd*ssy
   u_zd = ddd*ssz + dd*sszd
   u_z = dd*ssz
   ddd = wd(i+1, j, k, ivy) - wd(i, j, k, ivy)
   dd = w(i+1, j, k, ivy) - w(i, j, k, ivy)
   v_xd = ddd*ssx + dd*ssxd
   v_x = dd*ssx
   v_yd = ddd*ssy + dd*ssyd
   v_y = dd*ssy
   v_zd = ddd*ssz + dd*sszd
   v_z = dd*ssz
   ddd = wd(i+1, j, k, ivz) - wd(i, j, k, ivz)
   dd = w(i+1, j, k, ivz) - w(i, j, k, ivz)
   w_xd = ddd*ssx + dd*ssxd
   w_x = dd*ssx
   w_yd = ddd*ssy + dd*ssyd
   w_y = dd*ssy
   w_zd = ddd*ssz + dd*sszd
   w_z = dd*ssz
   ddd = pd(i+1, j, k) - pd(i, j, k)
   dd = p(i+1, j, k) - p(i, j, k)
   q_xd = -(ddd*ssx+dd*ssxd)
   q_x = -(dd*ssx)
   q_yd = -(ddd*ssy+dd*ssyd)
   q_y = -(dd*ssy)
   q_zd = -(ddd*ssz+dd*sszd)
   q_z = -(dd*ssz)
   por = half*rfilv
   IF (pori(i, j, k) .EQ. noflux) por = zero
   ! Compute the laminar and (if present) the eddy viscosities
   ! multiplied by the porosity. Compute the factor in front of
   ! the gradients of the speed of sound squared for the heat
   ! flux.
   muld = por*(rlvd(i, j, k)+rlvd(i+1, j, k))
   mul = por*(rlv(i, j, k)+rlv(i+1, j, k))
   IF (eddymodel) THEN
   mued = por*(revd(i, j, k)+revd(i+1, j, k))
   mue = por*(rev(i, j, k)+rev(i+1, j, k))
   END IF
   mutd = muld + mued
   mut = mul + mue
   gm1d = half*(gammad(i, j, k)+gammad(i+1, j, k))
   gm1 = half*(gamma(i, j, k)+gamma(i+1, j, k)) - one
   factlamheatd = -(one*prandtl*gm1d/(prandtl*gm1)**2)
   factlamheat = one/(prandtl*gm1)
   factturbheatd = -(one*prandtlturb*gm1d/(prandtlturb*gm1)**2)
   factturbheat = one/(prandtlturb*gm1)
   heatcoefd = muld*factlamheat + mul*factlamheatd + mued*&
   &           factturbheat + mue*factturbheatd
   heatcoef = mul*factlamheat + mue*factturbheat
   ! Compute the stress tensor and the heat flux vector.
   fracdivd = twothird*(u_xd+v_yd+w_zd)
   fracdiv = twothird*(u_x+v_y+w_z)
   tauxxd = mutd*(two*u_x-fracdiv) + mut*(two*u_xd-fracdivd)
   tauxx = mut*(two*u_x-fracdiv)
   tauyyd = mutd*(two*v_y-fracdiv) + mut*(two*v_yd-fracdivd)
   tauyy = mut*(two*v_y-fracdiv)
   tauzzd = mutd*(two*w_z-fracdiv) + mut*(two*w_zd-fracdivd)
   tauzz = mut*(two*w_z-fracdiv)
   tauxyd = mutd*(u_y+v_x) + mut*(u_yd+v_xd)
   tauxy = mut*(u_y+v_x)
   tauxzd = mutd*(u_z+w_x) + mut*(u_zd+w_xd)
   tauxz = mut*(u_z+w_x)
   tauyzd = mutd*(v_z+w_y) + mut*(v_zd+w_yd)
   tauyz = mut*(v_z+w_y)
   q_xd = heatcoefd*q_x + heatcoef*q_xd
   q_x = heatcoef*q_x
   q_yd = heatcoefd*q_y + heatcoef*q_yd
   q_y = heatcoef*q_y
   q_zd = heatcoefd*q_z + heatcoef*q_zd
   q_z = heatcoef*q_z
   ! Compute the average velocities for the face. Remember that
   ! the velocities are stored and not the momentum.
   ubard = half*(wd(i, j, k, ivx)+wd(i+1, j, k, ivx))
   ubar = half*(w(i, j, k, ivx)+w(i+1, j, k, ivx))
   vbard = half*(wd(i, j, k, ivy)+wd(i+1, j, k, ivy))
   vbar = half*(w(i, j, k, ivy)+w(i+1, j, k, ivy))
   wbard = half*(wd(i, j, k, ivz)+wd(i+1, j, k, ivz))
   wbar = half*(w(i, j, k, ivz)+w(i+1, j, k, ivz))
   ! Compute the viscous fluxes for this i-face.
   fmxd = tauxxd*si(i, j, k, 1) + tauxx*sid(i, j, k, 1) + tauxyd*&
   &           si(i, j, k, 2) + tauxy*sid(i, j, k, 2) + tauxzd*si(i, j, k, &
   &           3) + tauxz*sid(i, j, k, 3)
   fmx = tauxx*si(i, j, k, 1) + tauxy*si(i, j, k, 2) + tauxz*si(i&
   &           , j, k, 3)
   fmyd = tauxyd*si(i, j, k, 1) + tauxy*sid(i, j, k, 1) + tauyyd*&
   &           si(i, j, k, 2) + tauyy*sid(i, j, k, 2) + tauyzd*si(i, j, k, &
   &           3) + tauyz*sid(i, j, k, 3)
   fmy = tauxy*si(i, j, k, 1) + tauyy*si(i, j, k, 2) + tauyz*si(i&
   &           , j, k, 3)
   fmzd = tauxzd*si(i, j, k, 1) + tauxz*sid(i, j, k, 1) + tauyzd*&
   &           si(i, j, k, 2) + tauyz*sid(i, j, k, 2) + tauzzd*si(i, j, k, &
   &           3) + tauzz*sid(i, j, k, 3)
   fmz = tauxz*si(i, j, k, 1) + tauyz*si(i, j, k, 2) + tauzz*si(i&
   &           , j, k, 3)
   frhoed = (ubard*tauxx+ubar*tauxxd+vbard*tauxy+vbar*tauxyd+&
   &           wbard*tauxz+wbar*tauxzd)*si(i, j, k, 1) + (ubar*tauxx+vbar*&
   &           tauxy+wbar*tauxz)*sid(i, j, k, 1) + (ubard*tauxy+ubar*tauxyd&
   &           +vbard*tauyy+vbar*tauyyd+wbard*tauyz+wbar*tauyzd)*si(i, j, k&
   &           , 2) + (ubar*tauxy+vbar*tauyy+wbar*tauyz)*sid(i, j, k, 2) + &
   &           (ubard*tauxz+ubar*tauxzd+vbard*tauyz+vbar*tauyzd+wbard*tauzz&
   &           +wbar*tauzzd)*si(i, j, k, 3) + (ubar*tauxz+vbar*tauyz+wbar*&
   &           tauzz)*sid(i, j, k, 3) - q_xd*si(i, j, k, 1) - q_x*sid(i, j&
   &           , k, 1) - q_yd*si(i, j, k, 2) - q_y*sid(i, j, k, 2) - q_zd*&
   &           si(i, j, k, 3) - q_z*sid(i, j, k, 3)
   frhoe = (ubar*tauxx+vbar*tauxy+wbar*tauxz)*si(i, j, k, 1) + (&
   &           ubar*tauxy+vbar*tauyy+wbar*tauyz)*si(i, j, k, 2) + (ubar*&
   &           tauxz+vbar*tauyz+wbar*tauzz)*si(i, j, k, 3) - q_x*si(i, j, k&
   &           , 1) - q_y*si(i, j, k, 2) - q_z*si(i, j, k, 3)
   ! Update the residuals of cell i and i+1.
   fwd(i, j, k, imx) = fwd(i, j, k, imx) - fmxd
   fw(i, j, k, imx) = fw(i, j, k, imx) - fmx
   fwd(i, j, k, imy) = fwd(i, j, k, imy) - fmyd
   fw(i, j, k, imy) = fw(i, j, k, imy) - fmy
   fwd(i, j, k, imz) = fwd(i, j, k, imz) - fmzd
   fw(i, j, k, imz) = fw(i, j, k, imz) - fmz
   fwd(i, j, k, irhoe) = fwd(i, j, k, irhoe) - frhoed
   fw(i, j, k, irhoe) = fw(i, j, k, irhoe) - frhoe
   fwd(i+1, j, k, imx) = fwd(i+1, j, k, imx) + fmxd
   fw(i+1, j, k, imx) = fw(i+1, j, k, imx) + fmx
   fwd(i+1, j, k, imy) = fwd(i+1, j, k, imy) + fmyd
   fw(i+1, j, k, imy) = fw(i+1, j, k, imy) + fmy
   fwd(i+1, j, k, imz) = fwd(i+1, j, k, imz) + fmzd
   fw(i+1, j, k, imz) = fw(i+1, j, k, imz) + fmz
   fwd(i+1, j, k, irhoe) = fwd(i+1, j, k, irhoe) + frhoed
   fw(i+1, j, k, irhoe) = fw(i+1, j, k, irhoe) + frhoe
   END DO
   END DO
   END DO
   ! Viscous fluxes in the J-direction
   DO k=2,kl
   DO j=1,jl
   DO i=2,il
   ! Compute the vector from the center of cell j to cell j+1           
   ssxd = eighth*(xd(i-1, j+1, k-1, 1)-xd(i-1, j-1, k-1, 1)+xd(i-&
   &           1, j+1, k, 1)-xd(i-1, j-1, k, 1)+xd(i, j+1, k-1, 1)-xd(i, j-&
   &           1, k-1, 1)+xd(i, j+1, k, 1)-xd(i, j-1, k, 1))
   ssx = eighth*(x(i-1, j+1, k-1, 1)-x(i-1, j-1, k-1, 1)+x(i-1, j&
   &           +1, k, 1)-x(i-1, j-1, k, 1)+x(i, j+1, k-1, 1)-x(i, j-1, k-1&
   &           , 1)+x(i, j+1, k, 1)-x(i, j-1, k, 1))
   ssyd = eighth*(xd(i-1, j+1, k-1, 2)-xd(i-1, j-1, k-1, 2)+xd(i-&
   &           1, j+1, k, 2)-xd(i-1, j-1, k, 2)+xd(i, j+1, k-1, 2)-xd(i, j-&
   &           1, k-1, 2)+xd(i, j+1, k, 2)-xd(i, j-1, k, 2))
   ssy = eighth*(x(i-1, j+1, k-1, 2)-x(i-1, j-1, k-1, 2)+x(i-1, j&
   &           +1, k, 2)-x(i-1, j-1, k, 2)+x(i, j+1, k-1, 2)-x(i, j-1, k-1&
   &           , 2)+x(i, j+1, k, 2)-x(i, j-1, k, 2))
   sszd = eighth*(xd(i-1, j+1, k-1, 3)-xd(i-1, j-1, k-1, 3)+xd(i-&
   &           1, j+1, k, 3)-xd(i-1, j-1, k, 3)+xd(i, j+1, k-1, 3)-xd(i, j-&
   &           1, k-1, 3)+xd(i, j+1, k, 3)-xd(i, j-1, k, 3))
   ssz = eighth*(x(i-1, j+1, k-1, 3)-x(i-1, j-1, k-1, 3)+x(i-1, j&
   &           +1, k, 3)-x(i-1, j-1, k, 3)+x(i, j+1, k-1, 3)-x(i, j-1, k-1&
   &           , 3)+x(i, j+1, k, 3)-x(i, j-1, k, 3))
   ! And determine one/ length of vector squared
   ssd = -(one*(ssxd*ssx+ssx*ssxd+ssyd*ssy+ssy*ssyd+sszd*ssz+ssz*&
   &           sszd)/(ssx*ssx+ssy*ssy+ssz*ssz)**2)
   ss = one/(ssx*ssx+ssy*ssy+ssz*ssz)
   ssxd = ssd*ssx + ss*ssxd
   ssx = ss*ssx
   ssyd = ssd*ssy + ss*ssyd
   ssy = ss*ssy
   sszd = ssd*ssz + ss*sszd
   ssz = ss*ssz
   ! Now compute each gradient
   ddd = wd(i, j+1, k, ivx) - wd(i, j, k, ivx)
   dd = w(i, j+1, k, ivx) - w(i, j, k, ivx)
   u_xd = ddd*ssx + dd*ssxd
   u_x = dd*ssx
   u_yd = ddd*ssy + dd*ssyd
   u_y = dd*ssy
   u_zd = ddd*ssz + dd*sszd
   u_z = dd*ssz
   ddd = wd(i, j+1, k, ivy) - wd(i, j, k, ivy)
   dd = w(i, j+1, k, ivy) - w(i, j, k, ivy)
   v_xd = ddd*ssx + dd*ssxd
   v_x = dd*ssx
   v_yd = ddd*ssy + dd*ssyd
   v_y = dd*ssy
   v_zd = ddd*ssz + dd*sszd
   v_z = dd*ssz
   ddd = wd(i, j+1, k, ivz) - wd(i, j, k, ivz)
   dd = w(i, j+1, k, ivz) - w(i, j, k, ivz)
   w_xd = ddd*ssx + dd*ssxd
   w_x = dd*ssx
   w_yd = ddd*ssy + dd*ssyd
   w_y = dd*ssy
   w_zd = ddd*ssz + dd*sszd
   w_z = dd*ssz
   ddd = pd(i, j+1, k) - pd(i, j, k)
   dd = p(i, j+1, k) - p(i, j, k)
   q_xd = -(ddd*ssx+dd*ssxd)
   q_x = -(dd*ssx)
   q_yd = -(ddd*ssy+dd*ssyd)
   q_y = -(dd*ssy)
   q_zd = -(ddd*ssz+dd*sszd)
   q_z = -(dd*ssz)
   por = half*rfilv
   IF (porj(i, j, k) .EQ. noflux) por = zero
   ! Compute the laminar and (if present) the eddy viscosities
   ! multiplied by the porosity. Compute the factor in front of
   ! the gradients of the speed of sound squared for the heat
   ! flux.
   muld = por*(rlvd(i, j, k)+rlvd(i, j+1, k))
   mul = por*(rlv(i, j, k)+rlv(i, j+1, k))
   IF (eddymodel) THEN
   mued = por*(revd(i, j, k)+revd(i, j+1, k))
   mue = por*(rev(i, j, k)+rev(i, j+1, k))
   END IF
   mutd = muld + mued
   mut = mul + mue
   gm1d = half*(gammad(i, j, k)+gammad(i, j+1, k))
   gm1 = half*(gamma(i, j, k)+gamma(i, j+1, k)) - one
   factlamheatd = -(one*prandtl*gm1d/(prandtl*gm1)**2)
   factlamheat = one/(prandtl*gm1)
   factturbheatd = -(one*prandtlturb*gm1d/(prandtlturb*gm1)**2)
   factturbheat = one/(prandtlturb*gm1)
   heatcoefd = muld*factlamheat + mul*factlamheatd + mued*&
   &           factturbheat + mue*factturbheatd
   heatcoef = mul*factlamheat + mue*factturbheat
   ! Compute the stress tensor and the heat flux vector.
   fracdivd = twothird*(u_xd+v_yd+w_zd)
   fracdiv = twothird*(u_x+v_y+w_z)
   tauxxd = mutd*(two*u_x-fracdiv) + mut*(two*u_xd-fracdivd)
   tauxx = mut*(two*u_x-fracdiv)
   tauyyd = mutd*(two*v_y-fracdiv) + mut*(two*v_yd-fracdivd)
   tauyy = mut*(two*v_y-fracdiv)
   tauzzd = mutd*(two*w_z-fracdiv) + mut*(two*w_zd-fracdivd)
   tauzz = mut*(two*w_z-fracdiv)
   tauxyd = mutd*(u_y+v_x) + mut*(u_yd+v_xd)
   tauxy = mut*(u_y+v_x)
   tauxzd = mutd*(u_z+w_x) + mut*(u_zd+w_xd)
   tauxz = mut*(u_z+w_x)
   tauyzd = mutd*(v_z+w_y) + mut*(v_zd+w_yd)
   tauyz = mut*(v_z+w_y)
   q_xd = heatcoefd*q_x + heatcoef*q_xd
   q_x = heatcoef*q_x
   q_yd = heatcoefd*q_y + heatcoef*q_yd
   q_y = heatcoef*q_y
   q_zd = heatcoefd*q_z + heatcoef*q_zd
   q_z = heatcoef*q_z
   ! Compute the average velocities for the face. Remember that
   ! the velocities are stored and not the momentum.
   ubard = half*(wd(i, j, k, ivx)+wd(i, j+1, k, ivx))
   ubar = half*(w(i, j, k, ivx)+w(i, j+1, k, ivx))
   vbard = half*(wd(i, j, k, ivy)+wd(i, j+1, k, ivy))
   vbar = half*(w(i, j, k, ivy)+w(i, j+1, k, ivy))
   wbard = half*(wd(i, j, k, ivz)+wd(i, j+1, k, ivz))
   wbar = half*(w(i, j, k, ivz)+w(i, j+1, k, ivz))
   ! Compute the viscous fluxes for this j-face.
   fmxd = tauxxd*sj(i, j, k, 1) + tauxx*sjd(i, j, k, 1) + tauxyd*&
   &           sj(i, j, k, 2) + tauxy*sjd(i, j, k, 2) + tauxzd*sj(i, j, k, &
   &           3) + tauxz*sjd(i, j, k, 3)
   fmx = tauxx*sj(i, j, k, 1) + tauxy*sj(i, j, k, 2) + tauxz*sj(i&
   &           , j, k, 3)
   fmyd = tauxyd*sj(i, j, k, 1) + tauxy*sjd(i, j, k, 1) + tauyyd*&
   &           sj(i, j, k, 2) + tauyy*sjd(i, j, k, 2) + tauyzd*sj(i, j, k, &
   &           3) + tauyz*sjd(i, j, k, 3)
   fmy = tauxy*sj(i, j, k, 1) + tauyy*sj(i, j, k, 2) + tauyz*sj(i&
   &           , j, k, 3)
   fmzd = tauxzd*sj(i, j, k, 1) + tauxz*sjd(i, j, k, 1) + tauyzd*&
   &           sj(i, j, k, 2) + tauyz*sjd(i, j, k, 2) + tauzzd*sj(i, j, k, &
   &           3) + tauzz*sjd(i, j, k, 3)
   fmz = tauxz*sj(i, j, k, 1) + tauyz*sj(i, j, k, 2) + tauzz*sj(i&
   &           , j, k, 3)
   frhoed = (ubard*tauxx+ubar*tauxxd+vbard*tauxy+vbar*tauxyd+&
   &           wbard*tauxz+wbar*tauxzd)*sj(i, j, k, 1) + (ubar*tauxx+vbar*&
   &           tauxy+wbar*tauxz)*sjd(i, j, k, 1) + (ubard*tauxy+ubar*tauxyd&
   &           +vbard*tauyy+vbar*tauyyd+wbard*tauyz+wbar*tauyzd)*sj(i, j, k&
   &           , 2) + (ubar*tauxy+vbar*tauyy+wbar*tauyz)*sjd(i, j, k, 2) + &
   &           (ubard*tauxz+ubar*tauxzd+vbard*tauyz+vbar*tauyzd+wbard*tauzz&
   &           +wbar*tauzzd)*sj(i, j, k, 3) + (ubar*tauxz+vbar*tauyz+wbar*&
   &           tauzz)*sjd(i, j, k, 3) - q_xd*sj(i, j, k, 1) - q_x*sjd(i, j&
   &           , k, 1) - q_yd*sj(i, j, k, 2) - q_y*sjd(i, j, k, 2) - q_zd*&
   &           sj(i, j, k, 3) - q_z*sjd(i, j, k, 3)
   frhoe = (ubar*tauxx+vbar*tauxy+wbar*tauxz)*sj(i, j, k, 1) + (&
   &           ubar*tauxy+vbar*tauyy+wbar*tauyz)*sj(i, j, k, 2) + (ubar*&
   &           tauxz+vbar*tauyz+wbar*tauzz)*sj(i, j, k, 3) - q_x*sj(i, j, k&
   &           , 1) - q_y*sj(i, j, k, 2) - q_z*sj(i, j, k, 3)
   ! Update the residuals of cell j and j+1.
   fwd(i, j, k, imx) = fwd(i, j, k, imx) - fmxd
   fw(i, j, k, imx) = fw(i, j, k, imx) - fmx
   fwd(i, j, k, imy) = fwd(i, j, k, imy) - fmyd
   fw(i, j, k, imy) = fw(i, j, k, imy) - fmy
   fwd(i, j, k, imz) = fwd(i, j, k, imz) - fmzd
   fw(i, j, k, imz) = fw(i, j, k, imz) - fmz
   fwd(i, j, k, irhoe) = fwd(i, j, k, irhoe) - frhoed
   fw(i, j, k, irhoe) = fw(i, j, k, irhoe) - frhoe
   fwd(i, j+1, k, imx) = fwd(i, j+1, k, imx) + fmxd
   fw(i, j+1, k, imx) = fw(i, j+1, k, imx) + fmx
   fwd(i, j+1, k, imy) = fwd(i, j+1, k, imy) + fmyd
   fw(i, j+1, k, imy) = fw(i, j+1, k, imy) + fmy
   fwd(i, j+1, k, imz) = fwd(i, j+1, k, imz) + fmzd
   fw(i, j+1, k, imz) = fw(i, j+1, k, imz) + fmz
   fwd(i, j+1, k, irhoe) = fwd(i, j+1, k, irhoe) + frhoed
   fw(i, j+1, k, irhoe) = fw(i, j+1, k, irhoe) + frhoe
   END DO
   END DO
   END DO
   ! Viscous fluxes in the K-direction
   DO k=1,kl
   DO j=2,jl
   DO i=2,il
   ! Compute the vector from the center of cell k to cell k+1           
   ssxd = eighth*(xd(i-1, j-1, k+1, 1)-xd(i-1, j-1, k-1, 1)+xd(i-&
   &           1, j, k+1, 1)-xd(i-1, j, k-1, 1)+xd(i, j-1, k+1, 1)-xd(i, j-&
   &           1, k-1, 1)+xd(i, j, k+1, 1)-xd(i, j, k-1, 1))
   ssx = eighth*(x(i-1, j-1, k+1, 1)-x(i-1, j-1, k-1, 1)+x(i-1, j&
   &           , k+1, 1)-x(i-1, j, k-1, 1)+x(i, j-1, k+1, 1)-x(i, j-1, k-1&
   &           , 1)+x(i, j, k+1, 1)-x(i, j, k-1, 1))
   ssyd = eighth*(xd(i-1, j-1, k+1, 2)-xd(i-1, j-1, k-1, 2)+xd(i-&
   &           1, j, k+1, 2)-xd(i-1, j, k-1, 2)+xd(i, j-1, k+1, 2)-xd(i, j-&
   &           1, k-1, 2)+xd(i, j, k+1, 2)-xd(i, j, k-1, 2))
   ssy = eighth*(x(i-1, j-1, k+1, 2)-x(i-1, j-1, k-1, 2)+x(i-1, j&
   &           , k+1, 2)-x(i-1, j, k-1, 2)+x(i, j-1, k+1, 2)-x(i, j-1, k-1&
   &           , 2)+x(i, j, k+1, 2)-x(i, j, k-1, 2))
   sszd = eighth*(xd(i-1, j-1, k+1, 3)-xd(i-1, j-1, k-1, 3)+xd(i-&
   &           1, j, k+1, 3)-xd(i-1, j, k-1, 3)+xd(i, j-1, k+1, 3)-xd(i, j-&
   &           1, k-1, 3)+xd(i, j, k+1, 3)-xd(i, j, k-1, 3))
   ssz = eighth*(x(i-1, j-1, k+1, 3)-x(i-1, j-1, k-1, 3)+x(i-1, j&
   &           , k+1, 3)-x(i-1, j, k-1, 3)+x(i, j-1, k+1, 3)-x(i, j-1, k-1&
   &           , 3)+x(i, j, k+1, 3)-x(i, j, k-1, 3))
   ! And determine one/ length of vector squared
   ssd = -(one*(ssxd*ssx+ssx*ssxd+ssyd*ssy+ssy*ssyd+sszd*ssz+ssz*&
   &           sszd)/(ssx*ssx+ssy*ssy+ssz*ssz)**2)
   ss = one/(ssx*ssx+ssy*ssy+ssz*ssz)
   ssxd = ssd*ssx + ss*ssxd
   ssx = ss*ssx
   ssyd = ssd*ssy + ss*ssyd
   ssy = ss*ssy
   sszd = ssd*ssz + ss*sszd
   ssz = ss*ssz
   ! Now compute each gradient
   ddd = wd(i, j, k+1, ivx) - wd(i, j, k, ivx)
   dd = w(i, j, k+1, ivx) - w(i, j, k, ivx)
   u_xd = ddd*ssx + dd*ssxd
   u_x = dd*ssx
   u_yd = ddd*ssy + dd*ssyd
   u_y = dd*ssy
   u_zd = ddd*ssz + dd*sszd
   u_z = dd*ssz
   ddd = wd(i, j, k+1, ivy) - wd(i, j, k, ivy)
   dd = w(i, j, k+1, ivy) - w(i, j, k, ivy)
   v_xd = ddd*ssx + dd*ssxd
   v_x = dd*ssx
   v_yd = ddd*ssy + dd*ssyd
   v_y = dd*ssy
   v_zd = ddd*ssz + dd*sszd
   v_z = dd*ssz
   ddd = wd(i, j, k+1, ivz) - wd(i, j, k, ivz)
   dd = w(i, j, k+1, ivz) - w(i, j, k, ivz)
   w_xd = ddd*ssx + dd*ssxd
   w_x = dd*ssx
   w_yd = ddd*ssy + dd*ssyd
   w_y = dd*ssy
   w_zd = ddd*ssz + dd*sszd
   w_z = dd*ssz
   ddd = pd(i, j, k+1) - pd(i, j, k)
   dd = p(i, j, k+1) - p(i, j, k)
   q_xd = -(ddd*ssx+dd*ssxd)
   q_x = -(dd*ssx)
   q_yd = -(ddd*ssy+dd*ssyd)
   q_y = -(dd*ssy)
   q_zd = -(ddd*ssz+dd*sszd)
   q_z = -(dd*ssz)
   por = half*rfilv
   IF (pork(i, j, k) .EQ. noflux) por = zero
   ! Compute the laminar and (if present) the eddy viscosities
   ! multiplied by the porosity. Compute the factor in front of
   ! the gradients of the speed of sound squared for the heat
   ! flux.
   muld = por*(rlvd(i, j, k)+rlvd(i, j, k+1))
   mul = por*(rlv(i, j, k)+rlv(i, j, k+1))
   IF (eddymodel) THEN
   mued = por*(revd(i, j, k)+revd(i, j, k+1))
   mue = por*(rev(i, j, k)+rev(i, j, k+1))
   END IF
   mutd = muld + mued
   mut = mul + mue
   gm1d = half*(gammad(i, j, k)+gammad(i, j, k+1))
   gm1 = half*(gamma(i, j, k)+gamma(i, j, k+1)) - one
   factlamheatd = -(one*prandtl*gm1d/(prandtl*gm1)**2)
   factlamheat = one/(prandtl*gm1)
   factturbheatd = -(one*prandtlturb*gm1d/(prandtlturb*gm1)**2)
   factturbheat = one/(prandtlturb*gm1)
   heatcoefd = muld*factlamheat + mul*factlamheatd + mued*&
   &           factturbheat + mue*factturbheatd
   heatcoef = mul*factlamheat + mue*factturbheat
   ! Compute the stress tensor and the heat flux vector.
   fracdivd = twothird*(u_xd+v_yd+w_zd)
   fracdiv = twothird*(u_x+v_y+w_z)
   tauxxd = mutd*(two*u_x-fracdiv) + mut*(two*u_xd-fracdivd)
   tauxx = mut*(two*u_x-fracdiv)
   tauyyd = mutd*(two*v_y-fracdiv) + mut*(two*v_yd-fracdivd)
   tauyy = mut*(two*v_y-fracdiv)
   tauzzd = mutd*(two*w_z-fracdiv) + mut*(two*w_zd-fracdivd)
   tauzz = mut*(two*w_z-fracdiv)
   tauxyd = mutd*(u_y+v_x) + mut*(u_yd+v_xd)
   tauxy = mut*(u_y+v_x)
   tauxzd = mutd*(u_z+w_x) + mut*(u_zd+w_xd)
   tauxz = mut*(u_z+w_x)
   tauyzd = mutd*(v_z+w_y) + mut*(v_zd+w_yd)
   tauyz = mut*(v_z+w_y)
   q_xd = heatcoefd*q_x + heatcoef*q_xd
   q_x = heatcoef*q_x
   q_yd = heatcoefd*q_y + heatcoef*q_yd
   q_y = heatcoef*q_y
   q_zd = heatcoefd*q_z + heatcoef*q_zd
   q_z = heatcoef*q_z
   ! Compute the average velocities for the face. Remember that
   ! the velocities are stored and not the momentum.
   ubard = half*(wd(i, j, k, ivx)+wd(i, j, k+1, ivx))
   ubar = half*(w(i, j, k, ivx)+w(i, j, k+1, ivx))
   vbard = half*(wd(i, j, k, ivy)+wd(i, j, k+1, ivy))
   vbar = half*(w(i, j, k, ivy)+w(i, j, k+1, ivy))
   wbard = half*(wd(i, j, k, ivz)+wd(i, j, k+1, ivz))
   wbar = half*(w(i, j, k, ivz)+w(i, j, k+1, ivz))
   ! Compute the viscous fluxes for this j-face.
   fmxd = tauxxd*sk(i, j, k, 1) + tauxx*skd(i, j, k, 1) + tauxyd*&
   &           sk(i, j, k, 2) + tauxy*skd(i, j, k, 2) + tauxzd*sk(i, j, k, &
   &           3) + tauxz*skd(i, j, k, 3)
   fmx = tauxx*sk(i, j, k, 1) + tauxy*sk(i, j, k, 2) + tauxz*sk(i&
   &           , j, k, 3)
   fmyd = tauxyd*sk(i, j, k, 1) + tauxy*skd(i, j, k, 1) + tauyyd*&
   &           sk(i, j, k, 2) + tauyy*skd(i, j, k, 2) + tauyzd*sk(i, j, k, &
   &           3) + tauyz*skd(i, j, k, 3)
   fmy = tauxy*sk(i, j, k, 1) + tauyy*sk(i, j, k, 2) + tauyz*sk(i&
   &           , j, k, 3)
   fmzd = tauxzd*sk(i, j, k, 1) + tauxz*skd(i, j, k, 1) + tauyzd*&
   &           sk(i, j, k, 2) + tauyz*skd(i, j, k, 2) + tauzzd*sk(i, j, k, &
   &           3) + tauzz*skd(i, j, k, 3)
   fmz = tauxz*sk(i, j, k, 1) + tauyz*sk(i, j, k, 2) + tauzz*sk(i&
   &           , j, k, 3)
   frhoed = (ubard*tauxx+ubar*tauxxd+vbard*tauxy+vbar*tauxyd+&
   &           wbard*tauxz+wbar*tauxzd)*sk(i, j, k, 1) + (ubar*tauxx+vbar*&
   &           tauxy+wbar*tauxz)*skd(i, j, k, 1) + (ubard*tauxy+ubar*tauxyd&
   &           +vbard*tauyy+vbar*tauyyd+wbard*tauyz+wbar*tauyzd)*sk(i, j, k&
   &           , 2) + (ubar*tauxy+vbar*tauyy+wbar*tauyz)*skd(i, j, k, 2) + &
   &           (ubard*tauxz+ubar*tauxzd+vbard*tauyz+vbar*tauyzd+wbard*tauzz&
   &           +wbar*tauzzd)*sk(i, j, k, 3) + (ubar*tauxz+vbar*tauyz+wbar*&
   &           tauzz)*skd(i, j, k, 3) - q_xd*sk(i, j, k, 1) - q_x*skd(i, j&
   &           , k, 1) - q_yd*sk(i, j, k, 2) - q_y*skd(i, j, k, 2) - q_zd*&
   &           sk(i, j, k, 3) - q_z*skd(i, j, k, 3)
   frhoe = (ubar*tauxx+vbar*tauxy+wbar*tauxz)*sk(i, j, k, 1) + (&
   &           ubar*tauxy+vbar*tauyy+wbar*tauyz)*sk(i, j, k, 2) + (ubar*&
   &           tauxz+vbar*tauyz+wbar*tauzz)*sk(i, j, k, 3) - q_x*sk(i, j, k&
   &           , 1) - q_y*sk(i, j, k, 2) - q_z*sk(i, j, k, 3)
   ! Update the residuals of cell j and j+1.
   fwd(i, j, k, imx) = fwd(i, j, k, imx) - fmxd
   fw(i, j, k, imx) = fw(i, j, k, imx) - fmx
   fwd(i, j, k, imy) = fwd(i, j, k, imy) - fmyd
   fw(i, j, k, imy) = fw(i, j, k, imy) - fmy
   fwd(i, j, k, imz) = fwd(i, j, k, imz) - fmzd
   fw(i, j, k, imz) = fw(i, j, k, imz) - fmz
   fwd(i, j, k, irhoe) = fwd(i, j, k, irhoe) - frhoed
   fw(i, j, k, irhoe) = fw(i, j, k, irhoe) - frhoe
   fwd(i, j, k+1, imx) = fwd(i, j, k+1, imx) + fmxd
   fw(i, j, k+1, imx) = fw(i, j, k+1, imx) + fmx
   fwd(i, j, k+1, imy) = fwd(i, j, k+1, imy) + fmyd
   fw(i, j, k+1, imy) = fw(i, j, k+1, imy) + fmy
   fwd(i, j, k+1, imz) = fwd(i, j, k+1, imz) + fmzd
   fw(i, j, k+1, imz) = fw(i, j, k+1, imz) + fmz
   fwd(i, j, k+1, irhoe) = fwd(i, j, k+1, irhoe) + frhoed
   fw(i, j, k+1, irhoe) = fw(i, j, k+1, irhoe) + frhoe
   END DO
   END DO
   END DO
   ! Restore the pressure in p. Again only the first layer of
   ! halo cells.
   DO k=1,ke
   DO j=1,je
   DO i=1,ie
   pd(i, j, k) = ((wd(i, j, k, irho)*p(i, j, k)+w(i, j, k, irho)*&
   &           pd(i, j, k))*gamma(i, j, k)-w(i, j, k, irho)*p(i, j, k)*&
   &           gammad(i, j, k))/gamma(i, j, k)**2
   p(i, j, k) = w(i, j, k, irho)*p(i, j, k)/gamma(i, j, k)
   END DO
   END DO
   END DO
   IF (correctfork) THEN
   DO k=1,ke
   DO j=1,je
   DO i=1,ie
   pd(i, j, k) = pd(i, j, k) + twothird*(wd(i, j, k, irho)*w(i&
   &             , j, k, itu1)+w(i, j, k, irho)*wd(i, j, k, itu1))
   p(i, j, k) = p(i, j, k) + twothird*w(i, j, k, irho)*w(i, j, &
   &             k, itu1)
   END DO
   END DO
   END DO
   END IF
   END IF
   END SUBROUTINE VISCOUSFLUXAPPROX_D
