   !        Generated by TAPENADE     (INRIA, Tropics team)
   !  Tapenade 3.7 (r4786) - 21 Feb 2013 15:53
   !
   !  Differentiation of invisciddissfluxmatrix in forward (tangent) mode (with options i4 dr8 r8):
   !   variations   of useful results: *fw
   !   with respect to varying inputs: *p *sfacei *sfacej *gamma *sfacek
   !                *w *si *sj *sk pinfcorr
   !   Plus diff mem management of: p:in sfacei:in sfacej:in gamma:in
   !                sfacek:in w:in si:in sj:in sk:in fw:in
   !
   !      ******************************************************************
   !      *                                                                *
   !      * File:          inviscidDissFluxMatrix.f90                      *
   !      * Author:        Edwin van der Weide                             *
   !      * Starting date: 03-25-2003                                      *
   !      * Last modified: 10-29-2007                                      *
   !      *                                                                *
   !      ******************************************************************
   !
   SUBROUTINE INVISCIDDISSFLUXMATRIX_D()
   USE FLOWVARREFSTATE
   USE CGNSGRID
   USE BLOCKPOINTERS_D
   USE INPUTPHYSICS
   USE INPUTDISCRETIZATION
   USE CONSTANTS
   USE ITERATION
   IMPLICIT NONE
   !
   !      ******************************************************************
   !      *                                                                *
   !      * inviscidDissFluxMatrix computes the matrix artificial          *
   !      * dissipation term. Instead of the spectral radius, as used in   *
   !      * the scalar dissipation scheme, the absolute value of the flux  *
   !      * jacobian is used. This leads to a less diffusive and           *
   !      * consequently more accurate scheme. It is assumed that the      *
   !      * pointers in blockPointers already point to the correct block.  *
   !      *                                                                *
   !      ******************************************************************
   !
   !
   !      Local parameters.
   !
   REAL(kind=realtype), PARAMETER :: dpmax=0.25_realType
   REAL(kind=realtype), PARAMETER :: epsacoustic=0.25_realType
   REAL(kind=realtype), PARAMETER :: epsshear=0.025_realType
   REAL(kind=realtype), PARAMETER :: omega=0.5_realType
   REAL(kind=realtype), PARAMETER :: oneminomega=one-omega
   !
   !      Local variables.
   !
   INTEGER(kind=inttype) :: i, j, k, ind
   REAL(kind=realtype) :: plim, sface
   REAL(kind=realtype) :: plimd, sfaced
   REAL(kind=realtype) :: sfil, fis2, fis4
   REAL(kind=realtype) :: gammaavg, gm1, ovgm1, gm53
   REAL(kind=realtype) :: gammaavgd, gm1d, ovgm1d, gm53d
   REAL(kind=realtype) :: ppor, rrad, dis2, dis4
   REAL(kind=realtype) :: rradd, dis2d, dis4d
   REAL(kind=realtype) :: dp1, dp2, ddw, tmp, fs
   REAL(kind=realtype) :: dp1d, dp2d, ddwd, tmpd, fsd
   REAL(kind=realtype) :: dr, dru, drv, drw, dre, drk, sx, sy, sz
   REAL(kind=realtype) :: drd, drud, drvd, drwd, dred, drkd, sxd, syd, &
   &  szd
   REAL(kind=realtype) :: uavg, vavg, wavg, a2avg, aavg, havg
   REAL(kind=realtype) :: uavgd, vavgd, wavgd, a2avgd, aavgd, havgd
   REAL(kind=realtype) :: alphaavg, unavg, ovaavg, ova2avg
   REAL(kind=realtype) :: alphaavgd, unavgd, ovaavgd, ova2avgd
   REAL(kind=realtype) :: kavg, lam1, lam2, lam3, area
   REAL(kind=realtype) :: kavgd, lam1d, lam2d, lam3d, aread
   REAL(kind=realtype) :: abv1, abv2, abv3, abv4, abv5, abv6, abv7
   REAL(kind=realtype) :: abv1d, abv2d, abv3d, abv4d, abv5d, abv6d, abv7d
   LOGICAL :: correctfork
   REAL(kind=realtype) :: DIM
   REAL(kind=realtype) :: DIM_D
   REAL(kind=realtype) :: arg1
   REAL(kind=realtype) :: arg1d
   REAL(kind=realtype) :: min5d
   REAL(kind=realtype) :: x6d
   REAL(kind=realtype) :: y4d
   REAL(kind=realtype) :: abs1d
   REAL(kind=realtype) :: min6
   REAL(kind=realtype) :: min5
   REAL(kind=realtype) :: min4
   REAL(kind=realtype) :: max2d
   REAL(kind=realtype) :: min3
   REAL(kind=realtype) :: min2
   REAL(kind=realtype) :: min1
   REAL(kind=realtype) :: abs4d
   REAL(kind=realtype) :: abs11d
   INTRINSIC MAX
   REAL(kind=realtype) :: abs7d
   REAL(kind=realtype) :: x6
   REAL(kind=realtype) :: x5
   REAL(kind=realtype) :: min1d
   REAL(kind=realtype) :: x4
   REAL(kind=realtype) :: x3
   INTRINSIC ABS
   REAL(kind=realtype) :: x2
   REAL(kind=realtype) :: x2d
   REAL(kind=realtype) :: x1
   REAL(kind=realtype) :: min4d
   REAL(kind=realtype) :: x5d
   REAL(kind=realtype) :: y3d
   REAL(kind=realtype) :: max1d
   REAL(kind=realtype) :: y6d
   REAL(kind=realtype) :: abs3d
   REAL(kind=realtype) :: abs10d
   REAL(kind=realtype) :: abs6d
   REAL(kind=realtype) :: abs12
   REAL(kind=realtype) :: x1d
   REAL(kind=realtype) :: abs11
   REAL(kind=realtype) :: abs10
   REAL(kind=realtype) :: abs9d
   REAL(kind=realtype) :: min3d
   REAL(kind=realtype) :: x4d
   REAL(kind=realtype) :: y2d
   REAL(kind=realtype) :: min6d
   REAL(kind=realtype) :: abs9
   REAL(kind=realtype) :: abs8
   REAL(kind=realtype) :: abs7
   REAL(kind=realtype) :: abs6
   REAL(kind=realtype) :: y5d
   REAL(kind=realtype) :: abs5
   REAL(kind=realtype) :: abs4
   REAL(kind=realtype) :: abs3
   REAL(kind=realtype) :: abs2
   REAL(kind=realtype) :: abs2d
   REAL(kind=realtype) :: abs1
   REAL(kind=realtype) :: abs0
   REAL(kind=realtype) :: max3d
   INTRINSIC MIN
   REAL(kind=realtype) :: abs5d
   REAL(kind=realtype) :: abs12d
   INTRINSIC SQRT
   REAL(kind=realtype) :: max3
   REAL(kind=realtype) :: max2
   REAL(kind=realtype) :: abs8d
   REAL(kind=realtype) :: y6
   REAL(kind=realtype) :: max1
   REAL(kind=realtype) :: y5
   REAL(kind=realtype) :: min2d
   REAL(kind=realtype) :: y4
   REAL(kind=realtype) :: y3
   REAL(kind=realtype) :: y2
   REAL(kind=realtype) :: x3d
   REAL(kind=realtype) :: y1
   REAL(kind=realtype) :: y1d
   IF (rfil .GE. 0.) THEN
   abs0 = rfil
   ELSE
   abs0 = -rfil
   END IF
   !
   !      ******************************************************************
   !      *                                                                *
   !      * Begin execution                                                *
   !      *                                                                *
   !      ******************************************************************
   !
   ! Check if rFil == 0. If so, the dissipative flux needs not to
   ! be computed.
   IF (abs0 .LT. thresholdreal) THEN
   fwd = 0.0_8
   RETURN
   ELSE
   ! Set the value of plim. To be fully consistent this must have
   ! the dimension of a pressure. Therefore a fraction of pInfCorr
   ! is used.
   plimd = 0.001_realType*pinfcorrd
   plim = 0.001_realType*pinfcorr
   ! Determine whether or not the total energy must be corrected
   ! for the presence of the turbulent kinetic energy.
   IF (kpresent) THEN
   IF (currentlevel .EQ. groundlevel .OR. turbcoupled) THEN
   correctfork = .true.
   ELSE
   correctfork = .false.
   END IF
   ELSE
   correctfork = .false.
   END IF
   ! Initialize sface to zero. This value will be used if the
   ! block is not moving.
   sface = zero
   ! Set a couple of constants for the scheme.
   fis2 = rfil*vis2
   fis4 = rfil*vis4
   sfil = one - rfil
   ! Initialize the dissipative residual to a certain times,
   ! possibly zero, the previously stored value. Owned cells
   ! only, because the halo values do not matter.
   DO k=2,kl
   DO j=2,jl
   DO i=2,il
   fwd(i, j, k, irho) = 0.0_8
   fw(i, j, k, irho) = sfil*fw(i, j, k, irho)
   fwd(i, j, k, imx) = 0.0_8
   fw(i, j, k, imx) = sfil*fw(i, j, k, imx)
   fwd(i, j, k, imy) = 0.0_8
   fw(i, j, k, imy) = sfil*fw(i, j, k, imy)
   fwd(i, j, k, imz) = 0.0_8
   fw(i, j, k, imz) = sfil*fw(i, j, k, imz)
   fwd(i, j, k, irhoe) = 0.0_8
   fw(i, j, k, irhoe) = sfil*fw(i, j, k, irhoe)
   END DO
   END DO
   END DO
   fwd = 0.0_8
   sfaced = 0.0_8
   !
   !      ******************************************************************
   !      *                                                                *
   !      * Dissipative fluxes in the i-direction.                         *
   !      *                                                                *
   !      ******************************************************************
   !
   DO k=2,kl
   DO j=2,jl
   IF (p(2, j, k) - p(1, j, k) .GE. 0.) THEN
   abs1d = pd(2, j, k) - pd(1, j, k)
   abs1 = p(2, j, k) - p(1, j, k)
   ELSE
   abs1d = -(pd(2, j, k)-pd(1, j, k))
   abs1 = -(p(2, j, k)-p(1, j, k))
   END IF
   IF (p(1, j, k) - p(0, j, k) .GE. 0.) THEN
   abs7d = pd(1, j, k) - pd(0, j, k)
   abs7 = p(1, j, k) - p(0, j, k)
   ELSE
   abs7d = -(pd(1, j, k)-pd(0, j, k))
   abs7 = -(p(1, j, k)-p(0, j, k))
   END IF
   x1d = ((pd(2, j, k)-two*pd(1, j, k)+pd(0, j, k))*(omega*(p(2, j&
   &          , k)+two*p(1, j, k)+p(0, j, k))+oneminomega*(abs1+abs7)+plim)-&
   &          (p(2, j, k)-two*p(1, j, k)+p(0, j, k))*(omega*(pd(2, j, k)+two&
   &          *pd(1, j, k)+pd(0, j, k))+oneminomega*(abs1d+abs7d)+plimd))/(&
   &          omega*(p(2, j, k)+two*p(1, j, k)+p(0, j, k))+oneminomega*(abs1&
   &          +abs7)+plim)**2
   x1 = (p(2, j, k)-two*p(1, j, k)+p(0, j, k))/(omega*(p(2, j, k)+&
   &          two*p(1, j, k)+p(0, j, k))+oneminomega*(abs1+abs7)+plim)
   IF (x1 .GE. 0.) THEN
   dp1d = x1d
   dp1 = x1
   ELSE
   dp1d = -x1d
   dp1 = -x1
   END IF
   ! Loop in i-direction.
   DO i=1,il
   IF (p(i+2, j, k) - p(i+1, j, k) .GE. 0.) THEN
   abs2d = pd(i+2, j, k) - pd(i+1, j, k)
   abs2 = p(i+2, j, k) - p(i+1, j, k)
   ELSE
   abs2d = -(pd(i+2, j, k)-pd(i+1, j, k))
   abs2 = -(p(i+2, j, k)-p(i+1, j, k))
   END IF
   IF (p(i+1, j, k) - p(i, j, k) .GE. 0.) THEN
   abs8d = pd(i+1, j, k) - pd(i, j, k)
   abs8 = p(i+1, j, k) - p(i, j, k)
   ELSE
   abs8d = -(pd(i+1, j, k)-pd(i, j, k))
   abs8 = -(p(i+1, j, k)-p(i, j, k))
   END IF
   x2d = ((pd(i+2, j, k)-two*pd(i+1, j, k)+pd(i, j, k))*(omega*(p&
   &            (i+2, j, k)+two*p(i+1, j, k)+p(i, j, k))+oneminomega*(abs2+&
   &            abs8)+plim)-(p(i+2, j, k)-two*p(i+1, j, k)+p(i, j, k))*(&
   &            omega*(pd(i+2, j, k)+two*pd(i+1, j, k)+pd(i, j, k))+&
   &            oneminomega*(abs2d+abs8d)+plimd))/(omega*(p(i+2, j, k)+two*p&
   &            (i+1, j, k)+p(i, j, k))+oneminomega*(abs2+abs8)+plim)**2
   x2 = (p(i+2, j, k)-two*p(i+1, j, k)+p(i, j, k))/(omega*(p(i+2&
   &            , j, k)+two*p(i+1, j, k)+p(i, j, k))+oneminomega*(abs2+abs8)&
   &            +plim)
   IF (x2 .GE. 0.) THEN
   dp2d = x2d
   dp2 = x2
   ELSE
   dp2d = -x2d
   dp2 = -x2
   END IF
   ! Compute the dissipation coefficients for this face.
   ppor = zero
   IF (pori(i, j, k) .EQ. normalflux) ppor = one
   IF (lumpeddiss) THEN
   IF (dp1 .LT. dp2) THEN
   y1d = dp2d
   y1 = dp2
   ELSE
   y1d = dp1d
   y1 = dp1
   END IF
   IF (dpmax .GT. y1) THEN
   min1d = y1d
   min1 = y1
   ELSE
   min1 = dpmax
   min1d = 0.0_8
   END IF
   dis2d = fis2*ppor*min1d
   dis2 = fis2*ppor*min1 + sigma*fis4*ppor
   dis4 = 0.0
   dis4d = 0.0_8
   ELSE
   IF (dp1 .LT. dp2) THEN
   y2d = dp2d
   y2 = dp2
   ELSE
   y2d = dp1d
   y2 = dp1
   END IF
   IF (dpmax .GT. y2) THEN
   min2d = y2d
   min2 = y2
   ELSE
   min2 = dpmax
   min2d = 0.0_8
   END IF
   dis2d = ppor*fis2*min2d
   dis2 = ppor*fis2*min2
   dis4d = DIM_D(ppor*fis4, 0.0_8, dis2, dis2d, dis4)
   END IF
   ! Construct the vector of the first and third differences
   ! multiplied by the appropriate constants.
   ddwd = wd(i+1, j, k, irho) - wd(i, j, k, irho)
   ddw = w(i+1, j, k, irho) - w(i, j, k, irho)
   drd = dis2d*ddw + dis2*ddwd - dis4d*(w(i+2, j, k, irho)-w(i-1&
   &            , j, k, irho)-three*ddw) - dis4*(wd(i+2, j, k, irho)-wd(i-1&
   &            , j, k, irho)-three*ddwd)
   dr = dis2*ddw - dis4*(w(i+2, j, k, irho)-w(i-1, j, k, irho)-&
   &            three*ddw)
   ddwd = wd(i+1, j, k, irho)*w(i+1, j, k, ivx) + w(i+1, j, k, &
   &            irho)*wd(i+1, j, k, ivx) - wd(i, j, k, irho)*w(i, j, k, ivx)&
   &            - w(i, j, k, irho)*wd(i, j, k, ivx)
   ddw = w(i+1, j, k, irho)*w(i+1, j, k, ivx) - w(i, j, k, irho)*&
   &            w(i, j, k, ivx)
   drud = dis2d*ddw + dis2*ddwd - dis4d*(w(i+2, j, k, irho)*w(i+2&
   &            , j, k, ivx)-w(i-1, j, k, irho)*w(i-1, j, k, ivx)-three*ddw)&
   &            - dis4*(wd(i+2, j, k, irho)*w(i+2, j, k, ivx)+w(i+2, j, k, &
   &            irho)*wd(i+2, j, k, ivx)-wd(i-1, j, k, irho)*w(i-1, j, k, &
   &            ivx)-w(i-1, j, k, irho)*wd(i-1, j, k, ivx)-three*ddwd)
   dru = dis2*ddw - dis4*(w(i+2, j, k, irho)*w(i+2, j, k, ivx)-w(&
   &            i-1, j, k, irho)*w(i-1, j, k, ivx)-three*ddw)
   ddwd = wd(i+1, j, k, irho)*w(i+1, j, k, ivy) + w(i+1, j, k, &
   &            irho)*wd(i+1, j, k, ivy) - wd(i, j, k, irho)*w(i, j, k, ivy)&
   &            - w(i, j, k, irho)*wd(i, j, k, ivy)
   ddw = w(i+1, j, k, irho)*w(i+1, j, k, ivy) - w(i, j, k, irho)*&
   &            w(i, j, k, ivy)
   drvd = dis2d*ddw + dis2*ddwd - dis4d*(w(i+2, j, k, irho)*w(i+2&
   &            , j, k, ivy)-w(i-1, j, k, irho)*w(i-1, j, k, ivy)-three*ddw)&
   &            - dis4*(wd(i+2, j, k, irho)*w(i+2, j, k, ivy)+w(i+2, j, k, &
   &            irho)*wd(i+2, j, k, ivy)-wd(i-1, j, k, irho)*w(i-1, j, k, &
   &            ivy)-w(i-1, j, k, irho)*wd(i-1, j, k, ivy)-three*ddwd)
   drv = dis2*ddw - dis4*(w(i+2, j, k, irho)*w(i+2, j, k, ivy)-w(&
   &            i-1, j, k, irho)*w(i-1, j, k, ivy)-three*ddw)
   ddwd = wd(i+1, j, k, irho)*w(i+1, j, k, ivz) + w(i+1, j, k, &
   &            irho)*wd(i+1, j, k, ivz) - wd(i, j, k, irho)*w(i, j, k, ivz)&
   &            - w(i, j, k, irho)*wd(i, j, k, ivz)
   ddw = w(i+1, j, k, irho)*w(i+1, j, k, ivz) - w(i, j, k, irho)*&
   &            w(i, j, k, ivz)
   drwd = dis2d*ddw + dis2*ddwd - dis4d*(w(i+2, j, k, irho)*w(i+2&
   &            , j, k, ivz)-w(i-1, j, k, irho)*w(i-1, j, k, ivz)-three*ddw)&
   &            - dis4*(wd(i+2, j, k, irho)*w(i+2, j, k, ivz)+w(i+2, j, k, &
   &            irho)*wd(i+2, j, k, ivz)-wd(i-1, j, k, irho)*w(i-1, j, k, &
   &            ivz)-w(i-1, j, k, irho)*wd(i-1, j, k, ivz)-three*ddwd)
   drw = dis2*ddw - dis4*(w(i+2, j, k, irho)*w(i+2, j, k, ivz)-w(&
   &            i-1, j, k, irho)*w(i-1, j, k, ivz)-three*ddw)
   ddwd = wd(i+1, j, k, irhoe) - wd(i, j, k, irhoe)
   ddw = w(i+1, j, k, irhoe) - w(i, j, k, irhoe)
   dred = dis2d*ddw + dis2*ddwd - dis4d*(w(i+2, j, k, irhoe)-w(i-&
   &            1, j, k, irhoe)-three*ddw) - dis4*(wd(i+2, j, k, irhoe)-wd(i&
   &            -1, j, k, irhoe)-three*ddwd)
   dre = dis2*ddw - dis4*(w(i+2, j, k, irhoe)-w(i-1, j, k, irhoe)&
   &            -three*ddw)
   ! In case a k-equation is present, compute the difference
   ! of rhok and store the average value of k. If not present,
   ! set both these values to zero, such that later on no
   ! decision needs to be made anymore.
   IF (correctfork) THEN
   ddwd = wd(i+1, j, k, irho)*w(i+1, j, k, itu1) + w(i+1, j, k&
   &              , irho)*wd(i+1, j, k, itu1) - wd(i, j, k, irho)*w(i, j, k&
   &              , itu1) - w(i, j, k, irho)*wd(i, j, k, itu1)
   ddw = w(i+1, j, k, irho)*w(i+1, j, k, itu1) - w(i, j, k, &
   &              irho)*w(i, j, k, itu1)
   drkd = dis2d*ddw + dis2*ddwd - dis4d*(w(i+2, j, k, irho)*w(i&
   &              +2, j, k, itu1)-w(i-1, j, k, irho)*w(i-1, j, k, itu1)-&
   &              three*ddw) - dis4*(wd(i+2, j, k, irho)*w(i+2, j, k, itu1)+&
   &              w(i+2, j, k, irho)*wd(i+2, j, k, itu1)-wd(i-1, j, k, irho)&
   &              *w(i-1, j, k, itu1)-w(i-1, j, k, irho)*wd(i-1, j, k, itu1)&
   &              -three*ddwd)
   drk = dis2*ddw - dis4*(w(i+2, j, k, irho)*w(i+2, j, k, itu1)&
   &              -w(i-1, j, k, irho)*w(i-1, j, k, itu1)-three*ddw)
   kavgd = half*(wd(i, j, k, itu1)+wd(i+1, j, k, itu1))
   kavg = half*(w(i, j, k, itu1)+w(i+1, j, k, itu1))
   ELSE
   drk = zero
   kavg = zero
   kavgd = 0.0_8
   drkd = 0.0_8
   END IF
   ! Compute the average value of gamma and compute some
   ! expressions in which it occurs.
   gammaavgd = half*(gammad(i+1, j, k)+gammad(i, j, k))
   gammaavg = half*(gamma(i+1, j, k)+gamma(i, j, k))
   gm1d = gammaavgd
   gm1 = gammaavg - one
   ovgm1d = -(one*gm1d/gm1**2)
   ovgm1 = one/gm1
   gm53d = gammaavgd
   gm53 = gammaavg - five*third
   ! Compute the average state at the interface.
   uavgd = half*(wd(i+1, j, k, ivx)+wd(i, j, k, ivx))
   uavg = half*(w(i+1, j, k, ivx)+w(i, j, k, ivx))
   vavgd = half*(wd(i+1, j, k, ivy)+wd(i, j, k, ivy))
   vavg = half*(w(i+1, j, k, ivy)+w(i, j, k, ivy))
   wavgd = half*(wd(i+1, j, k, ivz)+wd(i, j, k, ivz))
   wavg = half*(w(i+1, j, k, ivz)+w(i, j, k, ivz))
   a2avgd = half*(((gammad(i+1, j, k)*p(i+1, j, k)+gamma(i+1, j, &
   &            k)*pd(i+1, j, k))*w(i+1, j, k, irho)-gamma(i+1, j, k)*p(i+1&
   &            , j, k)*wd(i+1, j, k, irho))/w(i+1, j, k, irho)**2+((gammad(&
   &            i, j, k)*p(i, j, k)+gamma(i, j, k)*pd(i, j, k))*w(i, j, k, &
   &            irho)-gamma(i, j, k)*p(i, j, k)*wd(i, j, k, irho))/w(i, j, k&
   &            , irho)**2)
   a2avg = half*(gamma(i+1, j, k)*p(i+1, j, k)/w(i+1, j, k, irho)&
   &            +gamma(i, j, k)*p(i, j, k)/w(i, j, k, irho))
   sxd = sid(i, j, k, 1)
   sx = si(i, j, k, 1)
   syd = sid(i, j, k, 2)
   sy = si(i, j, k, 2)
   szd = sid(i, j, k, 3)
   sz = si(i, j, k, 3)
   arg1d = 2*sx*sxd + 2*sy*syd + 2*sz*szd
   arg1 = sx**2 + sy**2 + sz**2
   IF (arg1 .EQ. 0.0_8) THEN
   aread = 0.0_8
   ELSE
   aread = arg1d/(2.0*SQRT(arg1))
   END IF
   area = SQRT(arg1)
   IF (1.e-25_realType .LT. area) THEN
   max1d = aread
   max1 = area
   ELSE
   max1 = 1.e-25_realType
   max1d = 0.0_8
   END IF
   tmpd = -(one*max1d/max1**2)
   tmp = one/max1
   sxd = sxd*tmp + sx*tmpd
   sx = sx*tmp
   syd = syd*tmp + sy*tmpd
   sy = sy*tmp
   szd = szd*tmp + sz*tmpd
   sz = sz*tmp
   alphaavgd = half*(2*uavg*uavgd+2*vavg*vavgd+2*wavg*wavgd)
   alphaavg = half*(uavg**2+vavg**2+wavg**2)
   havgd = alphaavgd + ovgm1d*(a2avg-gm53*kavg) + ovgm1*(a2avgd-&
   &            gm53d*kavg-gm53*kavgd)
   havg = alphaavg + ovgm1*(a2avg-gm53*kavg)
   IF (a2avg .EQ. 0.0_8) THEN
   aavgd = 0.0_8
   ELSE
   aavgd = a2avgd/(2.0*SQRT(a2avg))
   END IF
   aavg = SQRT(a2avg)
   unavgd = uavgd*sx + uavg*sxd + vavgd*sy + vavg*syd + wavgd*sz &
   &            + wavg*szd
   unavg = uavg*sx + vavg*sy + wavg*sz
   ovaavgd = -(one*aavgd/aavg**2)
   ovaavg = one/aavg
   ova2avgd = -(one*a2avgd/a2avg**2)
   ova2avg = one/a2avg
   ! The mesh velocity if the face is moving. It must be
   ! divided by the area to obtain a true velocity.
   IF (addgridvelocities) THEN
   sfaced = sfaceid(i, j, k)*tmp + sfacei(i, j, k)*tmpd
   sface = sfacei(i, j, k)*tmp
   END IF
   IF (unavg - sface + aavg .GE. 0.) THEN
   lam1d = unavgd - sfaced + aavgd
   lam1 = unavg - sface + aavg
   ELSE
   lam1d = -(unavgd-sfaced+aavgd)
   lam1 = -(unavg-sface+aavg)
   END IF
   IF (unavg - sface - aavg .GE. 0.) THEN
   lam2d = unavgd - sfaced - aavgd
   lam2 = unavg - sface - aavg
   ELSE
   lam2d = -(unavgd-sfaced-aavgd)
   lam2 = -(unavg-sface-aavg)
   END IF
   IF (unavg - sface .GE. 0.) THEN
   lam3d = unavgd - sfaced
   lam3 = unavg - sface
   ELSE
   lam3d = -(unavgd-sfaced)
   lam3 = -(unavg-sface)
   END IF
   rradd = lam3d + aavgd
   rrad = lam3 + aavg
   IF (lam1 .LT. epsacoustic*rrad) THEN
   lam1d = epsacoustic*rradd
   lam1 = epsacoustic*rrad
   ELSE
   lam1 = lam1
   END IF
   IF (lam2 .LT. epsacoustic*rrad) THEN
   lam2d = epsacoustic*rradd
   lam2 = epsacoustic*rrad
   ELSE
   lam2 = lam2
   END IF
   IF (lam3 .LT. epsshear*rrad) THEN
   lam3d = epsshear*rradd
   lam3 = epsshear*rrad
   ELSE
   lam3 = lam3
   END IF
   ! Multiply the eigenvalues by the area to obtain
   ! the correct values for the dissipation term.
   lam1d = lam1d*area + lam1*aread
   lam1 = lam1*area
   lam2d = lam2d*area + lam2*aread
   lam2 = lam2*area
   lam3d = lam3d*area + lam3*aread
   lam3 = lam3*area
   ! Some abbreviations, which occur quite often in the
   ! dissipation terms.
   abv1d = half*(lam1d+lam2d)
   abv1 = half*(lam1+lam2)
   abv2d = half*(lam1d-lam2d)
   abv2 = half*(lam1-lam2)
   abv3d = abv1d - lam3d
   abv3 = abv1 - lam3
   abv4d = gm1d*(alphaavg*dr-uavg*dru-vavg*drv-wavg*drw+dre) + &
   &            gm1*(alphaavgd*dr+alphaavg*drd-uavgd*dru-uavg*drud-vavgd*drv&
   &            -vavg*drvd-wavgd*drw-wavg*drwd+dred) - gm53d*drk - gm53*drkd
   abv4 = gm1*(alphaavg*dr-uavg*dru-vavg*drv-wavg*drw+dre) - gm53&
   &            *drk
   abv5d = sxd*dru + sx*drud + syd*drv + sy*drvd + szd*drw + sz*&
   &            drwd - unavgd*dr - unavg*drd
   abv5 = sx*dru + sy*drv + sz*drw - unavg*dr
   abv6d = (abv3d*abv4+abv3*abv4d)*ova2avg + abv3*abv4*ova2avgd +&
   &            (abv2d*abv5+abv2*abv5d)*ovaavg + abv2*abv5*ovaavgd
   abv6 = abv3*abv4*ova2avg + abv2*abv5*ovaavg
   abv7d = (abv2d*abv4+abv2*abv4d)*ovaavg + abv2*abv4*ovaavgd + &
   &            abv3d*abv5 + abv3*abv5d
   abv7 = abv2*abv4*ovaavg + abv3*abv5
   ! Compute and scatter the dissipative flux.
   ! Density.
   fsd = lam3d*dr + lam3*drd + abv6d
   fs = lam3*dr + abv6
   fwd(i+1, j, k, irho) = fwd(i+1, j, k, irho) + fsd
   fw(i+1, j, k, irho) = fw(i+1, j, k, irho) + fs
   fwd(i, j, k, irho) = fwd(i, j, k, irho) - fsd
   fw(i, j, k, irho) = fw(i, j, k, irho) - fs
   ! X-momentum.
   fsd = lam3d*dru + lam3*drud + uavgd*abv6 + uavg*abv6d + sxd*&
   &            abv7 + sx*abv7d
   fs = lam3*dru + uavg*abv6 + sx*abv7
   fwd(i+1, j, k, imx) = fwd(i+1, j, k, imx) + fsd
   fw(i+1, j, k, imx) = fw(i+1, j, k, imx) + fs
   fwd(i, j, k, imx) = fwd(i, j, k, imx) - fsd
   fw(i, j, k, imx) = fw(i, j, k, imx) - fs
   ! Y-momentum.
   fsd = lam3d*drv + lam3*drvd + vavgd*abv6 + vavg*abv6d + syd*&
   &            abv7 + sy*abv7d
   fs = lam3*drv + vavg*abv6 + sy*abv7
   fwd(i+1, j, k, imy) = fwd(i+1, j, k, imy) + fsd
   fw(i+1, j, k, imy) = fw(i+1, j, k, imy) + fs
   fwd(i, j, k, imy) = fwd(i, j, k, imy) - fsd
   fw(i, j, k, imy) = fw(i, j, k, imy) - fs
   ! Z-momentum.
   fsd = lam3d*drw + lam3*drwd + wavgd*abv6 + wavg*abv6d + szd*&
   &            abv7 + sz*abv7d
   fs = lam3*drw + wavg*abv6 + sz*abv7
   fwd(i+1, j, k, imz) = fwd(i+1, j, k, imz) + fsd
   fw(i+1, j, k, imz) = fw(i+1, j, k, imz) + fs
   fwd(i, j, k, imz) = fwd(i, j, k, imz) - fsd
   fw(i, j, k, imz) = fw(i, j, k, imz) - fs
   ! Energy.
   fsd = lam3d*dre + lam3*dred + havgd*abv6 + havg*abv6d + unavgd&
   &            *abv7 + unavg*abv7d
   fs = lam3*dre + havg*abv6 + unavg*abv7
   fwd(i+1, j, k, irhoe) = fwd(i+1, j, k, irhoe) + fsd
   fw(i+1, j, k, irhoe) = fw(i+1, j, k, irhoe) + fs
   fwd(i, j, k, irhoe) = fwd(i, j, k, irhoe) - fsd
   fw(i, j, k, irhoe) = fw(i, j, k, irhoe) - fs
   ! Set dp1 to dp2 for the next face.
   dp1d = dp2d
   dp1 = dp2
   END DO
   END DO
   END DO
   !
   !      ******************************************************************
   !      *                                                                *
   !      * Dissipative fluxes in the j-direction.                         *
   !      *                                                                *
   !      ******************************************************************
   !
   DO k=2,kl
   DO i=2,il
   IF (p(i, 2, k) - p(i, 1, k) .GE. 0.) THEN
   abs3d = pd(i, 2, k) - pd(i, 1, k)
   abs3 = p(i, 2, k) - p(i, 1, k)
   ELSE
   abs3d = -(pd(i, 2, k)-pd(i, 1, k))
   abs3 = -(p(i, 2, k)-p(i, 1, k))
   END IF
   IF (p(i, 1, k) - p(i, 0, k) .GE. 0.) THEN
   abs9d = pd(i, 1, k) - pd(i, 0, k)
   abs9 = p(i, 1, k) - p(i, 0, k)
   ELSE
   abs9d = -(pd(i, 1, k)-pd(i, 0, k))
   abs9 = -(p(i, 1, k)-p(i, 0, k))
   END IF
   x3d = ((pd(i, 2, k)-two*pd(i, 1, k)+pd(i, 0, k))*(omega*(p(i, 2&
   &          , k)+two*p(i, 1, k)+p(i, 0, k))+oneminomega*(abs3+abs9)+plim)-&
   &          (p(i, 2, k)-two*p(i, 1, k)+p(i, 0, k))*(omega*(pd(i, 2, k)+two&
   &          *pd(i, 1, k)+pd(i, 0, k))+oneminomega*(abs3d+abs9d)+plimd))/(&
   &          omega*(p(i, 2, k)+two*p(i, 1, k)+p(i, 0, k))+oneminomega*(abs3&
   &          +abs9)+plim)**2
   x3 = (p(i, 2, k)-two*p(i, 1, k)+p(i, 0, k))/(omega*(p(i, 2, k)+&
   &          two*p(i, 1, k)+p(i, 0, k))+oneminomega*(abs3+abs9)+plim)
   IF (x3 .GE. 0.) THEN
   dp1d = x3d
   dp1 = x3
   ELSE
   dp1d = -x3d
   dp1 = -x3
   END IF
   ! Loop in j-direction.
   DO j=1,jl
   IF (p(i, j+2, k) - p(i, j+1, k) .GE. 0.) THEN
   abs4d = pd(i, j+2, k) - pd(i, j+1, k)
   abs4 = p(i, j+2, k) - p(i, j+1, k)
   ELSE
   abs4d = -(pd(i, j+2, k)-pd(i, j+1, k))
   abs4 = -(p(i, j+2, k)-p(i, j+1, k))
   END IF
   IF (p(i, j+1, k) - p(i, j, k) .GE. 0.) THEN
   abs10d = pd(i, j+1, k) - pd(i, j, k)
   abs10 = p(i, j+1, k) - p(i, j, k)
   ELSE
   abs10d = -(pd(i, j+1, k)-pd(i, j, k))
   abs10 = -(p(i, j+1, k)-p(i, j, k))
   END IF
   x4d = ((pd(i, j+2, k)-two*pd(i, j+1, k)+pd(i, j, k))*(omega*(p&
   &            (i, j+2, k)+two*p(i, j+1, k)+p(i, j, k))+oneminomega*(abs4+&
   &            abs10)+plim)-(p(i, j+2, k)-two*p(i, j+1, k)+p(i, j, k))*(&
   &            omega*(pd(i, j+2, k)+two*pd(i, j+1, k)+pd(i, j, k))+&
   &            oneminomega*(abs4d+abs10d)+plimd))/(omega*(p(i, j+2, k)+two*&
   &            p(i, j+1, k)+p(i, j, k))+oneminomega*(abs4+abs10)+plim)**2
   x4 = (p(i, j+2, k)-two*p(i, j+1, k)+p(i, j, k))/(omega*(p(i, j&
   &            +2, k)+two*p(i, j+1, k)+p(i, j, k))+oneminomega*(abs4+abs10)&
   &            +plim)
   IF (x4 .GE. 0.) THEN
   dp2d = x4d
   dp2 = x4
   ELSE
   dp2d = -x4d
   dp2 = -x4
   END IF
   ! Compute the dissipation coefficients for this face.
   ppor = zero
   IF (porj(i, j, k) .EQ. normalflux) ppor = one
   IF (lumpeddiss) THEN
   IF (dp1 .LT. dp2) THEN
   y3d = dp2d
   y3 = dp2
   ELSE
   y3d = dp1d
   y3 = dp1
   END IF
   IF (dpmax .GT. y3) THEN
   min3d = y3d
   min3 = y3
   ELSE
   min3 = dpmax
   min3d = 0.0_8
   END IF
   dis2d = fis2*ppor*min3d
   dis2 = fis2*ppor*min3 + sigma*fis4*ppor
   dis4 = 0.0
   dis4d = 0.0_8
   ELSE
   IF (dp1 .LT. dp2) THEN
   y4d = dp2d
   y4 = dp2
   ELSE
   y4d = dp1d
   y4 = dp1
   END IF
   IF (dpmax .GT. y4) THEN
   min4d = y4d
   min4 = y4
   ELSE
   min4 = dpmax
   min4d = 0.0_8
   END IF
   dis2d = ppor*fis2*min4d
   dis2 = ppor*fis2*min4
   dis4d = DIM_D(ppor*fis4, 0.0_8, dis2, dis2d, dis4)
   END IF
   ! Construct the vector of the first and third differences
   ! multiplied by the appropriate constants.
   ddwd = wd(i, j+1, k, irho) - wd(i, j, k, irho)
   ddw = w(i, j+1, k, irho) - w(i, j, k, irho)
   drd = dis2d*ddw + dis2*ddwd - dis4d*(w(i, j+2, k, irho)-w(i, j&
   &            -1, k, irho)-three*ddw) - dis4*(wd(i, j+2, k, irho)-wd(i, j-&
   &            1, k, irho)-three*ddwd)
   dr = dis2*ddw - dis4*(w(i, j+2, k, irho)-w(i, j-1, k, irho)-&
   &            three*ddw)
   ddwd = wd(i, j+1, k, irho)*w(i, j+1, k, ivx) + w(i, j+1, k, &
   &            irho)*wd(i, j+1, k, ivx) - wd(i, j, k, irho)*w(i, j, k, ivx)&
   &            - w(i, j, k, irho)*wd(i, j, k, ivx)
   ddw = w(i, j+1, k, irho)*w(i, j+1, k, ivx) - w(i, j, k, irho)*&
   &            w(i, j, k, ivx)
   drud = dis2d*ddw + dis2*ddwd - dis4d*(w(i, j+2, k, irho)*w(i, &
   &            j+2, k, ivx)-w(i, j-1, k, irho)*w(i, j-1, k, ivx)-three*ddw)&
   &            - dis4*(wd(i, j+2, k, irho)*w(i, j+2, k, ivx)+w(i, j+2, k, &
   &            irho)*wd(i, j+2, k, ivx)-wd(i, j-1, k, irho)*w(i, j-1, k, &
   &            ivx)-w(i, j-1, k, irho)*wd(i, j-1, k, ivx)-three*ddwd)
   dru = dis2*ddw - dis4*(w(i, j+2, k, irho)*w(i, j+2, k, ivx)-w(&
   &            i, j-1, k, irho)*w(i, j-1, k, ivx)-three*ddw)
   ddwd = wd(i, j+1, k, irho)*w(i, j+1, k, ivy) + w(i, j+1, k, &
   &            irho)*wd(i, j+1, k, ivy) - wd(i, j, k, irho)*w(i, j, k, ivy)&
   &            - w(i, j, k, irho)*wd(i, j, k, ivy)
   ddw = w(i, j+1, k, irho)*w(i, j+1, k, ivy) - w(i, j, k, irho)*&
   &            w(i, j, k, ivy)
   drvd = dis2d*ddw + dis2*ddwd - dis4d*(w(i, j+2, k, irho)*w(i, &
   &            j+2, k, ivy)-w(i, j-1, k, irho)*w(i, j-1, k, ivy)-three*ddw)&
   &            - dis4*(wd(i, j+2, k, irho)*w(i, j+2, k, ivy)+w(i, j+2, k, &
   &            irho)*wd(i, j+2, k, ivy)-wd(i, j-1, k, irho)*w(i, j-1, k, &
   &            ivy)-w(i, j-1, k, irho)*wd(i, j-1, k, ivy)-three*ddwd)
   drv = dis2*ddw - dis4*(w(i, j+2, k, irho)*w(i, j+2, k, ivy)-w(&
   &            i, j-1, k, irho)*w(i, j-1, k, ivy)-three*ddw)
   ddwd = wd(i, j+1, k, irho)*w(i, j+1, k, ivz) + w(i, j+1, k, &
   &            irho)*wd(i, j+1, k, ivz) - wd(i, j, k, irho)*w(i, j, k, ivz)&
   &            - w(i, j, k, irho)*wd(i, j, k, ivz)
   ddw = w(i, j+1, k, irho)*w(i, j+1, k, ivz) - w(i, j, k, irho)*&
   &            w(i, j, k, ivz)
   drwd = dis2d*ddw + dis2*ddwd - dis4d*(w(i, j+2, k, irho)*w(i, &
   &            j+2, k, ivz)-w(i, j-1, k, irho)*w(i, j-1, k, ivz)-three*ddw)&
   &            - dis4*(wd(i, j+2, k, irho)*w(i, j+2, k, ivz)+w(i, j+2, k, &
   &            irho)*wd(i, j+2, k, ivz)-wd(i, j-1, k, irho)*w(i, j-1, k, &
   &            ivz)-w(i, j-1, k, irho)*wd(i, j-1, k, ivz)-three*ddwd)
   drw = dis2*ddw - dis4*(w(i, j+2, k, irho)*w(i, j+2, k, ivz)-w(&
   &            i, j-1, k, irho)*w(i, j-1, k, ivz)-three*ddw)
   ddwd = wd(i, j+1, k, irhoe) - wd(i, j, k, irhoe)
   ddw = w(i, j+1, k, irhoe) - w(i, j, k, irhoe)
   dred = dis2d*ddw + dis2*ddwd - dis4d*(w(i, j+2, k, irhoe)-w(i&
   &            , j-1, k, irhoe)-three*ddw) - dis4*(wd(i, j+2, k, irhoe)-wd(&
   &            i, j-1, k, irhoe)-three*ddwd)
   dre = dis2*ddw - dis4*(w(i, j+2, k, irhoe)-w(i, j-1, k, irhoe)&
   &            -three*ddw)
   ! In case a k-equation is present, compute the difference
   ! of rhok and store the average value of k. If not present,
   ! set both these values to zero, such that later on no
   ! decision needs to be made anymore.
   IF (correctfork) THEN
   ddwd = wd(i, j+1, k, irho)*w(i, j+1, k, itu1) + w(i, j+1, k&
   &              , irho)*wd(i, j+1, k, itu1) - wd(i, j, k, irho)*w(i, j, k&
   &              , itu1) - w(i, j, k, irho)*wd(i, j, k, itu1)
   ddw = w(i, j+1, k, irho)*w(i, j+1, k, itu1) - w(i, j, k, &
   &              irho)*w(i, j, k, itu1)
   drkd = dis2d*ddw + dis2*ddwd - dis4d*(w(i, j+2, k, irho)*w(i&
   &              , j+2, k, itu1)-w(i, j-1, k, irho)*w(i, j-1, k, itu1)-&
   &              three*ddw) - dis4*(wd(i, j+2, k, irho)*w(i, j+2, k, itu1)+&
   &              w(i, j+2, k, irho)*wd(i, j+2, k, itu1)-wd(i, j-1, k, irho)&
   &              *w(i, j-1, k, itu1)-w(i, j-1, k, irho)*wd(i, j-1, k, itu1)&
   &              -three*ddwd)
   drk = dis2*ddw - dis4*(w(i, j+2, k, irho)*w(i, j+2, k, itu1)&
   &              -w(i, j-1, k, irho)*w(i, j-1, k, itu1)-three*ddw)
   kavgd = half*(wd(i, j, k, itu1)+wd(i, j+1, k, itu1))
   kavg = half*(w(i, j, k, itu1)+w(i, j+1, k, itu1))
   ELSE
   drk = zero
   kavg = zero
   kavgd = 0.0_8
   drkd = 0.0_8
   END IF
   ! Compute the average value of gamma and compute some
   ! expressions in which it occurs.
   gammaavgd = half*(gammad(i, j+1, k)+gammad(i, j, k))
   gammaavg = half*(gamma(i, j+1, k)+gamma(i, j, k))
   gm1d = gammaavgd
   gm1 = gammaavg - one
   ovgm1d = -(one*gm1d/gm1**2)
   ovgm1 = one/gm1
   gm53d = gammaavgd
   gm53 = gammaavg - five*third
   ! Compute the average state at the interface.
   uavgd = half*(wd(i, j+1, k, ivx)+wd(i, j, k, ivx))
   uavg = half*(w(i, j+1, k, ivx)+w(i, j, k, ivx))
   vavgd = half*(wd(i, j+1, k, ivy)+wd(i, j, k, ivy))
   vavg = half*(w(i, j+1, k, ivy)+w(i, j, k, ivy))
   wavgd = half*(wd(i, j+1, k, ivz)+wd(i, j, k, ivz))
   wavg = half*(w(i, j+1, k, ivz)+w(i, j, k, ivz))
   a2avgd = half*(((gammad(i, j+1, k)*p(i, j+1, k)+gamma(i, j+1, &
   &            k)*pd(i, j+1, k))*w(i, j+1, k, irho)-gamma(i, j+1, k)*p(i, j&
   &            +1, k)*wd(i, j+1, k, irho))/w(i, j+1, k, irho)**2+((gammad(i&
   &            , j, k)*p(i, j, k)+gamma(i, j, k)*pd(i, j, k))*w(i, j, k, &
   &            irho)-gamma(i, j, k)*p(i, j, k)*wd(i, j, k, irho))/w(i, j, k&
   &            , irho)**2)
   a2avg = half*(gamma(i, j+1, k)*p(i, j+1, k)/w(i, j+1, k, irho)&
   &            +gamma(i, j, k)*p(i, j, k)/w(i, j, k, irho))
   sxd = sjd(i, j, k, 1)
   sx = sj(i, j, k, 1)
   syd = sjd(i, j, k, 2)
   sy = sj(i, j, k, 2)
   szd = sjd(i, j, k, 3)
   sz = sj(i, j, k, 3)
   arg1d = 2*sx*sxd + 2*sy*syd + 2*sz*szd
   arg1 = sx**2 + sy**2 + sz**2
   IF (arg1 .EQ. 0.0_8) THEN
   aread = 0.0_8
   ELSE
   aread = arg1d/(2.0*SQRT(arg1))
   END IF
   area = SQRT(arg1)
   IF (1.e-25_realType .LT. area) THEN
   max2d = aread
   max2 = area
   ELSE
   max2 = 1.e-25_realType
   max2d = 0.0_8
   END IF
   tmpd = -(one*max2d/max2**2)
   tmp = one/max2
   sxd = sxd*tmp + sx*tmpd
   sx = sx*tmp
   syd = syd*tmp + sy*tmpd
   sy = sy*tmp
   szd = szd*tmp + sz*tmpd
   sz = sz*tmp
   alphaavgd = half*(2*uavg*uavgd+2*vavg*vavgd+2*wavg*wavgd)
   alphaavg = half*(uavg**2+vavg**2+wavg**2)
   havgd = alphaavgd + ovgm1d*(a2avg-gm53*kavg) + ovgm1*(a2avgd-&
   &            gm53d*kavg-gm53*kavgd)
   havg = alphaavg + ovgm1*(a2avg-gm53*kavg)
   IF (a2avg .EQ. 0.0_8) THEN
   aavgd = 0.0_8
   ELSE
   aavgd = a2avgd/(2.0*SQRT(a2avg))
   END IF
   aavg = SQRT(a2avg)
   unavgd = uavgd*sx + uavg*sxd + vavgd*sy + vavg*syd + wavgd*sz &
   &            + wavg*szd
   unavg = uavg*sx + vavg*sy + wavg*sz
   ovaavgd = -(one*aavgd/aavg**2)
   ovaavg = one/aavg
   ova2avgd = -(one*a2avgd/a2avg**2)
   ova2avg = one/a2avg
   ! The mesh velocity if the face is moving. It must be
   ! divided by the area to obtain a true velocity.
   IF (addgridvelocities) THEN
   sfaced = sfacejd(i, j, k)*tmp + sfacej(i, j, k)*tmpd
   sface = sfacej(i, j, k)*tmp
   END IF
   IF (unavg - sface + aavg .GE. 0.) THEN
   lam1d = unavgd - sfaced + aavgd
   lam1 = unavg - sface + aavg
   ELSE
   lam1d = -(unavgd-sfaced+aavgd)
   lam1 = -(unavg-sface+aavg)
   END IF
   IF (unavg - sface - aavg .GE. 0.) THEN
   lam2d = unavgd - sfaced - aavgd
   lam2 = unavg - sface - aavg
   ELSE
   lam2d = -(unavgd-sfaced-aavgd)
   lam2 = -(unavg-sface-aavg)
   END IF
   IF (unavg - sface .GE. 0.) THEN
   lam3d = unavgd - sfaced
   lam3 = unavg - sface
   ELSE
   lam3d = -(unavgd-sfaced)
   lam3 = -(unavg-sface)
   END IF
   rradd = lam3d + aavgd
   rrad = lam3 + aavg
   IF (lam1 .LT. epsacoustic*rrad) THEN
   lam1d = epsacoustic*rradd
   lam1 = epsacoustic*rrad
   ELSE
   lam1 = lam1
   END IF
   IF (lam2 .LT. epsacoustic*rrad) THEN
   lam2d = epsacoustic*rradd
   lam2 = epsacoustic*rrad
   ELSE
   lam2 = lam2
   END IF
   IF (lam3 .LT. epsshear*rrad) THEN
   lam3d = epsshear*rradd
   lam3 = epsshear*rrad
   ELSE
   lam3 = lam3
   END IF
   ! Multiply the eigenvalues by the area to obtain
   ! the correct values for the dissipation term.
   lam1d = lam1d*area + lam1*aread
   lam1 = lam1*area
   lam2d = lam2d*area + lam2*aread
   lam2 = lam2*area
   lam3d = lam3d*area + lam3*aread
   lam3 = lam3*area
   ! Some abbreviations, which occur quite often in the
   ! dissipation terms.
   abv1d = half*(lam1d+lam2d)
   abv1 = half*(lam1+lam2)
   abv2d = half*(lam1d-lam2d)
   abv2 = half*(lam1-lam2)
   abv3d = abv1d - lam3d
   abv3 = abv1 - lam3
   abv4d = gm1d*(alphaavg*dr-uavg*dru-vavg*drv-wavg*drw+dre) + &
   &            gm1*(alphaavgd*dr+alphaavg*drd-uavgd*dru-uavg*drud-vavgd*drv&
   &            -vavg*drvd-wavgd*drw-wavg*drwd+dred) - gm53d*drk - gm53*drkd
   abv4 = gm1*(alphaavg*dr-uavg*dru-vavg*drv-wavg*drw+dre) - gm53&
   &            *drk
   abv5d = sxd*dru + sx*drud + syd*drv + sy*drvd + szd*drw + sz*&
   &            drwd - unavgd*dr - unavg*drd
   abv5 = sx*dru + sy*drv + sz*drw - unavg*dr
   abv6d = (abv3d*abv4+abv3*abv4d)*ova2avg + abv3*abv4*ova2avgd +&
   &            (abv2d*abv5+abv2*abv5d)*ovaavg + abv2*abv5*ovaavgd
   abv6 = abv3*abv4*ova2avg + abv2*abv5*ovaavg
   abv7d = (abv2d*abv4+abv2*abv4d)*ovaavg + abv2*abv4*ovaavgd + &
   &            abv3d*abv5 + abv3*abv5d
   abv7 = abv2*abv4*ovaavg + abv3*abv5
   ! Compute and scatter the dissipative flux.
   ! Density.
   fsd = lam3d*dr + lam3*drd + abv6d
   fs = lam3*dr + abv6
   fwd(i, j+1, k, irho) = fwd(i, j+1, k, irho) + fsd
   fw(i, j+1, k, irho) = fw(i, j+1, k, irho) + fs
   fwd(i, j, k, irho) = fwd(i, j, k, irho) - fsd
   fw(i, j, k, irho) = fw(i, j, k, irho) - fs
   ! X-momentum.
   fsd = lam3d*dru + lam3*drud + uavgd*abv6 + uavg*abv6d + sxd*&
   &            abv7 + sx*abv7d
   fs = lam3*dru + uavg*abv6 + sx*abv7
   fwd(i, j+1, k, imx) = fwd(i, j+1, k, imx) + fsd
   fw(i, j+1, k, imx) = fw(i, j+1, k, imx) + fs
   fwd(i, j, k, imx) = fwd(i, j, k, imx) - fsd
   fw(i, j, k, imx) = fw(i, j, k, imx) - fs
   ! Y-momentum.
   fsd = lam3d*drv + lam3*drvd + vavgd*abv6 + vavg*abv6d + syd*&
   &            abv7 + sy*abv7d
   fs = lam3*drv + vavg*abv6 + sy*abv7
   fwd(i, j+1, k, imy) = fwd(i, j+1, k, imy) + fsd
   fw(i, j+1, k, imy) = fw(i, j+1, k, imy) + fs
   fwd(i, j, k, imy) = fwd(i, j, k, imy) - fsd
   fw(i, j, k, imy) = fw(i, j, k, imy) - fs
   ! Z-momentum.
   fsd = lam3d*drw + lam3*drwd + wavgd*abv6 + wavg*abv6d + szd*&
   &            abv7 + sz*abv7d
   fs = lam3*drw + wavg*abv6 + sz*abv7
   fwd(i, j+1, k, imz) = fwd(i, j+1, k, imz) + fsd
   fw(i, j+1, k, imz) = fw(i, j+1, k, imz) + fs
   fwd(i, j, k, imz) = fwd(i, j, k, imz) - fsd
   fw(i, j, k, imz) = fw(i, j, k, imz) - fs
   ! Energy.
   fsd = lam3d*dre + lam3*dred + havgd*abv6 + havg*abv6d + unavgd&
   &            *abv7 + unavg*abv7d
   fs = lam3*dre + havg*abv6 + unavg*abv7
   fwd(i, j+1, k, irhoe) = fwd(i, j+1, k, irhoe) + fsd
   fw(i, j+1, k, irhoe) = fw(i, j+1, k, irhoe) + fs
   fwd(i, j, k, irhoe) = fwd(i, j, k, irhoe) - fsd
   fw(i, j, k, irhoe) = fw(i, j, k, irhoe) - fs
   ! Set dp1 to dp2 for the next face.
   dp1d = dp2d
   dp1 = dp2
   END DO
   END DO
   END DO
   !
   !      ******************************************************************
   !      *                                                                *
   !      * Dissipative fluxes in the k-direction.                         *
   !      *                                                                *
   !      ******************************************************************
   !
   DO j=2,jl
   DO i=2,il
   IF (p(i, j, 2) - p(i, j, 1) .GE. 0.) THEN
   abs5d = pd(i, j, 2) - pd(i, j, 1)
   abs5 = p(i, j, 2) - p(i, j, 1)
   ELSE
   abs5d = -(pd(i, j, 2)-pd(i, j, 1))
   abs5 = -(p(i, j, 2)-p(i, j, 1))
   END IF
   IF (p(i, j, 1) - p(i, j, 0) .GE. 0.) THEN
   abs11d = pd(i, j, 1) - pd(i, j, 0)
   abs11 = p(i, j, 1) - p(i, j, 0)
   ELSE
   abs11d = -(pd(i, j, 1)-pd(i, j, 0))
   abs11 = -(p(i, j, 1)-p(i, j, 0))
   END IF
   x5d = ((pd(i, j, 2)-two*pd(i, j, 1)+pd(i, j, 0))*(omega*(p(i, j&
   &          , 2)+two*p(i, j, 1)+p(i, j, 0))+oneminomega*(abs5+abs11)+plim)&
   &          -(p(i, j, 2)-two*p(i, j, 1)+p(i, j, 0))*(omega*(pd(i, j, 2)+&
   &          two*pd(i, j, 1)+pd(i, j, 0))+oneminomega*(abs5d+abs11d)+plimd)&
   &          )/(omega*(p(i, j, 2)+two*p(i, j, 1)+p(i, j, 0))+oneminomega*(&
   &          abs5+abs11)+plim)**2
   x5 = (p(i, j, 2)-two*p(i, j, 1)+p(i, j, 0))/(omega*(p(i, j, 2)+&
   &          two*p(i, j, 1)+p(i, j, 0))+oneminomega*(abs5+abs11)+plim)
   IF (x5 .GE. 0.) THEN
   dp1d = x5d
   dp1 = x5
   ELSE
   dp1d = -x5d
   dp1 = -x5
   END IF
   ! Loop in k-direction.
   DO k=1,kl
   IF (p(i, j, k+2) - p(i, j, k+1) .GE. 0.) THEN
   abs6d = pd(i, j, k+2) - pd(i, j, k+1)
   abs6 = p(i, j, k+2) - p(i, j, k+1)
   ELSE
   abs6d = -(pd(i, j, k+2)-pd(i, j, k+1))
   abs6 = -(p(i, j, k+2)-p(i, j, k+1))
   END IF
   IF (p(i, j, k+1) - p(i, j, k) .GE. 0.) THEN
   abs12d = pd(i, j, k+1) - pd(i, j, k)
   abs12 = p(i, j, k+1) - p(i, j, k)
   ELSE
   abs12d = -(pd(i, j, k+1)-pd(i, j, k))
   abs12 = -(p(i, j, k+1)-p(i, j, k))
   END IF
   x6d = ((pd(i, j, k+2)-two*pd(i, j, k+1)+pd(i, j, k))*(omega*(p&
   &            (i, j, k+2)+two*p(i, j, k+1)+p(i, j, k))+oneminomega*(abs6+&
   &            abs12)+plim)-(p(i, j, k+2)-two*p(i, j, k+1)+p(i, j, k))*(&
   &            omega*(pd(i, j, k+2)+two*pd(i, j, k+1)+pd(i, j, k))+&
   &            oneminomega*(abs6d+abs12d)+plimd))/(omega*(p(i, j, k+2)+two*&
   &            p(i, j, k+1)+p(i, j, k))+oneminomega*(abs6+abs12)+plim)**2
   x6 = (p(i, j, k+2)-two*p(i, j, k+1)+p(i, j, k))/(omega*(p(i, j&
   &            , k+2)+two*p(i, j, k+1)+p(i, j, k))+oneminomega*(abs6+abs12)&
   &            +plim)
   IF (x6 .GE. 0.) THEN
   dp2d = x6d
   dp2 = x6
   ELSE
   dp2d = -x6d
   dp2 = -x6
   END IF
   ! Compute the dissipation coefficients for this face.
   ppor = zero
   IF (pork(i, j, k) .EQ. normalflux) ppor = one
   IF (lumpeddiss) THEN
   IF (dp1 .LT. dp2) THEN
   y5d = dp2d
   y5 = dp2
   ELSE
   y5d = dp1d
   y5 = dp1
   END IF
   IF (dpmax .GT. y5) THEN
   min5d = y5d
   min5 = y5
   ELSE
   min5 = dpmax
   min5d = 0.0_8
   END IF
   dis2d = fis2*ppor*min5d
   dis2 = fis2*ppor*min5 + sigma*fis4*ppor
   dis4 = 0.0
   dis4d = 0.0_8
   ELSE
   IF (dp1 .LT. dp2) THEN
   y6d = dp2d
   y6 = dp2
   ELSE
   y6d = dp1d
   y6 = dp1
   END IF
   IF (dpmax .GT. y6) THEN
   min6d = y6d
   min6 = y6
   ELSE
   min6 = dpmax
   min6d = 0.0_8
   END IF
   dis2d = ppor*fis2*min6d
   dis2 = ppor*fis2*min6
   dis4d = DIM_D(ppor*fis4, 0.0_8, dis2, dis2d, dis4)
   END IF
   ! Construct the vector of the first and third differences
   ! multiplied by the appropriate constants.
   ddwd = wd(i, j, k+1, irho) - wd(i, j, k, irho)
   ddw = w(i, j, k+1, irho) - w(i, j, k, irho)
   drd = dis2d*ddw + dis2*ddwd - dis4d*(w(i, j, k+2, irho)-w(i, j&
   &            , k-1, irho)-three*ddw) - dis4*(wd(i, j, k+2, irho)-wd(i, j&
   &            , k-1, irho)-three*ddwd)
   dr = dis2*ddw - dis4*(w(i, j, k+2, irho)-w(i, j, k-1, irho)-&
   &            three*ddw)
   ddwd = wd(i, j, k+1, irho)*w(i, j, k+1, ivx) + w(i, j, k+1, &
   &            irho)*wd(i, j, k+1, ivx) - wd(i, j, k, irho)*w(i, j, k, ivx)&
   &            - w(i, j, k, irho)*wd(i, j, k, ivx)
   ddw = w(i, j, k+1, irho)*w(i, j, k+1, ivx) - w(i, j, k, irho)*&
   &            w(i, j, k, ivx)
   drud = dis2d*ddw + dis2*ddwd - dis4d*(w(i, j, k+2, irho)*w(i, &
   &            j, k+2, ivx)-w(i, j, k-1, irho)*w(i, j, k-1, ivx)-three*ddw)&
   &            - dis4*(wd(i, j, k+2, irho)*w(i, j, k+2, ivx)+w(i, j, k+2, &
   &            irho)*wd(i, j, k+2, ivx)-wd(i, j, k-1, irho)*w(i, j, k-1, &
   &            ivx)-w(i, j, k-1, irho)*wd(i, j, k-1, ivx)-three*ddwd)
   dru = dis2*ddw - dis4*(w(i, j, k+2, irho)*w(i, j, k+2, ivx)-w(&
   &            i, j, k-1, irho)*w(i, j, k-1, ivx)-three*ddw)
   ddwd = wd(i, j, k+1, irho)*w(i, j, k+1, ivy) + w(i, j, k+1, &
   &            irho)*wd(i, j, k+1, ivy) - wd(i, j, k, irho)*w(i, j, k, ivy)&
   &            - w(i, j, k, irho)*wd(i, j, k, ivy)
   ddw = w(i, j, k+1, irho)*w(i, j, k+1, ivy) - w(i, j, k, irho)*&
   &            w(i, j, k, ivy)
   drvd = dis2d*ddw + dis2*ddwd - dis4d*(w(i, j, k+2, irho)*w(i, &
   &            j, k+2, ivy)-w(i, j, k-1, irho)*w(i, j, k-1, ivy)-three*ddw)&
   &            - dis4*(wd(i, j, k+2, irho)*w(i, j, k+2, ivy)+w(i, j, k+2, &
   &            irho)*wd(i, j, k+2, ivy)-wd(i, j, k-1, irho)*w(i, j, k-1, &
   &            ivy)-w(i, j, k-1, irho)*wd(i, j, k-1, ivy)-three*ddwd)
   drv = dis2*ddw - dis4*(w(i, j, k+2, irho)*w(i, j, k+2, ivy)-w(&
   &            i, j, k-1, irho)*w(i, j, k-1, ivy)-three*ddw)
   ddwd = wd(i, j, k+1, irho)*w(i, j, k+1, ivz) + w(i, j, k+1, &
   &            irho)*wd(i, j, k+1, ivz) - wd(i, j, k, irho)*w(i, j, k, ivz)&
   &            - w(i, j, k, irho)*wd(i, j, k, ivz)
   ddw = w(i, j, k+1, irho)*w(i, j, k+1, ivz) - w(i, j, k, irho)*&
   &            w(i, j, k, ivz)
   drwd = dis2d*ddw + dis2*ddwd - dis4d*(w(i, j, k+2, irho)*w(i, &
   &            j, k+2, ivz)-w(i, j, k-1, irho)*w(i, j, k-1, ivz)-three*ddw)&
   &            - dis4*(wd(i, j, k+2, irho)*w(i, j, k+2, ivz)+w(i, j, k+2, &
   &            irho)*wd(i, j, k+2, ivz)-wd(i, j, k-1, irho)*w(i, j, k-1, &
   &            ivz)-w(i, j, k-1, irho)*wd(i, j, k-1, ivz)-three*ddwd)
   drw = dis2*ddw - dis4*(w(i, j, k+2, irho)*w(i, j, k+2, ivz)-w(&
   &            i, j, k-1, irho)*w(i, j, k-1, ivz)-three*ddw)
   ddwd = wd(i, j, k+1, irhoe) - wd(i, j, k, irhoe)
   ddw = w(i, j, k+1, irhoe) - w(i, j, k, irhoe)
   dred = dis2d*ddw + dis2*ddwd - dis4d*(w(i, j, k+2, irhoe)-w(i&
   &            , j, k-1, irhoe)-three*ddw) - dis4*(wd(i, j, k+2, irhoe)-wd(&
   &            i, j, k-1, irhoe)-three*ddwd)
   dre = dis2*ddw - dis4*(w(i, j, k+2, irhoe)-w(i, j, k-1, irhoe)&
   &            -three*ddw)
   ! In case a k-equation is present, compute the difference
   ! of rhok and store the average value of k. If not present,
   ! set both these values to zero, such that later on no
   ! decision needs to be made anymore.
   IF (correctfork) THEN
   ddwd = wd(i, j, k+1, irho)*w(i, j, k+1, itu1) + w(i, j, k+1&
   &              , irho)*wd(i, j, k+1, itu1) - wd(i, j, k, irho)*w(i, j, k&
   &              , itu1) - w(i, j, k, irho)*wd(i, j, k, itu1)
   ddw = w(i, j, k+1, irho)*w(i, j, k+1, itu1) - w(i, j, k, &
   &              irho)*w(i, j, k, itu1)
   drkd = dis2d*ddw + dis2*ddwd - dis4d*(w(i, j, k+2, irho)*w(i&
   &              , j, k+2, itu1)-w(i, j, k-1, irho)*w(i, j, k-1, itu1)-&
   &              three*ddw) - dis4*(wd(i, j, k+2, irho)*w(i, j, k+2, itu1)+&
   &              w(i, j, k+2, irho)*wd(i, j, k+2, itu1)-wd(i, j, k-1, irho)&
   &              *w(i, j, k-1, itu1)-w(i, j, k-1, irho)*wd(i, j, k-1, itu1)&
   &              -three*ddwd)
   drk = dis2*ddw - dis4*(w(i, j, k+2, irho)*w(i, j, k+2, itu1)&
   &              -w(i, j, k-1, irho)*w(i, j, k-1, itu1)-three*ddw)
   kavgd = half*(wd(i, j, k+1, itu1)+wd(i, j, k, itu1))
   kavg = half*(w(i, j, k+1, itu1)+w(i, j, k, itu1))
   ELSE
   drk = zero
   kavg = zero
   kavgd = 0.0_8
   drkd = 0.0_8
   END IF
   ! Compute the average value of gamma and compute some
   ! expressions in which it occurs.
   gammaavgd = half*(gammad(i, j, k+1)+gammad(i, j, k))
   gammaavg = half*(gamma(i, j, k+1)+gamma(i, j, k))
   gm1d = gammaavgd
   gm1 = gammaavg - one
   ovgm1d = -(one*gm1d/gm1**2)
   ovgm1 = one/gm1
   gm53d = gammaavgd
   gm53 = gammaavg - five*third
   ! Compute the average state at the interface.
   uavgd = half*(wd(i, j, k+1, ivx)+wd(i, j, k, ivx))
   uavg = half*(w(i, j, k+1, ivx)+w(i, j, k, ivx))
   vavgd = half*(wd(i, j, k+1, ivy)+wd(i, j, k, ivy))
   vavg = half*(w(i, j, k+1, ivy)+w(i, j, k, ivy))
   wavgd = half*(wd(i, j, k+1, ivz)+wd(i, j, k, ivz))
   wavg = half*(w(i, j, k+1, ivz)+w(i, j, k, ivz))
   a2avgd = half*(((gammad(i, j, k+1)*p(i, j, k+1)+gamma(i, j, k+&
   &            1)*pd(i, j, k+1))*w(i, j, k+1, irho)-gamma(i, j, k+1)*p(i, j&
   &            , k+1)*wd(i, j, k+1, irho))/w(i, j, k+1, irho)**2+((gammad(i&
   &            , j, k)*p(i, j, k)+gamma(i, j, k)*pd(i, j, k))*w(i, j, k, &
   &            irho)-gamma(i, j, k)*p(i, j, k)*wd(i, j, k, irho))/w(i, j, k&
   &            , irho)**2)
   a2avg = half*(gamma(i, j, k+1)*p(i, j, k+1)/w(i, j, k+1, irho)&
   &            +gamma(i, j, k)*p(i, j, k)/w(i, j, k, irho))
   sxd = skd(i, j, k, 1)
   sx = sk(i, j, k, 1)
   syd = skd(i, j, k, 2)
   sy = sk(i, j, k, 2)
   szd = skd(i, j, k, 3)
   sz = sk(i, j, k, 3)
   arg1d = 2*sx*sxd + 2*sy*syd + 2*sz*szd
   arg1 = sx**2 + sy**2 + sz**2
   IF (arg1 .EQ. 0.0_8) THEN
   aread = 0.0_8
   ELSE
   aread = arg1d/(2.0*SQRT(arg1))
   END IF
   area = SQRT(arg1)
   IF (1.e-25_realType .LT. area) THEN
   max3d = aread
   max3 = area
   ELSE
   max3 = 1.e-25_realType
   max3d = 0.0_8
   END IF
   tmpd = -(one*max3d/max3**2)
   tmp = one/max3
   sxd = sxd*tmp + sx*tmpd
   sx = sx*tmp
   syd = syd*tmp + sy*tmpd
   sy = sy*tmp
   szd = szd*tmp + sz*tmpd
   sz = sz*tmp
   alphaavgd = half*(2*uavg*uavgd+2*vavg*vavgd+2*wavg*wavgd)
   alphaavg = half*(uavg**2+vavg**2+wavg**2)
   havgd = alphaavgd + ovgm1d*(a2avg-gm53*kavg) + ovgm1*(a2avgd-&
   &            gm53d*kavg-gm53*kavgd)
   havg = alphaavg + ovgm1*(a2avg-gm53*kavg)
   IF (a2avg .EQ. 0.0_8) THEN
   aavgd = 0.0_8
   ELSE
   aavgd = a2avgd/(2.0*SQRT(a2avg))
   END IF
   aavg = SQRT(a2avg)
   unavgd = uavgd*sx + uavg*sxd + vavgd*sy + vavg*syd + wavgd*sz &
   &            + wavg*szd
   unavg = uavg*sx + vavg*sy + wavg*sz
   ovaavgd = -(one*aavgd/aavg**2)
   ovaavg = one/aavg
   ova2avgd = -(one*a2avgd/a2avg**2)
   ova2avg = one/a2avg
   ! The mesh velocity if the face is moving. It must be
   ! divided by the area to obtain a true velocity.
   IF (addgridvelocities) THEN
   sfaced = sfacekd(i, j, k)*tmp + sfacek(i, j, k)*tmpd
   sface = sfacek(i, j, k)*tmp
   END IF
   IF (unavg - sface + aavg .GE. 0.) THEN
   lam1d = unavgd - sfaced + aavgd
   lam1 = unavg - sface + aavg
   ELSE
   lam1d = -(unavgd-sfaced+aavgd)
   lam1 = -(unavg-sface+aavg)
   END IF
   IF (unavg - sface - aavg .GE. 0.) THEN
   lam2d = unavgd - sfaced - aavgd
   lam2 = unavg - sface - aavg
   ELSE
   lam2d = -(unavgd-sfaced-aavgd)
   lam2 = -(unavg-sface-aavg)
   END IF
   IF (unavg - sface .GE. 0.) THEN
   lam3d = unavgd - sfaced
   lam3 = unavg - sface
   ELSE
   lam3d = -(unavgd-sfaced)
   lam3 = -(unavg-sface)
   END IF
   rradd = lam3d + aavgd
   rrad = lam3 + aavg
   IF (lam1 .LT. epsacoustic*rrad) THEN
   lam1d = epsacoustic*rradd
   lam1 = epsacoustic*rrad
   ELSE
   lam1 = lam1
   END IF
   IF (lam2 .LT. epsacoustic*rrad) THEN
   lam2d = epsacoustic*rradd
   lam2 = epsacoustic*rrad
   ELSE
   lam2 = lam2
   END IF
   IF (lam3 .LT. epsshear*rrad) THEN
   lam3d = epsshear*rradd
   lam3 = epsshear*rrad
   ELSE
   lam3 = lam3
   END IF
   ! Multiply the eigenvalues by the area to obtain
   ! the correct values for the dissipation term.
   lam1d = lam1d*area + lam1*aread
   lam1 = lam1*area
   lam2d = lam2d*area + lam2*aread
   lam2 = lam2*area
   lam3d = lam3d*area + lam3*aread
   lam3 = lam3*area
   ! Some abbreviations, which occur quite often in the
   ! dissipation terms.
   abv1d = half*(lam1d+lam2d)
   abv1 = half*(lam1+lam2)
   abv2d = half*(lam1d-lam2d)
   abv2 = half*(lam1-lam2)
   abv3d = abv1d - lam3d
   abv3 = abv1 - lam3
   abv4d = gm1d*(alphaavg*dr-uavg*dru-vavg*drv-wavg*drw+dre) + &
   &            gm1*(alphaavgd*dr+alphaavg*drd-uavgd*dru-uavg*drud-vavgd*drv&
   &            -vavg*drvd-wavgd*drw-wavg*drwd+dred) - gm53d*drk - gm53*drkd
   abv4 = gm1*(alphaavg*dr-uavg*dru-vavg*drv-wavg*drw+dre) - gm53&
   &            *drk
   abv5d = sxd*dru + sx*drud + syd*drv + sy*drvd + szd*drw + sz*&
   &            drwd - unavgd*dr - unavg*drd
   abv5 = sx*dru + sy*drv + sz*drw - unavg*dr
   abv6d = (abv3d*abv4+abv3*abv4d)*ova2avg + abv3*abv4*ova2avgd +&
   &            (abv2d*abv5+abv2*abv5d)*ovaavg + abv2*abv5*ovaavgd
   abv6 = abv3*abv4*ova2avg + abv2*abv5*ovaavg
   abv7d = (abv2d*abv4+abv2*abv4d)*ovaavg + abv2*abv4*ovaavgd + &
   &            abv3d*abv5 + abv3*abv5d
   abv7 = abv2*abv4*ovaavg + abv3*abv5
   ! Compute and scatter the dissipative flux.
   ! Density.
   fsd = lam3d*dr + lam3*drd + abv6d
   fs = lam3*dr + abv6
   fwd(i, j, k+1, irho) = fwd(i, j, k+1, irho) + fsd
   fw(i, j, k+1, irho) = fw(i, j, k+1, irho) + fs
   fwd(i, j, k, irho) = fwd(i, j, k, irho) - fsd
   fw(i, j, k, irho) = fw(i, j, k, irho) - fs
   ! X-momentum.
   fsd = lam3d*dru + lam3*drud + uavgd*abv6 + uavg*abv6d + sxd*&
   &            abv7 + sx*abv7d
   fs = lam3*dru + uavg*abv6 + sx*abv7
   fwd(i, j, k+1, imx) = fwd(i, j, k+1, imx) + fsd
   fw(i, j, k+1, imx) = fw(i, j, k+1, imx) + fs
   fwd(i, j, k, imx) = fwd(i, j, k, imx) - fsd
   fw(i, j, k, imx) = fw(i, j, k, imx) - fs
   ! Y-momentum.
   fsd = lam3d*drv + lam3*drvd + vavgd*abv6 + vavg*abv6d + syd*&
   &            abv7 + sy*abv7d
   fs = lam3*drv + vavg*abv6 + sy*abv7
   fwd(i, j, k+1, imy) = fwd(i, j, k+1, imy) + fsd
   fw(i, j, k+1, imy) = fw(i, j, k+1, imy) + fs
   fwd(i, j, k, imy) = fwd(i, j, k, imy) - fsd
   fw(i, j, k, imy) = fw(i, j, k, imy) - fs
   ! Z-momentum.
   fsd = lam3d*drw + lam3*drwd + wavgd*abv6 + wavg*abv6d + szd*&
   &            abv7 + sz*abv7d
   fs = lam3*drw + wavg*abv6 + sz*abv7
   fwd(i, j, k+1, imz) = fwd(i, j, k+1, imz) + fsd
   fw(i, j, k+1, imz) = fw(i, j, k+1, imz) + fs
   fwd(i, j, k, imz) = fwd(i, j, k, imz) - fsd
   fw(i, j, k, imz) = fw(i, j, k, imz) - fs
   ! Energy.
   fsd = lam3d*dre + lam3*dred + havgd*abv6 + havg*abv6d + unavgd&
   &            *abv7 + unavg*abv7d
   fs = lam3*dre + havg*abv6 + unavg*abv7
   fwd(i, j, k+1, irhoe) = fwd(i, j, k+1, irhoe) + fsd
   fw(i, j, k+1, irhoe) = fw(i, j, k+1, irhoe) + fs
   fwd(i, j, k, irhoe) = fwd(i, j, k, irhoe) - fsd
   fw(i, j, k, irhoe) = fw(i, j, k, irhoe) - fs
   ! Set dp1 to dp2 for the next face.
   dp1d = dp2d
   dp1 = dp2
   END DO
   END DO
   END DO
   END IF
   END SUBROUTINE INVISCIDDISSFLUXMATRIX_D
