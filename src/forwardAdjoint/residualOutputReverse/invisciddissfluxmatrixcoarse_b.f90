   !        Generated by TAPENADE     (INRIA, Tropics team)
   !  Tapenade 3.6 (r4159) - 21 Sep 2011 10:11
   !
   !  Differentiation of invisciddissfluxmatrixcoarse in reverse (adjoint) mode:
   !   gradient     of useful results: *p *w *si *sj *sk *fw
   !   with respect to varying inputs: *p *sfacei *sfacej *sfacek
   !                *w *si *sj *sk
   !   Plus diff mem management of: p:in sfacei:in sfacej:in gamma:in
   !                sfacek:in w:in si:in sj:in sk:in fw:in
   !
   !      ******************************************************************
   !      *                                                                *
   !      * File:          inviscidDissFluxMatrixCoarse.f90                *
   !      * Author:        Edwin van der Weide                             *
   !      * Starting date: 03-25-2003                                      *
   !      * Last modified: 08-25-2005                                      *
   !      *                                                                *
   !      ******************************************************************
   !
   SUBROUTINE INVISCIDDISSFLUXMATRIXCOARSE_B()
   USE BLOCKPOINTERS_B
   USE INPUTPHYSICS
   USE INPUTDISCRETIZATION
   USE CONSTANTS
   USE ITERATION
   USE FLOWVARREFSTATE
   IMPLICIT NONE
   !
   !      ******************************************************************
   !      *                                                                *
   !      * inviscidDissFluxMatrixCoarse computes the matrix artificial    *
   !      * dissipation term. Instead of the spectral radius, as used in   *
   !      * the scalar dissipation scheme, the absolute value of the flux  *
   !      * jacobian is used. This routine is used on the coarser grids in *
   !      * the multigrid cycle and only computes the first order          *
   !      * dissipation term. It is assumed that the pointers in           *
   !      * blockPointers already point to the correct block.              *
   !      *                                                                *
   !      ******************************************************************
   !
   !
   !      Local parameters.
   !
   REAL(kind=realtype), PARAMETER :: epsacoustic=0.25_realType
   REAL(kind=realtype), PARAMETER :: epsshear=0.025_realType
   !
   !      Local variables.
   !
   INTEGER(kind=inttype) :: i, j, k
   REAL(kind=realtype) :: sfil, fis0, dis0, ppor, rrad, sface
   REAL(kind=realtype) :: rradb, sfaceb
   REAL(kind=realtype) :: gammaavg, gm1, ovgm1, gm53, tmp, fs
   REAL(kind=realtype) :: tmpb, fsb
   REAL(kind=realtype) :: dr, dru, drv, drw, dre, drk, sx, sy, sz
   REAL(kind=realtype) :: drb, drub, drvb, drwb, dreb, drkb, sxb, syb, &
   &  szb
   REAL(kind=realtype) :: uavg, vavg, wavg, a2avg, aavg, havg
   REAL(kind=realtype) :: uavgb, vavgb, wavgb, a2avgb, aavgb, havgb
   REAL(kind=realtype) :: alphaavg, unavg, ovaavg, ova2avg
   REAL(kind=realtype) :: alphaavgb, unavgb, ovaavgb, ova2avgb
   REAL(kind=realtype) :: kavg, lam1, lam2, lam3, area
   REAL(kind=realtype) :: kavgb, lam1b, lam2b, lam3b, areab
   REAL(kind=realtype) :: abv1, abv2, abv3, abv4, abv5, abv6, abv7
   REAL(kind=realtype) :: abv1b, abv2b, abv3b, abv4b, abv5b, abv6b, abv7b
   LOGICAL :: correctfork
   INTEGER :: branch
   REAL(kind=realtype) :: temp3
   REAL(kind=realtype) :: temp2
   REAL(kind=realtype) :: temp1
   REAL(kind=realtype) :: temp0
   REAL(kind=realtype) :: max2b
   REAL(kind=realtype) :: tempb4
   REAL(kind=realtype) :: tempb3
   REAL(kind=realtype) :: tempb2
   REAL(kind=realtype) :: tempb1
   REAL(kind=realtype) :: tempb0
   INTRINSIC MAX
   REAL(kind=realtype) :: temp3b
   INTRINSIC ABS
   REAL(kind=realtype) :: max1b
   REAL(kind=realtype) :: temp5b1
   REAL(kind=realtype) :: temp5b0
   REAL(kind=realtype) :: tempb
   REAL(kind=realtype) :: temp5b
   REAL(kind=realtype) :: temp3b7
   REAL(kind=realtype) :: temp3b6
   REAL(kind=realtype) :: temp3b5
   REAL(kind=realtype) :: temp3b4
   REAL(kind=realtype) :: temp3b3
   REAL(kind=realtype) :: temp3b2
   REAL(kind=realtype) :: temp3b1
   REAL(kind=realtype) :: temp3b0
   REAL(kind=realtype) :: abs0
   REAL(kind=realtype) :: max3b
   REAL(kind=realtype) :: temp1b7
   REAL(kind=realtype) :: temp1b
   REAL(kind=realtype) :: temp1b6
   INTRINSIC SQRT
   REAL(kind=realtype) :: temp
   REAL(kind=realtype) :: temp1b5
   REAL(kind=realtype) :: max3
   REAL(kind=realtype) :: temp1b4
   REAL(kind=realtype) :: max2
   REAL(kind=realtype) :: temp1b3
   REAL(kind=realtype) :: max1
   REAL(kind=realtype) :: temp1b2
   REAL(kind=realtype) :: temp1b1
   REAL(kind=realtype) :: temp1b0
   REAL(kind=realtype) :: temp4
   IF (rfil .GE. 0.) THEN
   abs0 = rfil
   ELSE
   abs0 = -rfil
   END IF
   !
   !      ******************************************************************
   !      *                                                                *
   !      * Begin execution                                                *
   !      *                                                                *
   !      ******************************************************************
   !
   ! Check if rFil == 0. If so, the dissipative flux needs not to
   ! be computed.
   IF (abs0 .LT. thresholdreal) THEN
   sfaceib = 0.0_8
   sfacejb = 0.0_8
   sfacekb = 0.0_8
   ELSE
   ! Determine whether or not the total energy must be corrected
   ! for the presence of the turbulent kinetic energy.
   IF (kpresent) THEN
   IF (currentlevel .EQ. groundlevel .OR. turbcoupled) THEN
   correctfork = .true.
   ELSE
   correctfork = .false.
   END IF
   ELSE
   correctfork = .false.
   END IF
   ! Initialize sface to zero. This value will be used if the
   ! block is not moving.
   sface = zero
   ! Set a couple of constants for the scheme.
   fis0 = rfil*vis2coarse
   !
   !      ******************************************************************
   !      *                                                                *
   !      * Dissipative fluxes in the i-direction.                         *
   !      *                                                                *
   !      ******************************************************************
   !
   DO k=2,kl
   DO j=2,jl
   DO i=1,il
   ! Compute the dissipation coefficient for this face.
   ppor = zero
   IF (pori(i, j, k) .EQ. normalflux) ppor = one
   CALL PUSHREAL8(dis0)
   dis0 = fis0*ppor
   ! Construct the vector of the first differences multiplied
   ! by dis0.
   dr = dis0*(w(i+1, j, k, irho)-w(i, j, k, irho))
   CALL PUSHREAL8(dru)
   dru = dis0*(w(i+1, j, k, irho)*w(i+1, j, k, ivx)-w(i, j, k, &
   &            irho)*w(i, j, k, ivx))
   CALL PUSHREAL8(drv)
   drv = dis0*(w(i+1, j, k, irho)*w(i+1, j, k, ivy)-w(i, j, k, &
   &            irho)*w(i, j, k, ivy))
   CALL PUSHREAL8(drw)
   drw = dis0*(w(i+1, j, k, irho)*w(i+1, j, k, ivz)-w(i, j, k, &
   &            irho)*w(i, j, k, ivz))
   dre = dis0*(w(i+1, j, k, irhoe)-w(i, j, k, irhoe))
   ! In case a k-equation is present, compute the difference
   ! of rhok and store the average value of k. If not present,
   ! set both these values to zero, such that later on no
   ! decision needs to be made anymore.
   IF (correctfork) THEN
   drk = dis0*(w(i+1, j, k, irho)*w(i+1, j, k, itu1)-w(i, j, k&
   &              , irho)*w(i, j, k, itu1))
   kavg = half*(w(i+1, j, k, itu1)+w(i, j, k, itu1))
   CALL PUSHCONTROL1B(1)
   ELSE
   CALL PUSHCONTROL1B(0)
   drk = zero
   kavg = zero
   END IF
   ! Compute the average value of gamma and compute some
   ! expressions in which it occurs.
   gammaavg = half*(gamma(i+1, j, k)+gamma(i, j, k))
   gm1 = gammaavg - one
   ovgm1 = one/gm1
   gm53 = gammaavg - five*third
   ! Compute the average state at the interface.
   uavg = half*(w(i+1, j, k, ivx)+w(i, j, k, ivx))
   vavg = half*(w(i+1, j, k, ivy)+w(i, j, k, ivy))
   wavg = half*(w(i+1, j, k, ivz)+w(i, j, k, ivz))
   CALL PUSHREAL8(a2avg)
   a2avg = half*(gamma(i+1, j, k)*p(i+1, j, k)/w(i+1, j, k, irho)&
   &            +gamma(i, j, k)*p(i, j, k)/w(i, j, k, irho))
   CALL PUSHREAL8(sx)
   sx = si(i, j, k, 1)
   CALL PUSHREAL8(sy)
   sy = si(i, j, k, 2)
   CALL PUSHREAL8(sz)
   sz = si(i, j, k, 3)
   CALL PUSHREAL8(area)
   area = SQRT(sx**2 + sy**2 + sz**2)
   IF (1.e-25_realType .LT. area) THEN
   CALL PUSHREAL8(max1)
   max1 = area
   CALL PUSHCONTROL1B(0)
   ELSE
   CALL PUSHREAL8(max1)
   max1 = 1.e-25_realType
   CALL PUSHCONTROL1B(1)
   END IF
   tmp = one/max1
   CALL PUSHREAL8(sx)
   sx = sx*tmp
   CALL PUSHREAL8(sy)
   sy = sy*tmp
   CALL PUSHREAL8(sz)
   sz = sz*tmp
   alphaavg = half*(uavg**2+vavg**2+wavg**2)
   CALL PUSHREAL8(havg)
   havg = alphaavg + ovgm1*(a2avg-gm53*kavg)
   CALL PUSHREAL8(aavg)
   aavg = SQRT(a2avg)
   unavg = uavg*sx + vavg*sy + wavg*sz
   ! The mesh velocity if the face is moving. It must be
   ! divided by the area to obtain a true velocity.
   IF (addgridvelocities) THEN
   sface = sfacei(i, j, k)*tmp
   CALL PUSHCONTROL1B(1)
   ELSE
   CALL PUSHCONTROL1B(0)
   END IF
   IF (unavg - sface + aavg .GE. 0.) THEN
   lam1 = unavg - sface + aavg
   CALL PUSHCONTROL1B(0)
   ELSE
   lam1 = -(unavg-sface+aavg)
   CALL PUSHCONTROL1B(1)
   END IF
   IF (unavg - sface - aavg .GE. 0.) THEN
   lam2 = unavg - sface - aavg
   CALL PUSHCONTROL1B(0)
   ELSE
   lam2 = -(unavg-sface-aavg)
   CALL PUSHCONTROL1B(1)
   END IF
   IF (unavg - sface .GE. 0.) THEN
   CALL PUSHREAL8(lam3)
   lam3 = unavg - sface
   CALL PUSHCONTROL1B(0)
   ELSE
   CALL PUSHREAL8(lam3)
   lam3 = -(unavg-sface)
   CALL PUSHCONTROL1B(1)
   END IF
   rrad = lam3 + aavg
   IF (lam1 .LT. epsacoustic*rrad) THEN
   lam1 = epsacoustic*rrad
   CALL PUSHCONTROL1B(0)
   ELSE
   CALL PUSHCONTROL1B(1)
   lam1 = lam1
   END IF
   IF (lam2 .LT. epsacoustic*rrad) THEN
   lam2 = epsacoustic*rrad
   CALL PUSHCONTROL1B(0)
   ELSE
   CALL PUSHCONTROL1B(1)
   lam2 = lam2
   END IF
   IF (lam3 .LT. epsshear*rrad) THEN
   lam3 = epsshear*rrad
   CALL PUSHCONTROL1B(0)
   ELSE
   lam3 = lam3
   CALL PUSHCONTROL1B(1)
   END IF
   CALL PUSHREAL8(lam1)
   ! Multiply the eigenvalues by the area to obtain
   ! the correct values for the dissipation term.
   lam1 = lam1*area
   CALL PUSHREAL8(lam2)
   lam2 = lam2*area
   CALL PUSHREAL8(lam3)
   lam3 = lam3*area
   ! Some abbreviations, which occur quite often in the
   ! dissipation terms.
   abv1 = half*(lam1+lam2)
   CALL PUSHREAL8(abv2)
   abv2 = half*(lam1-lam2)
   CALL PUSHREAL8(abv3)
   abv3 = abv1 - lam3
   CALL PUSHREAL8(abv4)
   abv4 = gm1*(alphaavg*dr-uavg*dru-vavg*drv-wavg*drw+dre) - gm53&
   &            *drk
   ! Compute and scatter the dissipative flux.
   ! Density.
   ! X-momentum.
   ! Y-momentum.
   ! Z-momentum.
   ! Energy.
   END DO
   END DO
   END DO
   !
   !      ******************************************************************
   !      *                                                                *
   !      * Dissipative fluxes in the j-direction.                         *
   !      *                                                                *
   !      ******************************************************************
   !
   DO k=2,kl
   DO j=1,jl
   DO i=2,il
   ! Compute the dissipation coefficient for this face.
   ppor = zero
   IF (porj(i, j, k) .EQ. normalflux) ppor = one
   CALL PUSHREAL8(dis0)
   dis0 = fis0*ppor
   ! Construct the vector of the first differences multiplied
   ! by dis0.
   dr = dis0*(w(i, j+1, k, irho)-w(i, j, k, irho))
   CALL PUSHREAL8(dru)
   dru = dis0*(w(i, j+1, k, irho)*w(i, j+1, k, ivx)-w(i, j, k, &
   &            irho)*w(i, j, k, ivx))
   CALL PUSHREAL8(drv)
   drv = dis0*(w(i, j+1, k, irho)*w(i, j+1, k, ivy)-w(i, j, k, &
   &            irho)*w(i, j, k, ivy))
   CALL PUSHREAL8(drw)
   drw = dis0*(w(i, j+1, k, irho)*w(i, j+1, k, ivz)-w(i, j, k, &
   &            irho)*w(i, j, k, ivz))
   dre = dis0*(w(i, j+1, k, irhoe)-w(i, j, k, irhoe))
   ! In case a k-equation is present, compute the difference
   ! of rhok and store the average value of k. If not present,
   ! set both these values to zero, such that later on no
   ! decision needs to be made anymore.
   IF (correctfork) THEN
   drk = dis0*(w(i, j+1, k, irho)*w(i, j+1, k, itu1)-w(i, j, k&
   &              , irho)*w(i, j, k, itu1))
   kavg = half*(w(i, j+1, k, itu1)+w(i, j, k, itu1))
   CALL PUSHCONTROL1B(1)
   ELSE
   CALL PUSHCONTROL1B(0)
   drk = zero
   kavg = zero
   END IF
   ! Compute the average value of gamma and compute some
   ! expressions in which it occurs.
   gammaavg = half*(gamma(i, j+1, k)+gamma(i, j, k))
   gm1 = gammaavg - one
   ovgm1 = one/gm1
   gm53 = gammaavg - five*third
   ! Compute the average state at the interface.
   uavg = half*(w(i, j+1, k, ivx)+w(i, j, k, ivx))
   vavg = half*(w(i, j+1, k, ivy)+w(i, j, k, ivy))
   wavg = half*(w(i, j+1, k, ivz)+w(i, j, k, ivz))
   CALL PUSHREAL8(a2avg)
   a2avg = half*(gamma(i, j+1, k)*p(i, j+1, k)/w(i, j+1, k, irho)&
   &            +gamma(i, j, k)*p(i, j, k)/w(i, j, k, irho))
   CALL PUSHREAL8(sx)
   sx = sj(i, j, k, 1)
   CALL PUSHREAL8(sy)
   sy = sj(i, j, k, 2)
   CALL PUSHREAL8(sz)
   sz = sj(i, j, k, 3)
   CALL PUSHREAL8(area)
   area = SQRT(sx**2 + sy**2 + sz**2)
   IF (1.e-25_realType .LT. area) THEN
   CALL PUSHREAL8(max2)
   max2 = area
   CALL PUSHCONTROL1B(0)
   ELSE
   CALL PUSHREAL8(max2)
   max2 = 1.e-25_realType
   CALL PUSHCONTROL1B(1)
   END IF
   tmp = one/max2
   CALL PUSHREAL8(sx)
   sx = sx*tmp
   CALL PUSHREAL8(sy)
   sy = sy*tmp
   CALL PUSHREAL8(sz)
   sz = sz*tmp
   alphaavg = half*(uavg**2+vavg**2+wavg**2)
   CALL PUSHREAL8(havg)
   havg = alphaavg + ovgm1*(a2avg-gm53*kavg)
   CALL PUSHREAL8(aavg)
   aavg = SQRT(a2avg)
   unavg = uavg*sx + vavg*sy + wavg*sz
   ! The mesh velocity if the face is moving. It must be
   ! divided by the area to obtain a true velocity.
   IF (addgridvelocities) THEN
   sface = sfacej(i, j, k)*tmp
   CALL PUSHCONTROL1B(1)
   ELSE
   CALL PUSHCONTROL1B(0)
   END IF
   IF (unavg - sface + aavg .GE. 0.) THEN
   lam1 = unavg - sface + aavg
   CALL PUSHCONTROL1B(0)
   ELSE
   lam1 = -(unavg-sface+aavg)
   CALL PUSHCONTROL1B(1)
   END IF
   IF (unavg - sface - aavg .GE. 0.) THEN
   lam2 = unavg - sface - aavg
   CALL PUSHCONTROL1B(0)
   ELSE
   lam2 = -(unavg-sface-aavg)
   CALL PUSHCONTROL1B(1)
   END IF
   IF (unavg - sface .GE. 0.) THEN
   CALL PUSHREAL8(lam3)
   lam3 = unavg - sface
   CALL PUSHCONTROL1B(0)
   ELSE
   CALL PUSHREAL8(lam3)
   lam3 = -(unavg-sface)
   CALL PUSHCONTROL1B(1)
   END IF
   rrad = lam3 + aavg
   IF (lam1 .LT. epsacoustic*rrad) THEN
   lam1 = epsacoustic*rrad
   CALL PUSHCONTROL1B(0)
   ELSE
   CALL PUSHCONTROL1B(1)
   lam1 = lam1
   END IF
   IF (lam2 .LT. epsacoustic*rrad) THEN
   lam2 = epsacoustic*rrad
   CALL PUSHCONTROL1B(0)
   ELSE
   CALL PUSHCONTROL1B(1)
   lam2 = lam2
   END IF
   IF (lam3 .LT. epsshear*rrad) THEN
   lam3 = epsshear*rrad
   CALL PUSHCONTROL1B(0)
   ELSE
   lam3 = lam3
   CALL PUSHCONTROL1B(1)
   END IF
   CALL PUSHREAL8(lam1)
   ! Multiply the eigenvalues by the area to obtain
   ! the correct values for the dissipation term.
   lam1 = lam1*area
   CALL PUSHREAL8(lam2)
   lam2 = lam2*area
   CALL PUSHREAL8(lam3)
   lam3 = lam3*area
   ! Some abbreviations, which occur quite often in the
   ! dissipation terms.
   abv1 = half*(lam1+lam2)
   CALL PUSHREAL8(abv2)
   abv2 = half*(lam1-lam2)
   CALL PUSHREAL8(abv3)
   abv3 = abv1 - lam3
   CALL PUSHREAL8(abv4)
   abv4 = gm1*(alphaavg*dr-uavg*dru-vavg*drv-wavg*drw+dre) - gm53&
   &            *drk
   ! Compute and scatter the dissipative flux.
   ! Density.
   ! X-momentum.
   ! Y-momentum.
   ! Z-momentum.
   ! Energy.
   END DO
   END DO
   END DO
   !
   !      ******************************************************************
   !      *                                                                *
   !      * Dissipative fluxes in the k-direction.                         *
   !      *                                                                *
   !      ******************************************************************
   !
   DO k=1,kl
   DO j=2,jl
   DO i=2,il
   ! Compute the dissipation coefficient for this face.
   ppor = zero
   IF (pork(i, j, k) .EQ. normalflux) ppor = one
   CALL PUSHREAL8(dis0)
   dis0 = fis0*ppor
   ! Construct the vector of the first differences multiplied
   ! by dis0.
   dr = dis0*(w(i, j, k+1, irho)-w(i, j, k, irho))
   CALL PUSHREAL8(dru)
   dru = dis0*(w(i, j, k+1, irho)*w(i, j, k+1, ivx)-w(i, j, k, &
   &            irho)*w(i, j, k, ivx))
   CALL PUSHREAL8(drv)
   drv = dis0*(w(i, j, k+1, irho)*w(i, j, k+1, ivy)-w(i, j, k, &
   &            irho)*w(i, j, k, ivy))
   CALL PUSHREAL8(drw)
   drw = dis0*(w(i, j, k+1, irho)*w(i, j, k+1, ivz)-w(i, j, k, &
   &            irho)*w(i, j, k, ivz))
   dre = dis0*(w(i, j, k+1, irhoe)-w(i, j, k, irhoe))
   ! In case a k-equation is present, compute the difference
   ! of rhok and store the average value of k. If not present,
   ! set both these values to zero, such that later on no
   ! decision needs to be made anymore.
   IF (correctfork) THEN
   drk = dis0*(w(i, j, k+1, irho)*w(i, j, k+1, itu1)-w(i, j, k&
   &              , irho)*w(i, j, k, itu1))
   kavg = half*(w(i, j, k+1, itu1)+w(i, j, k, itu1))
   CALL PUSHCONTROL1B(1)
   ELSE
   CALL PUSHCONTROL1B(0)
   drk = zero
   kavg = zero
   END IF
   ! Compute the average value of gamma and compute some
   ! expressions in which it occurs.
   gammaavg = half*(gamma(i, j, k+1)+gamma(i, j, k))
   gm1 = gammaavg - one
   ovgm1 = one/gm1
   gm53 = gammaavg - five*third
   ! Compute the average state at the interface.
   uavg = half*(w(i, j, k+1, ivx)+w(i, j, k, ivx))
   vavg = half*(w(i, j, k+1, ivy)+w(i, j, k, ivy))
   wavg = half*(w(i, j, k+1, ivz)+w(i, j, k, ivz))
   CALL PUSHREAL8(a2avg)
   a2avg = half*(gamma(i, j, k+1)*p(i, j, k+1)/w(i, j, k+1, irho)&
   &            +gamma(i, j, k)*p(i, j, k)/w(i, j, k, irho))
   CALL PUSHREAL8(sx)
   sx = sk(i, j, k, 1)
   CALL PUSHREAL8(sy)
   sy = sk(i, j, k, 2)
   CALL PUSHREAL8(sz)
   sz = sk(i, j, k, 3)
   CALL PUSHREAL8(area)
   area = SQRT(sx**2 + sy**2 + sz**2)
   IF (1.e-25_realType .LT. area) THEN
   CALL PUSHREAL8(max3)
   max3 = area
   CALL PUSHCONTROL1B(0)
   ELSE
   CALL PUSHREAL8(max3)
   max3 = 1.e-25_realType
   CALL PUSHCONTROL1B(1)
   END IF
   tmp = one/max3
   CALL PUSHREAL8(sx)
   sx = sx*tmp
   CALL PUSHREAL8(sy)
   sy = sy*tmp
   CALL PUSHREAL8(sz)
   sz = sz*tmp
   alphaavg = half*(uavg**2+vavg**2+wavg**2)
   CALL PUSHREAL8(havg)
   havg = alphaavg + ovgm1*(a2avg-gm53*kavg)
   CALL PUSHREAL8(aavg)
   aavg = SQRT(a2avg)
   unavg = uavg*sx + vavg*sy + wavg*sz
   ! The mesh velocity if the face is moving. It must be
   ! divided by the area to obtain a true velocity.
   IF (addgridvelocities) THEN
   sface = sfacek(i, j, k)*tmp
   CALL PUSHCONTROL1B(1)
   ELSE
   CALL PUSHCONTROL1B(0)
   END IF
   IF (unavg - sface + aavg .GE. 0.) THEN
   lam1 = unavg - sface + aavg
   CALL PUSHCONTROL1B(0)
   ELSE
   lam1 = -(unavg-sface+aavg)
   CALL PUSHCONTROL1B(1)
   END IF
   IF (unavg - sface - aavg .GE. 0.) THEN
   lam2 = unavg - sface - aavg
   CALL PUSHCONTROL1B(0)
   ELSE
   lam2 = -(unavg-sface-aavg)
   CALL PUSHCONTROL1B(1)
   END IF
   IF (unavg - sface .GE. 0.) THEN
   CALL PUSHREAL8(lam3)
   lam3 = unavg - sface
   CALL PUSHCONTROL1B(0)
   ELSE
   CALL PUSHREAL8(lam3)
   lam3 = -(unavg-sface)
   CALL PUSHCONTROL1B(1)
   END IF
   rrad = lam3 + aavg
   IF (lam1 .LT. epsacoustic*rrad) THEN
   lam1 = epsacoustic*rrad
   CALL PUSHCONTROL1B(0)
   ELSE
   CALL PUSHCONTROL1B(1)
   lam1 = lam1
   END IF
   IF (lam2 .LT. epsacoustic*rrad) THEN
   lam2 = epsacoustic*rrad
   CALL PUSHCONTROL1B(0)
   ELSE
   CALL PUSHCONTROL1B(1)
   lam2 = lam2
   END IF
   IF (lam3 .LT. epsshear*rrad) THEN
   lam3 = epsshear*rrad
   CALL PUSHCONTROL1B(0)
   ELSE
   lam3 = lam3
   CALL PUSHCONTROL1B(1)
   END IF
   CALL PUSHREAL8(lam1)
   ! Multiply the eigenvalues by the area to obtain
   ! the correct values for the dissipation term.
   lam1 = lam1*area
   CALL PUSHREAL8(lam2)
   lam2 = lam2*area
   CALL PUSHREAL8(lam3)
   lam3 = lam3*area
   ! Some abbreviations, which occur quite often in the
   ! dissipation terms.
   abv1 = half*(lam1+lam2)
   CALL PUSHREAL8(abv2)
   abv2 = half*(lam1-lam2)
   CALL PUSHREAL8(abv3)
   abv3 = abv1 - lam3
   CALL PUSHREAL8(abv4)
   abv4 = gm1*(alphaavg*dr-uavg*dru-vavg*drv-wavg*drw+dre) - gm53&
   &            *drk
   ! Compute and scatter the dissipative flux.
   ! Density.
   ! X-momentum.
   ! Y-momentum.
   ! Z-momentum.
   ! Energy.
   END DO
   END DO
   END DO
   sfacekb = 0.0_8
   sfaceb = 0.0_8
   DO k=kl,1,-1
   DO j=jl,2,-1
   DO i=il,2,-1
   fsb = fwb(i, j, k+1, irhoe) - fwb(i, j, k, irhoe)
   wavg = half*(w(i, j, k+1, ivz)+w(i, j, k, ivz))
   dr = dis0*(w(i, j, k+1, irho)-w(i, j, k, irho))
   vavg = half*(w(i, j, k+1, ivy)+w(i, j, k, ivy))
   uavg = half*(w(i, j, k+1, ivx)+w(i, j, k, ivx))
   unavg = uavg*sx + vavg*sy + wavg*sz
   abv5 = sx*dru + sy*drv + sz*drw - unavg*dr
   ovaavg = one/aavg
   ova2avg = one/a2avg
   abv6 = abv3*abv4*ova2avg + abv2*abv5*ovaavg
   abv7 = abv2*abv4*ovaavg + abv3*abv5
   dre = dis0*(w(i, j, k+1, irhoe)-w(i, j, k, irhoe))
   lam3b = dre*fsb
   dreb = lam3*fsb
   havgb = abv6*fsb
   abv6b = havg*fsb
   unavgb = abv7*fsb
   abv7b = unavg*fsb
   fsb = fwb(i, j, k+1, imz) - fwb(i, j, k, imz)
   lam3b = lam3b + drw*fsb
   drwb = lam3*fsb
   wavgb = abv6*fsb
   abv6b = abv6b + wavg*fsb
   szb = abv7*fsb
   abv7b = abv7b + sz*fsb
   fsb = fwb(i, j, k+1, imy) - fwb(i, j, k, imy)
   lam3b = lam3b + drv*fsb
   drvb = lam3*fsb
   vavgb = abv6*fsb
   abv6b = abv6b + vavg*fsb
   syb = abv7*fsb
   abv7b = abv7b + sy*fsb
   fsb = fwb(i, j, k+1, imx) - fwb(i, j, k, imx)
   lam3b = lam3b + dru*fsb
   drub = lam3*fsb
   uavgb = abv6*fsb
   abv6b = abv6b + uavg*fsb
   sxb = abv7*fsb
   abv7b = abv7b + sx*fsb
   fsb = fwb(i, j, k+1, irho) - fwb(i, j, k, irho)
   abv6b = abv6b + fsb
   abv2b = ovaavg*abv5*abv6b + ovaavg*abv4*abv7b
   abv4b = ova2avg*abv3*abv6b + ovaavg*abv2*abv7b
   ovaavgb = abv2*abv5*abv6b + abv2*abv4*abv7b
   abv3b = ova2avg*abv4*abv6b + abv5*abv7b
   lam3b = lam3b + dr*fsb - abv3b
   abv5b = ovaavg*abv2*abv6b + abv3*abv7b
   ova2avgb = abv3*abv4*abv6b
   sxb = sxb + dru*abv5b
   syb = syb + drv*abv5b
   szb = szb + drw*abv5b
   unavgb = unavgb - dr*abv5b
   gammaavg = half*(gamma(i, j, k+1)+gamma(i, j, k))
   gm1 = gammaavg - one
   gm53 = gammaavg - five*third
   alphaavg = half*(uavg**2+vavg**2+wavg**2)
   CALL POPREAL8(abv4)
   temp5b1 = gm1*abv4b
   drb = alphaavg*temp5b1 - unavg*abv5b + lam3*fsb
   drub = drub + sx*abv5b - uavg*temp5b1
   drvb = drvb + sy*abv5b - vavg*temp5b1
   drwb = drwb + sz*abv5b - wavg*temp5b1
   alphaavgb = dr*temp5b1
   uavgb = uavgb - dru*temp5b1
   vavgb = vavgb - drv*temp5b1
   dreb = dreb + temp5b1
   wavgb = wavgb - drw*temp5b1
   drkb = -(gm53*abv4b)
   CALL POPREAL8(abv3)
   abv1b = abv3b
   CALL POPREAL8(abv2)
   lam1b = half*abv1b + half*abv2b
   lam2b = half*abv1b - half*abv2b
   CALL POPREAL8(lam3)
   CALL POPREAL8(lam2)
   CALL POPREAL8(lam1)
   areab = lam2*lam2b + lam1*lam1b + lam3*lam3b
   lam3b = area*lam3b
   lam2b = area*lam2b
   lam1b = area*lam1b
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   rradb = epsshear*lam3b
   lam3b = 0.0_8
   ELSE
   rradb = 0.0_8
   END IF
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   rradb = rradb + epsacoustic*lam2b
   lam2b = 0.0_8
   END IF
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   rradb = rradb + epsacoustic*lam1b
   lam1b = 0.0_8
   END IF
   lam3b = lam3b + rradb
   aavgb = rradb
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   CALL POPREAL8(lam3)
   unavgb = unavgb + lam3b
   sfaceb = sfaceb - lam3b
   ELSE
   CALL POPREAL8(lam3)
   sfaceb = sfaceb + lam3b
   unavgb = unavgb - lam3b
   END IF
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   unavgb = unavgb + lam2b
   sfaceb = sfaceb - lam2b
   aavgb = aavgb - lam2b
   ELSE
   sfaceb = sfaceb + lam2b
   unavgb = unavgb - lam2b
   aavgb = aavgb + lam2b
   END IF
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   unavgb = unavgb + lam1b
   sfaceb = sfaceb - lam1b
   aavgb = aavgb + lam1b
   ELSE
   sfaceb = sfaceb + lam1b
   unavgb = unavgb - lam1b
   aavgb = aavgb - lam1b
   END IF
   tmp = one/max3
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   tmpb = 0.0_8
   ELSE
   sfacekb(i, j, k) = sfacekb(i, j, k) + tmp*sfaceb
   tmpb = sfacek(i, j, k)*sfaceb
   sfaceb = 0.0_8
   END IF
   alphaavgb = alphaavgb + havgb
   temp5b0 = half*alphaavgb
   ovgm1 = one/gm1
   aavgb = aavgb - one*ovaavgb/aavg**2
   IF (a2avg .EQ. 0.0) THEN
   a2avgb = ovgm1*havgb - one*ova2avgb/a2avg**2
   ELSE
   a2avgb = aavgb/(2.0*SQRT(a2avg)) + ovgm1*havgb - one*&
   &              ova2avgb/a2avg**2
   END IF
   uavgb = uavgb + 2*uavg*temp5b0 + sx*unavgb
   sxb = sxb + uavg*unavgb
   vavgb = vavgb + 2*vavg*temp5b0 + sy*unavgb
   syb = syb + vavg*unavgb
   wavgb = wavgb + 2*wavg*temp5b0 + sz*unavgb
   szb = szb + wavg*unavgb
   CALL POPREAL8(aavg)
   CALL POPREAL8(havg)
   kavgb = -(ovgm1*gm53*havgb)
   CALL POPREAL8(sz)
   CALL POPREAL8(sy)
   CALL POPREAL8(sx)
   tmpb = tmpb + sy*syb + sx*sxb + sz*szb
   szb = tmp*szb
   syb = tmp*syb
   sxb = tmp*sxb
   max3b = -(one*tmpb/max3**2)
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   CALL POPREAL8(max3)
   areab = areab + max3b
   ELSE
   CALL POPREAL8(max3)
   END IF
   CALL POPREAL8(area)
   IF (sx**2 + sy**2 + sz**2 .EQ. 0.0) THEN
   temp5b = 0.0
   ELSE
   temp5b = areab/(2.0*SQRT(sx**2+sy**2+sz**2))
   END IF
   sxb = sxb + 2*sx*temp5b
   syb = syb + 2*sy*temp5b
   szb = szb + 2*sz*temp5b
   CALL POPREAL8(sz)
   skb(i, j, k, 3) = skb(i, j, k, 3) + szb
   CALL POPREAL8(sy)
   skb(i, j, k, 2) = skb(i, j, k, 2) + syb
   CALL POPREAL8(sx)
   skb(i, j, k, 1) = skb(i, j, k, 1) + sxb
   CALL POPREAL8(a2avg)
   temp4 = w(i, j, k, irho)
   temp3 = w(i, j, k+1, irho)
   temp3b6 = gamma(i, j, k+1)*half*a2avgb/temp3
   temp3b7 = gamma(i, j, k)*half*a2avgb/temp4
   pb(i, j, k+1) = pb(i, j, k+1) + temp3b6
   wb(i, j, k+1, irho) = wb(i, j, k+1, irho) - p(i, j, k+1)*&
   &            temp3b6/temp3
   pb(i, j, k) = pb(i, j, k) + temp3b7
   wb(i, j, k, irho) = wb(i, j, k, irho) - p(i, j, k)*temp3b7/&
   &            temp4
   wb(i, j, k+1, ivz) = wb(i, j, k+1, ivz) + half*wavgb
   wb(i, j, k, ivz) = wb(i, j, k, ivz) + half*wavgb
   wb(i, j, k+1, ivy) = wb(i, j, k+1, ivy) + half*vavgb
   wb(i, j, k, ivy) = wb(i, j, k, ivy) + half*vavgb
   wb(i, j, k+1, ivx) = wb(i, j, k+1, ivx) + half*uavgb
   wb(i, j, k, ivx) = wb(i, j, k, ivx) + half*uavgb
   CALL POPCONTROL1B(branch)
   IF (branch .NE. 0) THEN
   wb(i, j, k+1, itu1) = wb(i, j, k+1, itu1) + half*kavgb
   wb(i, j, k, itu1) = wb(i, j, k, itu1) + half*kavgb
   temp3b5 = dis0*drkb
   wb(i, j, k+1, irho) = wb(i, j, k+1, irho) + w(i, j, k+1, &
   &              itu1)*temp3b5
   wb(i, j, k+1, itu1) = wb(i, j, k+1, itu1) + w(i, j, k+1, &
   &              irho)*temp3b5
   wb(i, j, k, irho) = wb(i, j, k, irho) - w(i, j, k, itu1)*&
   &              temp3b5
   wb(i, j, k, itu1) = wb(i, j, k, itu1) - w(i, j, k, irho)*&
   &              temp3b5
   END IF
   wb(i, j, k+1, irhoe) = wb(i, j, k+1, irhoe) + dis0*dreb
   wb(i, j, k, irhoe) = wb(i, j, k, irhoe) - dis0*dreb
   CALL POPREAL8(drw)
   temp3b2 = dis0*drwb
   wb(i, j, k+1, irho) = wb(i, j, k+1, irho) + w(i, j, k+1, ivz)*&
   &            temp3b2
   wb(i, j, k+1, ivz) = wb(i, j, k+1, ivz) + w(i, j, k+1, irho)*&
   &            temp3b2
   wb(i, j, k, irho) = wb(i, j, k, irho) - w(i, j, k, ivz)*&
   &            temp3b2
   wb(i, j, k, ivz) = wb(i, j, k, ivz) - w(i, j, k, irho)*temp3b2
   CALL POPREAL8(drv)
   temp3b3 = dis0*drvb
   wb(i, j, k+1, irho) = wb(i, j, k+1, irho) + w(i, j, k+1, ivy)*&
   &            temp3b3
   wb(i, j, k+1, ivy) = wb(i, j, k+1, ivy) + w(i, j, k+1, irho)*&
   &            temp3b3
   wb(i, j, k, irho) = wb(i, j, k, irho) - w(i, j, k, ivy)*&
   &            temp3b3
   wb(i, j, k, ivy) = wb(i, j, k, ivy) - w(i, j, k, irho)*temp3b3
   CALL POPREAL8(dru)
   temp3b4 = dis0*drub
   wb(i, j, k+1, irho) = wb(i, j, k+1, irho) + w(i, j, k+1, ivx)*&
   &            temp3b4
   wb(i, j, k+1, ivx) = wb(i, j, k+1, ivx) + w(i, j, k+1, irho)*&
   &            temp3b4
   wb(i, j, k, irho) = wb(i, j, k, irho) - w(i, j, k, ivx)*&
   &            temp3b4
   wb(i, j, k, ivx) = wb(i, j, k, ivx) - w(i, j, k, irho)*temp3b4
   wb(i, j, k+1, irho) = wb(i, j, k+1, irho) + dis0*drb
   wb(i, j, k, irho) = wb(i, j, k, irho) - dis0*drb
   CALL POPREAL8(dis0)
   END DO
   END DO
   END DO
   sfacejb = 0.0_8
   DO k=kl,2,-1
   DO j=jl,1,-1
   DO i=il,2,-1
   fsb = fwb(i, j+1, k, irhoe) - fwb(i, j, k, irhoe)
   wavg = half*(w(i, j+1, k, ivz)+w(i, j, k, ivz))
   dr = dis0*(w(i, j+1, k, irho)-w(i, j, k, irho))
   vavg = half*(w(i, j+1, k, ivy)+w(i, j, k, ivy))
   uavg = half*(w(i, j+1, k, ivx)+w(i, j, k, ivx))
   unavg = uavg*sx + vavg*sy + wavg*sz
   abv5 = sx*dru + sy*drv + sz*drw - unavg*dr
   ovaavg = one/aavg
   ova2avg = one/a2avg
   abv6 = abv3*abv4*ova2avg + abv2*abv5*ovaavg
   abv7 = abv2*abv4*ovaavg + abv3*abv5
   dre = dis0*(w(i, j+1, k, irhoe)-w(i, j, k, irhoe))
   lam3b = dre*fsb
   dreb = lam3*fsb
   havgb = abv6*fsb
   abv6b = havg*fsb
   unavgb = abv7*fsb
   abv7b = unavg*fsb
   fsb = fwb(i, j+1, k, imz) - fwb(i, j, k, imz)
   lam3b = lam3b + drw*fsb
   drwb = lam3*fsb
   wavgb = abv6*fsb
   abv6b = abv6b + wavg*fsb
   szb = abv7*fsb
   abv7b = abv7b + sz*fsb
   fsb = fwb(i, j+1, k, imy) - fwb(i, j, k, imy)
   lam3b = lam3b + drv*fsb
   drvb = lam3*fsb
   vavgb = abv6*fsb
   abv6b = abv6b + vavg*fsb
   syb = abv7*fsb
   abv7b = abv7b + sy*fsb
   fsb = fwb(i, j+1, k, imx) - fwb(i, j, k, imx)
   lam3b = lam3b + dru*fsb
   drub = lam3*fsb
   uavgb = abv6*fsb
   abv6b = abv6b + uavg*fsb
   sxb = abv7*fsb
   abv7b = abv7b + sx*fsb
   fsb = fwb(i, j+1, k, irho) - fwb(i, j, k, irho)
   abv6b = abv6b + fsb
   abv2b = ovaavg*abv5*abv6b + ovaavg*abv4*abv7b
   abv4b = ova2avg*abv3*abv6b + ovaavg*abv2*abv7b
   ovaavgb = abv2*abv5*abv6b + abv2*abv4*abv7b
   abv3b = ova2avg*abv4*abv6b + abv5*abv7b
   lam3b = lam3b + dr*fsb - abv3b
   abv5b = ovaavg*abv2*abv6b + abv3*abv7b
   ova2avgb = abv3*abv4*abv6b
   sxb = sxb + dru*abv5b
   syb = syb + drv*abv5b
   szb = szb + drw*abv5b
   unavgb = unavgb - dr*abv5b
   gammaavg = half*(gamma(i, j+1, k)+gamma(i, j, k))
   gm1 = gammaavg - one
   gm53 = gammaavg - five*third
   alphaavg = half*(uavg**2+vavg**2+wavg**2)
   CALL POPREAL8(abv4)
   temp3b1 = gm1*abv4b
   drb = alphaavg*temp3b1 - unavg*abv5b + lam3*fsb
   drub = drub + sx*abv5b - uavg*temp3b1
   drvb = drvb + sy*abv5b - vavg*temp3b1
   drwb = drwb + sz*abv5b - wavg*temp3b1
   alphaavgb = dr*temp3b1
   uavgb = uavgb - dru*temp3b1
   vavgb = vavgb - drv*temp3b1
   dreb = dreb + temp3b1
   wavgb = wavgb - drw*temp3b1
   drkb = -(gm53*abv4b)
   CALL POPREAL8(abv3)
   abv1b = abv3b
   CALL POPREAL8(abv2)
   lam1b = half*abv1b + half*abv2b
   lam2b = half*abv1b - half*abv2b
   CALL POPREAL8(lam3)
   CALL POPREAL8(lam2)
   CALL POPREAL8(lam1)
   areab = lam2*lam2b + lam1*lam1b + lam3*lam3b
   lam3b = area*lam3b
   lam2b = area*lam2b
   lam1b = area*lam1b
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   rradb = epsshear*lam3b
   lam3b = 0.0_8
   ELSE
   rradb = 0.0_8
   END IF
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   rradb = rradb + epsacoustic*lam2b
   lam2b = 0.0_8
   END IF
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   rradb = rradb + epsacoustic*lam1b
   lam1b = 0.0_8
   END IF
   lam3b = lam3b + rradb
   aavgb = rradb
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   CALL POPREAL8(lam3)
   unavgb = unavgb + lam3b
   sfaceb = sfaceb - lam3b
   ELSE
   CALL POPREAL8(lam3)
   sfaceb = sfaceb + lam3b
   unavgb = unavgb - lam3b
   END IF
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   unavgb = unavgb + lam2b
   sfaceb = sfaceb - lam2b
   aavgb = aavgb - lam2b
   ELSE
   sfaceb = sfaceb + lam2b
   unavgb = unavgb - lam2b
   aavgb = aavgb + lam2b
   END IF
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   unavgb = unavgb + lam1b
   sfaceb = sfaceb - lam1b
   aavgb = aavgb + lam1b
   ELSE
   sfaceb = sfaceb + lam1b
   unavgb = unavgb - lam1b
   aavgb = aavgb - lam1b
   END IF
   tmp = one/max2
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   tmpb = 0.0_8
   ELSE
   sfacejb(i, j, k) = sfacejb(i, j, k) + tmp*sfaceb
   tmpb = sfacej(i, j, k)*sfaceb
   sfaceb = 0.0_8
   END IF
   alphaavgb = alphaavgb + havgb
   temp3b0 = half*alphaavgb
   ovgm1 = one/gm1
   aavgb = aavgb - one*ovaavgb/aavg**2
   IF (a2avg .EQ. 0.0) THEN
   a2avgb = ovgm1*havgb - one*ova2avgb/a2avg**2
   ELSE
   a2avgb = aavgb/(2.0*SQRT(a2avg)) + ovgm1*havgb - one*&
   &              ova2avgb/a2avg**2
   END IF
   uavgb = uavgb + 2*uavg*temp3b0 + sx*unavgb
   sxb = sxb + uavg*unavgb
   vavgb = vavgb + 2*vavg*temp3b0 + sy*unavgb
   syb = syb + vavg*unavgb
   wavgb = wavgb + 2*wavg*temp3b0 + sz*unavgb
   szb = szb + wavg*unavgb
   CALL POPREAL8(aavg)
   CALL POPREAL8(havg)
   kavgb = -(ovgm1*gm53*havgb)
   CALL POPREAL8(sz)
   CALL POPREAL8(sy)
   CALL POPREAL8(sx)
   tmpb = tmpb + sy*syb + sx*sxb + sz*szb
   szb = tmp*szb
   syb = tmp*syb
   sxb = tmp*sxb
   max2b = -(one*tmpb/max2**2)
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   CALL POPREAL8(max2)
   areab = areab + max2b
   ELSE
   CALL POPREAL8(max2)
   END IF
   CALL POPREAL8(area)
   IF (sx**2 + sy**2 + sz**2 .EQ. 0.0) THEN
   temp3b = 0.0
   ELSE
   temp3b = areab/(2.0*SQRT(sx**2+sy**2+sz**2))
   END IF
   sxb = sxb + 2*sx*temp3b
   syb = syb + 2*sy*temp3b
   szb = szb + 2*sz*temp3b
   CALL POPREAL8(sz)
   sjb(i, j, k, 3) = sjb(i, j, k, 3) + szb
   CALL POPREAL8(sy)
   sjb(i, j, k, 2) = sjb(i, j, k, 2) + syb
   CALL POPREAL8(sx)
   sjb(i, j, k, 1) = sjb(i, j, k, 1) + sxb
   CALL POPREAL8(a2avg)
   temp2 = w(i, j, k, irho)
   temp1 = w(i, j+1, k, irho)
   temp1b6 = gamma(i, j+1, k)*half*a2avgb/temp1
   temp1b7 = gamma(i, j, k)*half*a2avgb/temp2
   pb(i, j+1, k) = pb(i, j+1, k) + temp1b6
   wb(i, j+1, k, irho) = wb(i, j+1, k, irho) - p(i, j+1, k)*&
   &            temp1b6/temp1
   pb(i, j, k) = pb(i, j, k) + temp1b7
   wb(i, j, k, irho) = wb(i, j, k, irho) - p(i, j, k)*temp1b7/&
   &            temp2
   wb(i, j+1, k, ivz) = wb(i, j+1, k, ivz) + half*wavgb
   wb(i, j, k, ivz) = wb(i, j, k, ivz) + half*wavgb
   wb(i, j+1, k, ivy) = wb(i, j+1, k, ivy) + half*vavgb
   wb(i, j, k, ivy) = wb(i, j, k, ivy) + half*vavgb
   wb(i, j+1, k, ivx) = wb(i, j+1, k, ivx) + half*uavgb
   wb(i, j, k, ivx) = wb(i, j, k, ivx) + half*uavgb
   CALL POPCONTROL1B(branch)
   IF (branch .NE. 0) THEN
   wb(i, j+1, k, itu1) = wb(i, j+1, k, itu1) + half*kavgb
   wb(i, j, k, itu1) = wb(i, j, k, itu1) + half*kavgb
   temp1b5 = dis0*drkb
   wb(i, j+1, k, irho) = wb(i, j+1, k, irho) + w(i, j+1, k, &
   &              itu1)*temp1b5
   wb(i, j+1, k, itu1) = wb(i, j+1, k, itu1) + w(i, j+1, k, &
   &              irho)*temp1b5
   wb(i, j, k, irho) = wb(i, j, k, irho) - w(i, j, k, itu1)*&
   &              temp1b5
   wb(i, j, k, itu1) = wb(i, j, k, itu1) - w(i, j, k, irho)*&
   &              temp1b5
   END IF
   wb(i, j+1, k, irhoe) = wb(i, j+1, k, irhoe) + dis0*dreb
   wb(i, j, k, irhoe) = wb(i, j, k, irhoe) - dis0*dreb
   CALL POPREAL8(drw)
   temp1b2 = dis0*drwb
   wb(i, j+1, k, irho) = wb(i, j+1, k, irho) + w(i, j+1, k, ivz)*&
   &            temp1b2
   wb(i, j+1, k, ivz) = wb(i, j+1, k, ivz) + w(i, j+1, k, irho)*&
   &            temp1b2
   wb(i, j, k, irho) = wb(i, j, k, irho) - w(i, j, k, ivz)*&
   &            temp1b2
   wb(i, j, k, ivz) = wb(i, j, k, ivz) - w(i, j, k, irho)*temp1b2
   CALL POPREAL8(drv)
   temp1b3 = dis0*drvb
   wb(i, j+1, k, irho) = wb(i, j+1, k, irho) + w(i, j+1, k, ivy)*&
   &            temp1b3
   wb(i, j+1, k, ivy) = wb(i, j+1, k, ivy) + w(i, j+1, k, irho)*&
   &            temp1b3
   wb(i, j, k, irho) = wb(i, j, k, irho) - w(i, j, k, ivy)*&
   &            temp1b3
   wb(i, j, k, ivy) = wb(i, j, k, ivy) - w(i, j, k, irho)*temp1b3
   CALL POPREAL8(dru)
   temp1b4 = dis0*drub
   wb(i, j+1, k, irho) = wb(i, j+1, k, irho) + w(i, j+1, k, ivx)*&
   &            temp1b4
   wb(i, j+1, k, ivx) = wb(i, j+1, k, ivx) + w(i, j+1, k, irho)*&
   &            temp1b4
   wb(i, j, k, irho) = wb(i, j, k, irho) - w(i, j, k, ivx)*&
   &            temp1b4
   wb(i, j, k, ivx) = wb(i, j, k, ivx) - w(i, j, k, irho)*temp1b4
   wb(i, j+1, k, irho) = wb(i, j+1, k, irho) + dis0*drb
   wb(i, j, k, irho) = wb(i, j, k, irho) - dis0*drb
   CALL POPREAL8(dis0)
   END DO
   END DO
   END DO
   sfaceib = 0.0_8
   DO k=kl,2,-1
   DO j=jl,2,-1
   DO i=il,1,-1
   fsb = fwb(i+1, j, k, irhoe) - fwb(i, j, k, irhoe)
   wavg = half*(w(i+1, j, k, ivz)+w(i, j, k, ivz))
   dr = dis0*(w(i+1, j, k, irho)-w(i, j, k, irho))
   vavg = half*(w(i+1, j, k, ivy)+w(i, j, k, ivy))
   uavg = half*(w(i+1, j, k, ivx)+w(i, j, k, ivx))
   unavg = uavg*sx + vavg*sy + wavg*sz
   abv5 = sx*dru + sy*drv + sz*drw - unavg*dr
   ovaavg = one/aavg
   ova2avg = one/a2avg
   abv6 = abv3*abv4*ova2avg + abv2*abv5*ovaavg
   abv7 = abv2*abv4*ovaavg + abv3*abv5
   dre = dis0*(w(i+1, j, k, irhoe)-w(i, j, k, irhoe))
   lam3b = dre*fsb
   dreb = lam3*fsb
   havgb = abv6*fsb
   abv6b = havg*fsb
   unavgb = abv7*fsb
   abv7b = unavg*fsb
   fsb = fwb(i+1, j, k, imz) - fwb(i, j, k, imz)
   lam3b = lam3b + drw*fsb
   drwb = lam3*fsb
   wavgb = abv6*fsb
   abv6b = abv6b + wavg*fsb
   szb = abv7*fsb
   abv7b = abv7b + sz*fsb
   fsb = fwb(i+1, j, k, imy) - fwb(i, j, k, imy)
   lam3b = lam3b + drv*fsb
   drvb = lam3*fsb
   vavgb = abv6*fsb
   abv6b = abv6b + vavg*fsb
   syb = abv7*fsb
   abv7b = abv7b + sy*fsb
   fsb = fwb(i+1, j, k, imx) - fwb(i, j, k, imx)
   lam3b = lam3b + dru*fsb
   drub = lam3*fsb
   uavgb = abv6*fsb
   abv6b = abv6b + uavg*fsb
   sxb = abv7*fsb
   abv7b = abv7b + sx*fsb
   fsb = fwb(i+1, j, k, irho) - fwb(i, j, k, irho)
   abv6b = abv6b + fsb
   abv2b = ovaavg*abv5*abv6b + ovaavg*abv4*abv7b
   abv4b = ova2avg*abv3*abv6b + ovaavg*abv2*abv7b
   ovaavgb = abv2*abv5*abv6b + abv2*abv4*abv7b
   abv3b = ova2avg*abv4*abv6b + abv5*abv7b
   lam3b = lam3b + dr*fsb - abv3b
   abv5b = ovaavg*abv2*abv6b + abv3*abv7b
   ova2avgb = abv3*abv4*abv6b
   sxb = sxb + dru*abv5b
   syb = syb + drv*abv5b
   szb = szb + drw*abv5b
   unavgb = unavgb - dr*abv5b
   gammaavg = half*(gamma(i+1, j, k)+gamma(i, j, k))
   gm1 = gammaavg - one
   gm53 = gammaavg - five*third
   alphaavg = half*(uavg**2+vavg**2+wavg**2)
   CALL POPREAL8(abv4)
   temp1b1 = gm1*abv4b
   drb = alphaavg*temp1b1 - unavg*abv5b + lam3*fsb
   drub = drub + sx*abv5b - uavg*temp1b1
   drvb = drvb + sy*abv5b - vavg*temp1b1
   drwb = drwb + sz*abv5b - wavg*temp1b1
   alphaavgb = dr*temp1b1
   uavgb = uavgb - dru*temp1b1
   vavgb = vavgb - drv*temp1b1
   dreb = dreb + temp1b1
   wavgb = wavgb - drw*temp1b1
   drkb = -(gm53*abv4b)
   CALL POPREAL8(abv3)
   abv1b = abv3b
   CALL POPREAL8(abv2)
   lam1b = half*abv1b + half*abv2b
   lam2b = half*abv1b - half*abv2b
   CALL POPREAL8(lam3)
   CALL POPREAL8(lam2)
   CALL POPREAL8(lam1)
   areab = lam2*lam2b + lam1*lam1b + lam3*lam3b
   lam3b = area*lam3b
   lam2b = area*lam2b
   lam1b = area*lam1b
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   rradb = epsshear*lam3b
   lam3b = 0.0_8
   ELSE
   rradb = 0.0_8
   END IF
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   rradb = rradb + epsacoustic*lam2b
   lam2b = 0.0_8
   END IF
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   rradb = rradb + epsacoustic*lam1b
   lam1b = 0.0_8
   END IF
   lam3b = lam3b + rradb
   aavgb = rradb
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   CALL POPREAL8(lam3)
   unavgb = unavgb + lam3b
   sfaceb = sfaceb - lam3b
   ELSE
   CALL POPREAL8(lam3)
   sfaceb = sfaceb + lam3b
   unavgb = unavgb - lam3b
   END IF
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   unavgb = unavgb + lam2b
   sfaceb = sfaceb - lam2b
   aavgb = aavgb - lam2b
   ELSE
   sfaceb = sfaceb + lam2b
   unavgb = unavgb - lam2b
   aavgb = aavgb + lam2b
   END IF
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   unavgb = unavgb + lam1b
   sfaceb = sfaceb - lam1b
   aavgb = aavgb + lam1b
   ELSE
   sfaceb = sfaceb + lam1b
   unavgb = unavgb - lam1b
   aavgb = aavgb - lam1b
   END IF
   tmp = one/max1
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   tmpb = 0.0_8
   ELSE
   sfaceib(i, j, k) = sfaceib(i, j, k) + tmp*sfaceb
   tmpb = sfacei(i, j, k)*sfaceb
   sfaceb = 0.0_8
   END IF
   alphaavgb = alphaavgb + havgb
   temp1b0 = half*alphaavgb
   ovgm1 = one/gm1
   aavgb = aavgb - one*ovaavgb/aavg**2
   IF (a2avg .EQ. 0.0) THEN
   a2avgb = ovgm1*havgb - one*ova2avgb/a2avg**2
   ELSE
   a2avgb = aavgb/(2.0*SQRT(a2avg)) + ovgm1*havgb - one*&
   &              ova2avgb/a2avg**2
   END IF
   uavgb = uavgb + 2*uavg*temp1b0 + sx*unavgb
   sxb = sxb + uavg*unavgb
   vavgb = vavgb + 2*vavg*temp1b0 + sy*unavgb
   syb = syb + vavg*unavgb
   wavgb = wavgb + 2*wavg*temp1b0 + sz*unavgb
   szb = szb + wavg*unavgb
   CALL POPREAL8(aavg)
   CALL POPREAL8(havg)
   kavgb = -(ovgm1*gm53*havgb)
   CALL POPREAL8(sz)
   CALL POPREAL8(sy)
   CALL POPREAL8(sx)
   tmpb = tmpb + sy*syb + sx*sxb + sz*szb
   szb = tmp*szb
   syb = tmp*syb
   sxb = tmp*sxb
   max1b = -(one*tmpb/max1**2)
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   CALL POPREAL8(max1)
   areab = areab + max1b
   ELSE
   CALL POPREAL8(max1)
   END IF
   CALL POPREAL8(area)
   IF (sx**2 + sy**2 + sz**2 .EQ. 0.0) THEN
   temp1b = 0.0
   ELSE
   temp1b = areab/(2.0*SQRT(sx**2+sy**2+sz**2))
   END IF
   sxb = sxb + 2*sx*temp1b
   syb = syb + 2*sy*temp1b
   szb = szb + 2*sz*temp1b
   CALL POPREAL8(sz)
   sib(i, j, k, 3) = sib(i, j, k, 3) + szb
   CALL POPREAL8(sy)
   sib(i, j, k, 2) = sib(i, j, k, 2) + syb
   CALL POPREAL8(sx)
   sib(i, j, k, 1) = sib(i, j, k, 1) + sxb
   CALL POPREAL8(a2avg)
   temp0 = w(i, j, k, irho)
   temp = w(i+1, j, k, irho)
   tempb3 = gamma(i+1, j, k)*half*a2avgb/temp
   tempb4 = gamma(i, j, k)*half*a2avgb/temp0
   pb(i+1, j, k) = pb(i+1, j, k) + tempb3
   wb(i+1, j, k, irho) = wb(i+1, j, k, irho) - p(i+1, j, k)*&
   &            tempb3/temp
   pb(i, j, k) = pb(i, j, k) + tempb4
   wb(i, j, k, irho) = wb(i, j, k, irho) - p(i, j, k)*tempb4/&
   &            temp0
   wb(i+1, j, k, ivz) = wb(i+1, j, k, ivz) + half*wavgb
   wb(i, j, k, ivz) = wb(i, j, k, ivz) + half*wavgb
   wb(i+1, j, k, ivy) = wb(i+1, j, k, ivy) + half*vavgb
   wb(i, j, k, ivy) = wb(i, j, k, ivy) + half*vavgb
   wb(i+1, j, k, ivx) = wb(i+1, j, k, ivx) + half*uavgb
   wb(i, j, k, ivx) = wb(i, j, k, ivx) + half*uavgb
   CALL POPCONTROL1B(branch)
   IF (branch .NE. 0) THEN
   wb(i+1, j, k, itu1) = wb(i+1, j, k, itu1) + half*kavgb
   wb(i, j, k, itu1) = wb(i, j, k, itu1) + half*kavgb
   tempb2 = dis0*drkb
   wb(i+1, j, k, irho) = wb(i+1, j, k, irho) + w(i+1, j, k, &
   &              itu1)*tempb2
   wb(i+1, j, k, itu1) = wb(i+1, j, k, itu1) + w(i+1, j, k, &
   &              irho)*tempb2
   wb(i, j, k, irho) = wb(i, j, k, irho) - w(i, j, k, itu1)*&
   &              tempb2
   wb(i, j, k, itu1) = wb(i, j, k, itu1) - w(i, j, k, irho)*&
   &              tempb2
   END IF
   wb(i+1, j, k, irhoe) = wb(i+1, j, k, irhoe) + dis0*dreb
   wb(i, j, k, irhoe) = wb(i, j, k, irhoe) - dis0*dreb
   CALL POPREAL8(drw)
   tempb = dis0*drwb
   wb(i+1, j, k, irho) = wb(i+1, j, k, irho) + w(i+1, j, k, ivz)*&
   &            tempb
   wb(i+1, j, k, ivz) = wb(i+1, j, k, ivz) + w(i+1, j, k, irho)*&
   &            tempb
   wb(i, j, k, irho) = wb(i, j, k, irho) - w(i, j, k, ivz)*tempb
   wb(i, j, k, ivz) = wb(i, j, k, ivz) - w(i, j, k, irho)*tempb
   CALL POPREAL8(drv)
   tempb0 = dis0*drvb
   wb(i+1, j, k, irho) = wb(i+1, j, k, irho) + w(i+1, j, k, ivy)*&
   &            tempb0
   wb(i+1, j, k, ivy) = wb(i+1, j, k, ivy) + w(i+1, j, k, irho)*&
   &            tempb0
   wb(i, j, k, irho) = wb(i, j, k, irho) - w(i, j, k, ivy)*tempb0
   wb(i, j, k, ivy) = wb(i, j, k, ivy) - w(i, j, k, irho)*tempb0
   CALL POPREAL8(dru)
   tempb1 = dis0*drub
   wb(i+1, j, k, irho) = wb(i+1, j, k, irho) + w(i+1, j, k, ivx)*&
   &            tempb1
   wb(i+1, j, k, ivx) = wb(i+1, j, k, ivx) + w(i+1, j, k, irho)*&
   &            tempb1
   wb(i, j, k, irho) = wb(i, j, k, irho) - w(i, j, k, ivx)*tempb1
   wb(i, j, k, ivx) = wb(i, j, k, ivx) - w(i, j, k, irho)*tempb1
   wb(i+1, j, k, irho) = wb(i+1, j, k, irho) + dis0*drb
   wb(i, j, k, irho) = wb(i, j, k, irho) - dis0*drb
   CALL POPREAL8(dis0)
   END DO
   END DO
   END DO
   END IF
   END SUBROUTINE INVISCIDDISSFLUXMATRIXCOARSE_B
