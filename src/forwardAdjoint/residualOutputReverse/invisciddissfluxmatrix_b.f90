   !        Generated by TAPENADE     (INRIA, Tropics team)
   !  Tapenade 3.6 (r4159) - 21 Sep 2011 10:11
   !
   !  Differentiation of invisciddissfluxmatrix in reverse (adjoint) mode:
   !   gradient     of useful results: *p *w *si *sj *sk *fw
   !   with respect to varying inputs: *p *sfacei *sfacej *sfacek
   !                *w *si *sj *sk
   !   Plus diff mem management of: p:in sfacei:in sfacej:in gamma:in
   !                sfacek:in w:in si:in sj:in sk:in fw:in
   !
   !      ******************************************************************
   !      *                                                                *
   !      * File:          inviscidDissFluxMatrix.f90                      *
   !      * Author:        Edwin van der Weide                             *
   !      * Starting date: 03-25-2003                                      *
   !      * Last modified: 10-29-2007                                      *
   !      *                                                                *
   !      ******************************************************************
   !
   SUBROUTINE INVISCIDDISSFLUXMATRIX_B()
   USE CGNSGRID
   USE BLOCKPOINTERS_B
   USE INPUTPHYSICS
   USE INPUTDISCRETIZATION
   USE CONSTANTS
   USE ITERATION
   USE FLOWVARREFSTATE
   IMPLICIT NONE
   !
   !      ******************************************************************
   !      *                                                                *
   !      * inviscidDissFluxMatrix computes the matrix artificial          *
   !      * dissipation term. Instead of the spectral radius, as used in   *
   !      * the scalar dissipation scheme, the absolute value of the flux  *
   !      * jacobian is used. This leads to a less diffusive and           *
   !      * consequently more accurate scheme. It is assumed that the      *
   !      * pointers in blockPointers already point to the correct block.  *
   !      *                                                                *
   !      ******************************************************************
   !
   !
   !      Local parameters.
   !
   REAL(kind=realtype), PARAMETER :: dpmax=0.25_realType
   REAL(kind=realtype), PARAMETER :: epsacoustic=0.25_realType
   REAL(kind=realtype), PARAMETER :: epsshear=0.025_realType
   REAL(kind=realtype), PARAMETER :: omega=0.5_realType
   REAL(kind=realtype), PARAMETER :: oneminomega=one-omega
   !
   !      Local variables.
   !
   INTEGER(kind=inttype) :: i, j, k, ind
   REAL(kind=realtype) :: plim, sface
   REAL(kind=realtype) :: sfaceb
   REAL(kind=realtype) :: sfil, fis2, fis4
   REAL(kind=realtype) :: gammaavg, gm1, ovgm1, gm53
   REAL(kind=realtype) :: ppor, rrad, dis2, dis4
   REAL(kind=realtype) :: rradb, dis2b, dis4b
   REAL(kind=realtype) :: dp1, dp2, ddw, tmp, fs
   REAL(kind=realtype) :: dp1b, dp2b, ddwb, tmpb, fsb
   REAL(kind=realtype) :: dr, dru, drv, drw, dre, drk, sx, sy, sz
   REAL(kind=realtype) :: drb, drub, drvb, drwb, dreb, drkb, sxb, syb, &
   &  szb
   REAL(kind=realtype) :: uavg, vavg, wavg, a2avg, aavg, havg
   REAL(kind=realtype) :: uavgb, vavgb, wavgb, a2avgb, aavgb, havgb
   REAL(kind=realtype) :: alphaavg, unavg, ovaavg, ova2avg
   REAL(kind=realtype) :: alphaavgb, unavgb, ovaavgb, ova2avgb
   REAL(kind=realtype) :: kavg, lam1, lam2, lam3, area
   REAL(kind=realtype) :: kavgb, lam1b, lam2b, lam3b, areab
   REAL(kind=realtype) :: abv1, abv2, abv3, abv4, abv5, abv6, abv7
   REAL(kind=realtype) :: abv1b, abv2b, abv3b, abv4b, abv5b, abv6b, abv7b
   LOGICAL :: correctfork
   REAL(kind=realtype) :: DIM
   REAL(kind=realtype) :: arg1
   REAL(kind=realtype) :: arg1b
   INTEGER :: branch
   REAL(kind=realtype) :: temp3
   REAL(kind=realtype) :: x3b
   REAL(kind=realtype) :: temp29
   REAL(kind=realtype) :: y1b
   REAL(kind=realtype) :: temp2
   REAL(kind=realtype) :: temp28
   REAL(kind=realtype) :: temp1
   REAL(kind=realtype) :: temp27
   REAL(kind=realtype) :: temp0
   REAL(kind=realtype) :: temp13b
   REAL(kind=realtype) :: temp26
   REAL(kind=realtype) :: temp21b
   REAL(kind=realtype) :: temp25
   REAL(kind=realtype) :: min5b
   REAL(kind=realtype) :: temp24
   REAL(kind=realtype) :: temp20b1
   REAL(kind=realtype) :: temp23
   REAL(kind=realtype) :: temp20b0
   REAL(kind=realtype) :: temp22
   REAL(kind=realtype) :: x6b
   REAL(kind=realtype) :: temp57b0
   REAL(kind=realtype) :: y4b
   REAL(kind=realtype) :: temp21
   REAL(kind=realtype) :: temp58
   REAL(kind=realtype) :: temp20
   REAL(kind=realtype) :: temp57
   REAL(kind=realtype) :: temp56
   REAL(kind=realtype) :: min6
   REAL(kind=realtype) :: temp55
   REAL(kind=realtype) :: min5
   REAL(kind=realtype) :: abs1b
   REAL(kind=realtype) :: temp54
   REAL(kind=realtype) :: min4
   REAL(kind=realtype) :: temp40b
   REAL(kind=realtype) :: temp53
   REAL(kind=realtype) :: min3
   REAL(kind=realtype) :: temp52
   REAL(kind=realtype) :: min2
   REAL(kind=realtype) :: temp13b0
   REAL(kind=realtype) :: max2b
   REAL(kind=realtype) :: temp51
   REAL(kind=realtype) :: min1
   REAL(kind=realtype) :: temp50
   REAL(kind=realtype) :: temp19b
   REAL(kind=realtype) :: abs4b
   REAL(kind=realtype) :: abs11b
   REAL(kind=realtype) :: tempb0
   REAL(kind=realtype) :: temp0b
   INTRINSIC MAX
   REAL(kind=realtype) :: temp40b1
   REAL(kind=realtype) :: x6
   REAL(kind=realtype) :: temp40b0
   REAL(kind=realtype) :: x5
   REAL(kind=realtype) :: abs7b
   REAL(kind=realtype) :: x4
   REAL(kind=realtype) :: x3
   REAL(kind=realtype) :: min1b
   INTRINSIC ABS
   REAL(kind=realtype) :: x2
   REAL(kind=realtype) :: x1
   REAL(kind=realtype) :: x2b
   REAL(kind=realtype) :: temp19
   REAL(kind=realtype) :: temp18
   REAL(kind=realtype) :: temp17
   REAL(kind=realtype) :: temp33b0
   REAL(kind=realtype) :: temp16
   REAL(kind=realtype) :: temp49b
   REAL(kind=realtype) :: temp15
   REAL(kind=realtype) :: temp20b
   REAL(kind=realtype) :: min4b
   REAL(kind=realtype) :: temp57b
   REAL(kind=realtype) :: temp14
   REAL(kind=realtype) :: temp13
   REAL(kind=realtype) :: temp12
   REAL(kind=realtype) :: x5b
   REAL(kind=realtype) :: temp49
   REAL(kind=realtype) :: temp11
   REAL(kind=realtype) :: y3b
   REAL(kind=realtype) :: temp48
   REAL(kind=realtype) :: temp10
   REAL(kind=realtype) :: temp47
   REAL(kind=realtype) :: temp46
   REAL(kind=realtype) :: temp9b
   REAL(kind=realtype) :: temp45
   REAL(kind=realtype) :: temp44
   REAL(kind=realtype) :: temp43
   REAL(kind=realtype) :: temp21b1
   REAL(kind=realtype) :: temp42
   REAL(kind=realtype) :: max1b
   REAL(kind=realtype) :: temp19b3
   REAL(kind=realtype) :: temp21b0
   REAL(kind=realtype) :: y6b
   REAL(kind=realtype) :: temp41
   REAL(kind=realtype) :: temp19b2
   REAL(kind=realtype) :: temp40
   REAL(kind=realtype) :: temp19b1
   REAL(kind=realtype) :: temp19b0
   REAL(kind=realtype) :: abs3b
   REAL(kind=realtype) :: abs10b
   REAL(kind=realtype) :: temp53b0
   REAL(kind=realtype) :: tempb
   REAL(kind=realtype) :: temp0b1
   REAL(kind=realtype) :: temp29b
   REAL(kind=realtype) :: temp0b0
   REAL(kind=realtype) :: temp37b
   REAL(kind=realtype) :: abs6b
   REAL(kind=realtype) :: temp45b
   REAL(kind=realtype) :: temp53b
   REAL(kind=realtype) :: abs12
   REAL(kind=realtype) :: abs11
   REAL(kind=realtype) :: abs10
   REAL(kind=realtype) :: x1b
   REAL(kind=realtype) :: temp41b1
   REAL(kind=realtype) :: abs9b
   REAL(kind=realtype) :: temp39b3
   REAL(kind=realtype) :: temp41b0
   REAL(kind=realtype) :: temp39b2
   REAL(kind=realtype) :: temp5b
   REAL(kind=realtype) :: min3b
   REAL(kind=realtype) :: temp39b1
   REAL(kind=realtype) :: temp39b0
   REAL(kind=realtype) :: x4b
   REAL(kind=realtype) :: temp39
   REAL(kind=realtype) :: y2b
   REAL(kind=realtype) :: temp38
   REAL(kind=realtype) :: temp17b0
   REAL(kind=realtype) :: temp37
   REAL(kind=realtype) :: abs9
   REAL(kind=realtype) :: temp36
   REAL(kind=realtype) :: abs8
   REAL(kind=realtype) :: temp35
   REAL(kind=realtype) :: min6b
   REAL(kind=realtype) :: temp59b
   REAL(kind=realtype) :: abs7
   REAL(kind=realtype) :: temp34
   REAL(kind=realtype) :: abs6
   REAL(kind=realtype) :: temp33
   REAL(kind=realtype) :: abs5
   REAL(kind=realtype) :: temp32
   REAL(kind=realtype) :: abs4
   REAL(kind=realtype) :: temp31
   REAL(kind=realtype) :: y5b
   REAL(kind=realtype) :: abs3
   REAL(kind=realtype) :: temp30
   REAL(kind=realtype) :: abs2
   REAL(kind=realtype) :: temp17b
   REAL(kind=realtype) :: abs1
   REAL(kind=realtype) :: temp25b
   REAL(kind=realtype) :: abs0
   REAL(kind=realtype) :: abs2b
   REAL(kind=realtype) :: temp33b
   REAL(kind=realtype) :: temp41b
   REAL(kind=realtype) :: max3b
   REAL(kind=realtype) :: temp59b1
   INTRINSIC MIN
   REAL(kind=realtype) :: temp59b0
   REAL(kind=realtype) :: abs5b
   REAL(kind=realtype) :: abs12b
   REAL(kind=realtype) :: temp37b0
   REAL(kind=realtype) :: temp1b
   INTRINSIC SQRT
   REAL(kind=realtype) :: temp
   REAL(kind=realtype) :: max3
   REAL(kind=realtype) :: max2
   REAL(kind=realtype) :: y6
   REAL(kind=realtype) :: max1
   REAL(kind=realtype) :: temp9
   REAL(kind=realtype) :: y5
   REAL(kind=realtype) :: abs8b
   REAL(kind=realtype) :: temp8
   REAL(kind=realtype) :: temp1b1
   REAL(kind=realtype) :: temp39b
   REAL(kind=realtype) :: y4
   REAL(kind=realtype) :: temp7
   REAL(kind=realtype) :: temp1b0
   REAL(kind=realtype) :: y3
   REAL(kind=realtype) :: min2b
   REAL(kind=realtype) :: temp6
   REAL(kind=realtype) :: y2
   REAL(kind=realtype) :: temp5
   REAL(kind=realtype) :: y1
   REAL(kind=realtype) :: temp4
   IF (rfil .GE. 0.) THEN
   abs0 = rfil
   ELSE
   abs0 = -rfil
   END IF
   !
   !      ******************************************************************
   !      *                                                                *
   !      * Begin execution                                                *
   !      *                                                                *
   !      ******************************************************************
   !
   ! Check if rFil == 0. If so, the dissipative flux needs not to
   ! be computed.
   IF (abs0 .LT. thresholdreal) THEN
   sfaceib = 0.0_8
   sfacejb = 0.0_8
   sfacekb = 0.0_8
   ELSE
   ! Set the value of plim. To be fully consistent this must have
   ! the dimension of a pressure. Therefore a fraction of pInfCorr
   ! is used.
   plim = 0.001_realType*pinfcorr
   ! Determine whether or not the total energy must be corrected
   ! for the presence of the turbulent kinetic energy.
   IF (kpresent) THEN
   IF (currentlevel .EQ. groundlevel .OR. turbcoupled) THEN
   correctfork = .true.
   ELSE
   correctfork = .false.
   END IF
   ELSE
   correctfork = .false.
   END IF
   ! Initialize sface to zero. This value will be used if the
   ! block is not moving.
   sface = zero
   ! Set a couple of constants for the scheme.
   fis2 = rfil*vis2
   fis4 = rfil*vis4
   !
   !      ******************************************************************
   !      *                                                                *
   !      * Dissipative fluxes in the i-direction.                         *
   !      *                                                                *
   !      ******************************************************************
   !
   DO k=2,kl
   DO j=2,jl
   IF (p(2, j, k) - p(1, j, k) .GE. 0.) THEN
   CALL PUSHREAL8(abs1)
   abs1 = p(2, j, k) - p(1, j, k)
   CALL PUSHCONTROL1B(1)
   ELSE
   CALL PUSHREAL8(abs1)
   abs1 = -(p(2, j, k)-p(1, j, k))
   CALL PUSHCONTROL1B(0)
   END IF
   IF (p(1, j, k) - p(0, j, k) .GE. 0.) THEN
   CALL PUSHREAL8(abs7)
   abs7 = p(1, j, k) - p(0, j, k)
   CALL PUSHCONTROL1B(0)
   ELSE
   CALL PUSHREAL8(abs7)
   abs7 = -(p(1, j, k)-p(0, j, k))
   CALL PUSHCONTROL1B(1)
   END IF
   x1 = (p(2, j, k)-two*p(1, j, k)+p(0, j, k))/(omega*(p(2, j, k)+&
   &          two*p(1, j, k)+p(0, j, k))+oneminomega*(abs1+abs7)+plim)
   IF (x1 .GE. 0.) THEN
   dp1 = x1
   CALL PUSHCONTROL1B(0)
   ELSE
   dp1 = -x1
   CALL PUSHCONTROL1B(1)
   END IF
   ! Loop in i-direction.
   DO i=1,il
   IF (p(i+2, j, k) - p(i+1, j, k) .GE. 0.) THEN
   CALL PUSHREAL8(abs2)
   abs2 = p(i+2, j, k) - p(i+1, j, k)
   CALL PUSHCONTROL1B(1)
   ELSE
   CALL PUSHREAL8(abs2)
   abs2 = -(p(i+2, j, k)-p(i+1, j, k))
   CALL PUSHCONTROL1B(0)
   END IF
   IF (p(i+1, j, k) - p(i, j, k) .GE. 0.) THEN
   CALL PUSHREAL8(abs8)
   abs8 = p(i+1, j, k) - p(i, j, k)
   CALL PUSHCONTROL1B(0)
   ELSE
   CALL PUSHREAL8(abs8)
   abs8 = -(p(i+1, j, k)-p(i, j, k))
   CALL PUSHCONTROL1B(1)
   END IF
   x2 = (p(i+2, j, k)-two*p(i+1, j, k)+p(i, j, k))/(omega*(p(i+2&
   &            , j, k)+two*p(i+1, j, k)+p(i, j, k))+oneminomega*(abs2+abs8)&
   &            +plim)
   IF (x2 .GE. 0.) THEN
   dp2 = x2
   CALL PUSHCONTROL1B(0)
   ELSE
   dp2 = -x2
   CALL PUSHCONTROL1B(1)
   END IF
   CALL PUSHREAL8(ppor)
   ! Compute the dissipation coefficients for this face.
   ppor = zero
   IF (pori(i, j, k) .EQ. normalflux) ppor = one
   IF (lumpeddiss) THEN
   IF (dp1 .LT. dp2) THEN
   y1 = dp2
   CALL PUSHCONTROL1B(0)
   ELSE
   y1 = dp1
   CALL PUSHCONTROL1B(1)
   END IF
   IF (dpmax .GT. y1) THEN
   min1 = y1
   CALL PUSHCONTROL1B(0)
   ELSE
   min1 = dpmax
   CALL PUSHCONTROL1B(1)
   END IF
   CALL PUSHREAL8(dis2)
   dis2 = fis2*ppor*min1 + sigma*fis4*ppor
   CALL PUSHREAL8(dis4)
   dis4 = 0.0
   CALL PUSHCONTROL1B(0)
   ELSE
   IF (dp1 .LT. dp2) THEN
   y2 = dp2
   CALL PUSHCONTROL1B(0)
   ELSE
   y2 = dp1
   CALL PUSHCONTROL1B(1)
   END IF
   IF (dpmax .GT. y2) THEN
   min2 = y2
   CALL PUSHCONTROL1B(0)
   ELSE
   min2 = dpmax
   CALL PUSHCONTROL1B(1)
   END IF
   CALL PUSHREAL8(dis2)
   dis2 = ppor*fis2*min2
   arg1 = ppor*fis4
   CALL PUSHREAL8(dis4)
   dis4 = DIM(arg1, dis2)
   CALL PUSHCONTROL1B(1)
   END IF
   CALL PUSHREAL8(ddw)
   ! Construct the vector of the first and third differences
   ! multiplied by the appropriate constants.
   ddw = w(i+1, j, k, irho) - w(i, j, k, irho)
   CALL PUSHREAL8(dr)
   dr = dis2*ddw - dis4*(w(i+2, j, k, irho)-w(i-1, j, k, irho)-&
   &            three*ddw)
   ddw = w(i+1, j, k, irho)*w(i+1, j, k, ivx) - w(i, j, k, irho)*&
   &            w(i, j, k, ivx)
   CALL PUSHREAL8(dru)
   dru = dis2*ddw - dis4*(w(i+2, j, k, irho)*w(i+2, j, k, ivx)-w(&
   &            i-1, j, k, irho)*w(i-1, j, k, ivx)-three*ddw)
   CALL PUSHREAL8(ddw)
   ddw = w(i+1, j, k, irho)*w(i+1, j, k, ivy) - w(i, j, k, irho)*&
   &            w(i, j, k, ivy)
   CALL PUSHREAL8(drv)
   drv = dis2*ddw - dis4*(w(i+2, j, k, irho)*w(i+2, j, k, ivy)-w(&
   &            i-1, j, k, irho)*w(i-1, j, k, ivy)-three*ddw)
   CALL PUSHREAL8(ddw)
   ddw = w(i+1, j, k, irho)*w(i+1, j, k, ivz) - w(i, j, k, irho)*&
   &            w(i, j, k, ivz)
   CALL PUSHREAL8(drw)
   drw = dis2*ddw - dis4*(w(i+2, j, k, irho)*w(i+2, j, k, ivz)-w(&
   &            i-1, j, k, irho)*w(i-1, j, k, ivz)-three*ddw)
   CALL PUSHREAL8(ddw)
   ddw = w(i+1, j, k, irhoe) - w(i, j, k, irhoe)
   CALL PUSHREAL8(dre)
   dre = dis2*ddw - dis4*(w(i+2, j, k, irhoe)-w(i-1, j, k, irhoe)&
   &            -three*ddw)
   ! In case a k-equation is present, compute the difference
   ! of rhok and store the average value of k. If not present,
   ! set both these values to zero, such that later on no
   ! decision needs to be made anymore.
   IF (correctfork) THEN
   ddw = w(i+1, j, k, irho)*w(i+1, j, k, itu1) - w(i, j, k, &
   &              irho)*w(i, j, k, itu1)
   drk = dis2*ddw - dis4*(w(i+2, j, k, irho)*w(i+2, j, k, itu1)&
   &              -w(i-1, j, k, irho)*w(i-1, j, k, itu1)-three*ddw)
   kavg = half*(w(i, j, k, itu1)+w(i+1, j, k, itu1))
   CALL PUSHCONTROL1B(1)
   ELSE
   drk = zero
   kavg = zero
   CALL PUSHCONTROL1B(0)
   END IF
   ! Compute the average value of gamma and compute some
   ! expressions in which it occurs.
   gammaavg = half*(gamma(i+1, j, k)+gamma(i, j, k))
   gm1 = gammaavg - one
   ovgm1 = one/gm1
   gm53 = gammaavg - five*third
   ! Compute the average state at the interface.
   uavg = half*(w(i+1, j, k, ivx)+w(i, j, k, ivx))
   vavg = half*(w(i+1, j, k, ivy)+w(i, j, k, ivy))
   wavg = half*(w(i+1, j, k, ivz)+w(i, j, k, ivz))
   CALL PUSHREAL8(a2avg)
   a2avg = half*(gamma(i+1, j, k)*p(i+1, j, k)/w(i+1, j, k, irho)&
   &            +gamma(i, j, k)*p(i, j, k)/w(i, j, k, irho))
   CALL PUSHREAL8(sx)
   sx = si(i, j, k, 1)
   CALL PUSHREAL8(sy)
   sy = si(i, j, k, 2)
   CALL PUSHREAL8(sz)
   sz = si(i, j, k, 3)
   CALL PUSHREAL8(area)
   area = SQRT(sx**2 + sy**2 + sz**2)
   IF (1.e-25_realType .LT. area) THEN
   CALL PUSHREAL8(max1)
   max1 = area
   CALL PUSHCONTROL1B(0)
   ELSE
   CALL PUSHREAL8(max1)
   max1 = 1.e-25_realType
   CALL PUSHCONTROL1B(1)
   END IF
   tmp = one/max1
   CALL PUSHREAL8(sx)
   sx = sx*tmp
   CALL PUSHREAL8(sy)
   sy = sy*tmp
   CALL PUSHREAL8(sz)
   sz = sz*tmp
   alphaavg = half*(uavg**2+vavg**2+wavg**2)
   CALL PUSHREAL8(havg)
   havg = alphaavg + ovgm1*(a2avg-gm53*kavg)
   CALL PUSHREAL8(aavg)
   aavg = SQRT(a2avg)
   unavg = uavg*sx + vavg*sy + wavg*sz
   ! The mesh velocity if the face is moving. It must be
   ! divided by the area to obtain a true velocity.
   IF (addgridvelocities) THEN
   sface = sfacei(i, j, k)*tmp
   CALL PUSHCONTROL1B(1)
   ELSE
   CALL PUSHCONTROL1B(0)
   END IF
   IF (unavg - sface + aavg .GE. 0.) THEN
   lam1 = unavg - sface + aavg
   CALL PUSHCONTROL1B(0)
   ELSE
   lam1 = -(unavg-sface+aavg)
   CALL PUSHCONTROL1B(1)
   END IF
   IF (unavg - sface - aavg .GE. 0.) THEN
   lam2 = unavg - sface - aavg
   CALL PUSHCONTROL1B(0)
   ELSE
   lam2 = -(unavg-sface-aavg)
   CALL PUSHCONTROL1B(1)
   END IF
   IF (unavg - sface .GE. 0.) THEN
   CALL PUSHREAL8(lam3)
   lam3 = unavg - sface
   CALL PUSHCONTROL1B(0)
   ELSE
   CALL PUSHREAL8(lam3)
   lam3 = -(unavg-sface)
   CALL PUSHCONTROL1B(1)
   END IF
   rrad = lam3 + aavg
   IF (lam1 .LT. epsacoustic*rrad) THEN
   lam1 = epsacoustic*rrad
   CALL PUSHCONTROL1B(0)
   ELSE
   CALL PUSHCONTROL1B(1)
   lam1 = lam1
   END IF
   IF (lam2 .LT. epsacoustic*rrad) THEN
   lam2 = epsacoustic*rrad
   CALL PUSHCONTROL1B(0)
   ELSE
   CALL PUSHCONTROL1B(1)
   lam2 = lam2
   END IF
   IF (lam3 .LT. epsshear*rrad) THEN
   lam3 = epsshear*rrad
   CALL PUSHCONTROL1B(0)
   ELSE
   lam3 = lam3
   CALL PUSHCONTROL1B(1)
   END IF
   CALL PUSHREAL8(lam1)
   ! Multiply the eigenvalues by the area to obtain
   ! the correct values for the dissipation term.
   lam1 = lam1*area
   CALL PUSHREAL8(lam2)
   lam2 = lam2*area
   CALL PUSHREAL8(lam3)
   lam3 = lam3*area
   ! Some abbreviations, which occur quite often in the
   ! dissipation terms.
   abv1 = half*(lam1+lam2)
   CALL PUSHREAL8(abv2)
   abv2 = half*(lam1-lam2)
   CALL PUSHREAL8(abv3)
   abv3 = abv1 - lam3
   CALL PUSHREAL8(abv4)
   abv4 = gm1*(alphaavg*dr-uavg*dru-vavg*drv-wavg*drw+dre) - gm53&
   &            *drk
   ! Compute and scatter the dissipative flux.
   ! Density.
   ! X-momentum.
   ! Y-momentum.
   ! Z-momentum.
   ! Energy.
   ! Set dp1 to dp2 for the next face.
   dp1 = dp2
   END DO
   END DO
   END DO
   !
   !      ******************************************************************
   !      *                                                                *
   !      * Dissipative fluxes in the j-direction.                         *
   !      *                                                                *
   !      ******************************************************************
   !
   DO k=2,kl
   DO i=2,il
   IF (p(i, 2, k) - p(i, 1, k) .GE. 0.) THEN
   CALL PUSHREAL8(abs3)
   abs3 = p(i, 2, k) - p(i, 1, k)
   CALL PUSHCONTROL1B(1)
   ELSE
   CALL PUSHREAL8(abs3)
   abs3 = -(p(i, 2, k)-p(i, 1, k))
   CALL PUSHCONTROL1B(0)
   END IF
   IF (p(i, 1, k) - p(i, 0, k) .GE. 0.) THEN
   CALL PUSHREAL8(abs9)
   abs9 = p(i, 1, k) - p(i, 0, k)
   CALL PUSHCONTROL1B(0)
   ELSE
   CALL PUSHREAL8(abs9)
   abs9 = -(p(i, 1, k)-p(i, 0, k))
   CALL PUSHCONTROL1B(1)
   END IF
   x3 = (p(i, 2, k)-two*p(i, 1, k)+p(i, 0, k))/(omega*(p(i, 2, k)+&
   &          two*p(i, 1, k)+p(i, 0, k))+oneminomega*(abs3+abs9)+plim)
   IF (x3 .GE. 0.) THEN
   dp1 = x3
   CALL PUSHCONTROL1B(0)
   ELSE
   dp1 = -x3
   CALL PUSHCONTROL1B(1)
   END IF
   ! Loop in j-direction.
   DO j=1,jl
   IF (p(i, j+2, k) - p(i, j+1, k) .GE. 0.) THEN
   CALL PUSHREAL8(abs4)
   abs4 = p(i, j+2, k) - p(i, j+1, k)
   CALL PUSHCONTROL1B(1)
   ELSE
   CALL PUSHREAL8(abs4)
   abs4 = -(p(i, j+2, k)-p(i, j+1, k))
   CALL PUSHCONTROL1B(0)
   END IF
   IF (p(i, j+1, k) - p(i, j, k) .GE. 0.) THEN
   CALL PUSHREAL8(abs10)
   abs10 = p(i, j+1, k) - p(i, j, k)
   CALL PUSHCONTROL1B(0)
   ELSE
   CALL PUSHREAL8(abs10)
   abs10 = -(p(i, j+1, k)-p(i, j, k))
   CALL PUSHCONTROL1B(1)
   END IF
   x4 = (p(i, j+2, k)-two*p(i, j+1, k)+p(i, j, k))/(omega*(p(i, j&
   &            +2, k)+two*p(i, j+1, k)+p(i, j, k))+oneminomega*(abs4+abs10)&
   &            +plim)
   IF (x4 .GE. 0.) THEN
   dp2 = x4
   CALL PUSHCONTROL1B(0)
   ELSE
   dp2 = -x4
   CALL PUSHCONTROL1B(1)
   END IF
   CALL PUSHREAL8(ppor)
   ! Compute the dissipation coefficients for this face.
   ppor = zero
   IF (porj(i, j, k) .EQ. normalflux) ppor = one
   IF (lumpeddiss) THEN
   IF (dp1 .LT. dp2) THEN
   y3 = dp2
   CALL PUSHCONTROL1B(0)
   ELSE
   y3 = dp1
   CALL PUSHCONTROL1B(1)
   END IF
   IF (dpmax .GT. y3) THEN
   min3 = y3
   CALL PUSHCONTROL1B(0)
   ELSE
   min3 = dpmax
   CALL PUSHCONTROL1B(1)
   END IF
   CALL PUSHREAL8(dis2)
   dis2 = fis2*ppor*min3 + sigma*fis4*ppor
   CALL PUSHREAL8(dis4)
   dis4 = 0.0
   CALL PUSHCONTROL1B(0)
   ELSE
   IF (dp1 .LT. dp2) THEN
   y4 = dp2
   CALL PUSHCONTROL1B(0)
   ELSE
   y4 = dp1
   CALL PUSHCONTROL1B(1)
   END IF
   IF (dpmax .GT. y4) THEN
   min4 = y4
   CALL PUSHCONTROL1B(0)
   ELSE
   min4 = dpmax
   CALL PUSHCONTROL1B(1)
   END IF
   CALL PUSHREAL8(dis2)
   dis2 = ppor*fis2*min4
   arg1 = ppor*fis4
   CALL PUSHREAL8(dis4)
   dis4 = DIM(arg1, dis2)
   CALL PUSHCONTROL1B(1)
   END IF
   CALL PUSHREAL8(ddw)
   ! Construct the vector of the first and third differences
   ! multiplied by the appropriate constants.
   ddw = w(i, j+1, k, irho) - w(i, j, k, irho)
   CALL PUSHREAL8(dr)
   dr = dis2*ddw - dis4*(w(i, j+2, k, irho)-w(i, j-1, k, irho)-&
   &            three*ddw)
   ddw = w(i, j+1, k, irho)*w(i, j+1, k, ivx) - w(i, j, k, irho)*&
   &            w(i, j, k, ivx)
   CALL PUSHREAL8(dru)
   dru = dis2*ddw - dis4*(w(i, j+2, k, irho)*w(i, j+2, k, ivx)-w(&
   &            i, j-1, k, irho)*w(i, j-1, k, ivx)-three*ddw)
   CALL PUSHREAL8(ddw)
   ddw = w(i, j+1, k, irho)*w(i, j+1, k, ivy) - w(i, j, k, irho)*&
   &            w(i, j, k, ivy)
   CALL PUSHREAL8(drv)
   drv = dis2*ddw - dis4*(w(i, j+2, k, irho)*w(i, j+2, k, ivy)-w(&
   &            i, j-1, k, irho)*w(i, j-1, k, ivy)-three*ddw)
   CALL PUSHREAL8(ddw)
   ddw = w(i, j+1, k, irho)*w(i, j+1, k, ivz) - w(i, j, k, irho)*&
   &            w(i, j, k, ivz)
   CALL PUSHREAL8(drw)
   drw = dis2*ddw - dis4*(w(i, j+2, k, irho)*w(i, j+2, k, ivz)-w(&
   &            i, j-1, k, irho)*w(i, j-1, k, ivz)-three*ddw)
   CALL PUSHREAL8(ddw)
   ddw = w(i, j+1, k, irhoe) - w(i, j, k, irhoe)
   CALL PUSHREAL8(dre)
   dre = dis2*ddw - dis4*(w(i, j+2, k, irhoe)-w(i, j-1, k, irhoe)&
   &            -three*ddw)
   ! In case a k-equation is present, compute the difference
   ! of rhok and store the average value of k. If not present,
   ! set both these values to zero, such that later on no
   ! decision needs to be made anymore.
   IF (correctfork) THEN
   ddw = w(i, j+1, k, irho)*w(i, j+1, k, itu1) - w(i, j, k, &
   &              irho)*w(i, j, k, itu1)
   drk = dis2*ddw - dis4*(w(i, j+2, k, irho)*w(i, j+2, k, itu1)&
   &              -w(i, j-1, k, irho)*w(i, j-1, k, itu1)-three*ddw)
   kavg = half*(w(i, j, k, itu1)+w(i, j+1, k, itu1))
   CALL PUSHCONTROL1B(1)
   ELSE
   drk = zero
   kavg = zero
   CALL PUSHCONTROL1B(0)
   END IF
   ! Compute the average value of gamma and compute some
   ! expressions in which it occurs.
   gammaavg = half*(gamma(i, j+1, k)+gamma(i, j, k))
   gm1 = gammaavg - one
   ovgm1 = one/gm1
   gm53 = gammaavg - five*third
   ! Compute the average state at the interface.
   uavg = half*(w(i, j+1, k, ivx)+w(i, j, k, ivx))
   vavg = half*(w(i, j+1, k, ivy)+w(i, j, k, ivy))
   wavg = half*(w(i, j+1, k, ivz)+w(i, j, k, ivz))
   CALL PUSHREAL8(a2avg)
   a2avg = half*(gamma(i, j+1, k)*p(i, j+1, k)/w(i, j+1, k, irho)&
   &            +gamma(i, j, k)*p(i, j, k)/w(i, j, k, irho))
   CALL PUSHREAL8(sx)
   sx = sj(i, j, k, 1)
   CALL PUSHREAL8(sy)
   sy = sj(i, j, k, 2)
   CALL PUSHREAL8(sz)
   sz = sj(i, j, k, 3)
   CALL PUSHREAL8(area)
   area = SQRT(sx**2 + sy**2 + sz**2)
   IF (1.e-25_realType .LT. area) THEN
   CALL PUSHREAL8(max2)
   max2 = area
   CALL PUSHCONTROL1B(0)
   ELSE
   CALL PUSHREAL8(max2)
   max2 = 1.e-25_realType
   CALL PUSHCONTROL1B(1)
   END IF
   tmp = one/max2
   CALL PUSHREAL8(sx)
   sx = sx*tmp
   CALL PUSHREAL8(sy)
   sy = sy*tmp
   CALL PUSHREAL8(sz)
   sz = sz*tmp
   alphaavg = half*(uavg**2+vavg**2+wavg**2)
   CALL PUSHREAL8(havg)
   havg = alphaavg + ovgm1*(a2avg-gm53*kavg)
   CALL PUSHREAL8(aavg)
   aavg = SQRT(a2avg)
   unavg = uavg*sx + vavg*sy + wavg*sz
   ! The mesh velocity if the face is moving. It must be
   ! divided by the area to obtain a true velocity.
   IF (addgridvelocities) THEN
   sface = sfacej(i, j, k)*tmp
   CALL PUSHCONTROL1B(1)
   ELSE
   CALL PUSHCONTROL1B(0)
   END IF
   IF (unavg - sface + aavg .GE. 0.) THEN
   lam1 = unavg - sface + aavg
   CALL PUSHCONTROL1B(0)
   ELSE
   lam1 = -(unavg-sface+aavg)
   CALL PUSHCONTROL1B(1)
   END IF
   IF (unavg - sface - aavg .GE. 0.) THEN
   lam2 = unavg - sface - aavg
   CALL PUSHCONTROL1B(0)
   ELSE
   lam2 = -(unavg-sface-aavg)
   CALL PUSHCONTROL1B(1)
   END IF
   IF (unavg - sface .GE. 0.) THEN
   CALL PUSHREAL8(lam3)
   lam3 = unavg - sface
   CALL PUSHCONTROL1B(0)
   ELSE
   CALL PUSHREAL8(lam3)
   lam3 = -(unavg-sface)
   CALL PUSHCONTROL1B(1)
   END IF
   rrad = lam3 + aavg
   IF (lam1 .LT. epsacoustic*rrad) THEN
   lam1 = epsacoustic*rrad
   CALL PUSHCONTROL1B(0)
   ELSE
   CALL PUSHCONTROL1B(1)
   lam1 = lam1
   END IF
   IF (lam2 .LT. epsacoustic*rrad) THEN
   lam2 = epsacoustic*rrad
   CALL PUSHCONTROL1B(0)
   ELSE
   CALL PUSHCONTROL1B(1)
   lam2 = lam2
   END IF
   IF (lam3 .LT. epsshear*rrad) THEN
   lam3 = epsshear*rrad
   CALL PUSHCONTROL1B(0)
   ELSE
   lam3 = lam3
   CALL PUSHCONTROL1B(1)
   END IF
   CALL PUSHREAL8(lam1)
   ! Multiply the eigenvalues by the area to obtain
   ! the correct values for the dissipation term.
   lam1 = lam1*area
   CALL PUSHREAL8(lam2)
   lam2 = lam2*area
   CALL PUSHREAL8(lam3)
   lam3 = lam3*area
   ! Some abbreviations, which occur quite often in the
   ! dissipation terms.
   abv1 = half*(lam1+lam2)
   CALL PUSHREAL8(abv2)
   abv2 = half*(lam1-lam2)
   CALL PUSHREAL8(abv3)
   abv3 = abv1 - lam3
   CALL PUSHREAL8(abv4)
   abv4 = gm1*(alphaavg*dr-uavg*dru-vavg*drv-wavg*drw+dre) - gm53&
   &            *drk
   ! Compute and scatter the dissipative flux.
   ! Density.
   ! X-momentum.
   ! Y-momentum.
   ! Z-momentum.
   ! Energy.
   ! Set dp1 to dp2 for the next face.
   dp1 = dp2
   END DO
   END DO
   END DO
   !
   !      ******************************************************************
   !      *                                                                *
   !      * Dissipative fluxes in the k-direction.                         *
   !      *                                                                *
   !      ******************************************************************
   !
   DO j=2,jl
   DO i=2,il
   IF (p(i, j, 2) - p(i, j, 1) .GE. 0.) THEN
   CALL PUSHREAL8(abs5)
   abs5 = p(i, j, 2) - p(i, j, 1)
   CALL PUSHCONTROL1B(1)
   ELSE
   CALL PUSHREAL8(abs5)
   abs5 = -(p(i, j, 2)-p(i, j, 1))
   CALL PUSHCONTROL1B(0)
   END IF
   IF (p(i, j, 1) - p(i, j, 0) .GE. 0.) THEN
   CALL PUSHREAL8(abs11)
   abs11 = p(i, j, 1) - p(i, j, 0)
   CALL PUSHCONTROL1B(0)
   ELSE
   CALL PUSHREAL8(abs11)
   abs11 = -(p(i, j, 1)-p(i, j, 0))
   CALL PUSHCONTROL1B(1)
   END IF
   x5 = (p(i, j, 2)-two*p(i, j, 1)+p(i, j, 0))/(omega*(p(i, j, 2)+&
   &          two*p(i, j, 1)+p(i, j, 0))+oneminomega*(abs5+abs11)+plim)
   IF (x5 .GE. 0.) THEN
   dp1 = x5
   CALL PUSHCONTROL1B(0)
   ELSE
   dp1 = -x5
   CALL PUSHCONTROL1B(1)
   END IF
   ! Loop in k-direction.
   DO k=1,kl
   IF (p(i, j, k+2) - p(i, j, k+1) .GE. 0.) THEN
   CALL PUSHREAL8(abs6)
   abs6 = p(i, j, k+2) - p(i, j, k+1)
   CALL PUSHCONTROL1B(1)
   ELSE
   CALL PUSHREAL8(abs6)
   abs6 = -(p(i, j, k+2)-p(i, j, k+1))
   CALL PUSHCONTROL1B(0)
   END IF
   IF (p(i, j, k+1) - p(i, j, k) .GE. 0.) THEN
   CALL PUSHREAL8(abs12)
   abs12 = p(i, j, k+1) - p(i, j, k)
   CALL PUSHCONTROL1B(0)
   ELSE
   CALL PUSHREAL8(abs12)
   abs12 = -(p(i, j, k+1)-p(i, j, k))
   CALL PUSHCONTROL1B(1)
   END IF
   x6 = (p(i, j, k+2)-two*p(i, j, k+1)+p(i, j, k))/(omega*(p(i, j&
   &            , k+2)+two*p(i, j, k+1)+p(i, j, k))+oneminomega*(abs6+abs12)&
   &            +plim)
   IF (x6 .GE. 0.) THEN
   dp2 = x6
   CALL PUSHCONTROL1B(0)
   ELSE
   dp2 = -x6
   CALL PUSHCONTROL1B(1)
   END IF
   CALL PUSHREAL8(ppor)
   ! Compute the dissipation coefficients for this face.
   ppor = zero
   IF (pork(i, j, k) .EQ. normalflux) ppor = one
   IF (lumpeddiss) THEN
   IF (dp1 .LT. dp2) THEN
   y5 = dp2
   CALL PUSHCONTROL1B(0)
   ELSE
   y5 = dp1
   CALL PUSHCONTROL1B(1)
   END IF
   IF (dpmax .GT. y5) THEN
   min5 = y5
   CALL PUSHCONTROL1B(0)
   ELSE
   min5 = dpmax
   CALL PUSHCONTROL1B(1)
   END IF
   CALL PUSHREAL8(dis2)
   dis2 = fis2*ppor*min5 + sigma*fis4*ppor
   CALL PUSHREAL8(dis4)
   dis4 = 0.0
   CALL PUSHCONTROL1B(0)
   ELSE
   IF (dp1 .LT. dp2) THEN
   y6 = dp2
   CALL PUSHCONTROL1B(0)
   ELSE
   y6 = dp1
   CALL PUSHCONTROL1B(1)
   END IF
   IF (dpmax .GT. y6) THEN
   min6 = y6
   CALL PUSHCONTROL1B(0)
   ELSE
   min6 = dpmax
   CALL PUSHCONTROL1B(1)
   END IF
   CALL PUSHREAL8(dis2)
   dis2 = ppor*fis2*min6
   arg1 = ppor*fis4
   CALL PUSHREAL8(dis4)
   dis4 = DIM(arg1, dis2)
   CALL PUSHCONTROL1B(1)
   END IF
   CALL PUSHREAL8(ddw)
   ! Construct the vector of the first and third differences
   ! multiplied by the appropriate constants.
   ddw = w(i, j, k+1, irho) - w(i, j, k, irho)
   CALL PUSHREAL8(dr)
   dr = dis2*ddw - dis4*(w(i, j, k+2, irho)-w(i, j, k-1, irho)-&
   &            three*ddw)
   ddw = w(i, j, k+1, irho)*w(i, j, k+1, ivx) - w(i, j, k, irho)*&
   &            w(i, j, k, ivx)
   CALL PUSHREAL8(dru)
   dru = dis2*ddw - dis4*(w(i, j, k+2, irho)*w(i, j, k+2, ivx)-w(&
   &            i, j, k-1, irho)*w(i, j, k-1, ivx)-three*ddw)
   CALL PUSHREAL8(ddw)
   ddw = w(i, j, k+1, irho)*w(i, j, k+1, ivy) - w(i, j, k, irho)*&
   &            w(i, j, k, ivy)
   CALL PUSHREAL8(drv)
   drv = dis2*ddw - dis4*(w(i, j, k+2, irho)*w(i, j, k+2, ivy)-w(&
   &            i, j, k-1, irho)*w(i, j, k-1, ivy)-three*ddw)
   CALL PUSHREAL8(ddw)
   ddw = w(i, j, k+1, irho)*w(i, j, k+1, ivz) - w(i, j, k, irho)*&
   &            w(i, j, k, ivz)
   CALL PUSHREAL8(drw)
   drw = dis2*ddw - dis4*(w(i, j, k+2, irho)*w(i, j, k+2, ivz)-w(&
   &            i, j, k-1, irho)*w(i, j, k-1, ivz)-three*ddw)
   CALL PUSHREAL8(ddw)
   ddw = w(i, j, k+1, irhoe) - w(i, j, k, irhoe)
   CALL PUSHREAL8(dre)
   dre = dis2*ddw - dis4*(w(i, j, k+2, irhoe)-w(i, j, k-1, irhoe)&
   &            -three*ddw)
   ! In case a k-equation is present, compute the difference
   ! of rhok and store the average value of k. If not present,
   ! set both these values to zero, such that later on no
   ! decision needs to be made anymore.
   IF (correctfork) THEN
   ddw = w(i, j, k+1, irho)*w(i, j, k+1, itu1) - w(i, j, k, &
   &              irho)*w(i, j, k, itu1)
   drk = dis2*ddw - dis4*(w(i, j, k+2, irho)*w(i, j, k+2, itu1)&
   &              -w(i, j, k-1, irho)*w(i, j, k-1, itu1)-three*ddw)
   kavg = half*(w(i, j, k+1, itu1)+w(i, j, k, itu1))
   CALL PUSHCONTROL1B(1)
   ELSE
   drk = zero
   kavg = zero
   CALL PUSHCONTROL1B(0)
   END IF
   ! Compute the average value of gamma and compute some
   ! expressions in which it occurs.
   gammaavg = half*(gamma(i, j, k+1)+gamma(i, j, k))
   gm1 = gammaavg - one
   ovgm1 = one/gm1
   gm53 = gammaavg - five*third
   ! Compute the average state at the interface.
   uavg = half*(w(i, j, k+1, ivx)+w(i, j, k, ivx))
   vavg = half*(w(i, j, k+1, ivy)+w(i, j, k, ivy))
   wavg = half*(w(i, j, k+1, ivz)+w(i, j, k, ivz))
   CALL PUSHREAL8(a2avg)
   a2avg = half*(gamma(i, j, k+1)*p(i, j, k+1)/w(i, j, k+1, irho)&
   &            +gamma(i, j, k)*p(i, j, k)/w(i, j, k, irho))
   CALL PUSHREAL8(sx)
   sx = sk(i, j, k, 1)
   CALL PUSHREAL8(sy)
   sy = sk(i, j, k, 2)
   CALL PUSHREAL8(sz)
   sz = sk(i, j, k, 3)
   CALL PUSHREAL8(area)
   area = SQRT(sx**2 + sy**2 + sz**2)
   IF (1.e-25_realType .LT. area) THEN
   CALL PUSHREAL8(max3)
   max3 = area
   CALL PUSHCONTROL1B(0)
   ELSE
   CALL PUSHREAL8(max3)
   max3 = 1.e-25_realType
   CALL PUSHCONTROL1B(1)
   END IF
   tmp = one/max3
   CALL PUSHREAL8(sx)
   sx = sx*tmp
   CALL PUSHREAL8(sy)
   sy = sy*tmp
   CALL PUSHREAL8(sz)
   sz = sz*tmp
   alphaavg = half*(uavg**2+vavg**2+wavg**2)
   CALL PUSHREAL8(havg)
   havg = alphaavg + ovgm1*(a2avg-gm53*kavg)
   CALL PUSHREAL8(aavg)
   aavg = SQRT(a2avg)
   unavg = uavg*sx + vavg*sy + wavg*sz
   ! The mesh velocity if the face is moving. It must be
   ! divided by the area to obtain a true velocity.
   IF (addgridvelocities) THEN
   sface = sfacek(i, j, k)*tmp
   CALL PUSHCONTROL1B(1)
   ELSE
   CALL PUSHCONTROL1B(0)
   END IF
   IF (unavg - sface + aavg .GE. 0.) THEN
   lam1 = unavg - sface + aavg
   CALL PUSHCONTROL1B(0)
   ELSE
   lam1 = -(unavg-sface+aavg)
   CALL PUSHCONTROL1B(1)
   END IF
   IF (unavg - sface - aavg .GE. 0.) THEN
   lam2 = unavg - sface - aavg
   CALL PUSHCONTROL1B(0)
   ELSE
   lam2 = -(unavg-sface-aavg)
   CALL PUSHCONTROL1B(1)
   END IF
   IF (unavg - sface .GE. 0.) THEN
   CALL PUSHREAL8(lam3)
   lam3 = unavg - sface
   CALL PUSHCONTROL1B(0)
   ELSE
   CALL PUSHREAL8(lam3)
   lam3 = -(unavg-sface)
   CALL PUSHCONTROL1B(1)
   END IF
   rrad = lam3 + aavg
   IF (lam1 .LT. epsacoustic*rrad) THEN
   lam1 = epsacoustic*rrad
   CALL PUSHCONTROL1B(0)
   ELSE
   CALL PUSHCONTROL1B(1)
   lam1 = lam1
   END IF
   IF (lam2 .LT. epsacoustic*rrad) THEN
   lam2 = epsacoustic*rrad
   CALL PUSHCONTROL1B(0)
   ELSE
   CALL PUSHCONTROL1B(1)
   lam2 = lam2
   END IF
   IF (lam3 .LT. epsshear*rrad) THEN
   lam3 = epsshear*rrad
   CALL PUSHCONTROL1B(0)
   ELSE
   lam3 = lam3
   CALL PUSHCONTROL1B(1)
   END IF
   CALL PUSHREAL8(lam1)
   ! Multiply the eigenvalues by the area to obtain
   ! the correct values for the dissipation term.
   lam1 = lam1*area
   CALL PUSHREAL8(lam2)
   lam2 = lam2*area
   CALL PUSHREAL8(lam3)
   lam3 = lam3*area
   ! Some abbreviations, which occur quite often in the
   ! dissipation terms.
   abv1 = half*(lam1+lam2)
   CALL PUSHREAL8(abv2)
   abv2 = half*(lam1-lam2)
   CALL PUSHREAL8(abv3)
   abv3 = abv1 - lam3
   CALL PUSHREAL8(abv4)
   abv4 = gm1*(alphaavg*dr-uavg*dru-vavg*drv-wavg*drw+dre) - gm53&
   &            *drk
   ! Compute and scatter the dissipative flux.
   ! Density.
   ! X-momentum.
   ! Y-momentum.
   ! Z-momentum.
   ! Energy.
   ! Set dp1 to dp2 for the next face.
   dp1 = dp2
   END DO
   END DO
   END DO
   sfacekb = 0.0_8
   sfaceb = 0.0_8
   DO j=jl,2,-1
   DO i=il,2,-1
   dp1b = 0.0_8
   DO k=kl,1,-1
   dp2b = dp1b
   fsb = fwb(i, j, k+1, irhoe) - fwb(i, j, k, irhoe)
   wavg = half*(w(i, j, k+1, ivz)+w(i, j, k, ivz))
   vavg = half*(w(i, j, k+1, ivy)+w(i, j, k, ivy))
   uavg = half*(w(i, j, k+1, ivx)+w(i, j, k, ivx))
   unavg = uavg*sx + vavg*sy + wavg*sz
   abv5 = sx*dru + sy*drv + sz*drw - unavg*dr
   ovaavg = one/aavg
   ova2avg = one/a2avg
   abv6 = abv3*abv4*ova2avg + abv2*abv5*ovaavg
   abv7 = abv2*abv4*ovaavg + abv3*abv5
   lam3b = dre*fsb
   dreb = lam3*fsb
   havgb = abv6*fsb
   abv6b = havg*fsb
   unavgb = abv7*fsb
   abv7b = unavg*fsb
   fsb = fwb(i, j, k+1, imz) - fwb(i, j, k, imz)
   lam3b = lam3b + drw*fsb
   drwb = lam3*fsb
   wavgb = abv6*fsb
   abv6b = abv6b + wavg*fsb
   szb = abv7*fsb
   abv7b = abv7b + sz*fsb
   fsb = fwb(i, j, k+1, imy) - fwb(i, j, k, imy)
   lam3b = lam3b + drv*fsb
   drvb = lam3*fsb
   vavgb = abv6*fsb
   abv6b = abv6b + vavg*fsb
   syb = abv7*fsb
   abv7b = abv7b + sy*fsb
   fsb = fwb(i, j, k+1, imx) - fwb(i, j, k, imx)
   lam3b = lam3b + dru*fsb
   drub = lam3*fsb
   uavgb = abv6*fsb
   abv6b = abv6b + uavg*fsb
   sxb = abv7*fsb
   abv7b = abv7b + sx*fsb
   fsb = fwb(i, j, k+1, irho) - fwb(i, j, k, irho)
   abv6b = abv6b + fsb
   abv2b = ovaavg*abv5*abv6b + ovaavg*abv4*abv7b
   abv4b = ova2avg*abv3*abv6b + ovaavg*abv2*abv7b
   ovaavgb = abv2*abv5*abv6b + abv2*abv4*abv7b
   abv3b = ova2avg*abv4*abv6b + abv5*abv7b
   lam3b = lam3b + dr*fsb - abv3b
   abv5b = ovaavg*abv2*abv6b + abv3*abv7b
   ova2avgb = abv3*abv4*abv6b
   sxb = sxb + dru*abv5b
   syb = syb + drv*abv5b
   szb = szb + drw*abv5b
   unavgb = unavgb - dr*abv5b
   gammaavg = half*(gamma(i, j, k+1)+gamma(i, j, k))
   gm1 = gammaavg - one
   gm53 = gammaavg - five*third
   alphaavg = half*(uavg**2+vavg**2+wavg**2)
   CALL POPREAL8(abv4)
   temp59b1 = gm1*abv4b
   drb = alphaavg*temp59b1 - unavg*abv5b + lam3*fsb
   drub = drub + sx*abv5b - uavg*temp59b1
   drvb = drvb + sy*abv5b - vavg*temp59b1
   drwb = drwb + sz*abv5b - wavg*temp59b1
   alphaavgb = dr*temp59b1
   uavgb = uavgb - dru*temp59b1
   vavgb = vavgb - drv*temp59b1
   dreb = dreb + temp59b1
   wavgb = wavgb - drw*temp59b1
   drkb = -(gm53*abv4b)
   CALL POPREAL8(abv3)
   abv1b = abv3b
   CALL POPREAL8(abv2)
   lam1b = half*abv1b + half*abv2b
   lam2b = half*abv1b - half*abv2b
   CALL POPREAL8(lam3)
   CALL POPREAL8(lam2)
   CALL POPREAL8(lam1)
   areab = lam2*lam2b + lam1*lam1b + lam3*lam3b
   lam3b = area*lam3b
   lam2b = area*lam2b
   lam1b = area*lam1b
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   rradb = epsshear*lam3b
   lam3b = 0.0_8
   ELSE
   rradb = 0.0_8
   END IF
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   rradb = rradb + epsacoustic*lam2b
   lam2b = 0.0_8
   END IF
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   rradb = rradb + epsacoustic*lam1b
   lam1b = 0.0_8
   END IF
   lam3b = lam3b + rradb
   aavgb = rradb
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   CALL POPREAL8(lam3)
   unavgb = unavgb + lam3b
   sfaceb = sfaceb - lam3b
   ELSE
   CALL POPREAL8(lam3)
   sfaceb = sfaceb + lam3b
   unavgb = unavgb - lam3b
   END IF
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   unavgb = unavgb + lam2b
   sfaceb = sfaceb - lam2b
   aavgb = aavgb - lam2b
   ELSE
   sfaceb = sfaceb + lam2b
   unavgb = unavgb - lam2b
   aavgb = aavgb + lam2b
   END IF
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   unavgb = unavgb + lam1b
   sfaceb = sfaceb - lam1b
   aavgb = aavgb + lam1b
   ELSE
   sfaceb = sfaceb + lam1b
   unavgb = unavgb - lam1b
   aavgb = aavgb - lam1b
   END IF
   tmp = one/max3
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   tmpb = 0.0_8
   ELSE
   sfacekb(i, j, k) = sfacekb(i, j, k) + tmp*sfaceb
   tmpb = sfacek(i, j, k)*sfaceb
   sfaceb = 0.0_8
   END IF
   alphaavgb = alphaavgb + havgb
   temp59b0 = half*alphaavgb
   ovgm1 = one/gm1
   aavgb = aavgb - one*ovaavgb/aavg**2
   IF (a2avg .EQ. 0.0) THEN
   a2avgb = ovgm1*havgb - one*ova2avgb/a2avg**2
   ELSE
   a2avgb = aavgb/(2.0*SQRT(a2avg)) + ovgm1*havgb - one*&
   &              ova2avgb/a2avg**2
   END IF
   uavgb = uavgb + 2*uavg*temp59b0 + sx*unavgb
   sxb = sxb + uavg*unavgb
   vavgb = vavgb + 2*vavg*temp59b0 + sy*unavgb
   syb = syb + vavg*unavgb
   wavgb = wavgb + 2*wavg*temp59b0 + sz*unavgb
   szb = szb + wavg*unavgb
   CALL POPREAL8(aavg)
   CALL POPREAL8(havg)
   kavgb = -(ovgm1*gm53*havgb)
   CALL POPREAL8(sz)
   CALL POPREAL8(sy)
   CALL POPREAL8(sx)
   tmpb = tmpb + sy*syb + sx*sxb + sz*szb
   szb = tmp*szb
   syb = tmp*syb
   sxb = tmp*sxb
   max3b = -(one*tmpb/max3**2)
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   CALL POPREAL8(max3)
   areab = areab + max3b
   ELSE
   CALL POPREAL8(max3)
   END IF
   CALL POPREAL8(area)
   IF (sx**2 + sy**2 + sz**2 .EQ. 0.0) THEN
   temp59b = 0.0
   ELSE
   temp59b = areab/(2.0*SQRT(sx**2+sy**2+sz**2))
   END IF
   sxb = sxb + 2*sx*temp59b
   syb = syb + 2*sy*temp59b
   szb = szb + 2*sz*temp59b
   CALL POPREAL8(sz)
   skb(i, j, k, 3) = skb(i, j, k, 3) + szb
   CALL POPREAL8(sy)
   skb(i, j, k, 2) = skb(i, j, k, 2) + syb
   CALL POPREAL8(sx)
   skb(i, j, k, 1) = skb(i, j, k, 1) + sxb
   CALL POPREAL8(a2avg)
   temp58 = w(i, j, k, irho)
   temp57 = w(i, j, k+1, irho)
   temp57b = gamma(i, j, k+1)*half*a2avgb/temp57
   temp57b0 = gamma(i, j, k)*half*a2avgb/temp58
   pb(i, j, k+1) = pb(i, j, k+1) + temp57b
   wb(i, j, k+1, irho) = wb(i, j, k+1, irho) - p(i, j, k+1)*&
   &            temp57b/temp57
   pb(i, j, k) = pb(i, j, k) + temp57b0
   wb(i, j, k, irho) = wb(i, j, k, irho) - p(i, j, k)*temp57b0/&
   &            temp58
   wb(i, j, k+1, ivz) = wb(i, j, k+1, ivz) + half*wavgb
   wb(i, j, k, ivz) = wb(i, j, k, ivz) + half*wavgb
   wb(i, j, k+1, ivy) = wb(i, j, k+1, ivy) + half*vavgb
   wb(i, j, k, ivy) = wb(i, j, k, ivy) + half*vavgb
   wb(i, j, k+1, ivx) = wb(i, j, k+1, ivx) + half*uavgb
   wb(i, j, k, ivx) = wb(i, j, k, ivx) + half*uavgb
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   dis2b = 0.0_8
   dis4b = 0.0_8
   ELSE
   wb(i, j, k+1, itu1) = wb(i, j, k+1, itu1) + half*kavgb
   wb(i, j, k, itu1) = wb(i, j, k, itu1) + half*kavgb
   temp56 = w(i, j, k-1, itu1)
   temp55 = w(i, j, k-1, irho)
   temp54 = w(i, j, k+2, itu1)
   temp53 = w(i, j, k+2, irho)
   temp53b0 = -(dis4*drkb)
   dis2b = ddw*drkb
   ddwb = dis2*drkb - three*temp53b0
   dis4b = -((temp53*temp54-temp55*temp56-three*ddw)*drkb)
   wb(i, j, k+2, irho) = wb(i, j, k+2, irho) + temp54*temp53b0
   wb(i, j, k+2, itu1) = wb(i, j, k+2, itu1) + temp53*temp53b0
   wb(i, j, k-1, irho) = wb(i, j, k-1, irho) - temp56*temp53b0
   wb(i, j, k-1, itu1) = wb(i, j, k-1, itu1) - temp55*temp53b0
   wb(i, j, k+1, irho) = wb(i, j, k+1, irho) + w(i, j, k+1, &
   &              itu1)*ddwb
   wb(i, j, k+1, itu1) = wb(i, j, k+1, itu1) + w(i, j, k+1, &
   &              irho)*ddwb
   wb(i, j, k, irho) = wb(i, j, k, irho) - w(i, j, k, itu1)*&
   &              ddwb
   wb(i, j, k, itu1) = wb(i, j, k, itu1) - w(i, j, k, irho)*&
   &              ddwb
   END IF
   ddw = w(i, j, k+1, irhoe) - w(i, j, k, irhoe)
   CALL POPREAL8(dre)
   temp53b = -(dis4*dreb)
   dis2b = dis2b + ddw*dreb
   ddwb = dis2*dreb - three*temp53b
   dis4b = dis4b - (w(i, j, k+2, irhoe)-w(i, j, k-1, irhoe)-three&
   &            *ddw)*dreb
   wb(i, j, k+2, irhoe) = wb(i, j, k+2, irhoe) + temp53b
   wb(i, j, k-1, irhoe) = wb(i, j, k-1, irhoe) - temp53b
   CALL POPREAL8(ddw)
   wb(i, j, k+1, irhoe) = wb(i, j, k+1, irhoe) + ddwb
   wb(i, j, k, irhoe) = wb(i, j, k, irhoe) - ddwb
   CALL POPREAL8(drw)
   temp52 = w(i, j, k-1, ivz)
   temp51 = w(i, j, k-1, irho)
   temp50 = w(i, j, k+2, ivz)
   temp49 = w(i, j, k+2, irho)
   temp49b = -(dis4*drwb)
   dis2b = dis2b + ddw*drwb
   ddwb = dis2*drwb - three*temp49b
   dis4b = dis4b - (temp49*temp50-temp51*temp52-three*ddw)*drwb
   wb(i, j, k+2, irho) = wb(i, j, k+2, irho) + temp50*temp49b
   wb(i, j, k+2, ivz) = wb(i, j, k+2, ivz) + temp49*temp49b
   wb(i, j, k-1, irho) = wb(i, j, k-1, irho) - temp52*temp49b
   wb(i, j, k-1, ivz) = wb(i, j, k-1, ivz) - temp51*temp49b
   CALL POPREAL8(ddw)
   wb(i, j, k+1, irho) = wb(i, j, k+1, irho) + w(i, j, k+1, ivz)*&
   &            ddwb
   wb(i, j, k+1, ivz) = wb(i, j, k+1, ivz) + w(i, j, k+1, irho)*&
   &            ddwb
   wb(i, j, k, irho) = wb(i, j, k, irho) - w(i, j, k, ivz)*ddwb
   wb(i, j, k, ivz) = wb(i, j, k, ivz) - w(i, j, k, irho)*ddwb
   CALL POPREAL8(drv)
   temp48 = w(i, j, k-1, ivy)
   temp47 = w(i, j, k-1, irho)
   temp46 = w(i, j, k+2, ivy)
   temp45 = w(i, j, k+2, irho)
   temp45b = -(dis4*drvb)
   dis2b = dis2b + ddw*drvb
   ddwb = dis2*drvb - three*temp45b
   dis4b = dis4b - (temp45*temp46-temp47*temp48-three*ddw)*drvb
   wb(i, j, k+2, irho) = wb(i, j, k+2, irho) + temp46*temp45b
   wb(i, j, k+2, ivy) = wb(i, j, k+2, ivy) + temp45*temp45b
   wb(i, j, k-1, irho) = wb(i, j, k-1, irho) - temp48*temp45b
   wb(i, j, k-1, ivy) = wb(i, j, k-1, ivy) - temp47*temp45b
   CALL POPREAL8(ddw)
   wb(i, j, k+1, irho) = wb(i, j, k+1, irho) + w(i, j, k+1, ivy)*&
   &            ddwb
   wb(i, j, k+1, ivy) = wb(i, j, k+1, ivy) + w(i, j, k+1, irho)*&
   &            ddwb
   wb(i, j, k, irho) = wb(i, j, k, irho) - w(i, j, k, ivy)*ddwb
   wb(i, j, k, ivy) = wb(i, j, k, ivy) - w(i, j, k, irho)*ddwb
   CALL POPREAL8(dru)
   temp44 = w(i, j, k-1, ivx)
   temp43 = w(i, j, k-1, irho)
   temp42 = w(i, j, k+2, ivx)
   temp41 = w(i, j, k+2, irho)
   temp41b0 = -(dis4*drub)
   dis2b = dis2b + ddw*drub
   ddwb = dis2*drub - three*temp41b0
   dis4b = dis4b - (temp41*temp42-temp43*temp44-three*ddw)*drub
   wb(i, j, k+2, irho) = wb(i, j, k+2, irho) + temp42*temp41b0
   wb(i, j, k+2, ivx) = wb(i, j, k+2, ivx) + temp41*temp41b0
   wb(i, j, k-1, irho) = wb(i, j, k-1, irho) - temp44*temp41b0
   wb(i, j, k-1, ivx) = wb(i, j, k-1, ivx) - temp43*temp41b0
   wb(i, j, k+1, irho) = wb(i, j, k+1, irho) + w(i, j, k+1, ivx)*&
   &            ddwb
   wb(i, j, k+1, ivx) = wb(i, j, k+1, ivx) + w(i, j, k+1, irho)*&
   &            ddwb
   wb(i, j, k, irho) = wb(i, j, k, irho) - w(i, j, k, ivx)*ddwb
   wb(i, j, k, ivx) = wb(i, j, k, ivx) - w(i, j, k, irho)*ddwb
   ddw = w(i, j, k+1, irho) - w(i, j, k, irho)
   CALL POPREAL8(dr)
   temp41b1 = -(dis4*drb)
   dis2b = dis2b + ddw*drb
   ddwb = dis2*drb - three*temp41b1
   dis4b = dis4b - (w(i, j, k+2, irho)-w(i, j, k-1, irho)-three*&
   &            ddw)*drb
   wb(i, j, k+2, irho) = wb(i, j, k+2, irho) + temp41b1
   wb(i, j, k-1, irho) = wb(i, j, k-1, irho) - temp41b1
   CALL POPREAL8(ddw)
   wb(i, j, k+1, irho) = wb(i, j, k+1, irho) + ddwb
   wb(i, j, k, irho) = wb(i, j, k, irho) - ddwb
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   CALL POPREAL8(dis4)
   CALL POPREAL8(dis2)
   min5b = fis2*ppor*dis2b
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   y5b = min5b
   ELSE
   y5b = 0.0_8
   END IF
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   dp2b = dp2b + y5b
   dp1b = 0.0_8
   ELSE
   dp1b = y5b
   END IF
   ELSE
   arg1 = ppor*fis4
   CALL POPREAL8(dis4)
   CALL DIM_B(arg1, arg1b, dis2, dis2b, dis4b)
   CALL POPREAL8(dis2)
   min6b = ppor*fis2*dis2b
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   y6b = min6b
   ELSE
   y6b = 0.0_8
   END IF
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   dp2b = dp2b + y6b
   dp1b = 0.0_8
   ELSE
   dp1b = y6b
   END IF
   END IF
   CALL POPREAL8(ppor)
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   x6b = dp2b
   ELSE
   x6b = -dp2b
   END IF
   temp40 = plim + omega*(p(i, j, k+2)+two*p(i, j, k+1)+p(i, j, k&
   &            )) + oneminomega*(abs6+abs12)
   temp40b0 = x6b/temp40
   temp40b1 = -((p(i, j, k+2)-two*p(i, j, k+1)+p(i, j, k))*&
   &            temp40b0/temp40)
   temp41b = omega*temp40b1
   pb(i, j, k+2) = pb(i, j, k+2) + temp41b + temp40b0
   pb(i, j, k+1) = pb(i, j, k+1) + two*temp41b - two*temp40b0
   pb(i, j, k) = pb(i, j, k) + temp41b + temp40b0
   abs6b = oneminomega*temp40b1
   abs12b = oneminomega*temp40b1
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   CALL POPREAL8(abs12)
   pb(i, j, k+1) = pb(i, j, k+1) + abs12b
   pb(i, j, k) = pb(i, j, k) - abs12b
   ELSE
   CALL POPREAL8(abs12)
   pb(i, j, k) = pb(i, j, k) + abs12b
   pb(i, j, k+1) = pb(i, j, k+1) - abs12b
   END IF
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   CALL POPREAL8(abs6)
   pb(i, j, k+1) = pb(i, j, k+1) + abs6b
   pb(i, j, k+2) = pb(i, j, k+2) - abs6b
   ELSE
   CALL POPREAL8(abs6)
   pb(i, j, k+2) = pb(i, j, k+2) + abs6b
   pb(i, j, k+1) = pb(i, j, k+1) - abs6b
   END IF
   END DO
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   x5b = dp1b
   ELSE
   x5b = -dp1b
   END IF
   temp39 = plim + omega*(p(i, j, 2)+two*p(i, j, 1)+p(i, j, 0)) + &
   &          oneminomega*(abs5+abs11)
   temp39b2 = x5b/temp39
   temp39b3 = -((p(i, j, 2)-two*p(i, j, 1)+p(i, j, 0))*temp39b2/&
   &          temp39)
   temp40b = omega*temp39b3
   pb(i, j, 2) = pb(i, j, 2) + temp40b + temp39b2
   pb(i, j, 1) = pb(i, j, 1) + two*temp40b - two*temp39b2
   pb(i, j, 0) = pb(i, j, 0) + temp40b + temp39b2
   abs5b = oneminomega*temp39b3
   abs11b = oneminomega*temp39b3
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   CALL POPREAL8(abs11)
   pb(i, j, 1) = pb(i, j, 1) + abs11b
   pb(i, j, 0) = pb(i, j, 0) - abs11b
   ELSE
   CALL POPREAL8(abs11)
   pb(i, j, 0) = pb(i, j, 0) + abs11b
   pb(i, j, 1) = pb(i, j, 1) - abs11b
   END IF
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   CALL POPREAL8(abs5)
   pb(i, j, 1) = pb(i, j, 1) + abs5b
   pb(i, j, 2) = pb(i, j, 2) - abs5b
   ELSE
   CALL POPREAL8(abs5)
   pb(i, j, 2) = pb(i, j, 2) + abs5b
   pb(i, j, 1) = pb(i, j, 1) - abs5b
   END IF
   END DO
   END DO
   sfacejb = 0.0_8
   DO k=kl,2,-1
   DO i=il,2,-1
   dp1b = 0.0_8
   DO j=jl,1,-1
   dp2b = dp1b
   fsb = fwb(i, j+1, k, irhoe) - fwb(i, j, k, irhoe)
   wavg = half*(w(i, j+1, k, ivz)+w(i, j, k, ivz))
   vavg = half*(w(i, j+1, k, ivy)+w(i, j, k, ivy))
   uavg = half*(w(i, j+1, k, ivx)+w(i, j, k, ivx))
   unavg = uavg*sx + vavg*sy + wavg*sz
   abv5 = sx*dru + sy*drv + sz*drw - unavg*dr
   ovaavg = one/aavg
   ova2avg = one/a2avg
   abv6 = abv3*abv4*ova2avg + abv2*abv5*ovaavg
   abv7 = abv2*abv4*ovaavg + abv3*abv5
   lam3b = dre*fsb
   dreb = lam3*fsb
   havgb = abv6*fsb
   abv6b = havg*fsb
   unavgb = abv7*fsb
   abv7b = unavg*fsb
   fsb = fwb(i, j+1, k, imz) - fwb(i, j, k, imz)
   lam3b = lam3b + drw*fsb
   drwb = lam3*fsb
   wavgb = abv6*fsb
   abv6b = abv6b + wavg*fsb
   szb = abv7*fsb
   abv7b = abv7b + sz*fsb
   fsb = fwb(i, j+1, k, imy) - fwb(i, j, k, imy)
   lam3b = lam3b + drv*fsb
   drvb = lam3*fsb
   vavgb = abv6*fsb
   abv6b = abv6b + vavg*fsb
   syb = abv7*fsb
   abv7b = abv7b + sy*fsb
   fsb = fwb(i, j+1, k, imx) - fwb(i, j, k, imx)
   lam3b = lam3b + dru*fsb
   drub = lam3*fsb
   uavgb = abv6*fsb
   abv6b = abv6b + uavg*fsb
   sxb = abv7*fsb
   abv7b = abv7b + sx*fsb
   fsb = fwb(i, j+1, k, irho) - fwb(i, j, k, irho)
   abv6b = abv6b + fsb
   abv2b = ovaavg*abv5*abv6b + ovaavg*abv4*abv7b
   abv4b = ova2avg*abv3*abv6b + ovaavg*abv2*abv7b
   ovaavgb = abv2*abv5*abv6b + abv2*abv4*abv7b
   abv3b = ova2avg*abv4*abv6b + abv5*abv7b
   lam3b = lam3b + dr*fsb - abv3b
   abv5b = ovaavg*abv2*abv6b + abv3*abv7b
   ova2avgb = abv3*abv4*abv6b
   sxb = sxb + dru*abv5b
   syb = syb + drv*abv5b
   szb = szb + drw*abv5b
   unavgb = unavgb - dr*abv5b
   gammaavg = half*(gamma(i, j+1, k)+gamma(i, j, k))
   gm1 = gammaavg - one
   gm53 = gammaavg - five*third
   alphaavg = half*(uavg**2+vavg**2+wavg**2)
   CALL POPREAL8(abv4)
   temp39b1 = gm1*abv4b
   drb = alphaavg*temp39b1 - unavg*abv5b + lam3*fsb
   drub = drub + sx*abv5b - uavg*temp39b1
   drvb = drvb + sy*abv5b - vavg*temp39b1
   drwb = drwb + sz*abv5b - wavg*temp39b1
   alphaavgb = dr*temp39b1
   uavgb = uavgb - dru*temp39b1
   vavgb = vavgb - drv*temp39b1
   dreb = dreb + temp39b1
   wavgb = wavgb - drw*temp39b1
   drkb = -(gm53*abv4b)
   CALL POPREAL8(abv3)
   abv1b = abv3b
   CALL POPREAL8(abv2)
   lam1b = half*abv1b + half*abv2b
   lam2b = half*abv1b - half*abv2b
   CALL POPREAL8(lam3)
   CALL POPREAL8(lam2)
   CALL POPREAL8(lam1)
   areab = lam2*lam2b + lam1*lam1b + lam3*lam3b
   lam3b = area*lam3b
   lam2b = area*lam2b
   lam1b = area*lam1b
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   rradb = epsshear*lam3b
   lam3b = 0.0_8
   ELSE
   rradb = 0.0_8
   END IF
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   rradb = rradb + epsacoustic*lam2b
   lam2b = 0.0_8
   END IF
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   rradb = rradb + epsacoustic*lam1b
   lam1b = 0.0_8
   END IF
   lam3b = lam3b + rradb
   aavgb = rradb
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   CALL POPREAL8(lam3)
   unavgb = unavgb + lam3b
   sfaceb = sfaceb - lam3b
   ELSE
   CALL POPREAL8(lam3)
   sfaceb = sfaceb + lam3b
   unavgb = unavgb - lam3b
   END IF
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   unavgb = unavgb + lam2b
   sfaceb = sfaceb - lam2b
   aavgb = aavgb - lam2b
   ELSE
   sfaceb = sfaceb + lam2b
   unavgb = unavgb - lam2b
   aavgb = aavgb + lam2b
   END IF
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   unavgb = unavgb + lam1b
   sfaceb = sfaceb - lam1b
   aavgb = aavgb + lam1b
   ELSE
   sfaceb = sfaceb + lam1b
   unavgb = unavgb - lam1b
   aavgb = aavgb - lam1b
   END IF
   tmp = one/max2
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   tmpb = 0.0_8
   ELSE
   sfacejb(i, j, k) = sfacejb(i, j, k) + tmp*sfaceb
   tmpb = sfacej(i, j, k)*sfaceb
   sfaceb = 0.0_8
   END IF
   alphaavgb = alphaavgb + havgb
   temp39b0 = half*alphaavgb
   ovgm1 = one/gm1
   aavgb = aavgb - one*ovaavgb/aavg**2
   IF (a2avg .EQ. 0.0) THEN
   a2avgb = ovgm1*havgb - one*ova2avgb/a2avg**2
   ELSE
   a2avgb = aavgb/(2.0*SQRT(a2avg)) + ovgm1*havgb - one*&
   &              ova2avgb/a2avg**2
   END IF
   uavgb = uavgb + 2*uavg*temp39b0 + sx*unavgb
   sxb = sxb + uavg*unavgb
   vavgb = vavgb + 2*vavg*temp39b0 + sy*unavgb
   syb = syb + vavg*unavgb
   wavgb = wavgb + 2*wavg*temp39b0 + sz*unavgb
   szb = szb + wavg*unavgb
   CALL POPREAL8(aavg)
   CALL POPREAL8(havg)
   kavgb = -(ovgm1*gm53*havgb)
   CALL POPREAL8(sz)
   CALL POPREAL8(sy)
   CALL POPREAL8(sx)
   tmpb = tmpb + sy*syb + sx*sxb + sz*szb
   szb = tmp*szb
   syb = tmp*syb
   sxb = tmp*sxb
   max2b = -(one*tmpb/max2**2)
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   CALL POPREAL8(max2)
   areab = areab + max2b
   ELSE
   CALL POPREAL8(max2)
   END IF
   CALL POPREAL8(area)
   IF (sx**2 + sy**2 + sz**2 .EQ. 0.0) THEN
   temp39b = 0.0
   ELSE
   temp39b = areab/(2.0*SQRT(sx**2+sy**2+sz**2))
   END IF
   sxb = sxb + 2*sx*temp39b
   syb = syb + 2*sy*temp39b
   szb = szb + 2*sz*temp39b
   CALL POPREAL8(sz)
   sjb(i, j, k, 3) = sjb(i, j, k, 3) + szb
   CALL POPREAL8(sy)
   sjb(i, j, k, 2) = sjb(i, j, k, 2) + syb
   CALL POPREAL8(sx)
   sjb(i, j, k, 1) = sjb(i, j, k, 1) + sxb
   CALL POPREAL8(a2avg)
   temp38 = w(i, j, k, irho)
   temp37 = w(i, j+1, k, irho)
   temp37b = gamma(i, j+1, k)*half*a2avgb/temp37
   temp37b0 = gamma(i, j, k)*half*a2avgb/temp38
   pb(i, j+1, k) = pb(i, j+1, k) + temp37b
   wb(i, j+1, k, irho) = wb(i, j+1, k, irho) - p(i, j+1, k)*&
   &            temp37b/temp37
   pb(i, j, k) = pb(i, j, k) + temp37b0
   wb(i, j, k, irho) = wb(i, j, k, irho) - p(i, j, k)*temp37b0/&
   &            temp38
   wb(i, j+1, k, ivz) = wb(i, j+1, k, ivz) + half*wavgb
   wb(i, j, k, ivz) = wb(i, j, k, ivz) + half*wavgb
   wb(i, j+1, k, ivy) = wb(i, j+1, k, ivy) + half*vavgb
   wb(i, j, k, ivy) = wb(i, j, k, ivy) + half*vavgb
   wb(i, j+1, k, ivx) = wb(i, j+1, k, ivx) + half*uavgb
   wb(i, j, k, ivx) = wb(i, j, k, ivx) + half*uavgb
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   dis2b = 0.0_8
   dis4b = 0.0_8
   ELSE
   wb(i, j, k, itu1) = wb(i, j, k, itu1) + half*kavgb
   wb(i, j+1, k, itu1) = wb(i, j+1, k, itu1) + half*kavgb
   temp36 = w(i, j-1, k, itu1)
   temp35 = w(i, j-1, k, irho)
   temp34 = w(i, j+2, k, itu1)
   temp33 = w(i, j+2, k, irho)
   temp33b0 = -(dis4*drkb)
   dis2b = ddw*drkb
   ddwb = dis2*drkb - three*temp33b0
   dis4b = -((temp33*temp34-temp35*temp36-three*ddw)*drkb)
   wb(i, j+2, k, irho) = wb(i, j+2, k, irho) + temp34*temp33b0
   wb(i, j+2, k, itu1) = wb(i, j+2, k, itu1) + temp33*temp33b0
   wb(i, j-1, k, irho) = wb(i, j-1, k, irho) - temp36*temp33b0
   wb(i, j-1, k, itu1) = wb(i, j-1, k, itu1) - temp35*temp33b0
   wb(i, j+1, k, irho) = wb(i, j+1, k, irho) + w(i, j+1, k, &
   &              itu1)*ddwb
   wb(i, j+1, k, itu1) = wb(i, j+1, k, itu1) + w(i, j+1, k, &
   &              irho)*ddwb
   wb(i, j, k, irho) = wb(i, j, k, irho) - w(i, j, k, itu1)*&
   &              ddwb
   wb(i, j, k, itu1) = wb(i, j, k, itu1) - w(i, j, k, irho)*&
   &              ddwb
   END IF
   ddw = w(i, j+1, k, irhoe) - w(i, j, k, irhoe)
   CALL POPREAL8(dre)
   temp33b = -(dis4*dreb)
   dis2b = dis2b + ddw*dreb
   ddwb = dis2*dreb - three*temp33b
   dis4b = dis4b - (w(i, j+2, k, irhoe)-w(i, j-1, k, irhoe)-three&
   &            *ddw)*dreb
   wb(i, j+2, k, irhoe) = wb(i, j+2, k, irhoe) + temp33b
   wb(i, j-1, k, irhoe) = wb(i, j-1, k, irhoe) - temp33b
   CALL POPREAL8(ddw)
   wb(i, j+1, k, irhoe) = wb(i, j+1, k, irhoe) + ddwb
   wb(i, j, k, irhoe) = wb(i, j, k, irhoe) - ddwb
   CALL POPREAL8(drw)
   temp32 = w(i, j-1, k, ivz)
   temp31 = w(i, j-1, k, irho)
   temp30 = w(i, j+2, k, ivz)
   temp29 = w(i, j+2, k, irho)
   temp29b = -(dis4*drwb)
   dis2b = dis2b + ddw*drwb
   ddwb = dis2*drwb - three*temp29b
   dis4b = dis4b - (temp29*temp30-temp31*temp32-three*ddw)*drwb
   wb(i, j+2, k, irho) = wb(i, j+2, k, irho) + temp30*temp29b
   wb(i, j+2, k, ivz) = wb(i, j+2, k, ivz) + temp29*temp29b
   wb(i, j-1, k, irho) = wb(i, j-1, k, irho) - temp32*temp29b
   wb(i, j-1, k, ivz) = wb(i, j-1, k, ivz) - temp31*temp29b
   CALL POPREAL8(ddw)
   wb(i, j+1, k, irho) = wb(i, j+1, k, irho) + w(i, j+1, k, ivz)*&
   &            ddwb
   wb(i, j+1, k, ivz) = wb(i, j+1, k, ivz) + w(i, j+1, k, irho)*&
   &            ddwb
   wb(i, j, k, irho) = wb(i, j, k, irho) - w(i, j, k, ivz)*ddwb
   wb(i, j, k, ivz) = wb(i, j, k, ivz) - w(i, j, k, irho)*ddwb
   CALL POPREAL8(drv)
   temp28 = w(i, j-1, k, ivy)
   temp27 = w(i, j-1, k, irho)
   temp26 = w(i, j+2, k, ivy)
   temp25 = w(i, j+2, k, irho)
   temp25b = -(dis4*drvb)
   dis2b = dis2b + ddw*drvb
   ddwb = dis2*drvb - three*temp25b
   dis4b = dis4b - (temp25*temp26-temp27*temp28-three*ddw)*drvb
   wb(i, j+2, k, irho) = wb(i, j+2, k, irho) + temp26*temp25b
   wb(i, j+2, k, ivy) = wb(i, j+2, k, ivy) + temp25*temp25b
   wb(i, j-1, k, irho) = wb(i, j-1, k, irho) - temp28*temp25b
   wb(i, j-1, k, ivy) = wb(i, j-1, k, ivy) - temp27*temp25b
   CALL POPREAL8(ddw)
   wb(i, j+1, k, irho) = wb(i, j+1, k, irho) + w(i, j+1, k, ivy)*&
   &            ddwb
   wb(i, j+1, k, ivy) = wb(i, j+1, k, ivy) + w(i, j+1, k, irho)*&
   &            ddwb
   wb(i, j, k, irho) = wb(i, j, k, irho) - w(i, j, k, ivy)*ddwb
   wb(i, j, k, ivy) = wb(i, j, k, ivy) - w(i, j, k, irho)*ddwb
   CALL POPREAL8(dru)
   temp24 = w(i, j-1, k, ivx)
   temp23 = w(i, j-1, k, irho)
   temp22 = w(i, j+2, k, ivx)
   temp21 = w(i, j+2, k, irho)
   temp21b0 = -(dis4*drub)
   dis2b = dis2b + ddw*drub
   ddwb = dis2*drub - three*temp21b0
   dis4b = dis4b - (temp21*temp22-temp23*temp24-three*ddw)*drub
   wb(i, j+2, k, irho) = wb(i, j+2, k, irho) + temp22*temp21b0
   wb(i, j+2, k, ivx) = wb(i, j+2, k, ivx) + temp21*temp21b0
   wb(i, j-1, k, irho) = wb(i, j-1, k, irho) - temp24*temp21b0
   wb(i, j-1, k, ivx) = wb(i, j-1, k, ivx) - temp23*temp21b0
   wb(i, j+1, k, irho) = wb(i, j+1, k, irho) + w(i, j+1, k, ivx)*&
   &            ddwb
   wb(i, j+1, k, ivx) = wb(i, j+1, k, ivx) + w(i, j+1, k, irho)*&
   &            ddwb
   wb(i, j, k, irho) = wb(i, j, k, irho) - w(i, j, k, ivx)*ddwb
   wb(i, j, k, ivx) = wb(i, j, k, ivx) - w(i, j, k, irho)*ddwb
   ddw = w(i, j+1, k, irho) - w(i, j, k, irho)
   CALL POPREAL8(dr)
   temp21b1 = -(dis4*drb)
   dis2b = dis2b + ddw*drb
   ddwb = dis2*drb - three*temp21b1
   dis4b = dis4b - (w(i, j+2, k, irho)-w(i, j-1, k, irho)-three*&
   &            ddw)*drb
   wb(i, j+2, k, irho) = wb(i, j+2, k, irho) + temp21b1
   wb(i, j-1, k, irho) = wb(i, j-1, k, irho) - temp21b1
   CALL POPREAL8(ddw)
   wb(i, j+1, k, irho) = wb(i, j+1, k, irho) + ddwb
   wb(i, j, k, irho) = wb(i, j, k, irho) - ddwb
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   CALL POPREAL8(dis4)
   CALL POPREAL8(dis2)
   min3b = fis2*ppor*dis2b
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   y3b = min3b
   ELSE
   y3b = 0.0_8
   END IF
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   dp2b = dp2b + y3b
   dp1b = 0.0_8
   ELSE
   dp1b = y3b
   END IF
   ELSE
   arg1 = ppor*fis4
   CALL POPREAL8(dis4)
   CALL DIM_B(arg1, arg1b, dis2, dis2b, dis4b)
   CALL POPREAL8(dis2)
   min4b = ppor*fis2*dis2b
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   y4b = min4b
   ELSE
   y4b = 0.0_8
   END IF
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   dp2b = dp2b + y4b
   dp1b = 0.0_8
   ELSE
   dp1b = y4b
   END IF
   END IF
   CALL POPREAL8(ppor)
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   x4b = dp2b
   ELSE
   x4b = -dp2b
   END IF
   temp20 = plim + omega*(p(i, j+2, k)+two*p(i, j+1, k)+p(i, j, k&
   &            )) + oneminomega*(abs4+abs10)
   temp20b0 = x4b/temp20
   temp20b1 = -((p(i, j+2, k)-two*p(i, j+1, k)+p(i, j, k))*&
   &            temp20b0/temp20)
   temp21b = omega*temp20b1
   pb(i, j+2, k) = pb(i, j+2, k) + temp21b + temp20b0
   pb(i, j+1, k) = pb(i, j+1, k) + two*temp21b - two*temp20b0
   pb(i, j, k) = pb(i, j, k) + temp21b + temp20b0
   abs4b = oneminomega*temp20b1
   abs10b = oneminomega*temp20b1
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   CALL POPREAL8(abs10)
   pb(i, j+1, k) = pb(i, j+1, k) + abs10b
   pb(i, j, k) = pb(i, j, k) - abs10b
   ELSE
   CALL POPREAL8(abs10)
   pb(i, j, k) = pb(i, j, k) + abs10b
   pb(i, j+1, k) = pb(i, j+1, k) - abs10b
   END IF
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   CALL POPREAL8(abs4)
   pb(i, j+1, k) = pb(i, j+1, k) + abs4b
   pb(i, j+2, k) = pb(i, j+2, k) - abs4b
   ELSE
   CALL POPREAL8(abs4)
   pb(i, j+2, k) = pb(i, j+2, k) + abs4b
   pb(i, j+1, k) = pb(i, j+1, k) - abs4b
   END IF
   END DO
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   x3b = dp1b
   ELSE
   x3b = -dp1b
   END IF
   temp19 = plim + omega*(p(i, 2, k)+two*p(i, 1, k)+p(i, 0, k)) + &
   &          oneminomega*(abs3+abs9)
   temp19b2 = x3b/temp19
   temp19b3 = -((p(i, 2, k)-two*p(i, 1, k)+p(i, 0, k))*temp19b2/&
   &          temp19)
   temp20b = omega*temp19b3
   pb(i, 2, k) = pb(i, 2, k) + temp20b + temp19b2
   pb(i, 1, k) = pb(i, 1, k) + two*temp20b - two*temp19b2
   pb(i, 0, k) = pb(i, 0, k) + temp20b + temp19b2
   abs3b = oneminomega*temp19b3
   abs9b = oneminomega*temp19b3
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   CALL POPREAL8(abs9)
   pb(i, 1, k) = pb(i, 1, k) + abs9b
   pb(i, 0, k) = pb(i, 0, k) - abs9b
   ELSE
   CALL POPREAL8(abs9)
   pb(i, 0, k) = pb(i, 0, k) + abs9b
   pb(i, 1, k) = pb(i, 1, k) - abs9b
   END IF
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   CALL POPREAL8(abs3)
   pb(i, 1, k) = pb(i, 1, k) + abs3b
   pb(i, 2, k) = pb(i, 2, k) - abs3b
   ELSE
   CALL POPREAL8(abs3)
   pb(i, 2, k) = pb(i, 2, k) + abs3b
   pb(i, 1, k) = pb(i, 1, k) - abs3b
   END IF
   END DO
   END DO
   sfaceib = 0.0_8
   DO k=kl,2,-1
   DO j=jl,2,-1
   dp1b = 0.0_8
   DO i=il,1,-1
   dp2b = dp1b
   fsb = fwb(i+1, j, k, irhoe) - fwb(i, j, k, irhoe)
   wavg = half*(w(i+1, j, k, ivz)+w(i, j, k, ivz))
   vavg = half*(w(i+1, j, k, ivy)+w(i, j, k, ivy))
   uavg = half*(w(i+1, j, k, ivx)+w(i, j, k, ivx))
   unavg = uavg*sx + vavg*sy + wavg*sz
   abv5 = sx*dru + sy*drv + sz*drw - unavg*dr
   ovaavg = one/aavg
   ova2avg = one/a2avg
   abv6 = abv3*abv4*ova2avg + abv2*abv5*ovaavg
   abv7 = abv2*abv4*ovaavg + abv3*abv5
   lam3b = dre*fsb
   dreb = lam3*fsb
   havgb = abv6*fsb
   abv6b = havg*fsb
   unavgb = abv7*fsb
   abv7b = unavg*fsb
   fsb = fwb(i+1, j, k, imz) - fwb(i, j, k, imz)
   lam3b = lam3b + drw*fsb
   drwb = lam3*fsb
   wavgb = abv6*fsb
   abv6b = abv6b + wavg*fsb
   szb = abv7*fsb
   abv7b = abv7b + sz*fsb
   fsb = fwb(i+1, j, k, imy) - fwb(i, j, k, imy)
   lam3b = lam3b + drv*fsb
   drvb = lam3*fsb
   vavgb = abv6*fsb
   abv6b = abv6b + vavg*fsb
   syb = abv7*fsb
   abv7b = abv7b + sy*fsb
   fsb = fwb(i+1, j, k, imx) - fwb(i, j, k, imx)
   lam3b = lam3b + dru*fsb
   drub = lam3*fsb
   uavgb = abv6*fsb
   abv6b = abv6b + uavg*fsb
   sxb = abv7*fsb
   abv7b = abv7b + sx*fsb
   fsb = fwb(i+1, j, k, irho) - fwb(i, j, k, irho)
   abv6b = abv6b + fsb
   abv2b = ovaavg*abv5*abv6b + ovaavg*abv4*abv7b
   abv4b = ova2avg*abv3*abv6b + ovaavg*abv2*abv7b
   ovaavgb = abv2*abv5*abv6b + abv2*abv4*abv7b
   abv3b = ova2avg*abv4*abv6b + abv5*abv7b
   lam3b = lam3b + dr*fsb - abv3b
   abv5b = ovaavg*abv2*abv6b + abv3*abv7b
   ova2avgb = abv3*abv4*abv6b
   sxb = sxb + dru*abv5b
   syb = syb + drv*abv5b
   szb = szb + drw*abv5b
   unavgb = unavgb - dr*abv5b
   gammaavg = half*(gamma(i+1, j, k)+gamma(i, j, k))
   gm1 = gammaavg - one
   gm53 = gammaavg - five*third
   alphaavg = half*(uavg**2+vavg**2+wavg**2)
   CALL POPREAL8(abv4)
   temp19b1 = gm1*abv4b
   drb = alphaavg*temp19b1 - unavg*abv5b + lam3*fsb
   drub = drub + sx*abv5b - uavg*temp19b1
   drvb = drvb + sy*abv5b - vavg*temp19b1
   drwb = drwb + sz*abv5b - wavg*temp19b1
   alphaavgb = dr*temp19b1
   uavgb = uavgb - dru*temp19b1
   vavgb = vavgb - drv*temp19b1
   dreb = dreb + temp19b1
   wavgb = wavgb - drw*temp19b1
   drkb = -(gm53*abv4b)
   CALL POPREAL8(abv3)
   abv1b = abv3b
   CALL POPREAL8(abv2)
   lam1b = half*abv1b + half*abv2b
   lam2b = half*abv1b - half*abv2b
   CALL POPREAL8(lam3)
   CALL POPREAL8(lam2)
   CALL POPREAL8(lam1)
   areab = lam2*lam2b + lam1*lam1b + lam3*lam3b
   lam3b = area*lam3b
   lam2b = area*lam2b
   lam1b = area*lam1b
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   rradb = epsshear*lam3b
   lam3b = 0.0_8
   ELSE
   rradb = 0.0_8
   END IF
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   rradb = rradb + epsacoustic*lam2b
   lam2b = 0.0_8
   END IF
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   rradb = rradb + epsacoustic*lam1b
   lam1b = 0.0_8
   END IF
   lam3b = lam3b + rradb
   aavgb = rradb
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   CALL POPREAL8(lam3)
   unavgb = unavgb + lam3b
   sfaceb = sfaceb - lam3b
   ELSE
   CALL POPREAL8(lam3)
   sfaceb = sfaceb + lam3b
   unavgb = unavgb - lam3b
   END IF
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   unavgb = unavgb + lam2b
   sfaceb = sfaceb - lam2b
   aavgb = aavgb - lam2b
   ELSE
   sfaceb = sfaceb + lam2b
   unavgb = unavgb - lam2b
   aavgb = aavgb + lam2b
   END IF
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   unavgb = unavgb + lam1b
   sfaceb = sfaceb - lam1b
   aavgb = aavgb + lam1b
   ELSE
   sfaceb = sfaceb + lam1b
   unavgb = unavgb - lam1b
   aavgb = aavgb - lam1b
   END IF
   tmp = one/max1
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   tmpb = 0.0_8
   ELSE
   sfaceib(i, j, k) = sfaceib(i, j, k) + tmp*sfaceb
   tmpb = sfacei(i, j, k)*sfaceb
   sfaceb = 0.0_8
   END IF
   alphaavgb = alphaavgb + havgb
   temp19b0 = half*alphaavgb
   ovgm1 = one/gm1
   aavgb = aavgb - one*ovaavgb/aavg**2
   IF (a2avg .EQ. 0.0) THEN
   a2avgb = ovgm1*havgb - one*ova2avgb/a2avg**2
   ELSE
   a2avgb = aavgb/(2.0*SQRT(a2avg)) + ovgm1*havgb - one*&
   &              ova2avgb/a2avg**2
   END IF
   uavgb = uavgb + 2*uavg*temp19b0 + sx*unavgb
   sxb = sxb + uavg*unavgb
   vavgb = vavgb + 2*vavg*temp19b0 + sy*unavgb
   syb = syb + vavg*unavgb
   wavgb = wavgb + 2*wavg*temp19b0 + sz*unavgb
   szb = szb + wavg*unavgb
   CALL POPREAL8(aavg)
   CALL POPREAL8(havg)
   kavgb = -(ovgm1*gm53*havgb)
   CALL POPREAL8(sz)
   CALL POPREAL8(sy)
   CALL POPREAL8(sx)
   tmpb = tmpb + sy*syb + sx*sxb + sz*szb
   szb = tmp*szb
   syb = tmp*syb
   sxb = tmp*sxb
   max1b = -(one*tmpb/max1**2)
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   CALL POPREAL8(max1)
   areab = areab + max1b
   ELSE
   CALL POPREAL8(max1)
   END IF
   CALL POPREAL8(area)
   IF (sx**2 + sy**2 + sz**2 .EQ. 0.0) THEN
   temp19b = 0.0
   ELSE
   temp19b = areab/(2.0*SQRT(sx**2+sy**2+sz**2))
   END IF
   sxb = sxb + 2*sx*temp19b
   syb = syb + 2*sy*temp19b
   szb = szb + 2*sz*temp19b
   CALL POPREAL8(sz)
   sib(i, j, k, 3) = sib(i, j, k, 3) + szb
   CALL POPREAL8(sy)
   sib(i, j, k, 2) = sib(i, j, k, 2) + syb
   CALL POPREAL8(sx)
   sib(i, j, k, 1) = sib(i, j, k, 1) + sxb
   CALL POPREAL8(a2avg)
   temp18 = w(i, j, k, irho)
   temp17 = w(i+1, j, k, irho)
   temp17b = gamma(i+1, j, k)*half*a2avgb/temp17
   temp17b0 = gamma(i, j, k)*half*a2avgb/temp18
   pb(i+1, j, k) = pb(i+1, j, k) + temp17b
   wb(i+1, j, k, irho) = wb(i+1, j, k, irho) - p(i+1, j, k)*&
   &            temp17b/temp17
   pb(i, j, k) = pb(i, j, k) + temp17b0
   wb(i, j, k, irho) = wb(i, j, k, irho) - p(i, j, k)*temp17b0/&
   &            temp18
   wb(i+1, j, k, ivz) = wb(i+1, j, k, ivz) + half*wavgb
   wb(i, j, k, ivz) = wb(i, j, k, ivz) + half*wavgb
   wb(i+1, j, k, ivy) = wb(i+1, j, k, ivy) + half*vavgb
   wb(i, j, k, ivy) = wb(i, j, k, ivy) + half*vavgb
   wb(i+1, j, k, ivx) = wb(i+1, j, k, ivx) + half*uavgb
   wb(i, j, k, ivx) = wb(i, j, k, ivx) + half*uavgb
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   dis2b = 0.0_8
   dis4b = 0.0_8
   ELSE
   wb(i, j, k, itu1) = wb(i, j, k, itu1) + half*kavgb
   wb(i+1, j, k, itu1) = wb(i+1, j, k, itu1) + half*kavgb
   temp16 = w(i-1, j, k, itu1)
   temp15 = w(i-1, j, k, irho)
   temp14 = w(i+2, j, k, itu1)
   temp13 = w(i+2, j, k, irho)
   temp13b0 = -(dis4*drkb)
   dis2b = ddw*drkb
   ddwb = dis2*drkb - three*temp13b0
   dis4b = -((temp13*temp14-temp15*temp16-three*ddw)*drkb)
   wb(i+2, j, k, irho) = wb(i+2, j, k, irho) + temp14*temp13b0
   wb(i+2, j, k, itu1) = wb(i+2, j, k, itu1) + temp13*temp13b0
   wb(i-1, j, k, irho) = wb(i-1, j, k, irho) - temp16*temp13b0
   wb(i-1, j, k, itu1) = wb(i-1, j, k, itu1) - temp15*temp13b0
   wb(i+1, j, k, irho) = wb(i+1, j, k, irho) + w(i+1, j, k, &
   &              itu1)*ddwb
   wb(i+1, j, k, itu1) = wb(i+1, j, k, itu1) + w(i+1, j, k, &
   &              irho)*ddwb
   wb(i, j, k, irho) = wb(i, j, k, irho) - w(i, j, k, itu1)*&
   &              ddwb
   wb(i, j, k, itu1) = wb(i, j, k, itu1) - w(i, j, k, irho)*&
   &              ddwb
   END IF
   ddw = w(i+1, j, k, irhoe) - w(i, j, k, irhoe)
   CALL POPREAL8(dre)
   temp13b = -(dis4*dreb)
   dis2b = dis2b + ddw*dreb
   ddwb = dis2*dreb - three*temp13b
   dis4b = dis4b - (w(i+2, j, k, irhoe)-w(i-1, j, k, irhoe)-three&
   &            *ddw)*dreb
   wb(i+2, j, k, irhoe) = wb(i+2, j, k, irhoe) + temp13b
   wb(i-1, j, k, irhoe) = wb(i-1, j, k, irhoe) - temp13b
   CALL POPREAL8(ddw)
   wb(i+1, j, k, irhoe) = wb(i+1, j, k, irhoe) + ddwb
   wb(i, j, k, irhoe) = wb(i, j, k, irhoe) - ddwb
   CALL POPREAL8(drw)
   temp12 = w(i-1, j, k, ivz)
   temp11 = w(i-1, j, k, irho)
   temp10 = w(i+2, j, k, ivz)
   temp9 = w(i+2, j, k, irho)
   temp9b = -(dis4*drwb)
   dis2b = dis2b + ddw*drwb
   ddwb = dis2*drwb - three*temp9b
   dis4b = dis4b - (temp9*temp10-temp11*temp12-three*ddw)*drwb
   wb(i+2, j, k, irho) = wb(i+2, j, k, irho) + temp10*temp9b
   wb(i+2, j, k, ivz) = wb(i+2, j, k, ivz) + temp9*temp9b
   wb(i-1, j, k, irho) = wb(i-1, j, k, irho) - temp12*temp9b
   wb(i-1, j, k, ivz) = wb(i-1, j, k, ivz) - temp11*temp9b
   CALL POPREAL8(ddw)
   wb(i+1, j, k, irho) = wb(i+1, j, k, irho) + w(i+1, j, k, ivz)*&
   &            ddwb
   wb(i+1, j, k, ivz) = wb(i+1, j, k, ivz) + w(i+1, j, k, irho)*&
   &            ddwb
   wb(i, j, k, irho) = wb(i, j, k, irho) - w(i, j, k, ivz)*ddwb
   wb(i, j, k, ivz) = wb(i, j, k, ivz) - w(i, j, k, irho)*ddwb
   CALL POPREAL8(drv)
   temp8 = w(i-1, j, k, ivy)
   temp7 = w(i-1, j, k, irho)
   temp6 = w(i+2, j, k, ivy)
   temp5 = w(i+2, j, k, irho)
   temp5b = -(dis4*drvb)
   dis2b = dis2b + ddw*drvb
   ddwb = dis2*drvb - three*temp5b
   dis4b = dis4b - (temp5*temp6-temp7*temp8-three*ddw)*drvb
   wb(i+2, j, k, irho) = wb(i+2, j, k, irho) + temp6*temp5b
   wb(i+2, j, k, ivy) = wb(i+2, j, k, ivy) + temp5*temp5b
   wb(i-1, j, k, irho) = wb(i-1, j, k, irho) - temp8*temp5b
   wb(i-1, j, k, ivy) = wb(i-1, j, k, ivy) - temp7*temp5b
   CALL POPREAL8(ddw)
   wb(i+1, j, k, irho) = wb(i+1, j, k, irho) + w(i+1, j, k, ivy)*&
   &            ddwb
   wb(i+1, j, k, ivy) = wb(i+1, j, k, ivy) + w(i+1, j, k, irho)*&
   &            ddwb
   wb(i, j, k, irho) = wb(i, j, k, irho) - w(i, j, k, ivy)*ddwb
   wb(i, j, k, ivy) = wb(i, j, k, ivy) - w(i, j, k, irho)*ddwb
   CALL POPREAL8(dru)
   temp4 = w(i-1, j, k, ivx)
   temp3 = w(i-1, j, k, irho)
   temp2 = w(i+2, j, k, ivx)
   temp1 = w(i+2, j, k, irho)
   temp1b0 = -(dis4*drub)
   dis2b = dis2b + ddw*drub
   ddwb = dis2*drub - three*temp1b0
   dis4b = dis4b - (temp1*temp2-temp3*temp4-three*ddw)*drub
   wb(i+2, j, k, irho) = wb(i+2, j, k, irho) + temp2*temp1b0
   wb(i+2, j, k, ivx) = wb(i+2, j, k, ivx) + temp1*temp1b0
   wb(i-1, j, k, irho) = wb(i-1, j, k, irho) - temp4*temp1b0
   wb(i-1, j, k, ivx) = wb(i-1, j, k, ivx) - temp3*temp1b0
   wb(i+1, j, k, irho) = wb(i+1, j, k, irho) + w(i+1, j, k, ivx)*&
   &            ddwb
   wb(i+1, j, k, ivx) = wb(i+1, j, k, ivx) + w(i+1, j, k, irho)*&
   &            ddwb
   wb(i, j, k, irho) = wb(i, j, k, irho) - w(i, j, k, ivx)*ddwb
   wb(i, j, k, ivx) = wb(i, j, k, ivx) - w(i, j, k, irho)*ddwb
   ddw = w(i+1, j, k, irho) - w(i, j, k, irho)
   CALL POPREAL8(dr)
   temp1b1 = -(dis4*drb)
   dis2b = dis2b + ddw*drb
   ddwb = dis2*drb - three*temp1b1
   dis4b = dis4b - (w(i+2, j, k, irho)-w(i-1, j, k, irho)-three*&
   &            ddw)*drb
   wb(i+2, j, k, irho) = wb(i+2, j, k, irho) + temp1b1
   wb(i-1, j, k, irho) = wb(i-1, j, k, irho) - temp1b1
   CALL POPREAL8(ddw)
   wb(i+1, j, k, irho) = wb(i+1, j, k, irho) + ddwb
   wb(i, j, k, irho) = wb(i, j, k, irho) - ddwb
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   CALL POPREAL8(dis4)
   CALL POPREAL8(dis2)
   min1b = fis2*ppor*dis2b
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   y1b = min1b
   ELSE
   y1b = 0.0_8
   END IF
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   dp2b = dp2b + y1b
   dp1b = 0.0_8
   ELSE
   dp1b = y1b
   END IF
   ELSE
   arg1 = ppor*fis4
   CALL POPREAL8(dis4)
   CALL DIM_B(arg1, arg1b, dis2, dis2b, dis4b)
   CALL POPREAL8(dis2)
   min2b = ppor*fis2*dis2b
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   y2b = min2b
   ELSE
   y2b = 0.0_8
   END IF
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   dp2b = dp2b + y2b
   dp1b = 0.0_8
   ELSE
   dp1b = y2b
   END IF
   END IF
   CALL POPREAL8(ppor)
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   x2b = dp2b
   ELSE
   x2b = -dp2b
   END IF
   temp0 = plim + omega*(p(i+2, j, k)+two*p(i+1, j, k)+p(i, j, k)&
   &            ) + oneminomega*(abs2+abs8)
   temp0b0 = x2b/temp0
   temp0b1 = -((p(i+2, j, k)-two*p(i+1, j, k)+p(i, j, k))*temp0b0&
   &            /temp0)
   temp1b = omega*temp0b1
   pb(i+2, j, k) = pb(i+2, j, k) + temp1b + temp0b0
   pb(i+1, j, k) = pb(i+1, j, k) + two*temp1b - two*temp0b0
   pb(i, j, k) = pb(i, j, k) + temp1b + temp0b0
   abs2b = oneminomega*temp0b1
   abs8b = oneminomega*temp0b1
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   CALL POPREAL8(abs8)
   pb(i+1, j, k) = pb(i+1, j, k) + abs8b
   pb(i, j, k) = pb(i, j, k) - abs8b
   ELSE
   CALL POPREAL8(abs8)
   pb(i, j, k) = pb(i, j, k) + abs8b
   pb(i+1, j, k) = pb(i+1, j, k) - abs8b
   END IF
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   CALL POPREAL8(abs2)
   pb(i+1, j, k) = pb(i+1, j, k) + abs2b
   pb(i+2, j, k) = pb(i+2, j, k) - abs2b
   ELSE
   CALL POPREAL8(abs2)
   pb(i+2, j, k) = pb(i+2, j, k) + abs2b
   pb(i+1, j, k) = pb(i+1, j, k) - abs2b
   END IF
   END DO
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   x1b = dp1b
   ELSE
   x1b = -dp1b
   END IF
   temp = plim + omega*(p(2, j, k)+two*p(1, j, k)+p(0, j, k)) + &
   &          oneminomega*(abs1+abs7)
   tempb = x1b/temp
   tempb0 = -((p(2, j, k)-two*p(1, j, k)+p(0, j, k))*tempb/temp)
   temp0b = omega*tempb0
   pb(2, j, k) = pb(2, j, k) + temp0b + tempb
   pb(1, j, k) = pb(1, j, k) + two*temp0b - two*tempb
   pb(0, j, k) = pb(0, j, k) + temp0b + tempb
   abs1b = oneminomega*tempb0
   abs7b = oneminomega*tempb0
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   CALL POPREAL8(abs7)
   pb(1, j, k) = pb(1, j, k) + abs7b
   pb(0, j, k) = pb(0, j, k) - abs7b
   ELSE
   CALL POPREAL8(abs7)
   pb(0, j, k) = pb(0, j, k) + abs7b
   pb(1, j, k) = pb(1, j, k) - abs7b
   END IF
   CALL POPCONTROL1B(branch)
   IF (branch .EQ. 0) THEN
   CALL POPREAL8(abs1)
   pb(1, j, k) = pb(1, j, k) + abs1b
   pb(2, j, k) = pb(2, j, k) - abs1b
   ELSE
   CALL POPREAL8(abs1)
   pb(2, j, k) = pb(2, j, k) + abs1b
   pb(1, j, k) = pb(1, j, k) - abs1b
   END IF
   END DO
   END DO
   END IF
   END SUBROUTINE INVISCIDDISSFLUXMATRIX_B
