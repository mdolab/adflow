#     ******************************************************************
#     *                                                                *
#     * File:          Makefile_tapenade                               *
#     * Author:        Gaetan Kenway                                   *
#     * Starting date: 08-02-2006                                      *
#     * Last modified: 01-10-2013                                      *
#     *                                                                *
#     ******************************************************************

# Define the required directories
SUMB_DIR = ../..
SUMB_COMMON_FILE = $(SUMB_DIR)/SUmb_Common.mk
SRC = ..

#     ******************************************************************
#     *                                                                *
#     * Set Tapenade options.                                          *
#     *                                                                *
#     ******************************************************************

TAPENADE_PARSERFILESEPARATOR = "/"

# Dependent output variables (separator: white space, default: all)
TAPENADE_OUTVARS = "flowdoms%dw flowdoms%w flowdoms%x Force Moment Lift Drag cForce cMoment CL CD BCData%F costFuncMat"

# Independent input variables (separator: white space, default: all)
TAPENADE_VARS = "flowdoms%w  flowdoms%x alpha beta inputPhysics%mach inputPhysics%machGrid inputPhysics%lengthRef inputPhysics%pointRef inputPhysics%surfaceRef" 

# Name of the top routine
TAPENADE_HEADROUTINE = "block_res"

# Differentiation mode
TAPENADE_MODE = -forward

# Output directory
TAPENADE_OUTDIR = $(SRC)/forwardAdjoint/residualTapenade

# Integer, double and real precision (bytes)
TAPENADE_PRECISION = -i4 -dr8 -r8

#     ******************************************************************
#     *                                                                *
#     * Routines to be differentiated (and dependencies).              *
#     *                                                                *
#     ******************************************************************

ALL_FILES =	$(SRC)/forwardAdjoint/residualInput/block_res.f90\
		$(SRC)/forwardAdjoint/residualInput/xhalo_block.f90\
		$(SRC)/forwardAdjoint/residualInput/metric_block.f90\
		$(SRC)/forwardAdjoint/residualInput/getCostFuncMat.f90\
		$(SRC)/modules/monitor.f90\
		$(SRC)/modules/block.F90\
		$(SRC)/modules/inputParam.F90\
		$(SRC)/modules/constants.F90 \
		$(SRC)/modules/precision.F90\
		$(SRC)/modules/iteration.f90\
		$(SRC)/modules/section.f90\
		$(SRC)/modules/communication.f90\
		$(SRC)/modules/BCTypes.f90\
		$(SRC)/modules/paramTurb.f90\
		$(SRC)/modules/cgnsGrid.f90 \
		$(SRC)/modules/CpCurveFits.f90\
		$(SRC)/modules/blockPointers.f90 \
		$(SRC)/modules/flowVarRefState.F90 \
		$(SRC)/modules/killSignals.f90\
		$(SRC)/modules/costFunctions.F90\
		$(SRC)/solver/inviscidCentralFlux.F90\
		$(SRC)/solver/inviscidDissFluxCusp.f90\
		$(SRC)/solver/inviscidDissFluxCuspCoarse.f90\
		$(SRC)/solver/inviscidDissFluxMatrix.F90\
		$(SRC)/solver/inviscidDissFluxMatrixCoarse.f90\
		$(SRC)/solver/inviscidDissFluxScalar.F90\
		$(SRC)/solver/inviscidDissFluxScalarCoarse.f90\
		$(SRC)/solver/inviscidUpwindFlux.F90\
		$(SRC)/solver/computeUtau.f90\
		$(SRC)/solver/applyAllBC.F90\
		$(SRC)/solver/initres.f90\
		$(SRC)/solver/timeStep.f90\
		$(SRC)/solver/residual.F90\
		$(SRC)/solver/computeLamViscosity.f90\
		$(SRC)/solver/setCoefTimeIntegrator.f90\
		$(SRC)/solver/derivativeRotMatrixRigid.f90\
		$(SRC)/solver/adjustInflowAngle.f90\
		$(SRC)/solver/getDirVector.f90\
		$(SRC)/solver/getDirAngle.f90\
		$(SRC)/solver/vectorRotation.f90\
		$(SRC)/solver/bcEulerWall.f90\
		$(SRC)/solver/bcSymmPolar.f90\
		$(SRC)/solver/bcFarfield.f90\
		$(SRC)/solver/extrapolate2ndHalo.f90\
		$(SRC)/solver/bcSymm.f90\
		$(SRC)/solver/viscousFlux.f90\
		$(SRC)/solver/utauWF.f90\
		$(SRC)/solver/bcNSWallAdiabatic.f90\
		$(SRC)/solver/bcNSWallIsothermal.f90\
		$(SRC)/solver/gridVelocitiesFineLevel.f90\
		$(SRC)/solver/normalVelocities.f90\
		$(SRC)/solver/forcesAndMoments.f90\
		$(SRC)/initFlow/referenceState.F90\
		$(SRC)/initFlow/setFlowInfinityState.F90\
		$(SRC)/turbulence/computeEddyViscosity.F90\
		$(SRC)/turbulence/curveFit.f90\
		$(SRC)/turbulence/turbBCNSWall.f90\
		$(SRC)/turbulence/bcTurbWall.f90\
		$(SRC)/turbulence/saNuFromEddyRatio.f90\
		$(SRC)/utils/rotMatrixRigidBody.f90\
		$(SRC)/utils/computeGamma.f90\
		$(SRC)/utils/TSalpha.f90\
		$(SRC)/utils/TSalphadot.f90\
		$(SRC)/utils/TSBeta.f90\
		$(SRC)/utils/TSMach.f90\
		$(SRC)/utils/rigidRotAngle.f90\
		$(SRC)/utils/derivativeRigidRotAngle.f90\
		$(SRC)/utils/dummy_dim.f90\
		$(SRC)/utils/setBCPointers.f90\
		$(SRC)/utils/computeEtot.f90\
		$(SRC)/utils/setPointers.f90\
		$(SRC)/utils/terminate.F90

IFILES := $(ALL_FILES:%=%.f90)
#     ******************************************************************
#     *                                                                *
#     * General targets.                                               *
#     *                                                                *
#     ******************************************************************

default:
	@echo "Deleting tapenade html"
	@rm -fr $(TAPENADE_OUTDIR)/tapenadehtml

# Run preprocessor on all input files
	make -f Makefile_tapenade preprocess

# The following is the single command to run:
	$(TAPENADE_HOME)/bin/tapenade -html -parserfileseparator \
	$(TAPENADE_PARSERFILESEPARATOR) -outvars $(TAPENADE_OUTVARS) -vars \
	$(TAPENADE_VARS) -head $(TAPENADE_HEADROUTINE) $(TAPENADE_MODE)\
	 -msglevel 30 -O $(TAPENADE_OUTDIR) $(TAPENADE_PRECISION) $(IFILES)

# Remove preprocessor files
	make -f Makefile_tapenade cleanpreprocess

preprocess:
	@echo "Preprocessing all input files..."
	@for file in $(ALL_FILES); do \
		echo Preprocessing $$file; \
		cpp -DUSE_TAPENADE -traditional -P $(FF90_ALL_FLAGS) $$file $$file.f90; \
	done

cleanpreprocess:
	@echo "Cleaning up preprocessed files..."
	@for file in $(ALL_FILES); do \
		rm $$file.f90; \
	done

all:	 default

clean:
	@echo " Making clean ... "
	@for subdir in $(TAPENADE_OUT_DIRS) ; \
		do \
			echo; \
			echo "making $@ in $$subdir"; \
			echo; \
			(cd $$subdir && rm -f *_b.f90 *_d.f90  *.msg *~) || exit 1; \
		done
