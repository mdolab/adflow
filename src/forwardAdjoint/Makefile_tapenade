#     ******************************************************************
#     *                                                                *
#     * File:          MakefileResidualMetric                          *
#     * Author:        Andre C. Marta, Sandy Mader                     *
#     * Starting date: 08-02-2006                                      *
#     * Last modified: 05-08-2008                                      *
#     *                                                                *
#     ******************************************************************

#     ==================================================================

#     ******************************************************************
#     *                                                                *
#     * Set some environment variables that otherwise would have to be *
#     * set at the command prompt with "setenv".                       *
#     *                                                                *
#     ******************************************************************

SOLVER_DIRSRC = ../
#SOLVER_DIRSRC = /nfs/tuff/home/mader/hg/SUmbADjoint/src
#SOLVER_DIRSRC = /home/cody/hg/SUmbADjoint/src

#     ******************************************************************
#     *                                                                *
#     * Set Tapenade options.                                          *
#     *                                                                *
#     ******************************************************************

TAPENADE_PARSERFILESEPARATOR = "/"

# Dependent output variables (separator: white space, default: all)

TAPENADE_OUTVARS = "flowdoms%dw"

# Independent input variables (separator: white space, default: all)
TAPENADE_VARS = "flowdoms%w flowdoms%x"

# Name of the top routine

TAPENADE_HEADROUTINE = "block_res"

# Differentiation mode

TAPENADE_MODE = -forward

# Output directory

TAPENADE_OUTDIR = $(SOLVER_DIRSRC)/forwardAdjoint/residualTapenade

# Integer, double and real precision (bytes)
TAPENADE_PRECISION = -i4 -dr8 -r8

#     ******************************************************************
#     *                                                                *
#     * The subdirectories where the sources are located.              *
#     *                                                                *
#     ******************************************************************

TAPENADE_DIRSRC   = $(SOLVER_DIRSRC)/solver/
TAPENADE_DIRMOD   = $(SOLVER_DIRSRC)/modules
TAPENADE_DIRUTILS = $(SOLVER_DIRSRC)/utils

TAPENADE_CLEAN_DIRS = $(TAPENADE_OUTDIR)

#     ******************************************************************
#     *                                                                *
#     * Routines to be differentiated (and dependencies).              *
#     *                                                                *
#     ******************************************************************

TAPENADE_SRC_SOLVER =  $(SOLVER_DIRSRC)/forwardAdjoint/residualInput/block_res.f90\
		       $(TAPENADE_DIRMOD)/blockPointers.f90 \
		       $(TAPENADE_DIRMOD)/flowVarRefState.f90 \
		       $(SOLVER_DIRSRC)/forwardAdjoint/residualInput/refModules/block.f90\
		       $(SOLVER_DIRSRC)/forwardAdjoint/residualInput/refModules/inputParam.f90\
		       $(SOLVER_DIRSRC)/forwardAdjoint/residualInput/refModules/constants.f90 \
		       $(SOLVER_DIRSRC)/forwardAdjoint/residualInput/refModules/precision.f90\
		       $(SOLVER_DIRSRC)/forwardAdjoint/residualInput/refModules/iteration.f90\
		       $(SOLVER_DIRSRC)/forwardAdjoint/residualInput/refModules/section.f90\
		       $(SOLVER_DIRSRC)/forwardAdjoint/residualInput/refModules/communication.f90\
		       $(SOLVER_DIRSRC)/forwardAdjoint/residualInput/refModules/BCTypes.f90\
		       $(SOLVER_DIRSRC)/forwardAdjoint/residualInput/refModules/paramTurb.f90\
		       $(SOLVER_DIRSRC)/forwardAdjoint/residualInput/refModules/monitor.f90\
		       $(SOLVER_DIRSRC)/forwardAdjoint/residualInput/refModules/cgnsGrid.f90 \
		       $(TAPENADE_DIRUTILS)/dummy_dim.f90\
                       $(SOLVER_DIRSRC)/forwardAdjoint/residualInput/xhalo_block.f90\
                       $(SOLVER_DIRSRC)/forwardAdjoint/residualInput/metric_block.f90\
		       $(SOLVER_DIRSRC)/forwardAdjoint/residualInput/gridVelocitiesFineLevel_block.f90\
		       $(SOLVER_DIRSRC)/forwardAdjoint/residualInput/normalVelocities_block.f90\
		       $(SOLVER_DIRSRC)/forwardAdjoint/residualInput/timeStep_block.f90\
		       $(SOLVER_DIRSRC)/forwardAdjoint/residualInput/terminate.f90\
		       $(SOLVER_DIRSRC)/forwardAdjoint/residualInput/residual_block.f90\
		       $(SOLVER_DIRSRC)/solver/inviscidCentralFlux.f90\
		       $(SOLVER_DIRSRC)/solver/inviscidDissFluxCusp.f90\
		       $(SOLVER_DIRSRC)/solver/inviscidDissFluxCuspCoarse.f90\
		       $(SOLVER_DIRSRC)/solver/inviscidDissFluxMatrix.f90\
		       $(SOLVER_DIRSRC)/solver/inviscidDissFluxMatrixCoarse.f90\
		       $(SOLVER_DIRSRC)/solver/inviscidDissFluxScalar.f90\
		       $(SOLVER_DIRSRC)/solver/inviscidDissFluxScalarCoarse.f90\
		       $(SOLVER_DIRSRC)/solver/inviscidUpwindFlux.f90\
		       $(SOLVER_DIRSRC)/solver/computeLamViscosity.f90\
		       $(SOLVER_DIRSRC)/solver/setCoefTimeIntegrator.f90\
		       $(SOLVER_DIRSRC)/solver/derivativeRotMatrixRigid.f90\
		       $(SOLVER_DIRSRC)/adjoint/residualInput/getDirVector.f90\
		       $(SOLVER_DIRSRC)/adjoint/residualInput/getDirAngle.f90\
		       $(SOLVER_DIRSRC)/adjoint/residualInput/vectorRotation.f90\
		       $(SOLVER_DIRSRC)/adjoint/residualInput/adjustInflowAngleAdj.f90\
		       $(SOLVER_DIRSRC)/solver/bcEulerWall.f90\
		       $(SOLVER_DIRSRC)/solver/bcSymmPolar.f90\
		       $(SOLVER_DIRSRC)/solver/bcFarfield.f90\
		       $(SOLVER_DIRSRC)/solver/extrapolate2ndHalo.f90\
		       $(SOLVER_DIRSRC)/solver/bcSymm.f90\
		       $(SOLVER_DIRSRC)/forwardAdjoint/residualInput/applyAllBC_block.f90\
		       $(TAPENADE_DIRUTILS)/setBCPointers.f90\
		       $(SOLVER_DIRSRC)/forwardAdjoint/residualInput/initres_block.f90\
		       $(SOLVER_DIRSRC)/solver/viscousFlux.f90\
		       $(SOLVER_DIRSRC)/solver/utauWF.f90\
		       $(TAPENADE_DIRUTILS)/computeEtot.f90\
		       $(SOLVER_DIRSRC)/forwardAdjoint/residualInput/computeUtau_block.f90\
		       $(TAPENADE_DIRMOD)/CpCurveFits.f90\
		       $(SOLVER_DIRSRC)/turbulence/curveFit.f90\
		       $(SOLVER_DIRSRC)/solver/bcNSWallAdiabatic.f90\
		       $(SOLVER_DIRSRC)/solver/bcNSWallIsothermal.f90\
		       $(SOLVER_DIRSRC)/utils/rotMatrixRigidBody.f90\
		       $(SOLVER_DIRSRC)/utils/TSalpha.f90\
		       $(SOLVER_DIRSRC)/utils/TSalphadot.f90\
		       $(SOLVER_DIRSRC)/utils/TSBeta.f90\
		       $(SOLVER_DIRSRC)/utils/TSMach.f90\
		       $(SOLVER_DIRSRC)/utils/rigidRotAngle.f90\
		       $(SOLVER_DIRSRC)/utils/derivativeRigidRotAngle.f90\

TAPENADE_SRC_ALL = $(TAPENADE_SRC_SOLVER)

#     ******************************************************************
#     *                                                                *
#     * General targets.                                               *
#     *                                                                *
#     ******************************************************************

default:
	@echo "Deleting tapenade html"
	@rm -fr $(TAPENADE_OUTDIR)/tapenadehtml
	@echo "TAPENADE - parsing and generating differentiated code"
	$(TAPENADE_HOME)/bin/tapenade -html -parserfileseparator $(TAPENADE_PARSERFILESEPARATOR) -outvars $(TAPENADE_OUTVARS) -vars $(TAPENADE_VARS) -head $(TAPENADE_HEADROUTINE) $(TAPENADE_MODE) -msglevel 30 -O $(TAPENADE_OUTDIR) $(TAPENADE_PRECISION) $(TAPENADE_SRC_ALL)


all:	 default

clean:
	@echo " Making clean ... "
	@for subdir in $(TAPENADE_CLEAN_DIRS) ; \
		do \
			echo; \
			echo "making $@ in $$subdir"; \
			echo; \
			(cd $$subdir && rm -f *_b.f90 *_d.f90  *.msg *~) || exit 1; \
		done
