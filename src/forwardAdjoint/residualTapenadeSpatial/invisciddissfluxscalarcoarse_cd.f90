!        Generated by TAPENADE     (INRIA, Tropics team)
!  Tapenade 3.4 (r3375) - 10 Feb 2010 15:08
!
!
!      ******************************************************************
!      *                                                                *
!      * File:          inviscidDissFluxScalarCoarse.f90                *
!      * Author:        Edwin van der Weide                             *
!      * Starting date: 03-25-2003                                      *
!      * Last modified: 08-25-2005                                      *
!      *                                                                *
!      ******************************************************************
!
SUBROUTINE INVISCIDDISSFLUXSCALARCOARSE_CD()
  USE ITERATION_SPATIAL_D
  USE INPUTDISCRETIZATION_SPATIAL_D
  USE CONSTANTS_SPATIAL_D
  USE BLOCKPOINTERS_SPATIAL_D
  IMPLICIT NONE
!
!      ******************************************************************
!      *                                                                *
!      * inviscidDissFluxScalarCoarse computes the coarse grid, i.e.    *
!      * 1st order, artificial dissipation flux for the scalar          *
!      * dissipation scheme for a given block. Therefore it is assumed  *
!      * that the pointers in blockPointers already point to the        *
!      * correct block.                                                 *
!      *                                                                *
!      ******************************************************************
!
!
!      Local variables.
!
  INTEGER(kind=inttype) :: i, j, k
  REAL(kind=realtype) :: sfil, fis0, dis0, ppor, fs, rhoi
!
!      ******************************************************************
!      *                                                                *
!      * Begin execution                                                *
!      *                                                                *
!      ******************************************************************
!
! Check if rFil == 0. If so, the dissipative flux needs not to
! be computed.
  IF (rfil .EQ. zero) THEN
    RETURN
  ELSE
! Set a couple of constants for the scheme.
    fis0 = rfil*vis2coarse
    sfil = one - rfil
! Replace the total energy by rho times the total enthalpy.
! In this way the numerical solution is total enthalpy preserving
! for the steady Euler equations. Also replace the velocities by
! the momentum. As only first order halo's are needed, only include
! the first order halo's.
    DO k=1,ke
      DO j=1,je
        DO i=1,ie
          w(i, j, k, ivx) = w(i, j, k, irho)*w(i, j, k, ivx)
          w(i, j, k, ivy) = w(i, j, k, irho)*w(i, j, k, ivy)
          w(i, j, k, ivz) = w(i, j, k, irho)*w(i, j, k, ivz)
          w(i, j, k, irhoe) = w(i, j, k, irhoe) + p(i, j, k)
        END DO
      END DO
    END DO
! Initialize the dissipative residual to a certain times,
! possibly zero, the previously stored value. Owned cells
! only, because the halo values do not matter.
    DO k=2,kl
      DO j=2,jl
        DO i=2,il
          fw(i, j, k, irho) = sfil*fw(i, j, k, irho)
          fw(i, j, k, imx) = sfil*fw(i, j, k, imx)
          fw(i, j, k, imy) = sfil*fw(i, j, k, imy)
          fw(i, j, k, imz) = sfil*fw(i, j, k, imz)
          fw(i, j, k, irhoe) = sfil*fw(i, j, k, irhoe)
        END DO
      END DO
    END DO
!
!      ******************************************************************
!      *                                                                *
!      * Dissipative fluxes in the i-direction.                         *
!      *                                                                *
!      ******************************************************************
!
    DO k=2,kl
      DO j=2,jl
        DO i=1,il
! Compute the dissipation coefficients for this face.
          ppor = zero
          IF (pori(i, j, k) .EQ. normalflux) ppor = half
          dis0 = fis0*ppor*(radi(i, j, k)+radi(i+1, j, k))
! Compute and scatter the dissipative flux.
! Density.
          fs = dis0*(w(i+1, j, k, irho)-w(i, j, k, irho))
          fw(i+1, j, k, irho) = fw(i+1, j, k, irho) + fs
          fw(i, j, k, irho) = fw(i, j, k, irho) - fs
! X-momentum.
          fs = dis0*(w(i+1, j, k, ivx)-w(i, j, k, ivx))
          fw(i+1, j, k, imx) = fw(i+1, j, k, imx) + fs
          fw(i, j, k, imx) = fw(i, j, k, imx) - fs
! Y-momentum.
          fs = dis0*(w(i+1, j, k, ivy)-w(i, j, k, ivy))
          fw(i+1, j, k, imy) = fw(i+1, j, k, imy) + fs
          fw(i, j, k, imy) = fw(i, j, k, imy) - fs
! Z-momentum.
          fs = dis0*(w(i+1, j, k, ivz)-w(i, j, k, ivz))
          fw(i+1, j, k, imz) = fw(i+1, j, k, imz) + fs
          fw(i, j, k, imz) = fw(i, j, k, imz) - fs
! Energy.
          fs = dis0*(w(i+1, j, k, irhoe)-w(i, j, k, irhoe))
          fw(i+1, j, k, irhoe) = fw(i+1, j, k, irhoe) + fs
          fw(i, j, k, irhoe) = fw(i, j, k, irhoe) - fs
        END DO
      END DO
    END DO
!
!      ******************************************************************
!      *                                                                *
!      * Dissipative fluxes in the j-direction.                         *
!      *                                                                *
!      ******************************************************************
!
    DO k=2,kl
      DO j=1,jl
        DO i=2,il
! Compute the dissipation coefficients for this face.
          ppor = zero
          IF (porj(i, j, k) .EQ. normalflux) ppor = half
          dis0 = fis0*ppor*(radj(i, j, k)+radj(i, j+1, k))
! Compute and scatter the dissipative flux.
! Density.
          fs = dis0*(w(i, j+1, k, irho)-w(i, j, k, irho))
          fw(i, j+1, k, irho) = fw(i, j+1, k, irho) + fs
          fw(i, j, k, irho) = fw(i, j, k, irho) - fs
! X-momentum.
          fs = dis0*(w(i, j+1, k, ivx)-w(i, j, k, ivx))
          fw(i, j+1, k, imx) = fw(i, j+1, k, imx) + fs
          fw(i, j, k, imx) = fw(i, j, k, imx) - fs
! Y-momentum.
          fs = dis0*(w(i, j+1, k, ivy)-w(i, j, k, ivy))
          fw(i, j+1, k, imy) = fw(i, j+1, k, imy) + fs
          fw(i, j, k, imy) = fw(i, j, k, imy) - fs
! Z-momentum.
          fs = dis0*(w(i, j+1, k, ivz)-w(i, j, k, ivz))
          fw(i, j+1, k, imz) = fw(i, j+1, k, imz) + fs
          fw(i, j, k, imz) = fw(i, j, k, imz) - fs
! Energy
          fs = dis0*(w(i, j+1, k, irhoe)-w(i, j, k, irhoe))
          fw(i, j+1, k, irhoe) = fw(i, j+1, k, irhoe) + fs
          fw(i, j, k, irhoe) = fw(i, j, k, irhoe) - fs
        END DO
      END DO
    END DO
!
!      ******************************************************************
!      *                                                                *
!      * Dissipative fluxes in the k-direction.                         *
!      *                                                                *
!      ******************************************************************
!
    DO k=1,kl
      DO j=2,jl
        DO i=2,il
! Compute the dissipation coefficients for this face.
          ppor = zero
          IF (pork(i, j, k) .EQ. normalflux) ppor = half
          dis0 = fis0*ppor*(radk(i, j, k)+radk(i, j, k+1))
! Compute and scatter the dissipative flux.
! Density.
          fs = dis0*(w(i, j, k+1, irho)-w(i, j, k, irho))
          fw(i, j, k+1, irho) = fw(i, j, k+1, irho) + fs
          fw(i, j, k, irho) = fw(i, j, k, irho) - fs
! X-momentum.
          fs = dis0*(w(i, j, k+1, ivx)-w(i, j, k, ivx))
          fw(i, j, k+1, imx) = fw(i, j, k+1, imx) + fs
          fw(i, j, k, imx) = fw(i, j, k, imx) - fs
! Y-momentum.
          fs = dis0*(w(i, j, k+1, ivy)-w(i, j, k, ivy))
          fw(i, j, k+1, imy) = fw(i, j, k+1, imy) + fs
          fw(i, j, k, imy) = fw(i, j, k, imy) - fs
! Z-momentum.
          fs = dis0*(w(i, j, k+1, ivz)-w(i, j, k, ivz))
          fw(i, j, k+1, imz) = fw(i, j, k+1, imz) + fs
          fw(i, j, k, imz) = fw(i, j, k, imz) - fs
! Energy
          fs = dis0*(w(i, j, k+1, irhoe)-w(i, j, k, irhoe))
          fw(i, j, k+1, irhoe) = fw(i, j, k+1, irhoe) + fs
          fw(i, j, k, irhoe) = fw(i, j, k, irhoe) - fs
        END DO
      END DO
    END DO
! Replace rho times the total enthalpy by the total energy and
! store the velocities again instead of the momentum. As only
! the first halo cells are included, this must be done here again.
    DO k=1,ke
      DO j=1,je
        DO i=1,ie
          rhoi = one/w(i, j, k, irho)
          w(i, j, k, ivx) = w(i, j, k, ivx)*rhoi
          w(i, j, k, ivy) = w(i, j, k, ivy)*rhoi
          w(i, j, k, ivz) = w(i, j, k, ivz)*rhoi
          w(i, j, k, irhoe) = w(i, j, k, irhoe) - p(i, j, k)
        END DO
      END DO
    END DO
  END IF
END SUBROUTINE INVISCIDDISSFLUXSCALARCOARSE_CD
