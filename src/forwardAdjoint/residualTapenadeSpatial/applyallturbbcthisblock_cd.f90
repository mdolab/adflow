!        Generated by TAPENADE     (INRIA, Tropics team)
!  Tapenade 3.4 (r3375) - 10 Feb 2010 15:08
!
!      ==================================================================
SUBROUTINE APPLYALLTURBBCTHISBLOCK_CD(secondhalo)
  USE BCTYPES_SPATIAL_D
  USE INPUTPHYSICS_SPATIAL_D
  USE BLOCKPOINTERS_SPATIAL_D
  USE FLOWVARREFSTATE_SPATIAL_D
  IMPLICIT NONE
!
!      ******************************************************************
!      *                                                                *
!      * applyAllTurbBCThisBlock sets the halo values of the            *
!      * turbulent variables and eddy viscosity for the block the       *
!      * variables in blockPointers currently point to.                 *
!      *                                                                *
!      ******************************************************************
!
!
!      Subroutine arguments.
!
  LOGICAL, INTENT(IN) :: secondhalo
!
!      Local variables.
!
  INTEGER(kind=inttype) :: nn, i, j, l, m
  REAL(kind=realtype), DIMENSION(:, :, :, :), POINTER :: bmt
  REAL(kind=realtype), DIMENSION(:, :, :), POINTER :: bvt, ww1, ww2
  EXTERNAL TURB2NDHALO
!
!      ******************************************************************
!      *                                                                *
!      * Begin execution                                                *
!      *                                                                *
!      ******************************************************************
!
! Loop over the boundary condition subfaces of this block.
bocos:DO nn=1,nbocos
! Determine the block face on which this subface is located
! and set some pointers accordingly.
    SELECT CASE  (bcfaceid(nn)) 
    CASE (imin) 
      bmt => bmti1
      bvt => bvti1
      ww1 => w(1, 1:, 1:, :)
      ww2 => w(2, 1:, 1:, :)
    CASE (imax) 
      bmt => bmti2
      bvt => bvti2
      ww1 => w(ie, 1:, 1:, :)
      ww2 => w(il, 1:, 1:, :)
    CASE (jmin) 
      bmt => bmtj1
      bvt => bvtj1
      ww1 => w(1:, 1, 1:, :)
      ww2 => w(1:, 2, 1:, :)
    CASE (jmax) 
      bmt => bmtj2
      bvt => bvtj2
      ww1 => w(1:, je, 1:, :)
      ww2 => w(1:, jl, 1:, :)
    CASE (kmin) 
      bmt => bmtk1
      bvt => bvtk1
      ww1 => w(1:, 1:, 1, :)
      ww2 => w(1:, 1:, 2, :)
    CASE (kmax) 
      bmt => bmtk2
      bvt => bvtk2
      ww1 => w(1:, 1:, ke, :)
      ww2 => w(1:, 1:, kl, :)
    END SELECT
! Loop over the faces and set the state in
! the turbulent halo cells.
    IF (wallfunctions) THEN
! Write an approximate value into the halo cell for
! postprocessing (it is not used in computation).
      DO j=bcdata(nn)%jcbeg,bcdata(nn)%jcend
        DO i=bcdata(nn)%icbeg,bcdata(nn)%icend
          DO l=nt1,nt2
            ww1(i, j, l) = bvt(i, j, l) - bmt(i, j, l, l)*ww2(i, j, l)
            DO m=nt1,nt2
              IF (m .NE. l .AND. bmt(i, j, l, m) .NE. zero) ww1(i, j, l)&
& =                ww2(i, j, l)
            END DO
          END DO
        END DO
      END DO
    ELSE
      DO j=bcdata(nn)%jcbeg,bcdata(nn)%jcend
        DO i=bcdata(nn)%icbeg,bcdata(nn)%icend
          DO l=nt1,nt2
            ww1(i, j, l) = bvt(i, j, l)
            DO m=nt1,nt2
              ww1(i, j, l) = ww1(i, j, l) - bmt(i, j, l, m)*ww2(i, j, m)
            END DO
          END DO
        END DO
      END DO
    END IF
! Set the value of the eddy viscosity, depending on the type of
! boundary condition. Only if the turbulence model is an eddy
! viscosity model of course.
    IF (eddymodel) THEN
      IF (bctype(nn) .EQ. nswalladiabatic .OR. bctype(nn) .EQ. &
&          nswallisothermal) THEN
! Viscous wall boundary condition. Eddy viscosity is
! zero at the wall.
        CALL BCEDDYWALL_CD(nn)
      ELSE
! Any boundary condition but viscous wall. A homogeneous
! Neumann condition is applied to the eddy viscosity.
        CALL BCEDDYNOWALL_CD(nn)
      END IF
    END IF
! Extrapolate the turbulent variables in case a second halo
! is needed.
    IF (secondhalo) CALL TURB2NDHALO(nn)
  END DO bocos
END SUBROUTINE APPLYALLTURBBCTHISBLOCK_CD
