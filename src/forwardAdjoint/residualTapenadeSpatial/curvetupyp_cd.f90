!        Generated by TAPENADE     (INRIA, Tropics team)
!  Tapenade 3.4 (r3375) - 10 Feb 2010 15:08
!
!
!      ==================================================================
!
SUBROUTINE CURVETUPYP_CD(tup, yp, ntu1, ntu2)
  USE INPUTPHYSICS_SPATIAL_D
  USE PARAMTURB_SPATIAL_D
  USE CONSTANTS_SPATIAL_D
  IMPLICIT NONE
!
!      ******************************************************************
!      *                                                                *
!      * CurveTupYp determines the value of the turbulent variables     *
!      * ntu1 to ntu2 for the given yplus.                              *
!      * This data has been curve fitted with cubic splines.            *
!      *                                                                *
!      ******************************************************************
!
!
!      Subroutine arguments.
!
  INTEGER(kind=inttype), INTENT(IN) :: ntu1, ntu2
  REAL(kind=realtype), INTENT(IN) :: yp
  REAL(kind=realtype), DIMENSION(ntu1:ntu2), INTENT(OUT) :: tup
!
!      Local variables.
!
  INTEGER(kind=inttype) :: ii, nn, start, mm
  REAL(kind=realtype) :: x, x2, x3, epswall, fwall
  INTRINSIC EXP
  INTRINSIC MAX
  REAL(kind=realtype) :: max2
  REAL(kind=realtype) :: max1
!
!      ******************************************************************
!      *                                                                *
!      * Begin execution                                                *
!      *                                                                *
!      ******************************************************************
!
! Determine the situation we are dealing with.
  IF (yp .LE. ypt(0)) THEN
! Yplus is less than the smallest number in the curve
! fit. The treatment is turbulence model dependent.
    SELECT CASE  (turbmodel) 
    CASE (spalartallmaras, spalartallmarasedwards) 
! Transport variable is zero on the wall. Use linear
! interpolation.
      x = yp/ypt(0)
      DO mm=ntu1,ntu2
        tup(mm) = x*tup0(1, mm)
      END DO
    CASE (komegawilcox, komegamodified, mentersst) 
!=============================================================
! Use the near wall expressions for k and omega.
      x = yp/ypt(0)
      DO mm=ntu1,ntu2
        SELECT CASE  (mm) 
        CASE (itu1) 
          IF (tulogfit(mm)) THEN
            tup(mm) = EXP(tup0(1, mm))*x**3.23_realType
          ELSE
            tup(mm) = tup0(1, mm)*x**3.23_realType
          END IF
        CASE (itu2) 
          IF (tulogfit(mm)) THEN
            IF (x .LT. eps) THEN
              max1 = eps
            ELSE
              max1 = x
            END IF
            tup(mm) = EXP(tup0(1, mm))/max1**2
          ELSE
            IF (x .LT. eps) THEN
              max2 = eps
            ELSE
              max2 = x
            END IF
            tup(mm) = tup0(1, mm)/max2**2
          END IF
        END SELECT
      END DO
    CASE (ktau) 
!=============================================================
! Use the near wall expressions for k and tau.
      x = yp/ypt(0)
      DO mm=ntu1,ntu2
        SELECT CASE  (mm) 
        CASE (itu1) 
          IF (tulogfit(mm)) THEN
            tup(mm) = EXP(tup0(1, mm))*x**3.23_realType
          ELSE
            tup(mm) = tup0(1, mm)*x**3.23_realType
          END IF
        CASE (itu2) 
          IF (tulogfit(mm)) THEN
            tup(mm) = EXP(tup0(1, mm))*x*x
          ELSE
            tup(mm) = tup0(1, mm)*x*x
          END IF
        END SELECT
      END DO
    CASE (v2f) 
!=============================================================
! Use the near wall expressions for k, epsilon, v2 and f.
      x = yp/ypt(0)
      DO mm=ntu1,ntu2
        SELECT CASE  (mm) 
        CASE (itu1) 
          IF (tulogfit(mm)) THEN
            tup(mm) = EXP(tup0(1, mm))*x**2
          ELSE
            tup(mm) = tup0(1, mm)*x**2
          END IF
        CASE (itu2) 
! epsilon cannot be fitted logarithmically.
          IF (tulogfit(mm)) THEN
            CALL TERMINATE_CD('curveTupYp', 'Check curveFit, ', &
&                        'epsilon cannot be fitted with log')
          ELSE
            IF (rvfn .EQ. 1) epswall = 0.33_realType
            IF (rvfn .EQ. 6) epswall = 0.27_realType
            tup(mm) = epswall + (tup0(1, mm)-epswall)*x
          END IF
        CASE (itu3) 
          IF (tulogfit(mm)) THEN
            tup(mm) = EXP(tup0(1, mm))*x**4
          ELSE
            tup(mm) = tup0(1, mm)*x**4
          END IF
        CASE (itu4) 
          IF (tulogfit(mm)) THEN
            IF (rvfn .EQ. 1) CALL TERMINATE_CD('curveTupYp', &
&                                         'Check curveFit, ', &
&                                         'f cannot be fitted with log')
            IF (rvfn .EQ. 6) tup(mm) = EXP(tup(mm))*x
          ELSE
            IF (rvfn .EQ. 1) fwall = -0.0035_realType
            IF (rvfn .EQ. 6) fwall = zero
            tup(mm) = fwall + (tup0(1, mm)-fwall)*x
          END IF
        CASE (itu5) 
          IF (tulogfit(mm)) THEN
            tup(mm) = EXP(tup(mm))*x**4
          ELSE
            tup(mm) = tup0(1, mm)*x**4
          END IF
        END SELECT
      END DO
    END SELECT
  ELSE IF (yp .GE. ypt(nfit)) THEN
!=================================================================
! Yplus is larger than the largest number in the curve
! fit. Set tup to the largest value available.
    nn = nfit
    x = ypt(nn) - ypt(nn-1)
    x2 = x*x
    x3 = x*x2
    DO mm=ntu1,ntu2
      tup(mm) = tup0(nn, mm) + tup1(nn, mm)*x + tup2(nn, mm)*x2 + tup3(&
&        nn, mm)*x3
      IF (tulogfit(mm)) tup(mm) = EXP(tup(mm))
    END DO
  ELSE
!=================================================================
! y-plus is in the range of the curve fits.
! First find the correct interval.
    ii = nfit
    start = 1
interval:DO 
! Next guess for the interval.
      nn = start + ii/2
! Determine the situation we are having here.
      IF (yp .GT. ypt(nn)) THEN
! Yplus is larger than the upper boundary of
! the current interval. Update the lower boundary.
        start = nn + 1
        ii = ii - 1
      ELSE IF (yp .GE. ypt(nn-1)) THEN
! Compute tup using the cubic polynomial for this interval.
        x = yp - ypt(nn-1)
        x2 = x*x
        x3 = x*x2
        DO mm=ntu1,ntu2
          tup(mm) = tup0(nn, mm) + tup1(nn, mm)*x + tup2(nn, mm)*x2 + &
&            tup3(nn, mm)*x3
          IF (tulogfit(mm)) tup(mm) = EXP(tup(mm))
        END DO
        GOTO 100
      END IF
! This is the correct range. Exit the do-loop.
! Modify ii for the next branch to search.
      ii = ii/2
    END DO interval
  END IF
 100 CONTINUE
END SUBROUTINE CURVETUPYP_CD
