!        Generated by TAPENADE     (INRIA, Tropics team)
!  Tapenade 3.4 (r3375) - 10 Feb 2010 15:08
!
!      ==================================================================
SUBROUTINE SSTEDDYVISCOSITY_CD()
  USE PARAMTURB_SPATIAL_D
  USE CONSTANTS_SPATIAL_D
  USE TURBMOD_SPATIAL_D
  USE BLOCKPOINTERS_SPATIAL_D
  IMPLICIT NONE
!
!      ******************************************************************
!      *                                                                *
!      * SSTEddyViscosity computes the eddy viscosity according to      *
!      * menter's SST variant of the k-omega turbulence model for the   *
!      * block given in blockPointers.                                  *
!      *                                                                *
!      ******************************************************************
!
!
!      Local variables.
!
  INTEGER(kind=inttype) :: i, j, k
  REAL(kind=realtype) :: t1, t2, arg2, f2, vortmag
  REAL(kind=realtype) :: result1
  REAL(kind=realtype) :: arg1
  INTRINSIC TANH
  INTRINSIC MAX
  INTRINSIC SQRT
  REAL(kind=realtype) :: max1
!
!      ******************************************************************
!      *                                                                *
!      * Begin execution                                                *
!      *                                                                *
!      ******************************************************************
!
! Compute the vorticity squared in the cell centers. The reason
! for computing the vorticity squared is that a routine exists
! for it; for the actual eddy viscosity computation the vorticity
! itself is needed.
  prod => dw(1:, 1:, 1:, iprod)
  vort => prod
  CALL PRODWMAG2_CD()
! Loop over the cells of this block and compute the eddy viscosity.
! Do not include halo's.
  DO k=2,kl
    DO j=2,jl
      DO i=2,il
! Compute the value of the function f2, which occurs in the
! eddy-viscosity computation.
        result1 = SQRT(w(i, j, k, itu1))
        t1 = two*result1/(0.09_realType*w(i, j, k, itu2)*d2wall(i, j, k)&
&          )
        t2 = 500.0_realType*rlv(i, j, k)/(w(i, j, k, irho)*w(i, j, k, &
&          itu2)*d2wall(i, j, k)**2)
        IF (t1 .LT. t2) THEN
          arg2 = t2
        ELSE
          arg2 = t1
        END IF
        arg1 = arg2**2
        f2 = TANH(arg1)
! And compute the eddy viscosity.
        vortmag = SQRT(vort(i, j, k))
        IF (rssta1*w(i, j, k, itu2) .LT. f2*vortmag) THEN
          max1 = f2*vortmag
        ELSE
          max1 = rssta1*w(i, j, k, itu2)
        END IF
        rev(i, j, k) = w(i, j, k, irho)*rssta1*w(i, j, k, itu1)/max1
      END DO
    END DO
  END DO
END SUBROUTINE SSTEDDYVISCOSITY_CD
