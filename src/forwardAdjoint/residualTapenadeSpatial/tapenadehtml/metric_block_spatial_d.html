<title>Generated by TAPENADE</title>
<link type="text/CSS" rel="stylesheet" href="tapenade.css">
<link type="text/CSS" rel="stylesheet" href="fortranStyle.css">
<body>
<pre><a name="metric_block_spatial_d"></a><a href="metric_block_p.html#metric_block" target="origFile"><code class="comment">!        Generated by TAPENADE     (INRIA, Tropics team)</code></a>
<a href="metric_block_p.html#metric_block" target="origFile"><code class="comment">!  Tapenade 3.4 (r3375) - 10 Feb 2010 15:08</code></a>
<a href="metric_block_p.html#metric_block" target="origFile"><code class="comment">!</code></a>
<a href="metric_block_p.html#metric_block" target="origFile"><code class="comment">!  Differentiation of metric_block in forward (tangent) mode:</code></a>
<a href="metric_block_p.html#metric_block" target="origFile"><code class="comment">!   variations   of useful results: *vol *si *sj *sk</code></a>
<a href="metric_block_p.html#metric_block" target="origFile"><code class="comment">!   with respect to varying inputs: *x</code></a>
<a href="metric_block_p.html#metric_block" target="origFile"><code class="keyword">SUBROUTINE </code><code class="funcname">METRIC_BLOCK_SPATIAL_D</code>(<code class="vardecl">nn</code>, <code class="vardecl">level</code>, <code class="vardecl">sps</code>)</a>
  <a href="metric_block_p.html#metric_block" target="origFile"><code class="keyword">USE </code><code class="funcname">BCTYPES_SPATIAL_D</code></a>
  <a href="metric_block_p.html#metric_block" target="origFile"><code class="keyword">USE </code><code class="funcname">CGNSGRID_SPATIAL_D</code></a>
  <a href="metric_block_p.html#metric_block" target="origFile"><code class="keyword">USE </code><code class="funcname">COMMUNICATION_SPATIAL_D</code></a>
  <a href="metric_block_p.html#metric_block" target="origFile"><code class="keyword">USE </code><code class="funcname">INPUTTIMESPECTRAL_SPATIAL_D</code></a>
<a name="metric_block_spatial_di0"></a>  <a href="metric_block_p.html#metric_block" target="origFile"><code class="keyword">USE </code><code class="funcname">BLOCKPOINTERS_SPATIAL_D</code></a>
  <a href="metric_block_p.html#metric_block" target="origFile"><code class="keyword">IMPLICIT NONE</code></a>
<a href="metric_block_p.html#metric_blocki0" target="origFile"><code class="comment">!</code></a>
<a href="metric_block_p.html#metric_blocki0" target="origFile"><code class="comment">!      ******************************************************************</code></a>
<a href="metric_block_p.html#metric_blocki0" target="origFile"><code class="comment">!      *                                                                *</code></a>
<a href="metric_block_p.html#metric_blocki0" target="origFile"><code class="comment">!      * metric computes the face normals and the volume for the given  *</code></a>
<a href="metric_block_p.html#metric_blocki0" target="origFile"><code class="comment">!      * grid level for all spectral solutions. First the volumes are   *</code></a>
<a href="metric_block_p.html#metric_blocki0" target="origFile"><code class="comment">!      * computed assuming that the block is right handed. Then the     *</code></a>
<a href="metric_block_p.html#metric_blocki0" target="origFile"><code class="comment">!      * number of positive and negative volumes are determined. If all *</code></a>
<a href="metric_block_p.html#metric_blocki0" target="origFile"><code class="comment">!      * volumes are positive the block is indeed right handed; if all  *</code></a>
<a href="metric_block_p.html#metric_blocki0" target="origFile"><code class="comment">!      * volumes are negative the block is left handed and both the     *</code></a>
<a href="metric_block_p.html#metric_blocki0" target="origFile"><code class="comment">!      * volumes and the normals must be negated (for the normals this  *</code></a>
<a href="metric_block_p.html#metric_blocki0" target="origFile"><code class="comment">!      * is done by the introduction of fact, which is either -0.5 or   *</code></a>
<a href="metric_block_p.html#metric_blocki0" target="origFile"><code class="comment">!      * 0.5); if there are both positive and negative volumes the mesh *</code></a>
<a href="metric_block_p.html#metric_blocki0" target="origFile"><code class="comment">!      * is not valid.                                                  *</code></a>
<a href="metric_block_p.html#metric_blocki0" target="origFile"><code class="comment">!      *                                                                *</code></a>
<a href="metric_block_p.html#metric_blocki0" target="origFile"><code class="comment">!      ******************************************************************</code></a>
<a href="metric_block_p.html#metric_blocki0" target="origFile"><code class="comment">!</code></a>
<a href="metric_block_p.html#metric_blocki0" target="origFile"><code class="comment">!</code></a>
<a href="metric_block_p.html#metric_blocki0" target="origFile"><code class="comment">!      Subroutine arguments.</code></a>
<a name="metric_block_spatial_di1"></a><a href="metric_block_p.html#metric_blocki0" target="origFile"><code class="comment">!</code></a>
  <a href="metric_block_p.html#metric_blocki0" target="origFile"><code class="typename">INTEGER(</code><code class="keyword">kind</code>=<code class="modifier">inttype</code><code class="typename">)</code>, <code class="typename">INTENT(IN) </code>:: <code class="vardecl">level</code></a>
<a href="metric_block_p.html#metric_blocki1" target="origFile"><code class="comment">!</code></a>
<a href="metric_block_p.html#metric_blocki1" target="origFile"><code class="comment">!      Local parameter.</code></a>
<a name="metric_block_spatial_di2"></a><a href="metric_block_p.html#metric_blocki1" target="origFile"><code class="comment">!</code></a>
  <a href="metric_block_p.html#metric_blocki1" target="origFile"><code class="typename">REAL(</code><code class="keyword">kind</code>=<code class="modifier">realtype</code><code class="typename">)</code>, <code class="typename">PARAMETER </code>:: <code class="vardecl">thresvolume</code>=<code class="constant">1.e-2_realType</code></a>
<a href="metric_block_p.html#metric_blocki2" target="origFile"><code class="comment">!</code></a>
<a href="metric_block_p.html#metric_blocki2" target="origFile"><code class="comment">!      Local variables.</code></a>
<a name="metric_block_spatial_di3"></a><a href="metric_block_p.html#metric_blocki2" target="origFile"><code class="comment">!</code></a>
<a name="metric_block_spatial_di4"></a>  <a href="metric_block_p.html#metric_blocki2" target="origFile"><code class="typename">INTEGER </code>:: <code class="vardecl">ierr</code></a>
<a name="metric_block_spatial_di5"></a>  <a href="metric_block_p.html#metric_blocki3" target="origFile"><code class="typename">INTEGER(</code><code class="keyword">kind</code>=<code class="modifier">inttype</code><code class="typename">) </code>:: <code class="vardecl">i</code>, <code class="vardecl">j</code>, <code class="vardecl">k</code>, <code class="vardecl">n</code>, <code class="vardecl">m</code>, <code class="vardecl">l</code></a>
<a name="metric_block_spatial_di6"></a>  <a href="metric_block_p.html#metric_blocki4" target="origFile"><code class="typename">INTEGER(</code><code class="keyword">kind</code>=<code class="modifier">inttype</code><code class="typename">) </code>:: <code class="vardecl">nn</code>, <code class="vardecl">mm</code>, <code class="vardecl">sps</code></a>
<a name="metric_block_spatial_di7"></a>  <a href="metric_block_p.html#metric_blocki5" target="origFile"><code class="typename">INTEGER(</code><code class="keyword">kind</code>=<code class="modifier">inttype</code><code class="typename">) </code>:: <code class="vardecl">nvolneg</code>, <code class="vardecl">nvolpos</code></a>
<a name="metric_block_spatial_di8"></a>  <a href="metric_block_p.html#metric_blocki6" target="origFile"><code class="typename">INTEGER(</code><code class="keyword">kind</code>=<code class="modifier">inttype</code><code class="typename">) </code>:: <code class="vardecl">nvolbad</code>, <code class="vardecl">nvolbadglobal</code></a>
<a name="metric_block_spatial_di9"></a>  <a href="metric_block_p.html#metric_blocki7" target="origFile"><code class="typename">INTEGER(</code><code class="keyword">kind</code>=<code class="modifier">inttype</code><code class="typename">) </code>:: <code class="vardecl">nblockbad</code>, <code class="vardecl">nblockbadglobal</code></a>
  <a href="metric_block_p.html#metric_blocki8" target="origFile"><code class="typename">REAL(</code><code class="keyword">kind</code>=<code class="modifier">realtype</code><code class="typename">) </code>:: <code class="vardecl">fact</code>, <code class="vardecl">mult</code></a>
<a name="metric_block_spatial_di10"></a>  <a href="metric_block_p.html#metric_blocki9" target="origFile"><code class="typename">REAL(</code><code class="keyword">kind</code>=<code class="modifier">realtype</code><code class="typename">) </code>:: <code class="vardecl">xp</code>, <code class="vardecl">yp</code>, <code class="vardecl">zp</code>, <code class="vardecl">vp1</code>, <code class="vardecl">vp2</code>, <code class="vardecl">vp3</code>, <code class="vardecl">vp4</code>, <code class="vardecl">vp5</code>, <code class="vardecl">vp6</code></a>
  <a href="metric_block_p.html#metric_block" target="origFile"><code class="typename">REAL(</code><code class="keyword">kind</code>=<code class="modifier">realtype</code><code class="typename">) </code>:: <code class="vardecl">vp1d</code>, <code class="vardecl">vp2d</code>, <code class="vardecl">vp3d</code>, <code class="vardecl">vp4d</code>, <code class="vardecl">vp5d</code>, <code class="vardecl">vp6d</code></a>
<a name="metric_block_spatial_di11"></a>  <a href="metric_block_p.html#metric_blocki10" target="origFile"><code class="typename">REAL(</code><code class="keyword">kind</code>=<code class="modifier">realtype</code><code class="typename">)</code>, <code class="typename">DIMENSION(</code><code class="constant">3</code><code class="typename">) </code>:: <code class="vardecl">v1</code>, <code class="vardecl">v2</code></a>
<a name="metric_block_spatial_di12"></a>  <a href="metric_block_p.html#metric_block" target="origFile"><code class="typename">REAL(</code><code class="keyword">kind</code>=<code class="modifier">realtype</code><code class="typename">)</code>, DIMENSION(<code class="constant">3</code>) :: <code class="vardecl">v1d</code>, <code class="vardecl">v2d</code></a>
<a name="metric_block_spatial_di13"></a>  <a href="metric_block_p.html#metric_blocki11" target="origFile"><code class="typename">REAL(</code><code class="keyword">kind</code>=<code class="modifier">realtype</code><code class="typename">)</code>, <code class="typename">DIMENSION(</code>:, :, :<code class="typename">)</code>, <code class="typename">POINTER </code>:: <code class="vardecl">ss</code></a>
<a name="metric_block_spatial_di14"></a>  <a href="metric_block_p.html#metric_blocki12" target="origFile"><code class="typename">CHARACTER</code>(<code class="keyword">len</code>=<code class="constant">10</code>) :: <code class="vardecl">integerstring</code></a>
<a name="metric_block_spatial_di15"></a>  <a href="metric_block_p.html#metric_blocki13" target="origFile"><code class="typename">LOGICAL </code>:: <code class="vardecl">checkk</code>, <code class="vardecl">checkj</code>, <code class="vardecl">checki</code>, <code class="vardecl">checkall</code></a>
  <a href="metric_block_p.html#metric_blocki14" target="origFile"><code class="typename">LOGICAL </code>:: <code class="vardecl">badvolume</code></a>
<a name="metric_block_spatial_di16"></a>  <a href="metric_block_p.html#metric_blocki15" target="origFile"><code class="typename">REAL(</code><code class="keyword">kind</code>=<code class="modifier">realtype</code><code class="typename">) </code>:: <code class="funcname">VOLPYM</code></a>
<a name="metric_block_spatial_di17"></a>  <a href="metric_block_p.html#metric_block" target="origFile"><code class="typename">REAL(</code><code class="keyword">kind</code>=<code class="modifier">realtype</code><code class="typename">) </code>:: <code class="funcname">VOLPYM_SPATIAL_D</code></a>
<a name="metric_block_spatial_di18"></a>  <a href="metric_block_p.html#metric_blocki16" target="origFile"><code class="keyword">EXTERNAL </code><code class="funcname">FLOWDOMS</code></a>
  <a href="metric_block_p.html#metric_blocki17" target="origFile"><code class="keyword">TYPE(</code><code class="typename">#UNKNOWNDERIVEDTYPE0#</code><code class="keyword">) </code>:: <code class="vardecl">result1</code></a>
  <a href="metric_block_p.html#metric_blocki18" target="origFile"><code class="typename">REAL(</code><code class="keyword">kind</code>=<code class="modifier">realtype</code><code class="typename">) </code>:: <code class="vardecl">arg1</code></a>
  <a href="metric_block_p.html#metric_block" target="origFile"><code class="keyword">TYPE(</code><code class="typename">UNKNOWNDERIVEDTYPE0</code><code class="keyword">) </code>:: <code class="funcname">FLOWDOMS</code></a>
<a name="metric_block_spatial_di19"></a>  <a href="metric_block_p.html#metric_block" target="origFile"><code class="keyword">INTRINSIC </code><code class="funcname">ABS</code></a>
  <a href="metric_block_p.html#metric_block" target="origFile"><code class="keyword">INTRINSIC </code><code class="funcname">SQRT</code></a>
<a href="metric_block_p.html#metric_blocki19" target="origFile"><code class="comment">!</code></a>
<a href="metric_block_p.html#metric_blocki19" target="origFile"><code class="comment">!      ******************************************************************</code></a>
<a href="metric_block_p.html#metric_blocki19" target="origFile"><code class="comment">!      *                                                                *</code></a>
<a href="metric_block_p.html#metric_blocki19" target="origFile"><code class="comment">!      * Begin execution                                                *</code></a>
<a href="metric_block_p.html#metric_blocki19" target="origFile"><code class="comment">!      *                                                                *</code></a>
<a href="metric_block_p.html#metric_blocki19" target="origFile"><code class="comment">!      ******************************************************************</code></a>
<a href="metric_block_p.html#metric_blocki19" target="origFile"><code class="comment">!</code></a>
<a href="metric_block_p.html#metric_blocki19" target="origFile"><code class="comment">! Compute the volumes. The hexahedron is split into 6 pyramids</code></a>
<a href="metric_block_p.html#metric_blocki19" target="origFile"><code class="comment">! whose volumes are computed. The volume is positive for a</code></a>
<a href="metric_block_p.html#metric_blocki19" target="origFile"><code class="comment">! right handed block.</code></a>
<a href="metric_block_p.html#metric_blocki19" target="origFile"><code class="comment">! Initialize the volumes to zero. The reasons is that the second</code></a>
<a href="metric_block_p.html#metric_blocki19" target="origFile"><code class="comment">! level halo's must be initialized to zero and for convenience</code></a>
<a href="metric_block_p.html#metric_blocki19" target="origFile"><code class="comment">! all the volumes are set to zero.</code></a>
<a name="metric_block_spatial_di20"></a>  <a href="metric_block_p.html#metric_blocki19" target="origFile">vol = zero</a>
<a name="metric_block_spatial_di21"></a>  <a href="metric_block_p.html#metric_block" target="origFile">vold = <code class="constant">0.0</code></a>
<a name="metric_block_spatial_di22"></a>  <a href="metric_block_p.html#metric_blocki20" target="origFile"><code class="keyword">DO </code>k=<code class="constant">1</code>,ke</a>
<a name="metric_block_spatial_di24"></a><a name="metric_block_spatial_di23"></a>    <a href="metric_block_p.html#metric_blocki21" target="origFile">n = k - <code class="constant">1</code></a>
<a name="metric_block_spatial_di25"></a>    <a href="metric_block_p.html#metric_blocki22" target="origFile">checkk = <code class="constant">.true.</code></a>
<a name="metric_block_spatial_di26"></a>    <a href="metric_block_p.html#metric_blocki23" target="origFile"><code class="keyword">IF</code> (k .EQ. <code class="constant">1 </code>.OR. k .EQ. ke) </a><a href="metric_block_p.html#metric_blocki24" target="origFile">checkk = <code class="constant">.false.</code></a>
<a name="metric_block_spatial_di27"></a>    <a href="metric_block_p.html#metric_blocki25" target="origFile"><code class="keyword">DO </code>j=<code class="constant">1</code>,je</a>
<a name="metric_block_spatial_di29"></a><a name="metric_block_spatial_di28"></a>      <a href="metric_block_p.html#metric_blocki26" target="origFile">m = j - <code class="constant">1</code></a>
<a name="metric_block_spatial_di30"></a>      <a href="metric_block_p.html#metric_blocki27" target="origFile">checkj = <code class="constant">.true.</code></a>
<a name="metric_block_spatial_di31"></a>      <a href="metric_block_p.html#metric_blocki28" target="origFile"><code class="keyword">IF</code> (j .EQ. <code class="constant">1 </code>.OR. j .EQ. je) </a><a href="metric_block_p.html#metric_blocki29" target="origFile">checkj = <code class="constant">.false.</code></a>
<a name="metric_block_spatial_di32"></a>      <a href="metric_block_p.html#metric_blocki30" target="origFile"><code class="keyword">DO </code>i=<code class="constant">1</code>,ie</a>
<a name="metric_block_spatial_di34"></a><a name="metric_block_spatial_di33"></a>        <a href="metric_block_p.html#metric_blocki31" target="origFile">l = i - <code class="constant">1</code></a>
<a name="metric_block_spatial_di35"></a>        <a href="metric_block_p.html#metric_blocki32" target="origFile">checki = <code class="constant">.true.</code></a>
        <a href="metric_block_p.html#metric_blocki33" target="origFile"><code class="keyword">IF</code> (i .EQ. <code class="constant">1 </code>.OR. i .EQ. ie) </a><a href="metric_block_p.html#metric_blocki34" target="origFile">checki = <code class="constant">.false.</code></a>
<a href="metric_block_p.html#metric_blocki35" target="origFile"><code class="comment">! Determine whether or not the voluem must be checked for</code></a>
<a name="metric_block_spatial_di37"></a><a name="metric_block_spatial_di36"></a><a href="metric_block_p.html#metric_blocki35" target="origFile"><code class="comment">! quality. Only owned volumes are checked, not halo's.</code></a>
<a name="metric_block_spatial_di38"></a>        <a href="metric_block_p.html#metric_blocki35" target="origFile">checkall = <code class="constant">.false.</code></a>
        <a href="metric_block_p.html#metric_blocki36" target="origFile"><code class="keyword">IF</code> (checkk .AND. checkj .AND. checki) </a><a href="metric_block_p.html#metric_blocki37" target="origFile">checkall = <code class="constant">.true.</code></a>
<a href="metric_block_p.html#metric_blocki38" target="origFile"><code class="comment">! Compute the coordinates of the center of gravity.</code></a>
<a name="metric_block_spatial_di39"></a>        <a href="metric_block_p.html#metric_blocki38" target="origFile">xp = eighth*(x(i, j, k, <code class="constant">1</code>)+x(i, m, k, <code class="constant">1</code>)+x(i, m, n, <code class="constant">1</code>)+x(i, j, n<code class="label">&</code></a>
<a href="metric_block_p.html#metric_blocki38" target="origFile"><code class="label">&          </code>, <code class="constant">1</code>)+x(l, j, k, <code class="constant">1</code>)+x(l, m, k, <code class="constant">1</code>)+x(l, m, n, <code class="constant">1</code>)+x(l, j, n, <code class="constant">1</code>))</a>
<a name="metric_block_spatial_di40"></a>        <a href="metric_block_p.html#metric_blocki39" target="origFile">yp = eighth*(x(i, j, k, <code class="constant">2</code>)+x(i, m, k, <code class="constant">2</code>)+x(i, m, n, <code class="constant">2</code>)+x(i, j, n<code class="label">&</code></a>
<a href="metric_block_p.html#metric_blocki39" target="origFile"><code class="label">&          </code>, <code class="constant">2</code>)+x(l, j, k, <code class="constant">2</code>)+x(l, m, k, <code class="constant">2</code>)+x(l, m, n, <code class="constant">2</code>)+x(l, j, n, <code class="constant">2</code>))</a>
<a name="metric_block_spatial_di41"></a>        <a href="metric_block_p.html#metric_blocki40" target="origFile">zp = eighth*(x(i, j, k, <code class="constant">3</code>)+x(i, m, k, <code class="constant">3</code>)+x(i, m, n, <code class="constant">3</code>)+x(i, j, n<code class="label">&</code></a>
<a href="metric_block_p.html#metric_blocki40" target="origFile"><code class="label">&          </code>, <code class="constant">3</code>)+x(l, j, k, <code class="constant">3</code>)+x(l, m, k, <code class="constant">3</code>)+x(l, m, n, <code class="constant">3</code>)+x(l, j, n, <code class="constant">3</code>))</a>
<a href="metric_block_p.html#metric_blocki41" target="origFile"><code class="comment">! Compute the volumes of the 6 sub pyramids. The</code></a>
<a href="metric_block_p.html#metric_blocki41" target="origFile"><code class="comment">! arguments of volpym must be such that for a (regular)</code></a>
<a href="metric_block_p.html#metric_blocki41" target="origFile"><code class="comment">! right handed hexahedron all volumes are positive.</code></a>
        <a href="metric_block_p.html#metric_blocki41" target="origFile">vp1d = <code class="funcname">VOLPYM_SPATIAL_D</code>(x(i, j, k, <code class="constant">1</code>), xd(i, j, k, <code class="constant">1</code>), x(i, j, k<code class="label">&</code></a>
<a href="metric_block_p.html#metric_blocki41" target="origFile"><code class="label">&          </code>, <code class="constant">2</code>), xd(i, j, k, <code class="constant">2</code>), x(i, j, k, <code class="constant">3</code>), xd(i, j, k, <code class="constant">3</code>), x(i, j, n<code class="label">&</code></a>
<a href="metric_block_p.html#metric_blocki41" target="origFile"><code class="label">&          </code>, <code class="constant">1</code>), xd(i, j, n, <code class="constant">1</code>), x(i, j, n, <code class="constant">2</code>), xd(i, j, n, <code class="constant">2</code>), x(i, j, n<code class="label">&</code></a>
<a href="metric_block_p.html#metric_blocki41" target="origFile"><code class="label">&          </code>, <code class="constant">3</code>), xd(i, j, n, <code class="constant">3</code>), x(i, m, n, <code class="constant">1</code>), xd(i, m, n, <code class="constant">1</code>), x(i, m, n<code class="label">&</code></a>
<a href="metric_block_p.html#metric_blocki41" target="origFile"><code class="label">&          </code>, <code class="constant">2</code>), xd(i, m, n, <code class="constant">2</code>), x(i, m, n, <code class="constant">3</code>), xd(i, m, n, <code class="constant">3</code>), x(i, m, k<code class="label">&</code></a>
<a name="metric_block_spatial_di42"></a><a href="metric_block_p.html#metric_blocki41" target="origFile"><code class="label">&          </code>, <code class="constant">1</code>), xd(i, m, k, <code class="constant">1</code>), x(i, m, k, <code class="constant">2</code>), xd(i, m, k, <code class="constant">2</code>), x(i, m, k<code class="label">&</code></a>
<a href="metric_block_p.html#metric_blocki41" target="origFile"><code class="label">&          </code>, <code class="constant">3</code>), xd(i, m, k, <code class="constant">3</code>), vp1)</a>
        <a href="metric_block_p.html#metric_blocki42" target="origFile">vp2d = <code class="funcname">VOLPYM_SPATIAL_D</code>(x(l, j, k, <code class="constant">1</code>), xd(l, j, k, <code class="constant">1</code>), x(l, j, k<code class="label">&</code></a>
<a href="metric_block_p.html#metric_blocki42" target="origFile"><code class="label">&          </code>, <code class="constant">2</code>), xd(l, j, k, <code class="constant">2</code>), x(l, j, k, <code class="constant">3</code>), xd(l, j, k, <code class="constant">3</code>), x(l, m, k<code class="label">&</code></a>
<a href="metric_block_p.html#metric_blocki42" target="origFile"><code class="label">&          </code>, <code class="constant">1</code>), xd(l, m, k, <code class="constant">1</code>), x(l, m, k, <code class="constant">2</code>), xd(l, m, k, <code class="constant">2</code>), x(l, m, k<code class="label">&</code></a>
<a href="metric_block_p.html#metric_blocki42" target="origFile"><code class="label">&          </code>, <code class="constant">3</code>), xd(l, m, k, <code class="constant">3</code>), x(l, m, n, <code class="constant">1</code>), xd(l, m, n, <code class="constant">1</code>), x(l, m, n<code class="label">&</code></a>
<a href="metric_block_p.html#metric_blocki42" target="origFile"><code class="label">&          </code>, <code class="constant">2</code>), xd(l, m, n, <code class="constant">2</code>), x(l, m, n, <code class="constant">3</code>), xd(l, m, n, <code class="constant">3</code>), x(l, j, n<code class="label">&</code></a>
<a name="metric_block_spatial_di43"></a><a href="metric_block_p.html#metric_blocki42" target="origFile"><code class="label">&          </code>, <code class="constant">1</code>), xd(l, j, n, <code class="constant">1</code>), x(l, j, n, <code class="constant">2</code>), xd(l, j, n, <code class="constant">2</code>), x(l, j, n<code class="label">&</code></a>
<a href="metric_block_p.html#metric_blocki42" target="origFile"><code class="label">&          </code>, <code class="constant">3</code>), xd(l, j, n, <code class="constant">3</code>), vp2)</a>
        <a href="metric_block_p.html#metric_blocki43" target="origFile">vp3d = <code class="funcname">VOLPYM_SPATIAL_D</code>(x(i, j, k, <code class="constant">1</code>), xd(i, j, k, <code class="constant">1</code>), x(i, j, k<code class="label">&</code></a>
<a href="metric_block_p.html#metric_blocki43" target="origFile"><code class="label">&          </code>, <code class="constant">2</code>), xd(i, j, k, <code class="constant">2</code>), x(i, j, k, <code class="constant">3</code>), xd(i, j, k, <code class="constant">3</code>), x(l, j, k<code class="label">&</code></a>
<a href="metric_block_p.html#metric_blocki43" target="origFile"><code class="label">&          </code>, <code class="constant">1</code>), xd(l, j, k, <code class="constant">1</code>), x(l, j, k, <code class="constant">2</code>), xd(l, j, k, <code class="constant">2</code>), x(l, j, k<code class="label">&</code></a>
<a href="metric_block_p.html#metric_blocki43" target="origFile"><code class="label">&          </code>, <code class="constant">3</code>), xd(l, j, k, <code class="constant">3</code>), x(l, j, n, <code class="constant">1</code>), xd(l, j, n, <code class="constant">1</code>), x(l, j, n<code class="label">&</code></a>
<a href="metric_block_p.html#metric_blocki43" target="origFile"><code class="label">&          </code>, <code class="constant">2</code>), xd(l, j, n, <code class="constant">2</code>), x(l, j, n, <code class="constant">3</code>), xd(l, j, n, <code class="constant">3</code>), x(i, j, n<code class="label">&</code></a>
<a name="metric_block_spatial_di44"></a><a href="metric_block_p.html#metric_blocki43" target="origFile"><code class="label">&          </code>, <code class="constant">1</code>), xd(i, j, n, <code class="constant">1</code>), x(i, j, n, <code class="constant">2</code>), xd(i, j, n, <code class="constant">2</code>), x(i, j, n<code class="label">&</code></a>
<a href="metric_block_p.html#metric_blocki43" target="origFile"><code class="label">&          </code>, <code class="constant">3</code>), xd(i, j, n, <code class="constant">3</code>), vp3)</a>
        <a href="metric_block_p.html#metric_blocki44" target="origFile">vp4d = <code class="funcname">VOLPYM_SPATIAL_D</code>(x(i, m, k, <code class="constant">1</code>), xd(i, m, k, <code class="constant">1</code>), x(i, m, k<code class="label">&</code></a>
<a href="metric_block_p.html#metric_blocki44" target="origFile"><code class="label">&          </code>, <code class="constant">2</code>), xd(i, m, k, <code class="constant">2</code>), x(i, m, k, <code class="constant">3</code>), xd(i, m, k, <code class="constant">3</code>), x(i, m, n<code class="label">&</code></a>
<a href="metric_block_p.html#metric_blocki44" target="origFile"><code class="label">&          </code>, <code class="constant">1</code>), xd(i, m, n, <code class="constant">1</code>), x(i, m, n, <code class="constant">2</code>), xd(i, m, n, <code class="constant">2</code>), x(i, m, n<code class="label">&</code></a>
<a href="metric_block_p.html#metric_blocki44" target="origFile"><code class="label">&          </code>, <code class="constant">3</code>), xd(i, m, n, <code class="constant">3</code>), x(l, m, n, <code class="constant">1</code>), xd(l, m, n, <code class="constant">1</code>), x(l, m, n<code class="label">&</code></a>
<a href="metric_block_p.html#metric_blocki44" target="origFile"><code class="label">&          </code>, <code class="constant">2</code>), xd(l, m, n, <code class="constant">2</code>), x(l, m, n, <code class="constant">3</code>), xd(l, m, n, <code class="constant">3</code>), x(l, m, k<code class="label">&</code></a>
<a name="metric_block_spatial_di45"></a><a href="metric_block_p.html#metric_blocki44" target="origFile"><code class="label">&          </code>, <code class="constant">1</code>), xd(l, m, k, <code class="constant">1</code>), x(l, m, k, <code class="constant">2</code>), xd(l, m, k, <code class="constant">2</code>), x(l, m, k<code class="label">&</code></a>
<a href="metric_block_p.html#metric_blocki44" target="origFile"><code class="label">&          </code>, <code class="constant">3</code>), xd(l, m, k, <code class="constant">3</code>), vp4)</a>
        <a href="metric_block_p.html#metric_blocki45" target="origFile">vp5d = <code class="funcname">VOLPYM_SPATIAL_D</code>(x(i, j, k, <code class="constant">1</code>), xd(i, j, k, <code class="constant">1</code>), x(i, j, k<code class="label">&</code></a>
<a href="metric_block_p.html#metric_blocki45" target="origFile"><code class="label">&          </code>, <code class="constant">2</code>), xd(i, j, k, <code class="constant">2</code>), x(i, j, k, <code class="constant">3</code>), xd(i, j, k, <code class="constant">3</code>), x(i, m, k<code class="label">&</code></a>
<a href="metric_block_p.html#metric_blocki45" target="origFile"><code class="label">&          </code>, <code class="constant">1</code>), xd(i, m, k, <code class="constant">1</code>), x(i, m, k, <code class="constant">2</code>), xd(i, m, k, <code class="constant">2</code>), x(i, m, k<code class="label">&</code></a>
<a href="metric_block_p.html#metric_blocki45" target="origFile"><code class="label">&          </code>, <code class="constant">3</code>), xd(i, m, k, <code class="constant">3</code>), x(l, m, k, <code class="constant">1</code>), xd(l, m, k, <code class="constant">1</code>), x(l, m, k<code class="label">&</code></a>
<a href="metric_block_p.html#metric_blocki45" target="origFile"><code class="label">&          </code>, <code class="constant">2</code>), xd(l, m, k, <code class="constant">2</code>), x(l, m, k, <code class="constant">3</code>), xd(l, m, k, <code class="constant">3</code>), x(l, j, k<code class="label">&</code></a>
<a name="metric_block_spatial_di46"></a><a href="metric_block_p.html#metric_blocki45" target="origFile"><code class="label">&          </code>, <code class="constant">1</code>), xd(l, j, k, <code class="constant">1</code>), x(l, j, k, <code class="constant">2</code>), xd(l, j, k, <code class="constant">2</code>), x(l, j, k<code class="label">&</code></a>
<a href="metric_block_p.html#metric_blocki45" target="origFile"><code class="label">&          </code>, <code class="constant">3</code>), xd(l, j, k, <code class="constant">3</code>), vp5)</a>
        <a href="metric_block_p.html#metric_blocki46" target="origFile">vp6d = <code class="funcname">VOLPYM_SPATIAL_D</code>(x(i, j, n, <code class="constant">1</code>), xd(i, j, n, <code class="constant">1</code>), x(i, j, n<code class="label">&</code></a>
<a href="metric_block_p.html#metric_blocki46" target="origFile"><code class="label">&          </code>, <code class="constant">2</code>), xd(i, j, n, <code class="constant">2</code>), x(i, j, n, <code class="constant">3</code>), xd(i, j, n, <code class="constant">3</code>), x(l, j, n<code class="label">&</code></a>
<a href="metric_block_p.html#metric_blocki46" target="origFile"><code class="label">&          </code>, <code class="constant">1</code>), xd(l, j, n, <code class="constant">1</code>), x(l, j, n, <code class="constant">2</code>), xd(l, j, n, <code class="constant">2</code>), x(l, j, n<code class="label">&</code></a>
<a href="metric_block_p.html#metric_blocki46" target="origFile"><code class="label">&          </code>, <code class="constant">3</code>), xd(l, j, n, <code class="constant">3</code>), x(l, m, n, <code class="constant">1</code>), xd(l, m, n, <code class="constant">1</code>), x(l, m, n<code class="label">&</code></a>
<a href="metric_block_p.html#metric_blocki46" target="origFile"><code class="label">&          </code>, <code class="constant">2</code>), xd(l, m, n, <code class="constant">2</code>), x(l, m, n, <code class="constant">3</code>), xd(l, m, n, <code class="constant">3</code>), x(i, m, n<code class="label">&</code></a>
<a name="metric_block_spatial_di47"></a><a href="metric_block_p.html#metric_blocki46" target="origFile"><code class="label">&          </code>, <code class="constant">1</code>), xd(i, m, n, <code class="constant">1</code>), x(i, m, n, <code class="constant">2</code>), xd(i, m, n, <code class="constant">2</code>), x(i, m, n<code class="label">&</code></a>
<a href="metric_block_p.html#metric_blocki46" target="origFile"><code class="label">&          </code>, <code class="constant">3</code>), xd(i, m, n, <code class="constant">3</code>), vp6)</a>
<a href="metric_block_p.html#metric_blocki47" target="origFile"><code class="comment">! Set the volume to 1/6 of the sum of the volumes of the</code></a>
<a href="metric_block_p.html#metric_blocki47" target="origFile"><code class="comment">! pyramid. Remember that volpym computes 6 times the</code></a>
<a href="metric_block_p.html#metric_blocki47" target="origFile"><code class="comment">! volume.</code></a>
<a name="metric_block_spatial_di48"></a>        <a href="metric_block_p.html#metric_blocki47" target="origFile">vold(i, j, k) = sixth*(vp1d+vp2d+vp3d+vp4d+vp5d+vp6d)</a>
<a name="metric_block_spatial_di50"></a>        <a href="metric_block_p.html#metric_blocki47" target="origFile">vol(i, j, k) = sixth*(vp1+vp2+vp3+vp4+vp5+vp6)</a>
        <a href="metric_block_p.html#metric_blocki48" target="origFile"><code class="keyword">IF</code> (vol(i, j, k) .GE. <code class="constant">0.</code>) <code class="keyword">THEN</code></a>
<a name="metric_block_spatial_di49"></a>          <a href="metric_block_p.html#metric_blocki50" target="origFile">vol(i, j, k) = vol(i, j, k)</a>
        <a href="metric_block_p.html#metric_blocki48" target="origFile"><code class="keyword">ELSE</code></a>
          <a href="metric_block_p.html#metric_blocki49" target="origFile">vold(i, j, k) = -vold(i, j, k)</a>
          <a href="metric_block_p.html#metric_blocki49" target="origFile">vol(i, j, k) = -vol(i, j, k)</a>
        <a href="metric_block_p.html#metric_blocki48" target="origFile"><code class="keyword">END IF</code></a>
      <a href="metric_block_p.html#metric_blocki30" target="origFile"><code class="keyword">END DO</code></a>
<a name="metric_block_spatial_di51"></a>    <a href="metric_block_p.html#metric_blocki25" target="origFile"><code class="keyword">END DO</code></a>
  <a href="metric_block_p.html#metric_blocki20" target="origFile"><code class="keyword">END DO</code></a>
<a name="metric_block_spatial_di52"></a><a href="metric_block_p.html#metric_blocki51" target="origFile"><code class="comment">! Some additional safety stuff for halo volumes.</code></a>
<a name="metric_block_spatial_di53"></a>  <a href="metric_block_p.html#metric_blocki51" target="origFile"><code class="keyword">DO </code>k=<code class="constant">2</code>,kl</a>
<a name="metric_block_spatial_di54"></a>    <a href="metric_block_p.html#metric_blocki52" target="origFile"><code class="keyword">DO </code>j=<code class="constant">2</code>,jl</a>
      <a href="metric_block_p.html#metric_blocki53" target="origFile"><code class="keyword">IF</code> (vol(<code class="constant">1</code>, j, k) .LE. eps) <code class="keyword">THEN</code></a>
        <a href="metric_block_p.html#metric_blocki54" target="origFile">vold(<code class="constant">1</code>, j, k) = vold(<code class="constant">2</code>, j, k)</a>
<a name="metric_block_spatial_di55"></a>        <a href="metric_block_p.html#metric_blocki54" target="origFile">vol(<code class="constant">1</code>, j, k) = vol(<code class="constant">2</code>, j, k)</a>
<a name="metric_block_spatial_di56"></a>      <a href="metric_block_p.html#metric_blocki53" target="origFile"><code class="keyword">END IF</code></a>
      <a href="metric_block_p.html#metric_blocki55" target="origFile"><code class="keyword">IF</code> (vol(ie, j, k) .LE. eps) <code class="keyword">THEN</code></a>
        <a href="metric_block_p.html#metric_blocki56" target="origFile">vold(ie, j, k) = vold(il, j, k)</a>
        <a href="metric_block_p.html#metric_blocki56" target="origFile">vol(ie, j, k) = vol(il, j, k)</a>
      <a href="metric_block_p.html#metric_blocki55" target="origFile"><code class="keyword">END IF</code></a>
<a name="metric_block_spatial_di57"></a>    <a href="metric_block_p.html#metric_blocki52" target="origFile"><code class="keyword">END DO</code></a>
<a name="metric_block_spatial_di58"></a>  <a href="metric_block_p.html#metric_blocki51" target="origFile"><code class="keyword">END DO</code></a>
<a name="metric_block_spatial_di59"></a>  <a href="metric_block_p.html#metric_blocki57" target="origFile"><code class="keyword">DO </code>k=<code class="constant">2</code>,kl</a>
<a name="metric_block_spatial_di60"></a>    <a href="metric_block_p.html#metric_blocki58" target="origFile"><code class="keyword">DO </code>i=<code class="constant">1</code>,ie</a>
      <a href="metric_block_p.html#metric_blocki59" target="origFile"><code class="keyword">IF</code> (vol(i, <code class="constant">1</code>, k) .LE. eps) <code class="keyword">THEN</code></a>
        <a href="metric_block_p.html#metric_blocki60" target="origFile">vold(i, <code class="constant">1</code>, k) = vold(i, <code class="constant">2</code>, k)</a>
<a name="metric_block_spatial_di61"></a>        <a href="metric_block_p.html#metric_blocki60" target="origFile">vol(i, <code class="constant">1</code>, k) = vol(i, <code class="constant">2</code>, k)</a>
<a name="metric_block_spatial_di62"></a>      <a href="metric_block_p.html#metric_blocki59" target="origFile"><code class="keyword">END IF</code></a>
      <a href="metric_block_p.html#metric_blocki61" target="origFile"><code class="keyword">IF</code> (vol(i, je, k) .LE. eps) <code class="keyword">THEN</code></a>
        <a href="metric_block_p.html#metric_blocki62" target="origFile">vold(i, je, k) = vold(i, jl, k)</a>
        <a href="metric_block_p.html#metric_blocki62" target="origFile">vol(i, je, k) = vol(i, jl, k)</a>
      <a href="metric_block_p.html#metric_blocki61" target="origFile"><code class="keyword">END IF</code></a>
<a name="metric_block_spatial_di63"></a>    <a href="metric_block_p.html#metric_blocki58" target="origFile"><code class="keyword">END DO</code></a>
<a name="metric_block_spatial_di64"></a>  <a href="metric_block_p.html#metric_blocki57" target="origFile"><code class="keyword">END DO</code></a>
<a name="metric_block_spatial_di65"></a>  <a href="metric_block_p.html#metric_blocki63" target="origFile"><code class="keyword">DO </code>j=<code class="constant">1</code>,je</a>
<a name="metric_block_spatial_di66"></a>    <a href="metric_block_p.html#metric_blocki64" target="origFile"><code class="keyword">DO </code>i=<code class="constant">1</code>,ie</a>
      <a href="metric_block_p.html#metric_blocki65" target="origFile"><code class="keyword">IF</code> (vol(i, j, <code class="constant">1</code>) .LE. eps) <code class="keyword">THEN</code></a>
        <a href="metric_block_p.html#metric_blocki66" target="origFile">vold(i, j, <code class="constant">1</code>) = vold(i, j, <code class="constant">2</code>)</a>
<a name="metric_block_spatial_di67"></a>        <a href="metric_block_p.html#metric_blocki66" target="origFile">vol(i, j, <code class="constant">1</code>) = vol(i, j, <code class="constant">2</code>)</a>
<a name="metric_block_spatial_di68"></a>      <a href="metric_block_p.html#metric_blocki65" target="origFile"><code class="keyword">END IF</code></a>
      <a href="metric_block_p.html#metric_blocki67" target="origFile"><code class="keyword">IF</code> (vol(i, j, ke) .LE. eps) <code class="keyword">THEN</code></a>
        <a href="metric_block_p.html#metric_blocki68" target="origFile">vold(i, j, ke) = vold(i, j, kl)</a>
        <a href="metric_block_p.html#metric_blocki68" target="origFile">vol(i, j, ke) = vol(i, j, kl)</a>
      <a href="metric_block_p.html#metric_blocki67" target="origFile"><code class="keyword">END IF</code></a>
<a name="metric_block_spatial_di69"></a>    <a href="metric_block_p.html#metric_blocki64" target="origFile"><code class="keyword">END DO</code></a>
  <a href="metric_block_p.html#metric_blocki63" target="origFile"><code class="keyword">END DO</code></a>
<a href="metric_block_p.html#metric_blocki69" target="origFile"><code class="comment">! Set the factor in the surface normals computation. For a</code></a>
<a href="metric_block_p.html#metric_blocki69" target="origFile"><code class="comment">! left handed block this factor is negative, such that the</code></a>
<a href="metric_block_p.html#metric_blocki69" target="origFile"><code class="comment">! normals still point in the direction of increasing index.</code></a>
<a href="metric_block_p.html#metric_blocki69" target="origFile"><code class="comment">! The formulae used later on assume a right handed block</code></a>
<a name="p7"></a><a href="metric_block_p.html#metric_blocki69" target="origFile"><code class="comment">! and fact is used to correct this for a left handed block,</code></a>
<a name="metric_block_spatial_di70"></a><a href="metric_block_p.html#metric_blocki69" target="origFile"><code class="comment">! as well as the scaling factor of 0.5</code></a>
<a name="metric_block_spatial_di71"></a>  <a href="metric_block_p.html#metric_blocki69" target="origFile">result1 = </a><a href="msg.html#p7" target="msg"><code class="comment"><img src="danger.gif" align=middle border=0 alt="!" /></code></a><a href="metric_block_p.html#metric_blocki69" target="origFile"><code class="funcname">FLOWDOMS</code>(nn, level, sps)</a>
  <a href="metric_block_p.html#metric_blocki70" target="origFile"><code class="keyword">IF</code> (result1%righthanded) <code class="keyword">THEN</code></a>
    <a href="metric_block_p.html#metric_blocki71" target="origFile">fact = half</a>
    <a href="metric_block_p.html#metric_blocki70" target="origFile">sid = <code class="constant">0.0</code></a>
    <a href="metric_block_p.html#metric_blocki70" target="origFile">v1d = <code class="constant">0.0</code></a>
<a name="metric_block_spatial_di72"></a>    <a href="metric_block_p.html#metric_blocki70" target="origFile">v2d = <code class="constant">0.0</code></a>
  <a href="metric_block_p.html#metric_blocki70" target="origFile"><code class="keyword">ELSE</code></a>
    <a href="metric_block_p.html#metric_blocki72" target="origFile">fact = -half</a>
    <a href="metric_block_p.html#metric_blocki70" target="origFile">sid = <code class="constant">0.0</code></a>
    <a href="metric_block_p.html#metric_blocki70" target="origFile">v1d = <code class="constant">0.0</code></a>
<a name="metric_block_spatial_di73"></a>    <a href="metric_block_p.html#metric_blocki70" target="origFile">v2d = <code class="constant">0.0</code></a>
  <a href="metric_block_p.html#metric_blocki70" target="origFile"><code class="keyword">END IF</code></a>
<a href="metric_block_p.html#metric_blocki73" target="origFile"><code class="comment">! Check if both positive and negative volumes occur. If so,</code></a>
<a href="metric_block_p.html#metric_blocki73" target="origFile"><code class="comment">! the block is bad and the counter nBlockBad is updated.</code></a>
<a href="metric_block_p.html#metric_blocki73" target="origFile"><code class="comment">!</code></a>
<a href="metric_block_p.html#metric_blocki73" target="origFile"><code class="comment">!          **************************************************************</code></a>
<a href="metric_block_p.html#metric_blocki73" target="origFile"><code class="comment">!          *                                                            *</code></a>
<a href="metric_block_p.html#metric_blocki73" target="origFile"><code class="comment">!          * Computation of the face normals in i-, j- and k-direction. *</code></a>
<a href="metric_block_p.html#metric_blocki73" target="origFile"><code class="comment">!          * Formula's are valid for a right handed block; for a left   *</code></a>
<a href="metric_block_p.html#metric_blocki73" target="origFile"><code class="comment">!          * handed block the correct orientation is obtained via fact. *</code></a>
<a href="metric_block_p.html#metric_blocki73" target="origFile"><code class="comment">!          * The normals point in the direction of increasing index.    *</code></a>
<a href="metric_block_p.html#metric_blocki73" target="origFile"><code class="comment">!          * The absolute value of fact is 0.5, because the cross       *</code></a>
<a href="metric_block_p.html#metric_blocki73" target="origFile"><code class="comment">!          * product of the two diagonals is twice the normal vector.   *</code></a>
<a href="metric_block_p.html#metric_blocki73" target="origFile"><code class="comment">!          *                                                            *</code></a>
<a href="metric_block_p.html#metric_blocki73" target="origFile"><code class="comment">!          * Note that also the normals of the first level halo cells   *</code></a>
<a href="metric_block_p.html#metric_blocki73" target="origFile"><code class="comment">!          * are computed. These are needed for the viscous fluxes.     *</code></a>
<a href="metric_block_p.html#metric_blocki73" target="origFile"><code class="comment">!          *                                                            *</code></a>
<a href="metric_block_p.html#metric_blocki73" target="origFile"><code class="comment">!          **************************************************************</code></a>
<a href="metric_block_p.html#metric_blocki73" target="origFile"><code class="comment">!</code></a>
<a name="metric_block_spatial_di74"></a><a href="metric_block_p.html#metric_blocki73" target="origFile"><code class="comment">! Projected areas of cell faces in the i direction.</code></a>
<a name="metric_block_spatial_di75"></a>  <a href="metric_block_p.html#metric_blocki73" target="origFile"><code class="keyword">DO </code>k=<code class="constant">1</code>,ke</a>
<a name="metric_block_spatial_di76"></a>    <a href="metric_block_p.html#metric_blocki74" target="origFile">n = k - <code class="constant">1</code></a>
<a name="metric_block_spatial_di77"></a>    <a href="metric_block_p.html#metric_blocki75" target="origFile"><code class="keyword">DO </code>j=<code class="constant">1</code>,je</a>
<a name="metric_block_spatial_di78"></a>      <a href="metric_block_p.html#metric_blocki76" target="origFile">m = j - <code class="constant">1</code></a>
      <a href="metric_block_p.html#metric_blocki77" target="origFile"><code class="keyword">DO </code>i=<code class="constant">0</code>,ie</a>
<a href="metric_block_p.html#metric_blocki78" target="origFile"><code class="comment">! Determine the two diagonal vectors of the face.</code></a>
<a name="metric_block_spatial_di79"></a>        <a href="metric_block_p.html#metric_blocki78" target="origFile">v1d(<code class="constant">1</code>) = xd(i, j, n, <code class="constant">1</code>) - xd(i, m, k, <code class="constant">1</code>)</a>
        <a href="metric_block_p.html#metric_blocki78" target="origFile">v1(<code class="constant">1</code>) = x(i, j, n, <code class="constant">1</code>) - x(i, m, k, <code class="constant">1</code>)</a>
<a name="metric_block_spatial_di80"></a>        <a href="metric_block_p.html#metric_blocki79" target="origFile">v1d(<code class="constant">2</code>) = xd(i, j, n, <code class="constant">2</code>) - xd(i, m, k, <code class="constant">2</code>)</a>
        <a href="metric_block_p.html#metric_blocki79" target="origFile">v1(<code class="constant">2</code>) = x(i, j, n, <code class="constant">2</code>) - x(i, m, k, <code class="constant">2</code>)</a>
<a name="metric_block_spatial_di81"></a>        <a href="metric_block_p.html#metric_blocki80" target="origFile">v1d(<code class="constant">3</code>) = xd(i, j, n, <code class="constant">3</code>) - xd(i, m, k, <code class="constant">3</code>)</a>
        <a href="metric_block_p.html#metric_blocki80" target="origFile">v1(<code class="constant">3</code>) = x(i, j, n, <code class="constant">3</code>) - x(i, m, k, <code class="constant">3</code>)</a>
<a name="metric_block_spatial_di82"></a>        <a href="metric_block_p.html#metric_blocki81" target="origFile">v2d(<code class="constant">1</code>) = xd(i, j, k, <code class="constant">1</code>) - xd(i, m, n, <code class="constant">1</code>)</a>
        <a href="metric_block_p.html#metric_blocki81" target="origFile">v2(<code class="constant">1</code>) = x(i, j, k, <code class="constant">1</code>) - x(i, m, n, <code class="constant">1</code>)</a>
<a name="metric_block_spatial_di83"></a>        <a href="metric_block_p.html#metric_blocki82" target="origFile">v2d(<code class="constant">2</code>) = xd(i, j, k, <code class="constant">2</code>) - xd(i, m, n, <code class="constant">2</code>)</a>
        <a href="metric_block_p.html#metric_blocki82" target="origFile">v2(<code class="constant">2</code>) = x(i, j, k, <code class="constant">2</code>) - x(i, m, n, <code class="constant">2</code>)</a>
<a name="metric_block_spatial_di84"></a>        <a href="metric_block_p.html#metric_blocki83" target="origFile">v2d(<code class="constant">3</code>) = xd(i, j, k, <code class="constant">3</code>) - xd(i, m, n, <code class="constant">3</code>)</a>
        <a href="metric_block_p.html#metric_blocki83" target="origFile">v2(<code class="constant">3</code>) = x(i, j, k, <code class="constant">3</code>) - x(i, m, n, <code class="constant">3</code>)</a>
<a href="metric_block_p.html#metric_blocki84" target="origFile"><code class="comment">! The face normal, which is the cross product of the two</code></a>
<a href="metric_block_p.html#metric_blocki84" target="origFile"><code class="comment">! diagonal vectors times fact; remember that fact is</code></a>
<a href="metric_block_p.html#metric_blocki84" target="origFile"><code class="comment">! either -0.5 or 0.5.</code></a>
        <a href="metric_block_p.html#metric_blocki84" target="origFile">sid(i, j, k, <code class="constant">1</code>) = fact*(v1d(<code class="constant">2</code>)*v2(<code class="constant">3</code>)+v1(<code class="constant">2</code>)*v2d(<code class="constant">3</code>)-v1d(<code class="constant">3</code>)*v2(<code class="constant">2</code>)-<code class="label">&</code></a>
<a name="metric_block_spatial_di85"></a><a href="metric_block_p.html#metric_blocki84" target="origFile"><code class="label">&          </code>v1(<code class="constant">3</code>)*v2d(<code class="constant">2</code>))</a>
        <a href="metric_block_p.html#metric_blocki84" target="origFile">si(i, j, k, <code class="constant">1</code>) = fact*(v1(<code class="constant">2</code>)*v2(<code class="constant">3</code>)-v1(<code class="constant">3</code>)*v2(<code class="constant">2</code>))</a>
        <a href="metric_block_p.html#metric_blocki85" target="origFile">sid(i, j, k, <code class="constant">2</code>) = fact*(v1d(<code class="constant">3</code>)*v2(<code class="constant">1</code>)+v1(<code class="constant">3</code>)*v2d(<code class="constant">1</code>)-v1d(<code class="constant">1</code>)*v2(<code class="constant">3</code>)-<code class="label">&</code></a>
<a name="metric_block_spatial_di86"></a><a href="metric_block_p.html#metric_blocki85" target="origFile"><code class="label">&          </code>v1(<code class="constant">1</code>)*v2d(<code class="constant">3</code>))</a>
        <a href="metric_block_p.html#metric_blocki85" target="origFile">si(i, j, k, <code class="constant">2</code>) = fact*(v1(<code class="constant">3</code>)*v2(<code class="constant">1</code>)-v1(<code class="constant">1</code>)*v2(<code class="constant">3</code>))</a>
        <a href="metric_block_p.html#metric_blocki86" target="origFile">sid(i, j, k, <code class="constant">3</code>) = fact*(v1d(<code class="constant">1</code>)*v2(<code class="constant">2</code>)+v1(<code class="constant">1</code>)*v2d(<code class="constant">2</code>)-v1d(<code class="constant">2</code>)*v2(<code class="constant">1</code>)-<code class="label">&</code></a>
<a href="metric_block_p.html#metric_blocki86" target="origFile"><code class="label">&          </code>v1(<code class="constant">2</code>)*v2d(<code class="constant">1</code>))</a>
        <a href="metric_block_p.html#metric_blocki86" target="origFile">si(i, j, k, <code class="constant">3</code>) = fact*(v1(<code class="constant">1</code>)*v2(<code class="constant">2</code>)-v1(<code class="constant">2</code>)*v2(<code class="constant">1</code>))</a>
      <a href="metric_block_p.html#metric_blocki77" target="origFile"><code class="keyword">END DO</code></a>
    <a href="metric_block_p.html#metric_blocki75" target="origFile"><code class="keyword">END DO</code></a>
<a name="metric_block_spatial_di87"></a>  <a href="metric_block_p.html#metric_blocki73" target="origFile"><code class="keyword">END DO</code></a>
  <a href="metric_block_p.html#metric_block" target="origFile">sjd = <code class="constant">0.0</code></a>
<a name="metric_block_spatial_di88"></a><a href="metric_block_p.html#metric_blocki87" target="origFile"><code class="comment">! Projected areas of cell faces in the j direction.</code></a>
<a name="metric_block_spatial_di89"></a>  <a href="metric_block_p.html#metric_blocki87" target="origFile"><code class="keyword">DO </code>k=<code class="constant">1</code>,ke</a>
<a name="metric_block_spatial_di90"></a>    <a href="metric_block_p.html#metric_blocki88" target="origFile">n = k - <code class="constant">1</code></a>
<a name="metric_block_spatial_di91"></a>    <a href="metric_block_p.html#metric_blocki89" target="origFile"><code class="keyword">DO </code>j=<code class="constant">0</code>,je</a>
<a name="metric_block_spatial_di92"></a>      <a href="metric_block_p.html#metric_blocki90" target="origFile"><code class="keyword">DO </code>i=<code class="constant">1</code>,ie</a>
        <a href="metric_block_p.html#metric_blocki91" target="origFile">l = i - <code class="constant">1</code></a>
<a href="metric_block_p.html#metric_blocki92" target="origFile"><code class="comment">! Determine the two diagonal vectors of the face.</code></a>
<a name="metric_block_spatial_di93"></a>        <a href="metric_block_p.html#metric_blocki92" target="origFile">v1d(<code class="constant">1</code>) = xd(i, j, n, <code class="constant">1</code>) - xd(l, j, k, <code class="constant">1</code>)</a>
        <a href="metric_block_p.html#metric_blocki92" target="origFile">v1(<code class="constant">1</code>) = x(i, j, n, <code class="constant">1</code>) - x(l, j, k, <code class="constant">1</code>)</a>
<a name="metric_block_spatial_di94"></a>        <a href="metric_block_p.html#metric_blocki93" target="origFile">v1d(<code class="constant">2</code>) = xd(i, j, n, <code class="constant">2</code>) - xd(l, j, k, <code class="constant">2</code>)</a>
        <a href="metric_block_p.html#metric_blocki93" target="origFile">v1(<code class="constant">2</code>) = x(i, j, n, <code class="constant">2</code>) - x(l, j, k, <code class="constant">2</code>)</a>
<a name="metric_block_spatial_di95"></a>        <a href="metric_block_p.html#metric_blocki94" target="origFile">v1d(<code class="constant">3</code>) = xd(i, j, n, <code class="constant">3</code>) - xd(l, j, k, <code class="constant">3</code>)</a>
        <a href="metric_block_p.html#metric_blocki94" target="origFile">v1(<code class="constant">3</code>) = x(i, j, n, <code class="constant">3</code>) - x(l, j, k, <code class="constant">3</code>)</a>
<a name="metric_block_spatial_di96"></a>        <a href="metric_block_p.html#metric_blocki95" target="origFile">v2d(<code class="constant">1</code>) = xd(l, j, n, <code class="constant">1</code>) - xd(i, j, k, <code class="constant">1</code>)</a>
        <a href="metric_block_p.html#metric_blocki95" target="origFile">v2(<code class="constant">1</code>) = x(l, j, n, <code class="constant">1</code>) - x(i, j, k, <code class="constant">1</code>)</a>
<a name="metric_block_spatial_di97"></a>        <a href="metric_block_p.html#metric_blocki96" target="origFile">v2d(<code class="constant">2</code>) = xd(l, j, n, <code class="constant">2</code>) - xd(i, j, k, <code class="constant">2</code>)</a>
        <a href="metric_block_p.html#metric_blocki96" target="origFile">v2(<code class="constant">2</code>) = x(l, j, n, <code class="constant">2</code>) - x(i, j, k, <code class="constant">2</code>)</a>
<a name="metric_block_spatial_di98"></a>        <a href="metric_block_p.html#metric_blocki97" target="origFile">v2d(<code class="constant">3</code>) = xd(l, j, n, <code class="constant">3</code>) - xd(i, j, k, <code class="constant">3</code>)</a>
        <a href="metric_block_p.html#metric_blocki97" target="origFile">v2(<code class="constant">3</code>) = x(l, j, n, <code class="constant">3</code>) - x(i, j, k, <code class="constant">3</code>)</a>
<a href="metric_block_p.html#metric_blocki98" target="origFile"><code class="comment">! The face normal, which is the cross product of the two</code></a>
<a href="metric_block_p.html#metric_blocki98" target="origFile"><code class="comment">! diagonal vectors times fact; remember that fact is</code></a>
<a href="metric_block_p.html#metric_blocki98" target="origFile"><code class="comment">! either -0.5 or 0.5.</code></a>
        <a href="metric_block_p.html#metric_blocki98" target="origFile">sjd(i, j, k, <code class="constant">1</code>) = fact*(v1d(<code class="constant">2</code>)*v2(<code class="constant">3</code>)+v1(<code class="constant">2</code>)*v2d(<code class="constant">3</code>)-v1d(<code class="constant">3</code>)*v2(<code class="constant">2</code>)-<code class="label">&</code></a>
<a name="metric_block_spatial_di99"></a><a href="metric_block_p.html#metric_blocki98" target="origFile"><code class="label">&          </code>v1(<code class="constant">3</code>)*v2d(<code class="constant">2</code>))</a>
        <a href="metric_block_p.html#metric_blocki98" target="origFile">sj(i, j, k, <code class="constant">1</code>) = fact*(v1(<code class="constant">2</code>)*v2(<code class="constant">3</code>)-v1(<code class="constant">3</code>)*v2(<code class="constant">2</code>))</a>
        <a href="metric_block_p.html#metric_blocki99" target="origFile">sjd(i, j, k, <code class="constant">2</code>) = fact*(v1d(<code class="constant">3</code>)*v2(<code class="constant">1</code>)+v1(<code class="constant">3</code>)*v2d(<code class="constant">1</code>)-v1d(<code class="constant">1</code>)*v2(<code class="constant">3</code>)-<code class="label">&</code></a>
<a name="metric_block_spatial_di100"></a><a href="metric_block_p.html#metric_blocki99" target="origFile"><code class="label">&          </code>v1(<code class="constant">1</code>)*v2d(<code class="constant">3</code>))</a>
        <a href="metric_block_p.html#metric_blocki99" target="origFile">sj(i, j, k, <code class="constant">2</code>) = fact*(v1(<code class="constant">3</code>)*v2(<code class="constant">1</code>)-v1(<code class="constant">1</code>)*v2(<code class="constant">3</code>))</a>
        <a href="metric_block_p.html#metric_blocki100" target="origFile">sjd(i, j, k, <code class="constant">3</code>) = fact*(v1d(<code class="constant">1</code>)*v2(<code class="constant">2</code>)+v1(<code class="constant">1</code>)*v2d(<code class="constant">2</code>)-v1d(<code class="constant">2</code>)*v2(<code class="constant">1</code>)-<code class="label">&</code></a>
<a href="metric_block_p.html#metric_blocki100" target="origFile"><code class="label">&          </code>v1(<code class="constant">2</code>)*v2d(<code class="constant">1</code>))</a>
        <a href="metric_block_p.html#metric_blocki100" target="origFile">sj(i, j, k, <code class="constant">3</code>) = fact*(v1(<code class="constant">1</code>)*v2(<code class="constant">2</code>)-v1(<code class="constant">2</code>)*v2(<code class="constant">1</code>))</a>
      <a href="metric_block_p.html#metric_blocki90" target="origFile"><code class="keyword">END DO</code></a>
    <a href="metric_block_p.html#metric_blocki89" target="origFile"><code class="keyword">END DO</code></a>
<a name="metric_block_spatial_di101"></a>  <a href="metric_block_p.html#metric_blocki87" target="origFile"><code class="keyword">END DO</code></a>
  <a href="metric_block_p.html#metric_block" target="origFile">skd = <code class="constant">0.0</code></a>
<a name="metric_block_spatial_di102"></a><a href="metric_block_p.html#metric_blocki101" target="origFile"><code class="comment">! Projected areas of cell faces in the k direction.</code></a>
<a name="metric_block_spatial_di103"></a>  <a href="metric_block_p.html#metric_blocki101" target="origFile"><code class="keyword">DO </code>k=<code class="constant">0</code>,ke</a>
<a name="metric_block_spatial_di104"></a>    <a href="metric_block_p.html#metric_blocki102" target="origFile"><code class="keyword">DO </code>j=<code class="constant">1</code>,je</a>
<a name="metric_block_spatial_di105"></a>      <a href="metric_block_p.html#metric_blocki103" target="origFile">m = j - <code class="constant">1</code></a>
<a name="metric_block_spatial_di106"></a>      <a href="metric_block_p.html#metric_blocki104" target="origFile"><code class="keyword">DO </code>i=<code class="constant">1</code>,ie</a>
        <a href="metric_block_p.html#metric_blocki105" target="origFile">l = i - <code class="constant">1</code></a>
<a href="metric_block_p.html#metric_blocki106" target="origFile"><code class="comment">! Determine the two diagonal vectors of the face.</code></a>
<a name="metric_block_spatial_di107"></a>        <a href="metric_block_p.html#metric_blocki106" target="origFile">v1d(<code class="constant">1</code>) = xd(i, j, k, <code class="constant">1</code>) - xd(l, m, k, <code class="constant">1</code>)</a>
        <a href="metric_block_p.html#metric_blocki106" target="origFile">v1(<code class="constant">1</code>) = x(i, j, k, <code class="constant">1</code>) - x(l, m, k, <code class="constant">1</code>)</a>
<a name="metric_block_spatial_di108"></a>        <a href="metric_block_p.html#metric_blocki107" target="origFile">v1d(<code class="constant">2</code>) = xd(i, j, k, <code class="constant">2</code>) - xd(l, m, k, <code class="constant">2</code>)</a>
        <a href="metric_block_p.html#metric_blocki107" target="origFile">v1(<code class="constant">2</code>) = x(i, j, k, <code class="constant">2</code>) - x(l, m, k, <code class="constant">2</code>)</a>
<a name="metric_block_spatial_di109"></a>        <a href="metric_block_p.html#metric_blocki108" target="origFile">v1d(<code class="constant">3</code>) = xd(i, j, k, <code class="constant">3</code>) - xd(l, m, k, <code class="constant">3</code>)</a>
        <a href="metric_block_p.html#metric_blocki108" target="origFile">v1(<code class="constant">3</code>) = x(i, j, k, <code class="constant">3</code>) - x(l, m, k, <code class="constant">3</code>)</a>
<a name="metric_block_spatial_di110"></a>        <a href="metric_block_p.html#metric_blocki109" target="origFile">v2d(<code class="constant">1</code>) = xd(l, j, k, <code class="constant">1</code>) - xd(i, m, k, <code class="constant">1</code>)</a>
        <a href="metric_block_p.html#metric_blocki109" target="origFile">v2(<code class="constant">1</code>) = x(l, j, k, <code class="constant">1</code>) - x(i, m, k, <code class="constant">1</code>)</a>
<a name="metric_block_spatial_di111"></a>        <a href="metric_block_p.html#metric_blocki110" target="origFile">v2d(<code class="constant">2</code>) = xd(l, j, k, <code class="constant">2</code>) - xd(i, m, k, <code class="constant">2</code>)</a>
        <a href="metric_block_p.html#metric_blocki110" target="origFile">v2(<code class="constant">2</code>) = x(l, j, k, <code class="constant">2</code>) - x(i, m, k, <code class="constant">2</code>)</a>
<a name="metric_block_spatial_di112"></a>        <a href="metric_block_p.html#metric_blocki111" target="origFile">v2d(<code class="constant">3</code>) = xd(l, j, k, <code class="constant">3</code>) - xd(i, m, k, <code class="constant">3</code>)</a>
        <a href="metric_block_p.html#metric_blocki111" target="origFile">v2(<code class="constant">3</code>) = x(l, j, k, <code class="constant">3</code>) - x(i, m, k, <code class="constant">3</code>)</a>
<a href="metric_block_p.html#metric_blocki112" target="origFile"><code class="comment">! The face normal, which is the cross product of the two</code></a>
<a href="metric_block_p.html#metric_blocki112" target="origFile"><code class="comment">! diagonal vectors times fact; remember that fact is</code></a>
<a href="metric_block_p.html#metric_blocki112" target="origFile"><code class="comment">! either -0.5 or 0.5.</code></a>
        <a href="metric_block_p.html#metric_blocki112" target="origFile">skd(i, j, k, <code class="constant">1</code>) = fact*(v1d(<code class="constant">2</code>)*v2(<code class="constant">3</code>)+v1(<code class="constant">2</code>)*v2d(<code class="constant">3</code>)-v1d(<code class="constant">3</code>)*v2(<code class="constant">2</code>)-<code class="label">&</code></a>
<a name="metric_block_spatial_di113"></a><a href="metric_block_p.html#metric_blocki112" target="origFile"><code class="label">&          </code>v1(<code class="constant">3</code>)*v2d(<code class="constant">2</code>))</a>
        <a href="metric_block_p.html#metric_blocki112" target="origFile">sk(i, j, k, <code class="constant">1</code>) = fact*(v1(<code class="constant">2</code>)*v2(<code class="constant">3</code>)-v1(<code class="constant">3</code>)*v2(<code class="constant">2</code>))</a>
        <a href="metric_block_p.html#metric_blocki113" target="origFile">skd(i, j, k, <code class="constant">2</code>) = fact*(v1d(<code class="constant">3</code>)*v2(<code class="constant">1</code>)+v1(<code class="constant">3</code>)*v2d(<code class="constant">1</code>)-v1d(<code class="constant">1</code>)*v2(<code class="constant">3</code>)-<code class="label">&</code></a>
<a name="metric_block_spatial_di114"></a><a href="metric_block_p.html#metric_blocki113" target="origFile"><code class="label">&          </code>v1(<code class="constant">1</code>)*v2d(<code class="constant">3</code>))</a>
        <a href="metric_block_p.html#metric_blocki113" target="origFile">sk(i, j, k, <code class="constant">2</code>) = fact*(v1(<code class="constant">3</code>)*v2(<code class="constant">1</code>)-v1(<code class="constant">1</code>)*v2(<code class="constant">3</code>))</a>
        <a href="metric_block_p.html#metric_blocki114" target="origFile">skd(i, j, k, <code class="constant">3</code>) = fact*(v1d(<code class="constant">1</code>)*v2(<code class="constant">2</code>)+v1(<code class="constant">1</code>)*v2d(<code class="constant">2</code>)-v1d(<code class="constant">2</code>)*v2(<code class="constant">1</code>)-<code class="label">&</code></a>
<a href="metric_block_p.html#metric_blocki114" target="origFile"><code class="label">&          </code>v1(<code class="constant">2</code>)*v2d(<code class="constant">1</code>))</a>
        <a href="metric_block_p.html#metric_blocki114" target="origFile">sk(i, j, k, <code class="constant">3</code>) = fact*(v1(<code class="constant">1</code>)*v2(<code class="constant">2</code>)-v1(<code class="constant">2</code>)*v2(<code class="constant">1</code>))</a>
      <a href="metric_block_p.html#metric_blocki104" target="origFile"><code class="keyword">END DO</code></a>
<a name="metric_block_spatial_di115"></a>    <a href="metric_block_p.html#metric_blocki102" target="origFile"><code class="keyword">END DO</code></a>
  <a href="metric_block_p.html#metric_blocki101" target="origFile"><code class="keyword">END DO</code></a>
<a href="metric_block_p.html#metric_blocki115" target="origFile"><code class="comment">!</code></a>
<a href="metric_block_p.html#metric_blocki115" target="origFile"><code class="comment">!          **************************************************************</code></a>
<a href="metric_block_p.html#metric_blocki115" target="origFile"><code class="comment">!          *                                                            *</code></a>
<a href="metric_block_p.html#metric_blocki115" target="origFile"><code class="comment">!          * The unit normals on the boundary faces. These always point *</code></a>
<a href="metric_block_p.html#metric_blocki115" target="origFile"><code class="comment">!          * out of the domain, so a multiplication by -1 is needed for *</code></a>
<a href="metric_block_p.html#metric_blocki115" target="origFile"><code class="comment">!          * the iMin, jMin and kMin boundaries.                        *</code></a>
<a href="metric_block_p.html#metric_blocki115" target="origFile"><code class="comment">!          *                                                            *</code></a>
<a href="metric_block_p.html#metric_blocki115" target="origFile"><code class="comment">!          **************************************************************</code></a>
<a href="metric_block_p.html#metric_blocki115" target="origFile"><code class="comment">!</code></a>
<a name="metric_block_spatial_di116"></a><a href="metric_block_p.html#metric_blocki115" target="origFile"><code class="comment">! Loop over the boundary subfaces of this block.</code></a>
<a href="metric_block_p.html#metric_blocki115" target="origFile"><code class="label">bocoloop:</code><code class="keyword">DO </code>mm=<code class="constant">1</code>,nbocos</a>
<a href="metric_block_p.html#metric_blocki116" target="origFile"><code class="comment">! Determine the block face on which this subface is located</code></a>
<a href="metric_block_p.html#metric_blocki116" target="origFile"><code class="comment">! and set ss and mult accordingly.</code></a>
<a name="metric_block_spatial_di117"></a>    <a href="metric_block_p.html#metric_blocki116" target="origFile"><code class="keyword">SELECT CASE </code> (bcfaceid(mm)) </a>
    <a href="metric_block_p.html#metric_blocki116" target="origFile"><code class="keyword">CASE </code>(imin) </a>
      <a href="metric_block_p.html#metric_blocki117" target="origFile">mult = -one</a>
<a name="metric_block_spatial_di119"></a>      <a href="metric_block_p.html#metric_blocki116" target="origFile">ss => si(<code class="constant">1</code>, :, :, :)</a>
    <a href="metric_block_p.html#metric_blocki116" target="origFile"><code class="keyword">CASE </code>(imax) </a>
      <a href="metric_block_p.html#metric_blocki119" target="origFile">mult = one</a>
<a name="metric_block_spatial_di121"></a>      <a href="metric_block_p.html#metric_blocki116" target="origFile">ss => si(il, :, :, :)</a>
    <a href="metric_block_p.html#metric_blocki116" target="origFile"><code class="keyword">CASE </code>(jmin) </a>
      <a href="metric_block_p.html#metric_blocki121" target="origFile">mult = -one</a>
<a name="metric_block_spatial_di123"></a>      <a href="metric_block_p.html#metric_blocki116" target="origFile">ss => sj(:, <code class="constant">1</code>, :, :)</a>
    <a href="metric_block_p.html#metric_blocki116" target="origFile"><code class="keyword">CASE </code>(jmax) </a>
      <a href="metric_block_p.html#metric_blocki123" target="origFile">mult = one</a>
<a name="metric_block_spatial_di125"></a>      <a href="metric_block_p.html#metric_blocki116" target="origFile">ss => sj(:, jl, :, :)</a>
    <a href="metric_block_p.html#metric_blocki116" target="origFile"><code class="keyword">CASE </code>(kmin) </a>
      <a href="metric_block_p.html#metric_blocki125" target="origFile">mult = -one</a>
<a name="metric_block_spatial_di127"></a>      <a href="metric_block_p.html#metric_blocki116" target="origFile">ss => sk(:, :, <code class="constant">1</code>, :)</a>
    <a href="metric_block_p.html#metric_blocki116" target="origFile"><code class="keyword">CASE </code>(kmax) </a>
      <a href="metric_block_p.html#metric_blocki127" target="origFile">mult = one</a>
<a name="metric_block_spatial_di129"></a>      <a href="metric_block_p.html#metric_blocki116" target="origFile">ss => sk(:, :, kl, :)</a>
    <a href="metric_block_p.html#metric_blocki116" target="origFile"><code class="keyword">END SELECT</code></a>
<a name="metric_block_spatial_di130"></a><a href="metric_block_p.html#metric_blocki129" target="origFile"><code class="comment">! Loop over the boundary faces of the subface.</code></a>
<a name="metric_block_spatial_di131"></a>    <a href="metric_block_p.html#metric_blocki129" target="origFile"><code class="keyword">DO </code>j=bcdata(mm)%jcbeg,bcdata(mm)%jcend</a>
      <a href="metric_block_p.html#metric_blocki130" target="origFile"><code class="keyword">DO </code>i=bcdata(mm)%icbeg,bcdata(mm)%icend</a>
<a name="p41"></a><a href="metric_block_p.html#metric_blocki131" target="origFile"><code class="comment">! Compute the inverse of the length of the normal vector</code></a>
<a name="p42"></a><a name="metric_block_spatial_di132"></a><a href="metric_block_p.html#metric_blocki131" target="origFile"><code class="comment">! and possibly correct for inward pointing.</code></a>
<a name="p43"></a><a name="metric_block_spatial_di133"></a>        <a href="metric_block_p.html#metric_blocki131" target="origFile">xp = </a><a href="msg.html#p41" target="msg"><code class="comment"><img src="danger.gif" align=middle border=0 alt="!" /></code></a><a href="metric_block_p.html#metric_blocki131" target="origFile">ss(i, j, <code class="constant">1</code>)</a>
<a name="metric_block_spatial_di134"></a>        <a href="metric_block_p.html#metric_blocki132" target="origFile">yp = </a><a href="msg.html#p42" target="msg"><code class="comment"><img src="danger.gif" align=middle border=0 alt="!" /></code></a><a href="metric_block_p.html#metric_blocki132" target="origFile">ss(i, j, <code class="constant">2</code>)</a>
<a name="metric_block_spatial_di135"></a>        <a href="metric_block_p.html#metric_blocki133" target="origFile">zp = </a><a href="msg.html#p43" target="msg"><code class="comment"><img src="danger.gif" align=middle border=0 alt="!" /></code></a><a href="metric_block_p.html#metric_blocki133" target="origFile">ss(i, j, <code class="constant">3</code>)</a>
<a name="metric_block_spatial_di137"></a><a name="metric_block_spatial_di136"></a>        <a href="metric_block_p.html#metric_blocki134" target="origFile">arg1 = xp*xp + yp*yp + zp*zp</a>
<a name="metric_block_spatial_di138"></a>        <a href="metric_block_p.html#metric_blocki135" target="origFile">fact = <code class="funcname">SQRT</code>(arg1)</a>
        <a href="metric_block_p.html#metric_blocki136" target="origFile"><code class="keyword">IF</code> (fact .GT. zero) </a><a href="metric_block_p.html#metric_blocki137" target="origFile">fact = mult/fact</a>
<a name="metric_block_spatial_di139"></a><a href="metric_block_p.html#metric_blocki138" target="origFile"><code class="comment">! Compute the unit normal.</code></a>
<a name="metric_block_spatial_di140"></a>        <a href="metric_block_p.html#metric_blocki138" target="origFile">bcdata(mm)%norm(i, j, <code class="constant">1</code>) = fact*xp</a>
        <a href="metric_block_p.html#metric_blocki139" target="origFile">bcdata(mm)%norm(i, j, <code class="constant">2</code>) = fact*yp</a>
        <a href="metric_block_p.html#metric_blocki140" target="origFile">bcdata(mm)%norm(i, j, <code class="constant">3</code>) = fact*zp</a>
      <a href="metric_block_p.html#metric_blocki130" target="origFile"><code class="keyword">END DO</code></a>
    <a href="metric_block_p.html#metric_blocki129" target="origFile"><code class="keyword">END DO</code></a>
  <a href="metric_block_p.html#metric_blocki115" target="origFile"><code class="keyword">END DO </code><code class="label">bocoloop</code></a>
<a name="volpym_spatial_d"></a>
<a href="metric_block_p.html#metric_block" target="origFile"><code class="keyword">CONTAINS</code></a>
<a href="metric_block_p.html#volpym" target="origFile"><code class="comment">!  Differentiation of volpym in forward (tangent) mode:</code></a>
<a href="metric_block_p.html#volpym" target="origFile"><code class="comment">!   variations   of useful results: volpym</code></a>
<a href="metric_block_p.html#volpym" target="origFile"><code class="comment">!   with respect to varying inputs: xa xb xc xd ya yb yc yd za</code></a>
<a href="metric_block_p.html#volpym" target="origFile"><code class="comment">!                zb zc zd</code></a>
<a href="metric_block_p.html#volpym" target="origFile"><code class="comment">!        ================================================================</code></a>
  <a href="metric_block_p.html#volpym" target="origFile"><code class="keyword">FUNCTION </code><code class="funcname">VOLPYM_SPATIAL_D</code>(<code class="vardecl">xa</code>, <code class="vardecl">xad</code>, <code class="vardecl">ya</code>, <code class="vardecl">yad</code>, <code class="vardecl">za</code>, <code class="vardecl">zad</code>, <code class="vardecl">xb</code>, <code class="vardecl">xbd</code>, <code class="vardecl">yb</code>, <code class="vardecl">ybd</code><code class="label">&</code></a>
<a href="metric_block_p.html#volpym" target="origFile"><code class="label">&    </code>, <code class="vardecl">zb</code>, <code class="vardecl">zbd</code>, <code class="vardecl">xc</code>, <code class="vardecl">xcd</code>, <code class="vardecl">yc</code>, <code class="vardecl">ycd</code>, <code class="vardecl">zc</code>, <code class="vardecl">zcd</code>, <code class="vardecl">xd</code>, <code class="vardecl">xdd</code>, <code class="vardecl">yd</code>, <code class="vardecl">ydd</code>, <code class="vardecl">zd</code>, <code class="vardecl">zdd</code>, <code class="label">&</code></a>
<a href="metric_block_p.html#volpym" target="origFile"><code class="label">&    </code><code class="vardecl">volpym</code>)</a>
<a name="volpym_spatial_di0"></a>    <a href="metric_block_p.html#volpym" target="origFile"><code class="keyword">USE </code><code class="funcname">PRECISION_SPATIAL_D</code></a>
    <a href="metric_block_p.html#volpym" target="origFile"><code class="keyword">IMPLICIT NONE</code></a>
<a href="metric_block_p.html#volpymi0" target="origFile"><code class="comment">!</code></a>
<a href="metric_block_p.html#volpymi0" target="origFile"><code class="comment">!        ****************************************************************</code></a>
<a href="metric_block_p.html#volpymi0" target="origFile"><code class="comment">!        *                                                              *</code></a>
<a href="metric_block_p.html#volpymi0" target="origFile"><code class="comment">!        * volpym computes 6 times the volume of a pyramid. Node p,     *</code></a>
<a href="metric_block_p.html#volpymi0" target="origFile"><code class="comment">!        * whose coordinates are set in the subroutine metric itself,   *</code></a>
<a href="metric_block_p.html#volpymi0" target="origFile"><code class="comment">!        * is the top node and a-b-c-d is the quadrilateral surface.    *</code></a>
<a href="metric_block_p.html#volpymi0" target="origFile"><code class="comment">!        * It is assumed that the cross product vCa * vDb points in     *</code></a>
<a href="metric_block_p.html#volpymi0" target="origFile"><code class="comment">!        * the direction of the top node. Here vCa is the diagonal      *</code></a>
<a href="metric_block_p.html#volpymi0" target="origFile"><code class="comment">!        * running from node c to node a and vDb the diagonal from      *</code></a>
<a href="metric_block_p.html#volpymi0" target="origFile"><code class="comment">!        * node d to node b.                                            *</code></a>
<a href="metric_block_p.html#volpymi0" target="origFile"><code class="comment">!        *                                                              *</code></a>
<a href="metric_block_p.html#volpymi0" target="origFile"><code class="comment">!        ****************************************************************</code></a>
<a href="metric_block_p.html#volpymi0" target="origFile"><code class="comment">!</code></a>
<a href="metric_block_p.html#volpymi0" target="origFile"><code class="comment">!</code></a>
<a href="metric_block_p.html#volpymi0" target="origFile"><code class="comment">!        Function type.</code></a>
<a href="metric_block_p.html#volpymi0" target="origFile"><code class="comment">!</code></a>
<a name="volpym_spatial_di1"></a>    <a href="metric_block_p.html#volpymi0" target="origFile"><code class="typename">REAL(</code><code class="keyword">kind</code>=<code class="modifier">realtype</code><code class="typename">) </code>:: <code class="vardecl">volpym</code></a>
    <a href="metric_block_p.html#volpym" target="origFile"><code class="typename">REAL(</code><code class="keyword">kind</code>=<code class="modifier">realtype</code><code class="typename">) </code>:: <code class="vardecl">volpym_spatial_d</code></a>
<a href="metric_block_p.html#volpymi1" target="origFile"><code class="comment">!</code></a>
<a href="metric_block_p.html#volpymi1" target="origFile"><code class="comment">!        Function arguments.</code></a>
<a href="metric_block_p.html#volpymi1" target="origFile"><code class="comment">!</code></a>
<a name="volpym_spatial_di2"></a>    <a href="metric_block_p.html#volpymi1" target="origFile"><code class="typename">REAL(</code><code class="keyword">kind</code>=<code class="modifier">realtype</code><code class="typename">)</code>, <code class="typename">INTENT(IN) </code>:: <code class="vardecl">xa</code>, <code class="vardecl">ya</code>, <code class="vardecl">za</code>, <code class="vardecl">xb</code>, <code class="vardecl">yb</code>, <code class="vardecl">zb</code></a>
    <a href="metric_block_p.html#volpym" target="origFile"><code class="typename">REAL(</code><code class="keyword">kind</code>=<code class="modifier">realtype</code><code class="typename">)</code>, <code class="typename">INTENT(IN) </code>:: <code class="vardecl">xad</code>, <code class="vardecl">yad</code>, <code class="vardecl">zad</code>, <code class="vardecl">xbd</code>, <code class="vardecl">ybd</code>, <code class="vardecl">zbd</code></a>
<a name="volpym_spatial_di3"></a>    <a href="metric_block_p.html#volpymi2" target="origFile"><code class="typename">REAL(</code><code class="keyword">kind</code>=<code class="modifier">realtype</code><code class="typename">)</code>, <code class="typename">INTENT(IN) </code>:: <code class="vardecl">xc</code>, <code class="vardecl">yc</code>, <code class="vardecl">zc</code>, <code class="vardecl">xd</code>, <code class="vardecl">yd</code>, <code class="vardecl">zd</code></a>
    <a href="metric_block_p.html#volpym" target="origFile"><code class="typename">REAL(</code><code class="keyword">kind</code>=<code class="modifier">realtype</code><code class="typename">)</code>, <code class="typename">INTENT(IN) </code>:: <code class="vardecl">xcd</code>, <code class="vardecl">ycd</code>, <code class="vardecl">zcd</code>, <code class="vardecl">xdd</code>, <code class="vardecl">ydd</code>, <code class="vardecl">zdd</code></a>
<a href="metric_block_p.html#volpymi3" target="origFile"><code class="comment">!</code></a>
<a href="metric_block_p.html#volpymi3" target="origFile"><code class="comment">!        ****************************************************************</code></a>
<a href="metric_block_p.html#volpymi3" target="origFile"><code class="comment">!        *                                                              *</code></a>
<a href="metric_block_p.html#volpymi3" target="origFile"><code class="comment">!        * Begin execution                                              *</code></a>
<a href="metric_block_p.html#volpymi3" target="origFile"><code class="comment">!        *                                                              *</code></a>
<a href="metric_block_p.html#volpymi3" target="origFile"><code class="comment">!        ****************************************************************</code></a>
<a href="metric_block_p.html#volpymi3" target="origFile"><code class="comment">!</code></a>
    <a href="metric_block_p.html#volpymi3" target="origFile">volpym_spatial_d = (xp-fourth*(xa+xb+xc+xd))*((yad-ycd)*(zb-zd)+(ya-<code class="label">&</code></a>
<a href="metric_block_p.html#volpymi3" target="origFile"><code class="label">&      </code>yc)*(zbd-zdd)-(zad-zcd)*(yb-yd)-(za-zc)*(ybd-ydd)) - fourth*(xad+<code class="label">&</code></a>
<a href="metric_block_p.html#volpymi3" target="origFile"><code class="label">&      </code>xbd+xcd+xdd)*((ya-yc)*(zb-zd)-(za-zc)*(yb-yd)) + (yp-fourth*(ya+yb<code class="label">&</code></a>
<a href="metric_block_p.html#volpymi3" target="origFile"><code class="label">&      </code>+yc+yd))*((zad-zcd)*(xb-xd)+(za-zc)*(xbd-xdd)-(xad-xcd)*(zb-zd)-(<code class="label">&</code></a>
<a href="metric_block_p.html#volpymi3" target="origFile"><code class="label">&      </code>xa-xc)*(zbd-zdd)) - fourth*(yad+ybd+ycd+ydd)*((za-zc)*(xb-xd)-(xa-<code class="label">&</code></a>
<a href="metric_block_p.html#volpymi3" target="origFile"><code class="label">&      </code>xc)*(zb-zd)) + (zp-fourth*(za+zb+zc+zd))*((xad-xcd)*(yb-yd)+(xa-xc<code class="label">&</code></a>
<a href="metric_block_p.html#volpymi3" target="origFile"><code class="label">&      </code>)*(ybd-ydd)-(yad-ycd)*(xb-xd)-(ya-yc)*(xbd-xdd)) - fourth*(zad+zbd<code class="label">&</code></a>
<a href="metric_block_p.html#volpymi3" target="origFile"><code class="label">&      </code>+zcd+zdd)*((xa-xc)*(yb-yd)-(ya-yc)*(xb-xd))</a>
    <a href="metric_block_p.html#volpymi3" target="origFile">volpym = (xp-fourth*(xa+xb+xc+xd))*((ya-yc)*(zb-zd)-(za-zc)*(yb-yd))<code class="label">&</code></a>
<a href="metric_block_p.html#volpymi3" target="origFile"><code class="label">&      </code>+ (yp-fourth*(ya+yb+yc+yd))*((za-zc)*(xb-xd)-(xa-xc)*(zb-zd)) + (<code class="label">&</code></a>
<a name="volpym"></a><a href="metric_block_p.html#volpymi3" target="origFile"><code class="label">&      </code>zp-fourth*(za+zb+zc+zd))*((xa-xc)*(yb-yd)-(ya-yc)*(xb-xd))</a>
  <a href="metric_block_p.html#volpym" target="origFile"><code class="keyword">END FUNCTION </code><code class="funcname">VOLPYM_SPATIAL_D</code></a>
<a href="metric_block_p.html#volpym" target="origFile"><code class="comment">!        ================================================================</code></a>
  <a href="metric_block_p.html#volpym" target="origFile"><code class="keyword">FUNCTION </code><code class="funcname">VOLPYM</code>(<code class="vardecl">xa</code>, <code class="vardecl">ya</code>, <code class="vardecl">za</code>, <code class="vardecl">xb</code>, <code class="vardecl">yb</code>, <code class="vardecl">zb</code>, <code class="vardecl">xc</code>, <code class="vardecl">yc</code>, <code class="vardecl">zc</code>, <code class="vardecl">xd</code>, <code class="vardecl">yd</code>, <code class="vardecl">zd</code>)</a>
    <a href="metric_block_p.html#volpym" target="origFile"><code class="keyword">USE </code><code class="funcname">PRECISION_SPATIAL_D</code></a>
    <a href="metric_block_p.html#volpym" target="origFile"><code class="keyword">IMPLICIT NONE</code></a>
<a href="metric_block_p.html#volpym" target="origFile"><code class="comment">!</code></a>
<a href="metric_block_p.html#volpym" target="origFile"><code class="comment">!        ****************************************************************</code></a>
<a href="metric_block_p.html#volpym" target="origFile"><code class="comment">!        *                                                              *</code></a>
<a href="metric_block_p.html#volpym" target="origFile"><code class="comment">!        * volpym computes 6 times the volume of a pyramid. Node p,     *</code></a>
<a href="metric_block_p.html#volpym" target="origFile"><code class="comment">!        * whose coordinates are set in the subroutine metric itself,   *</code></a>
<a href="metric_block_p.html#volpym" target="origFile"><code class="comment">!        * is the top node and a-b-c-d is the quadrilateral surface.    *</code></a>
<a href="metric_block_p.html#volpym" target="origFile"><code class="comment">!        * It is assumed that the cross product vCa * vDb points in     *</code></a>
<a href="metric_block_p.html#volpym" target="origFile"><code class="comment">!        * the direction of the top node. Here vCa is the diagonal      *</code></a>
<a href="metric_block_p.html#volpym" target="origFile"><code class="comment">!        * running from node c to node a and vDb the diagonal from      *</code></a>
<a href="metric_block_p.html#volpym" target="origFile"><code class="comment">!        * node d to node b.                                            *</code></a>
<a href="metric_block_p.html#volpym" target="origFile"><code class="comment">!        *                                                              *</code></a>
<a href="metric_block_p.html#volpym" target="origFile"><code class="comment">!        ****************************************************************</code></a>
<a href="metric_block_p.html#volpym" target="origFile"><code class="comment">!</code></a>
<a href="metric_block_p.html#volpym" target="origFile"><code class="comment">!</code></a>
<a href="metric_block_p.html#volpym" target="origFile"><code class="comment">!        Function type.</code></a>
<a href="metric_block_p.html#volpym" target="origFile"><code class="comment">!</code></a>
    <a href="metric_block_p.html#volpym" target="origFile"><code class="typename">REAL(</code><code class="keyword">kind</code>=<code class="modifier">realtype</code><code class="typename">) </code>:: <code class="vardecl">volpym</code></a>
<a href="metric_block_p.html#volpym" target="origFile"><code class="comment">!</code></a>
<a href="metric_block_p.html#volpym" target="origFile"><code class="comment">!        Function arguments.</code></a>
<a href="metric_block_p.html#volpym" target="origFile"><code class="comment">!</code></a>
    <a href="metric_block_p.html#volpym" target="origFile"><code class="typename">REAL(</code><code class="keyword">kind</code>=<code class="modifier">realtype</code><code class="typename">)</code>, <code class="typename">INTENT(IN) </code>:: <code class="vardecl">xa</code>, <code class="vardecl">ya</code>, <code class="vardecl">za</code>, <code class="vardecl">xb</code>, <code class="vardecl">yb</code>, <code class="vardecl">zb</code></a>
    <a href="metric_block_p.html#volpym" target="origFile"><code class="typename">REAL(</code><code class="keyword">kind</code>=<code class="modifier">realtype</code><code class="typename">)</code>, <code class="typename">INTENT(IN) </code>:: <code class="vardecl">xc</code>, <code class="vardecl">yc</code>, <code class="vardecl">zc</code>, <code class="vardecl">xd</code>, <code class="vardecl">yd</code>, <code class="vardecl">zd</code></a>
<a href="metric_block_p.html#volpym" target="origFile"><code class="comment">!</code></a>
<a href="metric_block_p.html#volpym" target="origFile"><code class="comment">!        ****************************************************************</code></a>
<a href="metric_block_p.html#volpym" target="origFile"><code class="comment">!        *                                                              *</code></a>
<a href="metric_block_p.html#volpym" target="origFile"><code class="comment">!        * Begin execution                                              *</code></a>
<a href="metric_block_p.html#volpym" target="origFile"><code class="comment">!        *                                                              *</code></a>
<a href="metric_block_p.html#volpym" target="origFile"><code class="comment">!        ****************************************************************</code></a>
<a href="metric_block_p.html#volpym" target="origFile"><code class="comment">!</code></a>
    <a href="metric_block_p.html#volpym" target="origFile">volpym = (xp-fourth*(xa+xb+xc+xd))*((ya-yc)*(zb-zd)-(za-zc)*(yb-yd))<code class="label">&</code></a>
<a href="metric_block_p.html#volpym" target="origFile"><code class="label">&      </code>+ (yp-fourth*(ya+yb+yc+yd))*((za-zc)*(xb-xd)-(xa-xc)*(zb-zd)) + (<code class="label">&</code></a>
<a href="metric_block_p.html#volpym" target="origFile"><code class="label">&      </code>zp-fourth*(za+zb+zc+zd))*((xa-xc)*(yb-yd)-(ya-yc)*(xb-xd))</a>
  <a href="metric_block_p.html#volpym" target="origFile"><code class="keyword">END FUNCTION </code><code class="funcname">VOLPYM</code></a>
<a href="metric_block_p.html#metric_block" target="origFile"><code class="keyword">END SUBROUTINE </code><code class="funcname">METRIC_BLOCK_SPATIAL_D</code></a>
</pre>
</body>
