<title>Generated by TAPENADE</title>
<link type="text/CSS" rel="stylesheet" href="tapenade.css">
<link type="text/CSS" rel="stylesheet" href="fortranStyle.css">
<body>
<pre><a name="metric_block_cd"></a><a href="metric_block_p.html#metric_block" target="origFile"><code class="comment">!        Generated by TAPENADE     (INRIA, Tropics team)</code></a>
<a href="metric_block_p.html#metric_block" target="origFile"><code class="comment">!  Tapenade 3.4 (r3375) - 10 Feb 2010 15:08</code></a>
<a href="metric_block_p.html#metric_block" target="origFile"><code class="comment">!</code></a>
<a href="metric_block_p.html#metric_block" target="origFile"><code class="keyword">SUBROUTINE </code><code class="funcname">METRIC_BLOCK_CD</code>(<code class="vardecl">nn</code>, <code class="vardecl">level</code>, <code class="vardecl">sps</code>)</a>
  <a href="metric_block_p.html#metric_block" target="origFile"><code class="keyword">USE </code><code class="funcname">BCTYPES_SPATIAL_D</code></a>
  <a href="metric_block_p.html#metric_block" target="origFile"><code class="keyword">USE </code><code class="funcname">CGNSGRID_SPATIAL_D</code></a>
  <a href="metric_block_p.html#metric_block" target="origFile"><code class="keyword">USE </code><code class="funcname">COMMUNICATION_SPATIAL_D</code></a>
  <a href="metric_block_p.html#metric_block" target="origFile"><code class="keyword">USE </code><code class="funcname">INPUTTIMESPECTRAL_SPATIAL_D</code></a>
  <a href="metric_block_p.html#metric_block" target="origFile"><code class="keyword">USE </code><code class="funcname">BLOCKPOINTERS_SPATIAL_D</code></a>
  <a href="metric_block_p.html#metric_block" target="origFile"><code class="keyword">IMPLICIT NONE</code></a>
<a href="metric_block_p.html#metric_block" target="origFile"><code class="comment">!</code></a>
<a href="metric_block_p.html#metric_block" target="origFile"><code class="comment">!      ******************************************************************</code></a>
<a href="metric_block_p.html#metric_block" target="origFile"><code class="comment">!      *                                                                *</code></a>
<a href="metric_block_p.html#metric_block" target="origFile"><code class="comment">!      * metric computes the face normals and the volume for the given  *</code></a>
<a href="metric_block_p.html#metric_block" target="origFile"><code class="comment">!      * grid level for all spectral solutions. First the volumes are   *</code></a>
<a href="metric_block_p.html#metric_block" target="origFile"><code class="comment">!      * computed assuming that the block is right handed. Then the     *</code></a>
<a href="metric_block_p.html#metric_block" target="origFile"><code class="comment">!      * number of positive and negative volumes are determined. If all *</code></a>
<a href="metric_block_p.html#metric_block" target="origFile"><code class="comment">!      * volumes are positive the block is indeed right handed; if all  *</code></a>
<a href="metric_block_p.html#metric_block" target="origFile"><code class="comment">!      * volumes are negative the block is left handed and both the     *</code></a>
<a href="metric_block_p.html#metric_block" target="origFile"><code class="comment">!      * volumes and the normals must be negated (for the normals this  *</code></a>
<a href="metric_block_p.html#metric_block" target="origFile"><code class="comment">!      * is done by the introduction of fact, which is either -0.5 or   *</code></a>
<a href="metric_block_p.html#metric_block" target="origFile"><code class="comment">!      * 0.5); if there are both positive and negative volumes the mesh *</code></a>
<a href="metric_block_p.html#metric_block" target="origFile"><code class="comment">!      * is not valid.                                                  *</code></a>
<a href="metric_block_p.html#metric_block" target="origFile"><code class="comment">!      *                                                                *</code></a>
<a href="metric_block_p.html#metric_block" target="origFile"><code class="comment">!      ******************************************************************</code></a>
<a href="metric_block_p.html#metric_block" target="origFile"><code class="comment">!</code></a>
<a href="metric_block_p.html#metric_block" target="origFile"><code class="comment">!</code></a>
<a href="metric_block_p.html#metric_block" target="origFile"><code class="comment">!      Subroutine arguments.</code></a>
<a href="metric_block_p.html#metric_block" target="origFile"><code class="comment">!</code></a>
  <a href="metric_block_p.html#metric_block" target="origFile"><code class="typename">INTEGER(</code><code class="keyword">kind</code>=<code class="modifier">inttype</code><code class="typename">)</code>, <code class="typename">INTENT(IN) </code>:: <code class="vardecl">level</code></a>
<a href="metric_block_p.html#metric_block" target="origFile"><code class="comment">!</code></a>
<a href="metric_block_p.html#metric_block" target="origFile"><code class="comment">!      Local parameter.</code></a>
<a href="metric_block_p.html#metric_block" target="origFile"><code class="comment">!</code></a>
  <a href="metric_block_p.html#metric_block" target="origFile"><code class="typename">REAL(</code><code class="keyword">kind</code>=<code class="modifier">realtype</code><code class="typename">)</code>, <code class="typename">PARAMETER </code>:: <code class="vardecl">thresvolume</code>=<code class="constant">1.e-2_realType</code></a>
<a href="metric_block_p.html#metric_block" target="origFile"><code class="comment">!</code></a>
<a href="metric_block_p.html#metric_block" target="origFile"><code class="comment">!      Local variables.</code></a>
<a href="metric_block_p.html#metric_block" target="origFile"><code class="comment">!</code></a>
  <a href="metric_block_p.html#metric_block" target="origFile"><code class="typename">INTEGER </code>:: <code class="vardecl">ierr</code></a>
  <a href="metric_block_p.html#metric_block" target="origFile"><code class="typename">INTEGER(</code><code class="keyword">kind</code>=<code class="modifier">inttype</code><code class="typename">) </code>:: <code class="vardecl">i</code>, <code class="vardecl">j</code>, <code class="vardecl">k</code>, <code class="vardecl">n</code>, <code class="vardecl">m</code>, <code class="vardecl">l</code></a>
  <a href="metric_block_p.html#metric_block" target="origFile"><code class="typename">INTEGER(</code><code class="keyword">kind</code>=<code class="modifier">inttype</code><code class="typename">) </code>:: <code class="vardecl">nn</code>, <code class="vardecl">mm</code>, <code class="vardecl">sps</code></a>
  <a href="metric_block_p.html#metric_block" target="origFile"><code class="typename">INTEGER(</code><code class="keyword">kind</code>=<code class="modifier">inttype</code><code class="typename">) </code>:: <code class="vardecl">nvolneg</code>, <code class="vardecl">nvolpos</code></a>
  <a href="metric_block_p.html#metric_block" target="origFile"><code class="typename">INTEGER(</code><code class="keyword">kind</code>=<code class="modifier">inttype</code><code class="typename">) </code>:: <code class="vardecl">nvolbad</code>, <code class="vardecl">nvolbadglobal</code></a>
  <a href="metric_block_p.html#metric_block" target="origFile"><code class="typename">INTEGER(</code><code class="keyword">kind</code>=<code class="modifier">inttype</code><code class="typename">) </code>:: <code class="vardecl">nblockbad</code>, <code class="vardecl">nblockbadglobal</code></a>
  <a href="metric_block_p.html#metric_block" target="origFile"><code class="typename">REAL(</code><code class="keyword">kind</code>=<code class="modifier">realtype</code><code class="typename">) </code>:: <code class="vardecl">fact</code>, <code class="vardecl">mult</code></a>
  <a href="metric_block_p.html#metric_block" target="origFile"><code class="typename">REAL(</code><code class="keyword">kind</code>=<code class="modifier">realtype</code><code class="typename">) </code>:: <code class="vardecl">xp</code>, <code class="vardecl">yp</code>, <code class="vardecl">zp</code>, <code class="vardecl">vp1</code>, <code class="vardecl">vp2</code>, <code class="vardecl">vp3</code>, <code class="vardecl">vp4</code>, <code class="vardecl">vp5</code>, <code class="vardecl">vp6</code></a>
  <a href="metric_block_p.html#metric_block" target="origFile"><code class="typename">REAL(</code><code class="keyword">kind</code>=<code class="modifier">realtype</code><code class="typename">)</code>, <code class="typename">DIMENSION(</code><code class="constant">3</code><code class="typename">) </code>:: <code class="vardecl">v1</code>, <code class="vardecl">v2</code></a>
  <a href="metric_block_p.html#metric_block" target="origFile"><code class="typename">REAL(</code><code class="keyword">kind</code>=<code class="modifier">realtype</code><code class="typename">)</code>, <code class="typename">DIMENSION(</code>:, :, :<code class="typename">)</code>, <code class="typename">POINTER </code>:: <code class="vardecl">ss</code></a>
  <a href="metric_block_p.html#metric_block" target="origFile"><code class="typename">CHARACTER</code>(<code class="keyword">len</code>=<code class="constant">10</code>) :: <code class="vardecl">integerstring</code></a>
  <a href="metric_block_p.html#metric_block" target="origFile"><code class="typename">LOGICAL </code>:: <code class="vardecl">checkk</code>, <code class="vardecl">checkj</code>, <code class="vardecl">checki</code>, <code class="vardecl">checkall</code></a>
  <a href="metric_block_p.html#metric_block" target="origFile"><code class="typename">LOGICAL </code>:: <code class="vardecl">badvolume</code></a>
  <a href="metric_block_p.html#metric_block" target="origFile"><code class="typename">REAL(</code><code class="keyword">kind</code>=<code class="modifier">realtype</code><code class="typename">) </code>:: <code class="funcname">VOLPYM</code></a>
  <a href="metric_block_p.html#metric_block" target="origFile"><code class="keyword">EXTERNAL </code><code class="funcname">FLOWDOMS</code></a>
  <a href="metric_block_p.html#metric_block" target="origFile"><code class="keyword">TYPE(</code><code class="typename">#UNKNOWNDERIVEDTYPE0#</code><code class="keyword">) </code>:: <code class="vardecl">result1</code></a>
  <a href="metric_block_p.html#metric_block" target="origFile"><code class="typename">REAL(</code><code class="keyword">kind</code>=<code class="modifier">realtype</code><code class="typename">) </code>:: <code class="vardecl">arg1</code></a>
  <a href="metric_block_p.html#metric_block" target="origFile"><code class="keyword">TYPE(</code><code class="typename">UNKNOWNDERIVEDTYPE0</code><code class="keyword">) </code>:: <code class="funcname">FLOWDOMS</code></a>
  <a href="metric_block_p.html#metric_block" target="origFile"><code class="keyword">INTRINSIC </code><code class="funcname">ABS</code></a>
  <a href="metric_block_p.html#metric_block" target="origFile"><code class="keyword">INTRINSIC </code><code class="funcname">SQRT</code></a>
<a href="metric_block_p.html#metric_block" target="origFile"><code class="comment">!</code></a>
<a href="metric_block_p.html#metric_block" target="origFile"><code class="comment">!      ******************************************************************</code></a>
<a href="metric_block_p.html#metric_block" target="origFile"><code class="comment">!      *                                                                *</code></a>
<a href="metric_block_p.html#metric_block" target="origFile"><code class="comment">!      * Begin execution                                                *</code></a>
<a href="metric_block_p.html#metric_block" target="origFile"><code class="comment">!      *                                                                *</code></a>
<a href="metric_block_p.html#metric_block" target="origFile"><code class="comment">!      ******************************************************************</code></a>
<a href="metric_block_p.html#metric_block" target="origFile"><code class="comment">!</code></a>
<a href="metric_block_p.html#metric_block" target="origFile"><code class="comment">! Compute the volumes. The hexahedron is split into 6 pyramids</code></a>
<a href="metric_block_p.html#metric_block" target="origFile"><code class="comment">! whose volumes are computed. The volume is positive for a</code></a>
<a href="metric_block_p.html#metric_block" target="origFile"><code class="comment">! right handed block.</code></a>
<a href="metric_block_p.html#metric_block" target="origFile"><code class="comment">! Initialize the volumes to zero. The reasons is that the second</code></a>
<a href="metric_block_p.html#metric_block" target="origFile"><code class="comment">! level halo's must be initialized to zero and for convenience</code></a>
<a href="metric_block_p.html#metric_block" target="origFile"><code class="comment">! all the volumes are set to zero.</code></a>
  <a href="metric_block_p.html#metric_block" target="origFile">vol = zero</a>
  <a href="metric_block_p.html#metric_block" target="origFile"><code class="keyword">DO </code>k=<code class="constant">1</code>,ke</a>
    <a href="metric_block_p.html#metric_block" target="origFile">n = k - <code class="constant">1</code></a>
    <a href="metric_block_p.html#metric_block" target="origFile">checkk = <code class="constant">.true.</code></a>
    <a href="metric_block_p.html#metric_block" target="origFile"><code class="keyword">IF</code> (k .EQ. <code class="constant">1 </code>.OR. k .EQ. ke) checkk = <code class="constant">.false.</code></a>
    <a href="metric_block_p.html#metric_block" target="origFile"><code class="keyword">DO </code>j=<code class="constant">1</code>,je</a>
      <a href="metric_block_p.html#metric_block" target="origFile">m = j - <code class="constant">1</code></a>
      <a href="metric_block_p.html#metric_block" target="origFile">checkj = <code class="constant">.true.</code></a>
      <a href="metric_block_p.html#metric_block" target="origFile"><code class="keyword">IF</code> (j .EQ. <code class="constant">1 </code>.OR. j .EQ. je) checkj = <code class="constant">.false.</code></a>
      <a href="metric_block_p.html#metric_block" target="origFile"><code class="keyword">DO </code>i=<code class="constant">1</code>,ie</a>
        <a href="metric_block_p.html#metric_block" target="origFile">l = i - <code class="constant">1</code></a>
        <a href="metric_block_p.html#metric_block" target="origFile">checki = <code class="constant">.true.</code></a>
        <a href="metric_block_p.html#metric_block" target="origFile"><code class="keyword">IF</code> (i .EQ. <code class="constant">1 </code>.OR. i .EQ. ie) checki = <code class="constant">.false.</code></a>
<a href="metric_block_p.html#metric_block" target="origFile"><code class="comment">! Determine whether or not the voluem must be checked for</code></a>
<a href="metric_block_p.html#metric_block" target="origFile"><code class="comment">! quality. Only owned volumes are checked, not halo's.</code></a>
        <a href="metric_block_p.html#metric_block" target="origFile">checkall = <code class="constant">.false.</code></a>
        <a href="metric_block_p.html#metric_block" target="origFile"><code class="keyword">IF</code> (checkk .AND. checkj .AND. checki) checkall = <code class="constant">.true.</code></a>
<a href="metric_block_p.html#metric_block" target="origFile"><code class="comment">! Compute the coordinates of the center of gravity.</code></a>
        <a href="metric_block_p.html#metric_block" target="origFile">xp = eighth*(x(i, j, k, <code class="constant">1</code>)+x(i, m, k, <code class="constant">1</code>)+x(i, m, n, <code class="constant">1</code>)+x(i, j, n<code class="label">&</code></a>
<a href="metric_block_p.html#metric_block" target="origFile"><code class="label">&          </code>, <code class="constant">1</code>)+x(l, j, k, <code class="constant">1</code>)+x(l, m, k, <code class="constant">1</code>)+x(l, m, n, <code class="constant">1</code>)+x(l, j, n, <code class="constant">1</code>))</a>
        <a href="metric_block_p.html#metric_block" target="origFile">yp = eighth*(x(i, j, k, <code class="constant">2</code>)+x(i, m, k, <code class="constant">2</code>)+x(i, m, n, <code class="constant">2</code>)+x(i, j, n<code class="label">&</code></a>
<a href="metric_block_p.html#metric_block" target="origFile"><code class="label">&          </code>, <code class="constant">2</code>)+x(l, j, k, <code class="constant">2</code>)+x(l, m, k, <code class="constant">2</code>)+x(l, m, n, <code class="constant">2</code>)+x(l, j, n, <code class="constant">2</code>))</a>
        <a href="metric_block_p.html#metric_block" target="origFile">zp = eighth*(x(i, j, k, <code class="constant">3</code>)+x(i, m, k, <code class="constant">3</code>)+x(i, m, n, <code class="constant">3</code>)+x(i, j, n<code class="label">&</code></a>
<a href="metric_block_p.html#metric_block" target="origFile"><code class="label">&          </code>, <code class="constant">3</code>)+x(l, j, k, <code class="constant">3</code>)+x(l, m, k, <code class="constant">3</code>)+x(l, m, n, <code class="constant">3</code>)+x(l, j, n, <code class="constant">3</code>))</a>
<a href="metric_block_p.html#metric_block" target="origFile"><code class="comment">! Compute the volumes of the 6 sub pyramids. The</code></a>
<a href="metric_block_p.html#metric_block" target="origFile"><code class="comment">! arguments of volpym must be such that for a (regular)</code></a>
<a href="metric_block_p.html#metric_block" target="origFile"><code class="comment">! right handed hexahedron all volumes are positive.</code></a>
        <a href="metric_block_p.html#metric_block" target="origFile">vp1 = <code class="funcname">VOLPYM</code>(x(i, j, k, <code class="constant">1</code>), x(i, j, k, <code class="constant">2</code>), x(i, j, k, <code class="constant">3</code>), x(i, j<code class="label">&</code></a>
<a href="metric_block_p.html#metric_block" target="origFile"><code class="label">&          </code>, n, <code class="constant">1</code>), x(i, j, n, <code class="constant">2</code>), x(i, j, n, <code class="constant">3</code>), x(i, m, n, <code class="constant">1</code>), x(i, m, <code class="label">&</code></a>
<a href="metric_block_p.html#metric_block" target="origFile"><code class="label">&          </code>n, <code class="constant">2</code>), x(i, m, n, <code class="constant">3</code>), x(i, m, k, <code class="constant">1</code>), x(i, m, k, <code class="constant">2</code>), x(i, m, k<code class="label">&</code></a>
<a href="metric_block_p.html#metric_block" target="origFile"><code class="label">&          </code>, <code class="constant">3</code>))</a>
        <a href="metric_block_p.html#metric_block" target="origFile">vp2 = <code class="funcname">VOLPYM</code>(x(l, j, k, <code class="constant">1</code>), x(l, j, k, <code class="constant">2</code>), x(l, j, k, <code class="constant">3</code>), x(l, m<code class="label">&</code></a>
<a href="metric_block_p.html#metric_block" target="origFile"><code class="label">&          </code>, k, <code class="constant">1</code>), x(l, m, k, <code class="constant">2</code>), x(l, m, k, <code class="constant">3</code>), x(l, m, n, <code class="constant">1</code>), x(l, m, <code class="label">&</code></a>
<a href="metric_block_p.html#metric_block" target="origFile"><code class="label">&          </code>n, <code class="constant">2</code>), x(l, m, n, <code class="constant">3</code>), x(l, j, n, <code class="constant">1</code>), x(l, j, n, <code class="constant">2</code>), x(l, j, n<code class="label">&</code></a>
<a href="metric_block_p.html#metric_block" target="origFile"><code class="label">&          </code>, <code class="constant">3</code>))</a>
        <a href="metric_block_p.html#metric_block" target="origFile">vp3 = <code class="funcname">VOLPYM</code>(x(i, j, k, <code class="constant">1</code>), x(i, j, k, <code class="constant">2</code>), x(i, j, k, <code class="constant">3</code>), x(l, j<code class="label">&</code></a>
<a href="metric_block_p.html#metric_block" target="origFile"><code class="label">&          </code>, k, <code class="constant">1</code>), x(l, j, k, <code class="constant">2</code>), x(l, j, k, <code class="constant">3</code>), x(l, j, n, <code class="constant">1</code>), x(l, j, <code class="label">&</code></a>
<a href="metric_block_p.html#metric_block" target="origFile"><code class="label">&          </code>n, <code class="constant">2</code>), x(l, j, n, <code class="constant">3</code>), x(i, j, n, <code class="constant">1</code>), x(i, j, n, <code class="constant">2</code>), x(i, j, n<code class="label">&</code></a>
<a href="metric_block_p.html#metric_block" target="origFile"><code class="label">&          </code>, <code class="constant">3</code>))</a>
        <a href="metric_block_p.html#metric_block" target="origFile">vp4 = <code class="funcname">VOLPYM</code>(x(i, m, k, <code class="constant">1</code>), x(i, m, k, <code class="constant">2</code>), x(i, m, k, <code class="constant">3</code>), x(i, m<code class="label">&</code></a>
<a href="metric_block_p.html#metric_block" target="origFile"><code class="label">&          </code>, n, <code class="constant">1</code>), x(i, m, n, <code class="constant">2</code>), x(i, m, n, <code class="constant">3</code>), x(l, m, n, <code class="constant">1</code>), x(l, m, <code class="label">&</code></a>
<a href="metric_block_p.html#metric_block" target="origFile"><code class="label">&          </code>n, <code class="constant">2</code>), x(l, m, n, <code class="constant">3</code>), x(l, m, k, <code class="constant">1</code>), x(l, m, k, <code class="constant">2</code>), x(l, m, k<code class="label">&</code></a>
<a href="metric_block_p.html#metric_block" target="origFile"><code class="label">&          </code>, <code class="constant">3</code>))</a>
        <a href="metric_block_p.html#metric_block" target="origFile">vp5 = <code class="funcname">VOLPYM</code>(x(i, j, k, <code class="constant">1</code>), x(i, j, k, <code class="constant">2</code>), x(i, j, k, <code class="constant">3</code>), x(i, m<code class="label">&</code></a>
<a href="metric_block_p.html#metric_block" target="origFile"><code class="label">&          </code>, k, <code class="constant">1</code>), x(i, m, k, <code class="constant">2</code>), x(i, m, k, <code class="constant">3</code>), x(l, m, k, <code class="constant">1</code>), x(l, m, <code class="label">&</code></a>
<a href="metric_block_p.html#metric_block" target="origFile"><code class="label">&          </code>k, <code class="constant">2</code>), x(l, m, k, <code class="constant">3</code>), x(l, j, k, <code class="constant">1</code>), x(l, j, k, <code class="constant">2</code>), x(l, j, k<code class="label">&</code></a>
<a href="metric_block_p.html#metric_block" target="origFile"><code class="label">&          </code>, <code class="constant">3</code>))</a>
        <a href="metric_block_p.html#metric_block" target="origFile">vp6 = <code class="funcname">VOLPYM</code>(x(i, j, n, <code class="constant">1</code>), x(i, j, n, <code class="constant">2</code>), x(i, j, n, <code class="constant">3</code>), x(l, j<code class="label">&</code></a>
<a href="metric_block_p.html#metric_block" target="origFile"><code class="label">&          </code>, n, <code class="constant">1</code>), x(l, j, n, <code class="constant">2</code>), x(l, j, n, <code class="constant">3</code>), x(l, m, n, <code class="constant">1</code>), x(l, m, <code class="label">&</code></a>
<a href="metric_block_p.html#metric_block" target="origFile"><code class="label">&          </code>n, <code class="constant">2</code>), x(l, m, n, <code class="constant">3</code>), x(i, m, n, <code class="constant">1</code>), x(i, m, n, <code class="constant">2</code>), x(i, m, n<code class="label">&</code></a>
<a href="metric_block_p.html#metric_block" target="origFile"><code class="label">&          </code>, <code class="constant">3</code>))</a>
<a href="metric_block_p.html#metric_block" target="origFile"><code class="comment">! Set the volume to 1/6 of the sum of the volumes of the</code></a>
<a href="metric_block_p.html#metric_block" target="origFile"><code class="comment">! pyramid. Remember that volpym computes 6 times the</code></a>
<a href="metric_block_p.html#metric_block" target="origFile"><code class="comment">! volume.</code></a>
        <a href="metric_block_p.html#metric_block" target="origFile">vol(i, j, k) = sixth*(vp1+vp2+vp3+vp4+vp5+vp6)</a>
        <a href="metric_block_p.html#metric_block" target="origFile"><code class="keyword">IF</code> (vol(i, j, k) .GE. <code class="constant">0.</code>) <code class="keyword">THEN</code></a>
          <a href="metric_block_p.html#metric_block" target="origFile">vol(i, j, k) = vol(i, j, k)</a>
        <a href="metric_block_p.html#metric_block" target="origFile"><code class="keyword">ELSE</code></a>
          <a href="metric_block_p.html#metric_block" target="origFile">vol(i, j, k) = -vol(i, j, k)</a>
        <a href="metric_block_p.html#metric_block" target="origFile"><code class="keyword">END IF</code></a>
      <a href="metric_block_p.html#metric_block" target="origFile"><code class="keyword">END DO</code></a>
    <a href="metric_block_p.html#metric_block" target="origFile"><code class="keyword">END DO</code></a>
  <a href="metric_block_p.html#metric_block" target="origFile"><code class="keyword">END DO</code></a>
<a href="metric_block_p.html#metric_block" target="origFile"><code class="comment">! Some additional safety stuff for halo volumes.</code></a>
  <a href="metric_block_p.html#metric_block" target="origFile"><code class="keyword">DO </code>k=<code class="constant">2</code>,kl</a>
    <a href="metric_block_p.html#metric_block" target="origFile"><code class="keyword">DO </code>j=<code class="constant">2</code>,jl</a>
      <a href="metric_block_p.html#metric_block" target="origFile"><code class="keyword">IF</code> (vol(<code class="constant">1</code>, j, k) .LE. eps) vol(<code class="constant">1</code>, j, k) = vol(<code class="constant">2</code>, j, k)</a>
      <a href="metric_block_p.html#metric_block" target="origFile"><code class="keyword">IF</code> (vol(ie, j, k) .LE. eps) vol(ie, j, k) = vol(il, j, k)</a>
    <a href="metric_block_p.html#metric_block" target="origFile"><code class="keyword">END DO</code></a>
  <a href="metric_block_p.html#metric_block" target="origFile"><code class="keyword">END DO</code></a>
  <a href="metric_block_p.html#metric_block" target="origFile"><code class="keyword">DO </code>k=<code class="constant">2</code>,kl</a>
    <a href="metric_block_p.html#metric_block" target="origFile"><code class="keyword">DO </code>i=<code class="constant">1</code>,ie</a>
      <a href="metric_block_p.html#metric_block" target="origFile"><code class="keyword">IF</code> (vol(i, <code class="constant">1</code>, k) .LE. eps) vol(i, <code class="constant">1</code>, k) = vol(i, <code class="constant">2</code>, k)</a>
      <a href="metric_block_p.html#metric_block" target="origFile"><code class="keyword">IF</code> (vol(i, je, k) .LE. eps) vol(i, je, k) = vol(i, jl, k)</a>
    <a href="metric_block_p.html#metric_block" target="origFile"><code class="keyword">END DO</code></a>
  <a href="metric_block_p.html#metric_block" target="origFile"><code class="keyword">END DO</code></a>
  <a href="metric_block_p.html#metric_block" target="origFile"><code class="keyword">DO </code>j=<code class="constant">1</code>,je</a>
    <a href="metric_block_p.html#metric_block" target="origFile"><code class="keyword">DO </code>i=<code class="constant">1</code>,ie</a>
      <a href="metric_block_p.html#metric_block" target="origFile"><code class="keyword">IF</code> (vol(i, j, <code class="constant">1</code>) .LE. eps) vol(i, j, <code class="constant">1</code>) = vol(i, j, <code class="constant">2</code>)</a>
      <a href="metric_block_p.html#metric_block" target="origFile"><code class="keyword">IF</code> (vol(i, j, ke) .LE. eps) vol(i, j, ke) = vol(i, j, kl)</a>
    <a href="metric_block_p.html#metric_block" target="origFile"><code class="keyword">END DO</code></a>
  <a href="metric_block_p.html#metric_block" target="origFile"><code class="keyword">END DO</code></a>
<a href="metric_block_p.html#metric_block" target="origFile"><code class="comment">! Set the factor in the surface normals computation. For a</code></a>
<a href="metric_block_p.html#metric_block" target="origFile"><code class="comment">! left handed block this factor is negative, such that the</code></a>
<a href="metric_block_p.html#metric_block" target="origFile"><code class="comment">! normals still point in the direction of increasing index.</code></a>
<a href="metric_block_p.html#metric_block" target="origFile"><code class="comment">! The formulae used later on assume a right handed block</code></a>
<a name="p7"></a><a href="metric_block_p.html#metric_block" target="origFile"><code class="comment">! and fact is used to correct this for a left handed block,</code></a>
<a href="metric_block_p.html#metric_block" target="origFile"><code class="comment">! as well as the scaling factor of 0.5</code></a>
  <a href="metric_block_p.html#metric_block" target="origFile">result1 = </a><a href="msg.html#p7" target="msg"><code class="comment"><img src="danger.gif" align=middle border=0 alt="!" /></code></a><a href="metric_block_p.html#metric_block" target="origFile"><code class="funcname">FLOWDOMS</code>(nn, level, sps)</a>
  <a href="metric_block_p.html#metric_block" target="origFile"><code class="keyword">IF</code> (result1%righthanded) <code class="keyword">THEN</code></a>
    <a href="metric_block_p.html#metric_block" target="origFile">fact = half</a>
  <a href="metric_block_p.html#metric_block" target="origFile"><code class="keyword">ELSE</code></a>
    <a href="metric_block_p.html#metric_block" target="origFile">fact = -half</a>
  <a href="metric_block_p.html#metric_block" target="origFile"><code class="keyword">END IF</code></a>
<a href="metric_block_p.html#metric_block" target="origFile"><code class="comment">! Check if both positive and negative volumes occur. If so,</code></a>
<a href="metric_block_p.html#metric_block" target="origFile"><code class="comment">! the block is bad and the counter nBlockBad is updated.</code></a>
<a href="metric_block_p.html#metric_block" target="origFile"><code class="comment">!</code></a>
<a href="metric_block_p.html#metric_block" target="origFile"><code class="comment">!          **************************************************************</code></a>
<a href="metric_block_p.html#metric_block" target="origFile"><code class="comment">!          *                                                            *</code></a>
<a href="metric_block_p.html#metric_block" target="origFile"><code class="comment">!          * Computation of the face normals in i-, j- and k-direction. *</code></a>
<a href="metric_block_p.html#metric_block" target="origFile"><code class="comment">!          * Formula's are valid for a right handed block; for a left   *</code></a>
<a href="metric_block_p.html#metric_block" target="origFile"><code class="comment">!          * handed block the correct orientation is obtained via fact. *</code></a>
<a href="metric_block_p.html#metric_block" target="origFile"><code class="comment">!          * The normals point in the direction of increasing index.    *</code></a>
<a href="metric_block_p.html#metric_block" target="origFile"><code class="comment">!          * The absolute value of fact is 0.5, because the cross       *</code></a>
<a href="metric_block_p.html#metric_block" target="origFile"><code class="comment">!          * product of the two diagonals is twice the normal vector.   *</code></a>
<a href="metric_block_p.html#metric_block" target="origFile"><code class="comment">!          *                                                            *</code></a>
<a href="metric_block_p.html#metric_block" target="origFile"><code class="comment">!          * Note that also the normals of the first level halo cells   *</code></a>
<a href="metric_block_p.html#metric_block" target="origFile"><code class="comment">!          * are computed. These are needed for the viscous fluxes.     *</code></a>
<a href="metric_block_p.html#metric_block" target="origFile"><code class="comment">!          *                                                            *</code></a>
<a href="metric_block_p.html#metric_block" target="origFile"><code class="comment">!          **************************************************************</code></a>
<a href="metric_block_p.html#metric_block" target="origFile"><code class="comment">!</code></a>
<a href="metric_block_p.html#metric_block" target="origFile"><code class="comment">! Projected areas of cell faces in the i direction.</code></a>
  <a href="metric_block_p.html#metric_block" target="origFile"><code class="keyword">DO </code>k=<code class="constant">1</code>,ke</a>
    <a href="metric_block_p.html#metric_block" target="origFile">n = k - <code class="constant">1</code></a>
    <a href="metric_block_p.html#metric_block" target="origFile"><code class="keyword">DO </code>j=<code class="constant">1</code>,je</a>
      <a href="metric_block_p.html#metric_block" target="origFile">m = j - <code class="constant">1</code></a>
      <a href="metric_block_p.html#metric_block" target="origFile"><code class="keyword">DO </code>i=<code class="constant">0</code>,ie</a>
<a href="metric_block_p.html#metric_block" target="origFile"><code class="comment">! Determine the two diagonal vectors of the face.</code></a>
        <a href="metric_block_p.html#metric_block" target="origFile">v1(<code class="constant">1</code>) = x(i, j, n, <code class="constant">1</code>) - x(i, m, k, <code class="constant">1</code>)</a>
        <a href="metric_block_p.html#metric_block" target="origFile">v1(<code class="constant">2</code>) = x(i, j, n, <code class="constant">2</code>) - x(i, m, k, <code class="constant">2</code>)</a>
        <a href="metric_block_p.html#metric_block" target="origFile">v1(<code class="constant">3</code>) = x(i, j, n, <code class="constant">3</code>) - x(i, m, k, <code class="constant">3</code>)</a>
        <a href="metric_block_p.html#metric_block" target="origFile">v2(<code class="constant">1</code>) = x(i, j, k, <code class="constant">1</code>) - x(i, m, n, <code class="constant">1</code>)</a>
        <a href="metric_block_p.html#metric_block" target="origFile">v2(<code class="constant">2</code>) = x(i, j, k, <code class="constant">2</code>) - x(i, m, n, <code class="constant">2</code>)</a>
        <a href="metric_block_p.html#metric_block" target="origFile">v2(<code class="constant">3</code>) = x(i, j, k, <code class="constant">3</code>) - x(i, m, n, <code class="constant">3</code>)</a>
<a href="metric_block_p.html#metric_block" target="origFile"><code class="comment">! The face normal, which is the cross product of the two</code></a>
<a href="metric_block_p.html#metric_block" target="origFile"><code class="comment">! diagonal vectors times fact; remember that fact is</code></a>
<a href="metric_block_p.html#metric_block" target="origFile"><code class="comment">! either -0.5 or 0.5.</code></a>
        <a href="metric_block_p.html#metric_block" target="origFile">si(i, j, k, <code class="constant">1</code>) = fact*(v1(<code class="constant">2</code>)*v2(<code class="constant">3</code>)-v1(<code class="constant">3</code>)*v2(<code class="constant">2</code>))</a>
        <a href="metric_block_p.html#metric_block" target="origFile">si(i, j, k, <code class="constant">2</code>) = fact*(v1(<code class="constant">3</code>)*v2(<code class="constant">1</code>)-v1(<code class="constant">1</code>)*v2(<code class="constant">3</code>))</a>
        <a href="metric_block_p.html#metric_block" target="origFile">si(i, j, k, <code class="constant">3</code>) = fact*(v1(<code class="constant">1</code>)*v2(<code class="constant">2</code>)-v1(<code class="constant">2</code>)*v2(<code class="constant">1</code>))</a>
      <a href="metric_block_p.html#metric_block" target="origFile"><code class="keyword">END DO</code></a>
    <a href="metric_block_p.html#metric_block" target="origFile"><code class="keyword">END DO</code></a>
  <a href="metric_block_p.html#metric_block" target="origFile"><code class="keyword">END DO</code></a>
<a href="metric_block_p.html#metric_block" target="origFile"><code class="comment">! Projected areas of cell faces in the j direction.</code></a>
  <a href="metric_block_p.html#metric_block" target="origFile"><code class="keyword">DO </code>k=<code class="constant">1</code>,ke</a>
    <a href="metric_block_p.html#metric_block" target="origFile">n = k - <code class="constant">1</code></a>
    <a href="metric_block_p.html#metric_block" target="origFile"><code class="keyword">DO </code>j=<code class="constant">0</code>,je</a>
      <a href="metric_block_p.html#metric_block" target="origFile"><code class="keyword">DO </code>i=<code class="constant">1</code>,ie</a>
        <a href="metric_block_p.html#metric_block" target="origFile">l = i - <code class="constant">1</code></a>
<a href="metric_block_p.html#metric_block" target="origFile"><code class="comment">! Determine the two diagonal vectors of the face.</code></a>
        <a href="metric_block_p.html#metric_block" target="origFile">v1(<code class="constant">1</code>) = x(i, j, n, <code class="constant">1</code>) - x(l, j, k, <code class="constant">1</code>)</a>
        <a href="metric_block_p.html#metric_block" target="origFile">v1(<code class="constant">2</code>) = x(i, j, n, <code class="constant">2</code>) - x(l, j, k, <code class="constant">2</code>)</a>
        <a href="metric_block_p.html#metric_block" target="origFile">v1(<code class="constant">3</code>) = x(i, j, n, <code class="constant">3</code>) - x(l, j, k, <code class="constant">3</code>)</a>
        <a href="metric_block_p.html#metric_block" target="origFile">v2(<code class="constant">1</code>) = x(l, j, n, <code class="constant">1</code>) - x(i, j, k, <code class="constant">1</code>)</a>
        <a href="metric_block_p.html#metric_block" target="origFile">v2(<code class="constant">2</code>) = x(l, j, n, <code class="constant">2</code>) - x(i, j, k, <code class="constant">2</code>)</a>
        <a href="metric_block_p.html#metric_block" target="origFile">v2(<code class="constant">3</code>) = x(l, j, n, <code class="constant">3</code>) - x(i, j, k, <code class="constant">3</code>)</a>
<a href="metric_block_p.html#metric_block" target="origFile"><code class="comment">! The face normal, which is the cross product of the two</code></a>
<a href="metric_block_p.html#metric_block" target="origFile"><code class="comment">! diagonal vectors times fact; remember that fact is</code></a>
<a href="metric_block_p.html#metric_block" target="origFile"><code class="comment">! either -0.5 or 0.5.</code></a>
        <a href="metric_block_p.html#metric_block" target="origFile">sj(i, j, k, <code class="constant">1</code>) = fact*(v1(<code class="constant">2</code>)*v2(<code class="constant">3</code>)-v1(<code class="constant">3</code>)*v2(<code class="constant">2</code>))</a>
        <a href="metric_block_p.html#metric_block" target="origFile">sj(i, j, k, <code class="constant">2</code>) = fact*(v1(<code class="constant">3</code>)*v2(<code class="constant">1</code>)-v1(<code class="constant">1</code>)*v2(<code class="constant">3</code>))</a>
        <a href="metric_block_p.html#metric_block" target="origFile">sj(i, j, k, <code class="constant">3</code>) = fact*(v1(<code class="constant">1</code>)*v2(<code class="constant">2</code>)-v1(<code class="constant">2</code>)*v2(<code class="constant">1</code>))</a>
      <a href="metric_block_p.html#metric_block" target="origFile"><code class="keyword">END DO</code></a>
    <a href="metric_block_p.html#metric_block" target="origFile"><code class="keyword">END DO</code></a>
  <a href="metric_block_p.html#metric_block" target="origFile"><code class="keyword">END DO</code></a>
<a href="metric_block_p.html#metric_block" target="origFile"><code class="comment">! Projected areas of cell faces in the k direction.</code></a>
  <a href="metric_block_p.html#metric_block" target="origFile"><code class="keyword">DO </code>k=<code class="constant">0</code>,ke</a>
    <a href="metric_block_p.html#metric_block" target="origFile"><code class="keyword">DO </code>j=<code class="constant">1</code>,je</a>
      <a href="metric_block_p.html#metric_block" target="origFile">m = j - <code class="constant">1</code></a>
      <a href="metric_block_p.html#metric_block" target="origFile"><code class="keyword">DO </code>i=<code class="constant">1</code>,ie</a>
        <a href="metric_block_p.html#metric_block" target="origFile">l = i - <code class="constant">1</code></a>
<a href="metric_block_p.html#metric_block" target="origFile"><code class="comment">! Determine the two diagonal vectors of the face.</code></a>
        <a href="metric_block_p.html#metric_block" target="origFile">v1(<code class="constant">1</code>) = x(i, j, k, <code class="constant">1</code>) - x(l, m, k, <code class="constant">1</code>)</a>
        <a href="metric_block_p.html#metric_block" target="origFile">v1(<code class="constant">2</code>) = x(i, j, k, <code class="constant">2</code>) - x(l, m, k, <code class="constant">2</code>)</a>
        <a href="metric_block_p.html#metric_block" target="origFile">v1(<code class="constant">3</code>) = x(i, j, k, <code class="constant">3</code>) - x(l, m, k, <code class="constant">3</code>)</a>
        <a href="metric_block_p.html#metric_block" target="origFile">v2(<code class="constant">1</code>) = x(l, j, k, <code class="constant">1</code>) - x(i, m, k, <code class="constant">1</code>)</a>
        <a href="metric_block_p.html#metric_block" target="origFile">v2(<code class="constant">2</code>) = x(l, j, k, <code class="constant">2</code>) - x(i, m, k, <code class="constant">2</code>)</a>
        <a href="metric_block_p.html#metric_block" target="origFile">v2(<code class="constant">3</code>) = x(l, j, k, <code class="constant">3</code>) - x(i, m, k, <code class="constant">3</code>)</a>
<a href="metric_block_p.html#metric_block" target="origFile"><code class="comment">! The face normal, which is the cross product of the two</code></a>
<a href="metric_block_p.html#metric_block" target="origFile"><code class="comment">! diagonal vectors times fact; remember that fact is</code></a>
<a href="metric_block_p.html#metric_block" target="origFile"><code class="comment">! either -0.5 or 0.5.</code></a>
        <a href="metric_block_p.html#metric_block" target="origFile">sk(i, j, k, <code class="constant">1</code>) = fact*(v1(<code class="constant">2</code>)*v2(<code class="constant">3</code>)-v1(<code class="constant">3</code>)*v2(<code class="constant">2</code>))</a>
        <a href="metric_block_p.html#metric_block" target="origFile">sk(i, j, k, <code class="constant">2</code>) = fact*(v1(<code class="constant">3</code>)*v2(<code class="constant">1</code>)-v1(<code class="constant">1</code>)*v2(<code class="constant">3</code>))</a>
        <a href="metric_block_p.html#metric_block" target="origFile">sk(i, j, k, <code class="constant">3</code>) = fact*(v1(<code class="constant">1</code>)*v2(<code class="constant">2</code>)-v1(<code class="constant">2</code>)*v2(<code class="constant">1</code>))</a>
      <a href="metric_block_p.html#metric_block" target="origFile"><code class="keyword">END DO</code></a>
    <a href="metric_block_p.html#metric_block" target="origFile"><code class="keyword">END DO</code></a>
  <a href="metric_block_p.html#metric_block" target="origFile"><code class="keyword">END DO</code></a>
<a href="metric_block_p.html#metric_block" target="origFile"><code class="comment">!</code></a>
<a href="metric_block_p.html#metric_block" target="origFile"><code class="comment">!          **************************************************************</code></a>
<a href="metric_block_p.html#metric_block" target="origFile"><code class="comment">!          *                                                            *</code></a>
<a href="metric_block_p.html#metric_block" target="origFile"><code class="comment">!          * The unit normals on the boundary faces. These always point *</code></a>
<a href="metric_block_p.html#metric_block" target="origFile"><code class="comment">!          * out of the domain, so a multiplication by -1 is needed for *</code></a>
<a href="metric_block_p.html#metric_block" target="origFile"><code class="comment">!          * the iMin, jMin and kMin boundaries.                        *</code></a>
<a href="metric_block_p.html#metric_block" target="origFile"><code class="comment">!          *                                                            *</code></a>
<a href="metric_block_p.html#metric_block" target="origFile"><code class="comment">!          **************************************************************</code></a>
<a href="metric_block_p.html#metric_block" target="origFile"><code class="comment">!</code></a>
<a href="metric_block_p.html#metric_block" target="origFile"><code class="comment">! Loop over the boundary subfaces of this block.</code></a>
<a href="metric_block_p.html#metric_block" target="origFile"><code class="label">bocoloop:</code><code class="keyword">DO </code>mm=<code class="constant">1</code>,nbocos</a>
<a href="metric_block_p.html#metric_block" target="origFile"><code class="comment">! Determine the block face on which this subface is located</code></a>
<a href="metric_block_p.html#metric_block" target="origFile"><code class="comment">! and set ss and mult accordingly.</code></a>
    <a href="metric_block_p.html#metric_block" target="origFile"><code class="keyword">SELECT CASE </code> (bcfaceid(mm)) </a>
    <a href="metric_block_p.html#metric_block" target="origFile"><code class="keyword">CASE </code>(imin) </a>
      <a href="metric_block_p.html#metric_block" target="origFile">mult = -one</a>
      <a href="metric_block_p.html#metric_block" target="origFile">ss => si(<code class="constant">1</code>, :, :, :)</a>
    <a href="metric_block_p.html#metric_block" target="origFile"><code class="keyword">CASE </code>(imax) </a>
      <a href="metric_block_p.html#metric_block" target="origFile">mult = one</a>
      <a href="metric_block_p.html#metric_block" target="origFile">ss => si(il, :, :, :)</a>
    <a href="metric_block_p.html#metric_block" target="origFile"><code class="keyword">CASE </code>(jmin) </a>
      <a href="metric_block_p.html#metric_block" target="origFile">mult = -one</a>
      <a href="metric_block_p.html#metric_block" target="origFile">ss => sj(:, <code class="constant">1</code>, :, :)</a>
    <a href="metric_block_p.html#metric_block" target="origFile"><code class="keyword">CASE </code>(jmax) </a>
      <a href="metric_block_p.html#metric_block" target="origFile">mult = one</a>
      <a href="metric_block_p.html#metric_block" target="origFile">ss => sj(:, jl, :, :)</a>
    <a href="metric_block_p.html#metric_block" target="origFile"><code class="keyword">CASE </code>(kmin) </a>
      <a href="metric_block_p.html#metric_block" target="origFile">mult = -one</a>
      <a href="metric_block_p.html#metric_block" target="origFile">ss => sk(:, :, <code class="constant">1</code>, :)</a>
    <a href="metric_block_p.html#metric_block" target="origFile"><code class="keyword">CASE </code>(kmax) </a>
      <a href="metric_block_p.html#metric_block" target="origFile">mult = one</a>
      <a href="metric_block_p.html#metric_block" target="origFile">ss => sk(:, :, kl, :)</a>
    <a href="metric_block_p.html#metric_block" target="origFile"><code class="keyword">END SELECT</code></a>
<a href="metric_block_p.html#metric_block" target="origFile"><code class="comment">! Loop over the boundary faces of the subface.</code></a>
    <a href="metric_block_p.html#metric_block" target="origFile"><code class="keyword">DO </code>j=bcdata(mm)%jcbeg,bcdata(mm)%jcend</a>
      <a href="metric_block_p.html#metric_block" target="origFile"><code class="keyword">DO </code>i=bcdata(mm)%icbeg,bcdata(mm)%icend</a>
<a name="p41"></a><a href="metric_block_p.html#metric_block" target="origFile"><code class="comment">! Compute the inverse of the length of the normal vector</code></a>
<a name="p42"></a><a href="metric_block_p.html#metric_block" target="origFile"><code class="comment">! and possibly correct for inward pointing.</code></a>
<a name="p43"></a>        <a href="metric_block_p.html#metric_block" target="origFile">xp = </a><a href="msg.html#p41" target="msg"><code class="comment"><img src="danger.gif" align=middle border=0 alt="!" /></code></a><a href="metric_block_p.html#metric_block" target="origFile">ss(i, j, <code class="constant">1</code>)</a>
        <a href="metric_block_p.html#metric_block" target="origFile">yp = </a><a href="msg.html#p42" target="msg"><code class="comment"><img src="danger.gif" align=middle border=0 alt="!" /></code></a><a href="metric_block_p.html#metric_block" target="origFile">ss(i, j, <code class="constant">2</code>)</a>
        <a href="metric_block_p.html#metric_block" target="origFile">zp = </a><a href="msg.html#p43" target="msg"><code class="comment"><img src="danger.gif" align=middle border=0 alt="!" /></code></a><a href="metric_block_p.html#metric_block" target="origFile">ss(i, j, <code class="constant">3</code>)</a>
        <a href="metric_block_p.html#metric_block" target="origFile">arg1 = xp*xp + yp*yp + zp*zp</a>
        <a href="metric_block_p.html#metric_block" target="origFile">fact = <code class="funcname">SQRT</code>(arg1)</a>
        <a href="metric_block_p.html#metric_block" target="origFile"><code class="keyword">IF</code> (fact .GT. zero) fact = mult/fact</a>
<a href="metric_block_p.html#metric_block" target="origFile"><code class="comment">! Compute the unit normal.</code></a>
        <a href="metric_block_p.html#metric_block" target="origFile">bcdata(mm)%norm(i, j, <code class="constant">1</code>) = fact*xp</a>
        <a href="metric_block_p.html#metric_block" target="origFile">bcdata(mm)%norm(i, j, <code class="constant">2</code>) = fact*yp</a>
        <a href="metric_block_p.html#metric_block" target="origFile">bcdata(mm)%norm(i, j, <code class="constant">3</code>) = fact*zp</a>
      <a href="metric_block_p.html#metric_block" target="origFile"><code class="keyword">END DO</code></a>
    <a href="metric_block_p.html#metric_block" target="origFile"><code class="keyword">END DO</code></a>
  <a href="metric_block_p.html#metric_block" target="origFile"><code class="keyword">END DO </code><code class="label">bocoloop</code></a>
<a href="metric_block_p.html#metric_block" target="origFile"><code class="keyword">END SUBROUTINE </code><code class="funcname">METRIC_BLOCK_CD</code></a>
</pre>
</body>
