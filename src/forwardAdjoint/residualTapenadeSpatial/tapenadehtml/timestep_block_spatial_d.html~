<title>Generated by TAPENADE</title>
<link type="text/CSS" rel="stylesheet" href="tapenade.css">
<link type="text/CSS" rel="stylesheet" href="fortranStyle.css">
<body>
<pre><a name="timestep_block_spatial_d"></a><a href="timestep_block_p.html#timestep_block" target="origFile"><code class="comment">!        Generated by TAPENADE     (INRIA, Tropics team)</code></a>
<a href="timestep_block_p.html#timestep_block" target="origFile"><code class="comment">!  Tapenade 3.4 (r3375) - 10 Feb 2010 15:08</code></a>
<a href="timestep_block_p.html#timestep_block" target="origFile"><code class="comment">!</code></a>
<a href="timestep_block_p.html#timestep_block" target="origFile"><code class="comment">!  Differentiation of timestep_block in forward (tangent) mode:</code></a>
<a href="timestep_block_p.html#timestep_block" target="origFile"><code class="comment">!   variations   of useful results: *radi *radj *radk</code></a>
<a href="timestep_block_p.html#timestep_block" target="origFile"><code class="comment">!   with respect to varying inputs: *p *gamma *w adis</code></a>
<a href="timestep_block_p.html#timestep_block" target="origFile"><code class="comment">!</code></a>
<a href="timestep_block_p.html#timestep_block" target="origFile"><code class="comment">!      ******************************************************************</code></a>
<a href="timestep_block_p.html#timestep_block" target="origFile"><code class="comment">!      *                                                                *</code></a>
<a href="timestep_block_p.html#timestep_block" target="origFile"><code class="comment">!      * File:          timeStep.f90                                    *</code></a>
<a href="timestep_block_p.html#timestep_block" target="origFile"><code class="comment">!      * Author:        Edwin van der Weide                             *</code></a>
<a href="timestep_block_p.html#timestep_block" target="origFile"><code class="comment">!      * Starting date: 03-17-2003                                      *</code></a>
<a href="timestep_block_p.html#timestep_block" target="origFile"><code class="comment">!      * Last modified: 06-28-2005                                      *</code></a>
<a href="timestep_block_p.html#timestep_block" target="origFile"><code class="comment">!      *                                                                *</code></a>
<a href="timestep_block_p.html#timestep_block" target="origFile"><code class="comment">!      ******************************************************************</code></a>
<a href="timestep_block_p.html#timestep_block" target="origFile"><code class="comment">!</code></a>
<a href="timestep_block_p.html#timestep_block" target="origFile"><code class="keyword">SUBROUTINE </code><code class="funcname">TIMESTEP_BLOCK_SPATIAL_D</code>(<code class="vardecl">onlyradii</code>)</a>
  <a href="timestep_block_p.html#timestep_block" target="origFile"><code class="keyword">USE </code><code class="funcname">INPUTITERATION_SPATIAL_D</code></a>
  <a href="timestep_block_p.html#timestep_block" target="origFile"><code class="keyword">USE </code><code class="funcname">SECTION_SPATIAL_D</code></a>
  <a href="timestep_block_p.html#timestep_block" target="origFile"><code class="keyword">USE </code><code class="funcname">INPUTPHYSICS_SPATIAL_D</code></a>
  <a href="timestep_block_p.html#timestep_block" target="origFile"><code class="keyword">USE </code><code class="funcname">ITERATION_SPATIAL_D</code></a>
  <a href="timestep_block_p.html#timestep_block" target="origFile"><code class="keyword">USE </code><code class="funcname">INPUTDISCRETIZATION_SPATIAL_D</code></a>
  <a href="timestep_block_p.html#timestep_block" target="origFile"><code class="keyword">USE </code><code class="funcname">CONSTANTS_SPATIAL_D</code></a>
  <a href="timestep_block_p.html#timestep_block" target="origFile"><code class="keyword">USE </code><code class="funcname">INPUTTIMESPECTRAL_SPATIAL_D</code></a>
  <a href="timestep_block_p.html#timestep_block" target="origFile"><code class="keyword">USE </code><code class="funcname">BLOCKPOINTERS_SPATIAL_D</code></a>
<a name="timestep_block_spatial_di0"></a>  <a href="timestep_block_p.html#timestep_block" target="origFile"><code class="keyword">USE </code><code class="funcname">FLOWVARREFSTATE_SPATIAL_D</code></a>
  <a href="timestep_block_p.html#timestep_block" target="origFile"><code class="keyword">IMPLICIT NONE</code></a>
<a href="timestep_block_p.html#timestep_blocki0" target="origFile"><code class="comment">!</code></a>
<a href="timestep_block_p.html#timestep_blocki0" target="origFile"><code class="comment">!      ******************************************************************</code></a>
<a href="timestep_block_p.html#timestep_blocki0" target="origFile"><code class="comment">!      *                                                                *</code></a>
<a href="timestep_block_p.html#timestep_blocki0" target="origFile"><code class="comment">!      * timeStep computes the time step, or more precisely the time    *</code></a>
<a href="timestep_block_p.html#timestep_blocki0" target="origFile"><code class="comment">!      * step divided by the volume per unit CFL, in the owned cells.   *</code></a>
<a href="timestep_block_p.html#timestep_blocki0" target="origFile"><code class="comment">!      * However, for the artificial dissipation schemes, the spectral  *</code></a>
<a href="timestep_block_p.html#timestep_blocki0" target="origFile"><code class="comment">!      * radIi in the halo's are needed. Therefore the loop is taken    *</code></a>
<a href="timestep_block_p.html#timestep_blocki0" target="origFile"><code class="comment">!      * over the the first level of halo cells. The spectral radIi are *</code></a>
<a href="timestep_block_p.html#timestep_blocki0" target="origFile"><code class="comment">!      * stored and possibly modified for high aspect ratio cells.      *</code></a>
<a href="timestep_block_p.html#timestep_blocki0" target="origFile"><code class="comment">!      *                                                                *</code></a>
<a href="timestep_block_p.html#timestep_blocki0" target="origFile"><code class="comment">!      ******************************************************************</code></a>
<a href="timestep_block_p.html#timestep_blocki0" target="origFile"><code class="comment">!</code></a>
<a href="timestep_block_p.html#timestep_blocki0" target="origFile"><code class="comment">!</code></a>
<a href="timestep_block_p.html#timestep_blocki0" target="origFile"><code class="comment">!      Subroutine argument.</code></a>
<a name="timestep_block_spatial_di1"></a><a href="timestep_block_p.html#timestep_blocki0" target="origFile"><code class="comment">!</code></a>
  <a href="timestep_block_p.html#timestep_blocki0" target="origFile"><code class="typename">LOGICAL</code>, <code class="typename">INTENT(IN) </code>:: <code class="vardecl">onlyradii</code></a>
<a href="timestep_block_p.html#timestep_blocki1" target="origFile"><code class="comment">!</code></a>
<a href="timestep_block_p.html#timestep_blocki1" target="origFile"><code class="comment">!      Local parameters.</code></a>
<a name="timestep_block_spatial_di2"></a><a href="timestep_block_p.html#timestep_blocki1" target="origFile"><code class="comment">!</code></a>
  <a href="timestep_block_p.html#timestep_blocki1" target="origFile"><code class="typename">REAL(</code><code class="keyword">kind</code>=<code class="modifier">realtype</code><code class="typename">)</code>, <code class="typename">PARAMETER </code>:: <code class="vardecl">b</code>=<code class="constant">2.0_realType</code></a>
<a href="timestep_block_p.html#timestep_blocki2" target="origFile"><code class="comment">!</code></a>
<a href="timestep_block_p.html#timestep_blocki2" target="origFile"><code class="comment">!      Local variables.</code></a>
<a name="timestep_block_spatial_di3"></a><a href="timestep_block_p.html#timestep_blocki2" target="origFile"><code class="comment">!</code></a>
<a name="timestep_block_spatial_di4"></a>  <a href="timestep_block_p.html#timestep_blocki2" target="origFile"><code class="typename">INTEGER(</code><code class="keyword">kind</code>=<code class="modifier">inttype</code><code class="typename">) </code>:: <code class="vardecl">sps</code>, <code class="vardecl">nn</code>, <code class="vardecl">i</code>, <code class="vardecl">j</code>, <code class="vardecl">k</code></a>
  <a href="timestep_block_p.html#timestep_blocki3" target="origFile"><code class="typename">REAL(</code><code class="keyword">kind</code>=<code class="modifier">realtype</code><code class="typename">) </code>:: <code class="vardecl">plim</code>, <code class="vardecl">rlim</code>, <code class="vardecl">clim2</code></a>
<a name="timestep_block_spatial_di5"></a>  <a href="timestep_block_p.html#timestep_blocki4" target="origFile"><code class="typename">REAL(</code><code class="keyword">kind</code>=<code class="modifier">realtype</code><code class="typename">) </code>:: <code class="vardecl">ux</code>, <code class="vardecl">uy</code>, <code class="vardecl">uz</code>, <code class="vardecl">cc2</code>, <code class="vardecl">qs</code>, <code class="vardecl">sx</code>, <code class="vardecl">sy</code>, <code class="vardecl">sz</code>, <code class="vardecl">rmu</code></a>
  <a href="timestep_block_p.html#timestep_block" target="origFile"><code class="typename">REAL(</code><code class="keyword">kind</code>=<code class="modifier">realtype</code><code class="typename">) </code>:: <code class="vardecl">uxd</code>, <code class="vardecl">uyd</code>, <code class="vardecl">uzd</code>, <code class="vardecl">cc2d</code>, <code class="vardecl">qsd</code></a>
<a name="timestep_block_spatial_di6"></a>  <a href="timestep_block_p.html#timestep_blocki5" target="origFile"><code class="typename">REAL(</code><code class="keyword">kind</code>=<code class="modifier">realtype</code><code class="typename">) </code>:: <code class="vardecl">ri</code>, <code class="vardecl">rj</code>, <code class="vardecl">rk</code>, <code class="vardecl">rij</code>, <code class="vardecl">rjk</code>, <code class="vardecl">rki</code></a>
<a name="timestep_block_spatial_di7"></a>  <a href="timestep_block_p.html#timestep_block" target="origFile"><code class="typename">REAL(</code><code class="keyword">kind</code>=<code class="modifier">realtype</code><code class="typename">) </code>:: <code class="vardecl">rid</code>, <code class="vardecl">rjd</code>, <code class="vardecl">rkd</code>, <code class="vardecl">rijd</code>, <code class="vardecl">rjkd</code>, <code class="vardecl">rkid</code></a>
<a name="timestep_block_spatial_di8"></a>  <a href="timestep_block_p.html#timestep_blocki6" target="origFile"><code class="typename">REAL(</code><code class="keyword">kind</code>=<code class="modifier">realtype</code><code class="typename">) </code>:: <code class="vardecl">vsi</code>, <code class="vardecl">vsj</code>, <code class="vardecl">vsk</code>, <code class="vardecl">rfl</code>, <code class="vardecl">dpi</code>, <code class="vardecl">dpj</code>, <code class="vardecl">dpk</code></a>
<a name="timestep_block_spatial_di9"></a>  <a href="timestep_block_p.html#timestep_blocki7" target="origFile"><code class="typename">REAL(</code><code class="keyword">kind</code>=<code class="modifier">realtype</code><code class="typename">) </code>:: <code class="vardecl">sface</code>, <code class="vardecl">tmp</code></a>
  <a href="timestep_block_p.html#timestep_blocki8" target="origFile"><code class="typename">LOGICAL </code>:: <code class="vardecl">radiineeded</code></a>
<a name="timestep_block_spatial_di10"></a>  <a href="timestep_block_p.html#timestep_blocki9" target="origFile"><code class="typename">REAL(</code><code class="keyword">kind</code>=<code class="modifier">realtype</code><code class="typename">) </code>:: <code class="vardecl">arg1</code></a>
  <a href="timestep_block_p.html#timestep_block" target="origFile"><code class="typename">REAL(</code><code class="keyword">kind</code>=<code class="modifier">realtype</code><code class="typename">) </code>:: <code class="vardecl">arg1d</code></a>
<a name="timestep_block_spatial_di11"></a>  <a href="timestep_block_p.html#timestep_blocki10" target="origFile"><code class="typename">REAL(</code><code class="keyword">kind</code>=<code class="modifier">realtype</code><code class="typename">) </code>:: <code class="vardecl">result1</code></a>
  <a href="timestep_block_p.html#timestep_block" target="origFile"><code class="typename">REAL(</code><code class="keyword">kind</code>=<code class="modifier">realtype</code><code class="typename">) </code>:: <code class="vardecl">result1d</code></a>
  <a href="timestep_block_p.html#timestep_blocki11" target="origFile"><code class="typename">REAL(</code><code class="keyword">kind</code>=<code class="modifier">realtype</code><code class="typename">) </code>:: <code class="vardecl">pwx1</code></a>
  <a href="timestep_block_p.html#timestep_block" target="origFile"><code class="typename">REAL(</code><code class="keyword">kind</code>=<code class="modifier">realtype</code><code class="typename">) </code>:: <code class="vardecl">pwx1d</code></a>
  <a href="timestep_block_p.html#timestep_block" target="origFile"><code class="typename">REAL(</code><code class="keyword">kind</code>=<code class="modifier">realtype</code><code class="typename">) </code>:: <code class="vardecl">abs1d</code></a>
  <a href="timestep_block_p.html#timestep_block" target="origFile"><code class="keyword">INTRINSIC </code><code class="funcname">MAX</code></a>
  <a href="timestep_block_p.html#timestep_block" target="origFile"><code class="keyword">INTRINSIC </code><code class="funcname">ABS</code></a>
  <a href="timestep_block_p.html#timestep_block" target="origFile"><code class="typename">REAL(</code><code class="keyword">kind</code>=<code class="modifier">realtype</code><code class="typename">) </code>:: <code class="vardecl">abs3d</code></a>
  <a href="timestep_block_p.html#timestep_block" target="origFile"><code class="typename">REAL(</code><code class="keyword">kind</code>=<code class="modifier">realtype</code><code class="typename">) </code>:: <code class="vardecl">abs6</code></a>
  <a href="timestep_block_p.html#timestep_block" target="origFile"><code class="typename">REAL(</code><code class="keyword">kind</code>=<code class="modifier">realtype</code><code class="typename">) </code>:: <code class="vardecl">abs5</code></a>
  <a href="timestep_block_p.html#timestep_block" target="origFile"><code class="typename">REAL(</code><code class="keyword">kind</code>=<code class="modifier">realtype</code><code class="typename">) </code>:: <code class="vardecl">abs4</code></a>
  <a href="timestep_block_p.html#timestep_block" target="origFile"><code class="typename">REAL(</code><code class="keyword">kind</code>=<code class="modifier">realtype</code><code class="typename">) </code>:: <code class="vardecl">abs3</code></a>
  <a href="timestep_block_p.html#timestep_block" target="origFile"><code class="typename">REAL(</code><code class="keyword">kind</code>=<code class="modifier">realtype</code><code class="typename">) </code>:: <code class="vardecl">abs2</code></a>
  <a href="timestep_block_p.html#timestep_block" target="origFile"><code class="typename">REAL(</code><code class="keyword">kind</code>=<code class="modifier">realtype</code><code class="typename">) </code>:: <code class="vardecl">abs2d</code></a>
<a name="timestep_block_spatial_di12"></a>  <a href="timestep_block_p.html#timestep_block" target="origFile"><code class="typename">REAL(</code><code class="keyword">kind</code>=<code class="modifier">realtype</code><code class="typename">) </code>:: <code class="vardecl">abs1</code></a>
  <a href="timestep_block_p.html#timestep_block" target="origFile"><code class="keyword">INTRINSIC </code><code class="funcname">SQRT</code></a>
<a href="timestep_block_p.html#timestep_blocki12" target="origFile"><code class="comment">!</code></a>
<a href="timestep_block_p.html#timestep_blocki12" target="origFile"><code class="comment">!      ******************************************************************</code></a>
<a href="timestep_block_p.html#timestep_blocki12" target="origFile"><code class="comment">!      *                                                                *</code></a>
<a href="timestep_block_p.html#timestep_blocki12" target="origFile"><code class="comment">!      * Begin execution                                                *</code></a>
<a href="timestep_block_p.html#timestep_blocki12" target="origFile"><code class="comment">!      *                                                                *</code></a>
<a href="timestep_block_p.html#timestep_blocki12" target="origFile"><code class="comment">!      ******************************************************************</code></a>
<a href="timestep_block_p.html#timestep_blocki12" target="origFile"><code class="comment">!</code></a>
<a href="timestep_block_p.html#timestep_blocki12" target="origFile"><code class="comment">! Determine whether or not the spectral radii are needed for the</code></a>
<a name="timestep_block_spatial_di14"></a><a name="timestep_block_spatial_di13"></a><a href="timestep_block_p.html#timestep_blocki12" target="origFile"><code class="comment">! flux computation.</code></a>
<a name="timestep_block_spatial_di15"></a>  <a href="timestep_block_p.html#timestep_blocki12" target="origFile">radiineeded = radiineededcoarse</a>
  <a href="timestep_block_p.html#timestep_blocki13" target="origFile"><code class="keyword">IF</code> (currentlevel .LE. groundlevel) </a><a href="timestep_block_p.html#timestep_blocki14" target="origFile">radiineeded = radiineededfine</a>
<a href="timestep_block_p.html#timestep_blocki15" target="origFile"><code class="comment">! Return immediately if only the spectral radii must be computed</code></a>
<a href="timestep_block_p.html#timestep_blocki15" target="origFile"><code class="comment">! and these are not needed for the flux computation.</code></a>
  <a href="timestep_block_p.html#timestep_blocki15" target="origFile"><code class="keyword">IF</code> (onlyradii .AND. (.NOT.radiineeded)) <code class="keyword">THEN</code></a>
    <a href="timestep_block_p.html#timestep_blocki15" target="origFile">radid = <code class="constant">0.0</code></a>
<a name="timestep_block_spatial_di16"></a>    <a href="timestep_block_p.html#timestep_blocki15" target="origFile">radjd = <code class="constant">0.0</code></a>
    <a href="timestep_block_p.html#timestep_blocki15" target="origFile">radkd = <code class="constant">0.0</code></a>
<a name="timestep_block_spatial_di17"></a>    <a href="timestep_block_p.html#timestep_blocki16" target="origFile"><code class="keyword">RETURN</code></a>
  <a href="timestep_block_p.html#timestep_blocki15" target="origFile"><code class="keyword">ELSE</code></a>
<a href="timestep_block_p.html#timestep_blocki17" target="origFile"><code class="comment">! Set the value of plim. To be fully consistent this must have</code></a>
<a href="timestep_block_p.html#timestep_blocki17" target="origFile"><code class="comment">! the dimension of a pressure. Therefore a fraction of pInfCorr</code></a>
<a name="timestep_block_spatial_di18"></a><a href="timestep_block_p.html#timestep_blocki17" target="origFile"><code class="comment">! is used. Idem for rlim; compute clim2 as well.</code></a>
<a name="timestep_block_spatial_di19"></a>    <a href="timestep_block_p.html#timestep_blocki17" target="origFile">plim = <code class="constant">0.001_realType</code>*pinfcorr</a>
<a name="timestep_block_spatial_di20"></a>    <a href="timestep_block_p.html#timestep_blocki18" target="origFile">rlim = <code class="constant">0.001_realType</code>*rhoinf</a>
    <a href="timestep_block_p.html#timestep_blocki19" target="origFile">clim2 = <code class="constant">0.000001_realType</code>*gammainf*pinfcorr/rhoinf</a>
<a href="timestep_block_p.html#timestep_blocki20" target="origFile"><code class="comment">! Loop over the number of spectral solutions and local blocks.</code></a>
<a href="timestep_block_p.html#timestep_blocki20" target="origFile"><code class="comment">! Initialize sFace to zero. This value will be used if the</code></a>
<a name="timestep_block_spatial_di21"></a><a href="timestep_block_p.html#timestep_blocki20" target="origFile"><code class="comment">! block is not moving.</code></a>
    <a href="timestep_block_p.html#timestep_blocki20" target="origFile">sface = zero</a>
<a href="timestep_block_p.html#timestep_blocki21" target="origFile"><code class="comment">!</code></a>
<a href="timestep_block_p.html#timestep_blocki21" target="origFile"><code class="comment">!          **************************************************************</code></a>
<a href="timestep_block_p.html#timestep_blocki21" target="origFile"><code class="comment">!          *                                                            *</code></a>
<a href="timestep_block_p.html#timestep_blocki21" target="origFile"><code class="comment">!          * Inviscid contribution, depending on the preconditioner.    *</code></a>
<a href="timestep_block_p.html#timestep_blocki21" target="origFile"><code class="comment">!          * Compute the cell centered values of the spectral radii.    *</code></a>
<a href="timestep_block_p.html#timestep_blocki21" target="origFile"><code class="comment">!          *                                                            *</code></a>
<a href="timestep_block_p.html#timestep_blocki21" target="origFile"><code class="comment">!          **************************************************************</code></a>
<a href="timestep_block_p.html#timestep_blocki21" target="origFile"><code class="comment">!</code></a>
    <a href="timestep_block_p.html#timestep_blocki21" target="origFile"><code class="keyword">SELECT CASE </code> (precond) </a>
    <a href="timestep_block_p.html#timestep_blocki21" target="origFile"><code class="keyword">CASE </code>(noprecond) </a>
      <a href="timestep_block_p.html#timestep_blocki21" target="origFile">radid = <code class="constant">0.0</code></a>
<a name="timestep_block_spatial_di22"></a>      <a href="timestep_block_p.html#timestep_blocki21" target="origFile">radjd = <code class="constant">0.0</code></a>
      <a href="timestep_block_p.html#timestep_blocki21" target="origFile">radkd = <code class="constant">0.0</code></a>
<a href="timestep_block_p.html#timestep_blocki22" target="origFile"><code class="comment">! No preconditioner. Simply the standard spectral radius.</code></a>
<a name="timestep_block_spatial_di23"></a><a href="timestep_block_p.html#timestep_blocki22" target="origFile"><code class="comment">! Loop over the cells, including the first level halo.</code></a>
<a name="timestep_block_spatial_di24"></a>      <a href="timestep_block_p.html#timestep_blocki22" target="origFile"><code class="keyword">DO </code>k=<code class="constant">1</code>,ke</a>
<a name="timestep_block_spatial_di25"></a>        <a href="timestep_block_p.html#timestep_blocki23" target="origFile"><code class="keyword">DO </code>j=<code class="constant">1</code>,je</a>
          <a href="timestep_block_p.html#timestep_blocki24" target="origFile"><code class="keyword">DO </code>i=<code class="constant">1</code>,ie</a>
<a href="timestep_block_p.html#timestep_blocki25" target="origFile"><code class="comment">! Compute the velocities and speed of sound squared.</code></a>
<a name="timestep_block_spatial_di26"></a>            <a href="timestep_block_p.html#timestep_blocki25" target="origFile">uxd = wd(i, j, k, ivx)</a>
            <a href="timestep_block_p.html#timestep_blocki25" target="origFile">ux = w(i, j, k, ivx)</a>
<a name="timestep_block_spatial_di27"></a>            <a href="timestep_block_p.html#timestep_blocki26" target="origFile">uyd = wd(i, j, k, ivy)</a>
            <a href="timestep_block_p.html#timestep_blocki26" target="origFile">uy = w(i, j, k, ivy)</a>
<a name="timestep_block_spatial_di28"></a>            <a href="timestep_block_p.html#timestep_blocki27" target="origFile">uzd = wd(i, j, k, ivz)</a>
            <a href="timestep_block_p.html#timestep_blocki27" target="origFile">uz = w(i, j, k, ivz)</a>
            <a href="timestep_block_p.html#timestep_blocki28" target="origFile">cc2d = ((gammad(i, j, k)*p(i, j, k)+gamma(i, j, k)*pd(i, j, <code class="label">&</code></a>
<a href="timestep_block_p.html#timestep_blocki28" target="origFile"><code class="label">&              </code>k))*w(i, j, k, irho)-gamma(i, j, k)*p(i, j, k)*wd(i, j, k<code class="label">&</code></a>
<a name="timestep_block_spatial_di29"></a><a href="timestep_block_p.html#timestep_blocki28" target="origFile"><code class="label">&              </code>, irho))/w(i, j, k, irho)**<code class="constant">2</code></a>
            <a href="timestep_block_p.html#timestep_blocki28" target="origFile">cc2 = gamma(i, j, k)*p(i, j, k)/w(i, j, k, irho)</a>
<a href="timestep_block_p.html#timestep_blocki29" target="origFile"><code class="comment">!cc2 = max(cc2,clim2)</code></a>
<a href="timestep_block_p.html#timestep_blocki29" target="origFile"><code class="comment">! Set the dot product of the grid velocity and the</code></a>
<a href="timestep_block_p.html#timestep_blocki29" target="origFile"><code class="comment">! normal in i-direction for a moving face. To avoid</code></a>
<a name="timestep_block_spatial_di30"></a><a href="timestep_block_p.html#timestep_blocki29" target="origFile"><code class="comment">! a number of multiplications by 0.5 simply the sum</code></a>
<a href="timestep_block_p.html#timestep_blocki29" target="origFile"><code class="comment">! is taken.</code></a>
<a name="timestep_block_spatial_di31"></a>            <a href="timestep_block_p.html#timestep_blocki29" target="origFile"><code class="keyword">IF</code> (addgridvelocities) </a><a href="timestep_block_p.html#timestep_blocki30" target="origFile">sface = sfacei(i-<code class="constant">1</code>, j, k) + sfacei(i<code class="label">&</code></a>
<a href="timestep_block_p.html#timestep_blocki30" target="origFile"><code class="label">&                </code>, j, k)</a>
<a name="timestep_block_spatial_di32"></a><a href="timestep_block_p.html#timestep_blocki31" target="origFile"><code class="comment">! Spectral radius in i-direction.</code></a>
<a name="timestep_block_spatial_di33"></a>            <a href="timestep_block_p.html#timestep_blocki31" target="origFile">sx = si(i-<code class="constant">1</code>, j, k, <code class="constant">1</code>) + si(i, j, k, <code class="constant">1</code>)</a>
<a name="timestep_block_spatial_di34"></a>            <a href="timestep_block_p.html#timestep_blocki32" target="origFile">sy = si(i-<code class="constant">1</code>, j, k, <code class="constant">2</code>) + si(i, j, k, <code class="constant">2</code>)</a>
            <a href="timestep_block_p.html#timestep_blocki33" target="origFile">sz = si(i-<code class="constant">1</code>, j, k, <code class="constant">3</code>) + si(i, j, k, <code class="constant">3</code>)</a>
<a name="timestep_block_spatial_di35"></a>            <a href="timestep_block_p.html#timestep_blocki34" target="origFile">qsd = sx*uxd + sy*uyd + sz*uzd</a>
<a name="timestep_block_spatial_di37"></a>            <a href="timestep_block_p.html#timestep_blocki34" target="origFile">qs = ux*sx + uy*sy + uz*sz - sface</a>
            <a href="timestep_block_p.html#timestep_blocki35" target="origFile"><code class="keyword">IF</code> (qs .GE. <code class="constant">0.</code>) <code class="keyword">THEN</code></a>
              <a href="timestep_block_p.html#timestep_blocki37" target="origFile">abs1d = qsd</a>
<a name="timestep_block_spatial_di36"></a>              <a href="timestep_block_p.html#timestep_blocki37" target="origFile">abs1 = qs</a>
            <a href="timestep_block_p.html#timestep_blocki35" target="origFile"><code class="keyword">ELSE</code></a>
              <a href="timestep_block_p.html#timestep_blocki36" target="origFile">abs1d = -qsd</a>
<a name="timestep_block_spatial_di38"></a>              <a href="timestep_block_p.html#timestep_blocki36" target="origFile">abs1 = -qs</a>
            <a href="timestep_block_p.html#timestep_blocki35" target="origFile"><code class="keyword">END IF</code></a>
<a name="timestep_block_spatial_di39"></a>            <a href="timestep_block_p.html#timestep_blocki38" target="origFile">arg1d = (sx**<code class="constant">2</code>+sy**<code class="constant">2</code>+sz**<code class="constant">2</code>)*cc2d</a>
            <a href="timestep_block_p.html#timestep_blocki38" target="origFile">arg1 = cc2*(sx**<code class="constant">2</code>+sy**<code class="constant">2</code>+sz**<code class="constant">2</code>)</a>
            <a href="timestep_block_p.html#timestep_blocki39" target="origFile"><code class="keyword">IF</code> (arg1 .EQ. <code class="constant">0.0</code>) <code class="keyword">THEN</code></a>
              <a href="timestep_block_p.html#timestep_blocki39" target="origFile">result1d = <code class="constant">0.0</code></a>
            <a href="timestep_block_p.html#timestep_blocki39" target="origFile"><code class="keyword">ELSE</code></a>
              <a href="timestep_block_p.html#timestep_blocki39" target="origFile">result1d = arg1d/(<code class="constant">2.0</code>*<code class="funcname">SQRT</code>(arg1))</a>
<a name="timestep_block_spatial_di40"></a>            <a href="timestep_block_p.html#timestep_blocki39" target="origFile"><code class="keyword">END IF</code></a>
            <a href="timestep_block_p.html#timestep_blocki39" target="origFile">result1 = <code class="funcname">SQRT</code>(arg1)</a>
<a name="timestep_block_spatial_di41"></a>            <a href="timestep_block_p.html#timestep_blocki40" target="origFile">radid(i, j, k) = half*(abs1d+result1d)</a>
<a name="timestep_block_spatial_di42"></a>            <a href="timestep_block_p.html#timestep_blocki40" target="origFile">radi(i, j, k) = half*(abs1+result1)</a>
<a href="timestep_block_p.html#timestep_blocki41" target="origFile"><code class="comment">! The grid velocity in j-direction.</code></a>
<a name="timestep_block_spatial_di43"></a>            <a href="timestep_block_p.html#timestep_blocki41" target="origFile"><code class="keyword">IF</code> (addgridvelocities) </a><a href="timestep_block_p.html#timestep_blocki42" target="origFile">sface = sfacej(i, j-<code class="constant">1</code>, k) + sfacej(i<code class="label">&</code></a>
<a href="timestep_block_p.html#timestep_blocki42" target="origFile"><code class="label">&                </code>, j, k)</a>
<a name="timestep_block_spatial_di44"></a><a href="timestep_block_p.html#timestep_blocki43" target="origFile"><code class="comment">! Spectral radius in j-direction.</code></a>
<a name="timestep_block_spatial_di45"></a>            <a href="timestep_block_p.html#timestep_blocki43" target="origFile">sx = sj(i, j-<code class="constant">1</code>, k, <code class="constant">1</code>) + sj(i, j, k, <code class="constant">1</code>)</a>
<a name="timestep_block_spatial_di46"></a>            <a href="timestep_block_p.html#timestep_blocki44" target="origFile">sy = sj(i, j-<code class="constant">1</code>, k, <code class="constant">2</code>) + sj(i, j, k, <code class="constant">2</code>)</a>
            <a href="timestep_block_p.html#timestep_blocki45" target="origFile">sz = sj(i, j-<code class="constant">1</code>, k, <code class="constant">3</code>) + sj(i, j, k, <code class="constant">3</code>)</a>
<a name="timestep_block_spatial_di47"></a>            <a href="timestep_block_p.html#timestep_blocki46" target="origFile">qsd = sx*uxd + sy*uyd + sz*uzd</a>
<a name="timestep_block_spatial_di49"></a>            <a href="timestep_block_p.html#timestep_blocki46" target="origFile">qs = ux*sx + uy*sy + uz*sz - sface</a>
            <a href="timestep_block_p.html#timestep_blocki47" target="origFile"><code class="keyword">IF</code> (qs .GE. <code class="constant">0.</code>) <code class="keyword">THEN</code></a>
              <a href="timestep_block_p.html#timestep_blocki49" target="origFile">abs2d = qsd</a>
<a name="timestep_block_spatial_di48"></a>              <a href="timestep_block_p.html#timestep_blocki49" target="origFile">abs2 = qs</a>
            <a href="timestep_block_p.html#timestep_blocki47" target="origFile"><code class="keyword">ELSE</code></a>
              <a href="timestep_block_p.html#timestep_blocki48" target="origFile">abs2d = -qsd</a>
<a name="timestep_block_spatial_di50"></a>              <a href="timestep_block_p.html#timestep_blocki48" target="origFile">abs2 = -qs</a>
            <a href="timestep_block_p.html#timestep_blocki47" target="origFile"><code class="keyword">END IF</code></a>
<a name="timestep_block_spatial_di51"></a>            <a href="timestep_block_p.html#timestep_blocki50" target="origFile">arg1d = (sx**<code class="constant">2</code>+sy**<code class="constant">2</code>+sz**<code class="constant">2</code>)*cc2d</a>
            <a href="timestep_block_p.html#timestep_blocki50" target="origFile">arg1 = cc2*(sx**<code class="constant">2</code>+sy**<code class="constant">2</code>+sz**<code class="constant">2</code>)</a>
            <a href="timestep_block_p.html#timestep_blocki51" target="origFile"><code class="keyword">IF</code> (arg1 .EQ. <code class="constant">0.0</code>) <code class="keyword">THEN</code></a>
              <a href="timestep_block_p.html#timestep_blocki51" target="origFile">result1d = <code class="constant">0.0</code></a>
            <a href="timestep_block_p.html#timestep_blocki51" target="origFile"><code class="keyword">ELSE</code></a>
              <a href="timestep_block_p.html#timestep_blocki51" target="origFile">result1d = arg1d/(<code class="constant">2.0</code>*<code class="funcname">SQRT</code>(arg1))</a>
<a name="timestep_block_spatial_di52"></a>            <a href="timestep_block_p.html#timestep_blocki51" target="origFile"><code class="keyword">END IF</code></a>
            <a href="timestep_block_p.html#timestep_blocki51" target="origFile">result1 = <code class="funcname">SQRT</code>(arg1)</a>
<a name="timestep_block_spatial_di53"></a>            <a href="timestep_block_p.html#timestep_blocki52" target="origFile">radjd(i, j, k) = half*(abs2d+result1d)</a>
<a name="timestep_block_spatial_di54"></a>            <a href="timestep_block_p.html#timestep_blocki52" target="origFile">radj(i, j, k) = half*(abs2+result1)</a>
<a href="timestep_block_p.html#timestep_blocki53" target="origFile"><code class="comment">! The grid velocity in k-direction.</code></a>
<a name="timestep_block_spatial_di55"></a>            <a href="timestep_block_p.html#timestep_blocki53" target="origFile"><code class="keyword">IF</code> (addgridvelocities) </a><a href="timestep_block_p.html#timestep_blocki54" target="origFile">sface = sfacek(i, j, k-<code class="constant">1</code>) + sfacek(i<code class="label">&</code></a>
<a href="timestep_block_p.html#timestep_blocki54" target="origFile"><code class="label">&                </code>, j, k)</a>
<a name="timestep_block_spatial_di56"></a><a href="timestep_block_p.html#timestep_blocki55" target="origFile"><code class="comment">! Spectral radius in k-direction.</code></a>
<a name="timestep_block_spatial_di57"></a>            <a href="timestep_block_p.html#timestep_blocki55" target="origFile">sx = sk(i, j, k-<code class="constant">1</code>, <code class="constant">1</code>) + sk(i, j, k, <code class="constant">1</code>)</a>
<a name="timestep_block_spatial_di58"></a>            <a href="timestep_block_p.html#timestep_blocki56" target="origFile">sy = sk(i, j, k-<code class="constant">1</code>, <code class="constant">2</code>) + sk(i, j, k, <code class="constant">2</code>)</a>
            <a href="timestep_block_p.html#timestep_blocki57" target="origFile">sz = sk(i, j, k-<code class="constant">1</code>, <code class="constant">3</code>) + sk(i, j, k, <code class="constant">3</code>)</a>
<a name="timestep_block_spatial_di59"></a>            <a href="timestep_block_p.html#timestep_blocki58" target="origFile">qsd = sx*uxd + sy*uyd + sz*uzd</a>
<a name="timestep_block_spatial_di61"></a>            <a href="timestep_block_p.html#timestep_blocki58" target="origFile">qs = ux*sx + uy*sy + uz*sz - sface</a>
            <a href="timestep_block_p.html#timestep_blocki59" target="origFile"><code class="keyword">IF</code> (qs .GE. <code class="constant">0.</code>) <code class="keyword">THEN</code></a>
              <a href="timestep_block_p.html#timestep_blocki61" target="origFile">abs3d = qsd</a>
<a name="timestep_block_spatial_di60"></a>              <a href="timestep_block_p.html#timestep_blocki61" target="origFile">abs3 = qs</a>
            <a href="timestep_block_p.html#timestep_blocki59" target="origFile"><code class="keyword">ELSE</code></a>
              <a href="timestep_block_p.html#timestep_blocki60" target="origFile">abs3d = -qsd</a>
<a name="timestep_block_spatial_di62"></a>              <a href="timestep_block_p.html#timestep_blocki60" target="origFile">abs3 = -qs</a>
            <a href="timestep_block_p.html#timestep_blocki59" target="origFile"><code class="keyword">END IF</code></a>
<a name="timestep_block_spatial_di63"></a>            <a href="timestep_block_p.html#timestep_blocki62" target="origFile">arg1d = (sx**<code class="constant">2</code>+sy**<code class="constant">2</code>+sz**<code class="constant">2</code>)*cc2d</a>
            <a href="timestep_block_p.html#timestep_blocki62" target="origFile">arg1 = cc2*(sx**<code class="constant">2</code>+sy**<code class="constant">2</code>+sz**<code class="constant">2</code>)</a>
            <a href="timestep_block_p.html#timestep_blocki63" target="origFile"><code class="keyword">IF</code> (arg1 .EQ. <code class="constant">0.0</code>) <code class="keyword">THEN</code></a>
              <a href="timestep_block_p.html#timestep_blocki63" target="origFile">result1d = <code class="constant">0.0</code></a>
            <a href="timestep_block_p.html#timestep_blocki63" target="origFile"><code class="keyword">ELSE</code></a>
              <a href="timestep_block_p.html#timestep_blocki63" target="origFile">result1d = arg1d/(<code class="constant">2.0</code>*<code class="funcname">SQRT</code>(arg1))</a>
<a name="timestep_block_spatial_di64"></a>            <a href="timestep_block_p.html#timestep_blocki63" target="origFile"><code class="keyword">END IF</code></a>
            <a href="timestep_block_p.html#timestep_blocki63" target="origFile">result1 = <code class="funcname">SQRT</code>(arg1)</a>
<a name="timestep_block_spatial_di65"></a>            <a href="timestep_block_p.html#timestep_blocki64" target="origFile">radkd(i, j, k) = half*(abs3d+result1d)</a>
            <a href="timestep_block_p.html#timestep_blocki64" target="origFile">radk(i, j, k) = half*(abs3+result1)</a>
<a href="timestep_block_p.html#timestep_blocki65" target="origFile"><code class="comment">! Compute the inviscid contribution to the time step.</code></a>
            <a href="timestep_block_p.html#timestep_blocki65" target="origFile">dtl(i, j, k) = radi(i, j, k) + radj(i, j, k) + radk(i, j, k)</a>
          <a href="timestep_block_p.html#timestep_blocki24" target="origFile"><code class="keyword">END DO</code></a>
        <a href="timestep_block_p.html#timestep_blocki23" target="origFile"><code class="keyword">END DO</code></a>
<a name="timestep_block_spatial_di66"></a>      <a href="timestep_block_p.html#timestep_blocki22" target="origFile"><code class="keyword">END DO</code></a>
    <a href="timestep_block_p.html#timestep_blocki21" target="origFile"><code class="keyword">CASE </code>(turkel) </a>
      <a href="timestep_block_p.html#timestep_blocki66" target="origFile"><code class="keyword">CALL </code><code class="funcname">TERMINATE_CD</code>(<code class="string">'timeStep'</code>, <code class="label">&</code></a>
<a href="timestep_block_p.html#timestep_blocki66" target="origFile"><code class="label">&                  </code><code class="string">'Turkel preconditioner not implemented yet'</code>)</a>
      <a href="timestep_block_p.html#timestep_blocki21" target="origFile">radid = <code class="constant">0.0</code></a>
      <a href="timestep_block_p.html#timestep_blocki21" target="origFile">radjd = <code class="constant">0.0</code></a>
<a name="timestep_block_spatial_di67"></a>      <a href="timestep_block_p.html#timestep_blocki21" target="origFile">radkd = <code class="constant">0.0</code></a>
    <a href="timestep_block_p.html#timestep_blocki21" target="origFile"><code class="keyword">CASE </code>(choimerkle) </a>
      <a href="timestep_block_p.html#timestep_blocki67" target="origFile"><code class="keyword">CALL </code><code class="funcname">TERMINATE_CD</code>(<code class="string">'timeStep'</code>, <code class="label">&</code></a>
<a href="timestep_block_p.html#timestep_blocki67" target="origFile"><code class="label">&                  </code><code class="string">'choi merkle preconditioner not implemented yet'</code>)</a>
      <a href="timestep_block_p.html#timestep_blocki21" target="origFile">radid = <code class="constant">0.0</code></a>
      <a href="timestep_block_p.html#timestep_blocki21" target="origFile">radjd = <code class="constant">0.0</code></a>
      <a href="timestep_block_p.html#timestep_blocki21" target="origFile">radkd = <code class="constant">0.0</code></a>
    <a href="timestep_block_p.html#timestep_blocki21" target="origFile"><code class="keyword">CASE DEFAULT</code></a>
      <a href="timestep_block_p.html#timestep_blocki21" target="origFile">radid = <code class="constant">0.0</code></a>
      <a href="timestep_block_p.html#timestep_blocki21" target="origFile">radjd = <code class="constant">0.0</code></a>
<a name="timestep_block_spatial_di68"></a>      <a href="timestep_block_p.html#timestep_blocki21" target="origFile">radkd = <code class="constant">0.0</code></a>
    <a href="timestep_block_p.html#timestep_blocki21" target="origFile"><code class="keyword">END SELECT</code></a>
<a href="timestep_block_p.html#timestep_blocki68" target="origFile"><code class="comment">!</code></a>
<a href="timestep_block_p.html#timestep_blocki68" target="origFile"><code class="comment">!          **************************************************************</code></a>
<a href="timestep_block_p.html#timestep_blocki68" target="origFile"><code class="comment">!          *                                                            *</code></a>
<a href="timestep_block_p.html#timestep_blocki68" target="origFile"><code class="comment">!          * Adapt the spectral radii if directional scaling must be    *</code></a>
<a href="timestep_block_p.html#timestep_blocki68" target="origFile"><code class="comment">!          * applied.                                                   *</code></a>
<a href="timestep_block_p.html#timestep_blocki68" target="origFile"><code class="comment">!          *                                                            *</code></a>
<a href="timestep_block_p.html#timestep_blocki68" target="origFile"><code class="comment">!          **************************************************************</code></a>
<a name="timestep_block_spatial_di69"></a><a href="timestep_block_p.html#timestep_blocki68" target="origFile"><code class="comment">!</code></a>
    <a href="timestep_block_p.html#timestep_blocki68" target="origFile"><code class="keyword">IF</code> (dirscaling .AND. currentlevel .LE. groundlevel) <code class="keyword">THEN</code></a>
<a name="timestep_block_spatial_di70"></a><a href="timestep_block_p.html#timestep_blocki69" target="origFile"><code class="comment">! if( dirScaling ) then</code></a>
<a name="timestep_block_spatial_di71"></a>      <a href="timestep_block_p.html#timestep_blocki69" target="origFile"><code class="keyword">DO </code>k=<code class="constant">1</code>,ke</a>
<a name="timestep_block_spatial_di72"></a>        <a href="timestep_block_p.html#timestep_blocki70" target="origFile"><code class="keyword">DO </code>j=<code class="constant">1</code>,je</a>
<a name="timestep_block_spatial_di74"></a>          <a href="timestep_block_p.html#timestep_blocki71" target="origFile"><code class="keyword">DO </code>i=<code class="constant">1</code>,ie</a>
            <a href="timestep_block_p.html#timestep_blocki72" target="origFile"><code class="keyword">IF</code> (radi(i, j, k) .LT. eps) <code class="keyword">THEN</code></a>
              <a href="timestep_block_p.html#timestep_blocki74" target="origFile">ri = eps</a>
<a name="timestep_block_spatial_di73"></a>              <a href="timestep_block_p.html#timestep_blocki72" target="origFile">rid = <code class="constant">0.0</code></a>
            <a href="timestep_block_p.html#timestep_blocki72" target="origFile"><code class="keyword">ELSE</code></a>
              <a href="timestep_block_p.html#timestep_blocki73" target="origFile">rid = radid(i, j, k)</a>
<a name="timestep_block_spatial_di75"></a>              <a href="timestep_block_p.html#timestep_blocki73" target="origFile">ri = radi(i, j, k)</a>
<a name="timestep_block_spatial_di77"></a>            <a href="timestep_block_p.html#timestep_blocki72" target="origFile"><code class="keyword">END IF</code></a>
            <a href="timestep_block_p.html#timestep_blocki75" target="origFile"><code class="keyword">IF</code> (radj(i, j, k) .LT. eps) <code class="keyword">THEN</code></a>
              <a href="timestep_block_p.html#timestep_blocki77" target="origFile">rj = eps</a>
<a name="timestep_block_spatial_di76"></a>              <a href="timestep_block_p.html#timestep_blocki75" target="origFile">rjd = <code class="constant">0.0</code></a>
            <a href="timestep_block_p.html#timestep_blocki75" target="origFile"><code class="keyword">ELSE</code></a>
              <a href="timestep_block_p.html#timestep_blocki76" target="origFile">rjd = radjd(i, j, k)</a>
<a name="timestep_block_spatial_di78"></a>              <a href="timestep_block_p.html#timestep_blocki76" target="origFile">rj = radj(i, j, k)</a>
<a name="timestep_block_spatial_di80"></a>            <a href="timestep_block_p.html#timestep_blocki75" target="origFile"><code class="keyword">END IF</code></a>
            <a href="timestep_block_p.html#timestep_blocki78" target="origFile"><code class="keyword">IF</code> (radk(i, j, k) .LT. eps) <code class="keyword">THEN</code></a>
              <a href="timestep_block_p.html#timestep_blocki80" target="origFile">rk = eps</a>
<a name="timestep_block_spatial_di79"></a>              <a href="timestep_block_p.html#timestep_blocki78" target="origFile">rkd = <code class="constant">0.0</code></a>
            <a href="timestep_block_p.html#timestep_blocki78" target="origFile"><code class="keyword">ELSE</code></a>
              <a href="timestep_block_p.html#timestep_blocki79" target="origFile">rkd = radkd(i, j, k)</a>
<a name="timestep_block_spatial_di81"></a>              <a href="timestep_block_p.html#timestep_blocki79" target="origFile">rk = radk(i, j, k)</a>
            <a href="timestep_block_p.html#timestep_blocki78" target="origFile"><code class="keyword">END IF</code></a>
<a href="timestep_block_p.html#timestep_blocki81" target="origFile"><code class="comment">! Compute the scaling in the three coordinate</code></a>
<a href="timestep_block_p.html#timestep_blocki81" target="origFile"><code class="comment">! directions.</code></a>
<a name="timestep_block_spatial_di82"></a>            <a href="timestep_block_p.html#timestep_blocki81" target="origFile">pwx1d = (rid*rj-ri*rjd)/rj**<code class="constant">2</code></a>
            <a href="timestep_block_p.html#timestep_blocki81" target="origFile">pwx1 = ri/rj</a>
            <a href="timestep_block_p.html#timestep_blocki82" target="origFile"><code class="keyword">IF</code> (pwx1 .GT. <code class="constant">0.0 </code>.OR. (pwx1 .LT. <code class="constant">0.0 </code>.AND. adis .EQ. <code class="funcname">INT</code>(<code class="label">&</code></a>
<a href="timestep_block_p.html#timestep_blocki82" target="origFile"><code class="label">&                </code>adis))) <code class="keyword">THEN</code></a>
              <a href="timestep_block_p.html#timestep_blocki82" target="origFile">rijd = adis*pwx1**(adis-<code class="constant">1</code>)*pwx1d</a>
            <a href="timestep_block_p.html#timestep_blocki82" target="origFile"><code class="keyword">ELSE IF</code> (pwx1 .EQ. <code class="constant">0.0 </code>.AND. adis .EQ. <code class="constant">1.0</code>) <code class="keyword">THEN</code></a>
              <a href="timestep_block_p.html#timestep_blocki82" target="origFile">rijd = pwx1d</a>
            <a href="timestep_block_p.html#timestep_blocki82" target="origFile"><code class="keyword">ELSE</code></a>
              <a href="timestep_block_p.html#timestep_blocki82" target="origFile">rijd = <code class="constant">0.0</code></a>
<a name="timestep_block_spatial_di83"></a>            <a href="timestep_block_p.html#timestep_blocki82" target="origFile"><code class="keyword">END IF</code></a>
            <a href="timestep_block_p.html#timestep_blocki82" target="origFile">rij = pwx1**adis</a>
<a name="timestep_block_spatial_di84"></a>            <a href="timestep_block_p.html#timestep_blocki83" target="origFile">pwx1d = (rjd*rk-rj*rkd)/rk**<code class="constant">2</code></a>
            <a href="timestep_block_p.html#timestep_blocki83" target="origFile">pwx1 = rj/rk</a>
            <a href="timestep_block_p.html#timestep_blocki84" target="origFile"><code class="keyword">IF</code> (pwx1 .GT. <code class="constant">0.0 </code>.OR. (pwx1 .LT. <code class="constant">0.0 </code>.AND. adis .EQ. <code class="funcname">INT</code>(<code class="label">&</code></a>
<a href="timestep_block_p.html#timestep_blocki84" target="origFile"><code class="label">&                </code>adis))) <code class="keyword">THEN</code></a>
              <a href="timestep_block_p.html#timestep_blocki84" target="origFile">rjkd = adis*pwx1**(adis-<code class="constant">1</code>)*pwx1d</a>
            <a href="timestep_block_p.html#timestep_blocki84" target="origFile"><code class="keyword">ELSE IF</code> (pwx1 .EQ. <code class="constant">0.0 </code>.AND. adis .EQ. <code class="constant">1.0</code>) <code class="keyword">THEN</code></a>
              <a href="timestep_block_p.html#timestep_blocki84" target="origFile">rjkd = pwx1d</a>
            <a href="timestep_block_p.html#timestep_blocki84" target="origFile"><code class="keyword">ELSE</code></a>
              <a href="timestep_block_p.html#timestep_blocki84" target="origFile">rjkd = <code class="constant">0.0</code></a>
<a name="timestep_block_spatial_di85"></a>            <a href="timestep_block_p.html#timestep_blocki84" target="origFile"><code class="keyword">END IF</code></a>
            <a href="timestep_block_p.html#timestep_blocki84" target="origFile">rjk = pwx1**adis</a>
<a name="timestep_block_spatial_di86"></a>            <a href="timestep_block_p.html#timestep_blocki85" target="origFile">pwx1d = (rkd*ri-rk*rid)/ri**<code class="constant">2</code></a>
            <a href="timestep_block_p.html#timestep_blocki85" target="origFile">pwx1 = rk/ri</a>
            <a href="timestep_block_p.html#timestep_blocki86" target="origFile"><code class="keyword">IF</code> (pwx1 .GT. <code class="constant">0.0 </code>.OR. (pwx1 .LT. <code class="constant">0.0 </code>.AND. adis .EQ. <code class="funcname">INT</code>(<code class="label">&</code></a>
<a href="timestep_block_p.html#timestep_blocki86" target="origFile"><code class="label">&                </code>adis))) <code class="keyword">THEN</code></a>
              <a href="timestep_block_p.html#timestep_blocki86" target="origFile">rkid = adis*pwx1**(adis-<code class="constant">1</code>)*pwx1d</a>
            <a href="timestep_block_p.html#timestep_blocki86" target="origFile"><code class="keyword">ELSE IF</code> (pwx1 .EQ. <code class="constant">0.0 </code>.AND. adis .EQ. <code class="constant">1.0</code>) <code class="keyword">THEN</code></a>
              <a href="timestep_block_p.html#timestep_blocki86" target="origFile">rkid = pwx1d</a>
            <a href="timestep_block_p.html#timestep_blocki86" target="origFile"><code class="keyword">ELSE</code></a>
              <a href="timestep_block_p.html#timestep_blocki86" target="origFile">rkid = <code class="constant">0.0</code></a>
<a name="timestep_block_spatial_di87"></a>            <a href="timestep_block_p.html#timestep_blocki86" target="origFile"><code class="keyword">END IF</code></a>
            <a href="timestep_block_p.html#timestep_blocki86" target="origFile">rki = pwx1**adis</a>
<a href="timestep_block_p.html#timestep_blocki87" target="origFile"><code class="comment">! Create the scaled versions of the aspect ratios.</code></a>
<a href="timestep_block_p.html#timestep_blocki87" target="origFile"><code class="comment">! Note that the multiplication is done with radi, radJ</code></a>
<a href="timestep_block_p.html#timestep_blocki87" target="origFile"><code class="comment">! and radK, such that the influence of the clipping</code></a>
<a href="timestep_block_p.html#timestep_blocki87" target="origFile"><code class="comment">! is negligible.</code></a>
<a href="timestep_block_p.html#timestep_blocki87" target="origFile"><code class="comment">!   radi(i,j,k) = third*radi(i,j,k)*(one + one/rij + rki)</code></a>
<a href="timestep_block_p.html#timestep_blocki87" target="origFile"><code class="comment">!   radJ(i,j,k) = third*radJ(i,j,k)*(one + one/rjk + rij)</code></a>
<a href="timestep_block_p.html#timestep_blocki87" target="origFile"><code class="comment">!   radK(i,j,k) = third*radK(i,j,k)*(one + one/rki + rjk)</code></a>
            <a href="timestep_block_p.html#timestep_blocki87" target="origFile">radid(i, j, k) = radid(i, j, k)*(one+one/rij+rki) + radi(i, <code class="label">&</code></a>
<a name="timestep_block_spatial_di88"></a><a href="timestep_block_p.html#timestep_blocki87" target="origFile"><code class="label">&              </code>j, k)*(rkid-one*rijd/rij**<code class="constant">2</code>)</a>
            <a href="timestep_block_p.html#timestep_blocki87" target="origFile">radi(i, j, k) = radi(i, j, k)*(one+one/rij+rki)</a>
            <a href="timestep_block_p.html#timestep_blocki88" target="origFile">radjd(i, j, k) = radjd(i, j, k)*(one+one/rjk+rij) + radj(i, <code class="label">&</code></a>
<a name="timestep_block_spatial_di89"></a><a href="timestep_block_p.html#timestep_blocki88" target="origFile"><code class="label">&              </code>j, k)*(rijd-one*rjkd/rjk**<code class="constant">2</code>)</a>
            <a href="timestep_block_p.html#timestep_blocki88" target="origFile">radj(i, j, k) = radj(i, j, k)*(one+one/rjk+rij)</a>
            <a href="timestep_block_p.html#timestep_blocki89" target="origFile">radkd(i, j, k) = radkd(i, j, k)*(one+one/rki+rjk) + radk(i, <code class="label">&</code></a>
<a href="timestep_block_p.html#timestep_blocki89" target="origFile"><code class="label">&              </code>j, k)*(rjkd-one*rkid/rki**<code class="constant">2</code>)</a>
            <a href="timestep_block_p.html#timestep_blocki89" target="origFile">radk(i, j, k) = radk(i, j, k)*(one+one/rki+rjk)</a>
          <a href="timestep_block_p.html#timestep_blocki71" target="origFile"><code class="keyword">END DO</code></a>
        <a href="timestep_block_p.html#timestep_blocki70" target="origFile"><code class="keyword">END DO</code></a>
<a name="timestep_block_spatial_di90"></a>      <a href="timestep_block_p.html#timestep_blocki69" target="origFile"><code class="keyword">END DO</code></a>
    <a href="timestep_block_p.html#timestep_blocki68" target="origFile"><code class="keyword">END IF</code></a>
<a href="timestep_block_p.html#timestep_blocki90" target="origFile"><code class="comment">! The rest of this file can be skipped if only the spectral</code></a>
<a name="timestep_block_spatial_di91"></a><a href="timestep_block_p.html#timestep_blocki90" target="origFile"><code class="comment">! radii need to be computed.</code></a>
    <a href="timestep_block_p.html#timestep_blocki90" target="origFile"><code class="keyword">IF</code> (.NOT.onlyradii) <code class="keyword">THEN</code></a>
<a name="timestep_block_spatial_di92"></a><a href="timestep_block_p.html#timestep_blocki91" target="origFile"><code class="comment">! The viscous contribution, if needed.</code></a>
      <a href="timestep_block_p.html#timestep_blocki91" target="origFile"><code class="keyword">IF</code> (viscous) <code class="keyword">THEN</code></a>
<a name="timestep_block_spatial_di93"></a><a href="timestep_block_p.html#timestep_blocki92" target="origFile"><code class="comment">! Loop over the owned cell centers.</code></a>
<a name="timestep_block_spatial_di94"></a>        <a href="timestep_block_p.html#timestep_blocki92" target="origFile"><code class="keyword">DO </code>k=<code class="constant">2</code>,kl</a>
<a name="timestep_block_spatial_di95"></a>          <a href="timestep_block_p.html#timestep_blocki93" target="origFile"><code class="keyword">DO </code>j=<code class="constant">2</code>,jl</a>
            <a href="timestep_block_p.html#timestep_blocki94" target="origFile"><code class="keyword">DO </code>i=<code class="constant">2</code>,il</a>
<a href="timestep_block_p.html#timestep_blocki95" target="origFile"><code class="comment">! Compute the effective viscosity coefficient. The</code></a>
<a href="timestep_block_p.html#timestep_blocki95" target="origFile"><code class="comment">! factor 0.5 is a combination of two things. In the</code></a>
<a href="timestep_block_p.html#timestep_blocki95" target="origFile"><code class="comment">! standard central discretization of a second</code></a>
<a href="timestep_block_p.html#timestep_blocki95" target="origFile"><code class="comment">! derivative there is a factor 2 multiplying the</code></a>
<a href="timestep_block_p.html#timestep_blocki95" target="origFile"><code class="comment">! central node. However in the code below not the</code></a>
<a href="timestep_block_p.html#timestep_blocki95" target="origFile"><code class="comment">! average but the sum of the left and the right face</code></a>
<a href="timestep_block_p.html#timestep_blocki95" target="origFile"><code class="comment">! is taken and squared. This leads to a factor 4.</code></a>
<a href="timestep_block_p.html#timestep_blocki95" target="origFile"><code class="comment">! Combining both effects leads to 0.5. Furthermore,</code></a>
<a href="timestep_block_p.html#timestep_blocki95" target="origFile"><code class="comment">! it is divided by the volume and density to obtain</code></a>
<a href="timestep_block_p.html#timestep_blocki95" target="origFile"><code class="comment">! the correct dimensions and multiplied by the</code></a>
<a name="timestep_block_spatial_di97"></a><a name="timestep_block_spatial_di96"></a><a href="timestep_block_p.html#timestep_blocki95" target="origFile"><code class="comment">! non-dimensional factor factVis.</code></a>
<a name="timestep_block_spatial_di98"></a>              <a href="timestep_block_p.html#timestep_blocki95" target="origFile">rmu = rlv(i, j, k)</a>
<a name="timestep_block_spatial_di99"></a>              <a href="timestep_block_p.html#timestep_blocki96" target="origFile"><code class="keyword">IF</code> (eddymodel) </a><a href="timestep_block_p.html#timestep_blocki97" target="origFile">rmu = rmu + rev(i, j, k)</a>
              <a href="timestep_block_p.html#timestep_blocki98" target="origFile">rmu = half*rmu/(w(i, j, k, irho)*vol(i, j, k))</a>
<a href="timestep_block_p.html#timestep_blocki99" target="origFile"><code class="comment">! Add the viscous contribution in i-direction to the</code></a>
<a name="timestep_block_spatial_di100"></a><a href="timestep_block_p.html#timestep_blocki99" target="origFile"><code class="comment">! (inverse) of the time step.</code></a>
<a name="timestep_block_spatial_di101"></a>              <a href="timestep_block_p.html#timestep_blocki99" target="origFile">sx = si(i, j, k, <code class="constant">1</code>) + si(i-<code class="constant">1</code>, j, k, <code class="constant">1</code>)</a>
<a name="timestep_block_spatial_di102"></a>              <a href="timestep_block_p.html#timestep_blocki100" target="origFile">sy = si(i, j, k, <code class="constant">2</code>) + si(i-<code class="constant">1</code>, j, k, <code class="constant">2</code>)</a>
<a name="timestep_block_spatial_di103"></a>              <a href="timestep_block_p.html#timestep_blocki101" target="origFile">sz = si(i, j, k, <code class="constant">3</code>) + si(i-<code class="constant">1</code>, j, k, <code class="constant">3</code>)</a>
<a name="timestep_block_spatial_di104"></a>              <a href="timestep_block_p.html#timestep_blocki102" target="origFile">vsi = rmu*(sx*sx+sy*sy+sz*sz)</a>
              <a href="timestep_block_p.html#timestep_blocki103" target="origFile">dtl(i, j, k) = dtl(i, j, k) + vsi</a>
<a href="timestep_block_p.html#timestep_blocki104" target="origFile"><code class="comment">! Add the viscous contribution in j-direction to the</code></a>
<a name="timestep_block_spatial_di105"></a><a href="timestep_block_p.html#timestep_blocki104" target="origFile"><code class="comment">! (inverse) of the time step.</code></a>
<a name="timestep_block_spatial_di106"></a>              <a href="timestep_block_p.html#timestep_blocki104" target="origFile">sx = sj(i, j, k, <code class="constant">1</code>) + sj(i, j-<code class="constant">1</code>, k, <code class="constant">1</code>)</a>
<a name="timestep_block_spatial_di107"></a>              <a href="timestep_block_p.html#timestep_blocki105" target="origFile">sy = sj(i, j, k, <code class="constant">2</code>) + sj(i, j-<code class="constant">1</code>, k, <code class="constant">2</code>)</a>
<a name="timestep_block_spatial_di108"></a>              <a href="timestep_block_p.html#timestep_blocki106" target="origFile">sz = sj(i, j, k, <code class="constant">3</code>) + sj(i, j-<code class="constant">1</code>, k, <code class="constant">3</code>)</a>
<a name="timestep_block_spatial_di109"></a>              <a href="timestep_block_p.html#timestep_blocki107" target="origFile">vsj = rmu*(sx*sx+sy*sy+sz*sz)</a>
              <a href="timestep_block_p.html#timestep_blocki108" target="origFile">dtl(i, j, k) = dtl(i, j, k) + vsj</a>
<a href="timestep_block_p.html#timestep_blocki109" target="origFile"><code class="comment">! Add the viscous contribution in k-direction to the</code></a>
<a name="timestep_block_spatial_di110"></a><a href="timestep_block_p.html#timestep_blocki109" target="origFile"><code class="comment">! (inverse) of the time step.</code></a>
<a name="timestep_block_spatial_di111"></a>              <a href="timestep_block_p.html#timestep_blocki109" target="origFile">sx = sk(i, j, k, <code class="constant">1</code>) + sk(i, j, k-<code class="constant">1</code>, <code class="constant">1</code>)</a>
<a name="timestep_block_spatial_di112"></a>              <a href="timestep_block_p.html#timestep_blocki110" target="origFile">sy = sk(i, j, k, <code class="constant">2</code>) + sk(i, j, k-<code class="constant">1</code>, <code class="constant">2</code>)</a>
<a name="timestep_block_spatial_di113"></a>              <a href="timestep_block_p.html#timestep_blocki111" target="origFile">sz = sk(i, j, k, <code class="constant">3</code>) + sk(i, j, k-<code class="constant">1</code>, <code class="constant">3</code>)</a>
              <a href="timestep_block_p.html#timestep_blocki112" target="origFile">vsk = rmu*(sx*sx+sy*sy+sz*sz)</a>
              <a href="timestep_block_p.html#timestep_blocki113" target="origFile">dtl(i, j, k) = dtl(i, j, k) + vsk</a>
            <a href="timestep_block_p.html#timestep_blocki94" target="origFile"><code class="keyword">END DO</code></a>
          <a href="timestep_block_p.html#timestep_blocki93" target="origFile"><code class="keyword">END DO</code></a>
<a name="timestep_block_spatial_di114"></a>        <a href="timestep_block_p.html#timestep_blocki92" target="origFile"><code class="keyword">END DO</code></a>
      <a href="timestep_block_p.html#timestep_blocki91" target="origFile"><code class="keyword">END IF</code></a>
<a href="timestep_block_p.html#timestep_blocki114" target="origFile"><code class="comment">! For the spectral mode an additional term term must be</code></a>
<a href="timestep_block_p.html#timestep_blocki114" target="origFile"><code class="comment">! taken into account, which corresponds to the contribution</code></a>
<a name="timestep_block_spatial_di115"></a><a href="timestep_block_p.html#timestep_blocki114" target="origFile"><code class="comment">! of the highest frequency.</code></a>
      <a href="timestep_block_p.html#timestep_blocki114" target="origFile"><code class="keyword">IF</code> (equationmode .EQ. timespectral) <code class="keyword">THEN</code></a>
<a name="timestep_block_spatial_di116"></a>        <a href="timestep_block_p.html#timestep_blocki115" target="origFile">tmp = ntimeintervalsspectral*pi*timeref/sections(sectionid)%<code class="label">&</code></a>
<a href="timestep_block_p.html#timestep_blocki115" target="origFile"><code class="label">&          </code>timeperiod</a>
<a name="timestep_block_spatial_di117"></a><a href="timestep_block_p.html#timestep_blocki116" target="origFile"><code class="comment">! Loop over the owned cell centers and add the term.</code></a>
<a name="timestep_block_spatial_di118"></a>        <a href="timestep_block_p.html#timestep_blocki116" target="origFile"><code class="keyword">DO </code>k=<code class="constant">2</code>,kl</a>
<a name="timestep_block_spatial_di119"></a>          <a href="timestep_block_p.html#timestep_blocki117" target="origFile"><code class="keyword">DO </code>j=<code class="constant">2</code>,jl</a>
            <a href="timestep_block_p.html#timestep_blocki118" target="origFile"><code class="keyword">DO </code>i=<code class="constant">2</code>,il</a>
              <a href="timestep_block_p.html#timestep_blocki119" target="origFile">dtl(i, j, k) = dtl(i, j, k) + tmp*vol(i, j, k)</a>
            <a href="timestep_block_p.html#timestep_blocki118" target="origFile"><code class="keyword">END DO</code></a>
          <a href="timestep_block_p.html#timestep_blocki117" target="origFile"><code class="keyword">END DO</code></a>
<a name="timestep_block_spatial_di120"></a>        <a href="timestep_block_p.html#timestep_blocki116" target="origFile"><code class="keyword">END DO</code></a>
      <a href="timestep_block_p.html#timestep_blocki114" target="origFile"><code class="keyword">END IF</code></a>
<a href="timestep_block_p.html#timestep_blocki120" target="origFile"><code class="comment">! Currently the inverse of dt/vol is stored in dtl. Invert</code></a>
<a href="timestep_block_p.html#timestep_blocki120" target="origFile"><code class="comment">! this value such that the time step per unit cfl number is</code></a>
<a name="timestep_block_spatial_di121"></a><a href="timestep_block_p.html#timestep_blocki120" target="origFile"><code class="comment">! stored and correct in cases of high gradients.</code></a>
<a name="timestep_block_spatial_di122"></a>      <a href="timestep_block_p.html#timestep_blocki120" target="origFile"><code class="keyword">DO </code>k=<code class="constant">2</code>,kl</a>
<a name="timestep_block_spatial_di123"></a>        <a href="timestep_block_p.html#timestep_blocki121" target="origFile"><code class="keyword">DO </code>j=<code class="constant">2</code>,jl</a>
          <a href="timestep_block_p.html#timestep_blocki122" target="origFile"><code class="keyword">DO </code>i=<code class="constant">2</code>,il</a>
<a name="timestep_block_spatial_di125"></a>            <a href="timestep_block_p.html#timestep_blocki123" target="origFile"><code class="keyword">IF</code> (p(i+<code class="constant">1</code>, j, k) - two*p(i, j, k) + p(i-<code class="constant">1</code>, j, k) .GE. <code class="constant">0.</code>) <code class="label">&</code></a>
<a href="timestep_block_p.html#timestep_blocki123" target="origFile"><code class="label">&            </code><code class="keyword">THEN</code></a>
<a name="timestep_block_spatial_di124"></a>              <a href="timestep_block_p.html#timestep_blocki125" target="origFile">abs4 = p(i+<code class="constant">1</code>, j, k) - two*p(i, j, k) + p(i-<code class="constant">1</code>, j, k)</a>
            <a href="timestep_block_p.html#timestep_blocki123" target="origFile"><code class="keyword">ELSE</code></a>
<a name="timestep_block_spatial_di126"></a>              <a href="timestep_block_p.html#timestep_blocki124" target="origFile">abs4 = -(p(i+<code class="constant">1</code>, j, k)-two*p(i, j, k)+p(i-<code class="constant">1</code>, j, k))</a>
<a name="timestep_block_spatial_di127"></a>            <a href="timestep_block_p.html#timestep_blocki123" target="origFile"><code class="keyword">END IF</code></a>
            <a href="timestep_block_p.html#timestep_blocki126" target="origFile">dpi = abs4/(p(i+<code class="constant">1</code>, j, k)+two*p(i, j, k)+p(i-<code class="constant">1</code>, j, k)+plim)</a>
<a name="timestep_block_spatial_di129"></a>            <a href="timestep_block_p.html#timestep_blocki127" target="origFile"><code class="keyword">IF</code> (p(i, j+<code class="constant">1</code>, k) - two*p(i, j, k) + p(i, j-<code class="constant">1</code>, k) .GE. <code class="constant">0.</code>) <code class="label">&</code></a>
<a href="timestep_block_p.html#timestep_blocki127" target="origFile"><code class="label">&            </code><code class="keyword">THEN</code></a>
<a name="timestep_block_spatial_di128"></a>              <a href="timestep_block_p.html#timestep_blocki129" target="origFile">abs5 = p(i, j+<code class="constant">1</code>, k) - two*p(i, j, k) + p(i, j-<code class="constant">1</code>, k)</a>
            <a href="timestep_block_p.html#timestep_blocki127" target="origFile"><code class="keyword">ELSE</code></a>
<a name="timestep_block_spatial_di130"></a>              <a href="timestep_block_p.html#timestep_blocki128" target="origFile">abs5 = -(p(i, j+<code class="constant">1</code>, k)-two*p(i, j, k)+p(i, j-<code class="constant">1</code>, k))</a>
<a name="timestep_block_spatial_di131"></a>            <a href="timestep_block_p.html#timestep_blocki127" target="origFile"><code class="keyword">END IF</code></a>
            <a href="timestep_block_p.html#timestep_blocki130" target="origFile">dpj = abs5/(p(i, j+<code class="constant">1</code>, k)+two*p(i, j, k)+p(i, j-<code class="constant">1</code>, k)+plim)</a>
<a name="timestep_block_spatial_di133"></a>            <a href="timestep_block_p.html#timestep_blocki131" target="origFile"><code class="keyword">IF</code> (p(i, j, k+<code class="constant">1</code>) - two*p(i, j, k) + p(i, j, k-<code class="constant">1</code>) .GE. <code class="constant">0.</code>) <code class="label">&</code></a>
<a href="timestep_block_p.html#timestep_blocki131" target="origFile"><code class="label">&            </code><code class="keyword">THEN</code></a>
<a name="timestep_block_spatial_di132"></a>              <a href="timestep_block_p.html#timestep_blocki133" target="origFile">abs6 = p(i, j, k+<code class="constant">1</code>) - two*p(i, j, k) + p(i, j, k-<code class="constant">1</code>)</a>
            <a href="timestep_block_p.html#timestep_blocki131" target="origFile"><code class="keyword">ELSE</code></a>
<a name="timestep_block_spatial_di134"></a>              <a href="timestep_block_p.html#timestep_blocki132" target="origFile">abs6 = -(p(i, j, k+<code class="constant">1</code>)-two*p(i, j, k)+p(i, j, k-<code class="constant">1</code>))</a>
<a name="timestep_block_spatial_di135"></a>            <a href="timestep_block_p.html#timestep_blocki131" target="origFile"><code class="keyword">END IF</code></a>
<a name="timestep_block_spatial_di136"></a>            <a href="timestep_block_p.html#timestep_blocki134" target="origFile">dpk = abs6/(p(i, j, k+<code class="constant">1</code>)+two*p(i, j, k)+p(i, j, k-<code class="constant">1</code>)+plim)</a>
            <a href="timestep_block_p.html#timestep_blocki135" target="origFile">rfl = one/(one+b*(dpi+dpj+dpk))</a>
            <a href="timestep_block_p.html#timestep_blocki136" target="origFile">dtl(i, j, k) = rfl/dtl(i, j, k)</a>
          <a href="timestep_block_p.html#timestep_blocki122" target="origFile"><code class="keyword">END DO</code></a>
        <a href="timestep_block_p.html#timestep_blocki121" target="origFile"><code class="keyword">END DO</code></a>
      <a href="timestep_block_p.html#timestep_blocki120" target="origFile"><code class="keyword">END DO</code></a>
    <a href="timestep_block_p.html#timestep_blocki90" target="origFile"><code class="keyword">END IF</code></a>
  <a href="timestep_block_p.html#timestep_blocki15" target="origFile"><code class="keyword">END IF</code></a>
<a href="timestep_block_p.html#timestep_block" target="origFile"><code class="keyword">END SUBROUTINE </code><code class="funcname">TIMESTEP_BLOCK_SPATIAL_D</code></a>
</pre>
</body>
