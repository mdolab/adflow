<title>Generated by TAPENADE</title>
<link type="text/CSS" rel="stylesheet" href="tapenade.css">
<link type="text/CSS" rel="stylesheet" href="fortranStyle.css">
<body>
<pre><a name="metric_block"></a><a href="metric_block.html#metric_block" target="diffFile"><code class="comment">!        Generated by TAPENADE     (INRIA, Tropics team)</code></a>
<a href="metric_block.html#metric_block" target="diffFile"><code class="comment">!  Tapenade 3.4 (r3375) - 10 Feb 2010 15:08</code></a>
<a href="metric_block.html#metric_block" target="diffFile"><code class="comment">!</code></a>
<a href="metric_block.html#metric_block" target="diffFile"><code class="keyword">SUBROUTINE </code><code class="funcname">METRIC_BLOCK</code>(<code class="vardecl">nn</code>, <code class="vardecl">level</code>, <code class="vardecl">sps</code>)</a>
  <a href="metric_block.html#metric_block" target="diffFile"><code class="keyword">USE </code><code class="funcname">BLOCKPOINTERS</code></a>
  <a href="metric_block.html#metric_block" target="diffFile"><code class="keyword">USE </code><code class="funcname">INPUTTIMESPECTRAL</code></a>
  <a href="metric_block.html#metric_block" target="diffFile"><code class="keyword">USE </code><code class="funcname">CGNSGRID</code></a>
  <a href="metric_block.html#metric_block" target="diffFile"><code class="keyword">USE </code><code class="funcname">COMMUNICATION</code></a>
<a name="metric_blocki0"></a>  <a href="metric_block.html#metric_block" target="diffFile"><code class="keyword">USE </code><code class="funcname">BCTYPES</code></a>
  <a href="metric_block.html#metric_block" target="diffFile"><code class="keyword">IMPLICIT NONE</code></a>
<a href="metric_block.html#metric_blocki0" target="diffFile"><code class="comment">!</code></a>
<a href="metric_block.html#metric_blocki0" target="diffFile"><code class="comment">!      ******************************************************************</code></a>
<a href="metric_block.html#metric_blocki0" target="diffFile"><code class="comment">!      *                                                                *</code></a>
<a href="metric_block.html#metric_blocki0" target="diffFile"><code class="comment">!      * metric computes the face normals and the volume for the given  *</code></a>
<a href="metric_block.html#metric_blocki0" target="diffFile"><code class="comment">!      * grid level for all spectral solutions. First the volumes are   *</code></a>
<a href="metric_block.html#metric_blocki0" target="diffFile"><code class="comment">!      * computed assuming that the block is right handed. Then the     *</code></a>
<a href="metric_block.html#metric_blocki0" target="diffFile"><code class="comment">!      * number of positive and negative volumes are determined. If all *</code></a>
<a href="metric_block.html#metric_blocki0" target="diffFile"><code class="comment">!      * volumes are positive the block is indeed right handed; if all  *</code></a>
<a href="metric_block.html#metric_blocki0" target="diffFile"><code class="comment">!      * volumes are negative the block is left handed and both the     *</code></a>
<a href="metric_block.html#metric_blocki0" target="diffFile"><code class="comment">!      * volumes and the normals must be negated (for the normals this  *</code></a>
<a href="metric_block.html#metric_blocki0" target="diffFile"><code class="comment">!      * is done by the introduction of fact, which is either -0.5 or   *</code></a>
<a href="metric_block.html#metric_blocki0" target="diffFile"><code class="comment">!      * 0.5); if there are both positive and negative volumes the mesh *</code></a>
<a href="metric_block.html#metric_blocki0" target="diffFile"><code class="comment">!      * is not valid.                                                  *</code></a>
<a href="metric_block.html#metric_blocki0" target="diffFile"><code class="comment">!      *                                                                *</code></a>
<a href="metric_block.html#metric_blocki0" target="diffFile"><code class="comment">!      ******************************************************************</code></a>
<a href="metric_block.html#metric_blocki0" target="diffFile"><code class="comment">!</code></a>
<a href="metric_block.html#metric_blocki0" target="diffFile"><code class="comment">!</code></a>
<a href="metric_block.html#metric_blocki0" target="diffFile"><code class="comment">!      Subroutine arguments.</code></a>
<a name="metric_blocki1"></a><a href="metric_block.html#metric_blocki0" target="diffFile"><code class="comment">!</code></a>
  <a href="metric_block.html#metric_blocki0" target="diffFile"><code class="typename">INTEGER(</code><code class="keyword">kind</code>=<code class="modifier">inttype</code><code class="typename">)</code>, <code class="typename">INTENT(IN) </code>:: <code class="vardecl">level</code></a>
<a href="metric_block.html#metric_blocki1" target="diffFile"><code class="comment">!</code></a>
<a href="metric_block.html#metric_blocki1" target="diffFile"><code class="comment">!      Local parameter.</code></a>
<a name="metric_blocki2"></a><a href="metric_block.html#metric_blocki1" target="diffFile"><code class="comment">!</code></a>
  <a href="metric_block.html#metric_blocki1" target="diffFile"><code class="typename">REAL(</code><code class="keyword">kind</code>=<code class="modifier">realtype</code><code class="typename">)</code>, <code class="typename">PARAMETER </code>:: <code class="vardecl">thresvolume</code>=<code class="constant">1.e-2_realType</code></a>
<a href="metric_block.html#metric_blocki2" target="diffFile"><code class="comment">!</code></a>
<a href="metric_block.html#metric_blocki2" target="diffFile"><code class="comment">!      Local variables.</code></a>
<a name="metric_blocki3"></a><a href="metric_block.html#metric_blocki2" target="diffFile"><code class="comment">!</code></a>
<a name="metric_blocki4"></a>  <a href="metric_block.html#metric_blocki2" target="diffFile"><code class="typename">INTEGER </code>:: <code class="vardecl">ierr</code></a>
<a name="metric_blocki5"></a>  <a href="metric_block.html#metric_blocki3" target="diffFile"><code class="typename">INTEGER(</code><code class="keyword">kind</code>=<code class="modifier">inttype</code><code class="typename">) </code>:: <code class="vardecl">i</code>, <code class="vardecl">j</code>, <code class="vardecl">k</code>, <code class="vardecl">n</code>, <code class="vardecl">m</code>, <code class="vardecl">l</code></a>
<a name="metric_blocki6"></a>  <a href="metric_block.html#metric_blocki4" target="diffFile"><code class="typename">INTEGER(</code><code class="keyword">kind</code>=<code class="modifier">inttype</code><code class="typename">) </code>:: <code class="vardecl">nn</code>, <code class="vardecl">mm</code>, <code class="vardecl">sps</code></a>
<a name="metric_blocki7"></a>  <a href="metric_block.html#metric_blocki5" target="diffFile"><code class="typename">INTEGER(</code><code class="keyword">kind</code>=<code class="modifier">inttype</code><code class="typename">) </code>:: <code class="vardecl">nvolneg</code>, <code class="vardecl">nvolpos</code></a>
<a name="metric_blocki8"></a>  <a href="metric_block.html#metric_blocki6" target="diffFile"><code class="typename">INTEGER(</code><code class="keyword">kind</code>=<code class="modifier">inttype</code><code class="typename">) </code>:: <code class="vardecl">nvolbad</code>, <code class="vardecl">nvolbadglobal</code></a>
<a name="metric_blocki9"></a>  <a href="metric_block.html#metric_blocki7" target="diffFile"><code class="typename">INTEGER(</code><code class="keyword">kind</code>=<code class="modifier">inttype</code><code class="typename">) </code>:: <code class="vardecl">nblockbad</code>, <code class="vardecl">nblockbadglobal</code></a>
<a name="metric_blocki10"></a>  <a href="metric_block.html#metric_blocki8" target="diffFile"><code class="typename">REAL(</code><code class="keyword">kind</code>=<code class="modifier">realtype</code><code class="typename">) </code>:: <code class="vardecl">fact</code>, <code class="vardecl">mult</code></a>
<a name="metric_blocki11"></a>  <a href="metric_block.html#metric_blocki9" target="diffFile"><code class="typename">REAL(</code><code class="keyword">kind</code>=<code class="modifier">realtype</code><code class="typename">) </code>:: <code class="vardecl">xp</code>, <code class="vardecl">yp</code>, <code class="vardecl">zp</code>, <code class="vardecl">vp1</code>, <code class="vardecl">vp2</code>, <code class="vardecl">vp3</code>, <code class="vardecl">vp4</code>, <code class="vardecl">vp5</code>, <code class="vardecl">vp6</code></a>
<a name="metric_blocki12"></a>  <a href="metric_block.html#metric_blocki10" target="diffFile"><code class="typename">REAL(</code><code class="keyword">kind</code>=<code class="modifier">realtype</code><code class="typename">)</code>, <code class="typename">DIMENSION(</code><code class="constant">3</code><code class="typename">) </code>:: <code class="vardecl">v1</code>, <code class="vardecl">v2</code></a>
<a name="metric_blocki13"></a>  <a href="metric_block.html#metric_blocki11" target="diffFile"><code class="typename">REAL(</code><code class="keyword">kind</code>=<code class="modifier">realtype</code><code class="typename">)</code>, <code class="typename">DIMENSION(</code>:, :, :<code class="typename">)</code>, <code class="typename">POINTER </code>:: <code class="vardecl">ss</code></a>
<a name="metric_blocki14"></a>  <a href="metric_block.html#metric_blocki12" target="diffFile"><code class="typename">CHARACTER</code>(<code class="keyword">len</code>=<code class="constant">10</code>) :: <code class="vardecl">integerstring</code></a>
<a name="metric_blocki15"></a>  <a href="metric_block.html#metric_blocki13" target="diffFile"><code class="typename">LOGICAL </code>:: <code class="vardecl">checkk</code>, <code class="vardecl">checkj</code>, <code class="vardecl">checki</code>, <code class="vardecl">checkall</code></a>
<a name="metric_blocki16"></a>  <a href="metric_block.html#metric_blocki14" target="diffFile"><code class="typename">LOGICAL </code>:: <code class="vardecl">badvolume</code></a>
<a name="metric_blocki17"></a>  <a href="metric_block.html#metric_blocki15" target="diffFile"><code class="typename">REAL(</code><code class="keyword">kind</code>=<code class="modifier">realtype</code><code class="typename">) </code>:: <code class="funcname">VOLPYM</code></a>
<a name="metric_blocki18"></a>  <a href="metric_block.html#metric_blocki16" target="diffFile"><code class="keyword">EXTERNAL </code><code class="funcname">FLOWDOMS</code></a>
  <a href="metric_block.html#metric_blocki17" target="diffFile"><code class="keyword">TYPE(</code><code class="typename">#UNKNOWNDERIVEDTYPE0#</code><code class="keyword">) </code>:: <code class="vardecl">result1</code></a>
  <a href="metric_block.html#metric_blocki18" target="diffFile"><code class="typename">REAL(</code><code class="keyword">kind</code>=<code class="modifier">realtype</code><code class="typename">) </code>:: <code class="vardecl">arg1</code></a>
  <a href="metric_block.html#metric_block" target="diffFile"><code class="keyword">TYPE(</code><code class="typename">UNKNOWNDERIVEDTYPE0</code><code class="keyword">) </code>:: <code class="funcname">FLOWDOMS</code></a>
<a name="metric_blocki19"></a>  <a href="metric_block.html#metric_block" target="diffFile"><code class="keyword">INTRINSIC </code><code class="funcname">ABS</code></a>
  <a href="metric_block.html#metric_block" target="diffFile"><code class="keyword">INTRINSIC </code><code class="funcname">SQRT</code></a>
<a href="metric_block.html#metric_blocki19" target="diffFile"><code class="comment">!</code></a>
<a href="metric_block.html#metric_blocki19" target="diffFile"><code class="comment">!      ******************************************************************</code></a>
<a href="metric_block.html#metric_blocki19" target="diffFile"><code class="comment">!      *                                                                *</code></a>
<a href="metric_block.html#metric_blocki19" target="diffFile"><code class="comment">!      * Begin execution                                                *</code></a>
<a href="metric_block.html#metric_blocki19" target="diffFile"><code class="comment">!      *                                                                *</code></a>
<a href="metric_block.html#metric_blocki19" target="diffFile"><code class="comment">!      ******************************************************************</code></a>
<a href="metric_block.html#metric_blocki19" target="diffFile"><code class="comment">!</code></a>
<a href="metric_block.html#metric_blocki19" target="diffFile"><code class="comment">! Compute the volumes. The hexahedron is split into 6 pyramids</code></a>
<a href="metric_block.html#metric_blocki19" target="diffFile"><code class="comment">! whose volumes are computed. The volume is positive for a</code></a>
<a href="metric_block.html#metric_blocki19" target="diffFile"><code class="comment">! right handed block.</code></a>
<a href="metric_block.html#metric_blocki19" target="diffFile"><code class="comment">! Initialize the volumes to zero. The reasons is that the second</code></a>
<a href="metric_block.html#metric_blocki19" target="diffFile"><code class="comment">! level halo's must be initialized to zero and for convenience</code></a>
<a name="metric_blocki20"></a><a href="metric_block.html#metric_blocki19" target="diffFile"><code class="comment">! all the volumes are set to zero.</code></a>
<a name="metric_blocki21"></a>  <a href="metric_block.html#metric_blocki19" target="diffFile">vol = zero</a>
<a name="metric_blocki22"></a>  <a href="metric_block.html#metric_blocki20" target="diffFile"><code class="keyword">DO </code>k=<code class="constant">1</code>,ke</a>
<a name="metric_blocki24"></a><a name="metric_blocki23"></a>    <a href="metric_block.html#metric_blocki21" target="diffFile">n = k - <code class="constant">1</code></a>
<a name="metric_blocki25"></a>    <a href="metric_block.html#metric_blocki22" target="diffFile">checkk = <code class="constant">.true.</code></a>
<a name="metric_blocki26"></a>    <a href="metric_block.html#metric_blocki23" target="diffFile"><code class="keyword">IF</code> (k .EQ. <code class="constant">1 </code>.OR. k .EQ. ke) </a><a href="metric_block.html#metric_blocki24" target="diffFile">checkk = <code class="constant">.false.</code></a>
<a name="metric_blocki27"></a>    <a href="metric_block.html#metric_blocki25" target="diffFile"><code class="keyword">DO </code>j=<code class="constant">1</code>,je</a>
<a name="metric_blocki29"></a><a name="metric_blocki28"></a>      <a href="metric_block.html#metric_blocki26" target="diffFile">m = j - <code class="constant">1</code></a>
<a name="metric_blocki30"></a>      <a href="metric_block.html#metric_blocki27" target="diffFile">checkj = <code class="constant">.true.</code></a>
<a name="metric_blocki31"></a>      <a href="metric_block.html#metric_blocki28" target="diffFile"><code class="keyword">IF</code> (j .EQ. <code class="constant">1 </code>.OR. j .EQ. je) </a><a href="metric_block.html#metric_blocki29" target="diffFile">checkj = <code class="constant">.false.</code></a>
<a name="metric_blocki32"></a>      <a href="metric_block.html#metric_blocki30" target="diffFile"><code class="keyword">DO </code>i=<code class="constant">1</code>,ie</a>
<a name="metric_blocki34"></a><a name="metric_blocki33"></a>        <a href="metric_block.html#metric_blocki31" target="diffFile">l = i - <code class="constant">1</code></a>
<a name="metric_blocki35"></a>        <a href="metric_block.html#metric_blocki32" target="diffFile">checki = <code class="constant">.true.</code></a>
        <a href="metric_block.html#metric_blocki33" target="diffFile"><code class="keyword">IF</code> (i .EQ. <code class="constant">1 </code>.OR. i .EQ. ie) </a><a href="metric_block.html#metric_blocki34" target="diffFile">checki = <code class="constant">.false.</code></a>
<a href="metric_block.html#metric_blocki35" target="diffFile"><code class="comment">! Determine whether or not the voluem must be checked for</code></a>
<a name="metric_blocki37"></a><a name="metric_blocki36"></a><a href="metric_block.html#metric_blocki35" target="diffFile"><code class="comment">! quality. Only owned volumes are checked, not halo's.</code></a>
<a name="metric_blocki38"></a>        <a href="metric_block.html#metric_blocki35" target="diffFile">checkall = <code class="constant">.false.</code></a>
        <a href="metric_block.html#metric_blocki36" target="diffFile"><code class="keyword">IF</code> (checkk .AND. checkj .AND. checki) </a><a href="metric_block.html#metric_blocki37" target="diffFile">checkall = <code class="constant">.true.</code></a>
<a href="metric_block.html#metric_blocki38" target="diffFile"><code class="comment">! Compute the coordinates of the center of gravity.</code></a>
<a name="metric_blocki39"></a>        <a href="metric_block.html#metric_blocki38" target="diffFile">xp = eighth*(x(i, j, k, <code class="constant">1</code>)+x(i, m, k, <code class="constant">1</code>)+x(i, m, n, <code class="constant">1</code>)+x(i, j, n<code class="label">&</code></a>
<a href="metric_block.html#metric_blocki38" target="diffFile"><code class="label">&          </code>, <code class="constant">1</code>)+x(l, j, k, <code class="constant">1</code>)+x(l, m, k, <code class="constant">1</code>)+x(l, m, n, <code class="constant">1</code>)+x(l, j, n, <code class="constant">1</code>))</a>
<a name="metric_blocki40"></a>        <a href="metric_block.html#metric_blocki39" target="diffFile">yp = eighth*(x(i, j, k, <code class="constant">2</code>)+x(i, m, k, <code class="constant">2</code>)+x(i, m, n, <code class="constant">2</code>)+x(i, j, n<code class="label">&</code></a>
<a href="metric_block.html#metric_blocki39" target="diffFile"><code class="label">&          </code>, <code class="constant">2</code>)+x(l, j, k, <code class="constant">2</code>)+x(l, m, k, <code class="constant">2</code>)+x(l, m, n, <code class="constant">2</code>)+x(l, j, n, <code class="constant">2</code>))</a>
<a name="metric_blocki41"></a>        <a href="metric_block.html#metric_blocki40" target="diffFile">zp = eighth*(x(i, j, k, <code class="constant">3</code>)+x(i, m, k, <code class="constant">3</code>)+x(i, m, n, <code class="constant">3</code>)+x(i, j, n<code class="label">&</code></a>
<a href="metric_block.html#metric_blocki40" target="diffFile"><code class="label">&          </code>, <code class="constant">3</code>)+x(l, j, k, <code class="constant">3</code>)+x(l, m, k, <code class="constant">3</code>)+x(l, m, n, <code class="constant">3</code>)+x(l, j, n, <code class="constant">3</code>))</a>
<a href="metric_block.html#metric_blocki41" target="diffFile"><code class="comment">! Compute the volumes of the 6 sub pyramids. The</code></a>
<a href="metric_block.html#metric_blocki41" target="diffFile"><code class="comment">! arguments of volpym must be such that for a (regular)</code></a>
<a href="metric_block.html#metric_blocki41" target="diffFile"><code class="comment">! right handed hexahedron all volumes are positive.</code></a>
        <a href="metric_block.html#metric_blocki41" target="diffFile">vp1 = <code class="funcname">VOLPYM</code>(x(i, j, k, <code class="constant">1</code>), x(i, j, k, <code class="constant">2</code>), x(i, j, k, <code class="constant">3</code>), x(i, j<code class="label">&</code></a>
<a href="metric_block.html#metric_blocki41" target="diffFile"><code class="label">&          </code>, n, <code class="constant">1</code>), x(i, j, n, <code class="constant">2</code>), x(i, j, n, <code class="constant">3</code>), x(i, m, n, <code class="constant">1</code>), x(i, m, <code class="label">&</code></a>
<a name="metric_blocki42"></a><a href="metric_block.html#metric_blocki41" target="diffFile"><code class="label">&          </code>n, <code class="constant">2</code>), x(i, m, n, <code class="constant">3</code>), x(i, m, k, <code class="constant">1</code>), x(i, m, k, <code class="constant">2</code>), x(i, m, k<code class="label">&</code></a>
<a href="metric_block.html#metric_blocki41" target="diffFile"><code class="label">&          </code>, <code class="constant">3</code>))</a>
        <a href="metric_block.html#metric_blocki42" target="diffFile">vp2 = <code class="funcname">VOLPYM</code>(x(l, j, k, <code class="constant">1</code>), x(l, j, k, <code class="constant">2</code>), x(l, j, k, <code class="constant">3</code>), x(l, m<code class="label">&</code></a>
<a href="metric_block.html#metric_blocki42" target="diffFile"><code class="label">&          </code>, k, <code class="constant">1</code>), x(l, m, k, <code class="constant">2</code>), x(l, m, k, <code class="constant">3</code>), x(l, m, n, <code class="constant">1</code>), x(l, m, <code class="label">&</code></a>
<a name="metric_blocki43"></a><a href="metric_block.html#metric_blocki42" target="diffFile"><code class="label">&          </code>n, <code class="constant">2</code>), x(l, m, n, <code class="constant">3</code>), x(l, j, n, <code class="constant">1</code>), x(l, j, n, <code class="constant">2</code>), x(l, j, n<code class="label">&</code></a>
<a href="metric_block.html#metric_blocki42" target="diffFile"><code class="label">&          </code>, <code class="constant">3</code>))</a>
        <a href="metric_block.html#metric_blocki43" target="diffFile">vp3 = <code class="funcname">VOLPYM</code>(x(i, j, k, <code class="constant">1</code>), x(i, j, k, <code class="constant">2</code>), x(i, j, k, <code class="constant">3</code>), x(l, j<code class="label">&</code></a>
<a href="metric_block.html#metric_blocki43" target="diffFile"><code class="label">&          </code>, k, <code class="constant">1</code>), x(l, j, k, <code class="constant">2</code>), x(l, j, k, <code class="constant">3</code>), x(l, j, n, <code class="constant">1</code>), x(l, j, <code class="label">&</code></a>
<a name="metric_blocki44"></a><a href="metric_block.html#metric_blocki43" target="diffFile"><code class="label">&          </code>n, <code class="constant">2</code>), x(l, j, n, <code class="constant">3</code>), x(i, j, n, <code class="constant">1</code>), x(i, j, n, <code class="constant">2</code>), x(i, j, n<code class="label">&</code></a>
<a href="metric_block.html#metric_blocki43" target="diffFile"><code class="label">&          </code>, <code class="constant">3</code>))</a>
        <a href="metric_block.html#metric_blocki44" target="diffFile">vp4 = <code class="funcname">VOLPYM</code>(x(i, m, k, <code class="constant">1</code>), x(i, m, k, <code class="constant">2</code>), x(i, m, k, <code class="constant">3</code>), x(i, m<code class="label">&</code></a>
<a href="metric_block.html#metric_blocki44" target="diffFile"><code class="label">&          </code>, n, <code class="constant">1</code>), x(i, m, n, <code class="constant">2</code>), x(i, m, n, <code class="constant">3</code>), x(l, m, n, <code class="constant">1</code>), x(l, m, <code class="label">&</code></a>
<a name="metric_blocki45"></a><a href="metric_block.html#metric_blocki44" target="diffFile"><code class="label">&          </code>n, <code class="constant">2</code>), x(l, m, n, <code class="constant">3</code>), x(l, m, k, <code class="constant">1</code>), x(l, m, k, <code class="constant">2</code>), x(l, m, k<code class="label">&</code></a>
<a href="metric_block.html#metric_blocki44" target="diffFile"><code class="label">&          </code>, <code class="constant">3</code>))</a>
        <a href="metric_block.html#metric_blocki45" target="diffFile">vp5 = <code class="funcname">VOLPYM</code>(x(i, j, k, <code class="constant">1</code>), x(i, j, k, <code class="constant">2</code>), x(i, j, k, <code class="constant">3</code>), x(i, m<code class="label">&</code></a>
<a href="metric_block.html#metric_blocki45" target="diffFile"><code class="label">&          </code>, k, <code class="constant">1</code>), x(i, m, k, <code class="constant">2</code>), x(i, m, k, <code class="constant">3</code>), x(l, m, k, <code class="constant">1</code>), x(l, m, <code class="label">&</code></a>
<a name="metric_blocki46"></a><a href="metric_block.html#metric_blocki45" target="diffFile"><code class="label">&          </code>k, <code class="constant">2</code>), x(l, m, k, <code class="constant">3</code>), x(l, j, k, <code class="constant">1</code>), x(l, j, k, <code class="constant">2</code>), x(l, j, k<code class="label">&</code></a>
<a href="metric_block.html#metric_blocki45" target="diffFile"><code class="label">&          </code>, <code class="constant">3</code>))</a>
        <a href="metric_block.html#metric_blocki46" target="diffFile">vp6 = <code class="funcname">VOLPYM</code>(x(i, j, n, <code class="constant">1</code>), x(i, j, n, <code class="constant">2</code>), x(i, j, n, <code class="constant">3</code>), x(l, j<code class="label">&</code></a>
<a href="metric_block.html#metric_blocki46" target="diffFile"><code class="label">&          </code>, n, <code class="constant">1</code>), x(l, j, n, <code class="constant">2</code>), x(l, j, n, <code class="constant">3</code>), x(l, m, n, <code class="constant">1</code>), x(l, m, <code class="label">&</code></a>
<a name="metric_blocki47"></a><a href="metric_block.html#metric_blocki46" target="diffFile"><code class="label">&          </code>n, <code class="constant">2</code>), x(l, m, n, <code class="constant">3</code>), x(i, m, n, <code class="constant">1</code>), x(i, m, n, <code class="constant">2</code>), x(i, m, n<code class="label">&</code></a>
<a href="metric_block.html#metric_blocki46" target="diffFile"><code class="label">&          </code>, <code class="constant">3</code>))</a>
<a href="metric_block.html#metric_blocki47" target="diffFile"><code class="comment">! Set the volume to 1/6 of the sum of the volumes of the</code></a>
<a href="metric_block.html#metric_blocki47" target="diffFile"><code class="comment">! pyramid. Remember that volpym computes 6 times the</code></a>
<a name="metric_blocki48"></a><a href="metric_block.html#metric_blocki47" target="diffFile"><code class="comment">! volume.</code></a>
<a name="metric_blocki50"></a>        <a href="metric_block.html#metric_blocki47" target="diffFile">vol(i, j, k) = sixth*(vp1+vp2+vp3+vp4+vp5+vp6)</a>
        <a href="metric_block.html#metric_blocki48" target="diffFile"><code class="keyword">IF</code> (vol(i, j, k) .GE. <code class="constant">0.</code>) <code class="keyword">THEN</code></a>
<a name="metric_blocki49"></a>          <a href="metric_block.html#metric_blocki50" target="diffFile">vol(i, j, k) = vol(i, j, k)</a>
        <a href="metric_block.html#metric_blocki48" target="diffFile"><code class="keyword">ELSE</code></a>
          <a href="metric_block.html#metric_blocki49" target="diffFile">vol(i, j, k) = -vol(i, j, k)</a>
        <a href="metric_block.html#metric_blocki48" target="diffFile"><code class="keyword">END IF</code></a>
      <a href="metric_block.html#metric_blocki30" target="diffFile"><code class="keyword">END DO</code></a>
<a name="metric_blocki51"></a>    <a href="metric_block.html#metric_blocki25" target="diffFile"><code class="keyword">END DO</code></a>
  <a href="metric_block.html#metric_blocki20" target="diffFile"><code class="keyword">END DO</code></a>
<a name="metric_blocki52"></a><a href="metric_block.html#metric_blocki51" target="diffFile"><code class="comment">! Some additional safety stuff for halo volumes.</code></a>
<a name="metric_blocki54"></a><a name="metric_blocki53"></a>  <a href="metric_block.html#metric_blocki51" target="diffFile"><code class="keyword">DO </code>k=<code class="constant">2</code>,kl</a>
<a name="metric_blocki56"></a><a name="metric_blocki55"></a>    <a href="metric_block.html#metric_blocki52" target="diffFile"><code class="keyword">DO </code>j=<code class="constant">2</code>,jl</a>
      <a href="metric_block.html#metric_blocki53" target="diffFile"><code class="keyword">IF</code> (vol(<code class="constant">1</code>, j, k) .LE. eps) </a><a href="metric_block.html#metric_blocki54" target="diffFile">vol(<code class="constant">1</code>, j, k) = vol(<code class="constant">2</code>, j, k)</a>
      <a href="metric_block.html#metric_blocki55" target="diffFile"><code class="keyword">IF</code> (vol(ie, j, k) .LE. eps) </a><a href="metric_block.html#metric_blocki56" target="diffFile">vol(ie, j, k) = vol(il, j, k)</a>
<a name="metric_blocki57"></a>    <a href="metric_block.html#metric_blocki52" target="diffFile"><code class="keyword">END DO</code></a>
<a name="metric_blocki58"></a>  <a href="metric_block.html#metric_blocki51" target="diffFile"><code class="keyword">END DO</code></a>
<a name="metric_blocki60"></a><a name="metric_blocki59"></a>  <a href="metric_block.html#metric_blocki57" target="diffFile"><code class="keyword">DO </code>k=<code class="constant">2</code>,kl</a>
<a name="metric_blocki62"></a><a name="metric_blocki61"></a>    <a href="metric_block.html#metric_blocki58" target="diffFile"><code class="keyword">DO </code>i=<code class="constant">1</code>,ie</a>
      <a href="metric_block.html#metric_blocki59" target="diffFile"><code class="keyword">IF</code> (vol(i, <code class="constant">1</code>, k) .LE. eps) </a><a href="metric_block.html#metric_blocki60" target="diffFile">vol(i, <code class="constant">1</code>, k) = vol(i, <code class="constant">2</code>, k)</a>
      <a href="metric_block.html#metric_blocki61" target="diffFile"><code class="keyword">IF</code> (vol(i, je, k) .LE. eps) </a><a href="metric_block.html#metric_blocki62" target="diffFile">vol(i, je, k) = vol(i, jl, k)</a>
<a name="metric_blocki63"></a>    <a href="metric_block.html#metric_blocki58" target="diffFile"><code class="keyword">END DO</code></a>
<a name="metric_blocki64"></a>  <a href="metric_block.html#metric_blocki57" target="diffFile"><code class="keyword">END DO</code></a>
<a name="metric_blocki66"></a><a name="metric_blocki65"></a>  <a href="metric_block.html#metric_blocki63" target="diffFile"><code class="keyword">DO </code>j=<code class="constant">1</code>,je</a>
<a name="metric_blocki68"></a><a name="metric_blocki67"></a>    <a href="metric_block.html#metric_blocki64" target="diffFile"><code class="keyword">DO </code>i=<code class="constant">1</code>,ie</a>
      <a href="metric_block.html#metric_blocki65" target="diffFile"><code class="keyword">IF</code> (vol(i, j, <code class="constant">1</code>) .LE. eps) </a><a href="metric_block.html#metric_blocki66" target="diffFile">vol(i, j, <code class="constant">1</code>) = vol(i, j, <code class="constant">2</code>)</a>
      <a href="metric_block.html#metric_blocki67" target="diffFile"><code class="keyword">IF</code> (vol(i, j, ke) .LE. eps) </a><a href="metric_block.html#metric_blocki68" target="diffFile">vol(i, j, ke) = vol(i, j, kl)</a>
<a name="metric_blocki69"></a>    <a href="metric_block.html#metric_blocki64" target="diffFile"><code class="keyword">END DO</code></a>
  <a href="metric_block.html#metric_blocki63" target="diffFile"><code class="keyword">END DO</code></a>
<a href="metric_block.html#metric_blocki69" target="diffFile"><code class="comment">! Set the factor in the surface normals computation. For a</code></a>
<a href="metric_block.html#metric_blocki69" target="diffFile"><code class="comment">! left handed block this factor is negative, such that the</code></a>
<a href="metric_block.html#metric_blocki69" target="diffFile"><code class="comment">! normals still point in the direction of increasing index.</code></a>
<a href="metric_block.html#metric_blocki69" target="diffFile"><code class="comment">! The formulae used later on assume a right handed block</code></a>
<a name="p7"></a><a href="metric_block.html#metric_blocki69" target="diffFile"><code class="comment">! and fact is used to correct this for a left handed block,</code></a>
<a name="metric_blocki70"></a><a href="metric_block.html#metric_blocki69" target="diffFile"><code class="comment">! as well as the scaling factor of 0.5</code></a>
<a name="metric_blocki71"></a>  <a href="metric_block.html#metric_blocki69" target="diffFile">result1 = </a><a href="msg.html#p7" target="msg"><code class="comment"><img src="danger.gif" align=middle border=0 alt="!" /></code></a><a href="metric_block.html#metric_blocki69" target="diffFile"><code class="funcname">FLOWDOMS</code>(nn, level, sps)</a>
  <a href="metric_block.html#metric_blocki70" target="diffFile"><code class="keyword">IF</code> (result1%righthanded) <code class="keyword">THEN</code></a>
<a name="metric_blocki72"></a>    <a href="metric_block.html#metric_blocki71" target="diffFile">fact = half</a>
  <a href="metric_block.html#metric_blocki70" target="diffFile"><code class="keyword">ELSE</code></a>
<a name="metric_blocki73"></a>    <a href="metric_block.html#metric_blocki72" target="diffFile">fact = -half</a>
  <a href="metric_block.html#metric_blocki70" target="diffFile"><code class="keyword">END IF</code></a>
<a href="metric_block.html#metric_blocki73" target="diffFile"><code class="comment">! Check if both positive and negative volumes occur. If so,</code></a>
<a href="metric_block.html#metric_blocki73" target="diffFile"><code class="comment">! the block is bad and the counter nBlockBad is updated.</code></a>
<a href="metric_block.html#metric_blocki73" target="diffFile"><code class="comment">!</code></a>
<a href="metric_block.html#metric_blocki73" target="diffFile"><code class="comment">!          **************************************************************</code></a>
<a href="metric_block.html#metric_blocki73" target="diffFile"><code class="comment">!          *                                                            *</code></a>
<a href="metric_block.html#metric_blocki73" target="diffFile"><code class="comment">!          * Computation of the face normals in i-, j- and k-direction. *</code></a>
<a href="metric_block.html#metric_blocki73" target="diffFile"><code class="comment">!          * Formula's are valid for a right handed block; for a left   *</code></a>
<a href="metric_block.html#metric_blocki73" target="diffFile"><code class="comment">!          * handed block the correct orientation is obtained via fact. *</code></a>
<a href="metric_block.html#metric_blocki73" target="diffFile"><code class="comment">!          * The normals point in the direction of increasing index.    *</code></a>
<a href="metric_block.html#metric_blocki73" target="diffFile"><code class="comment">!          * The absolute value of fact is 0.5, because the cross       *</code></a>
<a href="metric_block.html#metric_blocki73" target="diffFile"><code class="comment">!          * product of the two diagonals is twice the normal vector.   *</code></a>
<a href="metric_block.html#metric_blocki73" target="diffFile"><code class="comment">!          *                                                            *</code></a>
<a href="metric_block.html#metric_blocki73" target="diffFile"><code class="comment">!          * Note that also the normals of the first level halo cells   *</code></a>
<a href="metric_block.html#metric_blocki73" target="diffFile"><code class="comment">!          * are computed. These are needed for the viscous fluxes.     *</code></a>
<a href="metric_block.html#metric_blocki73" target="diffFile"><code class="comment">!          *                                                            *</code></a>
<a href="metric_block.html#metric_blocki73" target="diffFile"><code class="comment">!          **************************************************************</code></a>
<a href="metric_block.html#metric_blocki73" target="diffFile"><code class="comment">!</code></a>
<a name="metric_blocki74"></a><a href="metric_block.html#metric_blocki73" target="diffFile"><code class="comment">! Projected areas of cell faces in the i direction.</code></a>
<a name="metric_blocki75"></a>  <a href="metric_block.html#metric_blocki73" target="diffFile"><code class="keyword">DO </code>k=<code class="constant">1</code>,ke</a>
<a name="metric_blocki76"></a>    <a href="metric_block.html#metric_blocki74" target="diffFile">n = k - <code class="constant">1</code></a>
<a name="metric_blocki77"></a>    <a href="metric_block.html#metric_blocki75" target="diffFile"><code class="keyword">DO </code>j=<code class="constant">1</code>,je</a>
<a name="metric_blocki78"></a>      <a href="metric_block.html#metric_blocki76" target="diffFile">m = j - <code class="constant">1</code></a>
      <a href="metric_block.html#metric_blocki77" target="diffFile"><code class="keyword">DO </code>i=<code class="constant">0</code>,ie</a>
<a name="metric_blocki79"></a><a href="metric_block.html#metric_blocki78" target="diffFile"><code class="comment">! Determine the two diagonal vectors of the face.</code></a>
<a name="metric_blocki80"></a>        <a href="metric_block.html#metric_blocki78" target="diffFile">v1(<code class="constant">1</code>) = x(i, j, n, <code class="constant">1</code>) - x(i, m, k, <code class="constant">1</code>)</a>
<a name="metric_blocki81"></a>        <a href="metric_block.html#metric_blocki79" target="diffFile">v1(<code class="constant">2</code>) = x(i, j, n, <code class="constant">2</code>) - x(i, m, k, <code class="constant">2</code>)</a>
<a name="metric_blocki82"></a>        <a href="metric_block.html#metric_blocki80" target="diffFile">v1(<code class="constant">3</code>) = x(i, j, n, <code class="constant">3</code>) - x(i, m, k, <code class="constant">3</code>)</a>
<a name="metric_blocki83"></a>        <a href="metric_block.html#metric_blocki81" target="diffFile">v2(<code class="constant">1</code>) = x(i, j, k, <code class="constant">1</code>) - x(i, m, n, <code class="constant">1</code>)</a>
<a name="metric_blocki84"></a>        <a href="metric_block.html#metric_blocki82" target="diffFile">v2(<code class="constant">2</code>) = x(i, j, k, <code class="constant">2</code>) - x(i, m, n, <code class="constant">2</code>)</a>
        <a href="metric_block.html#metric_blocki83" target="diffFile">v2(<code class="constant">3</code>) = x(i, j, k, <code class="constant">3</code>) - x(i, m, n, <code class="constant">3</code>)</a>
<a href="metric_block.html#metric_blocki84" target="diffFile"><code class="comment">! The face normal, which is the cross product of the two</code></a>
<a href="metric_block.html#metric_blocki84" target="diffFile"><code class="comment">! diagonal vectors times fact; remember that fact is</code></a>
<a name="metric_blocki85"></a><a href="metric_block.html#metric_blocki84" target="diffFile"><code class="comment">! either -0.5 or 0.5.</code></a>
<a name="metric_blocki86"></a>        <a href="metric_block.html#metric_blocki84" target="diffFile">si(i, j, k, <code class="constant">1</code>) = fact*(v1(<code class="constant">2</code>)*v2(<code class="constant">3</code>)-v1(<code class="constant">3</code>)*v2(<code class="constant">2</code>))</a>
        <a href="metric_block.html#metric_blocki85" target="diffFile">si(i, j, k, <code class="constant">2</code>) = fact*(v1(<code class="constant">3</code>)*v2(<code class="constant">1</code>)-v1(<code class="constant">1</code>)*v2(<code class="constant">3</code>))</a>
        <a href="metric_block.html#metric_blocki86" target="diffFile">si(i, j, k, <code class="constant">3</code>) = fact*(v1(<code class="constant">1</code>)*v2(<code class="constant">2</code>)-v1(<code class="constant">2</code>)*v2(<code class="constant">1</code>))</a>
      <a href="metric_block.html#metric_blocki77" target="diffFile"><code class="keyword">END DO</code></a>
<a name="metric_blocki87"></a>    <a href="metric_block.html#metric_blocki75" target="diffFile"><code class="keyword">END DO</code></a>
  <a href="metric_block.html#metric_blocki73" target="diffFile"><code class="keyword">END DO</code></a>
<a name="metric_blocki88"></a><a href="metric_block.html#metric_blocki87" target="diffFile"><code class="comment">! Projected areas of cell faces in the j direction.</code></a>
<a name="metric_blocki89"></a>  <a href="metric_block.html#metric_blocki87" target="diffFile"><code class="keyword">DO </code>k=<code class="constant">1</code>,ke</a>
<a name="metric_blocki90"></a>    <a href="metric_block.html#metric_blocki88" target="diffFile">n = k - <code class="constant">1</code></a>
<a name="metric_blocki91"></a>    <a href="metric_block.html#metric_blocki89" target="diffFile"><code class="keyword">DO </code>j=<code class="constant">0</code>,je</a>
<a name="metric_blocki92"></a>      <a href="metric_block.html#metric_blocki90" target="diffFile"><code class="keyword">DO </code>i=<code class="constant">1</code>,ie</a>
        <a href="metric_block.html#metric_blocki91" target="diffFile">l = i - <code class="constant">1</code></a>
<a name="metric_blocki93"></a><a href="metric_block.html#metric_blocki92" target="diffFile"><code class="comment">! Determine the two diagonal vectors of the face.</code></a>
<a name="metric_blocki94"></a>        <a href="metric_block.html#metric_blocki92" target="diffFile">v1(<code class="constant">1</code>) = x(i, j, n, <code class="constant">1</code>) - x(l, j, k, <code class="constant">1</code>)</a>
<a name="metric_blocki95"></a>        <a href="metric_block.html#metric_blocki93" target="diffFile">v1(<code class="constant">2</code>) = x(i, j, n, <code class="constant">2</code>) - x(l, j, k, <code class="constant">2</code>)</a>
<a name="metric_blocki96"></a>        <a href="metric_block.html#metric_blocki94" target="diffFile">v1(<code class="constant">3</code>) = x(i, j, n, <code class="constant">3</code>) - x(l, j, k, <code class="constant">3</code>)</a>
<a name="metric_blocki97"></a>        <a href="metric_block.html#metric_blocki95" target="diffFile">v2(<code class="constant">1</code>) = x(l, j, n, <code class="constant">1</code>) - x(i, j, k, <code class="constant">1</code>)</a>
<a name="metric_blocki98"></a>        <a href="metric_block.html#metric_blocki96" target="diffFile">v2(<code class="constant">2</code>) = x(l, j, n, <code class="constant">2</code>) - x(i, j, k, <code class="constant">2</code>)</a>
        <a href="metric_block.html#metric_blocki97" target="diffFile">v2(<code class="constant">3</code>) = x(l, j, n, <code class="constant">3</code>) - x(i, j, k, <code class="constant">3</code>)</a>
<a href="metric_block.html#metric_blocki98" target="diffFile"><code class="comment">! The face normal, which is the cross product of the two</code></a>
<a href="metric_block.html#metric_blocki98" target="diffFile"><code class="comment">! diagonal vectors times fact; remember that fact is</code></a>
<a name="metric_blocki99"></a><a href="metric_block.html#metric_blocki98" target="diffFile"><code class="comment">! either -0.5 or 0.5.</code></a>
<a name="metric_blocki100"></a>        <a href="metric_block.html#metric_blocki98" target="diffFile">sj(i, j, k, <code class="constant">1</code>) = fact*(v1(<code class="constant">2</code>)*v2(<code class="constant">3</code>)-v1(<code class="constant">3</code>)*v2(<code class="constant">2</code>))</a>
        <a href="metric_block.html#metric_blocki99" target="diffFile">sj(i, j, k, <code class="constant">2</code>) = fact*(v1(<code class="constant">3</code>)*v2(<code class="constant">1</code>)-v1(<code class="constant">1</code>)*v2(<code class="constant">3</code>))</a>
        <a href="metric_block.html#metric_blocki100" target="diffFile">sj(i, j, k, <code class="constant">3</code>) = fact*(v1(<code class="constant">1</code>)*v2(<code class="constant">2</code>)-v1(<code class="constant">2</code>)*v2(<code class="constant">1</code>))</a>
      <a href="metric_block.html#metric_blocki90" target="diffFile"><code class="keyword">END DO</code></a>
<a name="metric_blocki101"></a>    <a href="metric_block.html#metric_blocki89" target="diffFile"><code class="keyword">END DO</code></a>
  <a href="metric_block.html#metric_blocki87" target="diffFile"><code class="keyword">END DO</code></a>
<a name="metric_blocki102"></a><a href="metric_block.html#metric_blocki101" target="diffFile"><code class="comment">! Projected areas of cell faces in the k direction.</code></a>
<a name="metric_blocki103"></a>  <a href="metric_block.html#metric_blocki101" target="diffFile"><code class="keyword">DO </code>k=<code class="constant">0</code>,ke</a>
<a name="metric_blocki104"></a>    <a href="metric_block.html#metric_blocki102" target="diffFile"><code class="keyword">DO </code>j=<code class="constant">1</code>,je</a>
<a name="metric_blocki105"></a>      <a href="metric_block.html#metric_blocki103" target="diffFile">m = j - <code class="constant">1</code></a>
<a name="metric_blocki106"></a>      <a href="metric_block.html#metric_blocki104" target="diffFile"><code class="keyword">DO </code>i=<code class="constant">1</code>,ie</a>
        <a href="metric_block.html#metric_blocki105" target="diffFile">l = i - <code class="constant">1</code></a>
<a name="metric_blocki107"></a><a href="metric_block.html#metric_blocki106" target="diffFile"><code class="comment">! Determine the two diagonal vectors of the face.</code></a>
<a name="metric_blocki108"></a>        <a href="metric_block.html#metric_blocki106" target="diffFile">v1(<code class="constant">1</code>) = x(i, j, k, <code class="constant">1</code>) - x(l, m, k, <code class="constant">1</code>)</a>
<a name="metric_blocki109"></a>        <a href="metric_block.html#metric_blocki107" target="diffFile">v1(<code class="constant">2</code>) = x(i, j, k, <code class="constant">2</code>) - x(l, m, k, <code class="constant">2</code>)</a>
<a name="metric_blocki110"></a>        <a href="metric_block.html#metric_blocki108" target="diffFile">v1(<code class="constant">3</code>) = x(i, j, k, <code class="constant">3</code>) - x(l, m, k, <code class="constant">3</code>)</a>
<a name="metric_blocki111"></a>        <a href="metric_block.html#metric_blocki109" target="diffFile">v2(<code class="constant">1</code>) = x(l, j, k, <code class="constant">1</code>) - x(i, m, k, <code class="constant">1</code>)</a>
<a name="metric_blocki112"></a>        <a href="metric_block.html#metric_blocki110" target="diffFile">v2(<code class="constant">2</code>) = x(l, j, k, <code class="constant">2</code>) - x(i, m, k, <code class="constant">2</code>)</a>
        <a href="metric_block.html#metric_blocki111" target="diffFile">v2(<code class="constant">3</code>) = x(l, j, k, <code class="constant">3</code>) - x(i, m, k, <code class="constant">3</code>)</a>
<a href="metric_block.html#metric_blocki112" target="diffFile"><code class="comment">! The face normal, which is the cross product of the two</code></a>
<a href="metric_block.html#metric_blocki112" target="diffFile"><code class="comment">! diagonal vectors times fact; remember that fact is</code></a>
<a name="metric_blocki113"></a><a href="metric_block.html#metric_blocki112" target="diffFile"><code class="comment">! either -0.5 or 0.5.</code></a>
<a name="metric_blocki114"></a>        <a href="metric_block.html#metric_blocki112" target="diffFile">sk(i, j, k, <code class="constant">1</code>) = fact*(v1(<code class="constant">2</code>)*v2(<code class="constant">3</code>)-v1(<code class="constant">3</code>)*v2(<code class="constant">2</code>))</a>
        <a href="metric_block.html#metric_blocki113" target="diffFile">sk(i, j, k, <code class="constant">2</code>) = fact*(v1(<code class="constant">3</code>)*v2(<code class="constant">1</code>)-v1(<code class="constant">1</code>)*v2(<code class="constant">3</code>))</a>
        <a href="metric_block.html#metric_blocki114" target="diffFile">sk(i, j, k, <code class="constant">3</code>) = fact*(v1(<code class="constant">1</code>)*v2(<code class="constant">2</code>)-v1(<code class="constant">2</code>)*v2(<code class="constant">1</code>))</a>
      <a href="metric_block.html#metric_blocki104" target="diffFile"><code class="keyword">END DO</code></a>
<a name="metric_blocki115"></a>    <a href="metric_block.html#metric_blocki102" target="diffFile"><code class="keyword">END DO</code></a>
  <a href="metric_block.html#metric_blocki101" target="diffFile"><code class="keyword">END DO</code></a>
<a href="metric_block.html#metric_blocki115" target="diffFile"><code class="comment">!</code></a>
<a href="metric_block.html#metric_blocki115" target="diffFile"><code class="comment">!          **************************************************************</code></a>
<a href="metric_block.html#metric_blocki115" target="diffFile"><code class="comment">!          *                                                            *</code></a>
<a href="metric_block.html#metric_blocki115" target="diffFile"><code class="comment">!          * The unit normals on the boundary faces. These always point *</code></a>
<a href="metric_block.html#metric_blocki115" target="diffFile"><code class="comment">!          * out of the domain, so a multiplication by -1 is needed for *</code></a>
<a href="metric_block.html#metric_blocki115" target="diffFile"><code class="comment">!          * the iMin, jMin and kMin boundaries.                        *</code></a>
<a href="metric_block.html#metric_blocki115" target="diffFile"><code class="comment">!          *                                                            *</code></a>
<a href="metric_block.html#metric_blocki115" target="diffFile"><code class="comment">!          **************************************************************</code></a>
<a href="metric_block.html#metric_blocki115" target="diffFile"><code class="comment">!</code></a>
<a name="metric_blocki116"></a><a href="metric_block.html#metric_blocki115" target="diffFile"><code class="comment">! Loop over the boundary subfaces of this block.</code></a>
<a href="metric_block.html#metric_blocki115" target="diffFile"><code class="label">bocoloop:</code><code class="keyword">DO </code>mm=<code class="constant">1</code>,nbocos</a>
<a href="metric_block.html#metric_blocki116" target="diffFile"><code class="comment">! Determine the block face on which this subface is located</code></a>
<a href="metric_block.html#metric_blocki116" target="diffFile"><code class="comment">! and set ss and mult accordingly.</code></a>
<a name="metric_blocki117"></a>    <a href="metric_block.html#metric_blocki116" target="diffFile"><code class="keyword">SELECT CASE </code> (bcfaceid(mm)) </a>
    <a href="metric_block.html#metric_blocki116" target="diffFile"><code class="keyword">CASE </code>(imin) </a>
      <a href="metric_block.html#metric_blocki117" target="diffFile">mult = -one</a>
<a name="metric_blocki119"></a>      <a href="metric_block.html#metric_blocki116" target="diffFile">ss => si(<code class="constant">1</code>, :, :, :)</a>
    <a href="metric_block.html#metric_blocki116" target="diffFile"><code class="keyword">CASE </code>(imax) </a>
      <a href="metric_block.html#metric_blocki119" target="diffFile">mult = one</a>
<a name="metric_blocki121"></a>      <a href="metric_block.html#metric_blocki116" target="diffFile">ss => si(il, :, :, :)</a>
    <a href="metric_block.html#metric_blocki116" target="diffFile"><code class="keyword">CASE </code>(jmin) </a>
      <a href="metric_block.html#metric_blocki121" target="diffFile">mult = -one</a>
<a name="metric_blocki123"></a>      <a href="metric_block.html#metric_blocki116" target="diffFile">ss => sj(:, <code class="constant">1</code>, :, :)</a>
    <a href="metric_block.html#metric_blocki116" target="diffFile"><code class="keyword">CASE </code>(jmax) </a>
      <a href="metric_block.html#metric_blocki123" target="diffFile">mult = one</a>
<a name="metric_blocki125"></a>      <a href="metric_block.html#metric_blocki116" target="diffFile">ss => sj(:, jl, :, :)</a>
    <a href="metric_block.html#metric_blocki116" target="diffFile"><code class="keyword">CASE </code>(kmin) </a>
      <a href="metric_block.html#metric_blocki125" target="diffFile">mult = -one</a>
<a name="metric_blocki127"></a>      <a href="metric_block.html#metric_blocki116" target="diffFile">ss => sk(:, :, <code class="constant">1</code>, :)</a>
    <a href="metric_block.html#metric_blocki116" target="diffFile"><code class="keyword">CASE </code>(kmax) </a>
      <a href="metric_block.html#metric_blocki127" target="diffFile">mult = one</a>
<a name="metric_blocki129"></a>      <a href="metric_block.html#metric_blocki116" target="diffFile">ss => sk(:, :, kl, :)</a>
    <a href="metric_block.html#metric_blocki116" target="diffFile"><code class="keyword">END SELECT</code></a>
<a name="metric_blocki130"></a><a href="metric_block.html#metric_blocki129" target="diffFile"><code class="comment">! Loop over the boundary faces of the subface.</code></a>
<a name="metric_blocki131"></a>    <a href="metric_block.html#metric_blocki129" target="diffFile"><code class="keyword">DO </code>j=bcdata(mm)%jcbeg,bcdata(mm)%jcend</a>
      <a href="metric_block.html#metric_blocki130" target="diffFile"><code class="keyword">DO </code>i=bcdata(mm)%icbeg,bcdata(mm)%icend</a>
<a name="p41"></a><a href="metric_block.html#metric_blocki131" target="diffFile"><code class="comment">! Compute the inverse of the length of the normal vector</code></a>
<a name="p42"></a><a name="metric_blocki132"></a><a href="metric_block.html#metric_blocki131" target="diffFile"><code class="comment">! and possibly correct for inward pointing.</code></a>
<a name="p43"></a><a name="metric_blocki133"></a>        <a href="metric_block.html#metric_blocki131" target="diffFile">xp = </a><a href="msg.html#p41" target="msg"><code class="comment"><img src="danger.gif" align=middle border=0 alt="!" /></code></a><a href="metric_block.html#metric_blocki131" target="diffFile">ss(i, j, <code class="constant">1</code>)</a>
<a name="metric_blocki134"></a>        <a href="metric_block.html#metric_blocki132" target="diffFile">yp = </a><a href="msg.html#p42" target="msg"><code class="comment"><img src="danger.gif" align=middle border=0 alt="!" /></code></a><a href="metric_block.html#metric_blocki132" target="diffFile">ss(i, j, <code class="constant">2</code>)</a>
<a name="metric_blocki135"></a>        <a href="metric_block.html#metric_blocki133" target="diffFile">zp = </a><a href="msg.html#p43" target="msg"><code class="comment"><img src="danger.gif" align=middle border=0 alt="!" /></code></a><a href="metric_block.html#metric_blocki133" target="diffFile">ss(i, j, <code class="constant">3</code>)</a>
<a name="metric_blocki137"></a><a name="metric_blocki136"></a>        <a href="metric_block.html#metric_blocki134" target="diffFile">arg1 = xp*xp + yp*yp + zp*zp</a>
<a name="metric_blocki138"></a>        <a href="metric_block.html#metric_blocki135" target="diffFile">fact = <code class="funcname">SQRT</code>(arg1)</a>
        <a href="metric_block.html#metric_blocki136" target="diffFile"><code class="keyword">IF</code> (fact .GT. zero) </a><a href="metric_block.html#metric_blocki137" target="diffFile">fact = mult/fact</a>
<a name="metric_blocki139"></a><a href="metric_block.html#metric_blocki138" target="diffFile"><code class="comment">! Compute the unit normal.</code></a>
<a name="metric_blocki140"></a>        <a href="metric_block.html#metric_blocki138" target="diffFile">bcdata(mm)%norm(i, j, <code class="constant">1</code>) = fact*xp</a>
        <a href="metric_block.html#metric_blocki139" target="diffFile">bcdata(mm)%norm(i, j, <code class="constant">2</code>) = fact*yp</a>
        <a href="metric_block.html#metric_blocki140" target="diffFile">bcdata(mm)%norm(i, j, <code class="constant">3</code>) = fact*zp</a>
      <a href="metric_block.html#metric_blocki130" target="diffFile"><code class="keyword">END DO</code></a>
    <a href="metric_block.html#metric_blocki129" target="diffFile"><code class="keyword">END DO</code></a>
  <a href="metric_block.html#metric_blocki115" target="diffFile"><code class="keyword">END DO </code><code class="label">bocoloop</code></a>
<a name="volpym"></a>
<a href="metric_block.html#metric_block" target="diffFile"><code class="keyword">CONTAINS</code></a>
<a href="metric_block.html#volpym" target="diffFile"><code class="comment">!        ================================================================</code></a>
  <a href="metric_block.html#volpym" target="diffFile"><code class="keyword">FUNCTION </code><code class="funcname">VOLPYM</code>(<code class="vardecl">xa</code>, <code class="vardecl">ya</code>, <code class="vardecl">za</code>, <code class="vardecl">xb</code>, <code class="vardecl">yb</code>, <code class="vardecl">zb</code>, <code class="vardecl">xc</code>, <code class="vardecl">yc</code>, <code class="vardecl">zc</code>, <code class="vardecl">xd</code>, <code class="vardecl">yd</code>, <code class="vardecl">zd</code>)</a>
<a name="volpymi0"></a>    <a href="metric_block.html#volpym" target="diffFile"><code class="keyword">USE </code><code class="funcname">PRECISION</code></a>
    <a href="metric_block.html#volpym" target="diffFile"><code class="keyword">IMPLICIT NONE</code></a>
<a href="metric_block.html#volpymi0" target="diffFile"><code class="comment">!</code></a>
<a href="metric_block.html#volpymi0" target="diffFile"><code class="comment">!        ****************************************************************</code></a>
<a href="metric_block.html#volpymi0" target="diffFile"><code class="comment">!        *                                                              *</code></a>
<a href="metric_block.html#volpymi0" target="diffFile"><code class="comment">!        * volpym computes 6 times the volume of a pyramid. Node p,     *</code></a>
<a href="metric_block.html#volpymi0" target="diffFile"><code class="comment">!        * whose coordinates are set in the subroutine metric itself,   *</code></a>
<a href="metric_block.html#volpymi0" target="diffFile"><code class="comment">!        * is the top node and a-b-c-d is the quadrilateral surface.    *</code></a>
<a href="metric_block.html#volpymi0" target="diffFile"><code class="comment">!        * It is assumed that the cross product vCa * vDb points in     *</code></a>
<a href="metric_block.html#volpymi0" target="diffFile"><code class="comment">!        * the direction of the top node. Here vCa is the diagonal      *</code></a>
<a href="metric_block.html#volpymi0" target="diffFile"><code class="comment">!        * running from node c to node a and vDb the diagonal from      *</code></a>
<a href="metric_block.html#volpymi0" target="diffFile"><code class="comment">!        * node d to node b.                                            *</code></a>
<a href="metric_block.html#volpymi0" target="diffFile"><code class="comment">!        *                                                              *</code></a>
<a href="metric_block.html#volpymi0" target="diffFile"><code class="comment">!        ****************************************************************</code></a>
<a href="metric_block.html#volpymi0" target="diffFile"><code class="comment">!</code></a>
<a href="metric_block.html#volpymi0" target="diffFile"><code class="comment">!</code></a>
<a href="metric_block.html#volpymi0" target="diffFile"><code class="comment">!        Function type.</code></a>
<a name="volpymi1"></a><a href="metric_block.html#volpymi0" target="diffFile"><code class="comment">!</code></a>
    <a href="metric_block.html#volpymi0" target="diffFile"><code class="typename">REAL(</code><code class="keyword">kind</code>=<code class="modifier">realtype</code><code class="typename">) </code>:: <code class="vardecl">volpym</code></a>
<a href="metric_block.html#volpymi1" target="diffFile"><code class="comment">!</code></a>
<a href="metric_block.html#volpymi1" target="diffFile"><code class="comment">!        Function arguments.</code></a>
<a name="volpymi2"></a><a href="metric_block.html#volpymi1" target="diffFile"><code class="comment">!</code></a>
<a name="volpymi3"></a>    <a href="metric_block.html#volpymi1" target="diffFile"><code class="typename">REAL(</code><code class="keyword">kind</code>=<code class="modifier">realtype</code><code class="typename">)</code>, <code class="typename">INTENT(IN) </code>:: <code class="vardecl">xa</code>, <code class="vardecl">ya</code>, <code class="vardecl">za</code>, <code class="vardecl">xb</code>, <code class="vardecl">yb</code>, <code class="vardecl">zb</code></a>
    <a href="metric_block.html#volpymi2" target="diffFile"><code class="typename">REAL(</code><code class="keyword">kind</code>=<code class="modifier">realtype</code><code class="typename">)</code>, <code class="typename">INTENT(IN) </code>:: <code class="vardecl">xc</code>, <code class="vardecl">yc</code>, <code class="vardecl">zc</code>, <code class="vardecl">xd</code>, <code class="vardecl">yd</code>, <code class="vardecl">zd</code></a>
<a href="metric_block.html#volpymi3" target="diffFile"><code class="comment">!</code></a>
<a href="metric_block.html#volpymi3" target="diffFile"><code class="comment">!        ****************************************************************</code></a>
<a href="metric_block.html#volpymi3" target="diffFile"><code class="comment">!        *                                                              *</code></a>
<a href="metric_block.html#volpymi3" target="diffFile"><code class="comment">!        * Begin execution                                              *</code></a>
<a href="metric_block.html#volpymi3" target="diffFile"><code class="comment">!        *                                                              *</code></a>
<a href="metric_block.html#volpymi3" target="diffFile"><code class="comment">!        ****************************************************************</code></a>
<a href="metric_block.html#volpymi3" target="diffFile"><code class="comment">!</code></a>
    <a href="metric_block.html#volpymi3" target="diffFile">volpym = (xp-fourth*(xa+xb+xc+xd))*((ya-yc)*(zb-zd)-(za-zc)*(yb-yd))<code class="label">&</code></a>
<a href="metric_block.html#volpymi3" target="diffFile"><code class="label">&      </code>+ (yp-fourth*(ya+yb+yc+yd))*((za-zc)*(xb-xd)-(xa-xc)*(zb-zd)) + (<code class="label">&</code></a>
<a href="metric_block.html#volpymi3" target="diffFile"><code class="label">&      </code>zp-fourth*(za+zb+zc+zd))*((xa-xc)*(yb-yd)-(ya-yc)*(xb-xd))</a>
  <a href="metric_block.html#volpym" target="diffFile"><code class="keyword">END FUNCTION </code><code class="funcname">VOLPYM</code></a>
<a href="metric_block.html#metric_block" target="diffFile"><code class="keyword">END SUBROUTINE </code><code class="funcname">METRIC_BLOCK</code></a>
</pre>
</body>
