!        Generated by TAPENADE     (INRIA, Tropics team)
!  Tapenade 3.4 (r3375) - 10 Feb 2010 15:08
!
!
!      ******************************************************************
!      *                                                                *
!      * File:          computeUtau.f90                                 *
!      * Author:        Georgi Kalitzin, Edwin van der Weide            *
!      * Starting date: 03-03-2004                                      *
!      * Last modified: 03-25-2005                                      *
!      *                                                                *
!      ******************************************************************
!
SUBROUTINE COMPUTEUTAU_BLOCK_CD()
  USE BCTYPES_SPATIAL_D
  USE INPUTPHYSICS_SPATIAL_D
  USE ITERATION_SPATIAL_D
  USE INPUTTIMESPECTRAL_SPATIAL_D
  USE BLOCKPOINTERS_SPATIAL_D
  IMPLICIT NONE
!
!      ******************************************************************
!      *                                                                *
!      * computeUtau computes the skin friction velocity for the        *
!      * viscous subfaces. This data is only needed if wall functions   *
!      * are used.                                                      *
!      *                                                                *
!      ******************************************************************
!
!
!      Local variables.
!
  INTEGER(kind=inttype) :: sps, nn, mm, i, j
  REAL(kind=realtype) :: re, vx, vy, vz, veln, veltmag
  REAL(kind=realtype), DIMENSION(:, :, :), POINTER :: ww, norm, uslip
  REAL(kind=realtype), DIMENSION(:, :), POINTER :: dd2wall, rrlv
  REAL(kind=realtype), DIMENSION(:, :), POINTER :: utau
!
!      Function definition.
!
  REAL(kind=realtype) :: CURVEUPRE_CD
  REAL(kind=realtype) :: arg1
  INTRINSIC MAX
  REAL(kind=realtype) :: x1
  INTRINSIC SQRT
  REAL(kind=realtype) :: max1
  REAL(kind=realtype) :: y1
!
!      ******************************************************************
!      *                                                                *
!      * Begin execution                                                *
!      *                                                                *
!      ******************************************************************
!
! Return immediately if no wall functions must be used.
  IF (.NOT.wallfunctions) THEN
    RETURN
  ELSE
! Loop over the number of spectral solutions and local blocks.
! Loop over the viscous subfaces of this block.
viscsubfaces:DO mm=1,nviscbocos
! Set a bunch of pointers depending on the face id to make
! a generic treatment possible.
      SELECT CASE  (bcfaceid(mm)) 
      CASE (imin) 
        ww => w(2, 1:, 1:, :)
        dd2wall => d2wall(2, :, :)
        rrlv => rlv(2, 1:, 1:)
      CASE (imax) 
!=========================================================
        ww => w(il, 1:, 1:, :)
        dd2wall => d2wall(il, :, :)
        rrlv => rlv(il, 1:, 1:)
      CASE (jmin) 
!=========================================================
        ww => w(1:, 2, 1:, :)
        dd2wall => d2wall(:, 2, :)
        rrlv => rlv(1:, 2, 1:)
      CASE (jmax) 
!=========================================================
        ww => w(1:, jl, 1:, :)
        dd2wall => d2wall(:, jl, :)
        rrlv => rlv(1:, jl, 1:)
      CASE (kmin) 
!=========================================================
        ww => w(1:, 1:, 2, :)
        dd2wall => d2wall(:, :, 2)
        rrlv => rlv(1:, 1:, 2)
      CASE (kmax) 
!=========================================================
        ww => w(1:, 1:, kl, :)
        dd2wall => d2wall(:, :, kl)
        rrlv => rlv(1:, 1:, kl)
      END SELECT
! Set the pointers for the unit outward normals, uSlip
! and utau to make the code more readable.
      norm => bcdata(mm)%norm
      uslip => bcdata(mm)%uslip
      utau => viscsubface(mm)%utau
! Loop over the quadrilateral faces of the subface. Note
! that the nodal range of BCData must be used and not the
! cell range, because the latter may include the halo's in i
! and j-direction. The offset +1 is there, because inBeg and
! jnBeg refer to nodal ranges and not to cell ranges.
! Note that an offset of -1 must be used in dd2Wall, because
! the original array d2Wall starts at 2.
      DO j=bcdata(mm)%jnbeg+1,bcdata(mm)%jnend
        DO i=bcdata(mm)%inbeg+1,bcdata(mm)%inend
! Compute the velocity difference between the internal
! cell and the wall.
          vx = ww(i, j, ivx) - uslip(i, j, 1)
          vy = ww(i, j, ivy) - uslip(i, j, 2)
          vz = ww(i, j, ivz) - uslip(i, j, 3)
! Compute the normal velocity of the internal cell.
          veln = vx*norm(i, j, 1) + vy*norm(i, j, 2) + vz*norm(i, j, 3)
          arg1 = vx*vx + vy*vy + vz*vz - veln*veln
          y1 = SQRT(arg1)
          IF (eps .LT. y1) THEN
            veltmag = y1
          ELSE
            veltmag = eps
          END IF
! Compute the Reynolds number. Note that an offset of -1
! must be used in dd2Wall, because the original array
! d2Wall starts at 2.
! Afterwards compute utau.
          re = ww(i, j, irho)*veltmag*dd2wall(i-1, j-1)/rrlv(i, j)
          x1 = CURVEUPRE_CD(re)
          IF (x1 .LT. eps) THEN
            max1 = eps
          ELSE
            max1 = x1
          END IF
          utau(i, j) = veltmag/max1
        END DO
      END DO
    END DO viscsubfaces
  END IF
END SUBROUTINE COMPUTEUTAU_BLOCK_CD
