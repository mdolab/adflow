!        Generated by TAPENADE     (INRIA, Tropics team)
!  Tapenade 3.4 (r3375) - 10 Feb 2010 15:08
!
!
!      ******************************************************************
!      *                                                                *
!      * File:          turbBCNSWall.f90                                *
!      * Author:        Edwin van der Weide                             *
!      * Starting date: 05-30-2003                                      *
!      * Last modified: 06-12-2005                                      *
!      *                                                                *
!      ******************************************************************
!
SUBROUTINE TURBBCNSWALL_CD(secondhalo)
  USE BCTYPES_SPATIAL_D
  USE BLOCKPOINTERS_SPATIAL_D
  USE FLOWVARREFSTATE_SPATIAL_D
  IMPLICIT NONE
!
!      ******************************************************************
!      *                                                                *
!      * turbBCNSWall applies the viscous wall boundary conditions      *
!      * of the turbulent transport equations to a block. It is assumed *
!      * that the pointers in blockPointers are already set to the      *
!      * correct block on the correct grid level.                       *
!      *                                                                *
!      ******************************************************************
!
!
!      Subroutine argument.
!
  LOGICAL, INTENT(IN) :: secondhalo
!
!      Local variables.
!
  INTEGER(kind=inttype) :: nn, i, j, l, m
  REAL(kind=realtype), DIMENSION(:, :, :, :), POINTER :: bmt
  REAL(kind=realtype), DIMENSION(:, :, :), POINTER :: bvt
  REAL(kind=realtype), DIMENSION(:, :, :), POINTER :: ww0, ww1, ww2
  REAL(kind=realtype), DIMENSION(:, :), POINTER :: rev0, rev1, rev2
!
!      ******************************************************************
!      *                                                                *
!      * Begin execution                                                *
!      *                                                                *
!      ******************************************************************
!
! Loop over the viscous subfaces of this block.
bocos:DO nn=1,nviscbocos
! Set the corresponding arrays.
    CALL BCTURBWALL_CD(nn)
! Determine the block face on which this subface is located
! and set some pointers accordingly.
    SELECT CASE  (bcfaceid(nn)) 
    CASE (imin) 
      bmt => bmti1
      bvt => bvti1
      ww0 => w(0, 1:, 1:, :)
      ww1 => w(1, 1:, 1:, :)
      ww2 => w(2, 1:, 1:, :)
      IF (eddymodel) THEN
        rev0 => rev(0, 1:, 1:)
        rev1 => rev(1, 1:, 1:)
        rev2 => rev(2, 1:, 1:)
      END IF
    CASE (imax) 
      bmt => bmti2
      bvt => bvti2
      ww0 => w(ib, 1:, 1:, :)
      ww1 => w(ie, 1:, 1:, :)
      ww2 => w(il, 1:, 1:, :)
      IF (eddymodel) THEN
        rev0 => rev(ib, 1:, 1:)
        rev1 => rev(ie, 1:, 1:)
        rev2 => rev(il, 1:, 1:)
      END IF
    CASE (jmin) 
      bmt => bmtj1
      bvt => bvtj1
      ww0 => w(1:, 0, 1:, :)
      ww1 => w(1:, 1, 1:, :)
      ww2 => w(1:, 2, 1:, :)
      IF (eddymodel) THEN
        rev0 => rev(1:, 0, 1:)
        rev1 => rev(1:, 1, 1:)
        rev2 => rev(1:, 2, 1:)
      END IF
    CASE (jmax) 
      bmt => bmtj2
      bvt => bvtj2
      ww0 => w(1:, jb, 1:, :)
      ww1 => w(1:, je, 1:, :)
      ww2 => w(1:, jl, 1:, :)
      IF (eddymodel) THEN
        rev0 => rev(1:, jb, 1:)
        rev1 => rev(1:, je, 1:)
        rev2 => rev(1:, jl, 1:)
      END IF
    CASE (kmin) 
      bmt => bmtk1
      bvt => bvtk1
      ww0 => w(1:, 1:, 0, :)
      ww1 => w(1:, 1:, 1, :)
      ww2 => w(1:, 1:, 2, :)
      IF (eddymodel) THEN
        rev0 => rev(1:, 1:, 0)
        rev1 => rev(1:, 1:, 1)
        rev2 => rev(1:, 1:, 2)
      END IF
    CASE (kmax) 
      bmt => bmtk2
      bvt => bvtk2
      ww0 => w(1:, 1:, kb, :)
      ww1 => w(1:, 1:, ke, :)
      ww2 => w(1:, 1:, kl, :)
      IF (eddymodel) THEN
        rev0 => rev(1:, 1:, kb)
        rev1 => rev(1:, 1:, ke)
        rev2 => rev(1:, 1:, kl)
      END IF
    END SELECT
! Loop over the faces and set the state in
! the turbulent halo cells.
    DO j=bcdata(nn)%jcbeg,bcdata(nn)%jcend
      DO i=bcdata(nn)%icbeg,bcdata(nn)%icend
        DO l=nt1,nt2
          ww1(i, j, l) = bvt(i, j, l)
          DO m=nt1,nt2
            ww1(i, j, l) = ww1(i, j, l) - bmt(i, j, l, m)*ww2(i, j, m)
          END DO
        END DO
      END DO
    END DO
! Use constant extrapolation if the state in the second halo
! must be computed.
    IF (secondhalo) THEN
      DO j=bcdata(nn)%jcbeg,bcdata(nn)%jcend
        DO i=bcdata(nn)%icbeg,bcdata(nn)%icend
          DO l=nt1,nt2
            ww0(i, j, l) = ww1(i, j, l)
          END DO
        END DO
      END DO
    END IF
! Set the eddy viscosity for an eddy model.
    IF (eddymodel) THEN
      DO j=bcdata(nn)%jcbeg,bcdata(nn)%jcend
        DO i=bcdata(nn)%icbeg,bcdata(nn)%icend
          rev1(i, j) = -rev2(i, j)
        END DO
      END DO
      IF (secondhalo) THEN
        DO j=bcdata(nn)%jcbeg,bcdata(nn)%jcend
          DO i=bcdata(nn)%icbeg,bcdata(nn)%icend
            rev0(i, j) = rev1(i, j)
          END DO
        END DO
      END IF
    END IF
  END DO bocos
END SUBROUTINE TURBBCNSWALL_CD
