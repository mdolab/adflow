!        Generated by TAPENADE     (INRIA, Tropics team)
!  Tapenade 3.7 (r4786) - 21 Feb 2013 15:53
!
!  Differentiation of getcostfunction in reverse (adjoint) mode (with options i4 dr8 r8):
!   gradient     of useful results: objvalue
!   with respect to varying inputs: machgrid lengthref machcoef
!                pointref moment objvalue alpha force beta
!   RW status of diff variables: machgrid:out lengthref:out machcoef:out
!                pointref:out moment:out objvalue:in-zero alpha:out
!                force:out beta:out
SUBROUTINE GETCOSTFUNCTION_B(costfunction, force, forceb, moment, &
     &  momentb, alpha, alphab, beta, betab, liftindex, objvalue, objvalueb)
  USE INPUTTIMESPECTRAL
  USE COSTFUNCTIONS
  USE INPUTPHYSICS
  USE FLOWVARREFSTATE
  IMPLICIT NONE
  ! Compute the value of the actual objective function based on the
  ! (summed) forces and moments and any other "extra" design
  ! variables. The index of the objective is determined by 'iDV'. This
  ! function is intended to be AD'ed in reverse mode. 
  ! Input 
  INTEGER(kind=inttype), INTENT(IN) :: costfunction
  INTEGER(kind=inttype), INTENT(IN) :: liftindex
  REAL(kind=realtype), DIMENSION(3, ntimeintervalsspectral), INTENT(IN) &
       &  :: force, moment
  REAL(kind=realtype), DIMENSION(3, ntimeintervalsspectral) :: forceb, &
       &  momentb
  REAL(kind=realtype), INTENT(IN) :: alpha, beta
  REAL(kind=realtype) :: alphab, betab
  ! Output
  REAL(kind=realtype) :: objvalue
  REAL(kind=realtype) :: objvalueb
  ! Working
  REAL(kind=realtype) :: fact, factmoment, scaledim, ovrnts
  REAL(kind=realtype) :: factb, factmomentb
  REAL(kind=realtype), DIMENSION(3) :: cf, cm
  REAL(kind=realtype), DIMENSION(3) :: cfb, cmb
  REAL(kind=realtype) :: elasticmomentx, elasticmomenty, elasticmomentz
  REAL(kind=realtype), DIMENSION(ntimeintervalsspectral, 8) :: basecoef
  REAL(kind=realtype), DIMENSION(ntimeintervalsspectral, 8) :: basecoefb
  REAL(kind=realtype), DIMENSION(8) :: coef0, dcdalpha, dcdalphadot, &
       &  dcdq, dcdqdot
  REAL(kind=realtype), DIMENSION(8) :: coef0b, dcdalphab, dcdalphadotb, &
       &  dcdqb, dcdqdotb
  REAL(kind=realtype) :: bendingmoment
  REAL(kind=realtype) :: bendingmomentb
  INTEGER(kind=inttype) :: sps
  INTEGER :: branch
  REAL(kind=realtype) :: temp0
  REAL(kind=realtype) :: temp1b
  REAL(kind=realtype) :: temp
  REAL(kind=realtype) :: temp1b5
  REAL(kind=realtype) :: temp1b4
  REAL(kind=realtype) :: temp1b3
  REAL(kind=realtype) :: temp1b2
  REAL(kind=realtype) :: temp1b1
  REAL(kind=realtype) :: temp1b0
  ! Compute the factor since we may need it below
  CALL ADJUSTINFLOWANGLE(alpha, beta, liftindex)
  scaledim = pref/pinf
  fact = two/(gammainf*pinf*machcoef**2*surfaceref*lref**2*scaledim)
  factmoment = fact/(lengthref*lref)
  ovrnts = one/ntimeintervalsspectral
  ! Pre-compute TS stability info if required:
  SELECT CASE  (costfunction) 
  CASE (costfunccl0, costfunccd0, costfunccm0, costfuncclalpha, &
       &  costfunccdalpha, costfunccmzalpha, costfuncclalphadot, &
       &  costfunccdalphadot, costfunccmzalphadot, costfuncclq, costfunccdq, &
       &  costfunccmzq, costfuncclqdot, costfunccdqdot, costfunccmzqdot) 
     DO sps=1,ntimeintervalsspectral
        basecoef(sps, 1) = fact*(force(1, sps)*liftdirection(1)+force(2, &
             &        sps)*liftdirection(2)+force(3, sps)*liftdirection(3))
        basecoef(sps, 2) = fact*(force(1, sps)*dragdirection(1)+force(2, &
             &        sps)*dragdirection(2)+force(3, sps)*dragdirection(3))
        basecoef(sps, 3) = force(1, sps)*fact
        basecoef(sps, 4) = force(2, sps)*fact
        basecoef(sps, 5) = force(3, sps)*fact
        basecoef(sps, 6) = moment(1, sps)*factmoment
        basecoef(sps, 7) = moment(2, sps)*factmoment
        basecoef(sps, 8) = moment(3, sps)*factmoment
     END DO
     CALL PUSHCONTROL1B(1)
  CASE DEFAULT
     CALL PUSHCONTROL1B(0)
  END SELECT
  ! Main cost function selection
  SELECT CASE  (costfunction) 
  CASE (costfuncforcex) 
     forceb = 0.0_8
     DO sps=ntimeintervalsspectral,1,-1
        forceb(1, sps) = forceb(1, sps) + ovrnts*objvalueb
     END DO
     lengthrefb = 0.0_8
     dragdirectionb = 0.0_8
     liftdirectionb = 0.0_8
     pointrefb = 0.0_8
     momentb = 0.0_8
     factmomentb = 0.0_8
     dcdalphadotb = 0.0_8
     coef0b = 0.0_8
     dcdqb = 0.0_8
     dcdqdotb = 0.0_8
     factb = 0.0_8
     dcdalphab = 0.0_8
  CASE (costfuncforcey) 
     forceb = 0.0_8
     DO sps=ntimeintervalsspectral,1,-1
        forceb(2, sps) = forceb(2, sps) + ovrnts*objvalueb
     END DO
     lengthrefb = 0.0_8
     dragdirectionb = 0.0_8
     liftdirectionb = 0.0_8
     pointrefb = 0.0_8
     momentb = 0.0_8
     factmomentb = 0.0_8
     dcdalphadotb = 0.0_8
     coef0b = 0.0_8
     dcdqb = 0.0_8
     dcdqdotb = 0.0_8
     factb = 0.0_8
     dcdalphab = 0.0_8
  CASE (costfuncforcez) 
     forceb = 0.0_8
     DO sps=ntimeintervalsspectral,1,-1
        forceb(3, sps) = forceb(3, sps) + ovrnts*objvalueb
     END DO
     lengthrefb = 0.0_8
     dragdirectionb = 0.0_8
     liftdirectionb = 0.0_8
     pointrefb = 0.0_8
     momentb = 0.0_8
     factmomentb = 0.0_8
     dcdalphadotb = 0.0_8
     coef0b = 0.0_8
     dcdqb = 0.0_8
     dcdqdotb = 0.0_8
     factb = 0.0_8
     dcdalphab = 0.0_8
  CASE (costfuncmomx) 
     momentb = 0.0_8
     DO sps=ntimeintervalsspectral,1,-1
        momentb(1, sps) = momentb(1, sps) + ovrnts*objvalueb
     END DO
     lengthrefb = 0.0_8
     dragdirectionb = 0.0_8
     liftdirectionb = 0.0_8
     pointrefb = 0.0_8
     forceb = 0.0_8
     factmomentb = 0.0_8
     dcdalphadotb = 0.0_8
     coef0b = 0.0_8
     dcdqb = 0.0_8
     dcdqdotb = 0.0_8
     factb = 0.0_8
     dcdalphab = 0.0_8
  CASE (costfuncmomy) 
     momentb = 0.0_8
     DO sps=ntimeintervalsspectral,1,-1
        momentb(2, sps) = momentb(2, sps) + ovrnts*objvalueb
     END DO
     lengthrefb = 0.0_8
     dragdirectionb = 0.0_8
     liftdirectionb = 0.0_8
     pointrefb = 0.0_8
     forceb = 0.0_8
     factmomentb = 0.0_8
     dcdalphadotb = 0.0_8
     coef0b = 0.0_8
     dcdqb = 0.0_8
     dcdqdotb = 0.0_8
     factb = 0.0_8
     dcdalphab = 0.0_8
  CASE (costfuncmomz) 
     momentb = 0.0_8
     DO sps=ntimeintervalsspectral,1,-1
        momentb(3, sps) = momentb(3, sps) + ovrnts*objvalueb
     END DO
     lengthrefb = 0.0_8
     dragdirectionb = 0.0_8
     liftdirectionb = 0.0_8
     pointrefb = 0.0_8
     forceb = 0.0_8
     factmomentb = 0.0_8
     dcdalphadotb = 0.0_8
     coef0b = 0.0_8
     dcdqb = 0.0_8
     dcdqdotb = 0.0_8
     factb = 0.0_8
     dcdalphab = 0.0_8
  CASE (costfuncforcexcoef) 
     forceb = 0.0_8
     factb = 0.0_8
     DO sps=ntimeintervalsspectral,1,-1
        forceb(1, sps) = forceb(1, sps) + ovrnts*fact*objvalueb
        factb = factb + ovrnts*force(1, sps)*objvalueb
     END DO
     lengthrefb = 0.0_8
     dragdirectionb = 0.0_8
     liftdirectionb = 0.0_8
     pointrefb = 0.0_8
     momentb = 0.0_8
     factmomentb = 0.0_8
     dcdalphadotb = 0.0_8
     coef0b = 0.0_8
     dcdqb = 0.0_8
     dcdqdotb = 0.0_8
     dcdalphab = 0.0_8
  CASE (costfuncforceycoef) 
     forceb = 0.0_8
     factb = 0.0_8
     DO sps=ntimeintervalsspectral,1,-1
        forceb(2, sps) = forceb(2, sps) + ovrnts*fact*objvalueb
        factb = factb + ovrnts*force(2, sps)*objvalueb
     END DO
     lengthrefb = 0.0_8
     dragdirectionb = 0.0_8
     liftdirectionb = 0.0_8
     pointrefb = 0.0_8
     momentb = 0.0_8
     factmomentb = 0.0_8
     dcdalphadotb = 0.0_8
     coef0b = 0.0_8
     dcdqb = 0.0_8
     dcdqdotb = 0.0_8
     dcdalphab = 0.0_8
  CASE (costfuncforcezcoef) 
     forceb = 0.0_8
     factb = 0.0_8
     DO sps=ntimeintervalsspectral,1,-1
        forceb(3, sps) = forceb(3, sps) + ovrnts*fact*objvalueb
        factb = factb + ovrnts*force(3, sps)*objvalueb
     END DO
     lengthrefb = 0.0_8
     dragdirectionb = 0.0_8
     liftdirectionb = 0.0_8
     pointrefb = 0.0_8
     momentb = 0.0_8
     factmomentb = 0.0_8
     dcdalphadotb = 0.0_8
     coef0b = 0.0_8
     dcdqb = 0.0_8
     dcdqdotb = 0.0_8
     dcdalphab = 0.0_8
  CASE (costfuncmomxcoef) 
     momentb = 0.0_8
     factmomentb = 0.0_8
     DO sps=ntimeintervalsspectral,1,-1
        momentb(1, sps) = momentb(1, sps) + ovrnts*factmoment*objvalueb
        factmomentb = factmomentb + ovrnts*moment(1, sps)*objvalueb
     END DO
     lengthrefb = 0.0_8
     dragdirectionb = 0.0_8
     liftdirectionb = 0.0_8
     pointrefb = 0.0_8
     forceb = 0.0_8
     dcdalphadotb = 0.0_8
     coef0b = 0.0_8
     dcdqb = 0.0_8
     dcdqdotb = 0.0_8
     factb = 0.0_8
     dcdalphab = 0.0_8
  CASE (costfuncmomycoef) 
     momentb = 0.0_8
     factmomentb = 0.0_8
     DO sps=ntimeintervalsspectral,1,-1
        momentb(2, sps) = momentb(2, sps) + ovrnts*factmoment*objvalueb
        factmomentb = factmomentb + ovrnts*moment(2, sps)*objvalueb
     END DO
     lengthrefb = 0.0_8
     dragdirectionb = 0.0_8
     liftdirectionb = 0.0_8
     pointrefb = 0.0_8
     forceb = 0.0_8
     dcdalphadotb = 0.0_8
     coef0b = 0.0_8
     dcdqb = 0.0_8
     dcdqdotb = 0.0_8
     factb = 0.0_8
     dcdalphab = 0.0_8
  CASE (costfuncmomzcoef) 
     momentb = 0.0_8
     factmomentb = 0.0_8
     DO sps=ntimeintervalsspectral,1,-1
        momentb(3, sps) = momentb(3, sps) + ovrnts*factmoment*objvalueb
        factmomentb = factmomentb + ovrnts*moment(3, sps)*objvalueb
     END DO
     lengthrefb = 0.0_8
     dragdirectionb = 0.0_8
     liftdirectionb = 0.0_8
     pointrefb = 0.0_8
     forceb = 0.0_8
     dcdalphadotb = 0.0_8
     coef0b = 0.0_8
     dcdqb = 0.0_8
     dcdqdotb = 0.0_8
     factb = 0.0_8
     dcdalphab = 0.0_8
  CASE (costfunclift) 
     liftdirectionb = 0.0_8
     forceb = 0.0_8
     DO sps=ntimeintervalsspectral,1,-1
        temp1b2 = ovrnts*objvalueb
        forceb(1, sps) = forceb(1, sps) + liftdirection(1)*temp1b2
        liftdirectionb(1) = liftdirectionb(1) + force(1, sps)*temp1b2
        forceb(2, sps) = forceb(2, sps) + liftdirection(2)*temp1b2
        liftdirectionb(2) = liftdirectionb(2) + force(2, sps)*temp1b2
        forceb(3, sps) = forceb(3, sps) + liftdirection(3)*temp1b2
        liftdirectionb(3) = liftdirectionb(3) + force(3, sps)*temp1b2
     END DO
     lengthrefb = 0.0_8
     dragdirectionb = 0.0_8
     pointrefb = 0.0_8
     momentb = 0.0_8
     factmomentb = 0.0_8
     dcdalphadotb = 0.0_8
     coef0b = 0.0_8
     dcdqb = 0.0_8
     dcdqdotb = 0.0_8
     factb = 0.0_8
     dcdalphab = 0.0_8
  CASE (costfuncdrag) 
     dragdirectionb = 0.0_8
     forceb = 0.0_8
     DO sps=ntimeintervalsspectral,1,-1
        temp1b3 = ovrnts*objvalueb
        forceb(1, sps) = forceb(1, sps) + dragdirection(1)*temp1b3
        dragdirectionb(1) = dragdirectionb(1) + force(1, sps)*temp1b3
        forceb(2, sps) = forceb(2, sps) + dragdirection(2)*temp1b3
        dragdirectionb(2) = dragdirectionb(2) + force(2, sps)*temp1b3
        forceb(3, sps) = forceb(3, sps) + dragdirection(3)*temp1b3
        dragdirectionb(3) = dragdirectionb(3) + force(3, sps)*temp1b3
     END DO
     lengthrefb = 0.0_8
     liftdirectionb = 0.0_8
     pointrefb = 0.0_8
     momentb = 0.0_8
     factmomentb = 0.0_8
     dcdalphadotb = 0.0_8
     coef0b = 0.0_8
     dcdqb = 0.0_8
     dcdqdotb = 0.0_8
     factb = 0.0_8
     dcdalphab = 0.0_8
  CASE (costfuncliftcoef) 
     liftdirectionb = 0.0_8
     forceb = 0.0_8
     factb = 0.0_8
     DO sps=ntimeintervalsspectral,1,-1
        temp1b4 = ovrnts*fact*objvalueb
        factb = factb + ovrnts*(force(1, sps)*liftdirection(1)+force(2, &
             &        sps)*liftdirection(2)+force(3, sps)*liftdirection(3))*objvalueb
        forceb(1, sps) = forceb(1, sps) + liftdirection(1)*temp1b4
        liftdirectionb(1) = liftdirectionb(1) + force(1, sps)*temp1b4
        forceb(2, sps) = forceb(2, sps) + liftdirection(2)*temp1b4
        liftdirectionb(2) = liftdirectionb(2) + force(2, sps)*temp1b4
        forceb(3, sps) = forceb(3, sps) + liftdirection(3)*temp1b4
        liftdirectionb(3) = liftdirectionb(3) + force(3, sps)*temp1b4
     END DO
     lengthrefb = 0.0_8
     dragdirectionb = 0.0_8
     pointrefb = 0.0_8
     momentb = 0.0_8
     factmomentb = 0.0_8
     dcdalphadotb = 0.0_8
     coef0b = 0.0_8
     dcdqb = 0.0_8
     dcdqdotb = 0.0_8
     dcdalphab = 0.0_8
  CASE (costfuncdragcoef) 
     dragdirectionb = 0.0_8
     forceb = 0.0_8
     factb = 0.0_8
     DO sps=ntimeintervalsspectral,1,-1
        temp1b5 = ovrnts*fact*objvalueb
        factb = factb + ovrnts*(force(1, sps)*dragdirection(1)+force(2, &
             &        sps)*dragdirection(2)+force(3, sps)*dragdirection(3))*objvalueb
        forceb(1, sps) = forceb(1, sps) + dragdirection(1)*temp1b5
        dragdirectionb(1) = dragdirectionb(1) + force(1, sps)*temp1b5
        forceb(2, sps) = forceb(2, sps) + dragdirection(2)*temp1b5
        dragdirectionb(2) = dragdirectionb(2) + force(2, sps)*temp1b5
        forceb(3, sps) = forceb(3, sps) + dragdirection(3)*temp1b5
        dragdirectionb(3) = dragdirectionb(3) + force(3, sps)*temp1b5
     END DO
     lengthrefb = 0.0_8
     liftdirectionb = 0.0_8
     pointrefb = 0.0_8
     momentb = 0.0_8
     factmomentb = 0.0_8
     dcdalphadotb = 0.0_8
     coef0b = 0.0_8
     dcdqb = 0.0_8
     dcdqdotb = 0.0_8
     dcdalphab = 0.0_8
  CASE (costfunccl0) 
     coef0b = 0.0_8
     coef0b(1) = coef0b(1) + objvalueb
     lengthrefb = 0.0_8
     dragdirectionb = 0.0_8
     liftdirectionb = 0.0_8
     pointrefb = 0.0_8
     momentb = 0.0_8
     forceb = 0.0_8
     factmomentb = 0.0_8
     dcdalphadotb = 0.0_8
     dcdqb = 0.0_8
     dcdqdotb = 0.0_8
     factb = 0.0_8
     dcdalphab = 0.0_8
  CASE (costfunccd0) 
     coef0b = 0.0_8
     coef0b(2) = coef0b(2) + objvalueb
     lengthrefb = 0.0_8
     dragdirectionb = 0.0_8
     liftdirectionb = 0.0_8
     pointrefb = 0.0_8
     momentb = 0.0_8
     forceb = 0.0_8
     factmomentb = 0.0_8
     dcdalphadotb = 0.0_8
     dcdqb = 0.0_8
     dcdqdotb = 0.0_8
     factb = 0.0_8
     dcdalphab = 0.0_8
  CASE (costfunccm0) 
     coef0b = 0.0_8
     coef0b(8) = coef0b(8) + objvalueb
     lengthrefb = 0.0_8
     dragdirectionb = 0.0_8
     liftdirectionb = 0.0_8
     pointrefb = 0.0_8
     momentb = 0.0_8
     forceb = 0.0_8
     factmomentb = 0.0_8
     dcdalphadotb = 0.0_8
     dcdqb = 0.0_8
     dcdqdotb = 0.0_8
     factb = 0.0_8
     dcdalphab = 0.0_8
  CASE (costfuncclalpha) 
     dcdalphab = 0.0_8
     dcdalphab(1) = dcdalphab(1) + objvalueb
     lengthrefb = 0.0_8
     dragdirectionb = 0.0_8
     liftdirectionb = 0.0_8
     pointrefb = 0.0_8
     momentb = 0.0_8
     forceb = 0.0_8
     factmomentb = 0.0_8
     dcdalphadotb = 0.0_8
     coef0b = 0.0_8
     dcdqb = 0.0_8
     dcdqdotb = 0.0_8
     factb = 0.0_8
  CASE (costfunccdalpha) 
     dcdalphab = 0.0_8
     dcdalphab(2) = dcdalphab(2) + objvalueb
     lengthrefb = 0.0_8
     dragdirectionb = 0.0_8
     liftdirectionb = 0.0_8
     pointrefb = 0.0_8
     momentb = 0.0_8
     forceb = 0.0_8
     factmomentb = 0.0_8
     dcdalphadotb = 0.0_8
     coef0b = 0.0_8
     dcdqb = 0.0_8
     dcdqdotb = 0.0_8
     factb = 0.0_8
  CASE (costfunccmzalpha) 
     dcdalphab = 0.0_8
     dcdalphab(8) = dcdalphab(8) + objvalueb
     lengthrefb = 0.0_8
     dragdirectionb = 0.0_8
     liftdirectionb = 0.0_8
     pointrefb = 0.0_8
     momentb = 0.0_8
     forceb = 0.0_8
     factmomentb = 0.0_8
     dcdalphadotb = 0.0_8
     coef0b = 0.0_8
     dcdqb = 0.0_8
     dcdqdotb = 0.0_8
     factb = 0.0_8
  CASE (costfuncclalphadot) 
     dcdalphadotb = 0.0_8
     dcdalphadotb(1) = dcdalphadotb(1) + objvalueb
     lengthrefb = 0.0_8
     dragdirectionb = 0.0_8
     liftdirectionb = 0.0_8
     pointrefb = 0.0_8
     momentb = 0.0_8
     forceb = 0.0_8
     factmomentb = 0.0_8
     coef0b = 0.0_8
     dcdqb = 0.0_8
     dcdqdotb = 0.0_8
     factb = 0.0_8
     dcdalphab = 0.0_8
  CASE (costfunccdalphadot) 
     dcdalphadotb = 0.0_8
     dcdalphadotb(2) = dcdalphadotb(2) + objvalueb
     lengthrefb = 0.0_8
     dragdirectionb = 0.0_8
     liftdirectionb = 0.0_8
     pointrefb = 0.0_8
     momentb = 0.0_8
     forceb = 0.0_8
     factmomentb = 0.0_8
     coef0b = 0.0_8
     dcdqb = 0.0_8
     dcdqdotb = 0.0_8
     factb = 0.0_8
     dcdalphab = 0.0_8
  CASE (costfunccmzalphadot) 
     dcdalphadotb = 0.0_8
     dcdalphadotb(8) = dcdalphadotb(8) + objvalueb
     lengthrefb = 0.0_8
     dragdirectionb = 0.0_8
     liftdirectionb = 0.0_8
     pointrefb = 0.0_8
     momentb = 0.0_8
     forceb = 0.0_8
     factmomentb = 0.0_8
     coef0b = 0.0_8
     dcdqb = 0.0_8
     dcdqdotb = 0.0_8
     factb = 0.0_8
     dcdalphab = 0.0_8
  CASE (costfuncclq) 
     dcdqb = 0.0_8
     dcdqb(1) = dcdqb(1) + objvalueb
     lengthrefb = 0.0_8
     dragdirectionb = 0.0_8
     liftdirectionb = 0.0_8
     pointrefb = 0.0_8
     momentb = 0.0_8
     forceb = 0.0_8
     factmomentb = 0.0_8
     dcdalphadotb = 0.0_8
     coef0b = 0.0_8
     dcdqdotb = 0.0_8
     factb = 0.0_8
     dcdalphab = 0.0_8
  CASE (costfunccdq) 
     dcdqb = 0.0_8
     dcdqb(2) = dcdqb(2) + objvalueb
     lengthrefb = 0.0_8
     dragdirectionb = 0.0_8
     liftdirectionb = 0.0_8
     pointrefb = 0.0_8
     momentb = 0.0_8
     forceb = 0.0_8
     factmomentb = 0.0_8
     dcdalphadotb = 0.0_8
     coef0b = 0.0_8
     dcdqdotb = 0.0_8
     factb = 0.0_8
     dcdalphab = 0.0_8
  CASE (costfunccmzq) 
     dcdqb = 0.0_8
     dcdqb(8) = dcdqb(8) + objvalueb
     lengthrefb = 0.0_8
     dragdirectionb = 0.0_8
     liftdirectionb = 0.0_8
     pointrefb = 0.0_8
     momentb = 0.0_8
     forceb = 0.0_8
     factmomentb = 0.0_8
     dcdalphadotb = 0.0_8
     coef0b = 0.0_8
     dcdqdotb = 0.0_8
     factb = 0.0_8
     dcdalphab = 0.0_8
  CASE (costfuncclqdot) 
     dcdqdotb = 0.0_8
     dcdqdotb(1) = dcdqdotb(1) + objvalueb
     lengthrefb = 0.0_8
     dragdirectionb = 0.0_8
     liftdirectionb = 0.0_8
     pointrefb = 0.0_8
     momentb = 0.0_8
     forceb = 0.0_8
     factmomentb = 0.0_8
     dcdalphadotb = 0.0_8
     coef0b = 0.0_8
     dcdqb = 0.0_8
     factb = 0.0_8
     dcdalphab = 0.0_8
  CASE (costfunccdqdot) 
     dcdqdotb = 0.0_8
     dcdqdotb(2) = dcdqdotb(2) + objvalueb
     lengthrefb = 0.0_8
     dragdirectionb = 0.0_8
     liftdirectionb = 0.0_8
     pointrefb = 0.0_8
     momentb = 0.0_8
     forceb = 0.0_8
     factmomentb = 0.0_8
     dcdalphadotb = 0.0_8
     coef0b = 0.0_8
     dcdqb = 0.0_8
     factb = 0.0_8
     dcdalphab = 0.0_8
  CASE (costfunccmzqdot) 
     dcdqdotb = 0.0_8
     dcdqdotb(8) = dcdqdotb(8) + objvalueb
     lengthrefb = 0.0_8
     dragdirectionb = 0.0_8
     liftdirectionb = 0.0_8
     pointrefb = 0.0_8
     momentb = 0.0_8
     forceb = 0.0_8
     factmomentb = 0.0_8
     dcdalphadotb = 0.0_8
     coef0b = 0.0_8
     dcdqb = 0.0_8
     factb = 0.0_8
     dcdalphab = 0.0_8
  CASE (costfuncbendingcoef) 
     lengthrefb = 0.0_8
     pointrefb = 0.0_8
     momentb = 0.0_8
     forceb = 0.0_8
     factmomentb = 0.0_8
     factb = 0.0_8
     DO sps=ntimeintervalsspectral,1,-1
        bendingmomentb = ovrnts*objvalueb
        cf = fact*force(:, sps)
        cm = factmoment*moment(:, sps)
        CALL COMPUTEROOTBENDINGMOMENT_B(cf, cfb, cm, cmb, liftindex, &
             &                                bendingmoment, bendingmomentb)
        factb = factb + SUM(force(:, sps)*cfb)
        forceb(:, sps) = forceb(:, sps) + fact*cfb
        factmomentb = factmomentb + SUM(moment(:, sps)*cmb)
        momentb(:, sps) = momentb(:, sps) + factmoment*cmb
     END DO
     dragdirectionb = 0.0_8
     liftdirectionb = 0.0_8
     dcdalphadotb = 0.0_8
     coef0b = 0.0_8
     dcdqb = 0.0_8
     dcdqdotb = 0.0_8
     dcdalphab = 0.0_8
  CASE DEFAULT
     lengthrefb = 0.0_8
     dragdirectionb = 0.0_8
     liftdirectionb = 0.0_8
     pointrefb = 0.0_8
     momentb = 0.0_8
     forceb = 0.0_8
     factmomentb = 0.0_8
     dcdalphadotb = 0.0_8
     coef0b = 0.0_8
     dcdqb = 0.0_8
     dcdqdotb = 0.0_8
     factb = 0.0_8
     dcdalphab = 0.0_8
  END SELECT
  CALL POPCONTROL1B(branch)
  IF (branch .EQ. 0) THEN
     machgridb = 0.0_8
  ELSE
     CALL COMPUTETSDERIVATIVES_B(basecoef, basecoefb, coef0, coef0b, &
          &                          dcdalpha, dcdalphab, dcdalphadot, dcdalphadotb&
          &                          , dcdq, dcdqb, dcdqdot, dcdqdotb)
     DO sps=ntimeintervalsspectral,1,-1
        momentb(3, sps) = momentb(3, sps) + factmoment*basecoefb(sps, 8)
        factmomentb = factmomentb + moment(3, sps)*basecoefb(sps, 8)
        basecoefb(sps, 8) = 0.0_8
        momentb(2, sps) = momentb(2, sps) + factmoment*basecoefb(sps, 7)
        factmomentb = factmomentb + moment(2, sps)*basecoefb(sps, 7)
        basecoefb(sps, 7) = 0.0_8
        momentb(1, sps) = momentb(1, sps) + factmoment*basecoefb(sps, 6)
        factmomentb = factmomentb + moment(1, sps)*basecoefb(sps, 6)
        basecoefb(sps, 6) = 0.0_8
        forceb(3, sps) = forceb(3, sps) + fact*basecoefb(sps, 5)
        factb = factb + force(3, sps)*basecoefb(sps, 5)
        basecoefb(sps, 5) = 0.0_8
        forceb(2, sps) = forceb(2, sps) + fact*basecoefb(sps, 4)
        factb = factb + force(2, sps)*basecoefb(sps, 4)
        basecoefb(sps, 4) = 0.0_8
        forceb(1, sps) = forceb(1, sps) + fact*basecoefb(sps, 3)
        factb = factb + force(1, sps)*basecoefb(sps, 3)
        basecoefb(sps, 3) = 0.0_8
        temp1b0 = fact*basecoefb(sps, 2)
        factb = factb + (force(1, sps)*dragdirection(1)+force(2, sps)*&
             &        dragdirection(2)+force(3, sps)*dragdirection(3))*basecoefb(sps, &
             &        2)
        forceb(1, sps) = forceb(1, sps) + dragdirection(1)*temp1b0
        dragdirectionb(1) = dragdirectionb(1) + force(1, sps)*temp1b0
        forceb(2, sps) = forceb(2, sps) + dragdirection(2)*temp1b0
        dragdirectionb(2) = dragdirectionb(2) + force(2, sps)*temp1b0
        forceb(3, sps) = forceb(3, sps) + dragdirection(3)*temp1b0
        dragdirectionb(3) = dragdirectionb(3) + force(3, sps)*temp1b0
        basecoefb(sps, 2) = 0.0_8
        temp1b1 = fact*basecoefb(sps, 1)
        factb = factb + (force(1, sps)*liftdirection(1)+force(2, sps)*&
             &        liftdirection(2)+force(3, sps)*liftdirection(3))*basecoefb(sps, &
             &        1)
        forceb(1, sps) = forceb(1, sps) + liftdirection(1)*temp1b1
        liftdirectionb(1) = liftdirectionb(1) + force(1, sps)*temp1b1
        forceb(2, sps) = forceb(2, sps) + liftdirection(2)*temp1b1
        liftdirectionb(2) = liftdirectionb(2) + force(2, sps)*temp1b1
        forceb(3, sps) = forceb(3, sps) + liftdirection(3)*temp1b1
        liftdirectionb(3) = liftdirectionb(3) + force(3, sps)*temp1b1
        basecoefb(sps, 1) = 0.0_8
     END DO
  END IF
  temp1b = factmomentb/(lref*lengthref)
  factb = factb + temp1b
  lengthrefb = lengthrefb - fact*temp1b/lengthref
  temp0 = gammainf*pinf*lref**2*surfaceref*scaledim
  temp = temp0*machcoef**2
  machcoefb = -(temp0*two*2*machcoef*factb/temp**2)
  CALL ADJUSTINFLOWANGLE_B(alpha, alphab, beta, betab, liftindex)
  objvalueb = 0.0_8
END SUBROUTINE GETCOSTFUNCTION_B
