   !        Generated by TAPENADE     (INRIA, Tropics team)
   !  Tapenade 3.7 (r4786) - 21 Feb 2013 15:53
   !
   !  Differentiation of computetsderivatives in reverse (adjoint) mode (with options i4 dr8 r8):
   !   gradient     of useful results: lengthref dcdalphadot coef0
   !                dcdq dcdqdot dcdalpha
   !   with respect to varying inputs: machgrid lengthref basecoef
   !
   !     ******************************************************************
   !     *                                                                *
   !     * File:          computeTSDerivatives.f90                        *
   !     * Author:        C.A.(Sandy) Mader, G. Kenway                    *
   !     * Starting date: 11-25-2009                                      *
   !     * Last modified: 11-26-2009                                      *
   !     *                                                                *
   !     ******************************************************************
   !
   SUBROUTINE COMPUTETSDERIVATIVES_B(basecoef, basecoefb, coef0, coef0b, &
   &  dcdalpha, dcdalphab, dcdalphadot, dcdalphadotb, dcdq, dcdqb, dcdqdot, &
   &  dcdqdotb)
   USE MONITOR
   USE SECTION
   USE INPUTTIMESPECTRAL
   USE INPUTTSSTABDERIV
   USE INPUTPHYSICS
   USE COMMUNICATION
   USE INPUTMOTION
   USE FLOWVARREFSTATE
   IMPLICIT NONE
   !
   !     ******************************************************************
   !     *                                                                *
   !     * Computes the stability derivatives based on the time spectral  *
   !     * solution of a given mesh. Takes in the force coefficients at   *
   !     * all time instantces and computes the agregate parameters       *
   !     *                                                                *
   !     ******************************************************************
   !
   !
   !     Subroutine arguments.
   !
   REAL(kind=realtype), DIMENSION(ntimeintervalsspectral, 8) :: basecoef
   REAL(kind=realtype), DIMENSION(ntimeintervalsspectral, 8) :: basecoefb
   REAL(kind=realtype), DIMENSION(8) :: dcdq, dcdqdot
   REAL(kind=realtype), DIMENSION(8) :: dcdqb, dcdqdotb
   REAL(kind=realtype), DIMENSION(8) :: dcdalpha, dcdalphadot
   REAL(kind=realtype), DIMENSION(8) :: dcdalphab, dcdalphadotb
   REAL(kind=realtype), DIMENSION(8) :: coef0
   REAL(kind=realtype), DIMENSION(8) :: coef0b
   ! Working Variables
   REAL(kind=realtype), DIMENSION(8) :: coef0dot
   REAL(kind=realtype), DIMENSION(8) :: coef0dotb
   REAL(kind=realtype), DIMENSION(ntimeintervalsspectral, 8) :: &
   &  resbasecoef
   REAL(kind=realtype), DIMENSION(ntimeintervalsspectral, 8) :: &
   &  resbasecoefb
   REAL(kind=realtype), DIMENSION(ntimeintervalsspectral) :: &
   &  intervalalpha, intervalalphadot
   REAL(kind=realtype), DIMENSION(ntimeintervalsspectral) :: intervalmach&
   &  , intervalmachdot
   REAL(kind=realtype), DIMENSION(nsections) :: t
   INTEGER(kind=inttype) :: i, sps, nn
   !speed of sound: for normalization of q derivatives
   REAL(kind=realtype) :: a
   ! Functions
   REAL(kind=realtype), DIMENSION(ntimeintervalsspectral) :: dphix, dphiy&
   &  , dphiz
   REAL(kind=realtype), DIMENSION(ntimeintervalsspectral) :: dphixdot, &
   &  dphiydot, dphizdot
   REAL(kind=realtype) :: DERIVATIVERIGIDROTANGLE, &
   &  SECONDDERIVATIVERIGIDROTANGLE
   REAL(kind=realtype) :: TSALPHA, TSALPHADOT
   EXTERNAL TERMINATE
   REAL*8 :: tempb0(8)
   REAL*8 :: tempb(8)
   INTRINSIC SQRT
   !
   !     ******************************************************************
   !     *                                                                *
   !     * Begin execution.                                               *
   !     *                                                                *
   !     ******************************************************************
   !
   IF (tsqmode) THEN
   !q is pitch
   DO sps=1,ntimeintervalsspectral
   !compute the time of this intervavc
   t = timeunsteadyrestart
   IF (equationmode .EQ. timespectral) THEN
   DO nn=1,nsections
   t(nn) = t(nn) + (sps-1)*sections(nn)%timeperiod/(&
   &            ntimeintervalsspectral*1.0)
   END DO
   END IF
   ! Compute the time derivative of the rotation angles around the
   ! z-axis. i.e. compute q
   dphiz(sps) = DERIVATIVERIGIDROTANGLE(degreepolzrot, coefpolzrot&
   &        , degreefourzrot, omegafourzrot, coscoeffourzrot, &
   &        sincoeffourzrot, t)
   ! add in q_dot computation
   dphizdot(sps) = SECONDDERIVATIVERIGIDROTANGLE(degreepolzrot, &
   &        coefpolzrot, degreefourzrot, omegafourzrot, coscoeffourzrot, &
   &        sincoeffourzrot, t)
   END DO
   !now compute dCl/dq
   DO i=1,8
   CALL COMPUTELEASTSQUARESREGRESSION(basecoef(:, i), dphiz, &
   &                                      ntimeintervalsspectral, dcdq(i), &
   &                                      coef0(i))
   END DO
   !now normalize the results...
   a = SQRT(gammainf*pinfdim/rhoinfdim)
   resbasecoefb = 0.0_8
   DO i=8,1,-1
   coef0dotb = 0.0_8
   CALL COMPUTELEASTSQUARESREGRESSION_B(resbasecoef(:, i), &
   &                                     resbasecoefb(:, i), dphizdot, &
   &                                     ntimeintervalsspectral, dcdqdot(i)&
   &                                     , dcdqdotb(i), coef0dot(i), &
   &                                     coef0dotb(i))
   dcdqdotb(i) = 0.0_8
   coef0dotb(i) = 0.0_8
   END DO
   tempb = timeref*2*a*dcdqb/lengthref
   machgridb = SUM(dcdq*tempb)
   lengthrefb = lengthrefb + SUM(-(dcdq*machgrid*tempb/lengthref))
   dcdqb = machgrid*tempb
   basecoefb = 0.0_8
   DO i=8,1,-1
   DO sps=ntimeintervalsspectral,1,-1
   basecoefb(sps, i) = basecoefb(sps, i) + resbasecoefb(sps, i)
   dcdqb(i) = dcdqb(i) - dphiz(sps)*resbasecoefb(sps, i)
   coef0b(i) = coef0b(i) - resbasecoefb(sps, i)
   resbasecoefb(sps, i) = 0.0_8
   END DO
   END DO
   DO i=8,1,-1
   CALL COMPUTELEASTSQUARESREGRESSION_B(basecoef(:, i), basecoefb(:, &
   &                                     i), dphiz, ntimeintervalsspectral, &
   &                                     dcdq(i), dcdqb(i), coef0(i), coef0b&
   &                                     (i))
   dcdqb(i) = 0.0_8
   coef0b(i) = 0.0_8
   END DO
   ELSE IF (tsalphamode) THEN
   !compute the alphas and alphadots
   DO sps=1,ntimeintervalsspectral
   !compute the time of this interval
   t = timeunsteadyrestart
   IF (equationmode .EQ. timespectral) THEN
   DO nn=1,nsections
   t(nn) = t(nn) + (sps-1)*sections(nn)%timeperiod/(&
   &            ntimeintervalsspectral*1.0)
   END DO
   END IF
   intervalalpha(sps) = TSALPHA(degreepolalpha, coefpolalpha, &
   &        degreefouralpha, omegafouralpha, coscoeffouralpha, &
   &        sincoeffouralpha, t)
   intervalalphadot(sps) = TSALPHADOT(degreepolalpha, coefpolalpha&
   &        , degreefouralpha, omegafouralpha, coscoeffouralpha, &
   &        sincoeffouralpha, t)
   END DO
   !now compute dCl/dalpha
   DO i=1,8
   CALL COMPUTELEASTSQUARESREGRESSION(basecoef(:, i), &
   &                                      intervalalpha, &
   &                                      ntimeintervalsspectral, dcdalpha(i&
   &                                      ), coef0(i))
   END DO
   ! now subtract off estimated cl,cmz and use remainder to compute 
   ! clalphadot and cmzalphadot.
   DO i=1,8
   DO sps=1,ntimeintervalsspectral
   resbasecoef(sps, i) = basecoef(sps, i) - (dcdalpha(i)*&
   &          intervalalpha(sps)+coef0(i))
   END DO
   END DO
   !now compute dCi/dalphadot
   DO i=1,8
   CALL COMPUTELEASTSQUARESREGRESSION(resbasecoef(:, i), &
   &                                      intervalalphadot, &
   &                                      ntimeintervalsspectral, &
   &                                      dcdalphadot(i), coef0dot(i))
   END DO
   a = SQRT(gammainf*pinfdim/rhoinfdim)
   tempb0 = a*2*dcdalphadotb/lengthref
   machgridb = SUM(dcdalphadot*tempb0)
   lengthrefb = lengthrefb + SUM(-(dcdalphadot*machgrid*tempb0/&
   &      lengthref))
   dcdalphadotb = machgrid*tempb0
   resbasecoefb = 0.0_8
   DO i=8,1,-1
   coef0dotb = 0.0_8
   CALL COMPUTELEASTSQUARESREGRESSION_B(resbasecoef(:, i), &
   &                                     resbasecoefb(:, i), &
   &                                     intervalalphadot, &
   &                                     ntimeintervalsspectral, dcdalphadot&
   &                                     (i), dcdalphadotb(i), coef0dot(i), &
   &                                     coef0dotb(i))
   dcdalphadotb(i) = 0.0_8
   coef0dotb(i) = 0.0_8
   END DO
   basecoefb = 0.0_8
   DO i=8,1,-1
   DO sps=ntimeintervalsspectral,1,-1
   basecoefb(sps, i) = basecoefb(sps, i) + resbasecoefb(sps, i)
   dcdalphab(i) = dcdalphab(i) - intervalalpha(sps)*resbasecoefb(&
   &          sps, i)
   coef0b(i) = coef0b(i) - resbasecoefb(sps, i)
   resbasecoefb(sps, i) = 0.0_8
   END DO
   END DO
   DO i=8,1,-1
   CALL COMPUTELEASTSQUARESREGRESSION_B(basecoef(:, i), basecoefb(:, &
   &                                     i), intervalalpha, &
   &                                     ntimeintervalsspectral, dcdalpha(i)&
   &                                     , dcdalphab(i), coef0(i), coef0b(i)&
   &                                    )
   dcdalphab(i) = 0.0_8
   coef0b(i) = 0.0_8
   END DO
   ELSE
   machgridb = 0.0_8
   basecoefb = 0.0_8
   END IF
   END SUBROUTINE COMPUTETSDERIVATIVES_B
