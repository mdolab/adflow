   !        Generated by TAPENADE     (INRIA, Tropics team)
   !  Tapenade 3.4 (r3375) - 10 Feb 2010 15:08
   !
   !
   !      ******************************************************************
   !      *                                                                *
   !      * File:          communication.F90                               *
   !      * Author:        Edwin van der Weide, Steve Repsher              *
   !      * Starting date: 12-10-2002                                      *
   !      * Last modified: 06-12-2005                                      *
   !      *                                                                *
   !      ******************************************************************
   !
   MODULE COMMUNICATION_SPATIAL_D
   USE PRECISION
   IMPLICIT NONE
   !
   !      ******************************************************************
   !      *                                                                *
   !      * Contains the variable definition of the processor number,      *
   !      * myID and the number of processors, nProc, which belong to the  *
   !      * group defined by the communicator SUmb_comm_world. The range   *
   !      * of processor numbers is <0..Nproc-1>, i.e. the numbering       *
   !      * starts at 0. This is done for compatibility with MPI.          *
   !      * Furthermore this module contains the communication pattern for *
   !      * all the multigrid levels.                                      *
   !      *                                                                *
   !      ******************************************************************
   !
   SAVE 
   ! block(..):     Local block id to which the cell/node belongs.
   !                The dimension is equal to the number of entities
   !                to be communicated with the particular processor.
   ! indices(..,3): I, j and k indices of the data to be communicated.
   !                For the first dimension, see block.
   ! interp(..,..): Interpolants for indices that represent a cell
   !                stencil (allocated only when needed, e.g. send
   !                list for overset communication).
   !                For the first dimension, see block.
   !
   !      ******************************************************************
   !      *                                                                *
   !      * The definition of the derived data type commListType, which    *
   !      * stores the i,j and k indices as well as the block id of the    *
   !      * data to be communicated. Send lists may contain interpolants   *
   !      * since the indices may refer to a stencil, while the receive    *
   !      * list does not. All interpolations should be done on the send   *
   !      * side to keep message sizes to a minimum.                       *
   !      *                                                                *
   !      ******************************************************************
   !
   TYPE SENDCOMMLISTTYPE
   INTEGER(kind=inttype), DIMENSION(:), POINTER :: block
   INTEGER(kind=inttype), DIMENSION(:, :), POINTER :: indices
   REAL(kind=realtype), DIMENSION(:, :), POINTER :: interp
   END TYPE SENDCOMMLISTTYPE
   ! block(..):     Local block id to which the cell/node belongs.
   !                The dimension is equal to the number of entities
   !                to be communicated with the particular processor.
   ! indices(..,3): I, j and k indices of the data to be communicated.
   !                For the first dimension, see block.
   TYPE RECVCOMMLISTTYPE
   INTEGER(kind=inttype), DIMENSION(:), POINTER :: block
   INTEGER(kind=inttype), DIMENSION(:, :), POINTER :: indices
   END TYPE RECVCOMMLISTTYPE
   ! rotMatrix(3,3): Rotation matrix.
   ! rotCenter(3):   Coordinates of center of rotation.
   ! translation(3):  Translation vector.
   ! nHalos:            # of halos to which this periodic
   !                    transformation must be applied.
   ! block(nHalos):     Local block id to which the halos belong.
   ! indices(nHalos,3): I, j and k indices of the halos in
   !                    this block.
   !
   !      ******************************************************************
   !      *                                                                *
   !      * The definition of the derived data type periodicDataType,      *
   !      * which stores the rotation matrix, the rotation center and the  *
   !      * translation vector of the periodic transformation, as well as  *
   !      * the halos to which this transformation must be applied.        *
   !      *                                                                *
   !      ******************************************************************
   !
   TYPE PERIODICDATATYPE
   REAL(kind=realtype), DIMENSION(3, 3) :: rotmatrix
   REAL(kind=realtype), DIMENSION(3) :: rotcenter, translation
   INTEGER(kind=inttype) :: nhalos
   INTEGER(kind=inttype), DIMENSION(:), POINTER :: block
   INTEGER(kind=inttype), DIMENSION(:, :), POINTER :: indices
   END TYPE PERIODICDATATYPE
   ! nProcSend:           # of procs, to whom this proc will send
   ! nProcRecv:           # of procs, from whom this proc will
   !                      receive.
   ! sendProc(nProcSend): Send processor numbers.
   ! recvProc(nProcRecv): Receive processor numbers.
   ! nsend(nProcSend): # of entities to send to other processors.
   ! nrecv(nProcRecv): # of entities to receive from other processors.
   ! nsendCum(0:NprocSend): cumulative version of nsend.
   ! nrecvCum(0:NprocRecv): cumulative version of nrecv.
   ! indexSendProc(0:Nproc-1): index of the processors in sendProc.
   !                           If nothing is to be sent to a
   !                           processor this value is 0.
   ! indexRecvProc(0:Nproc-1): index of the processors in recvProc.
   !                           If nothing is to be received from a
   !                           processor this value is 0.
   ! sendList(nProcSend): Indices and block ids to send to these
   !                      processors.
   ! recvList(nProcRecv): Indices and block ids to receive from
   !                      these processors.
   !Tapenade!         type(sendCommListType), pointer, dimension(:) :: sendList
   !Tapenade!         type(recvCommListType), pointer, dimension(:) :: recvList
   ! nPeriodic:               # of periodic data arrays.
   ! periodicData(nPeriodic): Periodic data and entities to which
   !                          the transformation must be applied.
   !Tapenade!         type(periodicDataType), pointer, dimension(:) :: periodicData
   !
   !      ******************************************************************
   !      *                                                                *
   !      * The definition of the derived data type commType, which        *
   !      * stores the communication pattern for a certain halo type for a *
   !      * certain grid level.                                            *
   !      *                                                                *
   !      ******************************************************************
   !
   TYPE COMMTYPE
   INTEGER(kind=inttype) :: nprocsend, nprocrecv
   INTEGER(kind=inttype), DIMENSION(:), POINTER :: sendproc, recvproc
   INTEGER(kind=inttype), DIMENSION(:), POINTER :: nsend, nrecv
   INTEGER(kind=inttype), DIMENSION(:), POINTER :: nsendcum
   INTEGER(kind=inttype), DIMENSION(:), POINTER :: nrecvcum
   INTEGER(kind=inttype), DIMENSION(:), POINTER :: indexsendproc
   INTEGER(kind=inttype), DIMENSION(:), POINTER :: indexrecvproc
   INTEGER(kind=inttype) :: nperiodic
   END TYPE COMMTYPE
   ! ncopy: # of entities to copy internally.
   ! donorBlock(ncopy):     Local block id of the donor cell.
   ! donorIndices(ncopy,3): The indices of the donor cell.
   ! donorInterp(ncopy,3):  Interpolants of the donor stencil.
   !                        Only allocated when needed, e.g.
   !                        overset communication).
   ! haloBlock(ncopy):     Local block id of the halo cell.
   ! haloIndices(ncopy,3): The indices of the halo cell.
   ! nPeriodic:               # of periodic data arrays.
   ! periodicData(nPeriodic): Periodic data and entities to which
   !                          the transformation must be applied.
   !Tapenade!         type(periodicDataType), pointer, dimension(:) :: periodicData
   !
   !      ******************************************************************
   !      *                                                                *
   !      * The definition of the derived data type internalCommType,      *
   !      * which stores the memory to memory copy on this processor for a *
   !      * certain halo type.                                             *
   !      *                                                                *
   !      ******************************************************************
   !
   TYPE INTERNALCOMMTYPE
   INTEGER(kind=inttype) :: ncopy
   INTEGER(kind=inttype), DIMENSION(:), POINTER :: donorblock
   INTEGER(kind=inttype), DIMENSION(:, :), POINTER :: donorindices
   REAL(kind=realtype), DIMENSION(:, :), POINTER :: donorinterp
   INTEGER(kind=inttype), DIMENSION(:), POINTER :: haloblock
   INTEGER(kind=inttype), DIMENSION(:, :), POINTER :: haloindices
   INTEGER(kind=inttype) :: nperiodic
   END TYPE INTERNALCOMMTYPE
   !
   !      ******************************************************************
   !      *                                                                *
   !      * Variables stored in this module.                               *
   !      *                                                                *
   !      ******************************************************************
   !
   ! SUmb_comm_world: The communicator of this processor group.
   ! myID:            My processor number in SUmb_comm_world.
   ! nProc:           The number of processors in SUmb_comm_world.
   INTEGER :: sumb_comm_world, sumb_comm_self, myid, nproc
   ! commPatternCell_1st(nLevel): The communication pattern for 1st
   !                              level cell halo's on the multiple
   !                              grids.
   ! commPatternCell_2nd(nLevel): The communication pattern for 2nd
   !                              level cell halo's (including the
   !                              1st level) on the multiple grids.
   ! commPatternNode_1st(nLevel): The communication pattern for 1st
   !                              level node halo's on the multiple
   !                              grids.
   ! CommPatternOverset(nLevel,   the communication pattern for
   !                      nsps):  Overset halos on the multiple
   !                              grids.
   !Tapenade!       type(commType), allocatable, dimension(:)   :: commPatternCell_1st
   !Tapenade!       type(commType), allocatable, dimension(:)   :: commPatternCell_2nd
   !Tapenade!       type(commType), allocatable, dimension(:)   :: commPatternNode_1st
   !Tapenade!       type(commType), allocatable, dimension(:,:) :: commPatternOverset
   ! internalCell_1st(nLevel): Memory to memory copies for 1st level
   !                           cell halo's on the multiple grids.
   ! internalCell_2nd(nLevel): Memory to memory copies for 2nd level
   !                           cell halo's on the multiple grids.
   ! internalNode_1st(nLevel): Memory to memory copies for 1st level
   !                           node halo's on the multiple grids.
   ! InternalOverset(nLevel,   internal communication for overset
   !                  nsps):   Halos on the multiple grids.
   !Tapenade!       type(internalCommType), allocatable, dimension(:)   :: internalCell_1st
   !Tapenade!       type(internalCommType), allocatable, dimension(:)   :: internalCell_2nd
   !Tapenade!       type(internalCommType), allocatable, dimension(:)   :: internalNode_1st
   !Tapenade!       type(internalCommType), allocatable, dimension(:,:) :: internalOverset
   ! sendBufferSize_1to1: Size of the send buffer needed to perform
   !                      all 1 to 1 communication.
   ! recvBufferSize_1to1: Idem for the receive buffer.
   ! sendBufferSizeOver:  Size of the send buffer needed to perform
   !                      all overset communication.
   ! recvBufferSizeOver:  Idem for the receive buffer.
   ! sendBufferSize:      Size of the send buffer to perform all
   !                      possible communication.
   ! recvBufferSize:      Idem for the receive buffer.
   INTEGER(kind=inttype) :: sendbuffersize_1to1, sendbuffersize
   INTEGER(kind=inttype) :: recvbuffersize_1to1, recvbuffersize
   INTEGER(kind=inttype) :: sendbuffersizeover, recvbuffersizeover
   ! sendBuffer:   Buffer used to store the info to be send during
   !               a nonblocking communication.
   ! recvBuffer:   Buffer used to store the info to be received
   !               during a nonblocking communication.
   ! sendRequests: Array of requests for the nonblocking sends.
   ! recvRequests: Array of requests for the nonblocking receives.
   REAL(kind=realtype), DIMENSION(:), ALLOCATABLE :: sendbuffer
   REAL(kind=realtype), DIMENSION(:), ALLOCATABLE :: recvbuffer
   INTEGER, DIMENSION(:), ALLOCATABLE :: sendrequests, recvrequests
   END MODULE COMMUNICATION_SPATIAL_D
