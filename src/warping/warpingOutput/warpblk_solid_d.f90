!        Generated by TAPENADE     (INRIA, Tropics team)
!  Tapenade 3.3 (r3163) - 09/25/2009 09:03
!
!  Differentiation of warpblk_solid in forward (tangent) mode:
!   variations  of output variables: xyz
!   with respect to input variables: xyz0 xyz
SUBROUTINE WARPBLK_SOLID_D(ifaceptb, iedgeptb, ncall, ig, igo, il, jl, &
&  kl, xyz0, xyz0d, s0, xyz, xyzd)
  USE PRECISION
  IMPLICIT NONE
!     ******************************************************************
!     *   WARP-BLK completes the perturbation of one block of a multi- *
!     *   block grid structure given a base grid and all fixed and all *
!     *   explicitly-perturbed faces in-place for the desired block.   *
!     *                                                                *
!     *   Ancillary routines:   PARAM3DM, WARPQ3DM, DELQ3DM            *
!     *                                                                *
!     *   11/29/95  D.Saunders  Specialized adaptation of WARP3D and   *
!     *                         ancillary routines for FLO107-MB.      *
!     *   01/26/96  DAS/JJR     Edges affected implicitly by corner    *
!     *                         motion had been overlooked.            *
!     *   04/04/96     "        Algorithm is now 3-stage/1-pass, not   *
!     *                         2-stage/2-pass as it was originally.   *
!     *   05/24/96     "        Juan Alonso debugged it for us.        *
!     *   06/??/96    JJR       Implicit edge motion is specified at   *
!     *                         the higher level now via IEDGEPTB(*).  *
!     *   06/19/96    DAS       Handled degenerate edges in PARAM3DM.  *
!     *   12/11/08  C.A.Mader   Converted to *.f90                     *
!     *                                                                *
!     *   David Saunders/James Reuther, NASA Ames Research Center, CA. *
!     ******************************************************************
!IMPLICIT REAL*8 (A-H,O-Z) ! Take out when all compilers have a switch
!     Arguments:
! I  Controls for faces 1 - 6:
  INTEGER(kind=inttype) :: ifaceptb(6)
!    0 means no perturbation;
!    1 means implicit perturbation;
!    2 means explicit perturbation
! I  Controls for edges 1 - 12:
  INTEGER(kind=inttype) :: iedgeptb(12)
!    0 means no perturbation;
!    1 means implicit perturbation;
!    2 means explicit perturbation
! I  First call if NCALL = -3
  INTEGER(kind=inttype) :: ncall
! I  Design point i.d.
  INTEGER(kind=inttype) :: ig, igo
! I  Block dimensions
  INTEGER(kind=inttype) :: il, jl, kl
! I  Base block including halo
  REAL(kind=realtype) :: xyz0(3, 0:il+1, 0:jl+1, 0:kl+1)
  REAL(kind=realtype) :: xyz0d(3, 0:il+1, 0:jl+1, 0:kl+1)
!I/O Base normalized arc-lengths;
  REAL(kind=realtype) :: s0(3, 0:il+1, 0:jl+1, 0:kl+1)
  REAL(kind=realtype) :: s0d(3, 0:il+1, 0:jl+1, 0:kl+1)
!    halo allows use of XYZ pointers
!   REAL(kind=realType)::DFACEI(3,JL,KL,2,4)         ! S  For face perturbations; e.g.,
!       REAL(kind=realType)::DFACEJ(3,IL,KL,2,4)         !    DFACEI(1:3,JL,KL,1,M) =
!       REAL(kind=realType)::DFACEK(3,IL,JL,2,4)         !    dX, dY, dZ on the I=1 face for
!                                             !    stage M, etc.; M = 1,2a 2b,3.
!                                             !    each can be (3,MDM,MDM,2,4) if
!                                             !    MDM=MAX(IL,JL,KL) (all blocks)
!I/O Perturbed block
  REAL(kind=realtype) :: xyz(3, 0:il+1, 0:jl+1, 0:kl+1)
  REAL(kind=realtype) :: xyzd(3, 0:il+1, 0:jl+1, 0:kl+1)
!     Local constants.
  REAL(kind=realtype) :: eps, one, zero
  PARAMETER (eps=1.e-14, one=1.e+0, zero=0.e+0)
! presumably only if result is zero.
!     Local variables.
  INTEGER(kind=inttype) :: i, i1, i2, j, j1, j2, k, k1, k2, l, lc, le, m
  INTEGER(kind=inttype) :: faceindex
  REAL(kind=realtype) :: del1, del2, deli, delj, delk, delij, delik, &
&  delji, deljk, delki, delkj, wti1, wti2, wtj1, wtj2, wtk1, wtk2
  REAL(kind=realtype) :: del1d, del2d, delid, deljd, delkd, delijd, &
&  delikd, deljid, deljkd, delkid, delkjd, wti1d, wti2d, wtj1d, wtj2d, &
&  wtk1d, wtk2d
! Corner perturbations
  REAL(kind=realtype) :: dx(8), dy(8), dz(8)
  REAL(kind=realtype) :: dxd(8), dyd(8), dzd(8)
  REAL(kind=realtype), DIMENSION(:, :, :, :, :), ALLOCATABLE :: dfacei, &
&  dfacej, dfacek
  REAL(kind=realtype), DIMENSION(:, :, :, :, :), ALLOCATABLE :: dfaceid&
&  , dfacejd, dfacekd
  REAL(kind=realtype) :: abs30
  REAL(kind=realtype) :: abs18d
  REAL(kind=realtype) :: abs26d
  REAL(kind=realtype) :: x10d
  REAL(kind=realtype) :: max10d
  REAL(kind=realtype) :: abs34d
  REAL(kind=realtype) :: abs42d
  REAL(kind=realtype) :: abs50d
  REAL(kind=realtype) :: x6d
  REAL(kind=realtype) :: abs29d
  REAL(kind=realtype) :: abs37d
  REAL(kind=realtype) :: x12
  REAL(kind=realtype) :: abs1d
  REAL(kind=realtype) :: abs45d
  REAL(kind=realtype) :: x11
  REAL(kind=realtype) :: abs53d
  REAL(kind=realtype) :: x10
  REAL(kind=realtype) :: x9d
  REAL(kind=realtype) :: max2d
  REAL(kind=realtype) :: abs4d
  REAL(kind=realtype) :: abs11d
  REAL(kind=realtype) :: abs48d
  REAL(kind=realtype) :: max5d
  REAL(kind=realtype) :: x9
  REAL(kind=realtype) :: abs29
  INTRINSIC MAX
  REAL(kind=realtype) :: x8
  REAL(kind=realtype) :: abs28
  REAL(kind=realtype) :: abs27
  REAL(kind=realtype) :: x7
  REAL(kind=realtype) :: abs14d
  REAL(kind=realtype) :: abs7d
  REAL(kind=realtype) :: abs26
  REAL(kind=realtype) :: x6
  REAL(kind=realtype) :: abs22d
  REAL(kind=realtype) :: abs25
  REAL(kind=realtype) :: x5
  REAL(kind=realtype) :: abs30d
  REAL(kind=realtype) :: abs24
  REAL(kind=realtype) :: x4
  REAL(kind=realtype) :: max8d
  REAL(kind=realtype) :: abs23
  REAL(kind=realtype) :: x3
  INTRINSIC ABS
  REAL(kind=realtype) :: abs22
  REAL(kind=realtype) :: x2
  REAL(kind=realtype) :: x2d
  REAL(kind=realtype) :: abs21
  REAL(kind=realtype) :: x1
  REAL(kind=realtype) :: abs20
  REAL(kind=realtype) :: abs17d
  REAL(kind=realtype) :: abs25d
  REAL(kind=realtype) :: abs33d
  REAL(kind=realtype) :: abs54
  REAL(kind=realtype) :: abs41d
  REAL(kind=realtype) :: abs53
  REAL(kind=realtype) :: abs52
  REAL(kind=realtype) :: x5d
  REAL(kind=realtype) :: abs51
  REAL(kind=realtype) :: abs50
  REAL(kind=realtype) :: abs28d
  REAL(kind=realtype) :: x12d
  REAL(kind=realtype) :: max12d
  REAL(kind=realtype) :: abs36d
  REAL(kind=realtype) :: abs44d
  REAL(kind=realtype) :: abs52d
  REAL(kind=realtype) :: x8d
  REAL(kind=realtype) :: max1d
  REAL(kind=realtype) :: abs39d
  REAL(kind=realtype) :: abs3d
  REAL(kind=realtype) :: abs10d
  REAL(kind=realtype) :: abs47d
  REAL(kind=realtype) :: max4d
  REAL(kind=realtype) :: abs19
  REAL(kind=realtype) :: abs18
  REAL(kind=realtype) :: abs17
  REAL(kind=realtype) :: abs13d
  REAL(kind=realtype) :: abs6d
  REAL(kind=realtype) :: abs16
  REAL(kind=realtype) :: abs21d
  REAL(kind=realtype) :: abs15
  REAL(kind=realtype) :: abs14
  REAL(kind=realtype) :: max7d
  REAL(kind=realtype) :: abs13
  REAL(kind=realtype) :: abs12
  REAL(kind=realtype) :: abs49
  REAL(kind=realtype) :: x1d
  REAL(kind=realtype) :: abs11
  REAL(kind=realtype) :: abs48
  REAL(kind=realtype) :: abs10
  REAL(kind=realtype) :: abs47
  REAL(kind=realtype) :: abs16d
  REAL(kind=realtype) :: abs9d
  REAL(kind=realtype) :: abs46
  REAL(kind=realtype) :: abs24d
  REAL(kind=realtype) :: abs45
  REAL(kind=realtype) :: abs32d
  REAL(kind=realtype) :: abs44
  REAL(kind=realtype) :: abs40d
  REAL(kind=realtype) :: abs43
  REAL(kind=realtype) :: abs42
  REAL(kind=realtype) :: x4d
  REAL(kind=realtype) :: abs41
  REAL(kind=realtype) :: abs40
  REAL(kind=realtype) :: abs19d
  REAL(kind=realtype) :: abs27d
  REAL(kind=realtype) :: x11d
  REAL(kind=realtype) :: max11d
  REAL(kind=realtype) :: abs35d
  REAL(kind=realtype) :: abs9
  REAL(kind=realtype) :: abs43d
  REAL(kind=realtype) :: abs8
  REAL(kind=realtype) :: abs51d
  REAL(kind=realtype) :: abs7
  REAL(kind=realtype) :: x7d
  REAL(kind=realtype) :: abs6
  REAL(kind=realtype) :: abs5
  REAL(kind=realtype) :: abs4
  REAL(kind=realtype) :: abs3
  REAL(kind=realtype) :: abs38d
  REAL(kind=realtype) :: abs2
  REAL(kind=realtype) :: abs2d
  REAL(kind=realtype) :: abs46d
  REAL(kind=realtype) :: abs1
  REAL(kind=realtype) :: abs54d
  REAL(kind=realtype) :: max3d
  REAL(kind=realtype) :: max9
  REAL(kind=realtype) :: abs49d
  REAL(kind=realtype) :: abs5d
  REAL(kind=realtype) :: abs12d
  REAL(kind=realtype) :: max8
  REAL(kind=realtype) :: abs20d
  REAL(kind=realtype) :: max7
  REAL(kind=realtype) :: max6
  REAL(kind=realtype) :: max6d
  REAL(kind=realtype) :: max5
  REAL(kind=realtype) :: max4
  REAL(kind=realtype) :: abs39
  REAL(kind=realtype) :: max3
  REAL(kind=realtype) :: abs38
  REAL(kind=realtype) :: max2
  REAL(kind=realtype) :: abs37
  REAL(kind=realtype) :: abs15d
  REAL(kind=realtype) :: abs8d
  REAL(kind=realtype) :: max1
  REAL(kind=realtype) :: max12
  REAL(kind=realtype) :: abs36
  REAL(kind=realtype) :: abs23d
  REAL(kind=realtype) :: max11
  REAL(kind=realtype) :: abs35
  REAL(kind=realtype) :: abs31d
  REAL(kind=realtype) :: max10
  REAL(kind=realtype) :: abs34
  REAL(kind=realtype) :: max9d
  REAL(kind=realtype) :: abs33
  REAL(kind=realtype) :: abs32
  REAL(kind=realtype) :: x3d
  REAL(kind=realtype) :: abs31
  ALLOCATE(dfaceid(3, jl, kl, 2, 4))
  ALLOCATE(dfacei(3, jl, kl, 2, 4))
  ALLOCATE(dfacejd(3, il, kl, 2, 4))
  ALLOCATE(dfacej(3, il, kl, 2, 4))
  ALLOCATE(dfacekd(3, il, jl, 2, 4))
  ALLOCATE(dfacek(3, il, jl, 2, 4))
!     Execution.
!     Parameterize the block volume on the first call:
  IF (ncall .LE. -3 .AND. ig .NE. igo) THEN
!         write(*,*) 'parameterizing'
    CALL PARAM3DM_SOLID_D(il, jl, kl, xyz0, xyz0d, s0, s0d)
  ELSE
    s0d = 0.0
  END IF
!     Calculate the DFACEI,DFACEJ,DFACEK
  dfaceid(1, 1:jl, 1:kl, 1, 1) = xyzd(1, 1, 1:jl, 1:kl) - xyz0d(1, 1, 1:&
&    jl, 1:kl)
  dfacei(1, 1:jl, 1:kl, 1, 1) = xyz(1, 1, 1:jl, 1:kl) - xyz0(1, 1, 1:jl&
&    , 1:kl)
  dfaceid(2, 1:jl, 1:kl, 1, 1) = xyzd(2, 1, 1:jl, 1:kl) - xyz0d(2, 1, 1:&
&    jl, 1:kl)
  dfacei(2, 1:jl, 1:kl, 1, 1) = xyz(2, 1, 1:jl, 1:kl) - xyz0(2, 1, 1:jl&
&    , 1:kl)
  dfaceid(3, 1:jl, 1:kl, 1, 1) = xyzd(3, 1, 1:jl, 1:kl) - xyz0d(3, 1, 1:&
&    jl, 1:kl)
  dfacei(3, 1:jl, 1:kl, 1, 1) = xyz(3, 1, 1:jl, 1:kl) - xyz0(3, 1, 1:jl&
&    , 1:kl)
  dfaceid(1, 1:jl, 1:kl, 2, 1) = xyzd(1, il, 1:jl, 1:kl) - xyz0d(1, il, &
&    1:jl, 1:kl)
  dfacei(1, 1:jl, 1:kl, 2, 1) = xyz(1, il, 1:jl, 1:kl) - xyz0(1, il, 1:&
&    jl, 1:kl)
  dfaceid(2, 1:jl, 1:kl, 2, 1) = xyzd(2, il, 1:jl, 1:kl) - xyz0d(2, il, &
&    1:jl, 1:kl)
  dfacei(2, 1:jl, 1:kl, 2, 1) = xyz(2, il, 1:jl, 1:kl) - xyz0(2, il, 1:&
&    jl, 1:kl)
  dfaceid(3, 1:jl, 1:kl, 2, 1) = xyzd(3, il, 1:jl, 1:kl) - xyz0d(3, il, &
&    1:jl, 1:kl)
  dfacei(3, 1:jl, 1:kl, 2, 1) = xyz(3, il, 1:jl, 1:kl) - xyz0(3, il, 1:&
&    jl, 1:kl)
  dfacejd(1, 1:il, 1:kl, 1, 1) = xyzd(1, 1:il, 1, 1:kl) - xyz0d(1, 1:il&
&    , 1, 1:kl)
  dfacej(1, 1:il, 1:kl, 1, 1) = xyz(1, 1:il, 1, 1:kl) - xyz0(1, 1:il, 1&
&    , 1:kl)
  dfacejd(2, 1:il, 1:kl, 1, 1) = xyzd(2, 1:il, 1, 1:kl) - xyz0d(2, 1:il&
&    , 1, 1:kl)
  dfacej(2, 1:il, 1:kl, 1, 1) = xyz(2, 1:il, 1, 1:kl) - xyz0(2, 1:il, 1&
&    , 1:kl)
  dfacejd(3, 1:il, 1:kl, 1, 1) = xyzd(3, 1:il, 1, 1:kl) - xyz0d(3, 1:il&
&    , 1, 1:kl)
  dfacej(3, 1:il, 1:kl, 1, 1) = xyz(3, 1:il, 1, 1:kl) - xyz0(3, 1:il, 1&
&    , 1:kl)
  dfacejd(1, 1:il, 1:kl, 2, 1) = xyzd(1, 1:il, jl, 1:kl) - xyz0d(1, 1:il&
&    , jl, 1:kl)
  dfacej(1, 1:il, 1:kl, 2, 1) = xyz(1, 1:il, jl, 1:kl) - xyz0(1, 1:il, &
&    jl, 1:kl)
  dfacejd(2, 1:il, 1:kl, 2, 1) = xyzd(2, 1:il, jl, 1:kl) - xyz0d(2, 1:il&
&    , jl, 1:kl)
  dfacej(2, 1:il, 1:kl, 2, 1) = xyz(2, 1:il, jl, 1:kl) - xyz0(2, 1:il, &
&    jl, 1:kl)
  dfacejd(3, 1:il, 1:kl, 2, 1) = xyzd(3, 1:il, jl, 1:kl) - xyz0d(3, 1:il&
&    , jl, 1:kl)
  dfacej(3, 1:il, 1:kl, 2, 1) = xyz(3, 1:il, jl, 1:kl) - xyz0(3, 1:il, &
&    jl, 1:kl)
  dfacekd(1, 1:il, 1:jl, 1, 1) = xyzd(1, 1:il, 1:jl, 1) - xyz0d(1, 1:il&
&    , 1:jl, 1)
  dfacek(1, 1:il, 1:jl, 1, 1) = xyz(1, 1:il, 1:jl, 1) - xyz0(1, 1:il, 1:&
&    jl, 1)
  dfacekd(2, 1:il, 1:jl, 1, 1) = xyzd(2, 1:il, 1:jl, 1) - xyz0d(2, 1:il&
&    , 1:jl, 1)
  dfacek(2, 1:il, 1:jl, 1, 1) = xyz(2, 1:il, 1:jl, 1) - xyz0(2, 1:il, 1:&
&    jl, 1)
  dfacekd(3, 1:il, 1:jl, 1, 1) = xyzd(3, 1:il, 1:jl, 1) - xyz0d(3, 1:il&
&    , 1:jl, 1)
  dfacek(3, 1:il, 1:jl, 1, 1) = xyz(3, 1:il, 1:jl, 1) - xyz0(3, 1:il, 1:&
&    jl, 1)
  dfacekd(1, 1:il, 1:jl, 2, 1) = xyzd(1, 1:il, 1:jl, kl) - xyz0d(1, 1:il&
&    , 1:jl, kl)
  dfacek(1, 1:il, 1:jl, 2, 1) = xyz(1, 1:il, 1:jl, kl) - xyz0(1, 1:il, 1&
&    :jl, kl)
  dfacekd(2, 1:il, 1:jl, 2, 1) = xyzd(2, 1:il, 1:jl, kl) - xyz0d(2, 1:il&
&    , 1:jl, kl)
  dfacek(2, 1:il, 1:jl, 2, 1) = xyz(2, 1:il, 1:jl, kl) - xyz0(2, 1:il, 1&
&    :jl, kl)
  dfacekd(3, 1:il, 1:jl, 2, 1) = xyzd(3, 1:il, 1:jl, kl) - xyz0d(3, 1:il&
&    , 1:jl, kl)
  dfacek(3, 1:il, 1:jl, 2, 1) = xyz(3, 1:il, 1:jl, kl) - xyz0(3, 1:il, 1&
&    :jl, kl)
!     Calculate corner point motion:
  lc = 1
  dxd = 0.0
  dyd = 0.0
  dzd = 0.0
  DO k=1,kl,kl-1
    DO j=1,jl,jl-1
      DO i=1,il,il-1
        dxd(lc) = xyzd(1, i, j, k) - xyz0d(1, i, j, k)
        dx(lc) = xyz(1, i, j, k) - xyz0(1, i, j, k)
        dyd(lc) = xyzd(2, i, j, k) - xyz0d(2, i, j, k)
        dy(lc) = xyz(2, i, j, k) - xyz0(2, i, j, k)
        dzd(lc) = xyzd(3, i, j, k) - xyz0d(3, i, j, k)
        dz(lc) = xyz(3, i, j, k) - xyz0(3, i, j, k)
        lc = lc + 1
      END DO
    END DO
  END DO
!     Perturb implicit block edges.
!     Edges in the I direction:
  le = 1
  lc = 1
  DO k=1,kl,kl-1
    DO j=1,jl,jl-1
      IF (iedgeptb(le) .EQ. 1) THEN
        DO i=2,il-1
          wti2d = s0d(1, i, j, k)
          wti2 = s0(1, i, j, k)
          wti1d = -wti2d
          wti1 = one - wti2
          xyzd(1, i, j, k) = wti1d*dx(lc) + wti1*dxd(lc) + wti2d*dx(lc+1&
&            ) + wti2*dxd(lc+1) + xyz0d(1, i, j, k)
          xyz(1, i, j, k) = wti1*dx(lc) + wti2*dx(lc+1) + xyz0(1, i, j, &
&            k)
          xyzd(2, i, j, k) = wti1d*dy(lc) + wti1*dyd(lc) + wti2d*dy(lc+1&
&            ) + wti2*dyd(lc+1) + xyz0d(2, i, j, k)
          xyz(2, i, j, k) = wti1*dy(lc) + wti2*dy(lc+1) + xyz0(2, i, j, &
&            k)
          xyzd(3, i, j, k) = wti1d*dz(lc) + wti1*dzd(lc) + wti2d*dz(lc+1&
&            ) + wti2*dzd(lc+1) + xyz0d(3, i, j, k)
          xyz(3, i, j, k) = wti1*dz(lc) + wti2*dz(lc+1) + xyz0(3, i, j, &
&            k)
        END DO
      END IF
      le = le + 1
      lc = lc + 2
    END DO
  END DO
!     Edges in the J direction:
  le = 5
  lc = 1
  DO k=1,kl,kl-1
    DO i=1,il,il-1
      IF (iedgeptb(le) .EQ. 1) THEN
        DO j=2,jl-1
          wtj2d = s0d(2, i, j, k)
          wtj2 = s0(2, i, j, k)
          wtj1d = -wtj2d
          wtj1 = one - wtj2
          xyzd(1, i, j, k) = wtj1d*dx(lc) + wtj1*dxd(lc) + wtj2d*dx(lc+2&
&            ) + wtj2*dxd(lc+2) + xyz0d(1, i, j, k)
          xyz(1, i, j, k) = wtj1*dx(lc) + wtj2*dx(lc+2) + xyz0(1, i, j, &
&            k)
          xyzd(2, i, j, k) = wtj1d*dy(lc) + wtj1*dyd(lc) + wtj2d*dy(lc+2&
&            ) + wtj2*dyd(lc+2) + xyz0d(2, i, j, k)
          xyz(2, i, j, k) = wtj1*dy(lc) + wtj2*dy(lc+2) + xyz0(2, i, j, &
&            k)
          xyzd(3, i, j, k) = wtj1d*dz(lc) + wtj1*dzd(lc) + wtj2d*dz(lc+2&
&            ) + wtj2*dzd(lc+2) + xyz0d(3, i, j, k)
          xyz(3, i, j, k) = wtj1*dz(lc) + wtj2*dz(lc+2) + xyz0(3, i, j, &
&            k)
        END DO
      END IF
      le = le + 1
      lc = lc + 1
    END DO
    lc = lc + 2
  END DO
!     Edges in the K direction:
  le = 9
  lc = 1
  DO j=1,jl,jl-1
    DO i=1,il,il-1
      IF (iedgeptb(le) .EQ. 1) THEN
        DO k=2,kl-1
          wtk2d = s0d(3, i, j, k)
          wtk2 = s0(3, i, j, k)
          wtk1d = -wtk2d
          wtk1 = one - wtk2
          xyzd(1, i, j, k) = wtk1d*dx(lc) + wtk1*dxd(lc) + wtk2d*dx(lc+4&
&            ) + wtk2*dxd(lc+4) + xyz0d(1, i, j, k)
          xyz(1, i, j, k) = wtk1*dx(lc) + wtk2*dx(lc+4) + xyz0(1, i, j, &
&            k)
          xyzd(2, i, j, k) = wtk1d*dy(lc) + wtk1*dyd(lc) + wtk2d*dy(lc+4&
&            ) + wtk2*dyd(lc+4) + xyz0d(2, i, j, k)
          xyz(2, i, j, k) = wtk1*dy(lc) + wtk2*dy(lc+4) + xyz0(2, i, j, &
&            k)
          xyzd(3, i, j, k) = wtk1d*dz(lc) + wtk1*dzd(lc) + wtk2d*dz(lc+4&
&            ) + wtk2*dzd(lc+4) + xyz0d(3, i, j, k)
          xyz(3, i, j, k) = wtk1*dz(lc) + wtk2*dz(lc+4) + xyz0(3, i, j, &
&            k)
        END DO
      END IF
      le = le + 1
      lc = lc + 1
    END DO
  END DO
!     Perturb block faces implicitly affected by explicit edge changes:
  DO m=1,6
    IF (ifaceptb(m) .EQ. 1) THEN
! WARPQ3DM expects one pair of indices to be
      i1 = 1
! equal to define the face
      i2 = il
      j1 = 1
      j2 = jl
      k1 = 1
      k2 = kl
      IF (m .EQ. 1) THEN
        i2 = 1
        faceindex = 1
      ELSE IF (m .EQ. 2) THEN
        i1 = il
        faceindex = 2
      ELSE IF (m .EQ. 3) THEN
        j2 = 1
        faceindex = 1
      ELSE IF (m .EQ. 4) THEN
        j1 = jl
        faceindex = 2
      ELSE IF (m .EQ. 5) THEN
        k2 = 1
        faceindex = 1
      ELSE
!  (M .EQ. 6)
        k1 = kl
        faceindex = 2
      END IF
!CALL WARPQ3DM (IL, JL, KL, I1, I2, J1, J2, K1, K2,&
!     XYZ0, S0, DFACEI, DFACEJ, DFACEK, XYZ)
      CALL WARPQ3DM_SOLID_D(il, jl, kl, i1, i2, j1, j2, k1, k2, xyz0, &
&                      xyz0d, s0, s0d, dfacei(:, :, :, faceindex, 1), &
&                      dfaceid(:, :, :, faceindex, 1), dfacej(:, :, :, &
&                      faceindex, 1), dfacejd(:, :, :, faceindex, 1), &
&                      dfacek(:, :, :, faceindex, 1), dfacekd(:, :, :, &
&                      faceindex, 1), xyz, xyzd)
    END IF
  END DO
!     Perturb the volume grid as though all faces have changed.
!     The face perturbations are stored for all three stages so that
!     the volume points can be perturbed in a single pass.
!     Stage 1:  Corner motion (only). This stage is reusable by WARPQ3DM.
!     --------
!     I = 1 and IL intermediate faces.
!CALL DELQ3DM (IL, JL, KL,  1,  1, 1, JL, 1, KL, XYZ0, S0,&
!     DFACEI(1,1,1,1,1), DFACEJ, DFACEK, XYZ)
  CALL DELQ3DM_SOLID_D(il, jl, kl, 1, 1, 1, jl, 1, kl, xyz0, xyz0d, s0, &
&                 s0d, dfacei(:, :, :, 1, 1), dfaceid(:, :, :, 1, 1), &
&                 dfacej(:, :, :, 1, 1), dfacejd(:, :, :, 1, 1), dfacek(:&
&                 , :, :, 1, 1), dfacekd(:, :, :, 1, 1), xyz, xyzd)
!CALL DELQ3DM (IL, JL, KL, IL, IL, 1, JL, 1, KL, XYZ0, S0,&
!     DFACEI(1,1,1,2,1), DFACEJ, DFACEK, XYZ)
  CALL DELQ3DM_SOLID_D(il, jl, kl, il, il, 1, jl, 1, kl, xyz0, xyz0d, s0&
&                 , s0d, dfacei(:, :, :, 2, 1), dfaceid(:, :, :, 2, 1), &
&                 dfacej(:, :, :, 2, 1), dfacejd(:, :, :, 2, 1), dfacek(:&
&                 , :, :, 2, 1), dfacekd(:, :, :, 2, 1), xyz, xyzd)
!     J = 1 and JL intermediate faces.
!CALL DELQ3DM (IL, JL, KL, 1, IL,  1,  1, 1, KL, XYZ0, S0,&
!     DFACEI, DFACEJ(1,1,1,1,1), DFACEK, XYZ)
  CALL DELQ3DM_SOLID_D(il, jl, kl, 1, il, 1, 1, 1, kl, xyz0, xyz0d, s0, &
&                 s0d, dfacei(:, :, :, 1, 1), dfaceid(:, :, :, 1, 1), &
&                 dfacej(:, :, :, 1, 1), dfacejd(:, :, :, 1, 1), dfacek(:&
&                 , :, :, 1, 1), dfacekd(:, :, :, 1, 1), xyz, xyzd)
!CALL DELQ3DM (IL, JL, KL, 1, IL, JL, JL, 1, KL, XYZ0, S0,&
!     DFACEI, DFACEJ(1,1,1,2,1), DFACEK, XYZ)
  CALL DELQ3DM_SOLID_D(il, jl, kl, 1, il, jl, jl, 1, kl, xyz0, xyz0d, s0&
&                 , s0d, dfacei(:, :, :, 2, 1), dfaceid(:, :, :, 2, 1), &
&                 dfacej(:, :, :, 2, 1), dfacejd(:, :, :, 2, 1), dfacek(:&
&                 , :, :, 2, 1), dfacekd(:, :, :, 2, 1), xyz, xyzd)
!     K = 1 and KL intermediate faces.
!CALL DELQ3DM (IL, JL, KL, 1, IL, 1, JL,  1,  1, XYZ0, S0,&
!     DFACEI, DFACEJ, DFACEK(1,1,1,1,1), XYZ)
  CALL DELQ3DM_SOLID_D(il, jl, kl, 1, il, 1, jl, 1, 1, xyz0, xyz0d, s0, &
&                 s0d, dfacei(:, :, :, 1, 1), dfaceid(:, :, :, 1, 1), &
&                 dfacej(:, :, :, 1, 1), dfacejd(:, :, :, 1, 1), dfacek(:&
&                 , :, :, 1, 1), dfacekd(:, :, :, 1, 1), xyz, xyzd)
!CALL DELQ3DM (IL, JL, KL, 1, IL, 1, JL, KL, KL, XYZ0, S0,&
!     DFACEI, DFACEJ, DFACEK(1,1,1,2,1), XYZ)
  CALL DELQ3DM_SOLID_D(il, jl, kl, 1, il, 1, jl, kl, kl, xyz0, xyz0d, s0&
&                 , s0d, dfacei(:, :, :, 2, 1), dfaceid(:, :, :, 2, 1), &
&                 dfacej(:, :, :, 2, 1), dfacejd(:, :, :, 2, 1), dfacek(:&
&                 , :, :, 2, 1), dfacekd(:, :, :, 2, 1), xyz, xyzd)
!     Stage 2:  Handle edge motion from above interim edges to final edges.
!     --------
!     James's insight here: consider the 4 faces affected by the motion of
!     4 edges in a given (index) direction; furthermore, keep the two
!     directions of the resulting face perturbations separated for proper
!     weighted combination during the final interpolation into the interior.
!     The 3 index directions are then independent of each other (added).
!     I = 1 and IL faces:
  l = 1
  DO i=1,il,il-1
!        K = 1 and KL edge perturbations (J direction edges):
    DO j=2,jl-1
      dfaceid(1, j, 1, l, 2) = xyzd(1, i, j, 1) - xyz0d(1, i, j, 1) - &
&        dfaceid(1, j, 1, l, 1)
      dfacei(1, j, 1, l, 2) = xyz(1, i, j, 1) - xyz0(1, i, j, 1) - &
&        dfacei(1, j, 1, l, 1)
      dfaceid(2, j, 1, l, 2) = xyzd(2, i, j, 1) - xyz0d(2, i, j, 1) - &
&        dfaceid(2, j, 1, l, 1)
      dfacei(2, j, 1, l, 2) = xyz(2, i, j, 1) - xyz0(2, i, j, 1) - &
&        dfacei(2, j, 1, l, 1)
      dfaceid(3, j, 1, l, 2) = xyzd(3, i, j, 1) - xyz0d(3, i, j, 1) - &
&        dfaceid(3, j, 1, l, 1)
      dfacei(3, j, 1, l, 2) = xyz(3, i, j, 1) - xyz0(3, i, j, 1) - &
&        dfacei(3, j, 1, l, 1)
      dfaceid(1, j, kl, l, 2) = xyzd(1, i, j, kl) - xyz0d(1, i, j, kl) -&
&        dfaceid(1, j, kl, l, 1)
      dfacei(1, j, kl, l, 2) = xyz(1, i, j, kl) - xyz0(1, i, j, kl) - &
&        dfacei(1, j, kl, l, 1)
      dfaceid(2, j, kl, l, 2) = xyzd(2, i, j, kl) - xyz0d(2, i, j, kl) -&
&        dfaceid(2, j, kl, l, 1)
      dfacei(2, j, kl, l, 2) = xyz(2, i, j, kl) - xyz0(2, i, j, kl) - &
&        dfacei(2, j, kl, l, 1)
      dfaceid(3, j, kl, l, 2) = xyzd(3, i, j, kl) - xyz0d(3, i, j, kl) -&
&        dfaceid(3, j, kl, l, 1)
      dfacei(3, j, kl, l, 2) = xyz(3, i, j, kl) - xyz0(3, i, j, kl) - &
&        dfacei(3, j, kl, l, 1)
    END DO
!        J = 1 and JL edge perturbations (K direction edges):
    DO k=2,kl-1
      dfaceid(1, 1, k, l, 3) = xyzd(1, i, 1, k) - xyz0d(1, i, 1, k) - &
&        dfaceid(1, 1, k, l, 1)
      dfacei(1, 1, k, l, 3) = xyz(1, i, 1, k) - xyz0(1, i, 1, k) - &
&        dfacei(1, 1, k, l, 1)
      dfaceid(2, 1, k, l, 3) = xyzd(2, i, 1, k) - xyz0d(2, i, 1, k) - &
&        dfaceid(2, 1, k, l, 1)
      dfacei(2, 1, k, l, 3) = xyz(2, i, 1, k) - xyz0(2, i, 1, k) - &
&        dfacei(2, 1, k, l, 1)
      dfaceid(3, 1, k, l, 3) = xyzd(3, i, 1, k) - xyz0d(3, i, 1, k) - &
&        dfaceid(3, 1, k, l, 1)
      dfacei(3, 1, k, l, 3) = xyz(3, i, 1, k) - xyz0(3, i, 1, k) - &
&        dfacei(3, 1, k, l, 1)
      dfaceid(1, jl, k, l, 3) = xyzd(1, i, jl, k) - xyz0d(1, i, jl, k) -&
&        dfaceid(1, jl, k, l, 1)
      dfacei(1, jl, k, l, 3) = xyz(1, i, jl, k) - xyz0(1, i, jl, k) - &
&        dfacei(1, jl, k, l, 1)
      dfaceid(2, jl, k, l, 3) = xyzd(2, i, jl, k) - xyz0d(2, i, jl, k) -&
&        dfaceid(2, jl, k, l, 1)
      dfacei(2, jl, k, l, 3) = xyz(2, i, jl, k) - xyz0(2, i, jl, k) - &
&        dfacei(2, jl, k, l, 1)
      dfaceid(3, jl, k, l, 3) = xyzd(3, i, jl, k) - xyz0d(3, i, jl, k) -&
&        dfaceid(3, jl, k, l, 1)
      dfacei(3, jl, k, l, 3) = xyz(3, i, jl, k) - xyz0(3, i, jl, k) - &
&        dfacei(3, jl, k, l, 1)
    END DO
!        Interpolate stage 2 interior points for this I face, keeping the
!        two index directions separated.
    DO k=2,kl-1
      DO j=2,jl-1
        wtj2d = s0d(2, i, j, k)
        wtj2 = s0(2, i, j, k)
        wtj1d = -wtj2d
        wtj1 = one - wtj2
        wtk2d = s0d(3, i, j, k)
        wtk2 = s0(3, i, j, k)
        wtk1d = -wtk2d
        wtk1 = one - wtk2
        dfaceid(1, j, k, l, 3) = wtj1d*dfacei(1, 1, k, l, 3) + wtj1*&
&          dfaceid(1, 1, k, l, 3) + wtj2d*dfacei(1, jl, k, l, 3) + wtj2*&
&          dfaceid(1, jl, k, l, 3)
        dfacei(1, j, k, l, 3) = wtj1*dfacei(1, 1, k, l, 3) + wtj2*dfacei&
&          (1, jl, k, l, 3)
        dfaceid(2, j, k, l, 3) = wtj1d*dfacei(2, 1, k, l, 3) + wtj1*&
&          dfaceid(2, 1, k, l, 3) + wtj2d*dfacei(2, jl, k, l, 3) + wtj2*&
&          dfaceid(2, jl, k, l, 3)
        dfacei(2, j, k, l, 3) = wtj1*dfacei(2, 1, k, l, 3) + wtj2*dfacei&
&          (2, jl, k, l, 3)
        dfaceid(3, j, k, l, 3) = wtj1d*dfacei(3, 1, k, l, 3) + wtj1*&
&          dfaceid(3, 1, k, l, 3) + wtj2d*dfacei(3, jl, k, l, 3) + wtj2*&
&          dfaceid(3, jl, k, l, 3)
        dfacei(3, j, k, l, 3) = wtj1*dfacei(3, 1, k, l, 3) + wtj2*dfacei&
&          (3, jl, k, l, 3)
        dfaceid(1, j, k, l, 2) = wtk1d*dfacei(1, j, 1, l, 2) + wtk1*&
&          dfaceid(1, j, 1, l, 2) + wtk2d*dfacei(1, j, kl, l, 2) + wtk2*&
&          dfaceid(1, j, kl, l, 2)
        dfacei(1, j, k, l, 2) = wtk1*dfacei(1, j, 1, l, 2) + wtk2*dfacei&
&          (1, j, kl, l, 2)
        dfaceid(2, j, k, l, 2) = wtk1d*dfacei(2, j, 1, l, 2) + wtk1*&
&          dfaceid(2, j, 1, l, 2) + wtk2d*dfacei(2, j, kl, l, 2) + wtk2*&
&          dfaceid(2, j, kl, l, 2)
        dfacei(2, j, k, l, 2) = wtk1*dfacei(2, j, 1, l, 2) + wtk2*dfacei&
&          (2, j, kl, l, 2)
        dfaceid(3, j, k, l, 2) = wtk1d*dfacei(3, j, 1, l, 2) + wtk1*&
&          dfaceid(3, j, 1, l, 2) + wtk2d*dfacei(3, j, kl, l, 2) + wtk2*&
&          dfaceid(3, j, kl, l, 2)
        dfacei(3, j, k, l, 2) = wtk1*dfacei(3, j, 1, l, 2) + wtk2*dfacei&
&          (3, j, kl, l, 2)
      END DO
    END DO
    l = 2
  END DO
!     J = 1 and JL faces, stage 2:
  l = 1
  DO j=1,jl,jl-1
!        K = 1 and KL edge perturbations (I direction):
    DO i=2,il-1
      dfacejd(1, i, 1, l, 2) = xyzd(1, i, j, 1) - xyz0d(1, i, j, 1) - &
&        dfacejd(1, i, 1, l, 1)
      dfacej(1, i, 1, l, 2) = xyz(1, i, j, 1) - xyz0(1, i, j, 1) - &
&        dfacej(1, i, 1, l, 1)
      dfacejd(2, i, 1, l, 2) = xyzd(2, i, j, 1) - xyz0d(2, i, j, 1) - &
&        dfacejd(2, i, 1, l, 1)
      dfacej(2, i, 1, l, 2) = xyz(2, i, j, 1) - xyz0(2, i, j, 1) - &
&        dfacej(2, i, 1, l, 1)
      dfacejd(3, i, 1, l, 2) = xyzd(3, i, j, 1) - xyz0d(3, i, j, 1) - &
&        dfacejd(3, i, 1, l, 1)
      dfacej(3, i, 1, l, 2) = xyz(3, i, j, 1) - xyz0(3, i, j, 1) - &
&        dfacej(3, i, 1, l, 1)
      dfacejd(1, i, kl, l, 2) = xyzd(1, i, j, kl) - xyz0d(1, i, j, kl) -&
&        dfacejd(1, i, kl, l, 1)
      dfacej(1, i, kl, l, 2) = xyz(1, i, j, kl) - xyz0(1, i, j, kl) - &
&        dfacej(1, i, kl, l, 1)
      dfacejd(2, i, kl, l, 2) = xyzd(2, i, j, kl) - xyz0d(2, i, j, kl) -&
&        dfacejd(2, i, kl, l, 1)
      dfacej(2, i, kl, l, 2) = xyz(2, i, j, kl) - xyz0(2, i, j, kl) - &
&        dfacej(2, i, kl, l, 1)
      dfacejd(3, i, kl, l, 2) = xyzd(3, i, j, kl) - xyz0d(3, i, j, kl) -&
&        dfacejd(3, i, kl, l, 1)
      dfacej(3, i, kl, l, 2) = xyz(3, i, j, kl) - xyz0(3, i, j, kl) - &
&        dfacej(3, i, kl, l, 1)
    END DO
!        I = 1 and IL edge perturbations (K direction):
    DO k=2,kl-1
      dfacejd(1, 1, k, l, 3) = xyzd(1, 1, j, k) - xyz0d(1, 1, j, k) - &
&        dfacejd(1, 1, k, l, 1)
      dfacej(1, 1, k, l, 3) = xyz(1, 1, j, k) - xyz0(1, 1, j, k) - &
&        dfacej(1, 1, k, l, 1)
      dfacejd(2, 1, k, l, 3) = xyzd(2, 1, j, k) - xyz0d(2, 1, j, k) - &
&        dfacejd(2, 1, k, l, 1)
      dfacej(2, 1, k, l, 3) = xyz(2, 1, j, k) - xyz0(2, 1, j, k) - &
&        dfacej(2, 1, k, l, 1)
      dfacejd(3, 1, k, l, 3) = xyzd(3, 1, j, k) - xyz0d(3, 1, j, k) - &
&        dfacejd(3, 1, k, l, 1)
      dfacej(3, 1, k, l, 3) = xyz(3, 1, j, k) - xyz0(3, 1, j, k) - &
&        dfacej(3, 1, k, l, 1)
      dfacejd(1, il, k, l, 3) = xyzd(1, il, j, k) - xyz0d(1, il, j, k) -&
&        dfacejd(1, il, k, l, 1)
      dfacej(1, il, k, l, 3) = xyz(1, il, j, k) - xyz0(1, il, j, k) - &
&        dfacej(1, il, k, l, 1)
      dfacejd(2, il, k, l, 3) = xyzd(2, il, j, k) - xyz0d(2, il, j, k) -&
&        dfacejd(2, il, k, l, 1)
      dfacej(2, il, k, l, 3) = xyz(2, il, j, k) - xyz0(2, il, j, k) - &
&        dfacej(2, il, k, l, 1)
      dfacejd(3, il, k, l, 3) = xyzd(3, il, j, k) - xyz0d(3, il, j, k) -&
&        dfacejd(3, il, k, l, 1)
      dfacej(3, il, k, l, 3) = xyz(3, il, j, k) - xyz0(3, il, j, k) - &
&        dfacej(3, il, k, l, 1)
    END DO
!        Interpolate stage 2 interior points for this J face.
    DO k=2,kl-1
      DO i=2,il-1
        wti2d = s0d(1, i, j, k)
        wti2 = s0(1, i, j, k)
        wti1d = -wti2d
        wti1 = one - wti2
        wtk2d = s0d(3, i, j, k)
        wtk2 = s0(3, i, j, k)
        wtk1d = -wtk2d
        wtk1 = one - wtk2
        dfacejd(1, i, k, l, 3) = wti1d*dfacej(1, 1, k, l, 3) + wti1*&
&          dfacejd(1, 1, k, l, 3) + wti2d*dfacej(1, il, k, l, 3) + wti2*&
&          dfacejd(1, il, k, l, 3)
        dfacej(1, i, k, l, 3) = wti1*dfacej(1, 1, k, l, 3) + wti2*dfacej&
&          (1, il, k, l, 3)
        dfacejd(2, i, k, l, 3) = wti1d*dfacej(2, 1, k, l, 3) + wti1*&
&          dfacejd(2, 1, k, l, 3) + wti2d*dfacej(2, il, k, l, 3) + wti2*&
&          dfacejd(2, il, k, l, 3)
        dfacej(2, i, k, l, 3) = wti1*dfacej(2, 1, k, l, 3) + wti2*dfacej&
&          (2, il, k, l, 3)
        dfacejd(3, i, k, l, 3) = wti1d*dfacej(3, 1, k, l, 3) + wti1*&
&          dfacejd(3, 1, k, l, 3) + wti2d*dfacej(3, il, k, l, 3) + wti2*&
&          dfacejd(3, il, k, l, 3)
        dfacej(3, i, k, l, 3) = wti1*dfacej(3, 1, k, l, 3) + wti2*dfacej&
&          (3, il, k, l, 3)
        dfacejd(1, i, k, l, 2) = wtk1d*dfacej(1, i, 1, l, 2) + wtk1*&
&          dfacejd(1, i, 1, l, 2) + wtk2d*dfacej(1, i, kl, l, 2) + wtk2*&
&          dfacejd(1, i, kl, l, 2)
        dfacej(1, i, k, l, 2) = wtk1*dfacej(1, i, 1, l, 2) + wtk2*dfacej&
&          (1, i, kl, l, 2)
        dfacejd(2, i, k, l, 2) = wtk1d*dfacej(2, i, 1, l, 2) + wtk1*&
&          dfacejd(2, i, 1, l, 2) + wtk2d*dfacej(2, i, kl, l, 2) + wtk2*&
&          dfacejd(2, i, kl, l, 2)
        dfacej(2, i, k, l, 2) = wtk1*dfacej(2, i, 1, l, 2) + wtk2*dfacej&
&          (2, i, kl, l, 2)
        dfacejd(3, i, k, l, 2) = wtk1d*dfacej(3, i, 1, l, 2) + wtk1*&
&          dfacejd(3, i, 1, l, 2) + wtk2d*dfacej(3, i, kl, l, 2) + wtk2*&
&          dfacejd(3, i, kl, l, 2)
        dfacej(3, i, k, l, 2) = wtk1*dfacej(3, i, 1, l, 2) + wtk2*dfacej&
&          (3, i, kl, l, 2)
      END DO
    END DO
    l = 2
  END DO
!     K = 1 and KL faces, stage 2:
  l = 1
  DO k=1,kl,kl-1
!        J = 1 and JL edge perturbations (I direction):
    DO i=2,il-1
      dfacekd(1, i, 1, l, 2) = xyzd(1, i, 1, k) - xyz0d(1, i, 1, k) - &
&        dfacekd(1, i, 1, l, 1)
      dfacek(1, i, 1, l, 2) = xyz(1, i, 1, k) - xyz0(1, i, 1, k) - &
&        dfacek(1, i, 1, l, 1)
      dfacekd(2, i, 1, l, 2) = xyzd(2, i, 1, k) - xyz0d(2, i, 1, k) - &
&        dfacekd(2, i, 1, l, 1)
      dfacek(2, i, 1, l, 2) = xyz(2, i, 1, k) - xyz0(2, i, 1, k) - &
&        dfacek(2, i, 1, l, 1)
      dfacekd(3, i, 1, l, 2) = xyzd(3, i, 1, k) - xyz0d(3, i, 1, k) - &
&        dfacekd(3, i, 1, l, 1)
      dfacek(3, i, 1, l, 2) = xyz(3, i, 1, k) - xyz0(3, i, 1, k) - &
&        dfacek(3, i, 1, l, 1)
      dfacekd(1, i, jl, l, 2) = xyzd(1, i, jl, k) - xyz0d(1, i, jl, k) -&
&        dfacekd(1, i, jl, l, 1)
      dfacek(1, i, jl, l, 2) = xyz(1, i, jl, k) - xyz0(1, i, jl, k) - &
&        dfacek(1, i, jl, l, 1)
      dfacekd(2, i, jl, l, 2) = xyzd(2, i, jl, k) - xyz0d(2, i, jl, k) -&
&        dfacekd(2, i, jl, l, 1)
      dfacek(2, i, jl, l, 2) = xyz(2, i, jl, k) - xyz0(2, i, jl, k) - &
&        dfacek(2, i, jl, l, 1)
      dfacekd(3, i, jl, l, 2) = xyzd(3, i, jl, k) - xyz0d(3, i, jl, k) -&
&        dfacekd(3, i, jl, l, 1)
      dfacek(3, i, jl, l, 2) = xyz(3, i, jl, k) - xyz0(3, i, jl, k) - &
&        dfacek(3, i, jl, l, 1)
    END DO
!        I = 1 and IL edge perturbations (J direction):
    DO j=2,jl-1
      dfacekd(1, 1, j, l, 3) = xyzd(1, 1, j, k) - xyz0d(1, 1, j, k) - &
&        dfacekd(1, 1, j, l, 1)
      dfacek(1, 1, j, l, 3) = xyz(1, 1, j, k) - xyz0(1, 1, j, k) - &
&        dfacek(1, 1, j, l, 1)
      dfacekd(2, 1, j, l, 3) = xyzd(2, 1, j, k) - xyz0d(2, 1, j, k) - &
&        dfacekd(2, 1, j, l, 1)
      dfacek(2, 1, j, l, 3) = xyz(2, 1, j, k) - xyz0(2, 1, j, k) - &
&        dfacek(2, 1, j, l, 1)
      dfacekd(3, 1, j, l, 3) = xyzd(3, 1, j, k) - xyz0d(3, 1, j, k) - &
&        dfacekd(3, 1, j, l, 1)
      dfacek(3, 1, j, l, 3) = xyz(3, 1, j, k) - xyz0(3, 1, j, k) - &
&        dfacek(3, 1, j, l, 1)
      dfacekd(1, il, j, l, 3) = xyzd(1, il, j, k) - xyz0d(1, il, j, k) -&
&        dfacekd(1, il, j, l, 1)
      dfacek(1, il, j, l, 3) = xyz(1, il, j, k) - xyz0(1, il, j, k) - &
&        dfacek(1, il, j, l, 1)
      dfacekd(2, il, j, l, 3) = xyzd(2, il, j, k) - xyz0d(2, il, j, k) -&
&        dfacekd(2, il, j, l, 1)
      dfacek(2, il, j, l, 3) = xyz(2, il, j, k) - xyz0(2, il, j, k) - &
&        dfacek(2, il, j, l, 1)
      dfacekd(3, il, j, l, 3) = xyzd(3, il, j, k) - xyz0d(3, il, j, k) -&
&        dfacekd(3, il, j, l, 1)
      dfacek(3, il, j, l, 3) = xyz(3, il, j, k) - xyz0(3, il, j, k) - &
&        dfacek(3, il, j, l, 1)
    END DO
!        Interpolate stage 2 interior points for this K face.
    DO j=2,jl-1
      DO i=2,il-1
        wti2d = s0d(1, i, j, k)
        wti2 = s0(1, i, j, k)
        wti1d = -wti2d
        wti1 = one - wti2
        wtj2d = s0d(2, i, j, k)
        wtj2 = s0(2, i, j, k)
        wtj1d = -wtj2d
        wtj1 = one - wtj2
        dfacekd(1, i, j, l, 3) = wti1d*dfacek(1, 1, j, l, 3) + wti1*&
&          dfacekd(1, 1, j, l, 3) + wti2d*dfacek(1, il, j, l, 3) + wti2*&
&          dfacekd(1, il, j, l, 3)
        dfacek(1, i, j, l, 3) = wti1*dfacek(1, 1, j, l, 3) + wti2*dfacek&
&          (1, il, j, l, 3)
        dfacekd(2, i, j, l, 3) = wti1d*dfacek(2, 1, j, l, 3) + wti1*&
&          dfacekd(2, 1, j, l, 3) + wti2d*dfacek(2, il, j, l, 3) + wti2*&
&          dfacekd(2, il, j, l, 3)
        dfacek(2, i, j, l, 3) = wti1*dfacek(2, 1, j, l, 3) + wti2*dfacek&
&          (2, il, j, l, 3)
        dfacekd(3, i, j, l, 3) = wti1d*dfacek(3, 1, j, l, 3) + wti1*&
&          dfacekd(3, 1, j, l, 3) + wti2d*dfacek(3, il, j, l, 3) + wti2*&
&          dfacekd(3, il, j, l, 3)
        dfacek(3, i, j, l, 3) = wti1*dfacek(3, 1, j, l, 3) + wti2*dfacek&
&          (3, il, j, l, 3)
        dfacekd(1, i, j, l, 2) = wtj1d*dfacek(1, i, 1, l, 2) + wtj1*&
&          dfacekd(1, i, 1, l, 2) + wtj2d*dfacek(1, i, jl, l, 2) + wtj2*&
&          dfacekd(1, i, jl, l, 2)
        dfacek(1, i, j, l, 2) = wtj1*dfacek(1, i, 1, l, 2) + wtj2*dfacek&
&          (1, i, jl, l, 2)
        dfacekd(2, i, j, l, 2) = wtj1d*dfacek(2, i, 1, l, 2) + wtj1*&
&          dfacekd(2, i, 1, l, 2) + wtj2d*dfacek(2, i, jl, l, 2) + wtj2*&
&          dfacekd(2, i, jl, l, 2)
        dfacek(2, i, j, l, 2) = wtj1*dfacek(2, i, 1, l, 2) + wtj2*dfacek&
&          (2, i, jl, l, 2)
        dfacekd(3, i, j, l, 2) = wtj1d*dfacek(3, i, 1, l, 2) + wtj1*&
&          dfacekd(3, i, 1, l, 2) + wtj2d*dfacek(3, i, jl, l, 2) + wtj2*&
&          dfacekd(3, i, jl, l, 2)
        dfacek(3, i, j, l, 2) = wtj1*dfacek(3, i, 1, l, 2) + wtj2*dfacek&
&          (3, i, jl, l, 2)
      END DO
    END DO
    l = 2
  END DO
!     Stage 3:  Handle face motion from above interim faces to final faces.
!     --------
  DO k=2,kl-1
    DO j=2,jl-1
      dfaceid(1, j, k, 1, 4) = xyzd(1, 1, j, k) - xyz0d(1, 1, j, k) - &
&        dfaceid(1, j, k, 1, 1) - dfaceid(1, j, k, 1, 2) - dfaceid(1, j, &
&        k, 1, 3)
      dfacei(1, j, k, 1, 4) = xyz(1, 1, j, k) - xyz0(1, 1, j, k) - &
&        dfacei(1, j, k, 1, 1) - dfacei(1, j, k, 1, 2) - dfacei(1, j, k, &
&        1, 3)
      dfaceid(2, j, k, 1, 4) = xyzd(2, 1, j, k) - xyz0d(2, 1, j, k) - &
&        dfaceid(2, j, k, 1, 1) - dfaceid(2, j, k, 1, 2) - dfaceid(2, j, &
&        k, 1, 3)
      dfacei(2, j, k, 1, 4) = xyz(2, 1, j, k) - xyz0(2, 1, j, k) - &
&        dfacei(2, j, k, 1, 1) - dfacei(2, j, k, 1, 2) - dfacei(2, j, k, &
&        1, 3)
      dfaceid(3, j, k, 1, 4) = xyzd(3, 1, j, k) - xyz0d(3, 1, j, k) - &
&        dfaceid(3, j, k, 1, 1) - dfaceid(3, j, k, 1, 2) - dfaceid(3, j, &
&        k, 1, 3)
      dfacei(3, j, k, 1, 4) = xyz(3, 1, j, k) - xyz0(3, 1, j, k) - &
&        dfacei(3, j, k, 1, 1) - dfacei(3, j, k, 1, 2) - dfacei(3, j, k, &
&        1, 3)
      dfaceid(1, j, k, 2, 4) = xyzd(1, il, j, k) - xyz0d(1, il, j, k) - &
&        dfaceid(1, j, k, 2, 1) - dfaceid(1, j, k, 2, 2) - dfaceid(1, j, &
&        k, 2, 3)
      dfacei(1, j, k, 2, 4) = xyz(1, il, j, k) - xyz0(1, il, j, k) - &
&        dfacei(1, j, k, 2, 1) - dfacei(1, j, k, 2, 2) - dfacei(1, j, k, &
&        2, 3)
      dfaceid(2, j, k, 2, 4) = xyzd(2, il, j, k) - xyz0d(2, il, j, k) - &
&        dfaceid(2, j, k, 2, 1) - dfaceid(2, j, k, 2, 2) - dfaceid(2, j, &
&        k, 2, 3)
      dfacei(2, j, k, 2, 4) = xyz(2, il, j, k) - xyz0(2, il, j, k) - &
&        dfacei(2, j, k, 2, 1) - dfacei(2, j, k, 2, 2) - dfacei(2, j, k, &
&        2, 3)
      dfaceid(3, j, k, 2, 4) = xyzd(3, il, j, k) - xyz0d(3, il, j, k) - &
&        dfaceid(3, j, k, 2, 1) - dfaceid(3, j, k, 2, 2) - dfaceid(3, j, &
&        k, 2, 3)
      dfacei(3, j, k, 2, 4) = xyz(3, il, j, k) - xyz0(3, il, j, k) - &
&        dfacei(3, j, k, 2, 1) - dfacei(3, j, k, 2, 2) - dfacei(3, j, k, &
&        2, 3)
    END DO
    DO i=2,il-1
      dfacejd(1, i, k, 1, 4) = xyzd(1, i, 1, k) - xyz0d(1, i, 1, k) - &
&        dfacejd(1, i, k, 1, 1) - dfacejd(1, i, k, 1, 2) - dfacejd(1, i, &
&        k, 1, 3)
      dfacej(1, i, k, 1, 4) = xyz(1, i, 1, k) - xyz0(1, i, 1, k) - &
&        dfacej(1, i, k, 1, 1) - dfacej(1, i, k, 1, 2) - dfacej(1, i, k, &
&        1, 3)
      dfacejd(2, i, k, 1, 4) = xyzd(2, i, 1, k) - xyz0d(2, i, 1, k) - &
&        dfacejd(2, i, k, 1, 1) - dfacejd(2, i, k, 1, 2) - dfacejd(2, i, &
&        k, 1, 3)
      dfacej(2, i, k, 1, 4) = xyz(2, i, 1, k) - xyz0(2, i, 1, k) - &
&        dfacej(2, i, k, 1, 1) - dfacej(2, i, k, 1, 2) - dfacej(2, i, k, &
&        1, 3)
      dfacejd(3, i, k, 1, 4) = xyzd(3, i, 1, k) - xyz0d(3, i, 1, k) - &
&        dfacejd(3, i, k, 1, 1) - dfacejd(3, i, k, 1, 2) - dfacejd(3, i, &
&        k, 1, 3)
      dfacej(3, i, k, 1, 4) = xyz(3, i, 1, k) - xyz0(3, i, 1, k) - &
&        dfacej(3, i, k, 1, 1) - dfacej(3, i, k, 1, 2) - dfacej(3, i, k, &
&        1, 3)
      dfacejd(1, i, k, 2, 4) = xyzd(1, i, jl, k) - xyz0d(1, i, jl, k) - &
&        dfacejd(1, i, k, 2, 1) - dfacejd(1, i, k, 2, 2) - dfacejd(1, i, &
&        k, 2, 3)
      dfacej(1, i, k, 2, 4) = xyz(1, i, jl, k) - xyz0(1, i, jl, k) - &
&        dfacej(1, i, k, 2, 1) - dfacej(1, i, k, 2, 2) - dfacej(1, i, k, &
&        2, 3)
      dfacejd(2, i, k, 2, 4) = xyzd(2, i, jl, k) - xyz0d(2, i, jl, k) - &
&        dfacejd(2, i, k, 2, 1) - dfacejd(2, i, k, 2, 2) - dfacejd(2, i, &
&        k, 2, 3)
      dfacej(2, i, k, 2, 4) = xyz(2, i, jl, k) - xyz0(2, i, jl, k) - &
&        dfacej(2, i, k, 2, 1) - dfacej(2, i, k, 2, 2) - dfacej(2, i, k, &
&        2, 3)
      dfacejd(3, i, k, 2, 4) = xyzd(3, i, jl, k) - xyz0d(3, i, jl, k) - &
&        dfacejd(3, i, k, 2, 1) - dfacejd(3, i, k, 2, 2) - dfacejd(3, i, &
&        k, 2, 3)
      dfacej(3, i, k, 2, 4) = xyz(3, i, jl, k) - xyz0(3, i, jl, k) - &
&        dfacej(3, i, k, 2, 1) - dfacej(3, i, k, 2, 2) - dfacej(3, i, k, &
&        2, 3)
    END DO
  END DO
  DO j=2,jl-1
    DO i=2,il-1
      dfacekd(1, i, j, 1, 4) = xyzd(1, i, j, 1) - xyz0d(1, i, j, 1) - &
&        dfacekd(1, i, j, 1, 1) - dfacekd(1, i, j, 1, 2) - dfacekd(1, i, &
&        j, 1, 3)
      dfacek(1, i, j, 1, 4) = xyz(1, i, j, 1) - xyz0(1, i, j, 1) - &
&        dfacek(1, i, j, 1, 1) - dfacek(1, i, j, 1, 2) - dfacek(1, i, j, &
&        1, 3)
      dfacekd(2, i, j, 1, 4) = xyzd(2, i, j, 1) - xyz0d(2, i, j, 1) - &
&        dfacekd(2, i, j, 1, 1) - dfacekd(2, i, j, 1, 2) - dfacekd(2, i, &
&        j, 1, 3)
      dfacek(2, i, j, 1, 4) = xyz(2, i, j, 1) - xyz0(2, i, j, 1) - &
&        dfacek(2, i, j, 1, 1) - dfacek(2, i, j, 1, 2) - dfacek(2, i, j, &
&        1, 3)
      dfacekd(3, i, j, 1, 4) = xyzd(3, i, j, 1) - xyz0d(3, i, j, 1) - &
&        dfacekd(3, i, j, 1, 1) - dfacekd(3, i, j, 1, 2) - dfacekd(3, i, &
&        j, 1, 3)
      dfacek(3, i, j, 1, 4) = xyz(3, i, j, 1) - xyz0(3, i, j, 1) - &
&        dfacek(3, i, j, 1, 1) - dfacek(3, i, j, 1, 2) - dfacek(3, i, j, &
&        1, 3)
      dfacekd(1, i, j, 2, 4) = xyzd(1, i, j, kl) - xyz0d(1, i, j, kl) - &
&        dfacekd(1, i, j, 2, 1) - dfacekd(1, i, j, 2, 2) - dfacekd(1, i, &
&        j, 2, 3)
      dfacek(1, i, j, 2, 4) = xyz(1, i, j, kl) - xyz0(1, i, j, kl) - &
&        dfacek(1, i, j, 2, 1) - dfacek(1, i, j, 2, 2) - dfacek(1, i, j, &
&        2, 3)
      dfacekd(2, i, j, 2, 4) = xyzd(2, i, j, kl) - xyz0d(2, i, j, kl) - &
&        dfacekd(2, i, j, 2, 1) - dfacekd(2, i, j, 2, 2) - dfacekd(2, i, &
&        j, 2, 3)
      dfacek(2, i, j, 2, 4) = xyz(2, i, j, kl) - xyz0(2, i, j, kl) - &
&        dfacek(2, i, j, 2, 1) - dfacek(2, i, j, 2, 2) - dfacek(2, i, j, &
&        2, 3)
      dfacekd(3, i, j, 2, 4) = xyzd(3, i, j, kl) - xyz0d(3, i, j, kl) - &
&        dfacekd(3, i, j, 2, 1) - dfacekd(3, i, j, 2, 2) - dfacekd(3, i, &
&        j, 2, 3)
      dfacek(3, i, j, 2, 4) = xyz(3, i, j, kl) - xyz0(3, i, j, kl) - &
&        dfacek(3, i, j, 2, 1) - dfacek(3, i, j, 2, 2) - dfacek(3, i, j, &
&        2, 3)
    END DO
  END DO
!     Perturb the interior volume points.
!     All stages are performed at once via interpolation from the face
!     perturbations stored for each stage.  Note that the three stages
!     accumulate the contributions from the three subscript directions
!     with varying degrees of independence.
  DO k=2,kl-1
    DO j=2,jl-1
      DO i=2,il-1
        wti2d = s0d(1, i, j, k)
        wti2 = s0(1, i, j, k)
        wti1d = -wti2d
        wti1 = one - wti2
        wtj2d = s0d(2, i, j, k)
        wtj2 = s0(2, i, j, k)
        wtj1d = -wtj2d
        wtj1 = one - wtj2
        wtk2d = s0d(3, i, j, k)
        wtk2 = s0(3, i, j, k)
        wtk1d = -wtk2d
        wtk1 = one - wtk2
!              Stage 1:
        delid = wti1d*dfacei(1, j, k, 1, 1) + wti1*dfaceid(1, j, k, 1, 1&
&          ) + wti2d*dfacei(1, j, k, 2, 1) + wti2*dfaceid(1, j, k, 2, 1)
        deli = wti1*dfacei(1, j, k, 1, 1) + wti2*dfacei(1, j, k, 2, 1)
        deljd = wtj1d*dfacej(1, i, k, 1, 1) + wtj1*dfacejd(1, i, k, 1, 1&
&          ) + wtj2d*dfacej(1, i, k, 2, 1) + wtj2*dfacejd(1, i, k, 2, 1)
        delj = wtj1*dfacej(1, i, k, 1, 1) + wtj2*dfacej(1, i, k, 2, 1)
        delkd = wtk1d*dfacek(1, i, j, 1, 1) + wtk1*dfacekd(1, i, j, 1, 1&
&          ) + wtk2d*dfacek(1, i, j, 2, 1) + wtk2*dfacekd(1, i, j, 2, 1)
        delk = wtk1*dfacek(1, i, j, 1, 1) + wtk2*dfacek(1, i, j, 2, 1)
        IF (deli .GE. 0.) THEN
          abs1d = delid
          abs1 = deli
        ELSE
          abs1d = -delid
          abs1 = -deli
        END IF
        IF (delj .GE. 0.) THEN
          abs13d = deljd
          abs13 = delj
        ELSE
          abs13d = -deljd
          abs13 = -delj
        END IF
        IF (delk .GE. 0.) THEN
          abs25d = delkd
          abs25 = delk
        ELSE
          abs25d = -delkd
          abs25 = -delk
        END IF
        IF (deli .GE. 0.) THEN
          abs37d = delid
          abs37 = deli
        ELSE
          abs37d = -delid
          abs37 = -deli
        END IF
        IF (delj .GE. 0.) THEN
          abs49d = deljd
          abs49 = delj
        ELSE
          abs49d = -deljd
          abs49 = -delj
        END IF
        IF (delk .GE. 0.) THEN
          abs52d = delkd
          abs52 = delk
        ELSE
          abs52d = -delkd
          abs52 = -delk
        END IF
        x10d = abs37d + abs49d + abs52d
        x10 = abs37 + abs49 + abs52
        IF (x10 .LT. eps) THEN
          max10 = eps
          max10d = 0.0
        ELSE
          max10d = x10d
          max10 = x10
        END IF
        del1d = ((abs1d*deli+abs1*delid+abs13d*delj+abs13*deljd+abs25d*&
&          delk+abs25*delkd)*max10-(abs1*deli+abs13*delj+abs25*delk)*&
&          max10d)/max10**2
        del1 = (abs1*deli+abs13*delj+abs25*delk)/max10
!              Stage 2:
        delijd = wtj1d*dfacej(1, i, k, 1, 2) + wtj1*dfacejd(1, i, k, 1, &
&          2) + wtj2d*dfacej(1, i, k, 2, 2) + wtj2*dfacejd(1, i, k, 2, 2)
        delij = wtj1*dfacej(1, i, k, 1, 2) + wtj2*dfacej(1, i, k, 2, 2)
        delikd = wtk1d*dfacek(1, i, j, 1, 2) + wtk1*dfacekd(1, i, j, 1, &
&          2) + wtk2d*dfacek(1, i, j, 2, 2) + wtk2*dfacekd(1, i, j, 2, 2)
        delik = wtk1*dfacek(1, i, j, 1, 2) + wtk2*dfacek(1, i, j, 2, 2)
        IF (delij .GE. 0.) THEN
          abs2d = delijd
          abs2 = delij
        ELSE
          abs2d = -delijd
          abs2 = -delij
        END IF
        IF (delik .GE. 0.) THEN
          abs14d = delikd
          abs14 = delik
        ELSE
          abs14d = -delikd
          abs14 = -delik
        END IF
        IF (delij .GE. 0.) THEN
          abs28d = delijd
          abs28 = delij
        ELSE
          abs28d = -delijd
          abs28 = -delij
        END IF
        IF (delik .GE. 0.) THEN
          abs38d = delikd
          abs38 = delik
        ELSE
          abs38d = -delikd
          abs38 = -delik
        END IF
        x1d = abs28d + abs38d
        x1 = abs28 + abs38
        IF (x1 .LT. eps) THEN
          max1 = eps
          max1d = 0.0
        ELSE
          max1d = x1d
          max1 = x1
        END IF
        delid = ((abs2d*delij+abs2*delijd+abs14d*delik+abs14*delikd)*&
&          max1-(abs2*delij+abs14*delik)*max1d)/max1**2
        deli = (abs2*delij+abs14*delik)/max1
        deljid = wti1d*dfacei(1, j, k, 1, 2) + wti1*dfaceid(1, j, k, 1, &
&          2) + wti2d*dfacei(1, j, k, 2, 2) + wti2*dfaceid(1, j, k, 2, 2)
        delji = wti1*dfacei(1, j, k, 1, 2) + wti2*dfacei(1, j, k, 2, 2)
        deljkd = wtk1d*dfacek(1, i, j, 1, 3) + wtk1*dfacekd(1, i, j, 1, &
&          3) + wtk2d*dfacek(1, i, j, 2, 3) + wtk2*dfacekd(1, i, j, 2, 3)
        deljk = wtk1*dfacek(1, i, j, 1, 3) + wtk2*dfacek(1, i, j, 2, 3)
        IF (delji .GE. 0.) THEN
          abs3d = deljid
          abs3 = delji
        ELSE
          abs3d = -deljid
          abs3 = -delji
        END IF
        IF (deljk .GE. 0.) THEN
          abs15d = deljkd
          abs15 = deljk
        ELSE
          abs15d = -deljkd
          abs15 = -deljk
        END IF
        IF (delji .GE. 0.) THEN
          abs29d = deljid
          abs29 = delji
        ELSE
          abs29d = -deljid
          abs29 = -delji
        END IF
        IF (deljk .GE. 0.) THEN
          abs39d = deljkd
          abs39 = deljk
        ELSE
          abs39d = -deljkd
          abs39 = -deljk
        END IF
        x2d = abs29d + abs39d
        x2 = abs29 + abs39
        IF (x2 .LT. eps) THEN
          max2 = eps
          max2d = 0.0
        ELSE
          max2d = x2d
          max2 = x2
        END IF
        deljd = ((abs3d*delji+abs3*deljid+abs15d*deljk+abs15*deljkd)*&
&          max2-(abs3*delji+abs15*deljk)*max2d)/max2**2
        delj = (abs3*delji+abs15*deljk)/max2
        delkid = wti1d*dfacei(1, j, k, 1, 3) + wti1*dfaceid(1, j, k, 1, &
&          3) + wti2d*dfacei(1, j, k, 2, 3) + wti2*dfaceid(1, j, k, 2, 3)
        delki = wti1*dfacei(1, j, k, 1, 3) + wti2*dfacei(1, j, k, 2, 3)
        delkjd = wtj1d*dfacej(1, i, k, 1, 3) + wtj1*dfacejd(1, i, k, 1, &
&          3) + wtj2d*dfacej(1, i, k, 2, 3) + wtj2*dfacejd(1, i, k, 2, 3)
        delkj = wtj1*dfacej(1, i, k, 1, 3) + wtj2*dfacej(1, i, k, 2, 3)
        IF (delki .GE. 0.) THEN
          abs4d = delkid
          abs4 = delki
        ELSE
          abs4d = -delkid
          abs4 = -delki
        END IF
        IF (delkj .GE. 0.) THEN
          abs16d = delkjd
          abs16 = delkj
        ELSE
          abs16d = -delkjd
          abs16 = -delkj
        END IF
        IF (delki .GE. 0.) THEN
          abs30d = delkid
          abs30 = delki
        ELSE
          abs30d = -delkid
          abs30 = -delki
        END IF
        IF (delkj .GE. 0.) THEN
          abs40d = delkjd
          abs40 = delkj
        ELSE
          abs40d = -delkjd
          abs40 = -delkj
        END IF
        x3d = abs30d + abs40d
        x3 = abs30 + abs40
        IF (x3 .LT. eps) THEN
          max3 = eps
          max3d = 0.0
        ELSE
          max3d = x3d
          max3 = x3
        END IF
        delkd = ((abs4d*delki+abs4*delkid+abs16d*delkj+abs16*delkjd)*&
&          max3-(abs4*delki+abs16*delkj)*max3d)/max3**2
        delk = (abs4*delki+abs16*delkj)/max3
        del2d = delid + deljd + delkd
        del2 = deli + delj + delk
!              Stage 3:
        delid = wti1d*dfacei(1, j, k, 1, 4) + wti1*dfaceid(1, j, k, 1, 4&
&          ) + wti2d*dfacei(1, j, k, 2, 4) + wti2*dfaceid(1, j, k, 2, 4)
        deli = wti1*dfacei(1, j, k, 1, 4) + wti2*dfacei(1, j, k, 2, 4)
        deljd = wtj1d*dfacej(1, i, k, 1, 4) + wtj1*dfacejd(1, i, k, 1, 4&
&          ) + wtj2d*dfacej(1, i, k, 2, 4) + wtj2*dfacejd(1, i, k, 2, 4)
        delj = wtj1*dfacej(1, i, k, 1, 4) + wtj2*dfacej(1, i, k, 2, 4)
        delkd = wtk1d*dfacek(1, i, j, 1, 4) + wtk1*dfacekd(1, i, j, 1, 4&
&          ) + wtk2d*dfacek(1, i, j, 2, 4) + wtk2*dfacekd(1, i, j, 2, 4)
        delk = wtk1*dfacek(1, i, j, 1, 4) + wtk2*dfacek(1, i, j, 2, 4)
        xyzd(1, i, j, k) = xyz0d(1, i, j, k) + del1d + del2d + delid + &
&          deljd + delkd
        xyz(1, i, j, k) = xyz0(1, i, j, k) + del1 + del2 + deli + delj +&
&          delk
!              Repeat all stages for Y perturbations:
        delid = wti1d*dfacei(2, j, k, 1, 1) + wti1*dfaceid(2, j, k, 1, 1&
&          ) + wti2d*dfacei(2, j, k, 2, 1) + wti2*dfaceid(2, j, k, 2, 1)
        deli = wti1*dfacei(2, j, k, 1, 1) + wti2*dfacei(2, j, k, 2, 1)
        deljd = wtj1d*dfacej(2, i, k, 1, 1) + wtj1*dfacejd(2, i, k, 1, 1&
&          ) + wtj2d*dfacej(2, i, k, 2, 1) + wtj2*dfacejd(2, i, k, 2, 1)
        delj = wtj1*dfacej(2, i, k, 1, 1) + wtj2*dfacej(2, i, k, 2, 1)
        delkd = wtk1d*dfacek(2, i, j, 1, 1) + wtk1*dfacekd(2, i, j, 1, 1&
&          ) + wtk2d*dfacek(2, i, j, 2, 1) + wtk2*dfacekd(2, i, j, 2, 1)
        delk = wtk1*dfacek(2, i, j, 1, 1) + wtk2*dfacek(2, i, j, 2, 1)
        IF (deli .GE. 0.) THEN
          abs5d = delid
          abs5 = deli
        ELSE
          abs5d = -delid
          abs5 = -deli
        END IF
        IF (delj .GE. 0.) THEN
          abs17d = deljd
          abs17 = delj
        ELSE
          abs17d = -deljd
          abs17 = -delj
        END IF
        IF (delk .GE. 0.) THEN
          abs26d = delkd
          abs26 = delk
        ELSE
          abs26d = -delkd
          abs26 = -delk
        END IF
        IF (deli .GE. 0.) THEN
          abs41d = delid
          abs41 = deli
        ELSE
          abs41d = -delid
          abs41 = -deli
        END IF
        IF (delj .GE. 0.) THEN
          abs50d = deljd
          abs50 = delj
        ELSE
          abs50d = -deljd
          abs50 = -delj
        END IF
        IF (delk .GE. 0.) THEN
          abs53d = delkd
          abs53 = delk
        ELSE
          abs53d = -delkd
          abs53 = -delk
        END IF
        x11d = abs41d + abs50d + abs53d
        x11 = abs41 + abs50 + abs53
        IF (x11 .LT. eps) THEN
          max11 = eps
          max11d = 0.0
        ELSE
          max11d = x11d
          max11 = x11
        END IF
        del1d = ((abs5d*deli+abs5*delid+abs17d*delj+abs17*deljd+abs26d*&
&          delk+abs26*delkd)*max11-(abs5*deli+abs17*delj+abs26*delk)*&
&          max11d)/max11**2
        del1 = (abs5*deli+abs17*delj+abs26*delk)/max11
        delijd = wtj1d*dfacej(2, i, k, 1, 2) + wtj1*dfacejd(2, i, k, 1, &
&          2) + wtj2d*dfacej(2, i, k, 2, 2) + wtj2*dfacejd(2, i, k, 2, 2)
        delij = wtj1*dfacej(2, i, k, 1, 2) + wtj2*dfacej(2, i, k, 2, 2)
        delikd = wtk1d*dfacek(2, i, j, 1, 2) + wtk1*dfacekd(2, i, j, 1, &
&          2) + wtk2d*dfacek(2, i, j, 2, 2) + wtk2*dfacekd(2, i, j, 2, 2)
        delik = wtk1*dfacek(2, i, j, 1, 2) + wtk2*dfacek(2, i, j, 2, 2)
        IF (delij .GE. 0.) THEN
          abs6d = delijd
          abs6 = delij
        ELSE
          abs6d = -delijd
          abs6 = -delij
        END IF
        IF (delik .GE. 0.) THEN
          abs18d = delikd
          abs18 = delik
        ELSE
          abs18d = -delikd
          abs18 = -delik
        END IF
        IF (delij .GE. 0.) THEN
          abs31d = delijd
          abs31 = delij
        ELSE
          abs31d = -delijd
          abs31 = -delij
        END IF
        IF (delik .GE. 0.) THEN
          abs42d = delikd
          abs42 = delik
        ELSE
          abs42d = -delikd
          abs42 = -delik
        END IF
        x4d = abs31d + abs42d
        x4 = abs31 + abs42
        IF (x4 .LT. eps) THEN
          max4 = eps
          max4d = 0.0
        ELSE
          max4d = x4d
          max4 = x4
        END IF
        delid = ((abs6d*delij+abs6*delijd+abs18d*delik+abs18*delikd)*&
&          max4-(abs6*delij+abs18*delik)*max4d)/max4**2
        deli = (abs6*delij+abs18*delik)/max4
        deljid = wti1d*dfacei(2, j, k, 1, 2) + wti1*dfaceid(2, j, k, 1, &
&          2) + wti2d*dfacei(2, j, k, 2, 2) + wti2*dfaceid(2, j, k, 2, 2)
        delji = wti1*dfacei(2, j, k, 1, 2) + wti2*dfacei(2, j, k, 2, 2)
        deljkd = wtk1d*dfacek(2, i, j, 1, 3) + wtk1*dfacekd(2, i, j, 1, &
&          3) + wtk2d*dfacek(2, i, j, 2, 3) + wtk2*dfacekd(2, i, j, 2, 3)
        deljk = wtk1*dfacek(2, i, j, 1, 3) + wtk2*dfacek(2, i, j, 2, 3)
        IF (delji .GE. 0.) THEN
          abs7d = deljid
          abs7 = delji
        ELSE
          abs7d = -deljid
          abs7 = -delji
        END IF
        IF (deljk .GE. 0.) THEN
          abs19d = deljkd
          abs19 = deljk
        ELSE
          abs19d = -deljkd
          abs19 = -deljk
        END IF
        IF (delji .GE. 0.) THEN
          abs32d = deljid
          abs32 = delji
        ELSE
          abs32d = -deljid
          abs32 = -delji
        END IF
        IF (deljk .GE. 0.) THEN
          abs43d = deljkd
          abs43 = deljk
        ELSE
          abs43d = -deljkd
          abs43 = -deljk
        END IF
        x5d = abs32d + abs43d
        x5 = abs32 + abs43
        IF (x5 .LT. eps) THEN
          max5 = eps
          max5d = 0.0
        ELSE
          max5d = x5d
          max5 = x5
        END IF
        deljd = ((abs7d*delji+abs7*deljid+abs19d*deljk+abs19*deljkd)*&
&          max5-(abs7*delji+abs19*deljk)*max5d)/max5**2
        delj = (abs7*delji+abs19*deljk)/max5
        delkid = wti1d*dfacei(2, j, k, 1, 3) + wti1*dfaceid(2, j, k, 1, &
&          3) + wti2d*dfacei(2, j, k, 2, 3) + wti2*dfaceid(2, j, k, 2, 3)
        delki = wti1*dfacei(2, j, k, 1, 3) + wti2*dfacei(2, j, k, 2, 3)
        delkjd = wtj1d*dfacej(2, i, k, 1, 3) + wtj1*dfacejd(2, i, k, 1, &
&          3) + wtj2d*dfacej(2, i, k, 2, 3) + wtj2*dfacejd(2, i, k, 2, 3)
        delkj = wtj1*dfacej(2, i, k, 1, 3) + wtj2*dfacej(2, i, k, 2, 3)
        IF (delki .GE. 0.) THEN
          abs8d = delkid
          abs8 = delki
        ELSE
          abs8d = -delkid
          abs8 = -delki
        END IF
        IF (delkj .GE. 0.) THEN
          abs20d = delkjd
          abs20 = delkj
        ELSE
          abs20d = -delkjd
          abs20 = -delkj
        END IF
        IF (delki .GE. 0.) THEN
          abs33d = delkid
          abs33 = delki
        ELSE
          abs33d = -delkid
          abs33 = -delki
        END IF
        IF (delkj .GE. 0.) THEN
          abs44d = delkjd
          abs44 = delkj
        ELSE
          abs44d = -delkjd
          abs44 = -delkj
        END IF
        x6d = abs33d + abs44d
        x6 = abs33 + abs44
        IF (x6 .LT. eps) THEN
          max6 = eps
          max6d = 0.0
        ELSE
          max6d = x6d
          max6 = x6
        END IF
        delkd = ((abs8d*delki+abs8*delkid+abs20d*delkj+abs20*delkjd)*&
&          max6-(abs8*delki+abs20*delkj)*max6d)/max6**2
        delk = (abs8*delki+abs20*delkj)/max6
        del2d = delid + deljd + delkd
        del2 = deli + delj + delk
        delid = wti1d*dfacei(2, j, k, 1, 4) + wti1*dfaceid(2, j, k, 1, 4&
&          ) + wti2d*dfacei(2, j, k, 2, 4) + wti2*dfaceid(2, j, k, 2, 4)
        deli = wti1*dfacei(2, j, k, 1, 4) + wti2*dfacei(2, j, k, 2, 4)
        deljd = wtj1d*dfacej(2, i, k, 1, 4) + wtj1*dfacejd(2, i, k, 1, 4&
&          ) + wtj2d*dfacej(2, i, k, 2, 4) + wtj2*dfacejd(2, i, k, 2, 4)
        delj = wtj1*dfacej(2, i, k, 1, 4) + wtj2*dfacej(2, i, k, 2, 4)
        delkd = wtk1d*dfacek(2, i, j, 1, 4) + wtk1*dfacekd(2, i, j, 1, 4&
&          ) + wtk2d*dfacek(2, i, j, 2, 4) + wtk2*dfacekd(2, i, j, 2, 4)
        delk = wtk1*dfacek(2, i, j, 1, 4) + wtk2*dfacek(2, i, j, 2, 4)
        xyzd(2, i, j, k) = xyz0d(2, i, j, k) + del1d + del2d + delid + &
&          deljd + delkd
        xyz(2, i, j, k) = xyz0(2, i, j, k) + del1 + del2 + deli + delj +&
&          delk
!              ... and for Z perturbations:
        delid = wti1d*dfacei(3, j, k, 1, 1) + wti1*dfaceid(3, j, k, 1, 1&
&          ) + wti2d*dfacei(3, j, k, 2, 1) + wti2*dfaceid(3, j, k, 2, 1)
        deli = wti1*dfacei(3, j, k, 1, 1) + wti2*dfacei(3, j, k, 2, 1)
        deljd = wtj1d*dfacej(3, i, k, 1, 1) + wtj1*dfacejd(3, i, k, 1, 1&
&          ) + wtj2d*dfacej(3, i, k, 2, 1) + wtj2*dfacejd(3, i, k, 2, 1)
        delj = wtj1*dfacej(3, i, k, 1, 1) + wtj2*dfacej(3, i, k, 2, 1)
        delkd = wtk1d*dfacek(3, i, j, 1, 1) + wtk1*dfacekd(3, i, j, 1, 1&
&          ) + wtk2d*dfacek(3, i, j, 2, 1) + wtk2*dfacekd(3, i, j, 2, 1)
        delk = wtk1*dfacek(3, i, j, 1, 1) + wtk2*dfacek(3, i, j, 2, 1)
        IF (deli .GE. 0.) THEN
          abs9d = delid
          abs9 = deli
        ELSE
          abs9d = -delid
          abs9 = -deli
        END IF
        IF (delj .GE. 0.) THEN
          abs21d = deljd
          abs21 = delj
        ELSE
          abs21d = -deljd
          abs21 = -delj
        END IF
        IF (delk .GE. 0.) THEN
          abs27d = delkd
          abs27 = delk
        ELSE
          abs27d = -delkd
          abs27 = -delk
        END IF
        IF (deli .GE. 0.) THEN
          abs45d = delid
          abs45 = deli
        ELSE
          abs45d = -delid
          abs45 = -deli
        END IF
        IF (delj .GE. 0.) THEN
          abs51d = deljd
          abs51 = delj
        ELSE
          abs51d = -deljd
          abs51 = -delj
        END IF
        IF (delk .GE. 0.) THEN
          abs54d = delkd
          abs54 = delk
        ELSE
          abs54d = -delkd
          abs54 = -delk
        END IF
        x12d = abs45d + abs51d + abs54d
        x12 = abs45 + abs51 + abs54
        IF (x12 .LT. eps) THEN
          max12 = eps
          max12d = 0.0
        ELSE
          max12d = x12d
          max12 = x12
        END IF
        del1d = ((abs9d*deli+abs9*delid+abs21d*delj+abs21*deljd+abs27d*&
&          delk+abs27*delkd)*max12-(abs9*deli+abs21*delj+abs27*delk)*&
&          max12d)/max12**2
        del1 = (abs9*deli+abs21*delj+abs27*delk)/max12
        delijd = wtj1d*dfacej(3, i, k, 1, 2) + wtj1*dfacejd(3, i, k, 1, &
&          2) + wtj2d*dfacej(3, i, k, 2, 2) + wtj2*dfacejd(3, i, k, 2, 2)
        delij = wtj1*dfacej(3, i, k, 1, 2) + wtj2*dfacej(3, i, k, 2, 2)
        delikd = wtk1d*dfacek(3, i, j, 1, 2) + wtk1*dfacekd(3, i, j, 1, &
&          2) + wtk2d*dfacek(3, i, j, 2, 2) + wtk2*dfacekd(3, i, j, 2, 2)
        delik = wtk1*dfacek(3, i, j, 1, 2) + wtk2*dfacek(3, i, j, 2, 2)
        IF (delij .GE. 0.) THEN
          abs10d = delijd
          abs10 = delij
        ELSE
          abs10d = -delijd
          abs10 = -delij
        END IF
        IF (delik .GE. 0.) THEN
          abs22d = delikd
          abs22 = delik
        ELSE
          abs22d = -delikd
          abs22 = -delik
        END IF
        IF (delij .GE. 0.) THEN
          abs34d = delijd
          abs34 = delij
        ELSE
          abs34d = -delijd
          abs34 = -delij
        END IF
        IF (delik .GE. 0.) THEN
          abs46d = delikd
          abs46 = delik
        ELSE
          abs46d = -delikd
          abs46 = -delik
        END IF
        x7d = abs34d + abs46d
        x7 = abs34 + abs46
        IF (x7 .LT. eps) THEN
          max7 = eps
          max7d = 0.0
        ELSE
          max7d = x7d
          max7 = x7
        END IF
        delid = ((abs10d*delij+abs10*delijd+abs22d*delik+abs22*delikd)*&
&          max7-(abs10*delij+abs22*delik)*max7d)/max7**2
        deli = (abs10*delij+abs22*delik)/max7
        deljid = wti1d*dfacei(3, j, k, 1, 2) + wti1*dfaceid(3, j, k, 1, &
&          2) + wti2d*dfacei(3, j, k, 2, 2) + wti2*dfaceid(3, j, k, 2, 2)
        delji = wti1*dfacei(3, j, k, 1, 2) + wti2*dfacei(3, j, k, 2, 2)
        deljkd = wtk1d*dfacek(3, i, j, 1, 3) + wtk1*dfacekd(3, i, j, 1, &
&          3) + wtk2d*dfacek(3, i, j, 2, 3) + wtk2*dfacekd(3, i, j, 2, 3)
        deljk = wtk1*dfacek(3, i, j, 1, 3) + wtk2*dfacek(3, i, j, 2, 3)
        IF (delji .GE. 0.) THEN
          abs11d = deljid
          abs11 = delji
        ELSE
          abs11d = -deljid
          abs11 = -delji
        END IF
        IF (deljk .GE. 0.) THEN
          abs23d = deljkd
          abs23 = deljk
        ELSE
          abs23d = -deljkd
          abs23 = -deljk
        END IF
        IF (delji .GE. 0.) THEN
          abs35d = deljid
          abs35 = delji
        ELSE
          abs35d = -deljid
          abs35 = -delji
        END IF
        IF (deljk .GE. 0.) THEN
          abs47d = deljkd
          abs47 = deljk
        ELSE
          abs47d = -deljkd
          abs47 = -deljk
        END IF
        x8d = abs35d + abs47d
        x8 = abs35 + abs47
        IF (x8 .LT. eps) THEN
          max8 = eps
          max8d = 0.0
        ELSE
          max8d = x8d
          max8 = x8
        END IF
        deljd = ((abs11d*delji+abs11*deljid+abs23d*deljk+abs23*deljkd)*&
&          max8-(abs11*delji+abs23*deljk)*max8d)/max8**2
        delj = (abs11*delji+abs23*deljk)/max8
        delkid = wti1d*dfacei(3, j, k, 1, 3) + wti1*dfaceid(3, j, k, 1, &
&          3) + wti2d*dfacei(3, j, k, 2, 3) + wti2*dfaceid(3, j, k, 2, 3)
        delki = wti1*dfacei(3, j, k, 1, 3) + wti2*dfacei(3, j, k, 2, 3)
        delkjd = wtj1d*dfacej(3, i, k, 1, 3) + wtj1*dfacejd(3, i, k, 1, &
&          3) + wtj2d*dfacej(3, i, k, 2, 3) + wtj2*dfacejd(3, i, k, 2, 3)
        delkj = wtj1*dfacej(3, i, k, 1, 3) + wtj2*dfacej(3, i, k, 2, 3)
        IF (delki .GE. 0.) THEN
          abs12d = delkid
          abs12 = delki
        ELSE
          abs12d = -delkid
          abs12 = -delki
        END IF
        IF (delkj .GE. 0.) THEN
          abs24d = delkjd
          abs24 = delkj
        ELSE
          abs24d = -delkjd
          abs24 = -delkj
        END IF
        IF (delki .GE. 0.) THEN
          abs36d = delkid
          abs36 = delki
        ELSE
          abs36d = -delkid
          abs36 = -delki
        END IF
        IF (delkj .GE. 0.) THEN
          abs48d = delkjd
          abs48 = delkj
        ELSE
          abs48d = -delkjd
          abs48 = -delkj
        END IF
        x9d = abs36d + abs48d
        x9 = abs36 + abs48
        IF (x9 .LT. eps) THEN
          max9 = eps
          max9d = 0.0
        ELSE
          max9d = x9d
          max9 = x9
        END IF
        delkd = ((abs12d*delki+abs12*delkid+abs24d*delkj+abs24*delkjd)*&
&          max9-(abs12*delki+abs24*delkj)*max9d)/max9**2
        delk = (abs12*delki+abs24*delkj)/max9
        del2d = delid + deljd + delkd
        del2 = deli + delj + delk
        delid = wti1d*dfacei(3, j, k, 1, 4) + wti1*dfaceid(3, j, k, 1, 4&
&          ) + wti2d*dfacei(3, j, k, 2, 4) + wti2*dfaceid(3, j, k, 2, 4)
        deli = wti1*dfacei(3, j, k, 1, 4) + wti2*dfacei(3, j, k, 2, 4)
        deljd = wtj1d*dfacej(3, i, k, 1, 4) + wtj1*dfacejd(3, i, k, 1, 4&
&          ) + wtj2d*dfacej(3, i, k, 2, 4) + wtj2*dfacejd(3, i, k, 2, 4)
        delj = wtj1*dfacej(3, i, k, 1, 4) + wtj2*dfacej(3, i, k, 2, 4)
        delkd = wtk1d*dfacek(3, i, j, 1, 4) + wtk1*dfacekd(3, i, j, 1, 4&
&          ) + wtk2d*dfacek(3, i, j, 2, 4) + wtk2*dfacekd(3, i, j, 2, 4)
        delk = wtk1*dfacek(3, i, j, 1, 4) + wtk2*dfacek(3, i, j, 2, 4)
        xyzd(3, i, j, k) = xyz0d(3, i, j, k) + del1d + del2d + delid + &
&          deljd + delkd
        xyz(3, i, j, k) = xyz0(3, i, j, k) + del1 + del2 + deli + delj +&
&          delk
      END DO
    END DO
  END DO
END SUBROUTINE WARPBLK_SOLID_D
