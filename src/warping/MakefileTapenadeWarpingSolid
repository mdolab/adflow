#     ******************************************************************
#     *                                                                *
#     * File:          MakefileTapenadWarpingSolid                     *
#     * Author:        Gaetan Kenway                                   *
#     * Starting date: 04-13-2010                                      *
#     * Last modified: 04-13-2010                                      *
#     *                                                                *
#     ******************************************************************

#     ******************************************************************
#     *                                                                *
#     * Description: Makefile to build the differentiated routines of  *
#     * the Warping routine warp_local with respect to xyz.            *
#     *                                                                *
#     * http://www-sop.inria.fr/tropics/tapenade.html                  *
#     *                                                                *
#     * Upon local installation of Tapenade, typing tapenade -help     *
#     * at the prompt gives the following information:                 *
#     *                                                                *
#     * Tapenade - Version 2.2 (r2308) - Java 1.6.0_06                 *
#     *                                                                *
#     *  Builds a differentiated program.                              *
#     *                                                                *
#     *  Usage: tapenade [options] filenames                           *
#     *                                                                *
#     *   options:                                                     *
#     *                                                                *
#     * -tangent, -d          differentiate in the tangent mode        *
#     * -reverse, -b          differentiate in the reverse mode        *
#     * -multi                turn on "vectorial" differentiation      *
#     *                       (multi-directional)                      *
#     * -directValid, -dV     tangent mode computing validity interval *
#     * -preprocess, -p       turn off differentiation                 *
#     * -head, -root <proc>   set the differentiation root procedure   *
#     * -outvars <vars>       set dependents, i.e. differentiate these *
#     *                       output variables, eg "x y z". Use the "  *
#     *                       delimitor. (default all outputs)         *
#     * -vars <vars>          set independents, i.e. differentiate wrt *
#     *                       these input variables, eg "x y z". Use   *
#     *                       the " delimitor. (default all inputs)    *
#     * -diffvarname <str>    set differentiation suffix for variables *
#     *                       (default d and b)                        *   
#     * -difffuncname <str>   set differentiation suffix for procedures*
#     *                       (default _D and _B)                      *
#     * -inputlanguage <lang> language of  input files                 *
#     *                       (fortran, fortran90, or fortran95)       *
#     * -outputlanguage <lang>language of output files                 *
#     *                       (fortran, fortran90, or fortran95)       *
#     * -output, -o <file>    put all generated procedures into a      *
#     *                       single <file>                            *
#     * -outputdirectory, -O <directory>  put all generated files in   *
#     *                       <directory> (default .) (default one     *
#     *                       separate file per differentiated procedur*
#     * -nolib                erase previous external libraries        *
#     *                       descriptions                             *
#     * -ext <file>           incorporate external library description *
#     *                       <file>                                   *
#     * -noADlib              erase previous external libraries AD     *
#     *                       descriptions                             *
#     * -extAD <file>         incorporate external library AD          *
#     *                       description <file>                       *
#     * -i<n>                 count <n> bytes for an integer (default4)*
#     * -r<n>                 count <n> bytes for a real (default 4)   *
#     * -dr<n>                count <n> bytes for a double real (def 8)*
#     * -nooptim <str>        turn off optimization <str>              *
#     * -traceactivevars <units>  insert debugging calls for the       *
#     *                       tangent mode of <units>                  *
#     * -traceallactivevars   insert debugging calls for all tangent   *
#     *                       diff procedures                          *
#     * -dptest <units>       insert debugging calls for the dot       *
#     *                       product test                             *
#     * -msglevel <n>         set the level of detail of               *
#     *                       differentiation milestones               *
#     * -dump <file>          write a dump <file>                      *
#     * -html                 display results in a web browser         *
#     *                                                                *
#     ******************************************************************

#     ==================================================================

#     ******************************************************************
#     *                                                                *
#     * Set some environment variables that otherwise would have to be *
#     * set at the command prompt with "setenv".                       *
#     *                                                                *
#     ******************************************************************

SOLVER_DIRSRC = /nfs/mica/home/kenway/svn/pyHF/SUmbADjoint/trunk/src

#     ******************************************************************
#     *                                                                *
#     * Set Tapenade options.                                          *
#     *                                                                *
#     ******************************************************************


TAPENADE_PARSERFILESEPARATOR = "/"
TAPENADE_MODE = -forward

# Algebric warping routine info 
OUTVARS_WARP = "xyz"
INVARS_WARP = "xyz xyz0"
ROUTINE_WARP = "warpblk_solid"

# Interpolation routine info
OUTVARS_INTERP = "bcoef"
INVARS_INTERP = "fcn"
ROUTINE_INTERP = "b3intk"

# Evaluation routine info
OUTVARS_EVAL = "b3val"
INVARS_EVAL = "bcoef"
ROUTINE_EVAL = "b3val"


TAPENADE_OUTDIR = $(SOLVER_DIRSRC)/warping/warpingTapenade

# Integer, double and real precision (bytes)
TAPENADE_PRECISION = -i4 -dr8 -r8

#     ******************************************************************
#     *                                                                *
#     * The subdirectories where the sources are located.              *
#     *                                                                *
#     ******************************************************************

TAPENADE_DIRSRC     = $(SOLVER_DIRSRC)/warping
TAPENADE_DIRMOD     = $(SOLVER_DIRSRC)/modules

TAPENADE_CLEAN_DIRS = $(TAPENADE_OUTDIR)

#     ******************************************************************
#     *                                                                *
#     * Routines to be differentiated (and dependencies).              *
#     *                                                                *
#     ******************************************************************

SRC_WARP            = $(TAPENADE_DIRSRC)/warp-mb_solid.f90\
		      $(TAPENADE_DIRMOD)/blockPointers.f90\
		      $(TAPENADE_DIRMOD)/block.f90\
		      $(SOLVER_DIRSRC)/adjoint/residualInput/precision.f90

SRC_INTERP          = $(TAPENADE_DIRSRC)/b3ink.f\
	              $(TAPENADE_DIRSRC)/btpcf.f\
                      $(TAPENADE_DIRSRC)/bintk.f\
                      $(TAPENADE_DIRSRC)/bnslv.f\
                      $(TAPENADE_DIRSRC)/bknot.f\
                      $(TAPENADE_DIRSRC)/bnslv.f\
	              $(TAPENADE_DIRSRC)/bspvn.f\
	              $(TAPENADE_DIRSRC)/bnfac.f\

SRC_EVAL            = $(TAPENADE_DIRSRC)/b3val.f\
	              $(TAPENADE_DIRSRC)/intrv.f\
                      $(TAPENADE_DIRSRC)/bvalu.f\



#     ******************************************************************
#     *                                                                *
#     * General targets.                                               *
#     *                                                                *
#     ******************************************************************

default:
	@echo "TAPENADE - Differentiating algebraic warping routine"
	tapenade -html -parserfileseparator $(TAPENADE_PARSERFILESEPARATOR) -outvars $(OUTVARS_WARP) -vars $(INVARS_WARP) -head $(ROUTINE_WARP) $(TAPENADE_MODE) -msglevel 30 -O $(TAPENADE_OUTDIR) $(TAPENADE_PRECISION) $(SRC_WARP)
	@echo "TAPENADE - Differentiating interpolation routine"
	tapenade -html -parserfileseparator $(TAPENADE_PARSERFILESEPARATOR) -outvars $(OUTVARS_INTERP) -vars $(INVARS_INTERP) -head $(ROUTINE_INTERP) $(TAPENADE_MODE) -msglevel 30 -O $(TAPENADE_OUTDIR) $(TAPENADE_PRECISION) $(SRC_INTERP)
	@echo "TAPENADE - Differentiating evaluation routine"
	tapenade -html -parserfileseparator $(TAPENADE_PARSERFILESEPARATOR) -outvars $(OUTVARS_EVAL) -vars $(INVARS_EVAL) -head $(ROUTINE_EVAL) $(TAPENADE_MODE) -msglevel 30 -O $(TAPENADE_OUTDIR) $(TAPENADE_PRECISION) $(SRC_EVAL)
	@echo "deleting some unnecessary files..."
	@rm -f $(TAPENADE_OUTDIR)/*__.f90 $(TAPENADE_OUTDIR)/*~

all:	 default

clean:
	@echo " Making clean ... "
	@for subdir in $(TAPENADE_CLEAN_DIRS) ; \
		do \
			echo; \
			echo "making $@ in $$subdir"; \
			echo; \
			(cd $$subdir && rm -f *_b.f90 *.msg *~) || exit 1; \
		done
